import{u as te,g as ae,r as h,D as se,x as f,h as le,q as F,ac as oe,p as ne,c as v,o as u,a,j as re,d as $,m as ie,b as k,w as de,k as y,l as w,v as D,t as c,F as Y,e as z,s as L,n as q,Q as M}from"./index-DoDyGwYu.js";import{L as ue}from"./LoaderView-CmYvZpI6.js";import{_ as me}from"./MultiselectDropdown-hrLG_XwW.js";import{u as ve}from"./holiday-BSAKkHOb.js";import{u as ce}from"./leave-application-BQEGjy4u.js";import{u as pe}from"./user-BABBqtbJ.js";const fe={class:"my-container max-w-4xl space-y-6"},ge={class:"rounded-2xl border border-slate-200 bg-white/80 p-4 shadow-sm md:p-6"},be={class:"flex flex-wrap items-center justify-between gap-3"},we={class:"grid grid-cols-1 gap-4 md:grid-cols-2"},_e=["min"],ye=["min"],xe={key:0,class:"rounded-lg bg-blue-50 p-3 text-sm text-blue-700"},he={key:1,class:"grid gap-3 rounded-xl border border-slate-100 bg-slate-50 p-4 sm:grid-cols-2 lg:grid-cols-4"},ke={class:"rounded-lg bg-white p-3 shadow-sm"},De={class:"text-2xl font-semibold text-slate-800"},Le={class:"rounded-lg bg-white p-3 shadow-sm"},Ue={class:"text-xl font-semibold text-slate-800"},Se={class:"rounded-lg bg-white p-3 shadow-sm"},Ve={class:"text-xl font-semibold text-slate-800"},We={class:"rounded-lg bg-white p-3 shadow-sm"},Te={class:"text-xl font-semibold text-amber-600"},Be={key:2,class:"flex items-start gap-3 rounded-lg border border-amber-200 bg-amber-50/80 p-4 text-amber-800 shadow-sm"},Re={class:"text-sm"},Ae={key:3,class:"space-y-4"},Me={class:"max-h-[28rem] space-y-3 overflow-y-auto pr-1"},Ne={class:"flex flex-wrap items-center justify-between gap-3"},Ce={class:"font-semibold text-slate-900"},He={class:"mt-1 flex flex-wrap gap-2"},je=["name","value","onUpdate:modelValue","disabled"],Ee=["name","onUpdate:modelValue"],Fe=["name","onUpdate:modelValue"],$e={class:"space-y-1"},Ye={class:"space-y-1"},ze={class:"space-y-1"},qe={key:4,class:"flex items-start gap-3 rounded-lg border border-red-200 bg-red-50 p-4 text-red-700 shadow-sm"},Ie={class:"flex-1 text-sm leading-5"},Pe={class:"mt-0.5"},et={__name:"LeaveApplicationAdd",setup(Je){const N=te(),I=ce(),d=ae(),b=pe(),C=ve(),U=h(""),{userLeaveBalance:x}=se(b),i=h({last_working_date:"",resumption_date:"",reason:"",works_in_hand:"",handover_user_id:"",leave_days:[]}),r=h([]),S=h(!1),g=h(null),V=new Date().getFullYear(),W=t=>{const e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0");return`${e}-${n}-${l}`},P=t=>W(new Date(t,0,1)),J=t=>W(new Date(t,11,31)),H=f(()=>P(V)),O=f(()=>J(V)),T=f(()=>{const t={};return r.value.forEach(e=>{typeof e=="number"&&(t[e]=(t[e]||0)+1)}),t}),B=t=>{const e=Number(t==null?void 0:t.remaining_days);return Number.isFinite(e)?e:1/0},R=f(()=>{var t;return(t=x.value)!=null&&t.length?x.value.map(e=>{const n=T.value[e.id]||0,l=B(e);return{id:e.id,name:e.name,used:n,remain:l}}).filter(e=>e.remain!==1/0&&e.used>e.remain):[]}),A=f(()=>R.value.length?`You have exceeded remaining days for: ${R.value.map(e=>e.name).join(", ")}`:""),Q=f(()=>{var t,e,n;return((e=(t=d==null?void 0:d.user)==null?void 0:t.assign_weekend)==null?void 0:e.weekends)||((n=d==null?void 0:d.user)==null?void 0:n.weekends)||[]}),m=f(()=>{const t=i.value.last_working_date,e=i.value.resumption_date;if(!t||!e)return[];const n=new Date(t),l=new Date(e);if(l<=n)return[];const s=[];let o=new Date(n);for(o.setDate(o.getDate()+1);o<l;)s.push(W(o)),o.setDate(o.getDate()+1);return s}),j=f(()=>{const t=i.value.last_working_date,e=i.value.resumption_date;if(!t||!e)return"";const n=new Date(t);return new Date(e)<=n?"Resumption date must be after Last Working Date.":m.value.length===0?"No leave days between the selected dates.":null}),_=f(()=>{const t=m.value.length;if(!t)return{total:0,weekends:0,holidays:0,assigned:0,pending:0};let e=0,n=0,l=0;r.value.forEach(o=>{o==="weekend"?e+=1:o==="holiday"?n+=1:o&&(l+=1)});const s=Math.max(t-(e+n+l),0);return{total:t,weekends:e,holidays:n,assigned:l,pending:s}}),G=t=>new Date(t).toLocaleString("en-us",{weekday:"long"}),K=t=>{const e=x.value.find(n=>n.id===t);return(e==null?void 0:e.name)||""},X=t=>{const e=B(t);if(e===1/0)return"∞";const n=T.value[t.id]||0;return Math.max(e-n,0)},E=(t,e)=>{const n=B(t);return n===1/0||e===t.id?!1:(T.value[t.id]||0)>=n};le(async()=>{var t;try{(t=d==null?void 0:d.user)!=null&&t.id&&b.userLeaveBalance.length===0&&await b.fetchUserLeaveBalances(d.user.id),await b.fetchTypeWiseEmployees({except:"auth"})}catch(e){console.error("Error while initializing leave form:",e)}}),F(()=>{var t;return(t=d.user)==null?void 0:t.id},async t=>{t&&b.userLeaveBalance.length===0&&await b.fetchUserLeaveBalances(t)}),F(()=>U.value,t=>{i.value.handover_user_id=t==null?void 0:t.id}),oe(async()=>{var n;if(!m.value.length||!x.value.length)return;const t=m.value[0],e=m.value[m.value.length-1];await C.fetchHolidays({company_id:(n=d==null?void 0:d.user)==null?void 0:n.company_id,start_date:t,end_date:e});for(let l=0;l<m.value.length;l++){const s=m.value[l];if(r.value[l])continue;const o=new Date(s).toLocaleString("en-us",{weekday:"long"}),p=Q.value.includes(o);if(C.holidayDates.includes(s)){r.value[l]="holiday";continue}p&&(r.value[l]="weekend")}});const Z=async()=>{var t;S.value=!0,g.value=null;try{if(!i.value.last_working_date||!i.value.resumption_date){g.value="Please select both Last Working Date and Resumption Date.";return}if(i.value.last_working_date<H.value||i.value.last_working_date>O.value){g.value=`Last Working Date must be within ${V}.`;return}if(new Date(i.value.resumption_date)<=new Date(i.value.last_working_date)){g.value="Resumption date must be after Last Working Date.";return}if(R.value.length){g.value=A.value;return}const e=m.value.map((o,p)=>({date:o,leave_type_id:r.value[p]!=="weekend"&&r.value[p]!=="holiday"?r.value[p]:null})).filter(o=>o.leave_type_id!==null),n=m.value.map((o,p)=>({date:o,leave_type_id:r.value[p]||""})),l={user_id:(t=d==null?void 0:d.user)==null?void 0:t.id,last_working_date:i.value.last_working_date,resumption_date:i.value.resumption_date,reason:i.value.reason,works_in_hand:i.value.works_in_hand,handover_user_id:i.value.handover_user_id,leave_days:e,json_data:n},s=await I.storeLeaveApplication(l);s&&N.push({name:"LeaveApplicationShow",params:{id:s==null?void 0:s.id}})}catch(e){g.value=(e==null?void 0:e.message)||"Failed to submit leave application"}finally{S.value=!1}},ee=()=>N.go(-1);return(t,e)=>{const n=ne("RouterLink");return u(),v("div",fe,[a("section",ge,[a("div",be,[a("button",{class:"btn-3",onClick:ee},e[5]||(e[5]=[a("i",{class:"far fa-arrow-left"},null,-1),a("span",{class:"hidden md:flex"},"Back",-1)])),e[7]||(e[7]=a("div",{class:"text-center"},[a("h1",{class:"title-md md:title-lg"},"Leave Application"),a("p",{class:"text-xs text-slate-500 md:text-sm"}," Pick your dates, assign leave types, and tell us who is covering while you’re away. ")],-1)),$(n,{to:"/applications",class:"btn-2"},{default:ie(()=>e[6]||(e[6]=[k("Home")])),_:1,__:[6]})])]),S.value?(u(),re(ue,{key:0})):(u(),v("form",{key:1,onSubmit:de(Z,["prevent"]),class:"relative space-y-6 rounded-2xl border border-slate-200 bg-white/80 p-4 pb-24 shadow-lg md:p-8 md:pb-28"},[a("div",we,[a("div",null,[e[8]||(e[8]=a("label",{for:"last-working-date",class:"block text-sm font-medium text-slate-600"}," Last Working Date ",-1)),w(a("input",{type:"date",id:"last-working-date","onUpdate:modelValue":e[0]||(e[0]=l=>i.value.last_working_date=l),class:"input-1 mt-1 w-full",required:"",min:H.value},null,8,_e),[[D,i.value.last_working_date]])]),a("div",null,[e[9]||(e[9]=a("label",{for:"resumption-date",class:"block text-sm font-medium text-slate-600"}," Resumption Date ",-1)),w(a("input",{type:"date",id:"resumption-date","onUpdate:modelValue":e[1]||(e[1]=l=>i.value.resumption_date=l),class:"input-1 mt-1 w-full",required:"",min:i.value.last_working_date},null,8,ye),[[D,i.value.resumption_date]])])]),i.value.last_working_date&&i.value.resumption_date&&j.value?(u(),v("div",xe,c(j.value),1)):y("",!0),_.value.total?(u(),v("div",he,[a("div",ke,[e[10]||(e[10]=a("p",{class:"text-xs uppercase text-slate-400"},"Total Days",-1)),a("p",De,c(_.value.total),1)]),a("div",Le,[e[11]||(e[11]=a("p",{class:"text-xs uppercase text-slate-400"},"Assigned",-1)),a("p",Ue,c(_.value.assigned),1)]),a("div",Se,[e[12]||(e[12]=a("p",{class:"text-xs uppercase text-slate-400"},"Weekend / Holiday",-1)),a("p",Ve,c(_.value.weekends+_.value.holidays),1)]),a("div",We,[e[13]||(e[13]=a("p",{class:"text-xs uppercase text-slate-400"},"Still Unassigned",-1)),a("p",Te,c(_.value.pending),1)])])):y("",!0),A.value?(u(),v("div",Be,[e[14]||(e[14]=a("i",{class:"fas fa-info-circle mt-1 text-amber-500"},null,-1)),a("p",Re,c(A.value),1)])):y("",!0),m.value.length?(u(),v("div",Ae,[e[17]||(e[17]=a("div",{class:"flex flex-wrap items-center justify-between gap-2"},[a("h2",{class:"text-lg font-semibold text-slate-700"},"Leave Days"),a("p",{class:"text-xs text-slate-500"},"Tap a badge to classify each date")],-1)),a("div",Me,[(u(!0),v(Y,null,z(m.value,(l,s)=>(u(),v("div",{key:s,class:"rounded-2xl border border-slate-100 bg-white px-3 py-2 shadow-sm transition hover:border-blue-200 hover:shadow-md"},[a("div",Ne,[a("div",null,[a("p",Ce,c(l)+" ("+c(G(l))+") ",1)]),r.value[s]?(u(),v("span",{key:0,class:L(["inline-flex items-center rounded-full px-3 text-xs font-semibold",{"bg-amber-50 text-amber-700":r.value[s]==="weekend","bg-emerald-50 text-emerald-700":r.value[s]==="holiday","bg-blue-50 text-blue-700":r.value[s]!=="weekend"&&r.value[s]!=="holiday"}])},c(r.value[s]==="weekend"?"Weekend":r.value[s]==="holiday"?"Holiday":K(r.value[s])),3)):y("",!0)]),a("div",He,[(u(!0),v(Y,null,z(q(x),o=>(u(),v("label",{key:o.id,class:L(["cursor-pointer rounded-full border px-3 py-1 text-sm font-medium transition",[r.value[s]===o.id?"border-blue-500 bg-blue-50 text-blue-700":"border-slate-200 text-slate-600",E(o,r.value[s])?"cursor-not-allowed opacity-40":""]])},[w(a("input",{type:"radio",class:"sr-only",name:"leaveType-"+s,value:o.id,"onUpdate:modelValue":p=>r.value[s]=p,disabled:E(o,r.value[s])},null,8,je),[[M,r.value[s]]]),a("span",null,c(o.name)+" ("+c(X(o))+")",1)],2))),128)),a("label",{class:L(["cursor-pointer rounded-full px-3 py-1 text-sm font-medium transition",r.value[s]==="weekend"?"border-amber-400 bg-amber-50 text-amber-700":"border-slate-200 text-slate-600 hover:border-amber-200 hover:text-amber-700"])},[w(a("input",{type:"radio",class:"sr-only",name:"leaveType-"+s,value:"weekend","onUpdate:modelValue":o=>r.value[s]=o},null,8,Ee),[[M,r.value[s]]]),e[15]||(e[15]=k(" Weekend "))],2),a("label",{class:L(["cursor-pointer rounded-full px-3 py-1 text-sm font-medium transition",r.value[s]==="holiday"?"border-emerald-400 bg-emerald-50 text-emerald-700":"border-slate-200 text-slate-600 hover:border-emerald-200 hover:text-emerald-700"])},[w(a("input",{type:"radio",class:"sr-only",name:"leaveType-"+s,value:"holiday","onUpdate:modelValue":o=>r.value[s]=o},null,8,Fe),[[M,r.value[s]]]),e[16]||(e[16]=k(" Holiday "))],2)])]))),128))])])):y("",!0),a("div",$e,[e[18]||(e[18]=a("label",{for:"reason",class:"text-sm font-medium text-slate-600"},"Reason",-1)),w(a("textarea",{id:"reason","onUpdate:modelValue":e[2]||(e[2]=l=>i.value.reason=l),class:"input-1 w-full",placeholder:"Let approvers know why you need the time off",rows:"3"},null,512),[[D,i.value.reason]])]),a("div",Ye,[e[19]||(e[19]=a("label",{for:"handover-user",class:"text-sm font-medium text-slate-600"},"Handover User",-1)),$(me,{modelValue:U.value,"onUpdate:modelValue":e[3]||(e[3]=l=>U.value=l),options:q(b).users,multiple:!1,label:"label",placeholder:"Search teammate",class:"z-50","top-label":"User"},null,8,["modelValue","options"])]),a("div",ze,[e[20]||(e[20]=a("label",{for:"works-in-hand",class:"text-sm font-medium text-slate-600"},"Works in Hand",-1)),w(a("textarea",{id:"works-in-hand","onUpdate:modelValue":e[4]||(e[4]=l=>i.value.works_in_hand=l),class:"input-1 w-full",placeholder:"Share current deliverables so the team has context",rows:"6"},null,512),[[D,i.value.works_in_hand]])]),g.value?(u(),v("div",qe,[e[22]||(e[22]=a("div",{class:"flex-shrink-0"},[a("i",{class:"fas fa-exclamation-triangle text-red-500"})],-1)),a("div",Ie,[e[21]||(e[21]=a("p",{class:"font-medium"},"Something went wrong!",-1)),a("p",Pe,c(g.value),1)])])):y("",!0),e[23]||(e[23]=a("div",{class:"sticky inset-x-0 bottom-0 -mx-4 flex justify-end border-t border-slate-100 bg-white/95 px-4 py-4 backdrop-blur supports-[backdrop-filter]:bg-white/80 md:-mx-8 md:px-8"},[a("button",{type:"submit",class:"btn-2 inline-flex items-center gap-2 shadow-md"},[a("i",{class:"far fa-paper-plane"}),k(" Submit Application ")])],-1))],32))])}}};export{et as default};
