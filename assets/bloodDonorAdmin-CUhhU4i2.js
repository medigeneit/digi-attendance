import{B as L,r as l,x as O,C as y}from"./index-UQNVsj_8.js";const N=()=>({user_id:"",last_donation_date:"",available_from:"",is_available:!0,availability_note:"",has_disease:!1,disease_note:"",status:"active",notes:""}),C=t=>t===!0||t==="true"||t===1||t==="1",F=(t,r)=>{var n,s;return((s=(n=t==null?void 0:t.response)==null?void 0:n.data)==null?void 0:s.message)||(t==null?void 0:t.message)||r},Y=(t,r)=>{var n,s,u,p;return{message:((s=(n=t==null?void 0:t.response)==null?void 0:n.data)==null?void 0:s.message)||r,errors:((p=(u=t==null?void 0:t.response)==null?void 0:u.data)==null?void 0:p.errors)||{}}},k=L("bloodDonorAdmin",()=>{const t=l(!1),r=l(""),n=l([]),s=l({page:1,per_page:25,total:0,last_page:1}),u=l({search:"",address:"",blood_group:"",status:"",availability:"all",soon_days:15,last_donation_from:"",last_donation_to:"",per_page:25,company_id:"",department_id:"",employee_id:"",line_type:"all"}),p=O(()=>{const a=u.value,e={page:s.value.page,per_page:a.per_page};return a.search&&(e.search=a.search),a.address&&(e.address=a.address),a.blood_group&&(e.blood_group=a.blood_group),a.status&&(e.status=a.status),a.last_donation_from&&(e.last_donation_from=a.last_donation_from),a.last_donation_to&&(e.last_donation_to=a.last_donation_to),a.availability&&a.availability!=="all"&&(e.availability=a.availability,a.availability==="soon"&&(e.soon_days=a.soon_days||15)),a.company_id&&(e.company_id=a.company_id),a.department_id&&(e.department_id=a.department_id),a.employee_id&&(e.employee_id=a.employee_id),a.line_type&&(e.line_type=a.line_type),e});async function D(){t.value=!0,r.value="";try{const a=await y.get("/blood-donors",{params:p.value}),e=(a==null?void 0:a.data)||{};n.value=e.data||[],s.value={page:e.current_page||1,per_page:e.per_page||u.value.per_page,total:e.total||0,last_page:e.last_page||1}}catch(a){n.value=[],s.value={page:1,per_page:u.value.per_page,total:0,last_page:1},r.value=F(a,"Failed to load donors.")}finally{t.value=!1}}function P(a){s.value.page=a}function T(){u.value={search:"",address:"",blood_group:"",status:"",availability:"all",soon_days:15,last_donation_from:"",last_donation_to:"",per_page:25,company_id:"",department_id:"",employee_id:"",line_type:"all"},s.value.page=1}const S=l(!1),x=l("edit"),g=l(!1),$=l(null),d=l(""),_=l({}),v=l(null),f=l([]),E=l(!1),b=l(""),o=l(N()),c=l(null);function m(){o.value=N(),c.value=null,_.value={},d.value=""}function A(a){if(!a)return"";const e=new Date(`${a}T00:00:00`);if(Number.isNaN(e.getTime()))return"";e.setDate(e.getDate()+90);const i=e.getFullYear(),H=String(e.getMonth()+1).padStart(2,"0"),M=String(e.getDate()).padStart(2,"0");return`${i}-${H}-${M}`}function B(a){o.value.last_donation_date=a,o.value.available_from=A(a)}async function h(a){if(!a){f.value=[];return}E.value=!0,b.value="";try{const e=await y.get("/blood-donor/me/histories",{params:{user_id:a,per_page:50}}),i=(e==null?void 0:e.data)||{};f.value=i.data||[]}catch(e){f.value=[],b.value=F(e,"Failed to load histories.")}finally{E.value=!1}}function U(a){S.value=!0,x.value="edit",m(),v.value=a,o.value.user_id=a!=null&&a.id?String(a.id):"",a!=null&&a.id&&h(a.id)}function V(){S.value=!1,m(),v.value=null,f.value=[],b.value=""}function q(a){var e;a&&(c.value=a.id??null,o.value={...N(),user_id:String(a.user_id||((e=v.value)==null?void 0:e.id)||""),last_donation_date:a.last_donation_date||"",is_available:C(a.is_available),availability_note:a.availability_note||"",has_disease:C(a.has_disease),disease_note:a.disease_note||"",status:a.status||"active",notes:a.notes||""},B(o.value.last_donation_date),o.value.has_disease||(o.value.disease_note=""),_.value={},d.value="")}async function w(){var e;if(g.value)return!1;if(!o.value.user_id)return d.value="Select a user first.",!1;g.value=!0,d.value="",_.value={};const a={user_id:Number(o.value.user_id),last_donation_date:o.value.last_donation_date||null,is_available:!!o.value.is_available,availability_note:o.value.availability_note||null,has_disease:!!o.value.has_disease,disease_note:o.value.has_disease&&o.value.disease_note||null,notes:o.value.notes||null,status:o.value.status||"active"};try{return c.value?await y.put(`/blood-donor/me/histories/${c.value}`,a):await y.post("/blood-donor/me/histories",a),await h(a.user_id),m(),await D(),!0}catch(i){if(((e=i==null?void 0:i.response)==null?void 0:e.status)===422){const{message:H,errors:M}=Y(i,"Validation error.");d.value=H,_.value=M}else d.value=F(i,"Failed to save donation history.");return!1}finally{g.value=!1}}async function I(a){var e;if(a){$.value=a,d.value="",_.value={};try{await y.delete(`/blood-donor/me/histories/${a}`),(e=v.value)!=null&&e.id&&await h(v.value.id),c.value===a&&m(),await D()}catch(i){d.value=F(i,"Failed to delete donation history.")}finally{$.value=null}}}return{donors:n,meta:s,loading:t,error:r,filters:u,queryParams:p,fetchDonors:D,setPage:P,resetFilters:T,modalOpen:S,modalMode:x,saving:g,deletingId:$,formError:d,errors:_,selectedUser:v,histories:f,loadingHistories:E,historiesError:b,form:o,editId:c,openModalForUser:U,closeModal:V,resetForm:m,calcAvailableFrom:A,setLastDonationDate:B,fetchHistories:h,editHistory:q,saveHistory:w,deleteHistory:I}});export{k as useBloodDonorAdminStore};
