import{_ as V,x as P,c as _,o as y,k as j,d as B,a as t,b as $,t as r,F as O,e as z,s as I,C as G,f as ne,u as le,S as de,D as re,r as A,q as ie,h as oe,m as ue,l as pe,H as ce,P as me}from"./index-CwlQjDzn.js";import{u as _e}from"./company-CdEmFMcl.js";import{u as ye}from"./department-yaGACPb3.js";import{L as ve}from"./LoaderView-D2yzncBe.js";import{_ as ge}from"./EmployeeFilter-DEghfRsg.js";import"./EmployeeDropdownInput-fKi8ns5J.js";import"./SelectDropdown-BRTTdot2.js";import"./UserChip-Bx_2n51U.js";import"./user-C71uyCAX.js";const be={class:"rounded-2xl border border-slate-100 bg-white/90 shadow-lg"},fe={key:0,class:"py-8"},xe={key:1,class:"empty-state"},he={key:2,class:"table-scroll"},$e={class:"min-w-full table-auto border-collapse"},ke={class:"sticky top-0 bg-white shadow-sm"},Se={class:"bg-gray-50 text-sm text-left"},Ce={class:"ml-1 text-[11px]"},qe={class:"ml-1 text-[11px]"},Ne={class:"ml-1 text-[11px]"},Ae={class:"text-sm"},Pe=["onClick"],De={class:"td"},Ue={class:"td font-semibold text-slate-700"},Fe={class:"td text-slate-600"},Le={class:"td"},Re={class:"td text-center"},Ye={class:"td text-center"},Be={class:"td text-center"},Me={key:3,class:"flex items-center justify-between p-3 text-sm"},Te={class:"text-slate-600"},Ee={class:"font-medium"},Ve={class:"font-medium"},je={class:"font-medium"},Oe={class:"flex items-center gap-3"},ze=["value"],Ie={class:"flex items-center gap-2"},Ge=["disabled"],He={class:"text-slate-600"},Qe=["disabled"],Je={__name:"YearlyAttendanceSummaryTable",props:{rows:{type:Array,default:()=>[]},meta:{type:Object,default:()=>({})},isLoading:{type:Boolean,default:!1},sortBy:{type:String,default:"attendance_score_avg"},sortDir:{type:String,default:"desc"},page:{type:Number,default:1},perPage:{type:Number,default:25}},emits:["update:page","update:perPage","sort-change","row-click"],setup(o,{emit:u}){const c=o,Y=u,k=P(()=>{var l;return Number(((l=c.meta)==null?void 0:l.total)||0)}),b=P(()=>{var l;return Number(((l=c.meta)==null?void 0:l.last_page)||1)}),S=P(()=>k.value===0?0:(c.page-1)*c.perPage+1),M=P(()=>k.value===0?0:(c.page-1)*c.perPage+c.rows.length),f=l=>{if(!l)return;const s=c.sortBy===l&&c.sortDir==="asc"?"desc":"asc";Y("sort-change",{sort_by:l,sort_dir:s})},D=l=>c.sortBy!==l?"":c.sortDir==="asc"?"↑":"↓",e=l=>{const s=Number(l||0);return s>=95?"bg-emerald-50 text-emerald-700":s>=80?"bg-amber-50 text-amber-700":"bg-rose-50 text-rose-700"},C=l=>{const s=Number(l);return Number.isFinite(s)?`${s.toFixed(1)}%`:"—"},U=l=>{const s=(l==null?void 0:l.user_name)||(l==null?void 0:l.name)||(l==null?void 0:l.user)||(l==null?void 0:l.employee_name)||"";return s&&(l!=null&&l.user_id)?`${s} (${l.user_id})`:l!=null&&l.user_id?`#${l.user_id}`:s||"—"},q=l=>l!=null&&l.department_name?l.department_name:(l==null?void 0:l.department_id)==null?"Unassigned":String((l==null?void 0:l.department_id)||"Unassigned");return(l,s)=>(y(),_("div",be,[o.isLoading?(y(),_("div",fe,[B(ve)])):o.rows.length===0?(y(),_("div",xe,s[6]||(s[6]=[t("p",{class:"text-base font-semibold text-slate-700"},"No attendance summary found",-1),t("p",{class:"text-sm text-slate-500"},"Try adjusting filters or year.",-1)]))):(y(),_("div",he,[t("table",$e,[t("thead",ke,[t("tr",Se,[s[10]||(s[10]=t("th",{class:"th w-12"},"#",-1)),t("th",{class:"th cursor-pointer",onClick:s[0]||(s[0]=d=>f("user_id"))},[s[7]||(s[7]=$(" User ")),t("span",Ce,r(D("user_id")),1)]),s[11]||(s[11]=t("th",{class:"th"},"Department",-1)),s[12]||(s[12]=t("th",{class:"th"},"Year",-1)),t("th",{class:"th cursor-pointer text-center",onClick:s[1]||(s[1]=d=>f("yearly_present_pct"))},[s[8]||(s[8]=$(" Present % ")),t("span",qe,r(D("yearly_present_pct")),1)]),t("th",{class:"th cursor-pointer text-center",onClick:s[2]||(s[2]=d=>f("total_months"))},[s[9]||(s[9]=$(" Score Months ")),t("span",Ne,r(D("total_months")),1)]),s[13]||(s[13]=t("th",{class:"th text-center"},"Grading",-1))])]),t("tbody",Ae,[(y(!0),_(O,null,z(o.rows,(d,F)=>(y(),_("tr",{key:`${d==null?void 0:d.user_id}-${d==null?void 0:d.year}-${F}`,class:"border-b hover:bg-blue-50 cursor-pointer",onClick:T=>l.$emit("row-click",d)},[t("td",De,r((o.page-1)*o.perPage+(F+1)),1),t("td",Ue,r(U(d)),1),t("td",Fe,r(q(d)),1),t("td",Le,r((d==null?void 0:d.year)||"—"),1),t("td",Re,[t("span",{class:I(["inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold",e(d==null?void 0:d.yearly_present_pct)])},r(C(d==null?void 0:d.yearly_present_pct)),3)]),t("td",Ye,r((d==null?void 0:d.yearly_present_score_months)??"—"),1),t("td",Be,r(d==null?void 0:d.yearly_present_score_avg),1)],8,Pe))),128))])])])),!o.isLoading&&o.rows.length?(y(),_("div",Me,[t("div",Te,[s[14]||(s[14]=$(" Showing ")),t("span",Ee,r(S.value),1),s[15]||(s[15]=$(" to ")),t("span",Ve,r(M.value),1),s[16]||(s[16]=$(" of ")),t("span",je,r(k.value),1)]),t("div",Oe,[t("select",{class:"rounded-md border border-slate-200 px-2 py-1 text-xs text-slate-700",value:o.perPage,onChange:s[3]||(s[3]=d=>l.$emit("update:perPage",Number(d.target.value)))},s[17]||(s[17]=[t("option",{value:10},"10 / page",-1),t("option",{value:25},"25 / page",-1),t("option",{value:50},"50 / page",-1)]),40,ze),t("div",Ie,[t("button",{class:"btn-3",disabled:o.page<=1,onClick:s[4]||(s[4]=d=>l.$emit("update:page",Math.max(1,o.page-1)))}," Prev ",8,Ge),t("span",He,"Page "+r(o.page)+" / "+r(b.value),1),t("button",{class:"btn-3",disabled:o.page>=b.value,onClick:s[5]||(s[5]=d=>l.$emit("update:page",Math.min(b.value,o.page+1)))}," Next ",8,Qe)])])])):j("",!0)]))}},Ke=V(Je,[["__scopeId","data-v-1519d0d3"]]),We=o=>G.get("/yearly-attendance-summary",{params:o}),Xe=o=>G.get("/yearly-attendance-summary/export",{params:o,responseType:"blob"}),Ze={class:"space-y-6 px-4 pb-10"},we={class:"report-hero glass-panel px-5 py-4"},et={class:"flex flex-wrap items-center gap-2"},tt=["disabled"],at={class:"md:col-span-1 flex gap-2"},st={class:"min-w-0 relative"},nt=["value"],lt=["disabled"],dt=["disabled"],rt={key:0,class:"drawer"},it={class:"drawer__panel"},ot={class:"flex items-center justify-between border-b pb-3"},ut={class:"text-lg font-semibold text-slate-800"},pt={class:"mt-4 space-y-4"},ct={class:"rounded-xl border border-slate-100 bg-slate-50 p-3"},mt={class:"text-sm font-medium text-slate-800"},_t={class:"grid gap-3 sm:grid-cols-2"},yt={class:"rounded-xl border border-slate-100 bg-white p-3"},vt={class:"text-base font-semibold text-slate-800"},gt={class:"rounded-xl border border-slate-100 bg-white p-3"},bt={class:"rounded-xl border border-slate-100 bg-white p-3"},ft={class:"mt-2 space-y-1"},xt={class:"h-2 w-full rounded-full bg-slate-100"},ht={class:"text-xs text-slate-500"},$t={class:"rounded-xl border border-slate-100 bg-white p-3"},kt={class:"text-base font-semibold text-slate-800"},St={class:"rounded-xl border border-slate-100 bg-white p-3"},Ct={class:"text-base font-semibold text-slate-800"},qt={class:"rounded-xl border border-slate-100 bg-white p-3"},Nt={class:"text-base font-semibold text-slate-800"},At={__name:"YearlyAttendanceSummary",setup(o){const u=ne(),c=le(),Y=de(),k=_e(),b=ye(),{companies:S}=re(k),f=new Date().getFullYear(),D=P(()=>Array.from({length:6},(a,n)=>{const p=f-n;return{id:String(p),label:String(p)}})),e=A({year:u.query.year||String(f),company_id:u.query.company_id||"",department_id:u.query.department_id||"",department_id_is_null:u.query.department_id_is_null==="1",line_type:u.query.line_type||"all",employee_id:u.query.employee_id||u.query.user_id||"",user_id:u.query.user_id||u.query.employee_id||"",search:u.query.search||"",page:u.query.page?Number(u.query.page):1,per_page:u.query.per_page?Number(u.query.per_page):25,sort_by:u.query.sort_by||"attendance_score_avg",sort_dir:u.query.sort_dir||"desc"}),C=A([]),U=A({total:0,current_page:1,last_page:1,per_page:25}),q=A(!1),l=P(()=>q.value),s=A(null),d=A(!1),F=()=>{d.value=!1,s.value=null},T=a=>{const n=Number(a);return Number.isFinite(n)?`${n.toFixed(1)}%`:"—"},E=a=>{const n=Number(a);if(!Number.isFinite(n))return{label:"—",pct:0};const p=Math.max(0,Math.min(5,n));return{label:`${p.toFixed(2)} / 5`,pct:p/5*100}},H=a=>{const n=Number(a||0);return n>=95?"bg-emerald-50 text-emerald-700":n>=80?"bg-amber-50 text-amber-700":"bg-rose-50 text-rose-700"},Q=a=>{const n=(a==null?void 0:a.user_name)||(a==null?void 0:a.name)||(a==null?void 0:a.user)||(a==null?void 0:a.employee_name)||"";return n&&(a!=null&&a.user_id)?`${n} (${a.user_id})`:a!=null&&a.user_id?`#${a.user_id}`:n||"—"},J=a=>a!=null&&a.department_name?a.department_name:(a==null?void 0:a.department_id)==null?"Unassigned":String((a==null?void 0:a.department_id)||"Unassigned"),L=()=>{c.replace({query:{year:e.value.year||void 0,company_id:e.value.company_id||void 0,department_id:e.value.department_id||void 0,department_id_is_null:e.value.department_id_is_null?"1":void 0,line_type:e.value.line_type&&e.value.line_type!=="all"?e.value.line_type:void 0,user_id:e.value.user_id||void 0,employee_id:e.value.employee_id||void 0,search:e.value.search||void 0,page:e.value.page>1?String(e.value.page):void 0,per_page:e.value.per_page!==10?String(e.value.per_page):void 0,sort_by:e.value.sort_by&&e.value.sort_by!=="attendance_score_avg"?e.value.sort_by:void 0,sort_dir:e.value.sort_dir!=="desc"?e.value.sort_dir:void 0}}).catch(()=>{})},K=a=>{var n;return a?Array.isArray(a)?{data:a,meta:{}}:Array.isArray(a.data)?{data:a.data,meta:a.meta||{}}:Array.isArray((n=a==null?void 0:a.data)==null?void 0:n.data)?{data:a.data.data,meta:a.data.meta||{}}:{data:[],meta:a.meta||{}}:{data:[],meta:{}}},N=async()=>{var n,p,x,h,g,m,R;if(!e.value.company_id){C.value=[],U.value={total:0,current_page:1,last_page:1,per_page:e.value.per_page};return}const a={company_id:e.value.company_id,year:e.value.year||void 0,department_id:e.value.department_id||void 0,department_id_is_null:e.value.department_id_is_null?1:void 0,line_type:e.value.line_type&&e.value.line_type!=="all"?e.value.line_type:void 0,user_id:e.value.user_id||void 0,search:e.value.search||void 0,page:e.value.page,per_page:e.value.per_page,sort_by:e.value.sort_by,sort_dir:e.value.sort_dir};e.value.department_id_is_null&&delete a.department_id,q.value=!0;try{const v=await We(a),i=K(v==null?void 0:v.data);C.value=i.data||[],U.value={total:((n=i.meta)==null?void 0:n.total)??((p=i.data)==null?void 0:p.length)??0,current_page:((x=i.meta)==null?void 0:x.current_page)??e.value.page,last_page:((h=i.meta)==null?void 0:h.last_page)??1,per_page:((g=i.meta)==null?void 0:g.per_page)??e.value.per_page}}catch(v){Y.error(((R=(m=v==null?void 0:v.response)==null?void 0:m.data)==null?void 0:R.message)||"Failed to load yearly attendance summary")}finally{q.value=!1}},W=async()=>{e.value.page=1,e.value.user_id=e.value.employee_id||"",await N(),L()},X=async()=>{const a=(S.value||[]).length===1?String(S.value[0].id):"";e.value={year:String(f),company_id:a,department_id:"",department_id_is_null:!1,line_type:"all",employee_id:"",user_id:"",search:"",page:1,per_page:25,sort_by:"attendance_score_avg",sort_dir:"desc"},a&&await b.fetchDepartments(a),await N(),L()},Z=async({sort_by:a,sort_dir:n})=>{e.value.sort_by=a,e.value.sort_dir=n,e.value.page=1,await N(),L()},w=async a=>{e.value.page=a,await N(),L()},ee=async a=>{e.value.per_page=a,e.value.page=1,await N(),L()},te=a=>{s.value=a,d.value=!0},ae=async()=>{var a,n;if(e.value.company_id)try{const p={company_id:e.value.company_id,year:e.value.year||void 0,department_id:e.value.department_id||void 0,department_id_is_null:e.value.department_id_is_null?1:void 0,line_type:e.value.line_type&&e.value.line_type!=="all"?e.value.line_type:void 0,user_id:e.value.user_id||void 0,search:e.value.search||void 0,sort_by:e.value.sort_by,sort_dir:e.value.sort_dir};e.value.department_id_is_null&&delete p.department_id;const x=await Xe(p),h=new Blob([x.data],{type:"text/csv"}),g=window.URL.createObjectURL(h),m=document.createElement("a");m.href=g,m.setAttribute("download",`yearly_attendance_summary_${e.value.year}.csv`),document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(g)}catch(p){Y.error(((n=(a=p==null?void 0:p.response)==null?void 0:a.data)==null?void 0:n.message)||"Failed to export summary")}};ie(()=>e.value.company_id,async a=>{if(!a){C.value=[],e.value.department_id="",e.value.department_id_is_null=!1,e.value.employee_id="",e.value.user_id="";return}e.value.department_id="",e.value.department_id_is_null=!1,e.value.employee_id="",e.value.user_id="",await b.fetchDepartments(a)});const se=()=>{e.value.user_id=e.value.employee_id||"",e.value.department_id&&(e.value.department_id_is_null=!1)};return oe(async()=>{await k.fetchCompanies({ignore_permission:!0}),!e.value.company_id&&(S.value||[]).length===1&&(e.value.company_id=String(S.value[0].id)),e.value.company_id&&await b.fetchDepartments(e.value.company_id),await N()}),(a,n)=>{var p,x,h,g,m,R,v;return y(),_("div",Ze,[t("div",we,[n[6]||(n[6]=t("div",{class:"space-y-2"},[t("p",{class:"text-xs font-semibold uppercase tracking-[0.2em] text-slate-400"}," At a glance "),t("h1",{class:"title-md"},"Yearly Attendance Summary"),t("p",{class:"text-sm text-slate-500"}," Calculated from view yearly_attendance_summary ")],-1)),t("div",et,[t("button",{type:"button",class:"btn-2 inline-flex items-center gap-2 rounded-full px-4 py-2 text-xs font-semibold shadow-sm",disabled:!e.value.company_id,onClick:ae},n[5]||(n[5]=[t("i",{class:"far fa-file-csv text-base text-emerald-500"},null,-1),$(" Export CSV ")]),8,tt)])]),B(ge,{company_id:e.value.company_id,"onUpdate:company_id":n[1]||(n[1]=i=>e.value.company_id=i),department_id:e.value.department_id,"onUpdate:department_id":n[2]||(n[2]=i=>e.value.department_id=i),employee_id:e.value.employee_id,"onUpdate:employee_id":n[3]||(n[3]=i=>e.value.employee_id=i),line_type:e.value.line_type,"onUpdate:line_type":n[4]||(n[4]=i=>e.value.line_type=i),"with-type":!0,"initial-value":{...a.$route.query,employee_id:a.$route.query.employee_id||a.$route.query.user_id},onFilterChange:se,class:"w-full"},{default:ue(()=>[t("div",at,[t("div",st,[n[7]||(n[7]=t("label",{class:"top-label text-[10px] font-semibold uppercase tracking-wide text-slate-500"},"Year",-1)),pe(t("select",{"onUpdate:modelValue":n[0]||(n[0]=i=>e.value.year=i),class:"input-1 h-8 py-0 w-full text-xs"},[(y(!0),_(O,null,z(D.value,i=>(y(),_("option",{key:i.id,value:i.id},r(i.label),9,nt))),128))],512),[[ce,e.value.year]])]),t("button",{type:"button",class:"h-9 rounded-md border border-slate-300 px-3 text-xs font-semibold text-slate-600 hover:bg-slate-50 disabled:opacity-50",disabled:l.value,onClick:X}," Reset ",8,lt),t("button",{type:"button",class:"h-9 rounded-md bg-slate-900 px-3 text-xs font-semibold text-white hover:bg-slate-800 disabled:opacity-50",disabled:l.value,onClick:W}," Apply ",8,dt)])]),_:1},8,["company_id","department_id","employee_id","line_type","initial-value"]),B(Ke,{rows:C.value,meta:U.value,"is-loading":q.value,"sort-by":e.value.sort_by,"sort-dir":e.value.sort_dir,page:e.value.page,"per-page":e.value.per_page,onSortChange:Z,"onUpdate:page":w,"onUpdate:perPage":ee,onRowClick:te},null,8,["rows","meta","is-loading","sort-by","sort-dir","page","per-page"]),d.value&&s.value?(y(),_("div",rt,[t("div",{class:"drawer__overlay",onClick:F}),t("aside",it,[t("div",ot,[t("div",null,[n[8]||(n[8]=t("p",{class:"text-xs uppercase tracking-wide text-slate-400"},"User Detail",-1)),t("h2",ut,r(Q(s.value)),1)]),t("button",{class:"btn-3",type:"button",onClick:F},"Close")]),t("div",pt,[t("div",ct,[n[9]||(n[9]=t("p",{class:"text-xs font-semibold uppercase tracking-wide text-slate-400"},"Department",-1)),t("p",mt,r(J(s.value)),1)]),t("div",_t,[t("div",yt,[n[10]||(n[10]=t("p",{class:"text-xs font-semibold uppercase tracking-wide text-slate-400"},"Year",-1)),t("p",vt,r(s.value.year),1)]),t("div",gt,[n[11]||(n[11]=t("p",{class:"text-xs font-semibold uppercase tracking-wide text-slate-400"},"Present %",-1)),t("span",{class:I(["inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold",H((p=s.value)==null?void 0:p.yearly_present_pct)])},r(T((x=s.value)==null?void 0:x.yearly_present_pct)),3)]),t("div",bt,[n[12]||(n[12]=t("p",{class:"text-xs font-semibold uppercase tracking-wide text-slate-400"},"Early & Delay Score Avg",-1)),t("div",ft,[t("div",xt,[t("div",{class:"h-2 rounded-full bg-emerald-500",style:me({width:`${E((h=s.value)==null?void 0:h.attendance_score_avg).pct}%`})},null,4)]),t("p",ht,r(E((g=s.value)==null?void 0:g.attendance_score_avg).label),1)])]),t("div",$t,[n[13]||(n[13]=t("p",{class:"text-xs font-semibold uppercase tracking-wide text-slate-400"},"Score Months",-1)),t("p",kt,r(((m=s.value)==null?void 0:m.score_months)??"—"),1)]),t("div",St,[n[14]||(n[14]=t("p",{class:"text-xs font-semibold uppercase tracking-wide text-slate-400"},"Present Avg Score",-1)),t("p",Ct,r(((R=s.value)==null?void 0:R.yearly_present_score_avg)??"—"),1)]),t("div",qt,[n[15]||(n[15]=t("p",{class:"text-xs font-semibold uppercase tracking-wide text-slate-400"},"Total Months",-1)),t("p",Nt,r(((v=s.value)==null?void 0:v.total_months)??"—"),1)])]),n[16]||(n[16]=t("div",{class:"rounded-xl border border-dashed border-slate-200 bg-slate-50 p-4 text-sm text-slate-500"}," Trend placeholder: monthly performance sparkline coming soon. ",-1))])])])):j("",!0)])}}},Tt=V(At,[["__scopeId","data-v-5be82e9e"]]);export{Tt as default};
