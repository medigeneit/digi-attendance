import{d as X,u as Z,b as ee,q as w,r as k,e as ae,a1 as te,A as le,k as se,c as v,o as p,a,m as oe,l as $,p as ne,n as ie,w as re,f as R,g as c,v as U,t as T,F as q,x as I,h as z,a2 as B}from"./index-CoUwBTUV.js";import{L as de}from"./LoaderView-BzGG-GjH.js";import{_ as ue}from"./MultiselectDropdown-BvYhE-Z5.js";import{u as pe}from"./holiday-Cxz9Eg-p.js";import{u as ve}from"./leave-application-DYA9e1ub.js";import{u as ce}from"./leave-type-E5VyX0xR.js";import{u as me}from"./user-c2TziuNA.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const _e={class:"my-container max-w-3xl space-y-4"},fe={class:"flex items-center justify-between gap-2"},ye={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},we={key:0,class:""},ke={class:"text-blue-600 font-medium"},ge={key:1,class:"bg-gray-100 p-2 rounded-md"},he={class:"font-semibold"},be={class:"flex flex-wrap gap-2"},De=["name","value","onUpdate:modelValue"],Ae={class:"flex items-center space-x-1"},xe=["name","onUpdate:modelValue"],Se={class:"flex items-center space-x-1"},Le=["name","onUpdate:modelValue"],Ue={key:2,class:"text-red-500 text-sm"},Ne={__name:"LeaveApplicationEdit",setup(Te){const m=X(),r=ve(),H=Z(),M=ee(),g=ce(),_=me(),J=pe(),V=w(()=>r.leaveApplication),P=w(()=>M.params.id),b=k(null),s=k({user_id:"",last_working_date:"",resumption_date:"",reason:"",works_in_hand:"",handover_user_id:"",leave_days:[]}),d=k([]),D=k(!1),A=k(null),C=k(!1),Y=w(()=>{var t,e,i;return((e=(t=m==null?void 0:m.user)==null?void 0:t.assign_weekend)==null?void 0:e.weekends)||((i=m==null?void 0:m.user)==null?void 0:i.weekends)});ae(async()=>{var e,i,o,l,n,f,x,S,F,N,W,j;const{id:t}=M.params;C.value=!!t;try{await r.fetchLeaveApplicationById(t);const L=(o=(i=(e=r.leaveApplication)==null?void 0:e.user)==null?void 0:i.company)==null?void 0:o.id;if(L&&await g.fetchLeaveTypes(L),r.leaveApplication){if(await _.fetchTypeWiseEmployees({type:r.leaveApplication.user.type,except:[r.leaveApplication.user.id]}),_.users=_.users.map(y=>({...y,label:y.name})),_.users.length>0){const y=w(()=>_.users.find(E=>{var h;return E.id===((h=r.leaveApplication)==null?void 0:h.handover_user_id)})||{});b.value=y.value}s.value.user_id=(l=r.leaveApplication)==null?void 0:l.user_id,s.value.last_working_date=(n=r.leaveApplication)==null?void 0:n.last_working_date,s.value.resumption_date=(f=r.leaveApplication)==null?void 0:f.resumption_date,s.value.reason=(x=r.leaveApplication)==null?void 0:x.reason,s.value.works_in_hand=(S=r.leaveApplication)==null?void 0:S.works_in_hand,s.value.handover_user_id=(F=r.leaveApplication)==null?void 0:F.handover_user_id,s.value.leave_days=(N=r.leaveApplication)==null?void 0:N.leave_days,(W=r.leaveApplication)!=null&&W.json_data&&((j=r.leaveApplication)==null||j.json_data.forEach((y,E)=>{var h;d.value[E]=y.leave_type_id||((h=g.leaveTypes[0])==null?void 0:h.id)}))}}catch(L){console.error("Failed to load leave application:",L)}finally{D.value=!1}});const u=w(()=>{const t=s.value.last_working_date,e=s.value.resumption_date;if(!t||!e)return[];const i=new Date(t),o=new Date(e);if(o<=i)return[];const l=[];let n=new Date(i);for(n.setDate(n.getDate()+1);n<o;){const f=n.getFullYear(),x=(n.getMonth()+1).toString().padStart(2,"0"),S=n.getDate().toString().padStart(2,"0");l.push(`${f}-${x}-${S}`),n.setDate(n.getDate()+1)}return l}),G=w(()=>{const t=s.value.last_working_date,e=s.value.resumption_date;if(!t||!e)return"";const i=new Date(t);return new Date(e)<=i?"Resumption date must be after Last Working Date.":u.value.length===0?"No leave days between the selected dates.":`Total leave days: ${u.value.length}`});te(()=>{C.value||u.value.length&&g.leaveTypes.length&&(d.value.length!==u.value.length&&(d.value=u.value.map(()=>{var t;return(t=g.leaveTypes[0])==null?void 0:t.id})),u.value.forEach(async(t,e)=>{const i=new Date(t).toLocaleString("en-us",{weekday:"long"}).toLowerCase(),o=i.charAt(0).toUpperCase()+i.slice(1);Y.value.includes(o)&&(d.value[e]="weekend"),await Q(t)&&(d.value[e]="holiday")}))}),le(()=>b.value,t=>{s.value.handover_user_id=t==null?void 0:t.id});const K=async()=>{var t;D.value=!0,A.value=null;try{const e=u.value.map((l,n)=>({date:l,leave_type_id:d.value[n]!=="weekend"&&d.value[n]!=="holiday"?d.value[n]:null})).filter(l=>l.leave_type_id!==null),i=u.value.map((l,n)=>({date:l,leave_type_id:d.value[n]||""})),o={id:P.value,user_id:(t=V==null?void 0:V.value)==null?void 0:t.user_id,last_working_date:s.value.last_working_date,resumption_date:s.value.resumption_date,reason:s.value.reason,works_in_hand:s.value.works_in_hand,handover_user_id:s.value.handover_user_id,leave_days:e,json_data:i};if(o.id){const l=await r.updateLeaveApplication(o.id,o);l&&H.push({name:"LeaveApplicationShow",params:{id:l==null?void 0:l.id}})}}catch(e){A.value=e.message||"Failed to submit leave application"}finally{D.value=!1}},O=()=>H.go(-1),Q=async t=>{var e;try{return(((e=(await J.fetchHolidays({start_date:t}))[0])==null?void 0:e.start_date)||[]).includes(t)}catch(i){return console.error("Error fetching holidays:",i),!1}};return(t,e)=>{const i=se("RouterLink");return p(),v("div",_e,[a("div",fe,[a("button",{class:"btn-3",onClick:O},e[5]||(e[5]=[a("i",{class:"far fa-arrow-left"},null,-1),a("span",{class:"hidden md:flex"},"Back",-1)])),e[7]||(e[7]=a("h1",{class:"title-md md:title-lg flex-wrap text-center"},"Leave Application Form",-1)),a("div",null,[$(i,{to:"/applications",class:"btn-2"},{default:ne(()=>e[6]||(e[6]=[ie("Home")])),_:1,__:[6]})])]),D.value?(p(),oe(de,{key:0})):(p(),v("form",{key:1,onSubmit:re(K,["prevent"]),class:"space-y-4 card-bg p-4 md:p-8"},[a("div",ye,[a("div",null,[e[8]||(e[8]=a("label",{for:"last-working-date",class:"block text-sm font-medium"},"Last Working Date",-1)),c(a("input",{type:"date",id:"last-working-date","onUpdate:modelValue":e[0]||(e[0]=o=>s.value.last_working_date=o),class:"input-1 w-full",required:""},null,512),[[U,s.value.last_working_date]])]),a("div",null,[e[9]||(e[9]=a("label",{for:"resumption-date",class:"block text-sm font-medium"},"Resumption Date",-1)),c(a("input",{type:"date",id:"resumption-date","onUpdate:modelValue":e[1]||(e[1]=o=>s.value.resumption_date=o),class:"input-1 w-full",required:""},null,512),[[U,s.value.resumption_date]])])]),s.value.last_working_date&&s.value.resumption_date?(p(),v("div",we,[a("p",ke,T(G.value),1)])):R("",!0),u.value.length?(p(),v("div",ge,[e[12]||(e[12]=a("h2",{class:"text-lg font-semibold"},"Leave Days",-1)),a("div",null,[(p(!0),v(q,null,I(u.value,(o,l)=>(p(),v("div",{key:l,class:"flex gap-4 mb-2 bg-white p-2 rounded-md"},[a("div",he,T(o),1),a("div",be,[(p(!0),v(q,null,I(z(g).leaveTypes,n=>(p(),v("label",{key:n.id,class:"flex items-center space-x-1"},[c(a("input",{type:"radio",name:"leaveType-"+l,value:n.id,"onUpdate:modelValue":f=>d.value[l]=f},null,8,De),[[B,d.value[l]]]),a("span",null,T(n.name),1)]))),128)),a("label",Ae,[c(a("input",{type:"radio",name:"leaveType-"+l,value:"weekend","onUpdate:modelValue":n=>d.value[l]=n},null,8,xe),[[B,d.value[l]]]),e[10]||(e[10]=a("span",null,"Weekend",-1))]),a("label",Se,[c(a("input",{type:"radio",name:"leaveType-"+l,value:"holiday","onUpdate:modelValue":n=>d.value[l]=n},null,8,Le),[[B,d.value[l]]]),e[11]||(e[11]=a("span",null," Holiday",-1))])])]))),128))])])):R("",!0),a("div",null,[e[13]||(e[13]=a("label",{for:"reason",class:"block text-sm font-medium"},"Reason",-1)),c(a("textarea",{id:"reason","onUpdate:modelValue":e[2]||(e[2]=o=>s.value.reason=o),class:"input-1 w-full",placeholder:"Enter your reason for leave"},null,512),[[U,s.value.reason]])]),a("div",null,[e[14]||(e[14]=a("label",{for:"handover-user",class:"block text-sm font-medium"},"Handover User",-1)),$(ue,{modelValue:b.value,"onUpdate:modelValue":e[3]||(e[3]=o=>b.value=o),options:z(_).users,multiple:!1,label:"label",placeholder:"Select user"},null,8,["modelValue","options"])]),a("div",null,[e[15]||(e[15]=a("label",{for:"works-in-hand",class:"block text-sm font-medium"},"Works in Hand",-1)),c(a("textarea",{id:"works-in-hand","onUpdate:modelValue":e[4]||(e[4]=o=>s.value.works_in_hand=o),class:"input-1 w-full",placeholder:"Enter details of works in hand",rows:"6"},null,512),[[U,s.value.works_in_hand]])]),A.value?(p(),v("div",Ue,T(A.value),1)):R("",!0),e[16]||(e[16]=a("div",{class:"flex justify-end"},[a("button",{type:"submit",class:"btn-1"},"Update")],-1))],32))])}}};export{Ne as default};
