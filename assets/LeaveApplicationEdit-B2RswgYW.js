import{d as te,u as le,b as se,z as oe,m as g,r as _,e as ne,a4 as ie,n as z,A as re,c as v,o as p,a as t,f as de,x as Y,i as ue,j as pe,w as ve,g as R,h as f,v as S,t as U,F as J,q as O,k as P,a5 as j}from"./index-C8Q_jJxd.js";import{L as ce}from"./LoaderView-DgaOprXB.js";import{_ as me}from"./MultiselectDropdown-BTkBgQ42.js";import{u as _e}from"./holiday-Byp3K15e.js";import{u as fe}from"./leave-application-BgXtdv_4.js";import{u as ye}from"./leave-type-CguNws5I.js";import{u as ge}from"./user-Bhi0xIQz.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const we={class:"my-container max-w-3xl space-y-4"},ke={class:"flex items-center justify-between gap-2"},he={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},be={key:0,class:""},De={class:"text-blue-600 font-medium"},xe={key:1,class:"bg-gray-100 p-2 rounded-md"},Ae={class:"font-semibold"},Le={class:"flex flex-wrap gap-2"},Se=["name","value","onUpdate:modelValue","disabled"],Ue={class:"flex items-center space-x-1"},Ve=["name","onUpdate:modelValue"],Te={class:"flex items-center space-x-1"},Ee=["name","onUpdate:modelValue"],Be={key:2,class:"text-red-500 text-sm"},qe={__name:"LeaveApplicationEdit",setup(Re){const V=te(),n=fe(),C=le(),M=se(),G=ye(),c=ge(),{userLeaveBalance:w}=oe(c),F=_e(),T=g(()=>n.leaveApplication),K=g(()=>M.params.id),h=_(null),s=_({user_id:"",last_working_date:"",resumption_date:"",reason:"",works_in_hand:"",handover_user_id:"",leave_days:[]}),d=_([]),E=_([]),b=_(!1),D=_(null),Q=_(!1),X=g(()=>{var i,e,r,a,l;return((r=(e=(i=n==null?void 0:n.leaveApplication)==null?void 0:i.user)==null?void 0:e.assign_weekend)==null?void 0:r.weekends)||((l=(a=n==null?void 0:n.leaveApplication)==null?void 0:a.user)==null?void 0:l.weekends)||[]});ne(async()=>{var e,r,a,l,o,m,x,A,H,N,W,$,q,I;c.fetchUserLeaveBalances((r=(e=n.leaveApplication)==null?void 0:e.user)==null?void 0:r.id);const{id:i}=M.params;Q.value=!!i;try{await n.fetchLeaveApplicationById(i);const L=(o=(l=(a=n.leaveApplication)==null?void 0:a.user)==null?void 0:l.company)==null?void 0:o.id;if(L&&await G.fetchLeaveTypes(L),n.leaveApplication){if(await c.fetchTypeWiseEmployees({type:n.leaveApplication.user.type,except:[n.leaveApplication.user.id]}),c.users=c.users.map(y=>({...y,label:y.name})),c.users.length>0){const y=g(()=>c.users.find(B=>{var k;return B.id===((k=n.leaveApplication)==null?void 0:k.handover_user_id)})||{});h.value=y.value}s.value.user_id=(m=n.leaveApplication)==null?void 0:m.user_id,s.value.last_working_date=(x=n.leaveApplication)==null?void 0:x.last_working_date,s.value.resumption_date=(A=n.leaveApplication)==null?void 0:A.resumption_date,s.value.reason=(H=n.leaveApplication)==null?void 0:H.reason,s.value.works_in_hand=(N=n.leaveApplication)==null?void 0:N.works_in_hand,s.value.handover_user_id=(W=n.leaveApplication)==null?void 0:W.handover_user_id,s.value.leave_days=($=n.leaveApplication)==null?void 0:$.leave_days,(q=n.leaveApplication)!=null&&q.json_data&&((I=n.leaveApplication)==null||I.json_data.forEach((y,B)=>{var k;console.log(n.leaveApplication),d.value[B]=y.leave_type_id||((k=w.value[0])==null?void 0:k.id)}))}}catch(L){console.error("Failed to load leave application:",L)}finally{b.value=!1}});const u=g(()=>{const i=s.value.last_working_date,e=s.value.resumption_date;if(!i||!e)return[];const r=new Date(i),a=new Date(e);if(a<=r)return[];const l=[];let o=new Date(r);for(o.setDate(o.getDate()+1);o<a;){const m=o.getFullYear(),x=(o.getMonth()+1).toString().padStart(2,"0"),A=o.getDate().toString().padStart(2,"0");l.push(`${m}-${x}-${A}`),o.setDate(o.getDate()+1)}return l}),Z=g(()=>{const i=s.value.last_working_date,e=s.value.resumption_date;if(!i||!e)return"";const r=new Date(i);return new Date(e)<=r?"Resumption date must be after Last Working Date.":u.value.length===0?"No leave days between the selected dates.":`Total leave days: ${u.value.length}`});ie(async()=>{var i;u.value.length&&w.value.length&&(d.value.length!==u.value.length&&(d.value=u.value.map(()=>{var e;return(e=w.value[0])==null?void 0:e.id})),await F.fetchHolidays({company_id:(i=V==null?void 0:V.user)==null?void 0:i.company_id,start_date:u.value[0],end_date:u.value[u.value.length-1]}),u.value.forEach(async(e,r)=>{const a=new Date(e).toLocaleString("en-us",{weekday:"long"}).toLowerCase(),l=a.charAt(0).toUpperCase()+a.slice(1);X.value.includes(l)&&(d.value[r]="weekend"),F.holidayDates.includes(e)&&(d.value[r]="holiday")}))}),z(()=>h.value,i=>{s.value.handover_user_id=i==null?void 0:i.id}),z(d,i=>{const e={};i.forEach(a=>{typeof a=="number"&&(e[a]=(e[a]||0)+1)});const r=w.value.filter(a=>(e[a.id]||0)>a.remaining_days);r.length?(E.value=r.map(a=>a.name),alert(`You have exceeded remaining days for: ${E.value.join(", ")}`)):E.value=[]});const ee=async()=>{var i;b.value=!0,D.value=null;try{const e=u.value.map((l,o)=>({date:l,leave_type_id:d.value[o]!=="weekend"&&d.value[o]!=="holiday"?d.value[o]:null})).filter(l=>l.leave_type_id!==null),r=u.value.map((l,o)=>({date:l,leave_type_id:d.value[o]||""})),a={id:K.value,user_id:(i=T==null?void 0:T.value)==null?void 0:i.user_id,last_working_date:s.value.last_working_date,resumption_date:s.value.resumption_date,reason:s.value.reason,works_in_hand:s.value.works_in_hand,handover_user_id:s.value.handover_user_id,leave_days:e,json_data:r};if(a.id){const l=await n.updateLeaveApplication(a.id,a);l&&C.push({name:"LeaveApplicationShow",params:{id:l==null?void 0:l.id}})}}catch(e){D.value=e.message||"Failed to submit leave application"}finally{b.value=!1}},ae=()=>C.go(-1);return(i,e)=>{const r=re("RouterLink");return p(),v("div",we,[t("div",ke,[t("button",{class:"btn-3",onClick:ae},e[5]||(e[5]=[t("i",{class:"far fa-arrow-left"},null,-1),t("span",{class:"hidden md:flex"},"Back",-1)])),e[7]||(e[7]=t("h1",{class:"title-md md:title-lg flex-wrap text-center"},"Leave Application Edit Form",-1)),t("div",null,[Y(r,{to:"/applications",class:"btn-2"},{default:ue(()=>e[6]||(e[6]=[pe("Home")])),_:1,__:[6]})])]),b.value?(p(),de(ce,{key:0})):(p(),v("form",{key:1,onSubmit:ve(ee,["prevent"]),class:"space-y-4 card-bg p-4 md:p-8"},[t("div",he,[t("div",null,[e[8]||(e[8]=t("label",{for:"last-working-date",class:"block text-sm font-medium"},"Last Working Date",-1)),f(t("input",{type:"date",id:"last-working-date","onUpdate:modelValue":e[0]||(e[0]=a=>s.value.last_working_date=a),class:"input-1 w-full",required:""},null,512),[[S,s.value.last_working_date]])]),t("div",null,[e[9]||(e[9]=t("label",{for:"resumption-date",class:"block text-sm font-medium"},"Resumption Date",-1)),f(t("input",{type:"date",id:"resumption-date","onUpdate:modelValue":e[1]||(e[1]=a=>s.value.resumption_date=a),class:"input-1 w-full",required:""},null,512),[[S,s.value.resumption_date]])])]),s.value.last_working_date&&s.value.resumption_date?(p(),v("div",be,[t("p",De,U(Z.value),1)])):R("",!0),u.value.length?(p(),v("div",xe,[e[12]||(e[12]=t("h2",{class:"text-lg font-semibold"},"Leave Days",-1)),t("div",null,[(p(!0),v(J,null,O(u.value,(a,l)=>(p(),v("div",{key:l,class:"flex gap-4 mb-2 bg-white p-2 rounded-md"},[t("div",Ae,U(a),1),t("div",Le,[(p(!0),v(J,null,O(P(w),o=>(p(),v("label",{key:o.id,class:"flex items-center space-x-1"},[f(t("input",{type:"radio",name:"leaveType-"+l,value:o.id,"onUpdate:modelValue":m=>d.value[l]=m,disabled:d.value.filter(m=>m===o.id).length>=o.remaining_days},null,8,Se),[[j,d.value[l]]]),t("span",null,U(o.leave_type),1)]))),128)),t("label",Ue,[f(t("input",{type:"radio",name:"leaveType-"+l,value:"weekend","onUpdate:modelValue":o=>d.value[l]=o},null,8,Ve),[[j,d.value[l]]]),e[10]||(e[10]=t("span",null,"Weekend",-1))]),t("label",Te,[f(t("input",{type:"radio",name:"leaveType-"+l,value:"holiday","onUpdate:modelValue":o=>d.value[l]=o},null,8,Ee),[[j,d.value[l]]]),e[11]||(e[11]=t("span",null," Holiday",-1))])])]))),128))])])):R("",!0),t("div",null,[e[13]||(e[13]=t("label",{for:"reason",class:"block text-sm font-medium"},"Reason",-1)),f(t("textarea",{id:"reason","onUpdate:modelValue":e[2]||(e[2]=a=>s.value.reason=a),class:"input-1 w-full",placeholder:"Enter your reason for leave"},null,512),[[S,s.value.reason]])]),t("div",null,[e[14]||(e[14]=t("label",{for:"handover-user",class:"block text-sm font-medium"},"Handover User",-1)),Y(me,{modelValue:h.value,"onUpdate:modelValue":e[3]||(e[3]=a=>h.value=a),options:P(c).users,multiple:!1,label:"label",placeholder:"Select user"},null,8,["modelValue","options"])]),t("div",null,[e[15]||(e[15]=t("label",{for:"works-in-hand",class:"block text-sm font-medium"},"Works in Hand",-1)),f(t("textarea",{id:"works-in-hand","onUpdate:modelValue":e[4]||(e[4]=a=>s.value.works_in_hand=a),class:"input-1 w-full",placeholder:"Enter details of works in hand",rows:"6"},null,512),[[S,s.value.works_in_hand]])]),D.value?(p(),v("div",Be,U(D.value),1)):R("",!0),e[16]||(e[16]=t("div",{class:"flex justify-end"},[t("button",{type:"submit",class:"btn-1"},"Update")],-1))],32))])}}};export{qe as default};
