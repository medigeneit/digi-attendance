import{L as dt}from"./LoaderView-CsbGm7ZA.js";import{O as P}from"./OverlyModal-C91Zma20.js";import{_ as q}from"./DepartmentChip-DCih9KbZ.js";import{b as ut,_ as ct}from"./TaskTableRow-Df-uVY8N.js";import{_ as mt}from"./TaskAddForm-Cv2CVcsR.js";import{_ as kt}from"./TaskEditForm-TpzpL_6f.js";import{a as pt}from"./TaskUserAssignForm-Dx8dUfO5.js";import{f as yt,g as tt,x as j,p as ft,c as r,o as n,k as y,a as s,F,e as R,s as H,j as T,t as b,m as M,b as J,w as _t,n as C,r as O,G as Q,h as gt,q as vt,d as h,N as ht}from"./index-B_xL3wTw.js";import{u as xt}from"./task-priority-CwSaKHA_.js";import{u as wt}from"./useRequirementStore-DsaPdVlR.js";import{u as bt}from"./useTaskStore-Cf95cbP5.js";const Tt={class:"w-full p-1"},Ct={key:0,class:"w-full rounded-b"},At={class:"group/dept"},$t={class:"flex gap-1 items-center text-base"},Lt={class:"font-bold text-lime-600"},It={key:0},Bt=["onClick"],Ft={class:"ml-auto"},St=["onClick"],G={__name:"TaskTable",props:{tasks:{type:Array,required:!0,default:()=>[]},hideButtons:{type:Boolean,default:!1},parentTreeLevel:{type:Number},maxItem:{Number,default:5},isMyTask:{type:Boolean,default:!1},taskLinkTo:{type:Function,default:null}},emits:["editClick","addClick","employeeAssignClick","clickAddClick","clickAttachment"],setup(A,{emit:K}){const W=A,k=yt(),p=tt(),z=j(()=>W.tasks.reduce((f,a)=>{var d;const $=((d=a.requirement)==null?void 0:d.id)||"-",u=[...f],e=u.find(x=>(x==null?void 0:x.key)==$);return e?e.tasks=[...e.tasks,a]:u.push({key:$,position:a!=null&&a.requirement?0:1,...(a==null?void 0:a.requirement)||{title:"(Other tasks)",id:0},tasks:[a]}),u},[]).sort((f,a)=>f.position-a.position)),m=K;return(f,a)=>{var u;const $=ft("RouterLink");return n(),r("div",Tt,[((u=A.tasks)==null?void 0:u.length)>0?(n(),r("table",Ct,[a[4]||(a[4]=s("thead",null,[s("tr",null,[s("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 w-[30px] sticky -top-4 z-20"}," SL "),s("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Task "),s("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Assign Person "),s("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Deadline "),s("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 -top-4 z-20 sticky right-0 border-l bg-sky-50 px-2 whitespace-nowrap"}," Status ")])],-1)),s("tbody",null,[(n(!0),r(F,null,R(z.value,(e,d)=>{var x,E,L,S,N,U;return n(),r(F,{key:e.id},[s("tr",At,[s("th",{colspan:"10",class:H(["font-semibold",[(d>0,"")]])},[s("div",{class:H(["text-left -mx-[2px] -mb-[1px] py-2 px-2 flex items-center border border-b-0 rounded-t bg-emerald-50",[e.id===0?"text-gray-500":"text-sky-800",d>0?"mt-4":""]])},[s("div",$t,[s("div",Lt,b(d+1)+".",1),e.id===0?(n(),r("p",It,b(e.title),1)):(n(),T($,{key:1,to:`requirements/show/${e.id}`,class:"line-clamp-2 hover:underline"},{default:M(()=>[J(b(e.title),1)]),_:2},1032,["to"])),((x=e.attachments)==null?void 0:x.length)>0?(n(),r("button",{key:2,class:"text-sky-400 text-sm",onClick:_t(_=>m("clickAttachment",e.attachments),["prevent"])},[a[2]||(a[2]=s("i",{class:"fas fa-paperclip"},null,-1)),J(" "+b((E=e.attachments)==null?void 0:E.length)+" Attachment"+b(((L=e.attachments)==null?void 0:L.length)>1?"s":""),1)],8,Bt)):y("",!0)]),s("div",Ft,[((S=C(k))==null?void 0:S.name)=="RequirementTaskList"&&((U=(N=C(p))==null?void 0:N.user)==null?void 0:U.department_id)==(e==null?void 0:e.to_department_id)?(n(),r("button",{key:0,onClick:_=>m("clickAddTask",{requirement_id:e==null?void 0:e.id,from_department_id:e==null?void 0:e.from_department_id,to_department_id:e==null?void 0:e.to_department_id},{requirement_id:!0,from_department_id:!0,to_department_id:!0}),class:"btn-2 whitespace-nowrap h-6 px-3 opacity-70 group-hover/dept:opacity-100"},a[3]||(a[3]=[s("i",{class:"fas fa-plus-circle"},null,-1),J(" Add Task ")]),8,St)):y("",!0)])],2)],2)]),(n(!0),r(F,null,R(e.tasks,(_,I)=>(n(),T(ut,{key:_.id,task:_,indexing:`${d+1}.${I+1}`,onEditClick:a[0]||(a[0]=B=>m("editClick",B)),onEmployeeAssignClick:a[1]||(a[1]=B=>m("employeeAssignClick",B)),taskLinkTo:A.taskLinkTo,hideButtons:A.hideButtons},null,8,["task","indexing","taskLinkTo","hideButtons"]))),128))],64)}),128))])])):y("",!0)])}}},Ot={class:"mb-4"},Mt={key:4,class:"text-center py-4 text-red-500"},Rt={class:"relative min-h-[60vh]"},zt={key:0,class:"space-y-6"},Et={class:"sticky top-14 z-40 text-gray-700 bg-gradient-to-tl from-sky-400/60 to-sky-400 py-2 px-4 flex items-center"},Nt={class:"font-semibold flex items-center gap-2"},Ut={class:"text-white text-base"},Vt={class:"rounded-b-md overflow-y-auto"},Dt={key:1,class:"space-y-6"},Pt={class:"sticky top-14 z-40 text-gray-700 bg-gradient-to-tl from-sky-400/60 to-sky-400 py-2 px-4 flex items-center"},jt={class:"font-semibold flex items-center gap-2"},Ht={class:"ml-auto"},Kt=["onClick"],Jt={class:"rounded-b-md overflow-y-auto"},Qt={key:2,class:"text-center py-4 text-gray-500 border h-[60vh] flex items-center justify-center rounded bg-gray-50 italic"},oe={__name:"RequirementTaskList",props:{taskFilters:{type:Object,default:()=>({})},showOnlyMyTasks:{type:Boolean,default:!1},inContainer:{type:Boolean,default:!0}},emits:["update:taskFilters"],setup(A,{expose:K,emit:W}){const k=A,p=bt(),z=wt(),m=O(""),f=O(null),a=O(!1),$=tt(),u=Q({show:!1,attachments:[]}),e=Q({parentId:0,requirementId:0,params:{}}),d=Q({taskId:0,isOpen:!1}),x=j(()=>{const i=k.taskFilters["user-ids"]||null,t=(p.tasks||[]).flatMap(c=>{var v;return i?(v=c.users)==null?void 0:v.filter(V=>i.includes(V.id)):c.users});return[...new Map(t.map(c=>[c.id,c])).values()].sort((c,v)=>c.id-v.id)}),E=j(()=>(p.tasks||[]).reduce((i,t)=>{const w=`${t.from_department_id}-${t.to_department_id}`,c=i.find(v=>v.key==w);return c?c.tasks=[...c.tasks,t]:i.push({key:w,from_department:t.from_department,to_department:t.to_department,tasks:[t]}),i},[])),L=O(null),S=O([]),{saveTaskPriority:N,listHasRearranged:U}=xt(()=>p.taskListTree,0);gt(()=>{m.value="loading",_()});async function _(){k.showOnlyMyTasks?await p.fetchAllMyTasks({...k.taskFilters,page:1}):await p.fetchAllTasks({...k.taskFilters,page:1}),m.value="",S.value=p.query_log||[]}const I=(i,t)=>{a.value=!0,e.params=i,e.readonlyValues=t},B=i=>{d.taskId=i,d.isOpen=!0};async function X(){f.value=null,a.value=!1,m.value="loading",e.params={},await _()}async function et(){a.value=!1,e.params={},await _()}async function st(){m.value="loading",await N()&&await _()}function at(i){return p.tasks.filter(t=>(t.users||[]).some(w=>w.id===i))}vt(()=>({...k.taskFilters}),async()=>{try{p.resetTaskList(),m.value="loading",await _()}catch(i){console.warn(i)}});function nt(i,t){I(i,t)}function ot(){return st()}function it(){return U&&L.value&&L.value.resetItems?L.value.resetItems():null}K({openAdd:nt,savePriority:ot,discardPriority:it});function rt(i){return{name:"RequirementTaskShow",params:{id:(i==null?void 0:i.id)||0}}}const lt=j(()=>k.inContainer?"p-6 mt-2 container mx-auto relative bg-white rounded-md shadow-md min-h-[calc(100vh-12rem)]":"");return(i,t)=>{var w,c,v,V;return n(),r("div",{class:H(lt.value)},[f.value?(n(),T(P,{key:0},{default:M(()=>[h(kt,{taskId:f.value,onClose:t[0]||(t[0]=o=>f.value=null),onUpdated:X},null,8,["taskId"])]),_:1})):y("",!0),a.value?(n(),T(P,{key:1},{default:M(()=>{var o,l;return[h(mt,{parentTaskId:e.parentId,requirementId:(o=e.params)==null?void 0:o.requirement_id,requirementDetailId:(l=e.params)==null?void 0:l.requirement_detail_id,"default-values":e.params,"readonly-fields":e.readonlyValues,onClose:et,onTaskCreated:X},null,8,["parentTaskId","requirementId","requirementDetailId","default-values","readonly-fields"])]}),_:1})):y("",!0),d.isOpen?(n(),T(P,{key:2,class:"*:max-w-4xl"},{default:M(()=>[h(pt,{taskId:d.taskId,onCancelClick:t[1]||(t[1]=()=>{d.isOpen=!1,d.taskId=0}),onSuccess:t[2]||(t[2]=()=>{d.isOpen=!1,d.taskId=0,m.value="loading",_()})},null,8,["taskId"])]),_:1})):y("",!0),((w=k.taskFilters)==null?void 0:w["query-log"])=="true"?(n(!0),r(F,{key:3},R(S.value,(o,l)=>(n(),r("div",{key:l,class:"text-xs text-gray-500"},[s("div",Ot,b(o.raw_query),1)]))),128)):y("",!0),C(z).error?(n(),r("div",Mt,b(C(z).error),1)):y("",!0),s("div",Rt,[((c=k.taskFilters)==null?void 0:c.view)==="userwise"?(n(),r("div",zt,[(n(!0),r(F,null,R(x.value,o=>(n(),r("div",{key:o.id,class:"rounded-md border-2 border-sky-300"},[s("div",Et,[s("div",Nt,[h(ht,{user:o},null,8,["user"]),s("div",Ut,b(o.label),1)])]),s("div",Vt,[h(G,{tasks:at(o.id),onEditClick:t[3]||(t[3]=l=>f.value=l),onAddClick:t[4]||(t[4]=l=>I(l)),onEmployeeAssignClick:t[5]||(t[5]=l=>B(l)),onClickAttachment:t[6]||(t[6]=l=>{u.show=!0,u.attachments=l}),taskLinkTo:l=>({name:"RequirementTaskShow",params:{id:(l==null?void 0:l.id)||0}})},null,8,["tasks","taskLinkTo"])])]))),128))])):(n(),r("div",Dt,[(n(!0),r(F,null,R(E.value,o=>{var l,Y,Z;return n(),r("div",{key:o.key,class:"rounded-md border-2 border-sky-300"},[s("div",Pt,[s("div",jt,[t[12]||(t[12]=s("span",{class:"text-white text-sm"},"From",-1)),h(q,{department:o.from_department},null,8,["department"]),t[13]||(t[13]=s("span",{class:"text-white text-sm"},"To",-1)),h(q,{department:o.to_department},null,8,["department"])]),s("div",Ht,[!k.showOnlyMyTasks&&((Y=(l=C($))==null?void 0:l.user)==null?void 0:Y.department_id)==((Z=o==null?void 0:o.to_department)==null?void 0:Z.id)?(n(),r("button",{key:0,onClick:()=>{var g,D;return I({from_department_id:(g=o==null?void 0:o.from_department)==null?void 0:g.id,to_department_id:(D=o==null?void 0:o.to_department)==null?void 0:D.id},{from_department_id:!0,to_department_id:!0})},class:"btn-3 h-6 whitespace-nowrap bg-white border-white px-2"}," Add Task ",8,Kt)):y("",!0)])]),s("div",Jt,[h(G,{tasks:o.tasks,groupBy:"requirement",onEditClick:t[7]||(t[7]=g=>f.value=g),onClickAddTask:t[8]||(t[8]=(g,D)=>I(g,D)),onEmployeeAssignClick:t[9]||(t[9]=g=>B(g)),onClickAttachment:t[10]||(t[10]=g=>{u.show=!0,u.attachments=g}),hideButtons:k.showOnlyMyTasks,taskLinkTo:rt},null,8,["tasks","hideButtons"])])])}),128))])),m.value!=="loading"&&((v=C(p).tasks)==null?void 0:v.length)===0?(n(),r("div",Qt," No tasks ")):y("",!0),m.value==="loading"?(n(),T(dt,{key:3,class:H(["absolute inset-0 flex items-center z-50 bg-opacity-60 h-full shadow-none border",[((V=C(p).tasks)==null?void 0:V.length)===0?"justify-center":""]])},null,8,["class"])):y("",!0)]),u.show?(n(),T(P,{key:5},{default:M(()=>[h(ct,{attachments:u.attachments||[],onClickClose:t[11]||(t[11]=o=>u.show=!1)},null,8,["attachments"])]),_:1})):y("",!0)],2)}}};export{oe as _};
