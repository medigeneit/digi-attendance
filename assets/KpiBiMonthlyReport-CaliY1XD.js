import{D as Te,r as _,x as H,f as Ve,q as J,h as Be,c as i,o as c,a as s,b as W,t as y,k as K,H as De,m as C,F as O,e as j,d as Ie,j as G,s as p,P as Q,z as X,w as Z}from"./index-DyrtSyKM.js";import{L as Ke}from"./LoaderView-swLqgaPw.js";import{u as Ae}from"./kpi-report-Bj8Tg7AW.js";import{_ as Pe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Re={class:"space-y-4 px-4 print:px-0"},Ue={class:"hidden print:block mx-auto text-center mb-3"},ze={class:"text-sm text-gray-600"},Ee={class:"font-medium"},Fe={class:"flex flex-wrap items-end gap-3 sticky top-0 z-10 bg-white/80 backdrop-blur print:hidden p-2 -mx-2 rounded-md border border-gray-100"},Le={class:"flex items-center gap-2"},Ye=["disabled"],qe=["value"],He={key:0,class:"py-10 text-center"},Je={key:1,class:"rounded-md border border-red-200 bg-red-50 p-3 text-red-700",role:"alert","aria-live":"polite"},We={key:2,class:"space-y-3 md:hidden"},Ge={class:"flex items-center justify-between"},Qe=["title"],Xe={class:"text-xs text-gray-500"},Ze={class:"mt-2 grid grid-cols-1 gap-2"},et={class:"flex items-center justify-between"},tt={class:"text-[13px] font-semibold text-gray-800"},ot={class:"flex items-center gap-3"},nt={class:"inline-flex items-center gap-1.5"},at=["aria-label","disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange"],st={class:"inline-flex items-center gap-1.5"},rt=["aria-label","disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange"],lt={class:"mt-2 grid grid-cols-2 gap-2 text-center"},dt={key:0,class:"mt-1 text-[10px] text-gray-500 text-center"},it={key:0,class:"px-3 py-6 text-center text-gray-600"},ct={class:"hidden md:block overflow-x-auto rounded-xl border bg-white shadow-sm"},ut={class:"min-w-[900px] w-full text-sm"},yt={class:"text-gray-800 sticky top-0 z-[5]"},mt={class:"bg-gray-100/95 backdrop-blur"},bt={rowspan:"2",class:"sticky z-[6] border-y border-r bg-gray-100/95 px-2 py-2 text-left",style:{left:"2rem",minWidth:"12.5rem",width:"12.5rem"}},ft={class:"whitespace-nowrap"},vt={class:"bg-gray-100/95 text-gray-700 whitespace-nowrap"},pt={class:"text-gray-800"},kt={class:"sticky left-0 z-[4] border-r bg-inherit px-2 text-center"},gt={class:"sticky z-[4] border bg-inherit px-2"},xt=["title"],ht={class:"inline-flex items-center justify-center gap-2 cursor-pointer"},_t=["aria-label","disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange"],wt={class:"inline-flex items-center justify-center gap-2 cursor-pointer"},Nt=["aria-label","disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange"],Ct={key:0,class:"mt-1 text-[10px] text-gray-500 text-center"},$t={key:0},St=1500,Mt={__name:"KpiBiMonthlyReport",setup(Ot){const T=Ae(),{meta:k,rows:h,isLoading:oe,error:ne}=Te(T),ae=new Date().getFullYear(),$=_(ae),V=_([]),se=_("department"),A=_(""),P=_(""),R=_("any"),f=H(()=>{var e;return((e=k.value)==null?void 0:e.periods)||[]}),re=H(()=>{var e;return((e=k.value)==null?void 0:e.available_years)||null}),le=H(()=>{const e=Object.create(null);for(const o of f.value)e[o.key]=o;return e}),xe=Ve(),he=["feb_mar","jun_jul","nov"],_e=H(()=>{var a;const e=xe.query.hl;if(e)return new Set(String(e).split(",").map(t=>t.trim()).filter(Boolean));const o=(a=k.value)==null?void 0:a.highlight_period_keys;return Array.isArray(o)&&o.length?new Set(o):new Set(he)}),ee=e=>_e.value.has(e.key),S=e=>ee(e)?"bg-amber-50":"bg-white",B=e=>ee(e)?"border-amber-300":"border-gray-200",we=ae;function Ne(e=2018,o=we+1){const a=[];for(let r=o;r>=e;r--)a.push(r);const t=Number($.value);a.includes(t)||a.unshift(t),V.value=Array.from(new Set(a))}function de(e){Array.isArray(e)&&e.length?(V.value=[...new Set(e.map(Number))].sort((o,a)=>a-o),V.value.includes(Number($.value))||($.value=V.value[0])):Ne()}J(re,de,{immediate:!0}),J($,()=>{const e=Number($.value);!Number.isInteger(e)||e<2e3||e>2100||ke()});const g=_(Object.create(null)),x=_(Object.create(null)),M=_(Object.create(null)),U=_(Object.create(null)),z=_(Object.create(null)),te=_(Object.create(null)),u=(e,o)=>`${e}::${o}`;function E(e){var a;if(((a=k.value)==null?void 0:a.scope)!=="department")return null;const o=String((e==null?void 0:e.key)||"").match(/^dept:(\d+)$/);return o?Number(o[1]):null}function ie(e){const o=le.value[e];return o!=null&&o.form_id?Number(o.form_id):null}function ce(e){var o;return((o=le.value[e])==null?void 0:o.label)||e}function ue(e){const o=te.value[e]||0;return Date.now()-o>=St}function Ce(){const e=Object.create(null);for(const o of h.value||[])for(const a of f.value){const t=u(o.key,a.key);e[t]=g.value[t]}U.value=e}function ye(){var a,t,r;const e=Object.create(null),o=Object.create(null);for(const n of f.value)o[n.key]=new Set((n.completed_departments||[]).map(Number));for(const n of h.value||[]){const d=E(n);for(const l of f.value){let m=!1;if(d&&o[l.key].has(d))m=!0;else{const b=(a=n.cells)==null?void 0:a[l.key],v=Number((b==null?void 0:b.assigned)??0),w=Number(((t=b==null?void 0:b.incharge)==null?void 0:t.done)??0),N=Number(((r=b==null?void 0:b.coordinator)==null?void 0:r.done)??0);m=R.value==="both"?v>0&&w>=v&&N>=v:v>0&&(w>=v||N>=v)}e[u(n.key,l.key)]=m}}g.value=e,Ce()}function F(e,o){const a=u(e.key,o.key);U.value[a]=g.value[a]}async function me(e,o){var w,N,ge;const a=u(e.key,o.key),t=!!g.value[a],r=!!U.value[a],n=`${(e==null?void 0:e.name)??""} • ${ce(o.key)}`,d=t?"mark as Completed":"mark as Pending";if(!window.confirm(`Confirm
${n}

Do you want to ${d}?`)){g.value[a]=r;return}if(M.value[a]){g.value[a]=r,window.alert("Already updating…");return}if(!ue(a)){g.value[a]=r,window.alert("Just updated. Try again shortly.");return}const m=ie(o.key),b=E(e),v=!!((N=(w=e==null?void 0:e.cells)==null?void 0:w[o.key])!=null&&N.form_id&&m);if(((ge=k.value)==null?void 0:ge.scope)!=="department"||!b||!v){g.value[a]=r,window.alert("This period is not assignable (no form).");return}M.value[a]=!0;try{await T.setReportCompletion({form_id:m,department_id:b,completed:t}),te.value[a]=Date.now(),U.value[a]=t;const D=f.value.findIndex(I=>I.key===o.key);if(D>=0){const I=new Set((k.value.periods[D].completed_departments||[]).map(Number));t?I.add(b):I.delete(b),k.value.periods[D].completed_departments=Array.from(I)}}catch(D){g.value[a]=r,console.error(D),window.alert("Failed to update.")}finally{M.value[a]=!1}}function $e(){const e=Object.create(null);for(const o of h.value||[])for(const a of f.value){const t=u(o.key,a.key);e[t]=x.value[t]}z.value=e}function be(){var a,t;const e=Object.create(null),o=Object.create(null);for(const r of f.value)o[r.key]=new Set((r.target_completed_departments||[]).map(Number));for(const r of h.value||[]){const n=E(r);for(const d of f.value){let l=!1;if(n&&o[d.key].has(n))l=!0;else{const m=(t=(a=r==null?void 0:r.cells)==null?void 0:a[d.key])==null?void 0:t.monthly_target,b=Number((m==null?void 0:m.have)??0),v=Number((m==null?void 0:m.of)??0);l=v>0&&b>=v}e[u(r.key,d.key)]=l}}x.value=e,$e()}function L(e,o){const a=u(e.key,o.key);z.value[a]=x.value[a]}async function fe(e,o){var v;const a=u(e.key,o.key),t=!!x.value[a],r=!!z.value[a],n=`${(e==null?void 0:e.name)??""} • ${ce(o.key)}`,d=t?"mark Target as Completed":"mark Target as Pending";if(!window.confirm(`Confirm
${n}

Do you want to ${d}?`)){x.value[a]=r;return}if(M.value[a]){x.value[a]=r,window.alert("Already updating…");return}if(!ue(a)){x.value[a]=r,window.alert("Just updated. Try again shortly.");return}const m=E(e);if(((v=k.value)==null?void 0:v.scope)!=="department"||!m){x.value[a]=r,window.alert("Not assignable.");return}const b=ie(o.key);M.value[a]=!0;try{await T.setTargetCompletion({period_key:o.key,form_id:b||void 0,department_id:m,completed:t}),te.value[a]=Date.now(),z.value[a]=t;const w=f.value.findIndex(N=>N.key===o.key);if(w>=0){const N=new Set((k.value.periods[w].target_completed_departments||[]).map(Number));t?N.add(m):N.delete(m),k.value.periods[w].target_completed_departments=Array.from(N)}}catch(w){x.value[a]=r,console.error(w),window.alert("Failed to update.")}finally{M.value[a]=!1}}const ve=(e,o)=>{var a,t,r;return!!((t=(a=e==null?void 0:e.cells)==null?void 0:a[o])!=null&&t.form_id)&&((r=k.value)==null?void 0:r.scope)==="department"},pe=(e,o)=>{var t,r,n,d,l;if(((t=k.value)==null?void 0:t.scope)!=="department")return!1;const a=(n=(r=e==null?void 0:e.cells)==null?void 0:r[o])==null?void 0:n.monthly_target;return Number((a==null?void 0:a.of)??0)>0||!!((l=(d=e==null?void 0:e.cells)==null?void 0:d[o])!=null&&l.form_id)},Se=e=>e?"✓":"—";function Y(e,o,a){var n,d;const t=Number((e==null?void 0:e.assigned)??0),r=Number(a==="ic"?((n=e==null?void 0:e.incharge)==null?void 0:n.done)??0:((d=e==null?void 0:e.coordinator)==null?void 0:d.done)??0);if(t===0&&r===0){const l=a==="ic"?e==null?void 0:e.incharge:e==null?void 0:e.coordinator;if(typeof l=="boolean")return Se(l)}return`${r}/${o}`}function q(e,o){var r,n;const a=Number((e==null?void 0:e.assigned)??0),t=Number(o==="ic"?((r=e==null?void 0:e.incharge)==null?void 0:r.done)??0:((n=e==null?void 0:e.coordinator)==null?void 0:n.done)??0);return a===0?"bg-gray-50 text-gray-600":t>=a?"bg-emerald-50 text-emerald-700":"bg-rose-50 text-rose-700"}function Me(){window.print()}function Oe(){return new Date().toLocaleString()}async function ke(){try{await T.fetchBiMonthly({year:Number($.value),scope:se.value,department_id:A.value?Number(A.value):void 0,form_id:P.value?Number(P.value):void 0,rule:R.value})}catch(e){console.error("fetchBiMonthly failed:",e)}finally{ye(),be()}}async function je(){try{await T.exportBiMonthly({year:Number($.value),scope:se.value,department_id:A.value?Number(A.value):void 0,form_id:P.value?Number(P.value):void 0,rule:R.value})}catch(e){console.error("exportBiMonthly failed:",e),window.alert("Export failed. Please try again.")}}return J([h,f,R],ye),J([h,f],be),Be(()=>{de(re.value),ke()}),(e,o)=>{var a;return c(),i("div",Re,[s("div",Ue,[o[3]||(o[3]=s("h1",{class:"text-xl font-semibold text-gray-900"},"Bi-Monthly KPI Report",-1)),s("div",ze,[o[1]||(o[1]=W(" Year: ")),s("span",Ee,y($.value),1),o[2]||(o[2]=W(" • Generated: ")),s("span",null,y(Oe()),1)])]),s("div",Fe,[s("div",Le,[o[4]||(o[4]=s("label",{class:"text-xs font-medium text-gray-600"},"Year",-1)),K(s("select",{"onUpdate:modelValue":o[0]||(o[0]=t=>$.value=t),class:"w-32 rounded border border-gray-300 bg-white px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400/50 disabled:opacity-60",disabled:C(oe),"aria-label":"Select year"},[(c(!0),i(O,null,j(V.value,t=>(c(),i("option",{key:t,value:t},y(t),9,qe))),128))],8,Ye),[[De,$.value,void 0,{number:!0}]])]),s("div",{class:"ml-auto flex gap-2"},[s("button",{class:"btn-3 !py-1.5 !px-3",onClick:je},o[5]||(o[5]=[s("i",{class:"far fa-file-excel mr-1"},null,-1),W(" Excel ")])),s("button",{class:"btn-3 !py-1.5 !px-3",onClick:Me},o[6]||(o[6]=[s("i",{class:"far fa-print mr-1"},null,-1),W(" Print ")]))])]),C(oe)?(c(),i("div",He,[Ie(Ke)])):C(ne)?(c(),i("div",Je,y(C(ne)),1)):(c(),i("div",We,[(c(!0),i(O,null,j(C(h),(t,r)=>(c(),i("div",{key:"card-"+t.key,class:"rounded-xl border border-gray-200 bg-white shadow-sm p-3 break-inside-avoid"},[s("div",Ge,[s("div",{class:"text-sm font-medium text-gray-900 truncate",title:t.name},y(r+1)+". "+y(t.name),9,Qe),s("div",Xe,"Total: "+y(t.employees_total),1)]),s("div",Ze,[(c(!0),i(O,null,j(f.value,n=>{var d;return c(),i("div",{key:n.key,class:p(["rounded-lg border p-2",[S(n),ee(n)?"border-amber-300":"border-gray-200"]])},[s("div",et,[s("div",tt,y(n.label),1),s("div",ot,[s("label",nt,[K(s("input",{type:"checkbox",class:"h-4 w-4 accent-emerald-500","aria-label":`Report • ${t.name} • ${n.label}`,disabled:!ve(t,n.key)||M.value[u(t.key,n.key)],"onUpdate:modelValue":l=>g.value[u(t.key,n.key)]=l,onMousedown:l=>F(t,n),onKeydown:X(Z(l=>F(t,n),["prevent"]),["enter"]),onChange:l=>me(t,n)},null,40,at),[[Q,g.value[u(t.key,n.key)]]]),o[7]||(o[7]=s("span",{class:"text-[11px] text-gray-700"},"Report",-1))]),s("label",st,[K(s("input",{type:"checkbox",class:"h-4 w-4 accent-sky-500","aria-label":`Target • ${t.name} • ${n.label}`,disabled:!pe(t,n.key)||M.value[u(t.key,n.key)],"onUpdate:modelValue":l=>x.value[u(t.key,n.key)]=l,onMousedown:l=>L(t,n),onKeydown:X(Z(l=>L(t,n),["prevent"]),["enter"]),onChange:l=>fe(t,n)},null,40,rt),[[Q,x.value[u(t.key,n.key)]]]),o[8]||(o[8]=s("span",{class:"text-[11px] text-gray-700"},"Target",-1))])])]),s("div",lt,[s("div",{class:p(["rounded px-2 py-1 text-[12px]",q(t.cells[n.key],"ic")])}," Inch: "+y(Y(t.cells[n.key],t.employees_total,"ic")),3),s("div",{class:p(["rounded px-2 py-1 text-[12px]",q(t.cells[n.key],"co")])}," Coord: "+y(Y(t.cells[n.key],t.employees_total,"co")),3)]),(d=t.cells[n.key])!=null&&d.max_total?(c(),i("div",dt,y(t.cells[n.key].final_total)+" / "+y(t.cells[n.key].max_total),1)):G("",!0)],2)}),128))])]))),128)),!C(h)||C(h).length===0?(c(),i("div",it,"No data")):G("",!0)])),s("div",ct,[s("table",ut,[s("thead",yt,[s("tr",mt,[o[9]||(o[9]=s("th",{rowspan:"2",class:"sticky left-0 z-[6] border-y border-r bg-gray-100/95 px-2 py-2 text-center",style:{"min-width":"2.25rem",width:"2.25rem"}},"SL",-1)),s("th",bt,y(((a=C(k))==null?void 0:a.scope)==="user"?"Employee":"Department"),1),(c(!0),i(O,null,j(f.value,t=>(c(),i("th",{key:t.key,colspan:"4",class:p(["border-y px-2 py-2 text-center font-semibold border-x-2 text-red-500 print:text-black",[S(t),B(t)]])},[s("span",ft,y(t.label),1)],2))),128))]),s("tr",vt,[(c(!0),i(O,null,j(f.value,t=>(c(),i(O,{key:t.key+"-sub"},[s("th",{class:p(["border-y py-1 text-center text-[11px] w-8 border-r",S(t)])},"Report",2),s("th",{class:p(["border-y py-1 text-center text-[11px] w-8 border-r",[S(t),B(t)]])},"Target",2),s("th",{class:p(["border-y py-1 text-center text-[11px] w-8 border-r",S(t)])},"Inch.",2),s("th",{class:p(["border-y py-1 text-center text-[11px] border-r-2 w-8",[S(t),B(t)]])},"Coord.",2)],64))),128))])]),s("tbody",pt,[(c(!0),i(O,null,j(C(h),(t,r)=>(c(),i("tr",{key:t.key,class:"border-t odd:bg-gray-50 hover:bg-sky-50/40 transition-colors break-inside-avoid"},[s("td",kt,y(r+1),1),s("td",gt,[s("div",{class:"truncate w-48",title:t.name},y(t.name),9,xt)]),(c(!0),i(O,null,j(f.value,n=>{var d;return c(),i(O,{key:n.key},[s("td",{class:p(["border-r text-center",S(n)])},[s("label",ht,[K(s("input",{type:"checkbox",class:"h-4 w-4 accent-emerald-500","aria-label":`Report • ${t.name} • ${n.label}`,disabled:!ve(t,n.key)||M.value[u(t.key,n.key)],"onUpdate:modelValue":l=>g.value[u(t.key,n.key)]=l,onMousedown:l=>F(t,n),onKeydown:X(Z(l=>F(t,n),["prevent"]),["enter"]),onChange:l=>me(t,n)},null,40,_t),[[Q,g.value[u(t.key,n.key)]]])])],2),s("td",{class:p(["text-center border-r",[S(n),B(n)]])},[s("label",wt,[K(s("input",{type:"checkbox",class:"h-4 w-4 accent-sky-500","aria-label":`Target • ${t.name} • ${n.label}`,disabled:!pe(t,n.key)||M.value[u(t.key,n.key)],"onUpdate:modelValue":l=>x.value[u(t.key,n.key)]=l,onMousedown:l=>L(t,n),onKeydown:X(Z(l=>L(t,n),["prevent"]),["enter"]),onChange:l=>fe(t,n)},null,40,Nt),[[Q,x.value[u(t.key,n.key)]]])])],2),s("td",{class:p(["border-r text-center",S(n)])},[s("span",{class:p(["inline-block rounded py-0.5 font-mono text-[12px]",q(t.cells[n.key],"ic")])},y(Y(t.cells[n.key],t.employees_total,"ic")),3)],2),s("td",{class:p(["border-y text-center border-r-2",[S(n),B(n)]])},[s("span",{class:p(["inline-block rounded py-0.5 font-mono text-[12px]",q(t.cells[n.key],"co")])},y(Y(t.cells[n.key],t.employees_total,"co")),3),(d=t.cells[n.key])!=null&&d.max_total?(c(),i("div",Ct,y(t.cells[n.key].final_total)+" / "+y(t.cells[n.key].max_total),1)):G("",!0)],2)],64)}),128))]))),128)),!C(h)||C(h).length===0?(c(),i("tr",$t,o[10]||(o[10]=[s("td",{colspan:"100",class:"px-3 py-6 text-center text-gray-600"},"No data",-1)]))):G("",!0)])])])])}}},Dt=Pe(Mt,[["__scopeId","data-v-c8afbfe6"]]);export{Dt as default};
