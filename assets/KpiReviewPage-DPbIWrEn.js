import{x as m,r as w,c as r,o,a as s,k as g,t as i,O as T,n as re,F as C,e as M,s as ce,f as Bs,g as zs,q as fe,h as Ds,y as Ks,l as be,G as Os,v as Be,j as tt,d as Qs,b as oe,I as Vs,m as Us,T as qs,C as ts}from"./index-DGmPUdou.js";import{u as Ys}from"./kpi-BGIJ16l_.js";const Ws={class:"border rounded-2xl bg-white shadow-sm overflow-hidden"},Js={class:"flex items-center justify-between border-b bg-slate-50 px-3 py-2 gap-2"},Xs={class:"flex items-center gap-2 min-w-0"},Zs={class:"text-sm font-semibold text-slate-800 truncate"},el={key:0,class:"text-[11px] text-slate-500 truncate"},tl={key:1,class:"flex items-center gap-2 shrink-0"},sl={class:"inline-flex items-center rounded-xl border bg-white p-1 shadow-sm"},ll=["disabled"],al=["disabled"],nl=["disabled"],ol={class:"overflow-auto"},rl={key:0,class:"min-w-[980px] w-full text-[11px]"},il={class:"bg-slate-50 sticky top-0 z-10"},ul={class:"text-slate-700"},dl={class:"text-[11px] font-semibold"},cl={class:"text-[10px] text-slate-500 flex flex-col items-center"},vl=["title"],ml={key:0,class:"mt-0.5 inline-flex items-center gap-1 rounded-full bg-blue-50 px-2 py-0.5 text-[10px] font-semibold text-blue-700 border border-blue-200"},xl={class:"bg-slate-100/80 border-t"},pl=["colspan"],fl={class:"flex items-start justify-between gap-2"},bl=["title"],yl={class:"opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition shrink-0"},gl={class:"inline-flex items-center rounded-lg border bg-white p-0.5 shadow-sm"},hl=["disabled","onClick"],_l=["disabled","onClick"],kl=["disabled","onClick"],wl=["disabled","onClick"],$l=["disabled","onClick"],Fl={key:0,class:"flex items-center justify-center"},Ll=["max","value","onInput","onBlur","aria-label"],Sl={key:1,class:"text-slate-700 tabular-nums"},Al={key:2,class:"text-slate-300"},Nl={class:"bg-slate-50 border-t"},Cl={class:"font-semibold text-slate-900 tabular-nums"},Ml={class:"text-[10px] text-slate-500 tabular-nums"},El={class:"mt-1 h-1 rounded bg-slate-200 overflow-hidden"},Il={key:1,class:"text-slate-300"},jl={key:1,class:"w-full text-[11px]"},Pl={class:"sticky top-0 bg-white z-10"},Rl={class:"bg-slate-100 text-slate-700"},Tl={class:"text-left px-2 py-2 w-[34%] font-medium"},Gl={class:"px-2 py-2 text-center text-slate-500"},Hl=["title"],Bl={class:"px-2 py-2 text-center text-slate-700 tabular-nums"},zl={class:"px-2 py-2 text-center"},Dl=["max","value","onInput","onBlur"],Kl={key:1,class:"text-slate-700 tabular-nums"},Ol={class:"bg-slate-50 border-t"},Ql={class:"px-2 py-2 text-center font-semibold text-slate-800 tabular-nums"},Vl={class:"px-2 py-2 text-center font-semibold text-slate-900 tabular-nums"},$e=44,ze=320,et=84,ss=Object.assign({name:"KpiGroupTable"},{__name:"KpiGroupTable",props:{group:{type:Object,required:!0},isPersonal:{type:Boolean,default:!1},lanes:{type:Array,default:()=>[]},editableLaneKey:{type:String,default:null},canEdit:{type:Boolean,default:!1},marks:{type:Object,default:()=>({})},headerLabel:{type:String,default:""},itemLabel:{type:String,default:"Item"},helperText:{type:String,default:""},showQuickFillGroup:{type:Boolean,default:!1},autoFillLabel:{type:String,default:""},autoFillVisible:{type:Boolean,default:!1},onAutoFill:{type:Function,default:null},serialMap:{type:Object,default:()=>({})},getLaneMark:{type:Function,default:()=>""},getHrMark:{type:Function,default:()=>""},onMarkChange:{type:Function,default:null},onCap:{type:Function,default:null},onQuickFillItem:{type:Function,default:null},onQuickFillGroup:{type:Function,default:null}},setup(p){const $=p,te=$e,S=$e+ze,ie=m(()=>Array.isArray($.lanes)?$.lanes:[]),E=m(()=>{var b;return Array.isArray((b=$.group)==null?void 0:b.items)?$.group.items:[]}),De=m(()=>$.showQuickFillGroup||$.isPersonal&&$.canEdit),ve=b=>{if(b===""||b==null)return null;const d=Number(b);return Number.isFinite(d)?d:null},k=b=>{const d=Number(b);return Number.isFinite(d)?d:0},I=(b,d,n)=>Math.min(Math.max(b,d),n),J=m(()=>E.value.reduce((b,d)=>b+k(d==null?void 0:d.max),0)),se=m(()=>E.value.reduce((b,d)=>{var h;const n=(h=$.marks)==null?void 0:h[d.id],y=n===""||n==null?0:Number(n),_=k(d==null?void 0:d.max);return b+I(k(y),0,_)},0)),le=(b,d)=>{var n;return((n=$.serialMap)==null?void 0:n[b.id])??d+1},B=w(!1),z=b=>(b==null?void 0:b.key)===$.editableLaneKey&&!!(b!=null&&b.can_current_user_review),ue=(b,d)=>{var n,y;return!b||!d?null:z(b)?ve((n=$.marks)==null?void 0:n[d.id]):b!=null&&b.can_view_marks?ve((y=$.getLaneMark)==null?void 0:y.call($,b.key,d.id)):null},P=m(()=>{const b={},d=k(J.value);return ie.value.forEach(n=>{const y=z(n)||!!(n!=null&&n.can_view_marks);if(!(n!=null&&n.key))return;let _=0,h=!1;E.value.forEach(Q=>{const Le=ue(n,Q);if(Le==null)return;h=!0;const Ke=k(Q==null?void 0:Q.max);_+=I(k(Le),0,Ke)});const O=d>0?Math.round(_/d*100):0;b[n.key]={got:Number(_.toFixed(2)),max:Number(d.toFixed(2)),percent:O,hasData:h,canShow:y}}),b}),D=m(()=>{const b=ie.value;if(B.value)return b;const d=b.filter(n=>{var y,_;return z(n)?!0:!!((_=(y=P.value)==null?void 0:y[n.key])!=null&&_.hasData)});return d.length?d:b}),de=b=>{var y;const d=(y=P.value)==null?void 0:y[b];return!d||!d.max?"0%":`${I(d.got/d.max*100,0,100)}%`},K=b=>{var n;if(!$.canEdit)return!1;const d=(n=$.marks)==null?void 0:n[b.id];return d===""||d==null},ae=(b,d)=>{var y;const n=d===""?"":Number(d);d!==""&&Number.isNaN(n)||(y=$.onMarkChange)==null||y.call($,b,n)},Fe=(b,d)=>{var n;return(n=$.onCap)==null?void 0:n.call($,b,d)};return(b,d)=>(o(),r("section",Ws,[s("div",Js,[s("div",Xs,[s("div",Zs,i(p.headerLabel),1),p.isPersonal&&ie.value.length>1?(o(),r("button",{key:0,type:"button",class:"shrink-0 rounded-full border border-slate-200 bg-white px-2.5 py-1 text-[10px] font-semibold text-slate-600 hover:border-slate-300 hover:text-slate-800",onClick:d[0]||(d[0]=n=>B.value=!B.value)},i(B.value?"Show only filled lanes":"Show all lanes"),1)):g("",!0)]),p.helperText?(o(),r("div",el,i(p.helperText),1)):g("",!0),De.value&&p.itemLabel!=="Personal Attributes"?(o(),r("div",tl,[s("div",sl,[s("button",{type:"button",class:"px-3 py-1 text-[11px] font-semibold rounded-lg text-slate-700 hover:bg-slate-100 disabled:opacity-40",onClick:d[1]||(d[1]=n=>{var y;return(y=p.onQuickFillGroup)==null?void 0:y.call(p,p.group,"half")}),disabled:!p.canEdit}," All 1/2 ",8,ll),s("button",{type:"button",class:"px-3 py-1 text-[11px] font-semibold rounded-lg text-slate-700 hover:bg-slate-100 disabled:opacity-40",onClick:d[2]||(d[2]=n=>{var y;return(y=p.onQuickFillGroup)==null?void 0:y.call(p,p.group,"threeQuarter")}),disabled:!p.canEdit}," All 3/4 ",8,al),s("button",{type:"button",class:"px-3 py-1 text-[11px] font-semibold rounded-lg bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-40",onClick:d[3]||(d[3]=n=>{var y;return(y=p.onQuickFillGroup)==null?void 0:y.call(p,p.group,"full")}),disabled:!p.canEdit}," All Full ",8,nl)]),p.autoFillVisible?(o(),r("button",{key:0,type:"button",class:"rounded-full border border-slate-300 bg-white px-2.5 py-1 text-[10px] font-semibold text-slate-600 hover:border-slate-400",onClick:d[4]||(d[4]=n=>{var y;return(y=p.onAutoFill)==null?void 0:y.call(p)})},i(p.autoFillLabel),1)):g("",!0)])):g("",!0)]),s("div",ol,[p.isPersonal?(o(),r("table",rl,[s("thead",il,[s("tr",ul,[s("th",{class:"sticky left-0 z-20 bg-slate-50 px-2 py-2 text-center font-medium",style:T({width:$e+"px"})}," # ",4),s("th",{class:"sticky z-20 bg-slate-50 px-2 py-2 text-left font-medium",style:T({left:re(te)+"px",width:ze+"px"})},i(p.itemLabel),5),s("th",{class:"sticky z-20 bg-slate-50 px-2 py-2 text-center font-medium",style:T({left:S+"px",width:et+"px"})}," Max ",4),(o(!0),r(C,null,M(D.value,n=>(o(),r("th",{key:n.key,class:"px-2 py-2 text-center font-medium"},[s("div",dl,i(n.label||n.key),1),s("div",cl,[s("span",{class:"truncate max-w-[140px]",title:n.assigned_user_name||""},i(n.assigned_user_name||"-"),9,vl),z(n)?(o(),r("span",ml," ✎ You can edit ")):g("",!0)])]))),128))])]),s("tbody",null,[s("tr",xl,[s("td",{colspan:3+D.value.length,class:"px-2 py-2 font-medium text-slate-800"},i(p.group.label||"Personal"),9,pl)]),(o(!0),r(C,null,M(E.value,(n,y)=>(o(),r("tr",{key:n.id,class:ce(["border-t hover:bg-slate-50/60 group",K(n)?"bg-rose-50/30 border-l-4 border-rose-400":""])},[s("td",{class:"sticky left-0 z-10 bg-white px-2 py-2 text-center text-slate-500",style:T({width:$e+"px"})},i(le(n,y)),5),s("td",{class:"sticky z-10 bg-white px-2 py-2 align-top",style:T({left:re(te)+"px",width:ze+"px"})},[s("div",fl,[s("div",{class:"font-medium text-slate-800 truncate pr-2",title:n.label},i(n.label),9,bl),s("div",yl,[s("div",gl,[s("button",{type:"button",class:"px-2 py-1 text-[11px] font-semibold rounded-md text-slate-700 hover:bg-slate-100 disabled:opacity-40",disabled:!p.canEdit,onClick:_=>{var h;return p.canEdit&&((h=p.onQuickFillItem)==null?void 0:h.call(p,n.id,n.max,"zero"))},title:"Set 0"}," 0 ",8,hl),s("button",{type:"button",class:"px-2 py-1 text-[11px] font-semibold rounded-md text-slate-700 hover:bg-slate-100 disabled:opacity-40",disabled:!p.canEdit,onClick:_=>{var h;return p.canEdit&&((h=p.onQuickFillItem)==null?void 0:h.call(p,n.id,n.max,"quarter"))},title:"Set 25%"}," ¼ ",8,_l),s("button",{type:"button",class:"px-2 py-1 text-[11px] font-semibold rounded-md text-slate-700 hover:bg-slate-100 disabled:opacity-40",disabled:!p.canEdit,onClick:_=>{var h;return p.canEdit&&((h=p.onQuickFillItem)==null?void 0:h.call(p,n.id,n.max,"half"))},title:"Set 50%"}," ½ ",8,kl),s("button",{type:"button",class:"px-2 py-1 text-[11px] font-semibold rounded-md text-slate-700 hover:bg-slate-100 disabled:opacity-40",disabled:!p.canEdit,onClick:_=>{var h;return p.canEdit&&((h=p.onQuickFillItem)==null?void 0:h.call(p,n.id,n.max,"threeQuarter"))},title:"Set 75%"}," ¾ ",8,wl),s("button",{type:"button",class:"px-2 py-1 text-[11px] font-semibold rounded-md bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-40",disabled:!p.canEdit,onClick:_=>{var h;return p.canEdit&&((h=p.onQuickFillItem)==null?void 0:h.call(p,n.id,n.max,"full"))},title:"Set 100%"}," Full ",8,$l)])])])],4),s("td",{class:"sticky z-10 bg-white px-2 py-2 text-center text-slate-700 tabular-nums",style:T({left:S+"px",width:et+"px"})},i(k(n.max).toFixed(1).replace(/\.0$/,"")),5),(o(!0),r(C,null,M(D.value,_=>(o(),r("td",{key:_.key,class:"px-2 py-2 text-center"},[z(_)?(o(),r("div",Fl,[s("input",{type:"number",step:"0.1",min:"0",max:n.max,value:p.marks[n.id]??"",onInput:h=>ae(n.id,h.target.value),onBlur:h=>Fe(n.id,n.max),inputmode:"decimal",class:ce(["w-16 text-right rounded-md px-2 py-1 text-[11px] focus:outline-none focus:ring-2 focus:ring-indigo-200 border tabular-nums",K(n)?"border-rose-300 bg-rose-50/40":"border-slate-200"]),"aria-label":`Score for ${n.label}`},null,42,Ll)])):_.can_view_marks?(o(),r("div",Sl,i($.getLaneMark(_.key,n.id)||"—"),1)):(o(),r("div",Al,"—"))]))),128))],2))),128)),s("tr",Nl,[s("td",{class:"sticky left-0 z-20 bg-slate-50 px-2 py-2",style:T({width:$e+"px"})},null,4),s("td",{class:"sticky z-20 bg-slate-50 px-2 py-2 text-right font-medium text-slate-700",style:T({left:re(te)+"px",width:ze+"px"})}," Group Total ",4),s("td",{class:"sticky z-20 bg-slate-50 px-2 py-2 text-center font-semibold text-slate-800 tabular-nums",style:T({left:S+"px",width:et+"px"})},i(J.value.toFixed(2)),5),(o(!0),r(C,null,M(D.value,n=>{var y,_,h,O;return o(),r("td",{key:n.key,class:"px-2 py-2 text-center align-top"},[(_=(y=P.value)==null?void 0:y[n.key])!=null&&_.canShow&&(z(n)||(O=(h=P.value)==null?void 0:h[n.key])!=null&&O.hasData)?(o(),r(C,{key:0},[s("div",Cl,i(P.value[n.key].got.toFixed(2)),1),s("div",Ml," / "+i(P.value[n.key].max.toFixed(2))+" · "+i(P.value[n.key].percent)+"% ",1),s("div",El,[s("div",{class:"h-1 bg-slate-900/40",style:T({width:de(n.key)})},null,4)])],64)):(o(),r("div",Il,"—"))])}),128))])])])):(o(),r("table",jl,[s("thead",Pl,[s("tr",Rl,[d[5]||(d[5]=s("th",{class:"px-2 py-2 w-[36px] text-center font-medium"},"#",-1)),s("th",Tl,i(p.itemLabel),1),d[6]||(d[6]=s("th",{class:"px-2 py-2 text-center w-[70px] font-medium"},"Max",-1)),d[7]||(d[7]=s("th",{class:"px-2 py-2 text-center w-[90px] font-medium"},"HR Score",-1))])]),s("tbody",null,[(o(!0),r(C,null,M(E.value,(n,y)=>(o(),r("tr",{key:n.id,class:ce(["border-t hover:bg-slate-50/60",K(n)?"bg-rose-50/30 border-l-4 border-rose-400":""])},[s("td",Gl,i(y+1),1),s("td",{class:"px-2 py-2 font-medium text-slate-800 truncate",title:n.label},i(n.label),9,Hl),s("td",Bl,i(k(n.max).toFixed(1).replace(/\.0$/,"")),1),s("td",zl,[p.canEdit?(o(),r("input",{key:0,type:"number",step:"0.1",min:"0",max:n.max,value:p.marks[n.id]??"",onInput:_=>ae(n.id,_.target.value),onBlur:_=>Fe(n.id,n.max),class:ce(["w-16 text-right rounded-md px-2 py-1 text-[11px] focus:outline-none focus:ring-2 focus:ring-indigo-200 border tabular-nums",K(n)?"border-rose-300 bg-rose-50/40":"border-slate-200"])},null,42,Dl)):(o(),r("span",Kl,i($.getHrMark(n.id)||"—"),1))])],2))),128)),s("tr",Ol,[d[8]||(d[8]=s("td",null,null,-1)),d[9]||(d[9]=s("td",{class:"px-2 py-2 text-right font-medium text-slate-700"},"Group Total",-1)),s("td",Ql,i(J.value.toFixed(2)),1),s("td",Vl,i(se.value.toFixed(2)),1)])])]))])]))}}),Ul={key:0,class:"space-y-4"},ql={class:"flex items-start justify-between gap-3"},Yl={class:"text-sm font-semibold text-slate-900"},Wl={class:"text-xs text-slate-500"},Jl={key:0,class:"text-xs text-slate-400"},Xl={class:"flex flex-wrap items-center gap-2"},Zl=["onClick"],ea={key:0,class:"rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600"},ta={key:1,class:"rounded-xl border border-rose-200 bg-rose-50 p-3 text-sm text-rose-700"},sa={key:2,class:"space-y-3"},la={key:0,class:"rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600"},aa={key:1,class:"space-y-3"},na={class:"flex items-start justify-between gap-3"},oa={class:"min-w-0"},ra=["title"],ia={class:"mt-0.5 text-[11px] text-slate-500"},ua={key:0},da={key:1},ca={class:"shrink-0"},va=["onUpdate:modelValue"],ma=["value"],xa={class:"mt-2"},pa=["onUpdate:modelValue"],fa={class:"flex items-center justify-end gap-2 pt-2"},ba=["disabled"],ya=["disabled"],ga={key:1,class:"max-w-7xl mx-auto px-4 py-6 space-y-6"},ha={key:0,class:"rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700"},_a={key:1,class:"rounded-2xl border border-slate-200 bg-slate-50 px-4 py-10 text-sm text-slate-600"},ka={class:"sticky top-14 z-[99999] border rounded-2xl bg-white/80 backdrop-blur px-4 py-3 shadow-sm"},wa={class:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between"},$a={class:"space-y-1"},Fa={class:"inline-flex items-center gap-2 rounded-full bg-indigo-50 px-3 py-1"},La={class:"text-xs text-indigo-900"},Sa={class:"text-sm text-slate-600"},Aa={class:"font-medium text-slate-800"},Na={class:"flex flex-wrap gap-2 text-xs mt-0.5"},Ca={key:0,class:"inline-flex items-center rounded-full bg-slate-50 px-2 py-0.5 text-slate-600"},Ma={class:"ml-1 font-medium text-slate-800"},Ea={key:1,class:"inline-flex items-center rounded-full bg-slate-50 px-2 py-0.5 text-slate-600"},Ia={class:"ml-1 font-medium text-slate-800"},ja={key:2,class:"inline-flex items-center rounded-full bg-slate-50 px-2 py-0.5 text-slate-600"},Pa={class:"ml-1 font-medium text-slate-800"},Ra={class:"inline-flex items-center rounded-full bg-slate-50 px-2 py-0.5 text-slate-600"},Ta={key:0,class:"ml-1 inline-flex items-center gap-1"},Ga={class:"font-semibold text-slate-800"},Ha={class:"font-semibold text-emerald-700"},Ba={key:1,class:"ml-1 inline-flex items-center gap-1"},za={key:2,class:"ml-1 font-semibold text-slate-800"},Da={class:"flex items-end gap-4"},Ka={class:"text-right"},Oa={class:"text-lg font-bold text-slate-900"},Qa={class:"text-slate-400"},Va={class:"text-xs text-slate-500"},Ua={key:0},qa={class:"border rounded-2xl bg-white shadow-sm overflow-hidden"},Ya={class:"text-xs text-slate-500"},Wa={key:0,class:"p-4 text-sm font-bold text-slate-500"},Ja=["innerHTML"],Xa={class:"mt-2"},Za={class:"grid gap-4 lg:grid-cols-5"},en={key:0,class:"space-y-4 lg:col-span-3"},tn={key:0,class:"sticky top-6 border rounded-2xl bg-white shadow-sm"},sn={class:"flex flex-wrap items-center justify-between border-b px-4 py-3 text-sm font-semibold text-slate-800"},ln={class:"flex flex-wrap items-center gap-2 text-[11px] text-slate-500"},an={class:"rounded-full border bg-slate-50 px-2 py-0.5 text-slate-700"},nn={key:0,class:"rounded-full border bg-slate-50 px-2 py-0.5 text-slate-700"},on={class:"rounded-full border bg-slate-50 px-2 py-0.5 text-slate-700"},rn={class:"p-4 space-y-4 max-h-[360px] overflow-y-auto"},un={class:"flex flex-wrap gap-2 border-b border-slate-100 pb-3"},dn=["onClick"],cn={class:"space-y-4"},vn={class:"grid grid-cols-1 gap-3 sm:grid-cols-2"},mn={class:"rounded-xl border bg-slate-50 p-3"},xn={class:"flex items-center justify-between"},pn={class:"text-[11px] px-1.5 py-0.5 rounded bg-blue-50 text-blue-700 border border-blue-200"},fn={class:"mt-1 text-sm font-semibold text-slate-900"},bn={class:"text-xs text-slate-500"},yn={class:"mt-2 h-2 rounded bg-slate-100 overflow-hidden"},gn={class:"rounded-xl border bg-slate-50 p-3"},hn={class:"flex items-center justify-between"},_n={class:"text-[11px] px-1.5 py-0.5 rounded bg-violet-50 text-violet-700 border border-violet-200"},kn={class:"mt-1 text-sm font-semibold text-slate-900"},wn={class:"text-xs text-slate-500"},$n={class:"mt-2 h-2 rounded bg-slate-100 overflow-hidden"},Fn={class:"rounded-xl border bg-slate-50 p-3 sm:col-span-2"},Ln={class:"flex items-center justify-between"},Sn={class:"text-[11px] px-1.5 py-0.5 rounded bg-emerald-50 text-emerald-700 border border-emerald-200"},An={class:"mt-1 text-sm font-semibold text-slate-900"},Nn={class:"text-xs text-slate-500"},Cn={class:"mt-2 h-2 rounded bg-slate-100 overflow-hidden"},Mn={class:"border-t pt-2 text-xs"},En={key:0,class:"mt-3 rounded-xl border border-slate-200 bg-slate-50 p-3 text-xs space-y-2"},In={class:"grid grid-cols-2 gap-2"},jn={class:"font-medium text-slate-800"},Pn={class:"font-medium text-slate-800"},Rn={class:"font-medium text-slate-800"},Tn={class:"font-medium text-slate-800"},Gn={class:"font-medium text-slate-800"},Hn={class:"font-medium text-slate-800"},Bn={key:1,class:"border rounded-2xl bg-white shadow-sm"},zn={class:"flex items-center justify-between border-b px-4 py-3 text-sm font-semibold text-slate-800"},Dn={class:"text-[11px] text-slate-500"},Kn={class:"p-4 space-y-3"},On={class:"max-h-96 overflow-auto border rounded-xl"},Qn={class:"min-w-full text-xs text-left"},Vn={class:"px-2 py-2"},Un={class:"font-semibold text-slate-700"},qn={key:0,class:"mt-0.5 text-[11px] text-slate-400"},Yn={class:"px-2 py-2 text-right"},Wn=["onClick"],Jn={key:2,class:"rounded-2xl bg-white border shadow-sm px-4 py-4 space-y-4"},Xn={class:"grid gap-4 md:grid-cols-3"},Zn={class:"space-y-3"},eo={class:"flex items-center justify-between text-xs font-semibold text-slate-600"},to={key:0,class:"text-[11px] text-emerald-600"},so={key:0,class:"rounded-2xl border border-slate-200 bg-slate-50/70 p-3 h-40 overflow-y-auto"},lo={class:"flex flex-wrap gap-1.5"},ao=["onClick","disabled"],no={class:"space-y-1"},oo={class:"space-y-3"},ro={class:"flex items-center justify-between text-xs font-semibold text-slate-600"},io={key:0,class:"text-[11px] text-amber-600"},uo={key:0,class:"rounded-2xl border border-slate-200 bg-slate-50/70 p-3 h-40 overflow-y-auto"},co={class:"flex flex-wrap gap-1.5"},vo=["onClick","disabled"],mo={class:"space-y-1"},xo={class:"space-y-3"},po={class:"flex items-center justify-between text-xs font-semibold text-slate-600"},fo={key:0,class:"text-[11px] text-sky-600"},bo={key:0,class:"rounded-2xl border border-slate-200 bg-slate-50/70 p-3 h-40 overflow-y-auto"},yo={class:"flex flex-wrap gap-1.5"},go=["onClick","disabled"],ho={class:"space-y-1"},_o={class:"mt-2 flex flex-col gap-3 border-t pt-3 md:flex-row md:items-center md:justify-between"},ko={class:"flex flex-wrap items-center gap-2"},wo=["disabled"],$o=["disabled"],Fo={key:0,class:"fixed inset-0 z-50 flex items-center justify-center px-4 py-6"},Lo={class:"relative w-full max-w-2xl rounded-2xl border border-slate-200 bg-white p-5 shadow-xl",role:"dialog","aria-modal":"true"},So={class:"flex items-start justify-between gap-3"},Ao={class:"text-lg font-semibold text-slate-900"},No={class:"text-xs text-slate-500"},Co={key:0,class:"text-xs text-slate-400 mt-1"},Mo={class:"mt-5 space-y-4 text-sm text-slate-700"},Eo={class:"mt-2 min-h-[40px] space-y-1 text-[13px] text-slate-600"},Io={key:0},jo={key:1,class:"text-slate-400"},Po={class:"mt-2 min-h-[40px] space-y-1 text-[13px] text-slate-600"},Ro={key:0},To={key:1,class:"text-slate-400"},Go={class:"mt-2 min-h-[40px] space-y-1 text-[13px] text-slate-600"},Ho={key:0},Bo={key:1,class:"text-slate-400"},zo=15e3,Do={__name:"KpiReviewForm",props:{mode:{type:String,default:"full"},allowedLanes:{type:Array,default:()=>["supv_director","da"]},groupFilter:{type:String,default:null},initialLane:{type:String,default:""},employeeId:{type:[Number,String],default:null},employeeName:{type:String,default:""},year:{type:Number,default:null}},emits:["saved"],setup(p,{emit:$}){const te=Bs(),S=Ys(),ie=zs(),E=p,De=$,ve=m(()=>E.mode==="compact"),k=w({}),I=w({}),J=w(""),se=w(""),le=w(""),B=w(null),z=w(null),ue=w(!1),P=w(!1),D=w(""),de=m(()=>{const e=Number(E.employeeId);return Number.isFinite(e)&&e>0?e:null}),K=m(()=>{const e=Number(E.year);return Number.isFinite(e)&&e>0?e:new Date().getFullYear()}),ae=m(()=>E.groupFilter?String(E.groupFilter):"personal"),Fe=m(()=>ae.value?ae.value.replace(/_/g," "):"personal"),b=m(()=>{const e=Array.isArray(E.allowedLanes)?E.allowedLanes.filter(Boolean):[];return e.length?e:["supv_director","da"]}),d=w(E.initialLane||b.value[0]||""),n=w([]),y=w({}),_=w({}),h=w(!1),O=w(!1),Q=w(""),Le=m(()=>{var e;return E.employeeName||((e=I.value)==null?void 0:e.name)||"Employee"}),Ke={supv_director:"Supv. Director",da:"DA"},st=e=>Ke[e]||e;function ls(e){return Array.isArray(e)?e.map((t,l)=>{const a=(t==null?void 0:t.id)??(t==null?void 0:t.item_id)??(t==null?void 0:t.kpi_item_id)??(t==null?void 0:t.kpi_id)??l,u=(t==null?void 0:t.title)??(t==null?void 0:t.name)??(t==null?void 0:t.label)??`Item ${l+1}`,c=(t==null?void 0:t.weight)??(t==null?void 0:t.weightage)??(t==null?void 0:t.weight_value)??(t==null?void 0:t.score_weight)??null,v=(t==null?void 0:t.max_score)??(t==null?void 0:t.max)??(t==null?void 0:t.max_marks)??(t==null?void 0:t.score_max)??0,f=(t==null?void 0:t.score)??(t==null?void 0:t.mark)??(t==null?void 0:t.obtained)??(t==null?void 0:t.value)??null,L=(t==null?void 0:t.comment)??(t==null?void 0:t.note)??(t==null?void 0:t.remark)??"";return{id:a,title:u,weight:c,maxScore:v,score:f,comment:L}}):[]}function as(e){const t=Number(e);if(!Number.isFinite(t)||t<=0)return[0];const l=Number.isInteger(t)?1:.5,a=[];for(let u=0;u<=t+1e-4;u+=l){const c=l===1?Math.round(u):Number(u.toFixed(1));a.push(c)}return a[a.length-1]!==t&&a.push(t),a}async function ns(){var e,t,l,a;if(ve.value&&!(!de.value||!K.value||!d.value)){h.value=!0,Q.value="";try{const{data:u}=await ts.get(`/kpi/yearly/${K.value}/employees/${de.value}/marking-form`,{params:{lane:d.value,group:ae.value}}),c=(u==null?void 0:u.data)??u??{},v=(c==null?void 0:c.items)||((e=c==null?void 0:c.form)==null?void 0:e.items)||((t=c==null?void 0:c.group)==null?void 0:t.items)||(c==null?void 0:c.data)||[],f=ls(v),L={},A={};f.forEach(H=>{var he,_e;const ee=(he=c==null?void 0:c.marks)==null?void 0:he[H.id],W=(_e=c==null?void 0:c.comments)==null?void 0:_e[H.id],pe=H.score??ee??0,He=H.comment??W??"";L[H.id]=pe===""||pe==null?0:Number(pe),A[H.id]=He??""}),n.value=f,y.value=L,_.value=A}catch(u){Q.value=((a=(l=u==null?void 0:u.response)==null?void 0:l.data)==null?void 0:a.message)||"Failed to load KPI marking form.",n.value=[]}finally{h.value=!1}}}async function lt(e){var t,l;if(!(!de.value||!K.value||!d.value)){O.value=!0,Q.value="";try{const a=n.value.map(c=>({item_id:c.id,score:Number(y.value[c.id]??0),comment:_.value[c.id]??""})),u={lane:d.value,group:ae.value,submit:!!e,items:a,marks:{...y.value},comments:{..._.value}};await ts.post(`/kpi/yearly/${K.value}/employees/${de.value}/marking-form`,u),De("saved")}catch(a){Q.value=((l=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:l.message)||"Failed to save KPI marking form."}finally{O.value=!1}}}fe(()=>E.initialLane,e=>{e&&(d.value=e)}),fe(b,e=>{e.length&&(e.includes(d.value)||(d.value=e[0]))},{immediate:!0}),fe([ve,d,de,K,ae],([e,t,l,a,u])=>{!e||!t||!l||!a||!u||ns()},{immediate:!0});const at=w([]),nt=w({}),Oe=w(!1),Se=m(()=>{var e;return((e=S.cycle)==null?void 0:e.groups_json)||[]}),os=m(()=>{var a;const e=S.cycle||{},t=Array.isArray(e==null?void 0:e.groups_json)?e.groups_json:[];return(e==null?void 0:e.slug)==="support_staff"&&t.length===1&&((a=t[0])==null?void 0:a.id)==="personal"?"staff":"executive"}),V=m(()=>os.value==="staff"),ot=e=>{if(!e)return!1;const t=String(e.id||"").toLowerCase(),l=String(e.label||"").toLowerCase();return t==="personal"||t==="personal_evaluation"||t==="personal_eval"?!0:l.includes("personal")},X=m(()=>Se.value.find(ot)||null),U=m(()=>V.value?[]:Se.value.filter(e=>!ot(e))),rs=(e,t)=>(e==null?void 0:e.label)||`Group ${t+1}`,rt=e=>/^hr\d*$/i.test(e)||e==="hr",it=e=>rt((e==null?void 0:e.key)||"")||(e==null?void 0:e.is_hr_lane)===!0,Ae=m(()=>[...at.value||[]].sort((e,t)=>(e.rank??999)-(t.rank??999))),Qe=m(()=>Ae.value.filter(it)),ut=m(()=>Ae.value.filter(e=>!it(e))),Ve=m(()=>V.value?Ae.value:ut.value),R=m(()=>{var e;return((e=Ve.value.find(t=>t.can_current_user_review))==null?void 0:e.key)||null}),dt=m(()=>Ve.value.find(e=>e.key===R.value)||null),is=m(()=>{var e;return((e=dt.value)==null?void 0:e.rank)??null}),us=m(()=>{var e;return Number(((e=ie==null?void 0:ie.user)==null?void 0:e.id)||0)}),Ue=m(()=>{const e=us.value;if(!e)return null;const t=Qe.value.find(l=>Number(l.assigned_user_id)===e);return t||Qe.value.find(l=>l.can_current_user_review)||null}),G=m(()=>{var e;return((e=Ue.value)==null?void 0:e.key)||null}),ds=m(()=>!!(Ue.value&&Ue.value.can_current_user_review)),q=m(()=>!!(Oe.value||ds.value)),Ne=m(()=>!!R.value),cs=m(()=>Ne.value?V.value?!0:!rt(R.value):!1);function vs(e,t="Submit"){const l=String(e||"").trim().replace(/_/g," ");return l?`${l.replace(/\b\w/g,u=>u.toUpperCase())} ${t}`:`${t} Personal`}function ct(e){if(!e)return!1;if(e.submitted_at)return!0;const t=e.marks&&typeof e.marks=="object"?e.marks:{};return Object.values(t).some(u=>Number(u??0)>0)?!0:[e.strengths,e.gaps,e.suggestions].some(u=>Array.isArray(u)?u.some(c=>String(c??"").trim()):typeof u=="string"?u.trim():!1)}const ms=m(()=>{const e=G.value;return e?ct(ne(e)):!1}),xs=m(()=>{const e=R.value;return e?ct(ne(e)):!1}),ps=m(()=>xs.value?"Update":"Submit"),fs=m(()=>{var t;const e=((t=dt.value)==null?void 0:t.label)||R.value;return vs(e,ps.value)}),bs=m(()=>ms.value?"Update HR Review":"Submit HR Review"),ys=m(()=>{if(V.value||!q.value)return!1;const e=R.value,t=G.value;return!e||!t||e===t?!1:U.value.length>0}),Ce=m(()=>V.value?R.value:q.value&&G.value?G.value:R.value),vt=m(()=>!!(Ce.value&&G.value&&Ce.value===G.value));function ne(e){var a;const t=(a=nt.value)==null?void 0:a[e];return t?(Array.isArray(t)?t:[t]).reduce((u,c)=>{if(!c)return u;if(!u)return c;const v=new Date(c.submitted_at||0).getTime(),f=new Date(u.submitted_at||0).getTime();return v>f?c:u},null):null}function mt(e,t){var a;const l=ne(e);return((a=l==null?void 0:l.marks)==null?void 0:a[t])??""}function xt(e){var l,a,u;if(G.value){const c=ne(G.value),v=(l=c==null?void 0:c.marks)==null?void 0:l[e];if(v!=null)return v}let t=null;for(const c of Qe.value){const v=ne(c.key);if(!v||((a=v==null?void 0:v.marks)==null?void 0:a[e])==null)continue;if(!t){t=v;continue}const f=new Date(v.submitted_at||0).getTime(),L=new Date(t.submitted_at||0).getTime();f>L&&(t=v)}return((u=t==null?void 0:t.marks)==null?void 0:u[e])??""}function pt(e,t){k.value[e]=t===""?"":Number(t)}function ye(e,t){const l=Number(k.value[e]??0);l<0&&(k.value[e]=0),l>Number(t)&&(k.value[e]=Number(t))}function ft(e,t,l){l==="zero"?k.value[e]=0:l==="quarter"?k.value[e]=Number(t)/4:l==="half"?k.value[e]=Number(t)/2:l==="threeQuarter"?k.value[e]=Number((Number(t)*.75).toFixed(1)):l==="full"&&(k.value[e]=Number(t)),ye(e,t)}function bt(e,t){e.items.forEach(l=>ft(l.id,l.max,t))}const qe=m(()=>{let e=0,t=0;const l=X.value;l&&Array.isArray(l.items)&&l.items.forEach(u=>{e+=Number(u.max||0);const c=Number(k.value[u.id]||0);t+=Math.min(Math.max(c,0),Number(u.max||0))});const a=e>0?t/e*100:0;return{max:Number(e.toFixed(2)),got:Number(t.toFixed(2)),percent:Number(a.toFixed(2))}}),gs=m(()=>!!B.value&&typeof B.value=="object"),hs=m(()=>{var e;return((e=B.value)==null?void 0:e.avg)||{per_scored_month:{},per_form_yearly:{},percent_simple:0,percent_weighted:0}}),_s=m(()=>{var e;return((e=B.value)==null?void 0:e.year)??null}),ks=m(()=>{var e;return((e=z.value)==null?void 0:e.avg)||{per_scored_month:{},per_form_yearly:{},percent_simple:0,percent_weighted:0}}),ws=m(()=>{var e;return((e=z.value)==null?void 0:e.year)??null}),Y=w("target"),yt=[{key:"target",label:"Annual Target"},{key:"performance",label:"Annual Performance"}],gt=m(()=>{var e;return((e=B.value)==null?void 0:e.months_total_form)??0}),$s=m(()=>{var e;return((e=z.value)==null?void 0:e.months_total_form)??gt.value}),F=m(()=>Y.value==="target"?hs.value:ks.value),ht=m(()=>{var e,t;return Number(((t=(e=F.value)==null?void 0:e.per_form_yearly)==null?void 0:t.final)||0)}),_t=m(()=>{var e,t;return Number(((t=(e=F.value)==null?void 0:e.per_scored_month)==null?void 0:t.max)||0)}),Fs=m(()=>_t.value?Math.round(ht.value/_t.value*100):0),kt=m(()=>q.value&&!V.value),Ye=m(()=>Y.value==="target"?_s.value:ws.value),wt=m(()=>Y.value==="target"?gt.value:$s.value),$t=m(()=>{var e;return((e=yt.find(t=>t.key===Y.value))==null?void 0:e.label)||"Annual Target"});fe(Y,()=>{ue.value=!1});const Ft=e=>String(e||"").toLowerCase(),Lt=(e,t)=>e?t==="target"?e.id==="monthly_target"?!0:Ft(e.label).includes("monthly target"):t==="performance"?e.id==="execution"?!0:Ft(e.label).includes("execution")||String(e.label||"").includes("কার্যসম্পাদন"):!1:!1,Ls=e=>U.value.find(t=>Lt(t,e))||null,St=(e,{overwrite:t}={overwrite:!1})=>{if(!kt.value)return;const l=Ls(e);if(!l||!Array.isArray(l.items)||l.items.length===0)return;const a=l.items,u=a.every(f=>Number(k.value[f.id]||0)===0);if(!t&&!u)return;const c=ht.value,v=a.reduce((f,L)=>f+Number(L.max||0),0);if(v){if(a.length===1){const f=a[0];k.value[f.id]=Math.min(c,Number(f.max||0)),ye(f.id,f.max);return}a.forEach(f=>{const L=Number(f.max||0)/v*c,A=Number(L.toFixed(1));k.value[f.id]=A,ye(f.id,f.max)})}},Ss=m(()=>`Auto: ${Y.value==="target"?"Annual Target":"Annual Performance"} (${Fs.value}%)`);fe(Y,e=>{St(e,{overwrite:!1})},{immediate:!0});const Me=m(()=>{const e=V.value?Ae.value:ut.value,t=[],l=vt.value||q.value?1/0:is.value??null,a=u=>{if(!u)return[];const c=[];if(Array.isArray(u))c.push(...u);else if(typeof u=="string"&&u.trim())c.push(u.trim());else return[];const v=new Set;return c.reduce((f,L)=>{const A=typeof L=="string"?L.trim():"";return!A||v.has(A)||(v.add(A),f.push(A)),f},[])};return e.forEach(u=>{const c=u.key;if(!c||l!=null&&(u.rank??999)>l)return;const v=ne(c);if(!v)return;const f=a(v.strengths),L=a(v.gaps),A=a(v.suggestions);!f.length&&!L.length&&!A.length||t.push({key:c,lane:c,label:u.label||(v==null?void 0:v.lane_label)||c,reviewer_id:v.reviewer_id,reviewer_name:v.reviewer_name,strengths:f,gaps:L,suggestions:A,submitted_at:v.submitted_at??null})}),t}),As=e=>{const t=new Set;return Me.value.forEach(l=>{(Array.isArray(l[e])?l[e]:[]).forEach(u=>{const c=typeof u=="string"?u.trim():"";c&&t.add(c)})}),Array.from(t)},At=e=>{if(!Array.isArray(e))return[];const t=new Set;return e.forEach(l=>{const a=typeof l=="string"?l.trim():"";a&&t.add(a)}),Array.from(t)},Ee=m(()=>At(S.strengths)),Ie=m(()=>At(S.gaps)),je=m(()=>As("suggestions"));w([]),w([]),w([]);const Pe=w(!1),j=w(null);function Ns(e){j.value=e,Pe.value=!0}function We(){Pe.value=!1,j.value=null}function Nt(e){Pe.value&&e.key==="Escape"&&We()}Ds(()=>{window.addEventListener("keydown",Nt)}),Ks(()=>{window.removeEventListener("keydown",Nt)});const Ct={strengths:J,gaps:se,suggestions:le};function Cs(e,t){const l=(t||"").trim();return l?e!=null&&e.trim()?`${e.trim()}
${l}`:l:e}function Re(e,t){const l=Ct[e];if(!l)return!1;const a=(l.value||"").split(`
`).map(c=>c.trim()).filter(Boolean),u=(t||"").trim();return u?a.includes(u):!1}function Je(e,t){const l=Ct[e];if(!l)return;const a=typeof t=="string"?t.trim():"";a&&(Re(e,a)||(l.value=Cs(l.value,a)))}const me=w(!1);let ge=null;const Ms=()=>{me.value=!me.value,ge&&(clearTimeout(ge),ge=null),me.value&&(ge=setTimeout(()=>{me.value=!1,ge=null},zo))},Es=m(()=>{const e={};let t=1;const l=X.value;return l&&Array.isArray(l.items)&&l.items.forEach(a=>{e[a.id]=t++}),e});function Te(e){return(Array.isArray(e==null?void 0:e.items)?e.items:[]).map(l=>l.id).filter(l=>l!=null)}function Mt(e){const t={};return(Array.isArray(e)?e:[]).forEach(l=>{var a;t[l]=Number(((a=k.value)==null?void 0:a[l])??0)}),t}function Et(e){return Mt(Te(e))}function It(e){const t=[];(Array.isArray(e)?e:[]).forEach(a=>{t.push(...Te(a))});const l=Array.from(new Set(t));return Mt(l)}function Xe(e){return Array.isArray(e)?e.map(t=>typeof t=="string"?t.trim():"").filter(Boolean).join(`
`):typeof e=="string"?e.trim():""}const Is=m(()=>!R.value||!X.value?!1:Object.keys(Et(X.value)).length>0),js=m(()=>!q.value||!G.value||!Array.isArray(U.value)||U.value.length===0?!1:Object.keys(It(U.value)).length>0);function jt(e,t){if(!e||!(t!=null&&t.length))return!1;const l=ne(e),a=l==null?void 0:l.marks;if(!a)return!1;let u=!1;return t.forEach(c=>{const v=a==null?void 0:a[c];v!==""&&v!=null&&(k.value[c]=Number(v),u=!0)}),u}const Ge=e=>{if(typeof e!="string")return e;const t=e.trim();if(!t)return e;try{return JSON.parse(t)}catch{return e}};function Ps(e,t=0){const l=(e==null?void 0:e.key)??(e==null?void 0:e.lane_key)??(e==null?void 0:e.laneKey)??(e==null?void 0:e.lane)??"",a=(e==null?void 0:e.label)??(e==null?void 0:e.lane_label)??(e==null?void 0:e.title)??l,u=(e==null?void 0:e.rank)??(e==null?void 0:e.order)??(e==null?void 0:e.priority)??999,c=(e==null?void 0:e.assigned_user_id)??(e==null?void 0:e.assignee_id)??(e==null?void 0:e.reviewer_id)??null,v=(e==null?void 0:e.assigned_user_name)??(e==null?void 0:e.assignee_name)??(e==null?void 0:e.reviewer_name)??"",f=(e==null?void 0:e.can_current_user_review)??(e==null?void 0:e.can_review)??!1,L=(e==null?void 0:e.can_view_marks)??!0;return{...e,key:String(l),label:String(a),rank:Number(u??999),assigned_user_id:c==null?null:Number(c),assigned_user_name:String(v||""),can_current_user_review:!!f,can_view_marks:!!L,_idx:t}}function Rs(e){const t={},l=e&&typeof e=="object"?e:{};return Object.keys(l).forEach(a=>{const u=l[a],c=Array.isArray(u)?u:u?[u]:[];t[a]=c.map(v=>{const f=Ge((v==null?void 0:v.marks)??(v==null?void 0:v.marks_json)??{});return{...v,marks:f&&typeof f=="object"?f:{},strengths:Ge(v==null?void 0:v.strengths),gaps:Ge(v==null?void 0:v.gaps),suggestions:Ge(v==null?void 0:v.suggestions)}})}),t}const Ze=m(()=>Number(te.params.employeeId)),Pt=e=>{var L;I.value=e.employee||{},B.value=(e==null?void 0:e.annual_target_avg_marks)||null,z.value=(e==null?void 0:e.annual_performance_avg_marks)||null,at.value=Array.isArray(e==null?void 0:e.lanes)?e.lanes.map(Ps):[],nt.value=Rs((e==null?void 0:e.reviews_by_lane)||{}),Oe.value=!!(((L=e==null?void 0:e.meta)==null?void 0:L.is_hr)??(e==null?void 0:e.hr)??!1),k.value={},(Array.isArray(Se.value)?Se.value:[]).forEach(A=>{(Array.isArray(A==null?void 0:A.items)?A.items:[]).forEach(ee=>{k.value[ee.id]=0})});const l=Te(X.value),a=R.value,u=G.value;!jt(a,l)&&u&&jt(u,l),q.value&&U.value.length&&U.value.forEach(A=>{Te(A).forEach(ee=>{let W=u?mt(u,ee):"";(W===""||W==null)&&(W=xt(ee)),W!==""&&W!=null&&(k.value[ee]=Number(W))})});const v=Ce.value||a||u||null,f=v?ne(v):null;J.value=Xe(f==null?void 0:f.strengths),se.value=Xe(f==null?void 0:f.gaps),le.value=Xe(f==null?void 0:f.suggestions)},Ts=async e=>{var t,l;if(e){P.value=!0,D.value="";try{await S.fetchActiveCycle(e);const a=await S.fetchLanes(S.cycle.id,e);Pt(a)}catch(a){D.value=((l=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:l.message)||(a==null?void 0:a.message)||"Failed to load KPI review data."}finally{P.value=!1}}},Rt=async()=>{var e,t,l;if(!(!Ze.value||!((e=S.cycle)!=null&&e.id))){P.value=!0,D.value="";try{const a=await S.fetchLanes(S.cycle.id,Ze.value);Pt(a)}catch(a){D.value=((l=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:l.message)||(a==null?void 0:a.message)||"Failed to refresh KPI review data."}finally{P.value=!1}}};fe(Ze,async(e,t)=>{!e||t&&e===t||await Ts(e)},{immediate:!0});async function Gs(){var a,u,c;const e=Number(te.params.employeeId),t=(a=S.cycle)==null?void 0:a.id,l=R.value;if(!t||!e)return alert("Invalid cycle/employee.");if(!l||!X.value)return alert("Unable to determine personal reviewer lane.");try{await S.submitReview({cycle_id:t,employee_id:e,reviewer_lane:l,marks:Et(X.value),strengths:J.value,gaps:se.value,suggestions:le.value}),await Rt(),alert("Personal review submitted")}catch(v){const f=((c=(u=v==null?void 0:v.response)==null?void 0:u.data)==null?void 0:c.message)||(v==null?void 0:v.message)||"Failed to submit personal review.";alert(f)}}async function Hs(){var a,u,c;const e=Number(te.params.employeeId),t=(a=S.cycle)==null?void 0:a.id,l=G.value;if(!t||!e)return alert("Invalid cycle/employee.");if(!l)return alert("Unable to determine HR reviewer lane.");try{await S.submitReview({cycle_id:t,employee_id:e,reviewer_lane:l,marks:It(U.value),strengths:J.value,gaps:se.value,suggestions:le.value}),await Rt(),alert("HR review submitted")}catch(v){const f=((c=(u=v==null?void 0:v.response)==null?void 0:u.data)==null?void 0:c.message)||(v==null?void 0:v.message)||"Failed to submit HR review.";alert(f)}}function Z(e){const t=Number(e??0);return isNaN(t)?"0.00":t.toFixed(2)}function xe(e,t){const l=Number(e??0),a=Number(t??0);return a>0?Math.round(l/a*100):0}return(e,t)=>{var l,a,u,c,v,f,L,A,H,ee,W,pe,He,he,_e,Tt,Gt,Ht,Bt,zt,Dt,Kt,Ot,Qt,Vt,Ut,qt,Yt,Wt,Jt,Xt,Zt;return ve.value?(o(),r("div",Ul,[s("div",ql,[s("div",null,[s("div",Yl,i(Le.value),1),s("div",Wl," Year "+i(K.value)+" / Group "+i(Fe.value),1)]),d.value?(o(),r("div",Jl," Lane: "+i(st(d.value)),1)):g("",!0)]),s("div",Xl,[(o(!0),r(C,null,M(b.value,x=>(o(),r("button",{key:x,type:"button",class:ce(["rounded-full border px-3 py-1 text-xs font-semibold transition",x===d.value?"bg-slate-900 text-white border-slate-900":"bg-white text-slate-600 border-slate-200 hover:border-slate-300"]),onClick:N=>d.value=x},i(st(x)),11,Zl))),128))]),h.value?(o(),r("div",ea," Loading KPI items... ")):Q.value?(o(),r("div",ta,i(Q.value),1)):(o(),r("div",sa,[n.value.length?(o(),r("div",aa,[(o(!0),r(C,null,M(n.value,x=>(o(),r("div",{key:x.id,class:"rounded-xl border border-slate-200 bg-white p-3"},[s("div",na,[s("div",oa,[s("div",{class:"text-sm font-semibold text-slate-900 truncate",title:x.title},i(x.title),9,ra),s("div",ia,[x.weight!=null?(o(),r("span",ua,"Weight: "+i(x.weight),1)):g("",!0),x.maxScore!=null?(o(),r("span",da," / Max: "+i(x.maxScore),1)):g("",!0)])]),s("div",ca,[be(s("select",{"onUpdate:modelValue":N=>y.value[x.id]=N,class:"rounded-lg border border-slate-300 bg-white px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400/50"},[(o(!0),r(C,null,M(as(x.maxScore),N=>(o(),r("option",{key:N,value:N},i(N),9,ma))),128))],8,va),[[Os,y.value[x.id],void 0,{number:!0}]])])]),s("div",xa,[t[7]||(t[7]=s("label",{class:"block text-[11px] font-medium text-slate-500"},"Comment (optional)",-1)),be(s("textarea",{"onUpdate:modelValue":N=>_.value[x.id]=N,rows:"2",class:"mt-1 w-full rounded-lg border border-slate-200 px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400/40",placeholder:"Add a note if needed"},null,8,pa),[[Be,_.value[x.id]]])])]))),128))])):(o(),r("div",la," No KPI items found for this lane. "))])),s("div",fa,[s("button",{type:"button",class:"rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-600 hover:bg-slate-50 disabled:opacity-50",disabled:O.value||h.value||!n.value.length,onClick:t[0]||(t[0]=x=>lt(!1))},i(O.value?"Saving...":"Save Draft"),9,ba),s("button",{type:"button",class:"rounded-lg bg-emerald-600 px-3 py-1.5 text-sm font-semibold text-white hover:bg-emerald-700 disabled:opacity-50",disabled:O.value||h.value||!n.value.length,onClick:t[1]||(t[1]=x=>lt(!0))},i(O.value?"Saving...":"Submit"),9,ya)])])):(o(),r("div",ga,[D.value?(o(),r("div",ha,i(D.value),1)):g("",!0),P.value?(o(),r("div",_a," Loading KPI review... ")):(o(),r(C,{key:2},[s("header",ka,[s("div",wa,[s("div",$a,[s("div",Fa,[t[8]||(t[8]=s("span",{class:"text-xs font-semibold text-indigo-700"},"KPI Cycle",-1)),s("span",La,i((l=re(S).cycle)==null?void 0:l.title),1)]),s("div",Sa,[s("div",Aa,i(((a=I.value)==null?void 0:a.name)||"Employee"),1),s("div",Na,[(c=(u=I.value)==null?void 0:u.designation)!=null&&c.title?(o(),r("span",Ca,[t[9]||(t[9]=oe(" Designation: ")),s("span",Ma,i(I.value.designation.title),1)])):g("",!0),(f=(v=I.value)==null?void 0:v.department)!=null&&f.name?(o(),r("span",Ea,[t[10]||(t[10]=oe(" Department: ")),s("span",Ia,i(I.value.department.name),1)])):g("",!0),(L=I.value)!=null&&L.joining_date?(o(),r("span",ja,[t[11]||(t[11]=oe(" Joining Date: ")),s("span",Pa,i((A=I.value)==null?void 0:A.joining_date),1)])):g("",!0),s("span",Ra,[t[15]||(t[15]=oe(" Reviewing as: ")),ys.value?(o(),r("span",Ta,[s("span",Ga,i(R.value),1),t[12]||(t[12]=s("span",{class:"text-slate-400"},"+",-1)),s("span",Ha,i(G.value),1),t[13]||(t[13]=s("span",{class:"text-[10px] rounded bg-emerald-50 border border-emerald-200 px-1.5 py-0.5 text-emerald-700"}," dual mode ",-1))])):vt.value?(o(),r("span",Ba,t[14]||(t[14]=[s("span",{class:"font-semibold text-emerald-700"},"HR",-1),s("span",{class:"text-[10px] rounded bg-emerald-50 border border-emerald-200 px-1.5 py-0.5 text-emerald-700"}," HR mode ",-1)]))):(o(),r("span",za,i(Ce.value||"No lane"),1))])])])]),s("div",Da,[s("div",Ka,[t[16]||(t[16]=s("div",{class:"text-[11px] uppercase tracking-wide text-slate-500"}," Personal group total ",-1)),s("div",Oa,[oe(i(qe.value.got.toFixed(2))+" ",1),s("span",Qa,"/ "+i(qe.value.max.toFixed(2)),1)]),s("div",Va,i(qe.value.percent.toFixed(2))+"% achieved ",1)]),Oe.value?(o(),r("button",{key:0,onClick:t[2]||(t[2]=x=>re(S).submitFinalResult(re(S).cycle.id,re(te).params.employeeId)),class:"inline-flex items-center gap-2 rounded-xl bg-indigo-600 px-4 py-2.5 text-sm font-medium text-white shadow hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-300 focus:outline-none"},t[17]||(t[17]=[s("span",null,"Finalize & Lock",-1)]))):g("",!0)])])]),(H=I.value)!=null&&H.active_criteria?(o(),r("div",Ua,[s("section",qa,[s("button",{type:"button",class:"w-full flex items-center justify-between border-b bg-slate-50 px-4 py-2 text-left",onClick:Ms},[t[18]||(t[18]=s("div",{class:"text-sm font-semibold text-slate-800"},"কার্যসম্পাদন বিষয়",-1)),s("div",Ya,i(me.value?"Hide":"Show"),1)]),be(s("div",null,[((W=(ee=I.value)==null?void 0:ee.active_criteria)==null?void 0:W.length)===0?(o(),r("div",Wa," -- ")):g("",!0),(o(!0),r(C,null,M(I.value.active_criteria,x=>(o(),r("div",{class:"p-4 text-sm text-slate-700",key:x.id},[s("div",{class:"print:block richtext print:break-inside-avoid",innerHTML:x==null?void 0:x.description},null,8,Ja)]))),128))],512),[[Vs,me.value]])])])):g("",!0),re(S).cycle&&X.value?(o(),tt(ss,{key:1,group:X.value,"is-personal":!0,lanes:Ve.value,"editable-lane-key":R.value,"can-edit":Ne.value,marks:k.value,"header-label":"Personal Evaluation","item-label":((pe=X.value)==null?void 0:pe.label)||"Personal",mode:V.value,"helper-text":V.value?"All reviewer lanes score the Personal table.":Ne.value&&q.value?"Submit Personal and HR reviews separately using the buttons below.":"Fill only your lane; others appear as read-only.","serial-map":Es.value,"get-lane-mark":mt,"on-mark-change":pt,"on-cap":ye,"on-quick-fill-item":ft,"on-quick-fill-group":bt},null,8,["group","lanes","editable-lane-key","can-edit","marks","item-label","mode","helper-text","serial-map"])):g("",!0),s("section",Xa,[s("div",Za,[U.value.length?(o(),r("div",en,[(o(!0),r(C,null,M(U.value,(x,N)=>(o(),tt(ss,{key:N,group:x,"is-personal":!1,"can-edit":q.value,marks:k.value,"header-label":`Group ${N+1} - ${rs(x,N)}`,"item-label":"Item","show-quick-fill-group":!0,"auto-fill-visible":kt.value&&Lt(x,Y.value),"auto-fill-label":Ss.value,"on-auto-fill":()=>St(Y.value,{overwrite:!0}),"get-hr-mark":xt,"on-mark-change":pt,"on-cap":ye,"on-quick-fill-group":bt},null,8,["group","can-edit","marks","header-label","auto-fill-visible","auto-fill-label","on-auto-fill"]))),128))])):g("",!0),s("aside",{class:ce(["space-y-4 sticky top-10 z-50",[U.value.length===0?"lg:col-span-full":"lg:col-span-2"]])},[!V.value&&gs.value&&q.value?(o(),r("section",tn,[s("header",sn,[t[19]||(t[19]=s("span",null,"Annual Summary",-1)),s("div",ln,[s("span",an,i($t.value),1),Ye.value?(o(),r("span",nn," Year "+i(Ye.value),1)):g("",!0),s("span",on,i(wt.value)+" month(s) ",1)])]),s("div",rn,[s("div",un,[(o(),r(C,null,M(yt,x=>s("button",{key:x.key,type:"button",onClick:N=>Y.value=x.key,class:ce(["px-3 py-1 rounded-full text-xs font-semibold transition",Y.value===x.key?"bg-slate-900 text-white shadow":"border border-slate-200 text-slate-700 bg-white hover:border-slate-400"])},i(x.label),11,dn)),64))]),s("div",cn,[s("div",vn,[s("div",mn,[s("div",xn,[t[20]||(t[20]=s("span",{class:"text-xs font-medium text-slate-600"},"Incharge",-1)),s("span",pn,i(xe((He=F.value.per_scored_month)==null?void 0:He.incharge,(he=F.value.per_scored_month)==null?void 0:he.max))+"% ",1)]),s("div",fn,[oe(i(Z((_e=F.value.per_scored_month)==null?void 0:_e.incharge))+" ",1),s("span",bn,"/ "+i(Z((Tt=F.value.per_scored_month)==null?void 0:Tt.max)),1)]),s("div",yn,[s("div",{class:"h-2 bg-blue-500",style:T({width:xe((Gt=F.value.per_scored_month)==null?void 0:Gt.incharge,(Ht=F.value.per_scored_month)==null?void 0:Ht.max)+"%"})},null,4)])]),s("div",gn,[s("div",hn,[t[21]||(t[21]=s("span",{class:"text-xs font-medium text-slate-600"},"Coordinator",-1)),s("span",_n,i(xe((Bt=F.value.per_scored_month)==null?void 0:Bt.coordinator,(zt=F.value.per_scored_month)==null?void 0:zt.max))+"% ",1)]),s("div",kn,[oe(i(Z((Dt=F.value.per_scored_month)==null?void 0:Dt.coordinator))+" ",1),s("span",wn,"/ "+i(Z((Kt=F.value.per_scored_month)==null?void 0:Kt.max)),1)]),s("div",$n,[s("div",{class:"h-2 bg-violet-500",style:T({width:xe((Ot=F.value.per_scored_month)==null?void 0:Ot.coordinator,(Qt=F.value.per_scored_month)==null?void 0:Qt.max)+"%"})},null,4)])]),s("div",Fn,[s("div",Ln,[t[22]||(t[22]=s("span",{class:"text-xs font-medium text-slate-600"},"Final",-1)),s("span",Sn,i(xe((Vt=F.value.per_form_yearly)==null?void 0:Vt.final,(Ut=F.value.per_scored_month)==null?void 0:Ut.max))+"% ",1)]),s("div",An,[oe(i(Z((qt=F.value.per_form_yearly)==null?void 0:qt.final))+" ",1),s("span",Nn,"/ "+i(Z((Yt=F.value.per_scored_month)==null?void 0:Yt.max)),1)]),s("div",Cn,[s("div",{class:"h-2 bg-emerald-500",style:T({width:xe((Wt=F.value.per_form_yearly)==null?void 0:Wt.final,(Jt=F.value.per_scored_month)==null?void 0:Jt.max)+"%"})},null,4)])])]),s("div",Mn,[s("button",{class:"text-xs px-3 py-1.5 rounded-md border hover:bg-slate-50",onClick:t[3]||(t[3]=x=>ue.value=!ue.value)},i(ue.value?"Hide details":"Show "+$t.value+" details"),1),ue.value?(o(),r("div",En,[s("div",In,[t[23]||(t[23]=s("div",{class:"text-slate-500"},"Year",-1)),s("div",jn,i(Ye.value||"-"),1),t[24]||(t[24]=s("div",{class:"text-slate-500"},"Months counted",-1)),s("div",Pn,i(wt.value),1),t[25]||(t[25]=s("div",{class:"text-slate-500"},"Max",-1)),s("div",Rn,i(Z((Xt=F.value.per_scored_month)==null?void 0:Xt.max)),1),t[26]||(t[26]=s("div",{class:"text-slate-500"},"Final avg",-1)),s("div",Tn,i(Z((Zt=F.value.per_form_yearly)==null?void 0:Zt.final)),1),t[27]||(t[27]=s("div",{class:"text-slate-500"},"Percent (simple)",-1)),s("div",Gn,i(Z(F.value.percent_simple))+"%",1),t[28]||(t[28]=s("div",{class:"text-slate-500"},"Percent (weighted)",-1)),s("div",Hn,i(Z(F.value.percent_weighted))+"%",1)])])):g("",!0)])])])])):g("",!0),Me.value.length?(o(),r("section",Bn,[s("header",zn,[t[29]||(t[29]=s("span",null,"Review Comments",-1)),s("span",Dn,i(Me.value.length)+" lane(s) ",1)]),s("div",Kn,[s("div",On,[s("table",Qn,[t[31]||(t[31]=s("thead",{class:"text-[11px] text-slate-600 uppercase tracking-wide bg-slate-50"},[s("tr",null,[s("th",{class:"px-2 py-2 w-[140px]"},"Lane"),s("th",{class:"px-2 py-2 text-right"},"Details")])],-1)),s("tbody",null,[(o(!0),r(C,null,M(Me.value,x=>(o(),r("tr",{key:x.key,class:"border-t hover:bg-slate-50/60 align-top"},[s("td",Vn,[s("div",Un,i(x.label),1),x.submitted_at?(o(),r("div",qn,i(new Date(x.submitted_at).toLocaleDateString()),1)):g("",!0)]),s("td",Yn,[s("button",{type:"button",class:"inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-[11px] font-semibold text-slate-600 hover:border-slate-300 hover:text-slate-800",onClick:N=>Ns(x)},t[30]||(t[30]=[s("span",null,"View comments",-1),s("span",{class:"text-[10px] text-slate-400"},"Strengths · Gaps · Suggestions",-1)]),8,Wn)])]))),128))])])])])])):g("",!0)],2)])]),Ne.value||q.value?(o(),r("section",Jn,[t[38]||(t[38]=s("header",{class:"flex items-center justify-between mb-1"},[s("div",null,[s("h2",{class:"text-sm font-semibold text-slate-800"},"Overall Review Notes"),s("p",{class:"text-[11px] text-slate-500"},"Use saved hints or write your own detailed comments.")])],-1)),s("div",Xn,[s("div",Zn,[s("header",eo,[t[32]||(t[32]=s("div",{class:"flex items-center gap-1"},[s("span",{class:"text-emerald-500 text-base leading-none"},"★"),s("span",null,"Strengths")],-1)),Ee.value.length?(o(),r("span",to,i(Ee.value.length)+" saved hint(s) ",1)):g("",!0)]),Ee.value.length?(o(),r("div",so,[s("div",lo,[(o(!0),r(C,null,M(Ee.value,x=>(o(),r("button",{key:x,type:"button",onClick:N=>Je("strengths",x),disabled:Re("strengths",x),class:"rounded-full border px-2.5 py-1 text-[11px] font-medium transition border-slate-200 bg-white text-slate-700 hover:border-emerald-300 hover:bg-emerald-50 hover:text-emerald-800 disabled:opacity-40 disabled:cursor-not-allowed"},i(x),9,ao))),128))])])):g("",!0),s("div",no,[t[33]||(t[33]=s("label",{class:"text-[11px] font-medium text-slate-500"}," Key Strength(s) ",-1)),be(s("textarea",{"onUpdate:modelValue":t[4]||(t[4]=x=>J.value=x),placeholder:"e.g. Strong ownership, proactive problem solving…",class:"w-full rounded-xl border px-3 py-2 text-sm min-h-28 focus:outline-none focus:ring-2 focus:ring-emerald-200"},null,512),[[Be,J.value]])])]),s("div",oo,[s("header",ro,[t[34]||(t[34]=s("div",{class:"flex items-center gap-1"},[s("span",{class:"text-amber-500 text-base leading-none"},"!"),s("span",null,"Gaps")],-1)),Ie.value.length?(o(),r("span",io,i(Ie.value.length)+" saved hint(s) ",1)):g("",!0)]),Ie.value.length?(o(),r("div",uo,[s("div",co,[(o(!0),r(C,null,M(Ie.value,x=>(o(),r("button",{key:x,type:"button",onClick:N=>Je("gaps",x),disabled:Re("gaps",x),class:"rounded-full border px-2.5 py-1 text-[11px] font-medium transition border-slate-200 bg-white text-slate-700 hover:border-amber-300 hover:bg-amber-50 hover:text-amber-800 disabled:opacity-40 disabled:cursor-not-allowed"},i(x),9,vo))),128))])])):g("",!0),s("div",mo,[t[35]||(t[35]=s("label",{class:"text-[11px] font-medium text-slate-500"},"GAP(s)",-1)),be(s("textarea",{"onUpdate:modelValue":t[5]||(t[5]=x=>se.value=x),placeholder:"e.g. Needs improvement in documentation, communication…",class:"w-full rounded-xl border px-3 py-2 text-sm min-h-28 focus:outline-none focus:ring-2 focus:ring-amber-200"},null,512),[[Be,se.value]])])]),s("div",xo,[s("header",po,[t[36]||(t[36]=s("div",{class:"flex items-center gap-1"},[s("span",{class:"text-sky-500 text-base leading-none"},"✱"),s("span",null,"Suggestions / Training")],-1)),je.value.length?(o(),r("span",fo,i(je.value.length)+" common suggestion(s) ",1)):g("",!0)]),je.value.length?(o(),r("div",bo,[s("div",yo,[(o(!0),r(C,null,M(je.value,x=>(o(),r("button",{key:x,type:"button",onClick:N=>Je("suggestions",x),disabled:Re("suggestions",x),class:"rounded-full border px-2.5 py-1 text-[11px] font-medium transition border-slate-200 bg-white text-slate-700 hover:border-sky-300 hover:bg-sky-50 hover:text-sky-800 disabled:opacity-40 disabled:cursor-not-allowed"},i(x),9,go))),128))])])):g("",!0),s("div",ho,[t[37]||(t[37]=s("label",{class:"text-[11px] font-medium text-slate-500"}," Suggestions / Development plan ",-1)),be(s("textarea",{"onUpdate:modelValue":t[6]||(t[6]=x=>le.value=x),placeholder:"Specific actions, training plans, timeline and expectations…",class:"w-full rounded-xl border px-3 py-2 text-sm min-h-28 focus:outline-none focus:ring-2 focus:ring-sky-200"},null,512),[[Be,le.value]])])])])])):g("",!0),s("div",_o,[t[39]||(t[39]=s("div",{class:"text-sm text-slate-600"},null,-1)),s("div",ko,[cs.value?(o(),r("button",{key:0,onClick:Gs,disabled:!Is.value,class:"inline-flex items-center justify-center rounded-xl bg-slate-900 px-5 py-2.5 text-sm font-medium text-white shadow hover:bg-slate-800 disabled:opacity-40 focus:outline-none focus:ring-2 focus:ring-slate-300"},i(fs.value),9,wo)):g("",!0),q.value&&!V.value?(o(),r("button",{key:1,onClick:Hs,disabled:!js.value,class:"inline-flex items-center justify-center rounded-xl bg-emerald-600 px-5 py-2.5 text-sm font-medium text-white shadow hover:bg-emerald-700 disabled:opacity-40 focus:outline-none focus:ring-2 focus:ring-emerald-300"},i(bs.value),9,$o)):g("",!0)])]),Qs(qs,{name:"fade-scale"},{default:Us(()=>{var x,N,es;return[Pe.value&&j.value?(o(),r("div",Fo,[s("div",{class:"absolute inset-0 bg-slate-900/60 backdrop-blur-sm","aria-hidden":"true",onClick:We}),s("div",Lo,[s("div",So,[s("div",null,[s("p",Ao,i(j.value.label),1),s("p",No," Lane: "+i(j.value.lane)+" - Reviewed by "+i(j.value.reviewer_name||"––"),1),j.value.submitted_at?(o(),r("p",Co,i(new Date(j.value.submitted_at).toLocaleString()),1)):g("",!0)]),s("button",{type:"button",class:"rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-600 hover:bg-slate-50",onClick:We}," Close ")]),s("div",Mo,[s("div",null,[t[40]||(t[40]=s("div",{class:"text-xs font-semibold text-slate-500 uppercase"},"Strengths",-1)),s("div",Eo,[(x=j.value.strengths)!=null&&x.length?(o(),r("div",Io,[(o(!0),r(C,null,M(j.value.strengths,(ke,we)=>(o(),r("p",{key:"modal-strength-"+we},"- "+i(ke),1))),128))])):(o(),r("p",jo,"No strengths entered."))])]),s("div",null,[t[41]||(t[41]=s("div",{class:"text-xs font-semibold text-slate-500 uppercase"},"Gaps",-1)),s("div",Po,[(N=j.value.gaps)!=null&&N.length?(o(),r("div",Ro,[(o(!0),r(C,null,M(j.value.gaps,(ke,we)=>(o(),r("p",{key:"modal-gap-"+we},"- "+i(ke),1))),128))])):(o(),r("p",To,"No gaps recorded."))])]),s("div",null,[t[42]||(t[42]=s("div",{class:"text-xs font-semibold text-slate-500 uppercase"},"Suggestions",-1)),s("div",Go,[(es=j.value.suggestions)!=null&&es.length?(o(),r("div",Ho,[(o(!0),r(C,null,M(j.value.suggestions,(ke,we)=>(o(),r("p",{key:"modal-sug-"+we},"- "+i(ke),1))),128))])):(o(),r("p",Bo,"No suggestions provided."))])])])])])):g("",!0)]}),_:1})],64))]))}}},Qo={__name:"KpiReviewPage",setup(p){return($,te)=>(o(),tt(Do))}};export{Qo as default};
