import{s as J,m as B,r as h,x as O,c as p,g as S,o as v,a as e,t as m,w as Q,h as M,v as Z,a2 as W,p as X,y as L,a1 as R,j as F,F as K,n as T,E as G,e as Y,q as A,f as ee,k as E}from"./index-Bn_zO_4f.js";import{a as q,b as H,u as se}from"./zk-finger-CaPTriPj.js";import{L as te}from"./LoaderView-BfTubdT2.js";import{_ as le,a as ne}from"./HeaderWithButtons-5RwvyYNt.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ae={key:0,class:"modal-bg"},ie={class:"modal-card"},oe={class:"text-xl font-bold mb-4 text-center"},de={class:"relative"},ue=["type"],re={class:"flex justify-end gap-4 mt-4"},ce={__name:"ZKUserModal",props:{editUser:Object,show:Boolean},emits:["close","saved"],setup(y,{emit:N}){const u=N,k=y,P=q(),l=J({zk_userid:"",name:"",password:"",role:0,cardno:""}),r=B(()=>!!k.editUser),i=h(!1);O(()=>k.editUser,d=>{d?(l.zk_userid=d.zk_userid||"",l.name=d.name||"",l.password=d.password||"",l.role=d.role||0,l.cardno=d.cardno||""):(l.zk_userid="",l.name="",l.password="",l.role=0,l.cardno="")},{immediate:!0});const f=async()=>{const d={...l};r.value?await P.updateUser(k.editUser.id,d):await P.createUser(d),u("saved"),u("close")};return(d,t)=>y.show?(v(),p("div",ae,[e("div",ie,[e("h2",oe,m(r.value?"Edit User":"Add User"),1),e("form",{onSubmit:Q(f,["prevent"]),class:"space-y-4"},[e("div",null,[t[7]||(t[7]=e("label",{class:"block"},"User ID",-1)),M(e("input",{"onUpdate:modelValue":t[0]||(t[0]=a=>l.zk_userid=a),type:"text",class:"input-1",required:""},null,512),[[Z,l.zk_userid]])]),e("div",null,[t[8]||(t[8]=e("label",{class:"block"},"Name",-1)),M(e("input",{"onUpdate:modelValue":t[1]||(t[1]=a=>l.name=a),type:"text",class:"input-1",required:""},null,512),[[Z,l.name]])]),e("div",null,[t[9]||(t[9]=e("label",{class:"block"},"Password",-1)),e("div",de,[M(e("input",{"onUpdate:modelValue":t[2]||(t[2]=a=>l.password=a),type:i.value?"text":"password",class:"input-1"},null,8,ue),[[W,l.password]]),e("span",{class:"absolute inset-y-0 right-3 flex items-center cursor-pointer",onClick:t[3]||(t[3]=a=>i.value=!i.value)},[e("i",{class:X(i.value?"fas fa-eye-slash":"fas fa-eye")},null,2)])])]),e("div",null,[t[11]||(t[11]=e("label",{class:"block"},"Role",-1)),M(e("select",{"onUpdate:modelValue":t[4]||(t[4]=a=>l.role=a),class:"input-1"},t[10]||(t[10]=[e("option",{value:0},"User",-1),e("option",{value:14},"Admin",-1)]),512),[[L,l.role]])]),e("div",null,[t[12]||(t[12]=e("label",{class:"block"},"Card No",-1)),M(e("input",{"onUpdate:modelValue":t[5]||(t[5]=a=>l.cardno=a),type:"text",class:"input-1"},null,512),[[Z,l.cardno]])]),e("div",re,[e("button",{type:"button",onClick:t[6]||(t[6]=a=>u("close")),class:"px-4 py-2 bg-gray-500 text-white rounded"}," Cancel "),t[13]||(t[13]=e("button",{type:"submit",class:"px-4 py-2 bg-blue-500 text-white rounded"},"Save",-1))])],32)])])):S("",!0)}},ve={key:0,class:"fixed inset-0 z-50"},fe={class:"absolute inset-0 grid place-items-center p-4"},pe={class:"relative w-full max-w-2xl rounded-xl bg-white p-5 shadow"},me={key:0,class:"absolute inset-0 grid place-items-center rounded-xl bg-white/60 z-10"},ge={class:"mt-3 grid gap-2 text-sm sm:grid-cols-2"},be={class:"font-medium"},xe={class:"font-medium"},ye={class:"font-medium"},he={class:"font-medium"},ke={class:"space-y-2"},we={class:"flex items-center justify-between"},_e={class:"text-sm font-medium"},$e={key:0,class:"ml-2 text-gray-500"},Ue={key:0,class:"text-sm text-red-600"},Ce={key:1,class:"grid gap-2 max-h-56 overflow-auto sm:grid-cols-2"},Pe=["value"],De={class:"flex flex-col leading-tight"},Se={class:"font-medium"},ze={class:"text-xs text-gray-500"},Me={class:"mt-5 flex flex-wrap justify-end gap-2"},Ne=["disabled"],Ie=["disabled"],Ve={key:0,class:"fas fa-circle-notch fa-spin mr-2"},je=["disabled"],Ae={key:0,class:"fas fa-circle-notch fa-spin mr-2"},Fe={__name:"ZKUserPushModal",props:{show:{type:Boolean,default:!1},user:{type:Object,default:null},devices:{type:Array,default:()=>[]}},emits:["close","pushed"],setup(y,{emit:N}){const u=y,k=N,P=H(),l=q(),r=R(),i=h([]),f=h(!1),d=h(!1),t=B(()=>(u.devices||[]).filter(x=>x.status==="active"));O(()=>u.show,x=>{x&&(i.value=[],f.value=!1,d.value=!1)});function a(){!f.value&&!d.value&&k("close")}function n(){i.value=t.value.map(x=>x.id)}function D(){i.value=[]}async function V(){var x;if(!((x=u.user)!=null&&x.zk_userid))return r.error("Invalid user");if(!i.value.length)return r.warning("Select at least one device");f.value=!0;try{const s=[...i.value],z=await Promise.allSettled(s.map(async _=>{const c=await l.pushSingleUserToDevice(_,u.user.zk_userid);return{deviceId:_,res:c}}));let $=0,U=0,C=0;z.forEach(_=>{if(_.status==="fulfilled"){const{res:c}=_.value;$+=Number((c==null?void 0:c.pushed)||0),U+=Number((c==null?void 0:c.already)||0)}else C++}),r.success(`User push done → created: ${$}, already: ${U}, failed: ${C}`),k("pushed",{type:"user",created:$,already:U,failed:C})}catch(s){r.error((s==null?void 0:s.message)||"User push failed")}finally{f.value=!1}}async function I(){var x;if(!((x=u.user)!=null&&x.zk_userid))return r.error("Invalid user");if(!i.value.length)return r.warning("Select at least one device");d.value=!0;try{const s=[...i.value],z=await Promise.allSettled(s.map(async c=>{const g=await P.pushFingerprintsOne(c,u.user.zk_userid);return{deviceId:c,res:g}}));let $=0,U=0,C=0,_=0;z.forEach(c=>{if(c.status==="fulfilled"){const{res:g}=c.value;$+=Number((g==null?void 0:g.pushed)||0),U+=Number((g==null?void 0:g.skipped)||0),C+=Number((g==null?void 0:g.created_users)||(g==null?void 0:g.createdUsers)||0)}else _++}),r.success(`Fingerprint push done → pushed: ${$}, skipped: ${U}, created users: ${C}, failed: ${_}`),k("pushed",{type:"fingers",pushed:$,skipped:U,createdUsers:C,failed:_})}catch(s){r.error((s==null?void 0:s.message)||"Fingerprint push failed")}finally{d.value=!1}}return(x,s)=>{var z,$,U,C,_;return y.show?(v(),p("div",ve,[e("div",{class:"absolute inset-0 bg-black/40",onClick:a}),e("div",fe,[e("div",pe,[f.value||d.value?(v(),p("div",me,s[1]||(s[1]=[e("i",{class:"fas fa-circle-notch fa-spin text-2xl"},null,-1)]))):S("",!0),e("div",{class:"flex items-start justify-between gap-4"},[s[3]||(s[3]=e("h3",{class:"text-lg font-semibold"},"Push User to Devices",-1)),e("button",{class:"text-gray-500 hover:text-gray-700",onClick:a,title:"Close"},s[2]||(s[2]=[e("i",{class:"fas fa-times"},null,-1)]))]),e("div",ge,[e("div",null,[s[4]||(s[4]=e("div",{class:"text-gray-500"},"ZK UID",-1)),e("div",be,m((z=y.user)==null?void 0:z.zk_uid),1)]),e("div",null,[s[5]||(s[5]=e("div",{class:"text-gray-500"},"Device User ID",-1)),e("div",xe,m(($=y.user)==null?void 0:$.zk_userid),1)]),e("div",null,[s[6]||(s[6]=e("div",{class:"text-gray-500"},"Name (Device)",-1)),e("div",ye,m((U=y.user)==null?void 0:U.name),1)]),e("div",null,[s[7]||(s[7]=e("div",{class:"text-gray-500"},"Name (Software)",-1)),e("div",he,m(((_=(C=y.user)==null?void 0:C.user)==null?void 0:_.name)||"—"),1)])]),s[9]||(s[9]=e("hr",{class:"my-4"},null,-1)),e("div",ke,[e("div",we,[e("div",_e,[s[8]||(s[8]=F(" Select target devices (active) ")),i.value.length?(v(),p("span",$e," • Selected: "+m(i.value.length),1)):S("",!0)]),e("div",{class:"flex gap-2"},[e("button",{class:"px-2 py-1 rounded border",onClick:n},"Select all"),e("button",{class:"px-2 py-1 rounded border",onClick:D},"Clear")])]),t.value.length?(v(),p("div",Ce,[(v(!0),p(K,null,T(t.value,c=>(v(),p("label",{key:c.id,class:"flex items-center gap-2 rounded border p-2"},[M(e("input",{type:"checkbox","onUpdate:modelValue":s[0]||(s[0]=g=>i.value=g),value:c.id},null,8,Pe),[[G,i.value]]),e("div",De,[e("span",Se,m(c.name),1),e("span",ze,m(c.ip_address)+" : "+m(c.port),1)])]))),128))])):(v(),p("div",Ue," No active devices found. "))]),e("div",Me,[e("button",{class:"px-3 py-2 border rounded",disabled:f.value||d.value,onClick:a}," Cancel ",8,Ne),e("button",{class:"px-3 py-2 rounded bg-blue-600 text-white",disabled:f.value||d.value||!i.value.length,onClick:V,title:"Push user profile to selected devices"},[f.value?(v(),p("i",Ve)):S("",!0),e("span",null,m(f.value?"Pushing user...":"Push user"),1)],8,Ie),e("button",{class:"px-3 py-2 rounded bg-purple-600 text-white",disabled:f.value||d.value||!i.value.length,onClick:I,title:"Push fingerprints to selected devices"},[d.value?(v(),p("i",Ae)):S("",!0),e("span",null,m(d.value?"Pushing fingerprints...":"Push fingerprints"),1)],8,je)])])])])):S("",!0)}}},Ee={key:0,class:"fixed inset-0 z-50 flex items-center justify-center"},Ke={class:"relative z-10 w-full max-w-lg rounded-xl bg-white p-5 shadow-xl"},Ze={class:"space-y-4"},Be={class:"rounded-md bg-gray-50 p-3 text-sm"},Oe=["disabled"],Te=["value"],qe={key:0,class:"mt-2 text-sm text-gray-500"},Le={key:0,class:"rounded-md bg-red-50 p-3 text-sm text-red-700"},Re={class:"mt-6 flex items-center justify-end gap-2"},Ge=["disabled"],He=["disabled"],Je={key:0,class:"inline-flex items-center gap-2"},Qe={key:1,class:"inline-flex items-center gap-2"},We={__name:"ZKUserPullModal",props:{show:{type:Boolean,default:!1},user:{type:Object,default:null},devices:{type:Array,default:()=>[]}},emits:["close","pulled"],setup(y,{emit:N}){const u=y,k=N,P=H(),l=h(null),r=h(!1),i=h(null);O(()=>u.show,a=>{var n,D;a&&(i.value=null,r.value=!1,l.value=((D=(n=u.devices)==null?void 0:n[0])==null?void 0:D.id)??null)});const f=B(()=>(u.devices||[]).map(a=>({id:a.id,label:(a.name||a.title||`Device #${a.id}`)+(a.ip_address?` — ${a.ip_address}`:"")})));function d(){r.value||k("close")}async function t(){var a;if(!((a=u.user)!=null&&a.zk_userid)){i.value="Invalid user (missing zk_userid)";return}if(!l.value){i.value="Please select a device";return}r.value=!0,i.value=null;try{const n=await P.pullUserFingersFromDevice(Number(l.value),String(u.user.zk_userid));k("pulled",{...n,device_id:Number(l.value)}),k("close")}catch(n){i.value=(n==null?void 0:n.message)||(n==null?void 0:n.error)||"Pull failed"}finally{r.value=!1}}return(a,n)=>{var D,V,I,x;return y.show?(v(),p("div",Ee,[e("div",{class:"absolute inset-0 bg-black/40",onClick:d}),e("div",Ke,[e("div",{class:"mb-4 flex items-center justify-between"},[n[2]||(n[2]=e("h3",{class:"text-lg font-semibold"},"Pull fingerprints (single device)",-1)),e("button",{class:"text-gray-500 hover:text-gray-700",onClick:d,title:"Close"},n[1]||(n[1]=[e("i",{class:"fas fa-times"},null,-1)]))]),e("div",Ze,[e("div",Be,[e("div",null,[n[3]||(n[3]=e("span",{class:"font-medium"},"User (device user id):",-1)),F(" "+m(((D=y.user)==null?void 0:D.zk_userid)||"—"),1)]),e("div",null,[n[4]||(n[4]=e("span",{class:"font-medium"},"Name:",-1)),F(" "+m(((V=y.user)==null?void 0:V.name)||((x=(I=y.user)==null?void 0:I.user)==null?void 0:x.name)||"—"),1)])]),e("div",null,[n[5]||(n[5]=e("label",{class:"label"},"Select device",-1)),M(e("select",{"onUpdate:modelValue":n[0]||(n[0]=s=>l.value=s),class:"input-1 w-full",disabled:!f.value.length||r.value},[(v(!0),p(K,null,T(f.value,s=>(v(),p("option",{key:s.id,value:s.id},m(s.label),9,Te))),128))],8,Oe),[[L,l.value]]),f.value.length?S("",!0):(v(),p("p",qe," No devices found. Please add devices first. "))]),i.value?(v(),p("p",Le,m(i.value),1)):S("",!0)]),e("div",Re,[e("button",{class:"btn-3",onClick:d,disabled:r.value},"Cancel",8,Ge),e("button",{class:"btn-2",onClick:t,disabled:r.value||!f.value.length},[r.value?(v(),p("span",Je,n[6]||(n[6]=[e("i",{class:"fas fa-spinner fa-spin"},null,-1),F(" Pulling... ")]))):(v(),p("span",Qe,n[7]||(n[7]=[e("i",{class:"fas fa-download"},null,-1),F(" Pull ")])))],8,He)])])])):S("",!0)}}},Xe={class:"my-container space-y-4"},Ye={key:1,class:"overflow-x-auto card-bg"},es={class:"min-w-full text-sm text-left text-gray-700"},ss={class:"bg-gray-200 uppercase text-xs text-gray-600 tracking-wider"},ts={class:"p-3"},ls={class:"p-3"},ns=["value"],as={class:"p-3"},is={class:"p-3 font-medium"},os={class:"p-3"},ds={class:"p-3"},us={class:"p-3 space-x-6"},rs=["onClick"],cs=["onClick"],vs=["onClick"],fs=["onClick"],ys={__name:"ZKUsers",setup(y){const N=R(),u=q(),k=se(),P=h([]),l=h(!1),r=h(null),i=h(!1),f=h(null),d=h(!1),t=h(null),a=h(!1),n=h(null);Y(()=>{u.fetchUsers(),k.fetchDevices()});function D(){r.value=null,l.value=!0}function V(b){r.value={...b},l.value=!0}function I(){l.value=!1}function x(){u.fetchUsers(),I()}function s(b){f.value=b,i.value=!0}async function z(){await u.deleteUser(f.value),f.value=null,i.value=!1,u.fetchUsers()}function $(b){t.value={...b},d.value=!0}function U(b){}function C(b){n.value={...b},a.value=!0}function _(b){N.success(`✅ Pulled ${(b==null?void 0:b.fingers_pulled)??0} template(s) from device ${(b==null?void 0:b.device_id)??""}`)}function c(b){b.target.checked?P.value=u.users.map(o=>o.id):P.value=[]}const g={0:"User",14:"Admin"};return(b,o)=>(v(),p(K,null,[e("div",Xe,[A(le,{title:"ZK User Management",onAdd:D}),E(u).loading?(v(),ee(te,{key:0})):(v(),p("div",Ye,[e("table",es,[e("thead",ss,[e("tr",null,[e("th",ts,[e("input",{type:"checkbox",onChange:o[0]||(o[0]=w=>c(w))},null,32)]),o[5]||(o[5]=e("th",{class:"p-3"},"Device User ID",-1)),o[6]||(o[6]=e("th",{class:"p-3"},"Name (Device)",-1)),o[7]||(o[7]=e("th",{class:"p-3"},"Fingers",-1)),o[8]||(o[8]=e("th",{class:"p-3"},"Role",-1)),o[9]||(o[9]=e("th",{class:"p-3"},"Actions",-1))])]),e("tbody",null,[(v(!0),p(K,null,T(E(u).users,w=>(v(),p("tr",{key:w.id,class:"border-b hover:bg-gray-50 transition-colors duration-150"},[e("td",ls,[M(e("input",{type:"checkbox",value:w.id,"onUpdate:modelValue":o[1]||(o[1]=j=>P.value=j)},null,8,ns),[[G,P.value]])]),e("td",as,m(w.zk_userid),1),e("td",is,m(w.name),1),e("td",os,m(w.fingerprints_count),1),e("td",ds,m(g[w.role]??"—"),1),e("td",us,[e("button",{onClick:j=>V(w),class:"text-blue-600 hover:text-blue-800 font-semibold",title:"Edit user"},o[10]||(o[10]=[e("i",{class:"fas fa-edit"},null,-1)]),8,rs),e("button",{onClick:j=>$(w),class:"text-purple-600 hover:text-purple-800 font-semibold",title:"Push user's fingerprints to selected devices"},o[11]||(o[11]=[e("i",{class:"fas fa-upload"},null,-1)]),8,cs),e("button",{onClick:j=>C(w),class:"text-green-600 hover:text-green-800 font-semibold",title:"Pull user's fingerprints from a selected device"},o[12]||(o[12]=[e("i",{class:"fas fa-fingerprint"},null,-1)]),8,vs),e("button",{onClick:j=>s(w.id),class:"text-red-600 hover:text-red-800 font-semibold",title:"Delete user"},o[13]||(o[13]=[e("i",{class:"fas fa-trash"},null,-1)]),8,fs)])]))),128))])])]))]),A(ce,{show:l.value,editUser:r.value,onClose:I,onSaved:x},null,8,["show","editUser"]),A(ne,{show:i.value,title:"Confirm Deletion",message:"Are you sure you want to delete this user?",onClose:o[2]||(o[2]=w=>i.value=!1),onConfirm:z},null,8,["show"]),A(Fe,{show:d.value,user:t.value,devices:E(k).devices,onClose:o[3]||(o[3]=w=>d.value=!1),onPushed:U},null,8,["show","user","devices"]),A(We,{show:a.value,user:n.value,devices:E(k).devices,onClose:o[4]||(o[4]=w=>a.value=!1),onPulled:_},null,8,["show","user","devices"])],64))}};export{ys as default};
