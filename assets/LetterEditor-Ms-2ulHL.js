import{B as H,r as b,x as R,C as f,c as J,o as Q,a as W,d as X}from"./index-Ngyzrnb3.js";import{_ as Z}from"./TextEditor-DdjAw0G3.js";const h=t=>Array.isArray(t)?t:[],B=t=>{if(!t)return null;const a=t.month_start||t.monthStart||t.start||t.value,p=t.label||t.name||"";return{...t,month_start:a,label:p}},C=t=>{if(!t)return{};const a=t.paycuts||t.paycut_items||t.paycut_list||t.paycut||[];return{...t,manual_indisciplines:h(t.manual_indisciplines||t.indisciplines||t.manualIndisciplines),manual_actions:h(t.manual_actions||t.actions||t.manualActions),attachments:h(t.attachments||t.attachment_files||t.files),letters:h(t.letters||t.text_letters||t.letter_attachments),paycuts:Array.isArray(a)?a:a?[a]:[]}},V=t=>{const a=(t==null?void 0:t.data)||{};return a!=null&&a.data&&typeof a.data=="object"&&!Array.isArray(a.data)?a.data:a},U=t=>{if(!(t!=null&&t.user)||!(t!=null&&t.months))return t;const a=t.user||{},p=t.year_review||{},l=Object.entries(t.months||{}).map(([d,_])=>{var A,P;const E=h((A=_==null?void 0:_.indiscipline)==null?void 0:A.manual),N=h((P=_==null?void 0:_.actions)==null?void 0:P.manual),w=(_==null?void 0:_.paycut)||null,M=Number((_==null?void 0:_.attachment_count)??(_==null?void 0:_.attachments_count)??0);return{month_start:d,paycut:w,paycuts:w?[w]:[],manual_indisciplines:E,manual_actions:N,indisciplines:E,actions:N,attachments_count:M,attachment_count:M}}),o=p==null?void 0:p.final_score;return{...a,month_records:l,final_outcome:o??a.final_outcome,final_score:o??a.final_score,yearly_final_outcome:o??a.yearly_final_outcome}},$=t=>{const a=U(t),p=h(a.month_records||a.monthRecords||a.records||a.months),l={};return p.forEach(o=>{const d=(o==null?void 0:o.month_start)||(o==null?void 0:o.monthStart);d&&(l[d]=C(o))}),{...a,_monthMap:l}},tt=t=>{const a=(t==null?void 0:t.meta)||(t==null?void 0:t.pagination)||{},p=Number((t==null?void 0:t.current_page)||a.current_page||a.page||1),l=Number((t==null?void 0:t.per_page)||a.per_page||a.perPage||25),o=Number((t==null?void 0:t.total)||a.total||0),d=Number((t==null?void 0:t.last_page)||a.last_page||a.lastPage);return{page:p,per_page:l,total:o,last_page:d||(l>0?Math.ceil(o/l):1)}},k=t=>{const a={};return Object.entries(t||{}).forEach(([p,l])=>{l==null||l===""||(a[p]=l)}),a},st=H("discipline-report",()=>{const t=b([]),a=b([]),p=b({page:1,per_page:25,total:0,last_page:1}),l=b({year:new Date().getFullYear(),search:"",company_id:"",department_id:"",line_type:"all",employee_id:"",page:1,per_page:25}),o=b(!1),d=b(null),_=R(()=>t.value),E=R(()=>a.value),N=R(()=>p.value),w=(n={})=>{["year","search","company_id","department_id","line_type","employee_id","page","per_page"].forEach(c=>{c in n&&(l.value[c]=n[c])})},M=n=>t.value.findIndex(e=>Number((e==null?void 0:e.id)||(e==null?void 0:e.user_id))===Number(n)),A=(n,e)=>{var s,i;const c=M(n);return c<0?null:((i=(s=t.value[c])==null?void 0:s._monthMap)==null?void 0:i[e])||null},P=async(n={})=>{o.value=!0,d.value=null;try{w(n);const e=k({...l.value,...n}),c=await f.get("/discipline-report",{params:e}),s=V(c),i=Array.isArray(s)?s:s.users||s.data||s.items||[];t.value=h(i).map($),a.value=h(s.months||s.month_list||s.months_list).map(B).filter(Boolean),p.value=tt(s)}catch(e){d.value=e,console.error("Error fetching discipline report:",e)}finally{o.value=!1}},S=(n,e)=>{const c=Array.isArray(n)?n:n.users||n.data||n.items||[],s=h(c).map($);s.length&&(s.forEach(i=>{var z;const r=(i==null?void 0:i.id)||(i==null?void 0:i.user_id);if(!r)return;const m=M(r);if(m===-1){t.value.push(i);return}const u=t.value[m],g={...u._monthMap||{}},I=(z=i._monthMap)==null?void 0:z[e];I&&(g[e]=I),t.value[m]={...u,...i,_monthMap:g}}),n.months&&(a.value=h(n.months).map(B).filter(Boolean)))},v=async n=>{if(n){o.value=!0,d.value=null;try{const e=k({...l.value,month_start:n}),c=await f.get("/discipline-report",{params:e}),s=V(c);S(s,n)}catch(e){d.value=e,console.error("Error refreshing discipline month:",e)}finally{o.value=!1}}},j=async(n,e,c)=>{var s;if(!(!n||!c))try{const i=await f.post("/discipline/month-records/ensure",{user_id:n,year:e,month_start:c}),r=((s=i==null?void 0:i.data)==null?void 0:s.data)||(i==null?void 0:i.data)||null;if(r){const m=M(n);if(m>=0){const u=t.value[m]._monthMap||{};t.value[m]._monthMap={...u,[c]:C(r)}}}}catch(i){throw console.error("Error ensuring month record:",i),i}},D=async n=>{const e=n==null?void 0:n.month_start;await f.post("/discipline/indisciplines",n),e&&await v(e)},F=async(n,e,c={})=>{const{user_id:s,month_start:i}=c,r=A(s,i),m=(r==null?void 0:r.manual_indisciplines)||[],u=m.findIndex(g=>g.id===n),y=u>=0?{...m[u]}:null;u>=0&&(m[u]={...m[u],...e});try{await f.patch(`/discipline/indisciplines/${n}`,e)}catch(g){throw u>=0&&y&&(m[u]=y),g}},L=async(n,e={})=>{await f.delete(`/discipline/indisciplines/${n}`),e!=null&&e.month_start&&await v(e.month_start)},x=async n=>{const e=n==null?void 0:n.month_start;await f.post("/discipline/actions",n),e&&await v(e)},K=async(n,e,c={})=>{const{user_id:s,month_start:i}=c,r=A(s,i),m=(r==null?void 0:r.manual_actions)||[],u=m.findIndex(g=>g.id===n),y=u>=0?{...m[u]}:null;u>=0&&(m[u]={...m[u],...e});try{await f.patch(`/discipline/actions/${n}`,e)}catch(g){throw u>=0&&y&&(m[u]=y),g}},O=async(n,e={})=>{await f.delete(`/discipline/actions/${n}`),e!=null&&e.month_start&&await v(e.month_start)},T=async({file:n,title:e,user_id:c,month_start:s,year:i})=>{const r=new FormData;r.append("file",n),e&&r.append("title",e),c&&r.append("user_id",c),s&&r.append("month_start",s),i&&r.append("year",i),await f.post("/discipline/attachments",r,{headers:{"Content-Type":"multipart/form-data"}}),s&&await v(s)},Y=async({title:n,body_html:e,user_id:c,month_start:s,year:i})=>{await f.post("/discipline/letters",{title:n,body_html:e,user_id:c,month_start:s,year:i}),s&&await v(s)},q=async(n,e={})=>{await f.delete(`/discipline/attachments/${n}`),e!=null&&e.month_start&&await v(e.month_start)},G=async({user_id:n,year:e,score:c})=>{const s=M(n),i=s>=0?{...t.value[s]}:null;s>=0&&(t.value[s]={...t.value[s],final_outcome:c,final_score:c,yearly_final_outcome:c});try{await f.patch("/discipline-report/final-outcome",{user_id:n,year:e,score:c})}catch(r){throw s>=0&&i&&(t.value[s]=i),r}};return{filters:l,loading:R(()=>o.value),error:R(()=>d.value),users:_,months:E,pagination:N,fetchReport:P,refreshMonth:v,ensureMonthRecord:j,createManualIndiscipline:D,updateManualIndiscipline:F,deleteManualIndiscipline:L,createManualAction:x,updateManualAction:K,deleteManualAction:O,uploadAttachment:T,createLetter:Y,deleteAttachment:q,updateFinalScore:G,setFilters:w}}),et={class:"space-y-2"},it={__name:"LetterEditor",props:{modelValue:{type:String,default:""}},emits:["update:modelValue"],setup(t){return(a,p)=>(Q(),J("div",et,[p[1]||(p[1]=W("label",{class:"text-xs font-semibold uppercase tracking-wide text-slate-500"}," Letter Body ",-1)),X(Z,{"model-value":t.modelValue,"onUpdate:modelValue":p[0]||(p[0]=l=>a.$emit("update:modelValue",l))},null,8,["model-value"])]))}};export{it as _,st as u};
