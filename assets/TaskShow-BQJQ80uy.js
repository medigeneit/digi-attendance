import{G as nt,r as S,e as ot,H as kt,A as rt,c as i,o as a,f as b,a as t,t as g,I as A,n as $,h as p,w,l as _,p as T,E as lt,m as C,q as I,F as P,x as L,J as mt,K as et,g as yt,v as ft,b as gt,u as bt,d as _t,k as st,y as M}from"./index-FFQob3Ky.js";import{L as at}from"./LoaderView-D3LMfMEJ.js";import{u as xt,_ as vt,O as N}from"./task-priority-CYJ8LNh7.js";import{a as ht}from"./TaskAddForm-CsSwqak7.js";import{_ as Tt}from"./TaskEditForm-Cop0pYeD.js";import{_ as $t,a as wt,b as Ct}from"./TaskTreeView-Bb9QLTbM.js";import{g as E}from"./datetime-BISRKKpq.js";import{_ as B}from"./UserChip-DQYGpQgu.js";import{u as St}from"./useTaskStore-DGrBxAU9.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./RequiredIcon-BXFGmVln.js";import"./company-B-ukXYqW.js";import"./useRequirementStore-BSncET5p.js";import"./SectionLoading-CiBvGoMm.js";const Dt={key:0},It={key:0},Pt={key:1},Ut=nt({__name:"CountdownTimer",props:{targetDateTime:{}},setup(u){const e=u,s=S(c());let d;function c(){const m=new Date(e.targetDateTime).getTime()-new Date().getTime(),f=Math.floor(m/1e3%60),l=Math.floor(m/1e3/60%60),o=Math.floor(m/(1e3*60*60)%24),k=Math.floor(m/(1e3*60*60*24));return{total:m,days:k,hours:o,minutes:l,seconds:f}}function r(){s.value=c()}return ot(()=>{d=setInterval(()=>{r(),s.value.total<=0&&clearInterval(d)},1e3)}),kt(()=>clearInterval(d)),rt(()=>e.targetDateTime,()=>{r(),clearInterval(d)}),(m,f)=>s.value.total>0?(a(),i("div",Dt,[s.value.days?(a(),i("span",It,g(s.value.days)+"d ",1)):b("",!0),t("span",null,g(s.value.hours.toString().padStart(2,"0"))+"h :",1),t("span",null,g(s.value.minutes.toString().padStart(2,"0"))+"m :",1),t("span",null,g(s.value.seconds.toString().padStart(2,"0"))+"s",1)])):(a(),i("div",Pt,[A(m.$slots,"expired",{},()=>[f[0]||(f[0]=$("Timeâ€™s up!"))])]))}}),Lt={class:"mb-3"},At={key:0,class:"flex gap-2 items-center mx-auto justify-center mb-2"},Et={key:1,class:"text-center py-4 text-gray-500"},Mt={key:2,class:"text-center py-4 text-red-500"},Nt={key:3,class:"space-y-4"},Bt={__name:"TaskList",props:{tasks:{default:null,type:Array},loading:{default:!1,type:Boolean},error:{default:"",type:String},parentId:{type:Number,default:0},treeLevel:{type:Number,required:!0}},emits:["commentButtonClick","editClick","addClick","updatePriority"],setup(u,{emit:e}){const s=u,d=e,c=S(null),{handleItemsPriorityUpdate:r,saveTaskPriority:m,listHasRearranged:f}=xt(()=>s.tasks,s.parentId),l=async()=>{await m(),d("updatePriority")};return(o,k)=>(a(),i("div",null,[t("div",Lt,[A(o.$slots,"task:header")]),p(f)?(a(),i("div",At,[k[3]||(k[3]=t("span",{class:"text-red-500"},"Priority Changed",-1)),t("button",{class:"btn-3",onClick:w(l,["prevent"])},"Save"),t("button",{class:"btn-3",onClick:k[0]||(k[0]=w((...y)=>c.value.resetItems&&c.value.resetItems(...y),["prevent"]))},"Discard")])):b("",!0),u.loading?(a(),i("div",Et,"Loading tasks...")):u.error?(a(),i("div",Mt,g(u.error),1)):(a(),i("div",Nt,[_(vt,{items:u.tasks,handle:"handle",onItemsUpdate:p(r),class:"rounded-lg bg-white overflow-hidden space-y-3",ref_key:"draggableTaskList",ref:c},{item:T(({item:y,index:h})=>[_($t,{index:h,task:y,showDraggableHandle:!0,"tree-level":u.treeLevel,class:"!border-0",onCommentButtonClick:D=>d("commentButtonClick",y.id),onEditClick:k[1]||(k[1]=D=>d("editClick",D)),onAddClick:k[2]||(k[2]=D=>d("addClick",D))},null,8,["index","task","tree-level","onCommentButtonClick"])]),_:1},8,["items","onItemsUpdate"])]))]))}},Ft={class:"flex justify-between mt-5"},Rt={class:"flex flex-wrap items-center gap-2 mt-3"},jt={__name:"SubTaskList",props:{subTasks:Array,parentId:{type:Number,required:!0},treeLevel:{type:Number,required:!0}},emits:["created","error","updatePriority"],setup(u,{emit:e}){const s=u,d=e,c=S(),r=lt({show:!1,parentId:s.parentId,requirementId:null}),m=k=>{r.show=!0,r.parentId=k,console.log({addForm:r})};function f(){r.show=!1,r.parentId=s.parentId,d("created")}function l(){c.value=!1,d("updated")}function o(){r.show=!1,r.parentId=s.parentId}return(k,y)=>(a(),i("div",null,[c.value?(a(),C(N,{key:0},{default:T(()=>[_(Tt,{taskId:c.value,onClose:y[0]||(y[0]=h=>c.value=null),onUpdated:l},null,8,["taskId"])]),_:1})):b("",!0),r.show?(a(),C(N,{key:1},{default:T(()=>[_(ht,{parentTaskId:r.parentId,requirementId:r.requirementId,onTaskCreated:f,onError:k.handleTaskError,onClose:o},null,8,["parentTaskId","requirementId","onError"])]),_:1})):b("",!0),_(Bt,{tasks:u.subTasks,parentId:u.parentId,treeLevel:u.treeLevel,onAddClick:y[2]||(y[2]=h=>m(h)),onEditClick:y[3]||(y[3]=h=>c.value=h),onUpdatePriority:y[4]||(y[4]=h=>d("updatePriority"))},{"task:header":T(()=>[t("div",Ft,[y[5]||(y[5]=t("div",{class:"flex justify-between items-center"},[t("h2",{class:"text-2xl font-bold text-gray-800"},"Sub Tasks")],-1)),t("div",Rt,[t("button",{class:"btn-1 ml-auto",onClick:y[1]||(y[1]=w(()=>m(u.parentId),["prevent"]))}," Add Sub Task ")])])]),_:1},8,["tasks","parentId","treeLevel"])]))}},qt=u=>u==null?void 0:u.reduce((e,s)=>e+s.task_weight,0),it=(u,e)=>{const s=qt(u);return u.map(d=>{const c=e.filter(r=>r.user_id===d.id).reduce((r,m)=>r+m.progress,0);return{...d,task_progress:Math.floor(c*(d.task_weight/s)),user_progress:c}})},Ot=(u,e)=>{let s=0;const d=[],c=f=>f.status==="COMPLETED",r=f=>f.users.some(l=>l.id===e),m=(f,l)=>{f.forEach(o=>{const k=r(o);d[l]=d[l]||{user_id:e,total_assigned:0,total_assigned_on_leaf_task:0,completed_count:0};const y=k&&o.children_tasks.length===0;d[l].total_assigned+=k?1:0,d[l].total_assigned_on_leaf_task+=y?1:0,s+=y?1:0,k&&c(o)&&(d[l].completed_count++,o.children_tasks.length),o.children_tasks.length>0&&m(o.children_tasks,l+1)})};return m(u,0),{sub_task_infos:d,assigned_on_any_leaf_task:s>0}},Vt=(u,e)=>u.map(s=>({...s,...Ot(e,s.id)})),Ht={key:0,class:"min-w-full bg-white rounded overflow-hidden"},zt={class:"py-0.5 text-bg font-semibold"},Gt={class:"bg-gray-50"},Wt={class:"px-2 py-1 border-y"},Jt={class:"px-2 py-1 border-y"},Kt={key:0,class:"text-sm text-gray-400"},Qt={key:1},Xt={key:1,class:"min-w-full bg-white rounded overflow-hidden"},Yt={class:"py-0.5 text-bg font-semibold"},Zt={class:"px-2 py-1 border-y"},te={class:"px-2 py-1 border-y"},ee={class:"px-2 py-1 border-y text-center"},se={class:"px-2 py-1 border-y text-center"},ae=nt({__name:"TaskProgressTable",props:{task:{},subTasks:{}},setup(u){const e=u,s=I(()=>it(e.task.users,e.task.task_reports||[])),d=I(()=>Vt(e.task.users,e.subTasks));return(c,r)=>{var m,f;return e.task.children_task_count>0?(a(),i("table",Ht,[t("caption",zt,[A(c.$slots,"caption",{},()=>[r[0]||(r[0]=$("Progress"))])]),t("thead",Gt,[t("tr",null,[r[1]||(r[1]=t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-left"},"#",-1)),r[2]||(r[2]=t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-left lg:w-[200px]"}," User ",-1)),(a(!0),i(P,null,L(((f=(m=d.value[0]||{})==null?void 0:m.sub_task_infos)==null?void 0:f.length)||1,l=>(a(),i("th",{key:l,class:"px-2 py-1 border-y font-semibold text-xs uppercase text-center"},g(l===1?"Completed Sub Task":"")+" "+g(l===2?"Completed Sub Sub Task":"")+" "+g(l===3?"Completed Sub Sub Sub Task":""),1))),128))])]),t("tbody",null,[(a(!0),i(P,null,L(d.value,(l,o)=>(a(),i("tr",{key:l.id,class:"border-t hover:bg-gray-50 cursor-pointer"},[t("td",Wt,g(o+1),1),t("td",Jt,[_(B,{user:l},null,8,["user"])]),(a(!0),i(P,null,L(l.sub_task_infos,(k,y)=>(a(),i("td",{class:"px-2 py-1 border-y text-center",key:y},[k.total_assigned===0||!l.assigned_on_any_leaf_task?(a(),i("div",Kt," Not Assigned To Any Task ")):(a(),i("div",Qt,g(k.completed_count)+" / "+g(k.total_assigned),1))]))),128))]))),128))])])):(a(),i("table",Xt,[t("caption",Yt,[A(c.$slots,"caption",{},()=>[r[3]||(r[3]=$("Progress"))])]),r[4]||(r[4]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-left"},"#"),t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-left lg:w-[200px]"}," User "),t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-center"},"Started"),t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-center"},"Finished")])],-1)),t("tbody",null,[(a(!0),i(P,null,L(s.value,(l,o)=>(a(),i("tr",{key:l.id,class:"border-t hover:bg-gray-50 cursor-pointer"},[t("td",Zt,g(o+1),1),t("td",te,[_(B,{user:l},null,8,["user"])]),t("td",ee,g(p(E)(l.task_started_at)),1),t("td",se,g(p(E)(l.task_finished_at)),1)]))),128))])]))}}}),ne=mt("task-user",()=>({updateUserStartDate:async(s,d,c)=>await et.patch(`/task-user/task/${s}/user/${d}/update-start-date/${c}`),updateUserFinishDate:async(s,d,c)=>await et.patch(`/task-user/task/${s}/user/${d}/update-finish-date/${c}`)})),oe={class:"border-b text-center"},re={key:0},le={key:1},ie={class:"mb-2 mt-6"},de={class:"flex justify-center"},ue={class:"py-6"},pe={class:"mt-2"},ce={key:0,class:"inline-block text-sm text-orange-700 text-center w-full"},ke={class:"flex justify-between items-center"},me={__name:"TaskUserDateUpdate",props:{task:{type:Object},user:{user:Object},type:{type:String}},emits:["closeClick","updateDate"],setup(u,{emit:e}){const s=u,d=e,c=ne(),r=S(""),m=S("");async function f(){var l,o;console.log({date:r.value});try{s.type=="start-date"?await c.updateUserStartDate(s.task.id,s.user.id,r.value||"0"):s.type=="finish-date"&&await c.updateUserFinishDate(s.task.id,s.user.id,r.value||"0"),d("updateDate")}catch(k){m.value=((o=(l=k.response)==null?void 0:l.data)==null?void 0:o.message)||`Failed to update ${s.type}`}}return(l,o)=>(a(),i("form",{class:"p-4",onSubmit:w(f,["prevent"])},[t("div",oe,[u.type=="start-date"?(a(),i("h2",re,"Edit Start Date")):u.type=="finish-date"?(a(),i("h2",le,"Edit Finish Date")):b("",!0)]),t("div",ie,[o[2]||(o[2]=t("div",{class:"text-xs uppercase text-gray-500 font-semibold"},"Task:",-1)),t("div",null,g(u.task.title),1)]),t("div",null,[o[3]||(o[3]=t("div",{class:"text-xs uppercase text-gray-500 font-semibold"},"User:",-1)),_(B,{user:u.user},null,8,["user"])]),t("div",de,[t("div",ue,[o[4]||(o[4]=t("label",{class:"block text-xs font-semibold"},"Date",-1)),yt(t("input",{type:"date","onUpdate:modelValue":o[0]||(o[0]=k=>r.value=k),class:"border py-2 px-4 rounded-md",size:"8"},null,512),[[ft,r.value]])])]),t("div",pe,[m.value?(a(),i("div",ce,g(m.value),1)):b("",!0)]),t("div",ke,[o[5]||(o[5]=t("div",null,[t("button",{class:"btn-2"},"Submit")],-1)),t("button",{class:"btn-3",onClick:o[1]||(o[1]=w(k=>d("closeClick"),["prevent"]))},"Close")])],32))}},ye={class:"container mx-auto p-6"},fe={key:2,class:"max-w-8xl min-h-64 mx-auto bg-white shadow-lg rounded-lg p-6 relative"},ge={class:"grid grid-cols-4"},be={class:"mb-4 flex col-span-full"},_e={class:"font-medium text-xl"},xe={class:"flex items-center gap-2 text-xs text-gray-500 mt-2 opacity-80 text-left"},ve={key:0,class:"text-xs px-2 py-0.5 rounded-full border bg-yellow-800 text-white"},he={key:1,class:"text-xs px-2 py-0.5 rounded-full border bg-red-500 text-white"},Te={class:"text-right col-span-full md:col-span-1 ml-auto flex items-start justify-center gap-4 !text-lg"},$e={class:"col-span-full"},we=["innerHTML"],Ce={class:"mt-4 col-span-full mb-6"},Se={class:"ml-auto text-right text-sm col-span-full"},De={key:1,class:"text-gray-500"},Ie={class:"font-semibold text-green-800"},Pe={key:2,class:"ml-4 text-gray-500"},Ue={class:"text-red-500 font-semibold"},Le={class:"py-2 flex justify-center items-center gap-2 col-span-full"},Ae={class:"ml-auto flex gap-4"},Ee=["disabled"],Me=["disabled"],Ne={key:0},Be={key:1},Fe={key:1,class:"text-center py-4 text-red-500"},Ze={__name:"TaskShow",setup(u){const e=St(),s=gt(),d=bt(),c=S(""),r=_t(),m=I(()=>e.tasks),f=S({}),l=S(!0);ot(async()=>{c.value="loading",await k(s.params.id),c.value=""});const o=lt({user:null,type:""});async function k(x){await e.fetchTask(x)}const y=I(()=>it(e.task.users,e.task.task_reports||[])),h=I(()=>E(e.task.started_at)),D=I(()=>E(e.task.deadline));function F(x){o.user=r.user,o.type=x}async function dt(){await k(s.params.id),o.user=null,o.type=""}const ut=x=>{d.push({name:"TaskEdit",params:{id:x}})},pt=I(()=>{var x,n;return e.task?((x=e.task)==null?void 0:x.parent_id)==0?{name:"TaskList"}:{name:"TaskShow",params:{id:(n=e.task)==null?void 0:n.parent_id}}:null});return rt(()=>s.params.id,async x=>{c.value="changing",await k(x),c.value=""}),(x,n)=>{var R,j,q,O,V,H,z,G,W,J,K,Q,X,Y,Z;const U=st("RouterLink"),ct=st("router-view");return a(),i("div",ye,[o.user?(a(),C(N,{key:0},{default:T(()=>[_(me,{task:p(e).task,user:o.user,type:o.type,onCloseClick:n[0]||(n[0]=v=>o.user=null),onUpdateDate:dt},null,8,["task","user","type"])]),_:1})):b("",!0),c.value==="loading"?(a(),C(at,{key:1})):(a(),i("div",fe,[p(e).task?(a(),i(P,{key:0},[t("section",ge,[t("div",be,[t("div",null,[t("h2",_e,g(p(e).task.title),1),t("div",xe,[(R=p(e).task)!=null&&R.is_important?(a(),i("span",ve,"IMPORTANT")):b("",!0),(j=p(e).task)!=null&&j.is_urgent?(a(),i("span",he,"URGENT")):b("",!0)])]),t("div",Te,[_(wt,{status:(q=p(e).task)==null?void 0:q.status,progressPercent:(O=p(e).task)==null?void 0:O.progress_percent,class:"h-6 !text-lg"},null,8,["status","progressPercent"]),p(e).task?(a(),C(Ct,{key:0,task:p(e).task,ref_key:"progress",ref:f,class:"!text-lg"},null,8,["task"])):b("",!0)])]),t("div",$e,[t("p",{innerHTML:(V=p(e).task)==null?void 0:V.description,class:M(["text-gray-700",{"line-clamp-3":l.value}])},null,10,we),((z=(H=p(e).task)==null?void 0:H.description)==null?void 0:z.length)>=600?(a(),i("button",{key:0,class:"text-blue-500 mt-2",onClick:n[1]||(n[1]=w(v=>l.value=!l.value,["prevent"]))}," Show "+g(l.value?"More":"Less"),1)):b("",!0)]),t("section",Ce,[_(ae,{"task-users":((G=p(e).task)==null?void 0:G.users)||[],task:p(e).task,"sub-tasks":p(e).tasks,"progress-users":y.value},{caption:T(()=>n[12]||(n[12]=[t("div",{class:"text-sm py-1 text-left uppercase font-semibold text-gray-600"}," Assigned Users ",-1)])),_:1},8,["task-users","task","sub-tasks","progress-users"])]),t("div",Se,[p(e).task.deadline?(a(),C(Ut,{key:0,targetDateTime:p(e).task.deadline,class:"text-lg font-semibold italic text-green-600"},null,8,["targetDateTime"])):b("",!0),h.value?(a(),i("span",De,[n[13]||(n[13]=$(" Started: ")),t("span",Ie,g(h.value),1)])):b("",!0),D.value?(a(),i("span",Pe,[n[14]||(n[14]=$(" Deadline: ")),t("span",Ue,g(D.value),1)])):b("",!0)]),n[19]||(n[19]=t("hr",{class:"my-3 col-span-full"},null,-1)),t("div",Le,[t("button",{onClick:n[2]||(n[2]=w(v=>{var tt;return ut((tt=p(e).task)==null?void 0:tt.id)},["stop"])),class:"btn-2 py-0.5"},"Edit"),_(U,{to:{name:"TaskUserAssign",params:{id:(W=p(e).task)==null?void 0:W.id}},class:"bg-indigo-500 hover:bg-indigo-600 text-white font-semibold px-3 py-0.5 rounded-full transition",onClick:n[3]||(n[3]=v=>v.stopPropagation())},{default:T(()=>n[15]||(n[15]=[t("i",{class:"fas fa-user-plus"},null,-1),$(" Assign Users ")])),_:1,__:[15]},8,["to"]),_(U,{to:pt.value,class:"bg-indigo-500 hover:bg-indigo-600 text-white font-semibold px-3 py-0.5 rounded-full transition",onClick:n[4]||(n[4]=v=>v.stopPropagation())},{default:T(()=>n[16]||(n[16]=[t("i",{class:"fas fa-arrow-left"},null,-1),$(" Back ")])),_:1,__:[16]},8,["to"]),t("div",Ae,[((J=p(e).task)==null?void 0:J.children_task_count)===0?(a(),i(P,{key:0},[t("button",{class:"btn-3 px-3 py-0.5 text-sm h-8 font-semibold border disabled:opacity-30 disabled:pointer-events-none",onClick:n[5]||(n[5]=w(()=>F("start-date"),["prevent"])),disabled:!!((K=x.authUserProgress)!=null&&K.started_at)}," Set Started Date ",8,Ee),t("button",{class:"btn-3 px-3 py-0.5 text-sm h-8 font-semibold border disabled:opacity-30 disabled:pointer-events-none",onClick:n[6]||(n[6]=w(()=>F("finish-date"),["prevent"])),disabled:!!((Q=x.authUserProgress)!=null&&Q.finished_at)}," Set Finish Date ",8,Me)],64)):b("",!0),m.value.length>0?(a(),C(U,{key:1,to:{name:"TaskShow",params:{id:(X=p(e).task)==null?void 0:X.id}},onClick:n[7]||(n[7]=v=>v.stopPropagation()),class:M(["py-0.5 btn-3 ml-auto text-sm h-8",{"bg-blue-500 text-white":p(s).name=="TaskShow"}])},{default:T(()=>n[17]||(n[17]=[t("i",{class:"fal fa-list-ul"},null,-1),$(" Sub Tasks ")])),_:1,__:[17]},8,["to","class"])):b("",!0),_(U,{to:{name:"TaskReports",params:{id:(Y=p(e).task)==null?void 0:Y.id}},onClick:n[8]||(n[8]=v=>v.stopPropagation()),class:M(["py-0.5 btn-3 text-sm h-8",{"bg-blue-500 text-white":p(s).name=="TaskReports"}])},{default:T(()=>n[18]||(n[18]=[t("i",{class:"fal fa-file-alt"},null,-1),$(" Reports ")])),_:1,__:[18]},8,["to","class"])])])]),p(s).name=="TaskShow"&&((Z=p(e).task)==null?void 0:Z.level)<=2?(a(),i("section",Ne,[_(jt,{subTasks:m.value,"parent-id":p(s).params.id,"tree-level":p(e).task.level+1,onCreated:n[9]||(n[9]=v=>k(p(s).params.id)),onUpdated:n[10]||(n[10]=v=>k(p(s).params.id)),onUpdatePriority:n[11]||(n[11]=v=>k(p(s).params.id))},null,8,["subTasks","parent-id","tree-level"])])):(a(),i("section",Be,[_(ct)]))],64)):(a(),i("div",Fe,g(p(e).error),1)),c.value==="changing"?(a(),C(at,{key:2,class:"absolute bg-opacity-80 inset-0 z-20"})):b("",!0)]))])}}};export{Ze as default};
