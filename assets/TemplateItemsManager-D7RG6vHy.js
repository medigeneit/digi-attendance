import{P as A,r as x,Q as L,A as S,x as M,e as R,K as F,f as P,o as y,i as z,c as g,g as w,w as J,a as t,t as h,h as I,j as D,S as K,v as B,F as T,y as j,q as V,ab as Q,a5 as Y,J as G,b as H,n as W,k as $}from"./index-CqAksBNS.js";import{_ as X}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Z=A("templateItems",()=>{const u=x([]),C=x(!1),c=x(!1),n=x("");function _(){u.value.sort((m,o)=>(m.order_no??0)-(o.order_no??0)||m.id-o.id)}async function r(m){var o,l,i,v;C.value=!0,n.value="";try{const{data:s}=await L.get(`/checklist-templates/${m}/items`);u.value=((s==null?void 0:s.data)||[]).map(e=>({...e})),_()}catch(s){n.value=((l=(o=s==null?void 0:s.response)==null?void 0:o.data)==null?void 0:l.message)||"Failed to load items",(v=(i=window==null?void 0:window.notify)==null?void 0:i.error)==null||v.call(i,n.value)}finally{C.value=!1}}async function p(m,o){var l,i,v,s,e,a;c.value=!0,n.value="";try{const{data:d}=await L.post(`/checklist-templates/${m}/items`,o),f=(d==null?void 0:d.data)||{};return u.value.push(f),_(),(i=(l=window==null?void 0:window.notify)==null?void 0:l.success)==null||i.call(l,"Item added"),f}catch(d){throw n.value=((s=(v=d==null?void 0:d.response)==null?void 0:v.data)==null?void 0:s.message)||"Failed to add item",(a=(e=window==null?void 0:window.notify)==null?void 0:e.error)==null||a.call(e,n.value),d}finally{c.value=!1}}async function b(m,o){var v,s,e,a;c.value=!0,n.value="";const l=u.value.findIndex(d=>d.id===m),i=l>=0?{...u.value[l]}:null;l>=0&&(u.value[l]={...u.value[l],...o});try{const{data:d}=await L.patch(`/checklist-template-items/${m}`,o),f=(d==null?void 0:d.data)||{};return l>=0&&(u.value[l]={...f}),_(),f}catch(d){throw l>=0&&i&&(u.value[l]=i),n.value=((s=(v=d==null?void 0:d.response)==null?void 0:v.data)==null?void 0:s.message)||"Failed to update item",(a=(e=window==null?void 0:window.notify)==null?void 0:e.error)==null||a.call(e,n.value),d}finally{c.value=!1}}async function k(m){var i,v,s,e,a,d;c.value=!0,n.value="";const o=u.value.findIndex(f=>f.id===m),l=o>=0?{...u.value[o]}:null;o>=0&&u.value.splice(o,1);try{await L.delete(`/checklist-template-items/${m}`),(v=(i=window==null?void 0:window.notify)==null?void 0:i.success)==null||v.call(i,"Item deleted")}catch(f){throw o>=0&&l&&u.value.splice(o,0,l),n.value=((e=(s=f==null?void 0:f.response)==null?void 0:s.data)==null?void 0:e.message)||"Failed to delete item",(d=(a=window==null?void 0:window.notify)==null?void 0:a.error)==null||d.call(a,n.value),f}finally{c.value=!1}}function q(m){const o=u.value.findIndex(l=>l.id===m);if(o>0){const l=u.value[o-1],i=u.value[o],v=l.order_no;l.order_no=i.order_no,i.order_no=v,u.value[o-1]=i,u.value[o]=l}}function O(m){const o=u.value.findIndex(l=>l.id===m);if(o>=0&&o<u.value.length-1){const l=u.value[o+1],i=u.value[o],v=l.order_no;l.order_no=i.order_no,i.order_no=v,u.value[o+1]=i,u.value[o]=l}}async function E(){var m,o,l,i;c.value=!0;try{const v=u.value.map((s,e)=>{const a=e;return(s.order_no??0)!==a?(s.order_no=a,L.patch(`/checklist-template-items/${s.id}`,a)):Promise.resolve()});await Promise.allSettled(v),(o=(m=window==null?void 0:window.notify)==null?void 0:m.success)==null||o.call(m,"Order saved")}catch{throw(i=(l=window==null?void 0:window.notify)==null?void 0:l.error)==null||i.call(l,"Failed to save order"),new Error("Failed to save order")}finally{c.value=!1,_()}}return{items:u,loading:C,saving:c,error:n,fetch:r,add:p,update:b,remove:k,moveUp:q,moveDown:O,saveOrder:E}}),ee=["aria-label"],te={class:"flex items-center justify-between gap-3 border-b border-gray-100 px-5 py-4 dark:border-gray-800"},se={class:"text-lg font-semibold tracking-tight"},ae=["disabled"],le={class:"px-5 py-4 space-y-4"},oe={key:0},ne={class:"flex items-center justify-between"},re={class:"flex items-center gap-2 text-xs text-gray-600"},ie=["readonly"],de={class:"mt-1 flex items-start justify-between"},ue={key:0,class:"text-xs text-rose-600"},ce={key:0,class:"mt-1 text-xs text-rose-600"},me={class:"grid grid-cols-1 gap-4 sm:grid-cols-2"},ve={class:"flex h-full items-end"},pe={class:"inline-flex items-center gap-2"},fe={key:0,class:"mt-1 text-xs text-rose-600"},ye={class:"flex flex-wrap gap-2"},be=["value"],ge={class:"inline-flex items-center gap-1"},xe={key:0,class:"mt-1 text-xs text-rose-600"},_e={class:"flex items-center justify-end gap-2 border-t border-gray-100 px-5 py-4 dark:border-gray-800"},he=["disabled"],ke=["disabled"],we={key:0,class:"h-4 w-4 animate-spin",viewBox:"0 0 24 24",fill:"none"},Ce={__name:"AddEditItemModal",props:{open:{type:Boolean,default:!1},mode:{type:String,default:"add"},model:{type:Object,default:()=>({})},nextOrder:{type:Number,default:0}},emits:["close","submit"],setup(u,{emit:C}){const c=u,n=C,_=[{value:"BLOCKED",label:"Blocked"},{value:"COMPLETED",label:"Completed"}],r=x({item_key:"",label:"",required:!1,order_no:0,status:"BLOCKED"}),p=x({}),b=x(!1),k=x(!0),q=x(null),O=x(null);function E(s){return s.toLowerCase().trim().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"").slice(0,80)}S(()=>c.open,async s=>{var e,a,d,f,N,U;s&&(c.mode==="edit"?(r.value={item_key:((e=c.model)==null?void 0:e.item_key)??"",label:((a=c.model)==null?void 0:a.label)??"",required:!!((d=c.model)!=null&&d.required),order_no:Number(((f=c.model)==null?void 0:f.order_no)??0),status:((N=c.model)==null?void 0:N.status)??"BLOCKED"},k.value=!1):(r.value={item_key:"",label:"",required:!1,order_no:Number(c.nextOrder??0),status:"BLOCKED"},k.value=!0),p.value={},b.value=!1,await G(),(U=O.value)==null||U.focus())},{immediate:!0}),S(()=>r.value.label,s=>{c.mode==="add"&&k.value&&(r.value.item_key=E(s))});const m=M(()=>c.mode==="edit"?"Edit Checklist Item":"Add Checklist Item");function o(){const s={};return c.mode==="add"&&(r.value.item_key.trim()||(s.item_key="Item key is required"),r.value.item_key.length>80&&(s.item_key="Max 80 characters"),/^[a-z0-9_]+$/.test(r.value.item_key)||(s.item_key="Use lowercase letters, numbers, and underscores only")),r.value.label.trim()||(s.label="Label is required"),(r.value.order_no==null||isNaN(r.value.order_no)||r.value.order_no<0)&&(s.order_no="Order must be 0 or a positive number"),_.some(e=>e.value===r.value.status)||(s.status="Invalid status"),p.value=s,Object.keys(s).length===0}function l(){b.value||n("close")}function i(s){c.open&&s.key==="Escape"&&(s.stopPropagation(),l())}R(()=>window.addEventListener("keydown",i)),F(()=>window.removeEventListener("keydown",i));async function v(){if(o()){b.value=!0;try{n("submit",{...r.value})}finally{b.value=!1}}}return(s,e)=>(y(),P(Y,{name:"fade"},{default:z(()=>[u.open?(y(),g("div",{key:0,class:"fixed inset-0 z-50 flex items-start justify-center bg-black/40 backdrop-blur-sm p-4 md:items-center",onClick:J(l,["self"]),"aria-modal":"true",role:"dialog","aria-label":m.value},[t("div",{ref_key:"modalRef",ref:q,class:"w-full max-w-xl rounded-2xl bg-white shadow-2xl ring-1 ring-black/5 dark:bg-gray-900 dark:text-gray-100"},[t("div",te,[t("h3",se,h(m.value),1),t("button",{class:"inline-flex h-8 w-8 items-center justify-center rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:hover:bg-gray-800",onClick:l,disabled:b.value,title:"Close"},"âœ•",8,ae)]),t("div",le,[c.mode==="add"?(y(),g("div",oe,[t("div",ne,[e[7]||(e[7]=t("label",{for:"item_key",class:"block text-sm font-medium"},"Item Key",-1)),t("label",re,[I(t("input",{type:"checkbox","onUpdate:modelValue":e[0]||(e[0]=a=>k.value=a),class:"h-4 w-4"},null,512),[[K,k.value]]),e[6]||(e[6]=D(" Auto-generate from Label "))])]),I(t("input",{ref_key:"firstInputRef",ref:O,id:"item_key","onUpdate:modelValue":e[1]||(e[1]=a=>r.value.item_key=a),readonly:k.value,maxlength:"80",type:"text",class:"mt-1 w-full rounded-lg border px-3 py-2 outline-none transition focus:ring-2 focus:ring-gray-900/20 disabled:opacity-60 dark:bg-gray-900 dark:border-gray-700",placeholder:"e.g., nid_copy"},null,8,ie),[[B,r.value.item_key,void 0,{trim:!0}]]),t("div",de,[e[8]||(e[8]=t("p",{class:"text-xs text-gray-500"},"Lowercase, numbers, underscores (max 80 chars)",-1)),p.value.item_key?(y(),g("p",ue,h(p.value.item_key),1)):w("",!0)])])):w("",!0),t("div",null,[e[9]||(e[9]=t("label",{for:"label",class:"block text-sm font-medium"},"Label",-1)),I(t("input",{id:"label","onUpdate:modelValue":e[2]||(e[2]=a=>r.value.label=a),type:"text",class:"mt-1 w-full rounded-lg border px-3 py-2 outline-none transition focus:ring-2 focus:ring-gray-900/20 dark:bg-gray-900 dark:border-gray-700",placeholder:"e.g., National ID Copy"},null,512),[[B,r.value.label,void 0,{trim:!0}]]),p.value.label?(y(),g("p",ce,h(p.value.label),1)):w("",!0)]),t("div",me,[t("div",ve,[t("label",pe,[I(t("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>r.value.required=a),type:"checkbox",class:"h-4 w-4"},null,512),[[K,r.value.required]]),e[10]||(e[10]=t("span",{class:"text-sm"},"Required",-1))])]),t("div",null,[e[11]||(e[11]=t("label",{for:"order_no",class:"block text-sm font-medium"},"Order",-1)),I(t("input",{id:"order_no","onUpdate:modelValue":e[4]||(e[4]=a=>r.value.order_no=a),type:"number",min:"0",class:"mt-1 w-full rounded-lg border px-3 py-2 outline-none transition focus:ring-2 focus:ring-gray-900/20 dark:bg-gray-900 dark:border-gray-700",placeholder:"0"},null,512),[[B,r.value.order_no,void 0,{number:!0}]]),p.value.order_no?(y(),g("p",fe,h(p.value.order_no),1)):w("",!0)])]),t("div",null,[e[12]||(e[12]=t("label",{class:"block text-sm font-medium mb-1"},"Status",-1)),t("div",ye,[(y(),g(T,null,j(_,a=>t("label",{key:a.value,class:V(["inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-sm cursor-pointer transition hover:bg-gray-50 dark:border-gray-700 dark:hover:bg-gray-800",r.value.status===a.value?"ring-2 ring-gray-900/20":""])},[I(t("input",{"onUpdate:modelValue":e[5]||(e[5]=d=>r.value.status=d),type:"radio",value:a.value,class:"h-4 w-4"},null,8,be),[[Q,r.value.status]]),t("span",ge,[t("span",{class:V(["inline-block h-2.5 w-2.5 rounded-full",{"bg-amber-500":a.value==="BLOCKED","bg-emerald-500":a.value==="COMPLETED"}])},null,2),D(" "+h(a.label),1)])],2)),64))]),p.value.status?(y(),g("p",xe,h(p.value.status),1)):w("",!0)])]),t("div",_e,[t("button",{class:"rounded-lg border px-3 py-2 text-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:border-gray-700 dark:hover:bg-gray-800",onClick:l,disabled:b.value}," Cancel ",8,he),t("button",{class:"inline-flex items-center gap-2 rounded-lg bg-gray-900 px-3 py-2 text-sm text-white transition hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-300 disabled:opacity-60",onClick:v,disabled:b.value},[b.value?(y(),g("svg",we,e[13]||(e[13]=[t("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4",opacity:"0.25"},null,-1),t("path",{d:"M22 12a10 10 0 0 1-10 10",stroke:"currentColor","stroke-width":"4","stroke-linecap":"round"},null,-1)]))):w("",!0),D(" "+h(c.mode==="edit"?"Update":"Create"),1)],8,ke)])],512)],8,ee)):w("",!0)]),_:1}))}},$e=X(Ce,[["__scopeId","data-v-0ed05c7e"]]),Ie={class:"mx-auto max-w-7xl p-4"},Oe={class:"mb-4 flex items-center gap-2"},qe={class:"flex-1"},Ee={class:"text-md text-gray-500"},Le={class:"mb-3 flex items-center gap-2"},Me={class:"ml-auto flex items-center gap-2"},Be=["disabled"],De={class:"overflow-hidden rounded-xl border bg-white"},Ne={class:"min-w-full text-sm"},Ue={key:0},Se={class:"px-3 py-2"},Ke={class:"flex items-center gap-1"},Ve=["disabled","onClick"],Re=["disabled","onClick"],Te={class:"ml-2 tabular-nums text-gray-500"},je={class:"px-3 py-2 font-mono text-xs text-gray-700"},Ae={class:"px-3 py-2"},Fe={class:"truncate"},Pe={class:"px-3 py-2"},ze={class:"inline-flex cursor-pointer items-center gap-2"},Je=["checked","disabled","onChange"],Qe={class:"text-xs"},Ye={class:"px-3 py-2"},Ge=["onClick"],He={key:1},We={key:0,class:"mt-3 text-sm text-gray-500"},et={__name:"TemplateItemsManager",setup(u){const C=H(),c=M(()=>Number(C.params.id||C.query.template_id)),n=Z(),_=x(!1),r=x("add"),p=x(null),b=x(""),k=M(()=>{const s=(b.value||"").toLowerCase().trim();return s?n.items.filter(e=>(e.item_key||"").toLowerCase().includes(s)||(e.label||"").toLowerCase().includes(s)):n.items}),q=M(()=>{var s;return((s=n.items)==null?void 0:s.length)||0});R(async()=>{c.value&&await n.fetch(c.value)});function O(){r.value="add",p.value=null,_.value=!0}function E(s){r.value="edit",p.value={...s},_.value=!0}async function m(s){var e;try{if(r.value==="add")await n.add(c.value,s);else if((e=p.value)!=null&&e.id){const a={label:s.label,status:s.status,required:!!s.required,order_no:s.order_no??p.value.order_no};await n.update(p.value.id,a)}_.value=!1}catch{}}async function o(s){var e,a;try{await n.update(s.id,{required:!s.required}),(a=(e=window==null?void 0:window.notify)==null?void 0:e.success)==null||a.call(e,"Required updated")}catch{}}function l(s){n.moveUp(s.id)}function i(s){n.moveDown(s.id)}async function v(){await n.saveOrder()}return(s,e)=>(y(),g("div",Ie,[t("div",Oe,[t("div",qe,[e[2]||(e[2]=t("h2",{class:"text-xl font-semibold"},"Checklist Template Items",-1)),t("p",Ee,"Template : "+h(c.value==1?"Joining Checklist Items":"Exist Checklist Items"),1)]),t("button",{class:"rounded bg-gray-900 px-3 py-2 text-white hover:bg-gray-800",onClick:O}," + Add Item ")]),t("div",Le,[I(t("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>b.value=a),type:"text",placeholder:"Search (key/label)â€¦",class:"w-64 rounded border px-3 py-2"},null,512),[[B,b.value]]),t("div",Me,[t("button",{class:"rounded border px-3 py-2 hover:bg-gray-50",disabled:$(n).saving,onClick:v,title:"Persist current order"},"Save Order",8,Be)])]),t("div",De,[t("table",Ne,[e[5]||(e[5]=t("thead",{class:"bg-gray-50 text-left"},[t("tr",null,[t("th",{class:"px-3 py-2 w-16"},"Order"),t("th",{class:"px-3 py-2"},"Item Key"),t("th",{class:"px-3 py-2"},"Label"),t("th",{class:"px-3 py-2 w-28"},"Required"),t("th",{class:"px-3 py-2 w-28"},"Status"),t("th",{class:"px-3 py-2 w-40"},"Actions")])],-1)),t("tbody",null,[$(n).loading?(y(),g("tr",Ue,e[3]||(e[3]=[t("td",{colspan:"5",class:"px-3 py-4"},[t("div",{class:"h-4 w-full animate-pulse rounded bg-gray-100"})],-1)]))):w("",!0),(y(!0),g(T,null,j(k.value,(a,d)=>(y(),g("tr",{key:a.id,class:"border-t hover:bg-gray-50"},[t("td",Se,[t("div",Ke,[t("button",{class:"rounded border px-2 py-1 text-xs hover:bg-gray-50 disabled:opacity-50",disabled:d===0||$(n).saving,onClick:f=>l(a),title:"Move up"},"â†‘",8,Ve),t("button",{class:"rounded border px-2 py-1 text-xs hover:bg-gray-50 disabled:opacity-50",disabled:d===k.value.length-1||$(n).saving,onClick:f=>i(a),title:"Move down"},"â†“",8,Re),t("span",Te,h(a.order_no??d),1)])]),t("td",je,h(a.item_key),1),t("td",Ae,[t("div",Fe,h(a.label),1)]),t("td",Pe,[t("label",ze,[t("input",{type:"checkbox",class:"h-4 w-4",checked:!!a.required,disabled:$(n).saving,onChange:f=>o(a)},null,40,Je),t("span",Qe,h(a.required?"Yes":"No"),1)])]),t("td",null,h(a.status),1),t("td",Ye,[t("button",{class:"btn-2 py-1",onClick:f=>E(a)},"Edit",8,Ge)])]))),128)),!$(n).loading&&k.value.length===0?(y(),g("tr",He,e[4]||(e[4]=[t("td",{colspan:"5",class:"px-3 py-6 text-center text-gray-500"},"No items",-1)]))):w("",!0)])])]),$(n).saving?(y(),g("div",We,"Savingâ€¦")):w("",!0),W($e,{open:_.value,mode:r.value,model:p.value,"next-order":q.value,onClose:e[1]||(e[1]=a=>_.value=!1),onSubmit:m},null,8,["open","mode","model","next-order"])]))}};export{et as default};
