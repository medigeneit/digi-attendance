import{Q as De,u as Ve,f as Ne,r as p,D as ie,x as n,G as Se,q as g,h as Pe,p as je,c as f,o as m,a as t,j as V,i as Ee,w as ze,t as r,s as x,d as w,b as B,F as Be,e as Ue,k as $e,v as Fe,O as Me,l as Te}from"./index-IT1V0Ofo.js";import{L as Le}from"./LoaderView-BAbIpeVv.js";import{_ as K}from"./MultiselectDropdown-D62n6TFW.js";import{_ as Re}from"./TextEditor-joJUK86s.js";import{_ as ne}from"./FlexibleDatePicker-LZ2ISg_B.js";import{u as Ge}from"./company-DcMkjy20.js";import{u as He}from"./department-Vd11_UQS.js";import{u as Oe}from"./notice-BlPKx-Rw.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const qe={class:"my-container space-y-4"},Ie={class:"card-bg md:p-8 p-4 mx-4"},Je={class:"grid grid-cols-1 md:grid-cols-3 gap-3"},Qe={class:"rounded-xl border bg-white p-4 flex items-center justify-between"},Xe={class:"flex items-center gap-3"},Ye={class:"font-semibold"},Ke={class:"rounded-xl border bg-white p-4 flex items-center justify-between"},We={class:"flex items-center gap-3"},Ze={class:"font-semibold"},et={class:"rounded-xl border bg-white p-4"},tt={class:"flex items-center justify-between"},lt={class:"flex items-center gap-3"},st={class:"font-semibold"},at={class:"border p-4 rounded-xl bg-white space-y-6 shadow-sm"},ot={class:"flex gap-4"},it={class:"inline-flex rounded-lg border overflow-hidden"},nt={class:"flex gap-4"},rt={class:"w-full"},dt={key:0,class:"text-xs text-gray-500 mt-1"},ut={class:"w-full"},pt={key:0,class:"text-xs text-red-600 mt-1"},ct={key:1,class:"text-xs text-gray-500 mt-1"},mt={class:"space-y-2"},vt={class:"flex flex-wrap gap-2"},yt=["onClick"],bt={key:0,class:"text-xs text-red-500 mt-1"},ft={class:"space-y-3"},gt={class:"flex items-center gap-2"},xt={class:"inline-flex rounded-lg border overflow-hidden"},ht={class:"grid gap-6"},_t={class:"space-y-3"},wt={class:"flex items-center gap-2"},Ct={class:"inline-flex rounded-lg border overflow-hidden"},kt={class:"space-y-3"},At={class:"flex items-center gap-2"},Dt={class:"inline-flex items-center gap-3"},Vt={class:"inline-flex rounded-lg border overflow-hidden"},Nt={class:"text-xs text-gray-500"},St={class:"border p-4 rounded-xl bg-white space-y-6 shadow-sm"},Pt={class:"space-y-2"},jt={key:0,class:"mb-2"},Et=["href"],zt={class:"w-full rounded-lg border border-dashed p-4 hover:bg-gray-50 transition"},Bt={class:"flex items-center justify-between gap-3"},Ut={class:"inline-flex items-center"},$t=["disabled"],Ft={key:0,class:"mt-3"},Mt={class:"h-2 bg-gray-200 rounded overflow-hidden"},Tt={class:"flex items-center justify-between mt-1 text-xs text-gray-600"},Lt={class:"sticky bottom-0 bg-white/90 backdrop-blur flex justify-center gap-4 p-3 rounded-xl border"},Rt=["disabled"],Gt={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4"},Ht={class:"bg-white rounded-xl shadow-xl w-full max-w-md p-6 space-y-4"},Ot={class:"text-sm text-gray-600 break-words"},qt={class:"flex justify-end gap-3"},ll={__name:"NoticeEdit",setup(It){const v=De(),W=Ve(),H=Ne(),O=p(!1),U=p(!1),N=p(!0),q=Oe(),I=Ge(),c=He(),{companies:re}=ie(I),{employees:J}=ie(c),S=n(()=>c.departments||[]),Q=n(()=>Array.isArray(J.value)?J.value:[]),P=n(()=>re.value||[]),l=Se({title:"",type:1,description:"",published_at:"",expired_at:"",all_companies:!1,all_departments:!1,all_employees:!1,file_url:null,receiver_type:[]}),Z=[{value:"doctor",label:"Doctor"},{value:"executive",label:"Executive"},{value:"support_staff",label:"Support Staff"},{value:"academic_body",label:"Academic Body"}],C=n(()=>(Array.isArray(l.receiver_type)?l.receiver_type:l.receiver_type?[l.receiver_type]:[]).filter(Boolean)),de=s=>{if(!s)return;Array.isArray(l.receiver_type)||(l.receiver_type=[]);const e=l.receiver_type.indexOf(s);e>=0?l.receiver_type.splice(e,1):l.receiver_type.push(s)},ue=()=>{l.receiver_type=Z.map(s=>s.value)},pe=()=>{l.receiver_type=[]},$=s=>{if(!s)return null;const[e,o,a]=s.split("-");return!e||!o||!a?null:{year:Number(e),month:Number(o),day:Number(a)}},d=p($(l.published_at)),y=p($(l.expired_at)),ce=()=>{d.value=null,y.value=null,l.published_at="",l.expired_at=""},j=n(()=>l.type===2),ee=s=>String(s).padStart(2,"0"),X=s=>s?`${s.year}-${ee(s.month)}-${ee(s.day)}`:"",me=()=>{const s=new Date;return{year:s.getFullYear(),month:s.getMonth()+1,day:s.getDate()}},k=p([]),A=p([]),u=p([]),h=p(null),F=p(0),D=p(!1),M=p(!1);let E=null;const ve=n(()=>{var s;return((s=h.value)==null?void 0:s.name)||""}),ye=n(()=>h.value?(h.value.size/(1024*1024)).toFixed(2):"0.00"),T=n(()=>k.value.map(s=>s.id)),te=n(()=>A.value.map(s=>s.id)),be=n(()=>u.value.map(s=>s.id)),le=s=>{if(!s)return"";const e=String(s).split(" ")[0];return e.includes("-")?e:""},Y=n(()=>{if(l.type===2||!l.published_at||!l.expired_at)return!0;try{const s=new Date(l.published_at);return new Date(l.expired_at)>=s}catch{return!0}}),fe=n(()=>{var s;return!!((s=l.title)!=null&&s.trim())&&(l.type===2||!!l.published_at)&&C.value.length>0&&!D.value&&Y.value}),L=n({get:()=>l.all_companies?"all":"custom",set:s=>{l.all_companies=s==="all",k.value=l.all_companies?[...P.value]:[]}}),R=n({get:()=>l.all_departments?"all":"custom",set:s=>{l.all_departments=s==="all",A.value=l.all_departments?[...S.value]:[]}}),G=n({get:()=>l.all_employees?"all":"custom",set:s=>{l.all_employees=s==="all",u.value=l.all_employees?[...Q.value]:[]}});g(()=>l.all_companies,async s=>{N.value||(s?await c.fetchDepartments():await c.fetchDepartments(T.value))}),g(T,async s=>{N.value||l.all_companies||await c.fetchDepartments(s)});const ge=n(()=>l.all_departments?(S.value||[]).map(s=>s.id):te.value);g([ge,C],async([s,e])=>{if(N.value)return;const o=Array.isArray(e)?e:[];if(!o.length){c.employees=[],u.value=[],l.all_employees=!1;return}if(Array.isArray(s)&&s.length>0){u.value=[];let a=[];for(const b of o){const z=await c.fetchDepartmentActiveEmployee(s,b);Array.isArray(z)&&z.forEach(i=>{a.some(_=>(_==null?void 0:_.id)===(i==null?void 0:i.id))||a.push(i)})}c.employees=a,l.all_employees&&Array.isArray(a)&&(u.value=[...a])}else c.employees=[],u.value=[],l.all_employees=!1},{immediate:!0}),g(d,s=>{if(!s){l.published_at="";return}const e=X(s);l.published_at!==e&&(l.published_at=e)}),g(y,s=>{if(!s){l.expired_at="";return}const e=X(s);l.expired_at!==e&&(l.expired_at=e)}),g(()=>l.published_at,s=>{if(!s){d.value=null;return}const e=$(s);e&&(!d.value||d.value.year!==e.year||d.value.month!==e.month||d.value.day!==e.day)&&(d.value=e)}),g(()=>l.expired_at,s=>{if(!s){y.value=null;return}const e=$(s);e&&(!y.value||y.value.year!==e.year||y.value.month!==e.month||y.value.day!==e.day)&&(y.value=e)}),g(()=>l.type,(s,e)=>{if(s===2)ce();else if(e===2&&s===1&&!d.value){const o=me();d.value=o,l.published_at=X(o)}}),g([u,J],([s,e])=>{if(N.value)return;const o=Array.isArray(e)?e.length:0;l.all_employees=o>0&&s.length===o});const xe=async()=>{var e,o,a,b,z;const s=H.params.id;try{const i=await q.fetchNotice(s);l.title=i.title??"",l.type=Number(i.type??1),l.published_at=le(i.published_at),l.expired_at=le(i.expired_at),l.description=i.description??"",l.file_url=i.file_url||i.file||null,l.receiver_type=Array.isArray(i.receiver_type)?i.receiver_type.filter(Boolean):i.receiver_type?[i.receiver_type]:[];const _=(((e=i.companies_notice)==null?void 0:e.length)??0)>0;l.all_companies=!_,P.value.length===0&&await I.fetchCompanies(),k.value=_?i.companies_notice:[...P.value],l.all_companies?await c.fetchDepartments():await c.fetchDepartments(T.value);const ae=(((o=i.departments)==null?void 0:o.length)??0)>0;l.all_departments=!ae,A.value=ae?i.departments:[...S.value];const oe=(((a=i.employees)==null?void 0:a.length)??0)>0;l.all_employees=!oe,u.value=oe?i.employees:[]}catch(i){const _=((z=(b=i==null?void 0:i.response)==null?void 0:b.data)==null?void 0:z.message)||"Failed to load notice data";v.error(_),W.push({name:"NoticeList"})}},he=s=>{var a,b;const e=(b=(a=s==null?void 0:s.target)==null?void 0:a.files)==null?void 0:b[0];if(!e)return;if(!["image/jpeg","image/jpg","image/png","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"].includes(e.type)){v.error("Unsupported file type. Allowed: jpg, jpeg, png, pdf, doc, docx.");return}if(e.size>2*1024*1024){v.error("File size must be ≤ 2MB.");return}h.value=e,M.value=!0},_e=async()=>{var s,e;try{const o=H.params.id;if(!(h.value instanceof Blob))return;F.value=0,D.value=!0,E=new AbortController;const a=await q.updateNoticeFile(o,h.value,{onProgress:b=>F.value=b,signal:E.signal});l.file_url=(a==null?void 0:a.file_url)||(a==null?void 0:a.file)||l.file_url,v.success("File uploaded successfully.")}catch(o){if((o==null?void 0:o.name)==="CanceledError"||(o==null?void 0:o.message)==="canceled")v.info("Upload canceled.");else{const a=((e=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:e.message)||(o==null?void 0:o.message)||"Upload failed.";v.error(a)}}finally{D.value=!1,M.value=!1,h.value=null,E=null}},we=()=>{E&&E.abort()},Ce=async()=>{var s,e;if(!C.value.length){v.error("Receiver type is required.");return}if(!Y.value){v.error("Expire date must be the same or after Publish date.");return}try{U.value=!0;const o=H.params.id,a={title:l.title,type:l.type,description:l.description,published_at:l.type===2?null:l.published_at||null,expired_at:l.type===2?null:l.expired_at||null,all_companies:!!l.all_companies,all_departments:!!l.all_departments,all_employees:!!l.all_employees,company_ids:T.value,department_ids:te.value,employee_ids:be.value,receiver_type:C.value};await q.updateNotice(o,a),v.success("Notice updated successfully"),W.push({name:"NoticeShow",params:{id:o}})}catch(o){const a=((e=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:e.message)||(o==null?void 0:o.message)||"Failed to update notice";v.error(a)}finally{U.value=!1}};Pe(async()=>{O.value=!0,await I.fetchCompanies(),await xe(),O.value=!1,N.value=!1});const ke=n(()=>P.value.length),Ae=n(()=>S.value.length),se=n(()=>Q.value.length);return(s,e)=>{const o=je("RouterLink");return m(),f("div",qe,[t("div",Ie,[e[36]||(e[36]=t("h2",{class:"title-lg text-center"},"Edit Notice",-1)),O.value?(m(),Ee(Le,{key:0,class:"bg-gray-100 border shadow-none"})):(m(),f("form",{key:1,onSubmit:ze(Ce,["prevent"]),class:"space-y-5"},[t("div",Je,[t("div",Qe,[t("div",Xe,[e[17]||(e[17]=t("span",{class:"inline-flex h-8 w-8 items-center justify-center rounded-lg bg-blue-100"},[t("svg",{viewBox:"0 0 24 24",class:"h-5 w-5 text-blue-600"},[t("path",{fill:"currentColor",d:"M3 10v10h18V10H3zm9-7l9 7H3l9-7z"})])],-1)),t("div",null,[e[16]||(e[16]=t("div",{class:"text-sm text-gray-500"},"Companies",-1)),t("div",Ye,r(l.all_companies?"All":k.value.length)+" / "+r(ke.value),1)])])]),t("div",Ke,[t("div",We,[e[19]||(e[19]=t("span",{class:"inline-flex h-8 w-8 items-center justify-center rounded-lg bg-purple-100"},[t("svg",{viewBox:"0 0 24 24",class:"h-5 w-5 text-purple-600"},[t("path",{fill:"currentColor",d:"M3 5h18v2H3V5zm3 4h12v10H6V9z"})])],-1)),t("div",null,[e[18]||(e[18]=t("div",{class:"text-sm text-gray-500"},"Departments",-1)),t("div",Ze,r(l.all_departments?"All":A.value.length)+" / "+r(Ae.value),1)])])]),t("div",et,[t("div",tt,[t("div",lt,[e[21]||(e[21]=t("span",{class:"inline-flex h-8 w-8 items-center justify-center rounded-lg bg-emerald-100"},[t("svg",{viewBox:"0 0 24 24",class:"h-5 w-5 text-emerald-600"},[t("path",{fill:"currentColor",d:"M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6z"})])],-1)),t("div",null,[e[20]||(e[20]=t("div",{class:"text-sm text-gray-500"},"Employees",-1)),t("div",st,r(l.all_employees?"All":u.value.length)+" / "+r(se.value),1)])])])])]),t("div",at,[e[27]||(e[27]=t("h2",{class:"text-lg font-semibold"},"Notice Information",-1)),t("div",null,[e[22]||(e[22]=t("label",{for:"type",class:"font-medium block mb-1"},"Type*",-1)),t("div",ot,[t("div",it,[t("button",{type:"button",class:x(["px-4 py-2 text-sm",l.type===1?"bg-blue-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[0]||(e[0]=a=>l.type=1)}," General ",2),t("button",{type:"button",class:x(["px-4 py-2 text-sm border-l",l.type===2?"bg-blue-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[1]||(e[1]=a=>l.type=2)}," Policy ",2)]),t("div",nt,[t("div",rt,[w(ne,{modelValue:d.value,"onUpdate:modelValue":e[2]||(e[2]=a=>d.value=a),"show-year":!1,"show-month":!1,"show-date":!0,disabled:j.value,label:"Publish Date *"},null,8,["modelValue","disabled"]),j.value?(m(),f("p",dt," Policies skip publish dates and remain visible indefinitely. ")):V("",!0)]),t("div",ut,[w(ne,{modelValue:y.value,"onUpdate:modelValue":e[3]||(e[3]=a=>y.value=a),"show-year":!1,"show-month":!1,"show-date":!0,disabled:j.value,label:"Expire Date"},null,8,["modelValue","disabled"]),!Y.value&&!j.value?(m(),f("p",pt," Expire date must be the same or after Publish date. ")):j.value?(m(),f("p",ct," Policies stay active until replaced. ")):V("",!0)])])])]),t("div",mt,[t("div",{class:"flex items-center justify-between"},[e[23]||(e[23]=t("label",{class:"font-medium block mb-1"},[B(" Send To "),t("span",{class:"text-red-500"},"*")],-1)),t("div",{class:"inline-flex gap-1 text-xs"},[t("button",{type:"button",class:"px-2 py-1 rounded border text-gray-600 hover:bg-gray-50",onClick:ue}," Select All "),t("button",{type:"button",class:"px-2 py-1 rounded border text-gray-600 hover:bg-gray-50",onClick:pe}," Clear ")])]),t("div",vt,[(m(),f(Be,null,Ue(Z,a=>t("button",{key:a.value,type:"button",class:x(["px-3 py-1.5 rounded-full border text-xs",C.value.includes(a.value)?"bg-blue-600 text-white border-blue-600":"bg-white text-gray-700 hover:bg-gray-50"]),onClick:b=>de(a.value)},r(a.label),11,yt)),64))]),C.value.length?V("",!0):(m(),f("p",bt," Receiver type is required. "))]),t("div",ft,[t("div",gt,[e[24]||(e[24]=t("label",{class:"font-medium"},"Companies",-1)),t("div",xt,[t("button",{type:"button",class:x(["px-3 py-1.5 text-xs",L.value==="all"?"bg-blue-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[4]||(e[4]=a=>L.value="all")},"All",2),t("button",{type:"button",class:x(["px-3 py-1.5 text-xs border-l",L.value==="custom"?"bg-blue-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[5]||(e[5]=a=>L.value="custom")},"Custom",2)])]),t("div",null,[w(K,{modelValue:k.value,"onUpdate:modelValue":e[6]||(e[6]=a=>k.value=a),options:P.value,multiple:!0,searchable:!0,placeholder:"Select companies","track-by":"id",label:"name","top-label":"Companies"},null,8,["modelValue","options"])])]),t("div",ht,[t("div",_t,[t("div",wt,[e[25]||(e[25]=t("label",{class:"font-medium"},"Departments",-1)),t("div",Ct,[t("button",{type:"button",class:x(["px-3 py-1.5 text-xs",R.value==="all"?"bg-purple-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[7]||(e[7]=a=>R.value="all")},"All",2),t("button",{type:"button",class:x(["px-3 py-1.5 text-xs border-l",R.value==="custom"?"bg-purple-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[8]||(e[8]=a=>R.value="custom")},"Custom",2)])]),w(K,{modelValue:A.value,"onUpdate:modelValue":e[9]||(e[9]=a=>A.value=a),options:S.value,multiple:!0,searchable:!0,placeholder:"Select departments","track-by":"id",label:"name","top-label":"Departments"},null,8,["modelValue","options"])]),t("div",kt,[t("div",At,[e[26]||(e[26]=t("label",{class:"font-medium"},"Employees",-1)),t("div",Dt,[t("div",Vt,[t("button",{type:"button",class:x(["px-3 py-1.5 text-xs",G.value==="all"?"bg-emerald-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[10]||(e[10]=a=>G.value="all")},"All",2),t("button",{type:"button",class:x(["px-3 py-1.5 text-xs border-l",G.value==="custom"?"bg-emerald-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[11]||(e[11]=a=>G.value="custom")},"Custom",2)]),t("span",Nt," Selected "+r(u.value.length)+" / "+r(se.value),1)])]),w(K,{modelValue:u.value,"onUpdate:modelValue":e[12]||(e[12]=a=>u.value=a),options:Q.value,multiple:!0,searchable:!0,placeholder:"Select employee","track-by":"id",label:"name","top-label":"Employees"},null,8,["modelValue","options"])])])]),t("div",St,[e[34]||(e[34]=t("h2",{class:"text-lg font-semibold"},"Notice Content",-1)),t("div",null,[e[28]||(e[28]=t("label",{class:"font-medium block mb-1"},"Title*",-1)),$e(t("input",{"onUpdate:modelValue":e[13]||(e[13]=a=>l.title=a),type:"text",class:"w-full p-2 border rounded",required:""},null,512),[[Fe,l.title]])]),t("div",Pt,[e[32]||(e[32]=t("label",{class:"font-medium block mb-1"},"Attachment",-1)),l.file_url?(m(),f("div",jt,[t("a",{href:l.file_url,target:"_blank",class:"inline-flex items-center gap-2 text-blue-600 underline"},e[29]||(e[29]=[t("svg",{viewBox:"0 0 24 24",class:"h-4 w-4"},[t("path",{fill:"currentColor",d:"M14 3H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"}),t("path",{fill:"currentColor",d:"M14 3v6h6"})],-1),B(" View Current File ")]),8,Et)])):V("",!0),t("div",zt,[t("div",Bt,[e[31]||(e[31]=t("div",{class:"text-sm text-gray-600"},[t("div",{class:"font-medium"},"Upload new file"),t("div",null,"JPG, JPEG, PNG, PDF, DOC, DOCX (≤ 2MB)")],-1)),t("label",Ut,[t("input",{type:"file",accept:".jpg,.jpeg,.png,.pdf,.doc,.docx",onChange:he,class:"hidden",disabled:D.value},null,40,$t),e[30]||(e[30]=t("span",{class:"px-4 py-2 rounded border bg-white hover:bg-gray-50 cursor-pointer"}," Browse… ",-1))])]),D.value?(m(),f("div",Ft,[t("div",Mt,[t("div",{class:"h-2 bg-blue-600 transition-all",style:Me({width:F.value+"%"})},null,4)]),t("div",Tt,[t("span",null,r(F.value)+"%",1),t("button",{type:"button",class:"px-3 py-1 rounded border hover:bg-gray-50",onClick:we}," Cancel ")])])):V("",!0)])]),t("div",null,[e[33]||(e[33]=t("label",{class:"font-medium block mb-1"},"Description",-1)),w(Re,{modelValue:l.description,"onUpdate:modelValue":e[14]||(e[14]=a=>l.description=a),class:"w-full px-4 py-2"},null,8,["modelValue"])])]),t("div",Lt,[w(o,{to:{name:"NoticeList"},type:"button",class:"bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"},{default:Te(()=>e[35]||(e[35]=[B(" Cancel ")])),_:1,__:[35]}),t("button",{disabled:U.value||D.value||!fe.value,type:"submit",class:"bg-blue-600 text-white px-5 py-2 rounded hover:bg-blue-700 disabled:opacity-60"},r(U.value?"Saving…":"Save"),9,Rt)])],32))]),M.value?(m(),f("div",Gt,[t("div",Ht,[e[40]||(e[40]=t("h3",{class:"text-lg font-semibold"},"Upload this file?",-1)),t("p",Ot,[e[37]||(e[37]=t("span",{class:"font-medium"},"Name:",-1)),B(" "+r(ve.value),1),e[38]||(e[38]=t("br",null,null,-1)),e[39]||(e[39]=t("span",{class:"font-medium"},"Size:",-1)),B(" "+r(ye.value)+" MB ",1)]),t("div",qt,[t("button",{class:"px-4 py-2 rounded border hover:bg-gray-50",onClick:e[15]||(e[15]=a=>{M.value=!1,h.value=null})}," Cancel "),t("button",{class:"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",onClick:_e}," Upload ")])])])):V("",!0)])}}};export{ll as default};
