import{B as he,r as j,G as we,x as U,C as ye,D as ke,f as Se,u as Ce,h as $e,c as r,o as i,k as C,a as t,s as me,t as p,d as Me,b as _e,l as A,v as L,n as c,F as P,e as B}from"./index-DHp0yAPx.js";import{_ as De}from"./EmployeeFilter-D6UDqzRI.js";import"./company-D9uh6rHN.js";import"./department-D73SwJBL.js";import"./EmployeeDropdownInput-D1w4cEGq.js";import"./SelectDropdown-Btd9safT.js";import"./UserChip-CW1u3Slr.js";import"./user-uUh910Tf.js";const Te=he("weeklyUpdates",()=>{const E=j(!1),g=j(null),z=j(null),R=j([]),$=j([]),F=we({anchor_date:"",past_days:5,future_days:5,window:null,start_date:"",end_date:"",company_id:"",department_id:"",line_type:"",user_id:"",status:""});let _=null,l=0;const x=v=>{const y={};return Object.entries(v||{}).forEach(([h,f])=>{f==null||f===""||f!=="all"&&(y[h]=f)}),y},M=async(v={})=>{var h,f,T,w,I;const y=++l;E.value=!0,g.value=null,Object.assign(F,v),_&&_.abort(),_=new AbortController;try{const u=await ye.get("/weekly-updates",{params:x(F),signal:_.signal});return y!==l?void 0:(z.value=((h=u.data)==null?void 0:h.meta)??null,R.value=((f=u.data)==null?void 0:f.dates)??[],$.value=((T=u.data)==null?void 0:T.rows)??[],u.data)}catch(u){if((u==null?void 0:u.name)==="CanceledError"||(u==null?void 0:u.code)==="ERR_CANCELED"||y!==l)return;throw g.value=((I=(w=u==null?void 0:u.response)==null?void 0:w.data)==null?void 0:I.message)||(u==null?void 0:u.message)||"Failed to load weekly updates.",u}finally{y===l&&(E.value=!1)}},a=async v=>{const{kind:y,ref_id:h,status:f,message:T}=v||{};if(!y||!h)throw new Error("Invalid item");const w={kind:y,ref_id:h};return f!=null&&f!==""&&(w.status=f),T&&(w.message=T),await ye.post("/weekly-updates/send-message",w)},n=()=>M({window:"prev"}),D=()=>M({window:"next"}),V=(v,y)=>M({past_days:v,future_days:y,window:null}),G=(v={})=>M(v),Q=U(()=>R.value),Y=U(()=>$.value),W=U(()=>z.value);return{loading:E,error:g,params:F,dates:Q,rows:Y,meta:W,fetchWeekly:M,prevWeek:n,nextWeek:D,applyRange:V,setFilters:G,sendWeeklyMessage:a}}),qe={class:"space-y-3 px-4"},je={class:"rounded-2xl border border-slate-200 bg-white p-3 shadow-sm"},Fe={class:"rounded-2xl border border-slate-200 bg-white p-3 shadow-sm"},Ie={class:"flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between"},Ne={class:"flex flex-wrap items-center gap-2"},Ue={class:"rounded-xl border border-slate-200 bg-slate-50/70 px-2 py-1"},Re={class:"flex items-center gap-2"},We={class:"flex items-center gap-2 text-xs font-semibold text-slate-600"},Oe={class:"flex items-center gap-2 text-xs font-semibold text-slate-600"},Ee={class:"flex items-center gap-2 text-xs font-semibold text-slate-600"},ze={class:"flex items-center justify-between gap-3 text-xs text-slate-500 lg:justify-end"},Ve={key:0,class:"font-semibold text-slate-800"},Ke={key:1},Ae={key:1,class:"rounded-xl border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-700"},Le={key:2,class:"rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-500"},Pe={key:3,class:"rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden"},Be={class:"overflow-x-auto"},Ge={class:"min-w-max w-full text-sm"},Qe={class:"bg-slate-50 text-slate-600"},Ye={class:"text-[11px] font-semibold text-slate-400"},He={class:"text-xs font-semibold text-slate-800"},Je={class:"sticky left-0 z-20 border-r border-slate-200 bg-white px-4 py-3"},Xe={class:"min-w-0"},Ze={class:"truncate font-semibold text-slate-900"},et={key:0,class:"flex flex-wrap gap-1.5"},tt=["title","onClick"],st={key:1,class:"text-slate-300 text-sm"},at={class:"px-4 py-3 text-right"},lt=["disabled","onClick"],nt={key:0},ot={key:1},dt={key:0,class:"border-t border-slate-100"},rt=["colspan"],it={key:4,class:"fixed inset-0 z-[75] flex items-center justify-center bg-slate-900/50 p-4"},ut={class:"w-full max-w-lg rounded-2xl bg-white p-4 shadow-xl"},pt={class:"flex items-start justify-between gap-3"},ct={class:"text-xs text-slate-500"},yt={class:"mt-3 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600"},mt={class:"mt-1 flex flex-wrap items-center gap-2"},_t={class:"rounded-full bg-white px-2 py-0.5 text-[11px] font-semibold text-slate-700 ring-1 ring-slate-200"},xt={class:"text-[11px] text-slate-500"},ft={class:"text-[11px] text-slate-500"},bt={key:0,class:"mt-1 text-[11px] text-slate-500"},vt={class:"mt-4"},gt={class:"mt-1 flex items-center justify-between text-[11px] text-slate-400"},ht={class:"mt-4 flex items-center justify-end gap-2"},wt=["disabled"],kt={key:0},St={key:1},Ct={key:5,class:"fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/50 p-4"},$t={class:"w-full max-w-sm rounded-2xl bg-white p-4 shadow-xl"},Mt={class:"flex items-start justify-between gap-3"},Dt={class:"mt-4 space-y-2 text-sm text-slate-700"},Tt={class:"flex items-center justify-between"},qt={class:"font-semibold"},jt={class:"flex items-center justify-between"},Ft={class:"font-semibold"},It={class:"flex items-center justify-between"},Nt={class:"font-semibold"},Ut={class:"flex items-center justify-between"},Rt={class:"font-semibold"},Wt={class:"mt-4 flex items-center justify-end gap-2"},Gt={__name:"WeeklyUpdatesGrid",setup(E){const g=Te(),{loading:z,error:R,dates:$,rows:F,meta:_,params:l}=ke(g),x=Se(),M=Ce(),a=j({detailsOpen:!1,selectedItem:null,smsOpen:!1,smsMessage:"",smsTarget:null,busyKey:null,toast:null}),n=j({company_id:x.query.company_id||"",department_id:x.query.department_id||"all",line_type:x.query.line_type||"all",employee_id:x.query.employee_id||x.query.user_id||""}),D=(s,e,o)=>Math.min(Math.max(Number(s)||0,e),o),V=(s,e)=>{const o=Number(s);return Number.isFinite(o)?D(o,0,60):e};x.query.anchor_date&&(l.value.anchor_date=String(x.query.anchor_date)),x.query.past_days!=null&&(l.value.past_days=V(x.query.past_days,l.value.past_days)),x.query.future_days!=null&&(l.value.future_days=V(x.query.future_days,l.value.future_days));const G=s=>{if(s){const[e,o,m]=String(s).split("-").map(Number);if(e&&o&&m)return new Date(e,o-1,m)}return new Date},Q=(s,e)=>{const o=new Date(s);return o.setDate(o.getDate()+e),o},Y=s=>{const e=s.getFullYear(),o=String(s.getMonth()+1).padStart(2,"0"),m=String(s.getDate()).padStart(2,"0");return`${e}-${o}-${m}`},W=s=>{if(!s)return"";const e=new Date(`${s}T00:00:00`);return new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric"}).format(e)},v=s=>{if(!s)return"";const e=new Date(`${s}T00:00:00`);return new Intl.DateTimeFormat("en-US",{weekday:"short"}).format(e)},y=(s,e)=>{var o;return((o=s==null?void 0:s.days)==null?void 0:o[e])??[]},h=s=>{const e=String((s==null?void 0:s.status)??"").toLowerCase();return e.includes("pending")?"bg-amber-50 text-amber-700 ring-amber-200":e.includes("approved")?"bg-emerald-50 text-emerald-700 ring-emerald-200":e.includes("rejected")?"bg-rose-50 text-rose-700 ring-rose-200":"bg-slate-50 text-slate-700 ring-slate-200"},f=U(()=>{var e;const s=(e=a.value.toast)==null?void 0:e.type;return s==="success"?"border-emerald-200 bg-emerald-50 text-emerald-800":s==="error"?"border-rose-200 bg-rose-50 text-rose-800":"border-slate-200 bg-slate-50 text-slate-800"}),T=U(()=>{var e;return!!String(a.value.smsMessage||"").trim()&&!!((e=a.value.smsTarget)!=null&&e.item)&&!a.value.busyKey}),w=U(()=>{var s,e;return!((s=_.value)!=null&&s.start_date)||!((e=_.value)!=null&&e.end_date)?"":`${W(_.value.start_date)} - ${W(_.value.end_date)}`}),I=()=>{M.replace({query:{...x.query,company_id:n.value.company_id||void 0,department_id:n.value.department_id&&n.value.department_id!=="all"?n.value.department_id:void 0,line_type:n.value.line_type&&n.value.line_type!=="all"?n.value.line_type:void 0,employee_id:n.value.employee_id||void 0,anchor_date:l.value.anchor_date||void 0,past_days:l.value.past_days!=null?String(l.value.past_days):void 0,future_days:l.value.future_days!=null?String(l.value.future_days):void 0}}).catch(()=>{})},u=()=>{l.value.past_days=D(l.value.past_days,0,60),l.value.future_days=D(l.value.future_days,0,60),g.fetchWeekly({anchor_date:l.value.anchor_date,past_days:l.value.past_days,future_days:l.value.future_days,company_id:n.value.company_id||"",department_id:n.value.department_id||"all",line_type:n.value.line_type||"all",user_id:n.value.employee_id||"",window:null}),I()},xe=()=>{g.fetchWeekly({company_id:n.value.company_id||"",department_id:n.value.department_id||"all",line_type:n.value.line_type||"all",user_id:n.value.employee_id||"",anchor_date:l.value.anchor_date,past_days:l.value.past_days,future_days:l.value.future_days,window:null}),I()},J=s=>{var O;const e=D(l.value.past_days,0,60),o=D(l.value.future_days,0,60),m=e+o+1,b=G(l.value.anchor_date||((O=_.value)==null?void 0:O.anchor_date)),S=Q(b,s*m),q=Y(S);l.value.anchor_date=q,g.fetchWeekly({anchor_date:q,past_days:e,future_days:o,company_id:n.value.company_id||"",department_id:n.value.department_id||"all",line_type:n.value.line_type||"all",user_id:n.value.employee_id||"",window:null}),I()},fe=s=>{a.value.selectedItem=s,a.value.detailsOpen=!0};function N(s,e){a.value.toast={type:s,text:e},window.clearTimeout(N._t),N._t=window.setTimeout(()=>{a.value.toast=null},2500)}const X=s=>{const e=$.value||[];for(let o=e.length-1;o>=0;o--){const m=e[o],b=y(s,m);if(b!=null&&b.length)return b[b.length-1]}return null},be=s=>{const e=X(s);if(!e){N("info","No application found in this range.");return}a.value.smsTarget={item:e,user:(s==null?void 0:s.user)||null},a.value.smsMessage="",a.value.smsOpen=!0},H=()=>{a.value.smsOpen=!1,a.value.smsMessage="",a.value.smsTarget=null},ve=async(s,e="")=>{var m,b;if(!(s!=null&&s.kind)||!(s!=null&&s.ref_id))return;const o=`${s.kind}:${s.ref_id}`;a.value.busyKey=o;try{return await g.sendWeeklyMessage({kind:s.kind,ref_id:s.ref_id,status:s.status,message:e}),N("success",`SMS sent (${s.code||s.kind} #${s.ref_id})`),!0}catch(S){const q=((b=(m=S==null?void 0:S.response)==null?void 0:m.data)==null?void 0:b.message)||"Failed to send SMS.";return N("error",q),!1}finally{a.value.busyKey=null}},ge=async()=>{const s=a.value.smsTarget,e=s==null?void 0:s.item,o=String(a.value.smsMessage||"").trim();if(!e)return;if(!o){N("error","Please write a message before sending.");return}await ve(e,o)&&H()};return $e(()=>{g.fetchWeekly({company_id:n.value.company_id||"",department_id:n.value.department_id||"all",line_type:n.value.line_type||"all",user_id:n.value.employee_id||"",anchor_date:l.value.anchor_date,past_days:l.value.past_days,future_days:l.value.future_days,window:null})}),(s,e)=>{var o,m,b,S,q,O,Z,ee,te,se,ae,le,ne,oe,de,re,ie,ue,pe,ce;return i(),r("section",qe,[a.value.toast?(i(),r("div",{key:0,class:me(["fixed right-4 top-4 z-[80] rounded-xl border px-4 py-2 text-sm shadow-sm",f.value])},p(a.value.toast.text),3)):C("",!0),t("div",je,[Me(De,{company_id:n.value.company_id,"onUpdate:company_id":e[0]||(e[0]=d=>n.value.company_id=d),department_id:n.value.department_id,"onUpdate:department_id":e[1]||(e[1]=d=>n.value.department_id=d),employee_id:n.value.employee_id,"onUpdate:employee_id":e[2]||(e[2]=d=>n.value.employee_id=d),line_type:n.value.line_type,"onUpdate:line_type":e[3]||(e[3]=d=>n.value.line_type=d),"with-type":!0,"initial-value":{...s.$route.query,employee_id:s.$route.query.employee_id||s.$route.query.user_id},onFilterChange:xe,class:"w-full"},null,8,["company_id","department_id","employee_id","line_type","initial-value"])]),t("div",Fe,[t("div",Ie,[t("div",Ne,[t("button",{type:"button",class:"rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50",onClick:e[4]||(e[4]=d=>J(-1)),title:"Previous range"}," Prev "),t("div",Ue,[t("div",Re,[t("label",We,[e[12]||(e[12]=_e(" Past ")),A(t("input",{"onUpdate:modelValue":e[5]||(e[5]=d=>c(l).past_days=d),type:"number",min:"0",max:"60",class:"w-14 rounded-lg border border-slate-200 bg-white px-2 py-2 text-xs focus:border-slate-400 focus:outline-none"},null,512),[[L,c(l).past_days,void 0,{number:!0}]])]),t("label",Oe,[e[13]||(e[13]=_e(" Future ")),A(t("input",{"onUpdate:modelValue":e[6]||(e[6]=d=>c(l).future_days=d),type:"number",min:"0",max:"60",class:"w-14 rounded-lg border border-slate-200 bg-white px-2 py-2 text-xs focus:border-slate-400 focus:outline-none"},null,512),[[L,c(l).future_days,void 0,{number:!0}]])])])]),t("button",{type:"button",class:"rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50",onClick:e[7]||(e[7]=d=>J(1)),title:"Next range"}," Next "),t("label",Ee,[A(t("input",{"onUpdate:modelValue":e[8]||(e[8]=d=>c(l).anchor_date=d),type:"date",class:"rounded-lg border border-slate-200 px-2 py-2 text-xs focus:border-slate-400 focus:outline-none"},null,512),[[L,c(l).anchor_date]])]),t("button",{type:"button",class:"rounded-lg bg-slate-900 px-3 py-2 text-xs font-semibold text-white hover:bg-slate-800",onClick:u}," Apply ")]),t("div",ze,[t("div",null,[w.value?(i(),r("div",Ve,p(w.value),1)):C("",!0),((o=c(_))==null?void 0:o.past_days)!=null&&((m=c(_))==null?void 0:m.future_days)!=null?(i(),r("div",Ke," Past "+p(c(_).past_days)+" / Future "+p(c(_).future_days),1)):C("",!0)])])])]),c(R)?(i(),r("div",Ae,p(c(R)),1)):C("",!0),c(z)?(i(),r("div",Le," Loading weekly updates... ")):(i(),r("div",Pe,[t("div",Be,[t("table",Ge,[t("thead",Qe,[t("tr",null,[e[14]||(e[14]=t("th",{class:"sticky left-0 top-0 z-30 border-r border-slate-200 bg-slate-50 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide"}," Employee ",-1)),(i(!0),r(P,null,B(c($),d=>(i(),r("th",{key:d,class:"sticky top-0 z-20 min-w-[110px] bg-slate-50 px-3 py-3 text-left"},[t("div",Ye,p(v(d)),1),t("div",He,p(W(d)),1)]))),128)),e[15]||(e[15]=t("th",{class:"sticky top-0 z-20 bg-slate-50 px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide"}," SMS ",-1))])]),t("tbody",null,[(i(!0),r(P,null,B(c(F),d=>(i(),r("tr",{key:d.user.id,class:"border-t border-slate-300 hover:bg-slate-50/60"},[t("td",Je,[t("div",Xe,[t("div",Ze,p(d.user.name),1)])]),(i(!0),r(P,null,B(c($),K=>(i(),r("td",{key:`${d.user.id}-${K}`,class:"px-3 py-3 align-top"},[y(d,K).length?(i(),r("div",et,[(i(!0),r(P,null,B(y(d,K),k=>(i(),r("button",{key:`${k.kind}-${k.ref_id}-${k.code}`,type:"button",class:me(["rounded-full px-2 py-0.5 text-[11px] font-semibold ring-1 ring-inset",h(k)]),title:`${k.label} • ${k.status} • #${k.ref_id}`,onClick:Ot=>fe(k)},p(k.code),11,tt))),128))])):(i(),r("span",st,"—"))]))),128)),t("td",at,[t("button",{type:"button",class:"rounded-lg bg-slate-900 px-3 py-2 text-xs font-semibold text-white hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-50",disabled:!X(d)||!!a.value.busyKey,onClick:K=>be(d)},[a.value.busyKey?(i(),r("span",nt,"Sending...")):(i(),r("span",ot,"Send SMS"))],8,lt)])]))),128)),c(F).length?C("",!0):(i(),r("tr",dt,[t("td",{class:"bg-white px-4 py-8 text-slate-500",colspan:c($).length+2}," No updates found. ",8,rt)]))])])])])),a.value.smsOpen?(i(),r("div",it,[t("div",ut,[t("div",pt,[t("div",null,[e[16]||(e[16]=t("h3",{class:"text-sm font-semibold text-slate-900"},"Send SMS",-1)),t("p",ct,p(((S=(b=a.value.smsTarget)==null?void 0:b.user)==null?void 0:S.name)||"Employee"),1)]),t("button",{type:"button",class:"rounded-lg border border-slate-200 bg-white px-2 py-1 text-xs font-semibold text-slate-700 hover:bg-slate-50",onClick:H}," Close ")]),t("div",yt,[e[17]||(e[17]=t("div",{class:"font-semibold text-slate-700"},"Application",-1)),t("div",mt,[t("span",_t,p(((O=(q=a.value.smsTarget)==null?void 0:q.item)==null?void 0:O.code)||((ee=(Z=a.value.smsTarget)==null?void 0:Z.item)==null?void 0:ee.kind)||"N/A"),1),t("span",xt," #"+p(((se=(te=a.value.smsTarget)==null?void 0:te.item)==null?void 0:se.ref_id)||"N/A"),1),t("span",ft,p(((le=(ae=a.value.smsTarget)==null?void 0:ae.item)==null?void 0:le.status)||"Unknown"),1)]),(oe=(ne=a.value.smsTarget)==null?void 0:ne.item)!=null&&oe.label?(i(),r("div",bt,p((re=(de=a.value.smsTarget)==null?void 0:de.item)==null?void 0:re.label),1)):C("",!0)]),t("div",vt,[e[19]||(e[19]=t("label",{class:"text-xs font-semibold text-slate-600"},"Message",-1)),A(t("textarea",{"onUpdate:modelValue":e[9]||(e[9]=d=>a.value.smsMessage=d),rows:"4",class:"mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-slate-400 focus:outline-none",placeholder:"Write your SMS message..."},null,512),[[L,a.value.smsMessage]]),t("div",gt,[t("span",null,p((a.value.smsMessage||"").length)+" characters",1),e[18]||(e[18]=t("span",null,"Message will be sent to the employee.",-1))])]),t("div",ht,[t("button",{type:"button",class:"rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50",onClick:H}," Cancel "),t("button",{type:"button",class:"rounded-lg bg-slate-900 px-4 py-2 text-xs font-semibold text-white hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-60",disabled:!T.value,onClick:ge},[a.value.busyKey?(i(),r("span",kt,"Sending...")):(i(),r("span",St,"Send SMS"))],8,wt)])])])):C("",!0),a.value.detailsOpen?(i(),r("div",Ct,[t("div",$t,[t("div",Mt,[e[20]||(e[20]=t("div",null,[t("h3",{class:"text-sm font-semibold text-slate-900"},"Update Details"),t("p",{class:"text-xs text-slate-500"},"Quick view")],-1)),t("button",{type:"button",class:"rounded-lg border border-slate-200 bg-white px-2 py-1 text-xs font-semibold text-slate-700 hover:bg-slate-50",onClick:e[10]||(e[10]=d=>a.value.detailsOpen=!1)}," Close ")]),t("div",Dt,[t("div",Tt,[e[21]||(e[21]=t("span",{class:"text-xs font-semibold text-slate-500"},"Label",-1)),t("span",qt,p((ie=a.value.selectedItem)==null?void 0:ie.label),1)]),t("div",jt,[e[22]||(e[22]=t("span",{class:"text-xs font-semibold text-slate-500"},"Status",-1)),t("span",Ft,p((ue=a.value.selectedItem)==null?void 0:ue.status),1)]),t("div",It,[e[23]||(e[23]=t("span",{class:"text-xs font-semibold text-slate-500"},"Kind",-1)),t("span",Nt,p((pe=a.value.selectedItem)==null?void 0:pe.kind),1)]),t("div",Ut,[e[24]||(e[24]=t("span",{class:"text-xs font-semibold text-slate-500"},"Ref ID",-1)),t("span",Rt,"#"+p((ce=a.value.selectedItem)==null?void 0:ce.ref_id),1)])]),t("div",Wt,[t("button",{type:"button",class:"rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50",onClick:e[11]||(e[11]=d=>a.value.detailsOpen=!1)}," Done ")])])])):C("",!0)])}}};export{Gt as default};
