import{Q as Re,N as Q,s as Ve,r as N,m as X,b as Ae,A as Z,e as De,c as u,o as y,a as s,j as ee,t as p,h as L,B as Ie,k as M,F as T,y as V,p as Ke,g as te,x,S as oe,D as ne,w as ae}from"./index-C_Hd4Q4D.js";import{L as Ue}from"./LoaderView-DEBeE2xd.js";import{_ as Le}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Pe=Re("kpi-report",{state:()=>({meta:null,rows:[],isLoading:!1,error:null}),actions:{async fetchBiMonthly(B){var b,d;this.isLoading=!0,this.error=null;try{const{data:r}=await Q.get("/kpi/reports/bi-monthly",{params:B});return this.meta=(r==null?void 0:r.meta)??null,this.rows=Array.isArray(r==null?void 0:r.rows)?r.rows:Array.isArray(r==null?void 0:r.data)?r.data:[],{meta:this.meta,rows:this.rows}}catch(r){throw this.error=((d=(b=r==null?void 0:r.response)==null?void 0:b.data)==null?void 0:d.message)||"Failed to load report",r}finally{this.isLoading=!1}},async exportBiMonthly(B){try{const b=await Q.get("/kpi/reports/bi-monthly-export",{params:B,responseType:"blob"}),d=b.headers["content-disposition"]||"";let r="kpi_bi_monthly.xlsx";const C=/filename="?([^"]+)"?/i.exec(d);C&&C[1]&&(r=decodeURIComponent(C[1]));const A=new Blob([b.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),R=URL.createObjectURL(A),h=document.createElement("a");h.href=R,h.download=r,document.body.appendChild(h),h.click(),h.remove(),URL.revokeObjectURL(R)}catch(b){throw console.error(b),b}},async setReportCompletion(B){var b,d;try{const{form_id:r,department_id:C,completed:A}=B||{};if(!r)throw new Error("form_id is required");if(C==null)throw new Error("department_id is required");const{data:R}=await Q.patch(`/kpi/forms/${r}/report-completion`,{department_id:C,completed:!!A});return R}catch(r){const C=((d=(b=r==null?void 0:r.response)==null?void 0:b.data)==null?void 0:d.message)||(r==null?void 0:r.message)||"Failed to update report completion";throw console.error("setReportCompletion error:",r),new Error(C)}},async setTargetCompletion({form_id:B,department_id:b,completed:d}){const{data:r}=await Q.post(`/kpi/bi-monthly/forms/${B}/target-completion`,{department_id:b,completed:d});return r}}}),Ee={class:"space-y-4 px-4 print:px-0"},Fe={class:"hidden print:block mx-auto text-center mb-3"},ze={class:"text-sm text-gray-600"},Ye={class:"font-medium"},qe={class:"flex flex-wrap items-end gap-3 sticky top-0 z-10 bg-white/80 backdrop-blur print:hidden p-2 -mx-2 rounded-md border border-gray-100"},He={class:"flex items-center gap-2"},Je=["disabled"],We=["value"],Ge={key:0,class:"py-10 text-center"},Qe={key:1,class:"rounded-md border border-red-200 bg-red-50 p-3 text-red-700",role:"alert","aria-live":"polite"},Xe={key:2,class:"space-y-3 md:hidden"},Ze={class:"flex items-center justify-between"},et=["title"],tt={class:"text-xs text-gray-500"},ot={class:"mt-2 grid grid-cols-1 gap-2"},nt={class:"flex items-center justify-between"},at={class:"text-[13px] font-semibold text-gray-800"},st={class:"flex items-center gap-3"},rt={class:"inline-flex items-center gap-1.5"},lt=["aria-label","disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange"],it={class:"inline-flex items-center gap-1.5"},dt=["aria-label","disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange"],ct={class:"mt-2 grid grid-cols-2 gap-2 text-center"},ut={key:0,class:"mt-1 text-[10px] text-gray-500 text-center"},yt={key:0,class:"px-3 py-6 text-center text-gray-600"},mt={class:"hidden md:block overflow-x-auto rounded-xl border bg-white shadow-sm"},pt={class:"min-w-[900px] w-full text-sm"},bt={class:"text-gray-800 sticky top-0 z-[5]"},ft={class:"bg-gray-100/95 backdrop-blur"},vt={rowspan:"2",class:"sticky z-[6] border-y border-r bg-gray-100/95 px-2 py-2 text-left",style:{left:"2rem",minWidth:"12.5rem",width:"12.5rem"}},ht={class:"whitespace-nowrap"},kt={class:"bg-gray-100/95 text-gray-700 whitespace-nowrap"},gt={class:"text-gray-800"},xt={class:"sticky left-0 z-[4] border-r bg-inherit px-2 text-center"},_t={class:"sticky z-[4] border bg-inherit px-2"},wt=["title"],Ct={class:"inline-flex items-center justify-center gap-2 cursor-pointer"},Nt=["aria-label","disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange"],$t={class:"inline-flex items-center justify-center gap-2 cursor-pointer"},St=["aria-label","disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange"],Mt={key:0,class:"mt-1 text-[10px] text-gray-500 text-center"},Ot={key:0},jt=1500,Tt={__name:"KpiBiMonthlyReport",setup(B){const b=Pe(),{meta:d,rows:r,isLoading:C,error:A}=Ve(b),R=new Date().getFullYear(),h=N(R),D=N([]),le=N("department"),P=N(""),E=N(""),F=N("any"),k=X(()=>{var e;return((e=d.value)==null?void 0:e.periods)||[]}),ie=X(()=>{var e;return((e=d.value)==null?void 0:e.available_years)||null}),de=X(()=>{const e=Object.create(null);for(const o of k.value)e[o.key]=o;return e}),_e=Ae(),we=["feb_mar","jun_jul","nov"],Ce=X(()=>{var a;const e=_e.query.hl;if(e)return new Set(String(e).split(",").map(t=>t.trim()).filter(Boolean));const o=(a=d.value)==null?void 0:a.highlight_period_keys;return Array.isArray(o)&&o.length?new Set(o):new Set(we)}),se=e=>Ce.value.has(e.key),O=e=>se(e)?"bg-amber-50":"bg-white",I=e=>se(e)?"border-amber-300":"border-gray-200",Ne=R;function $e(e=2018,o=Ne+1){const a=[];for(let l=o;l>=e;l--)a.push(l);const t=Number(h.value);a.includes(t)||a.unshift(t),D.value=Array.from(new Set(a))}function ce(e){Array.isArray(e)&&e.length?(D.value=[...new Set(e.map(Number))].sort((o,a)=>a-o),D.value.includes(Number(h.value))||(h.value=D.value[0])):$e()}Z(ie,ce,{immediate:!0}),Z(h,()=>{const e=Number(h.value);!Number.isInteger(e)||e<2e3||e>2100||ge()});const _=N(Object.create(null)),w=N(Object.create(null)),j=N(Object.create(null)),z=N(Object.create(null)),Y=N(Object.create(null)),re=N(Object.create(null)),m=(e,o)=>`${e}::${o}`;function q(e){var a;if(((a=d.value)==null?void 0:a.scope)!=="department")return null;const o=String((e==null?void 0:e.key)||"").match(/^dept:(\d+)$/);return o?Number(o[1]):null}function ue(e){const o=de.value[e];return o!=null&&o.form_id?Number(o.form_id):null}function ye(e){var o;return((o=de.value[e])==null?void 0:o.label)||e}function me(e){const o=re.value[e]||0;return Date.now()-o>=jt}function Se(){const e=Object.create(null);for(const o of r.value||[])for(const a of k.value){const t=m(o.key,a.key);e[t]=_.value[t]}z.value=e}function pe(){var a,t,l;const e=Object.create(null),o=Object.create(null);for(const n of k.value)o[n.key]=new Set((n.completed_departments||[]).map(Number));for(const n of r.value||[]){const c=q(n);for(const i of k.value){let f=!1;if(c&&o[i.key].has(c))f=!0;else{const v=(a=n.cells)==null?void 0:a[i.key],g=Number((v==null?void 0:v.assigned)??0),$=Number(((t=v==null?void 0:v.incharge)==null?void 0:t.done)??0),S=Number(((l=v==null?void 0:v.coordinator)==null?void 0:l.done)??0);f=F.value==="both"?g>0&&$>=g&&S>=g:g>0&&($>=g||S>=g)}e[m(n.key,i.key)]=f}}_.value=e,Se()}function H(e,o){const a=m(e.key,o.key);z.value[a]=_.value[a]}async function be(e,o){var $,S,xe;const a=m(e.key,o.key),t=!!_.value[a],l=!!z.value[a],n=`${(e==null?void 0:e.name)??""} • ${ye(o.key)}`,c=t?"mark as Completed":"mark as Pending";if(!window.confirm(`Confirm
${n}

Do you want to ${c}?`)){_.value[a]=l;return}if(j.value[a]){_.value[a]=l,window.alert("Already updating…");return}if(!me(a)){_.value[a]=l,window.alert("Just updated. Try again shortly.");return}const f=ue(o.key),v=q(e),g=!!((S=($=e==null?void 0:e.cells)==null?void 0:$[o.key])!=null&&S.form_id&&f);if(((xe=d.value)==null?void 0:xe.scope)!=="department"||!v||!g){_.value[a]=l,window.alert("This period is not assignable (no form).");return}j.value[a]=!0;try{await b.setReportCompletion({form_id:f,department_id:v,completed:t}),re.value[a]=Date.now(),z.value[a]=t;const K=k.value.findIndex(U=>U.key===o.key);if(K>=0){const U=new Set((d.value.periods[K].completed_departments||[]).map(Number));t?U.add(v):U.delete(v),d.value.periods[K].completed_departments=Array.from(U)}}catch(K){_.value[a]=l,console.error(K),window.alert("Failed to update.")}finally{j.value[a]=!1}}function Me(){const e=Object.create(null);for(const o of r.value||[])for(const a of k.value){const t=m(o.key,a.key);e[t]=w.value[t]}Y.value=e}function fe(){var a,t;const e=Object.create(null),o=Object.create(null);for(const l of k.value)o[l.key]=new Set((l.target_completed_departments||[]).map(Number));for(const l of r.value||[]){const n=q(l);for(const c of k.value){let i=!1;if(n&&o[c.key].has(n))i=!0;else{const f=(t=(a=l==null?void 0:l.cells)==null?void 0:a[c.key])==null?void 0:t.monthly_target,v=Number((f==null?void 0:f.have)??0),g=Number((f==null?void 0:f.of)??0);i=g>0&&v>=g}e[m(l.key,c.key)]=i}}w.value=e,Me()}function J(e,o){const a=m(e.key,o.key);Y.value[a]=w.value[a]}async function ve(e,o){var g;const a=m(e.key,o.key),t=!!w.value[a],l=!!Y.value[a],n=`${(e==null?void 0:e.name)??""} • ${ye(o.key)}`,c=t?"mark Target as Completed":"mark Target as Pending";if(!window.confirm(`Confirm
${n}

Do you want to ${c}?`)){w.value[a]=l;return}if(j.value[a]){w.value[a]=l,window.alert("Already updating…");return}if(!me(a)){w.value[a]=l,window.alert("Just updated. Try again shortly.");return}const f=q(e);if(((g=d.value)==null?void 0:g.scope)!=="department"||!f){w.value[a]=l,window.alert("Not assignable.");return}const v=ue(o.key);j.value[a]=!0;try{await b.setTargetCompletion({period_key:o.key,form_id:v||void 0,department_id:f,completed:t}),re.value[a]=Date.now(),Y.value[a]=t;const $=k.value.findIndex(S=>S.key===o.key);if($>=0){const S=new Set((d.value.periods[$].target_completed_departments||[]).map(Number));t?S.add(f):S.delete(f),d.value.periods[$].target_completed_departments=Array.from(S)}}catch($){w.value[a]=l,console.error($),window.alert("Failed to update.")}finally{j.value[a]=!1}}const he=(e,o)=>{var a,t,l;return!!((t=(a=e==null?void 0:e.cells)==null?void 0:a[o])!=null&&t.form_id)&&((l=d.value)==null?void 0:l.scope)==="department"},ke=(e,o)=>{var t,l,n,c,i;if(((t=d.value)==null?void 0:t.scope)!=="department")return!1;const a=(n=(l=e==null?void 0:e.cells)==null?void 0:l[o])==null?void 0:n.monthly_target;return Number((a==null?void 0:a.of)??0)>0||!!((i=(c=e==null?void 0:e.cells)==null?void 0:c[o])!=null&&i.form_id)},Oe=e=>e?"✓":"—";function W(e,o,a){var n,c;const t=Number((e==null?void 0:e.assigned)??0),l=Number(a==="ic"?((n=e==null?void 0:e.incharge)==null?void 0:n.done)??0:((c=e==null?void 0:e.coordinator)==null?void 0:c.done)??0);if(t===0&&l===0){const i=a==="ic"?e==null?void 0:e.incharge:e==null?void 0:e.coordinator;if(typeof i=="boolean")return Oe(i)}return`${l}/${o}`}function G(e,o){var l,n;const a=Number((e==null?void 0:e.assigned)??0),t=Number(o==="ic"?((l=e==null?void 0:e.incharge)==null?void 0:l.done)??0:((n=e==null?void 0:e.coordinator)==null?void 0:n.done)??0);return a===0?"bg-gray-50 text-gray-600":t>=a?"bg-emerald-50 text-emerald-700":"bg-rose-50 text-rose-700"}function je(){window.print()}function Te(){return new Date().toLocaleString()}async function ge(){try{await b.fetchBiMonthly({year:Number(h.value),scope:le.value,department_id:P.value?Number(P.value):void 0,form_id:E.value?Number(E.value):void 0,rule:F.value})}catch(e){console.error("fetchBiMonthly failed:",e)}finally{pe(),fe()}}async function Be(){try{await b.exportBiMonthly({year:Number(h.value),scope:le.value,department_id:P.value?Number(P.value):void 0,form_id:E.value?Number(E.value):void 0,rule:F.value})}catch(e){console.error("exportBiMonthly failed:",e),window.alert("Export failed. Please try again.")}}return Z([r,k,F],pe),Z([r,k],fe),De(()=>{ce(ie.value),ge()}),(e,o)=>{var a;return y(),u("div",Ee,[s("div",Fe,[o[3]||(o[3]=s("h1",{class:"text-xl font-semibold text-gray-900"},"Bi-Monthly KPI Report",-1)),s("div",ze,[o[1]||(o[1]=ee(" Year: ")),s("span",Ye,p(h.value),1),o[2]||(o[2]=ee(" • Generated: ")),s("span",null,p(Te()),1)])]),s("div",qe,[s("div",He,[o[4]||(o[4]=s("label",{class:"text-xs font-medium text-gray-600"},"Year",-1)),L(s("select",{"onUpdate:modelValue":o[0]||(o[0]=t=>h.value=t),class:"w-32 rounded border border-gray-300 bg-white px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400/50 disabled:opacity-60",disabled:M(C),"aria-label":"Select year"},[(y(!0),u(T,null,V(D.value,t=>(y(),u("option",{key:t,value:t},p(t),9,We))),128))],8,Je),[[Ie,h.value,void 0,{number:!0}]])]),s("div",{class:"ml-auto flex gap-2"},[s("button",{class:"btn-3 !py-1.5 !px-3",onClick:Be},o[5]||(o[5]=[s("i",{class:"far fa-file-excel mr-1"},null,-1),ee(" Excel ")])),s("button",{class:"btn-3 !py-1.5 !px-3",onClick:je},o[6]||(o[6]=[s("i",{class:"far fa-print mr-1"},null,-1),ee(" Print ")]))])]),M(C)?(y(),u("div",Ge,[Ke(Ue)])):M(A)?(y(),u("div",Qe,p(M(A)),1)):(y(),u("div",Xe,[(y(!0),u(T,null,V(M(r),(t,l)=>(y(),u("div",{key:"card-"+t.key,class:"rounded-xl border border-gray-200 bg-white shadow-sm p-3 break-inside-avoid"},[s("div",Ze,[s("div",{class:"text-sm font-medium text-gray-900 truncate",title:t.name},p(l+1)+". "+p(t.name),9,et),s("div",tt,"Total: "+p(t.employees_total),1)]),s("div",ot,[(y(!0),u(T,null,V(k.value,n=>{var c;return y(),u("div",{key:n.key,class:x(["rounded-lg border p-2",[O(n),se(n)?"border-amber-300":"border-gray-200"]])},[s("div",nt,[s("div",at,p(n.label),1),s("div",st,[s("label",rt,[L(s("input",{type:"checkbox",class:"h-4 w-4 accent-emerald-500","aria-label":`Report • ${t.name} • ${n.label}`,disabled:!he(t,n.key)||j.value[m(t.key,n.key)],"onUpdate:modelValue":i=>_.value[m(t.key,n.key)]=i,onMousedown:i=>H(t,n),onKeydown:ne(ae(i=>H(t,n),["prevent"]),["enter"]),onChange:i=>be(t,n)},null,40,lt),[[oe,_.value[m(t.key,n.key)]]]),o[7]||(o[7]=s("span",{class:"text-[11px] text-gray-700"},"Report",-1))]),s("label",it,[L(s("input",{type:"checkbox",class:"h-4 w-4 accent-sky-500","aria-label":`Target • ${t.name} • ${n.label}`,disabled:!ke(t,n.key)||j.value[m(t.key,n.key)],"onUpdate:modelValue":i=>w.value[m(t.key,n.key)]=i,onMousedown:i=>J(t,n),onKeydown:ne(ae(i=>J(t,n),["prevent"]),["enter"]),onChange:i=>ve(t,n)},null,40,dt),[[oe,w.value[m(t.key,n.key)]]]),o[8]||(o[8]=s("span",{class:"text-[11px] text-gray-700"},"Target",-1))])])]),s("div",ct,[s("div",{class:x(["rounded px-2 py-1 text-[12px]",G(t.cells[n.key],"ic")])}," Inch: "+p(W(t.cells[n.key],t.employees_total,"ic")),3),s("div",{class:x(["rounded px-2 py-1 text-[12px]",G(t.cells[n.key],"co")])}," Coord: "+p(W(t.cells[n.key],t.employees_total,"co")),3)]),(c=t.cells[n.key])!=null&&c.max_total?(y(),u("div",ut,p(t.cells[n.key].final_total)+" / "+p(t.cells[n.key].max_total),1)):te("",!0)],2)}),128))])]))),128)),!M(r)||M(r).length===0?(y(),u("div",yt,"No data")):te("",!0)])),s("div",mt,[s("table",pt,[s("thead",bt,[s("tr",ft,[o[9]||(o[9]=s("th",{rowspan:"2",class:"sticky left-0 z-[6] border-y border-r bg-gray-100/95 px-2 py-2 text-center",style:{"min-width":"2.25rem",width:"2.25rem"}},"SL",-1)),s("th",vt,p(((a=M(d))==null?void 0:a.scope)==="user"?"Employee":"Department"),1),(y(!0),u(T,null,V(k.value,t=>(y(),u("th",{key:t.key,colspan:"4",class:x(["border-y px-2 py-2 text-center font-semibold border-x-2 text-red-500 print:text-black",[O(t),I(t)]])},[s("span",ht,p(t.label),1)],2))),128))]),s("tr",kt,[(y(!0),u(T,null,V(k.value,t=>(y(),u(T,{key:t.key+"-sub"},[s("th",{class:x(["border-y py-1 text-center text-[11px] w-8 border-r",O(t)])},"Report",2),s("th",{class:x(["border-y py-1 text-center text-[11px] w-8 border-r",[O(t),I(t)]])},"Target",2),s("th",{class:x(["border-y py-1 text-center text-[11px] w-8 border-r",O(t)])},"Inch.",2),s("th",{class:x(["border-y py-1 text-center text-[11px] border-r-2 w-8",[O(t),I(t)]])},"Coord.",2)],64))),128))])]),s("tbody",gt,[(y(!0),u(T,null,V(M(r),(t,l)=>(y(),u("tr",{key:t.key,class:"border-t odd:bg-gray-50 hover:bg-sky-50/40 transition-colors break-inside-avoid"},[s("td",xt,p(l+1),1),s("td",_t,[s("div",{class:"truncate w-48",title:t.name},p(t.name),9,wt)]),(y(!0),u(T,null,V(k.value,n=>{var c;return y(),u(T,{key:n.key},[s("td",{class:x(["border-r text-center",O(n)])},[s("label",Ct,[L(s("input",{type:"checkbox",class:"h-4 w-4 accent-emerald-500","aria-label":`Report • ${t.name} • ${n.label}`,disabled:!he(t,n.key)||j.value[m(t.key,n.key)],"onUpdate:modelValue":i=>_.value[m(t.key,n.key)]=i,onMousedown:i=>H(t,n),onKeydown:ne(ae(i=>H(t,n),["prevent"]),["enter"]),onChange:i=>be(t,n)},null,40,Nt),[[oe,_.value[m(t.key,n.key)]]])])],2),s("td",{class:x(["text-center border-r",[O(n),I(n)]])},[s("label",$t,[L(s("input",{type:"checkbox",class:"h-4 w-4 accent-sky-500","aria-label":`Target • ${t.name} • ${n.label}`,disabled:!ke(t,n.key)||j.value[m(t.key,n.key)],"onUpdate:modelValue":i=>w.value[m(t.key,n.key)]=i,onMousedown:i=>J(t,n),onKeydown:ne(ae(i=>J(t,n),["prevent"]),["enter"]),onChange:i=>ve(t,n)},null,40,St),[[oe,w.value[m(t.key,n.key)]]])])],2),s("td",{class:x(["border-r text-center",O(n)])},[s("span",{class:x(["inline-block rounded py-0.5 font-mono text-[12px]",G(t.cells[n.key],"ic")])},p(W(t.cells[n.key],t.employees_total,"ic")),3)],2),s("td",{class:x(["border-y text-center border-r-2",[O(n),I(n)]])},[s("span",{class:x(["inline-block rounded py-0.5 font-mono text-[12px]",G(t.cells[n.key],"co")])},p(W(t.cells[n.key],t.employees_total,"co")),3),(c=t.cells[n.key])!=null&&c.max_total?(y(),u("div",Mt,p(t.cells[n.key].final_total)+" / "+p(t.cells[n.key].max_total),1)):te("",!0)],2)],64)}),128))]))),128)),!M(r)||M(r).length===0?(y(),u("tr",Ot,o[10]||(o[10]=[s("td",{colspan:"100",class:"px-3 py-6 text-center text-gray-600"},"No data",-1)]))):te("",!0)])])])])}}},At=Le(Tt,[["__scopeId","data-v-c8afbfe6"]]);export{At as default};
