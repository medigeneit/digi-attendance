import{b as Q,u as W,r as m,m as X,A as ee,e as te,c as n,o as d,a as e,g as A,t as b,h as r,v as i,j as L,F as V,y as U,B as se}from"./index-D_dgf00N.js";import{u as le}from"./kpiCycleAdmin-BIMZInC6.js";const oe={class:"max-w-6xl mx-auto p-4 space-y-5"},ae={class:"flex items-center justify-between"},ne={class:"flex items-center gap-3"},de={class:"text-xl font-semibold"},re={class:"grid md:grid-cols-3 gap-3"},ie={class:"rounded-xl border card-bg p-3"},ue={class:"space-y-2"},ce={class:"text-xs text-slate-600"},pe={class:"rounded-xl border card-bg p-3 md:col-span-2"},me={class:"grid md:grid-cols-3 gap-2"},be={class:"text-xs text-slate-600 mb-1 capitalize"},xe={class:"flex items-center gap-1"},ve=["onUpdate:modelValue"],ye=["onUpdate:modelValue"],_e={class:"rounded-xl border card-bg p-3"},fe={class:"overflow-auto"},he={class:"w-full text-sm min-w-[760px]"},ke={class:"px-2 py-1"},ge=["onClick"],we=["onClick"],Ce={class:"px-2 py-1"},Ve=["onUpdate:modelValue"],Ue={class:"px-2 py-1"},$e=["onUpdate:modelValue"],Ie={class:"px-2 py-1"},De=["onUpdate:modelValue","onChange"],Ae={class:"px-2 py-1"},Le=["onUpdate:modelValue"],Ge=["onUpdate:modelValue"],je={class:"px-2 py-1"},Me=["onClick"],Se={class:"rounded-xl border p-3"},Te={class:"space-y-4 mt-3"},Ne={class:"flex items-center justify-between bg-slate-50 px-3 py-2"},Ee={class:"font-medium"},Ke={class:"flex items-center gap-2"},Pe=["onClick"],Fe=["onClick"],Re=["onClick"],ze={class:"p-3 overflow-auto"},Be={class:"w-full text-sm min-w-[720px]"},Oe={class:"px-2 py-1"},qe={class:"px-2 py-1"},He=["onUpdate:modelValue"],Ye={class:"px-2 py-1"},Ze=["onUpdate:modelValue"],Je={class:"px-2 py-1"},Qe=["onUpdate:modelValue"],We={class:"px-2 py-1"},Xe=["onClick"],et=["onClick"],tt=["onClick"],st={class:"mt-2"},lt=["onClick"],ot={class:"text-xs text-slate-600 ml-3"},at={class:"flex items-center justify-between mt-3"},nt={class:"text-sm text-slate-700"},dt={key:0,class:"fixed inset-0 z-50"},rt={class:"absolute left-1/2 top-1/2 w-[92vw] max-w-md -translate-x-1/2 -translate-y-1/2 rounded-2xl border bg-white shadow-xl",role:"dialog","aria-modal":"true","aria-labelledby":"addGroupTitle"},it={class:"p-4 space-y-3"},ut={key:0,class:"mt-1 text-xs text-red-600"},ct={key:0,class:"mt-1 text-xs text-red-600"},xt={__name:"CycleFormPage",setup(pt){const G=Q();W();const k=le(),_=m(G.params.id?Number(G.params.id):null),g=m("KPI 2025"),w=m(new Date().getFullYear()),p=m([{id:"personal",label:"Personal Attributes (25)",items:[{id:"attitude",label:"ব্যক্তিত্ব ও আচরণ",max:2.5},{id:"punctual",label:"সময়নিষ্ঠতা",max:2.5},{id:"teamwork",label:"সহযোগিতা ও আচরণ",max:5},{id:"discipline",label:"শৃঙ্খলা",max:5},{id:"communication",label:"কমিউনিকেশন",max:5},{id:"ethics",label:"নৈতিকতা",max:5}]},{id:"training",label:"Training (15)",items:[{id:"tech_training",label:"প্রযুক্তিগত প্রশিক্ষণ",max:5},{id:"cert",label:"সার্টিফিকেশন/সেমিনার",max:5},{id:"onjob",label:"অন জব লার্নিং",max:5}]},{id:"performance",label:"কাজের কার্যসম্পাদন (25)",items:[{id:"quality",label:"কাজের মান",max:10},{id:"planning",label:"পরিকল্পনা/ম্যানেজমেন্ট",max:7},{id:"report",label:"রিপোর্টিং/ডকুমেন্টেশন",max:8}]},{id:"target",label:"Monthly Target (25)",items:[{id:"target",label:"টার্গেট এচিভমেন্ট",max:25}]}]),u=m([{key:"incharge",label:"Incharge",rank:10,source:{type:"department_field",field:"incharge_id"}},{key:"op_admin",label:"Op. Admin",rank:20,source:{type:"department_field",field:"operational_admin_user_id"}},{key:"hr",label:"HR",rank:25,source:{type:"manual",permission:"kpi.review.lane.hr"}},{key:"coordinator",label:"Coordinator / AD / DD",rank:30,source:{type:"department_field",field:"coordinator_id"}},{key:"cc",label:"CC",rank:40,source:{type:"department_field",field:"recommend_by_user_id"}},{key:"supv_director",label:"Supv. Director",rank:50,source:{type:"department_field",field:"approved_by_user_id"}},{key:"da",label:"DA",rank:60,source:{type:"manual",permission:"kpi.da"}}]),f=m({excellent:[91,100],good:[81,90],satisfactory:[71,80],average:[51,70],below:[0,50]}),j=X(()=>{let t=0;return p.value.forEach(s=>s.items.forEach(l=>t+=Number(l.max||0))),Number(t.toFixed(2))});function h(t,s,l){const o=s+l;o<0||o>=t.length||([t[s],t[o]]=[t[o],t[s]])}const $=m(!1),x=m({id:"",label:""}),I=m(!1),v=m({id:"",label:""});function N(t){return String(t||"").trim().toLowerCase().replace(/[^\w]+/g,"_").replace(/^_+|_+$/g,"").slice(0,40)||`group_${p.value.length+1}`}ee(()=>x.value.label,t=>{I.value||(x.value.id=N(t))});function E(){I.value=!0}function K(){v.value={id:"",label:""};const{id:t,label:s}=x.value;let l=!0;return(!s||!s.trim())&&(v.value.label="Label is required",l=!1),(!t||!/^[A-Za-z0-9_]+$/.test(t))&&(v.value.id="ID must be letters/numbers/underscore only",l=!1),p.value.some(o=>o.id===t)&&(v.value.id="This ID already exists",l=!1),l}function P(){$.value=!0,x.value={id:"",label:""},I.value=!1,v.value={id:"",label:""}}function C(){$.value=!1}function F(){if(!K())return;const{id:t,label:s}=x.value;p.value.push({id:t,label:s,items:[]}),C()}function R(t){t.items.push({id:"item_"+(t.items.length+1),label:"New Item",max:1})}function z(t){p.value.splice(t,1)}function B(t,s){t.items.splice(s,1)}const D={incharge:"incharge_id",op_admin:"operational_admin_user_id",coordinator:"coordinator_id",cc:"recommend_by_user_id",supv_director:"approved_by_user_id",hr:"approved_by_user_id"};function M(t,s=0){var y,c,T;const l=t.key||`lane_${s+1}`,o=((y=t.source)==null?void 0:y.type)||"manual",a={key:l,label:t.label||l,rank:t.rank??(s+1)*10,source:{type:o}};return o==="department_field"?a.source.field=((c=t.source)==null?void 0:c.field)||D[l]||"":a.source.permission=((T=t.source)==null?void 0:T.permission)||`kpi.review.lane.${l}`,a}function O(){u.value.push({key:"",label:"New Lane",rank:(u.value.length+1)*10,source:{type:"manual",permission:""}})}function q(t){u.value.splice(t,1)}function H(t){t.source||(t.source={type:"manual"}),t.source.type==="department_field"?("field"in t.source||(t.source.field=D[t.key]||""),delete t.source.permission):("permission"in t.source||(t.source.permission=`kpi.review.lane.${t.key||"new"}`),delete t.source.field)}function Y(t){const s=new Set;for(const l of t){if(!l.key||!/^[A-Za-z0-9_]+$/.test(l.key))throw new Error(`Invalid lane key "${l.key||"(empty)"}". Use letters/numbers/underscore only.`);if(s.has(l.key))throw new Error(`Duplicate lane key "${l.key}".`);s.add(l.key)}}te(async()=>{if(_.value){const t=await k.load(_.value);g.value=t.title,w.value=t.year,p.value=t.groups_json||[],u.value=(t.reviewer_lanes_json||[]).map((s,l)=>M(s,l)),f.value=t.grading_json||f.value}else u.value=u.value.map((t,s)=>M(t,s))});function Z(t){return t.map((s,l)=>{const o={...s,rank:s.rank??(l+1)*10,source:{...s.source||{}}};if(o.source.type==="department_field"){if(o.source.field=o.source.field||D[o.key]||"",!o.source.field)throw new Error(`Missing department field for lane '${o.key}'. Please set source.field.`);delete o.source.permission}else o.source.permission=o.source.permission||`kpi.review.lane.${o.key}`,delete o.source.field;return o})}async function S(){try{Y(u.value);const t={title:g.value,year:w.value,groups:p.value,lanes:Z(u.value),grading:f.value};_.value?await k.update(_.value,t):_.value=(await k.create(t)).id,alert("Saved!")}catch(t){console.error(t),alert((t==null?void 0:t.message)||"Failed to save")}}async function J(){if(!_.value){alert("Save first");return}await k.activate(_.value),alert("Activated!")}return(t,s)=>(d(),n("div",oe,[e("header",ae,[e("div",ne,[e("button",{class:"px-3 py-1.5 rounded-lg border",onClick:s[0]||(s[0]=l=>t.$router.push({name:"KpiCycles"}))},"← Back"),e("h1",de,b(_.value?"Edit KPI Cycle":"Create KPI Cycle"),1)]),e("div",{class:"flex gap-2"},[e("button",{onClick:S,class:"btn-2"},"Save Draft"),e("button",{onClick:J,class:"btn-1"},"Activate")])]),e("div",re,[e("div",ie,[s[6]||(s[6]=e("div",{class:"text-sm font-medium mb-2"},"Basic",-1)),e("div",ue,[r(e("input",{"onUpdate:modelValue":s[1]||(s[1]=l=>g.value=l),class:"border rounded-lg px-3 py-2 w-full",placeholder:"Title e.g., KPI 2025"},null,512),[[i,g.value]]),r(e("input",{"onUpdate:modelValue":s[2]||(s[2]=l=>w.value=l),type:"number",class:"border rounded-lg px-3 py-2 w-full",placeholder:"Year"},null,512),[[i,w.value]]),e("div",ce,[s[5]||(s[5]=L("Total Max: ")),e("b",null,b(j.value),1)])])]),e("div",pe,[s[8]||(s[8]=e("div",{class:"text-sm font-medium mb-2"},"Grading (0–100)",-1)),e("div",me,[(d(!0),n(V,null,U(f.value,(l,o)=>(d(),n("div",{key:o,class:"border rounded-lg p-2"},[e("div",be,b(o),1),e("div",xe,[r(e("input",{type:"number","onUpdate:modelValue":a=>f.value[o][0]=a,class:"border rounded px-2 py-1 w-20 text-right"},null,8,ve),[[i,f.value[o][0],void 0,{number:!0}]]),s[7]||(s[7]=e("span",null,"–",-1)),r(e("input",{type:"number","onUpdate:modelValue":a=>f.value[o][1]=a,class:"border rounded px-2 py-1 w-20 text-right"},null,8,ye),[[i,f.value[o][1],void 0,{number:!0}]])])]))),128))])])]),e("div",_e,[e("div",{class:"flex items-center justify-between mb-2"},[s[9]||(s[9]=e("div",{class:"text-sm font-medium"},"Reviewer Lanes & Hierarchy",-1)),e("button",{class:"btn-2",onClick:O},"Add Lane")]),e("div",fe,[e("table",he,[s[11]||(s[11]=e("thead",{class:"bg-slate-50"},[e("tr",null,[e("th",{class:"text-left px-2 py-1"},"Order"),e("th",{class:"text-left px-2 py-1"},"Key"),e("th",{class:"text-left px-2 py-1"},"Label"),e("th",{class:"text-left px-2 py-1"},"Source"),e("th",{class:"text-left px-2 py-1"},"Field / Permission"),e("th",{class:"text-left px-2 py-1"})])],-1)),e("tbody",null,[(d(!0),n(V,null,U(u.value,(l,o)=>(d(),n("tr",{key:o,class:"border-t"},[e("td",ke,[e("button",{class:"border rounded px-2 text-xs mr-1",onClick:a=>h(u.value,o,-1)},"↑",8,ge),e("button",{class:"border rounded px-2 text-xs",onClick:a=>h(u.value,o,1)},"↓",8,we)]),e("td",Ce,[r(e("input",{"onUpdate:modelValue":a=>l.key=a,class:"border rounded px-2 py-1 w-32"},null,8,Ve),[[i,l.key]])]),e("td",Ue,[r(e("input",{"onUpdate:modelValue":a=>l.label=a,class:"border rounded px-2 py-1 w-56"},null,8,$e),[[i,l.label]])]),e("td",Ie,[r(e("select",{"onUpdate:modelValue":a=>l.source.type=a,class:"border rounded px-2 py-1",onChange:a=>H(l)},s[10]||(s[10]=[e("option",{value:"department_field"},"department_field",-1),e("option",{value:"manual"},"manual",-1)]),40,De),[[se,l.source.type]])]),e("td",Ae,[l.source.type==="department_field"?r((d(),n("input",{key:0,"onUpdate:modelValue":a=>l.source.field=a,class:"border rounded px-2 py-1 w-64",placeholder:"e.g., incharge_id"},null,8,Le)),[[i,l.source.field]]):r((d(),n("input",{key:1,"onUpdate:modelValue":a=>l.source.permission=a,class:"border rounded px-2 py-1 w-64",placeholder:"permission e.g., kpi.review.lane.hr"},null,8,Ge)),[[i,l.source.permission]])]),e("td",je,[e("button",{class:"border rounded px-2 text-xs",onClick:a=>q(o)},"Remove",8,Me)])]))),128))])])]),s[12]||(s[12]=e("div",{class:"text-xs text-slate-500 mt-2"},"Order (top→bottom) ই হল hierarchy rank।",-1))]),e("div",Se,[e("div",{class:"flex items-center justify-between"},[s[13]||(s[13]=e("div",{class:"text-sm font-medium"},"Groups & Items",-1)),e("button",{onClick:P,class:"btn-2"},"Add Group")]),e("div",Te,[(d(!0),n(V,null,U(p.value,(l,o)=>(d(),n("div",{key:l.id,class:"rounded-lg border card-bg"},[e("div",Ne,[e("div",Ee,b(o+1)+". "+b(l.label),1),e("div",Ke,[e("button",{class:"px-2 py-1 text-xs border rounded",onClick:a=>h(p.value,o,-1)},"↑",8,Pe),e("button",{class:"px-2 py-1 text-xs border rounded",onClick:a=>h(p.value,o,1)},"↓",8,Fe),e("button",{class:"px-2 py-1 text-xs border rounded",onClick:a=>z(o)},"Remove",8,Re)])]),e("div",ze,[e("table",Be,[s[14]||(s[14]=e("thead",null,[e("tr",{class:"text-left bg-slate-50"},[e("th",{class:"px-2 py-1 w-14"},"SL"),e("th",{class:"px-2 py-1"},"Item ID"),e("th",{class:"px-2 py-1"},"Label"),e("th",{class:"px-2 py-1 w-24"},"Max"),e("th",{class:"px-2 py-1 w-40"})])],-1)),e("tbody",null,[(d(!0),n(V,null,U(l.items,(a,y)=>(d(),n("tr",{key:a.id,class:"border-t bg-white"},[e("td",Oe,b(y+1),1),e("td",qe,[r(e("input",{"onUpdate:modelValue":c=>a.id=c,class:"border rounded px-2 py-1 w-40"},null,8,He),[[i,a.id]])]),e("td",Ye,[r(e("input",{"onUpdate:modelValue":c=>a.label=c,class:"border rounded px-2 py-1 w-full"},null,8,Ze),[[i,a.label]])]),e("td",Je,[r(e("input",{"onUpdate:modelValue":c=>a.max=c,type:"number",min:"0",step:"0.5",class:"border rounded px-2 py-1 w-24 text-right"},null,8,Qe),[[i,a.max,void 0,{number:!0}]])]),e("td",We,[e("button",{class:"px-2 py-1 text-xs border rounded mr-1",onClick:c=>h(l.items,y,-1)},"↑",8,Xe),e("button",{class:"px-2 py-1 text-xs border rounded mr-1",onClick:c=>h(l.items,y,1)},"↓",8,et),e("button",{class:"px-2 py-1 text-xs border rounded",onClick:c=>B(l,y)},"Remove",8,tt)])]))),128))])]),e("div",st,[e("button",{onClick:a=>R(l),class:"btn-2"},"Add Item",8,lt),e("span",ot,"Group total: "+b(l.items.reduce((a,y)=>a+Number(y.max||0),0)),1)])])]))),128))]),e("div",at,[e("div",nt,[s[15]||(s[15]=L("Overall Total Max: ")),e("b",null,b(j.value),1)]),e("button",{onClick:S,class:"btn-2"},"Save Draft")])]),$.value?(d(),n("div",dt,[e("div",{class:"absolute inset-0 bg-black/40",onClick:C}),e("div",rt,[e("div",{class:"px-4 py-3 border-b flex items-center justify-between"},[s[16]||(s[16]=e("h3",{id:"addGroupTitle",class:"text-sm font-semibold"},"Add Group",-1)),e("button",{class:"text-slate-500 hover:text-slate-700",onClick:C},"✕")]),e("div",it,[e("div",null,[s[17]||(s[17]=e("label",{class:"block text-xs font-medium text-slate-600 mb-1"},"Group Label",-1)),r(e("input",{"onUpdate:modelValue":s[3]||(s[3]=l=>x.value.label=l),type:"text",class:"w-full rounded-lg border px-3 py-2",placeholder:"e.g., Training (15)"},null,512),[[i,x.value.label]]),v.value.label?(d(),n("p",ut,b(v.value.label),1)):A("",!0)]),e("div",null,[s[18]||(s[18]=e("label",{class:"block text-xs font-medium text-slate-600 mb-1"},[L(" Group ID (slug) "),e("span",{class:"text-[11px] text-slate-500 ml-1"},"(letters/numbers/_ only)")],-1)),r(e("input",{"onUpdate:modelValue":s[4]||(s[4]=l=>x.value.id=l),onInput:E,type:"text",class:"w-full rounded-lg border px-3 py-2 font-mono",placeholder:"e.g., training"},null,544),[[i,x.value.id]]),v.value.id?(d(),n("p",ct,b(v.value.id),1)):A("",!0)])]),e("div",{class:"px-4 py-3 border-t flex items-center justify-end gap-2"},[e("button",{class:"px-3 py-1.5 rounded-lg border",onClick:C},"Cancel"),e("button",{class:"px-3 py-1.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700",onClick:F}," Add ")])])])):A("",!0)]))}};export{xt as default};
