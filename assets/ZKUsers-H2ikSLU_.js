import{G as ie,r as p,H as C,c as w,o as $,a as e,g as A,j as y,t as b,F as O,x as B,n as K,z as re,q as Z,p as T,h as U,v as z,A as L,I as ue,a1 as de,e as ce,y as P,W as ve,k as j}from"./index-BQaj8qaN.js";import{u as me}from"./zk-device-BxApvJ4S.js";import{_ as R}from"./_plugin-vue_export-helper-DlAUqK2U.js";const fe=ie("zkUser",()=>{const c=p([]),g=p(!1),x=p(null),o=(i,d)=>{var r,m;x.value=((m=(r=i==null?void 0:i.response)==null?void 0:r.data)==null?void 0:m.message)||(i==null?void 0:i.message)||d};async function s(){g.value=!0,x.value=null;try{const{data:i}=await C.get("/zk-users");return c.value=i,i}catch(i){return o(i,"ইউজার লোড ব্যর্থ"),[]}finally{g.value=!1}}async function u(i,d=25){var r;try{const{data:m}=await C.get("/zk-users/search",{params:{query:i,limit:d}});return m}catch(m){throw o(m,"সার্চ ব্যর্থ"),((r=m==null?void 0:m.response)==null?void 0:r.data)||m}}async function n(i){var d;try{const{data:r}=await C.post("/zk-users",i);return await s(),r}catch(r){throw o(r,"ইউজার তৈরিতে ব্যর্থ"),((d=r==null?void 0:r.response)==null?void 0:d.data)||r}}async function k(i,d){var r;try{const{data:m}=await C.put(`/zk-users/${encodeURIComponent(i)}`,d);return await s(),m}catch(m){throw o(m,"ইউজার আপডেট ব্যর্থ"),((r=m==null?void 0:m.response)==null?void 0:r.data)||m}}async function v(i){var d;try{const{data:r}=await C.delete(`/zk-users/${encodeURIComponent(i)}`);return await s(),r}catch(r){throw o(r,"ইউজার ডিলিট ব্যর্থ"),((d=r==null?void 0:r.response)==null?void 0:d.data)||r}}async function t(i){const{data:d}=await C.post(`/devices/${encodeURIComponent(i)}/pull-users`);return await s(),d}async function f(i){const{data:d}=await C.post(`/devices/${encodeURIComponent(i)}/push-users`);return d}async function D(i,d){const{data:r}=await C.post(`/devices/${encodeURIComponent(i)}/users/${encodeURIComponent(d)}/push`);return r}async function h(i){const{data:d}=await C.get(`/devices/${encodeURIComponent(i)}/user-count`);return d}async function S(i,d){const{data:r}=await C.post(`/devices/${encodeURIComponent(i)}/users/${encodeURIComponent(d)}/remove`);return r}return{users:c,loading:g,error:x,fetchUsers:s,searchUsers:u,createUser:n,updateUser:k,deleteUser:v,pullUsersFromDevice:t,pushAllUsersToDevice:f,pushSingleUserToDevice:D,userCountOnDevice:h,removeUserFromDevice:S}}),pe={class:"bg-white border rounded-xl overflow-hidden"},be={class:"p-3 border-b flex items-center justify-between"},ye={class:"text-sm text-slate-600"},xe={key:0,class:"text-xs text-slate-500"},we={class:"overflow-auto"},$e={class:"w-full text-sm"},he={class:"px-3 py-2 font-mono text-xs"},ge={class:"px-3 py-2"},ke={class:"px-3 py-2"},Ce={class:"px-3 py-2"},Ue={class:"px-3 py-2"},_e={class:"px-3 py-2"},De={class:"flex flex-wrap gap-2"},ze=["onClick"],Ae=["onClick"],Se=["onClick"],Re=["onClick"],Ie={key:0},Pe={__name:"UserTable",props:{items:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["edit","delete","push-one","remove-one"],setup(c,{emit:g}){function x(o){return Number(o)===14?"Admin":"User"}return(o,s)=>($(),w("div",pe,[e("div",be,[e("div",ye,[s[0]||(s[0]=y(" Total: ")),e("b",null,b(c.items.length),1)]),c.loading?($(),w("div",xe,s[1]||(s[1]=[e("i",{class:"fas fa-circle-notch fa-spin"},null,-1),y(" Loading… ")]))):A("",!0)]),e("div",we,[e("table",$e,[s[7]||(s[7]=e("thead",{class:"text-left bg-slate-50"},[e("tr",null,[e("th",{class:"px-3 py-2 border-b"},"Enroll"),e("th",{class:"px-3 py-2 border-b"},"Name"),e("th",{class:"px-3 py-2 border-b"},"Role"),e("th",{class:"px-3 py-2 border-b"},"Card"),e("th",{class:"px-3 py-2 border-b"},"FPs"),e("th",{class:"px-3 py-2 border-b w-64"},"Actions")])],-1)),e("tbody",null,[($(!0),w(O,null,B(c.items,u=>($(),w("tr",{key:u.id,class:"border-b"},[e("td",he,b(u.zk_userid),1),e("td",ge,b(u.name),1),e("td",ke,[e("span",{class:K([Number(u.role)===14?"bg-amber-100 text-amber-800":"bg-emerald-100 text-emerald-800","px-2 py-0.5 rounded text-xs"])},b(x(u.role)),3)]),e("td",Ce,b(u.cardno??""),1),e("td",Ue,b(u.fingerprints_count??0),1),e("td",_e,[e("div",De,[e("button",{class:"btn",onClick:n=>o.$emit("edit",u)},s[2]||(s[2]=[e("i",{class:"fas fa-edit mr-1"},null,-1),y(" Edit ")]),8,ze),e("button",{class:"btn",onClick:n=>o.$emit("delete",u)},s[3]||(s[3]=[e("i",{class:"fas fa-trash mr-1"},null,-1),y(" Delete ")]),8,Ae),e("button",{class:"btn",onClick:n=>o.$emit("push-one",u)},s[4]||(s[4]=[e("i",{class:"fas fa-upload mr-1"},null,-1),y(" Push to Device ")]),8,Se),e("button",{class:"btn",onClick:n=>o.$emit("remove-one",u)},s[5]||(s[5]=[e("i",{class:"fas fa-user-slash mr-1"},null,-1),y(" Remove from Device ")]),8,Re)])])]))),128)),c.items.length?A("",!0):($(),w("tr",Ie,s[6]||(s[6]=[e("td",{colspan:"6",class:"px-3 py-4 text-center text-slate-500"},"No users found",-1)])))])])])]))}},Te=R(Pe,[["__scopeId","data-v-af7e6944"]]),Ne={key:0,class:"fixed inset-0 z-50 grid place-items-center bg-black/30"},Fe={class:"bg-white rounded-xl shadow-lg w-[560px] max-w-[95vw]"},Ee={class:"px-4 py-3 border-b flex items-center justify-between"},Me={class:"font-semibold"},Ve={class:"p-4 space-y-3"},je={class:"grid grid-cols-2 gap-3"},Oe=["readonly"],Be={class:"flex items-center gap-2"},Ke={class:"px-4 py-3 border-t flex items-center justify-end gap-2"},Ze={__name:"UserFormModal",props:{show:{type:Boolean,default:!1},user:{type:Object,default:null}},emits:["close","save"],setup(c,{emit:g}){const x=c,o=g,s=re({zk_userid:"",name:"",role:0,cardno:"",password:"",is_active:!0});Z(()=>x.user,v=>{v?(s.zk_userid=v.zk_userid??"",s.name=v.name??"",s.role=Number(v.role??0),s.cardno=v.cardno??"",s.password="",s.is_active=v.is_active??!0):(s.zk_userid="",s.name="",s.role=0,s.cardno="",s.password="",s.is_active=!0)},{immediate:!0});const u=T(()=>!!x.user);function n(){o("close")}function k(){const v={zk_userid:s.zk_userid,name:s.name,role:Number(s.role),cardno:s.cardno||null,password:s.password||null,is_active:!!s.is_active};o("save",v)}return(v,t)=>c.show?($(),w("div",Ne,[e("div",Fe,[e("div",Ee,[e("div",Me,b(u.value?"Edit User":"New User"),1),e("button",{class:"text-slate-500 hover:text-slate-800",onClick:n},t[6]||(t[6]=[e("i",{class:"fas fa-times"},null,-1)]))]),e("div",Ve,[e("div",je,[e("div",null,[t[7]||(t[7]=e("label",{class:"block text-xs text-slate-600 mb-1"},"Enroll (zk_userid)",-1)),U(e("input",{"onUpdate:modelValue":t[0]||(t[0]=f=>s.zk_userid=f),readonly:u.value,type:"text",maxlength:"9",class:"border rounded px-3 py-1.5 w-full",placeholder:"e.g. 1001"},null,8,Oe),[[z,s.zk_userid]])]),e("div",null,[t[8]||(t[8]=e("label",{class:"block text-xs text-slate-600 mb-1"},"Name",-1)),U(e("input",{"onUpdate:modelValue":t[1]||(t[1]=f=>s.name=f),type:"text",maxlength:"24",class:"border rounded px-3 py-1.5 w-full"},null,512),[[z,s.name]])]),e("div",null,[t[10]||(t[10]=e("label",{class:"block text-xs text-slate-600 mb-1"},"Role",-1)),U(e("select",{"onUpdate:modelValue":t[2]||(t[2]=f=>s.role=f),class:"border rounded px-3 py-1.5 w-full"},t[9]||(t[9]=[e("option",{value:0},"User",-1),e("option",{value:14},"Admin",-1)]),512),[[L,s.role,void 0,{number:!0}]])]),e("div",null,[t[11]||(t[11]=e("label",{class:"block text-xs text-slate-600 mb-1"},"Card No",-1)),U(e("input",{"onUpdate:modelValue":t[3]||(t[3]=f=>s.cardno=f),type:"text",class:"border rounded px-3 py-1.5 w-full"},null,512),[[z,s.cardno]])]),e("div",null,[t[12]||(t[12]=e("label",{class:"block text-xs text-slate-600 mb-1"},"Password",-1)),U(e("input",{"onUpdate:modelValue":t[4]||(t[4]=f=>s.password=f),type:"text",maxlength:"8",class:"border rounded px-3 py-1.5 w-full",placeholder:"(optional)"},null,512),[[z,s.password]])]),e("div",Be,[U(e("input",{id:"active","onUpdate:modelValue":t[5]||(t[5]=f=>s.is_active=f),type:"checkbox",class:"h-4 w-4"},null,512),[[ue,s.is_active]]),t[13]||(t[13]=e("label",{for:"active",class:"text-sm"},"Active",-1))])])]),e("div",Ke,[e("button",{class:"btn",onClick:n},"Cancel"),e("button",{class:"btn-primary",onClick:k},b(u.value?"Update":"Create"),1)])])])):A("",!0)}},Le=R(Ze,[["__scopeId","data-v-ffa7d03c"]]),We={key:0,class:"fixed inset-0 z-50 grid place-items-center bg-black/30"},qe={class:"bg-white rounded-xl shadow-lg w-[480px] max-w-[95vw]"},Ge={class:"px-4 py-3 border-b flex items-center justify-between"},He={class:"font-semibold"},Je={class:"p-4 text-sm text-slate-700"},Qe={class:"px-4 py-3 border-t flex items-center justify-end gap-2"},Xe={__name:"ConfirmModal",props:{show:{type:Boolean,default:!1},title:{type:String,default:"Confirm"},message:{type:String,default:"Are you sure?"}},emits:["close","confirm"],setup(c,{emit:g}){return(x,o)=>c.show?($(),w("div",We,[e("div",qe,[e("div",Ge,[e("div",He,b(c.title),1),e("button",{class:"text-slate-500 hover:text-slate-800",onClick:o[0]||(o[0]=s=>x.$emit("close"))},o[3]||(o[3]=[e("i",{class:"fas fa-times"},null,-1)]))]),e("div",Je,b(c.message),1),e("div",Qe,[e("button",{class:"btn",onClick:o[1]||(o[1]=s=>x.$emit("close"))},"Cancel"),e("button",{class:"btn-danger",onClick:o[2]||(o[2]=s=>x.$emit("confirm"))},"Confirm")])])])):A("",!0)}},Ye=R(Xe,[["__scopeId","data-v-56cdf847"]]),es={key:0,class:"fixed inset-0 z-[60] grid place-items-center bg-black/30"},ss={class:"bg-white rounded-xl shadow-xl w-[520px] max-w-[95vw]"},ts={class:"px-4 py-3 border-b flex items-center justify-between"},ls={class:"font-semibold"},os={class:"p-4 space-y-3 text-sm"},as={class:"text-slate-600"},ns={key:0},is={key:1},rs=["value"],us={class:"px-4 py-3 border-t flex items-center justify-end gap-2"},ds=["disabled"],cs={key:1,class:"fas fa-circle-notch fa-spin"},vs={class:"ml-1"},ms={__name:"DeviceActionModal",props:{show:{type:Boolean,default:!1},mode:{type:String,default:"push"},user:{type:Object,default:null},devices:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["close","confirm"],setup(c,{emit:g}){const x=c,o=p(null);Z(()=>x.show,u=>{u&&(o.value=null)});const s=T(()=>x.mode==="remove"?"Remove From Device":"Push To Device");return(u,n)=>{var k,v;return c.show?($(),w("div",es,[e("div",ss,[e("div",ts,[e("div",ls,b(s.value),1),e("button",{class:"text-slate-500 hover:text-slate-800",onClick:n[0]||(n[0]=t=>u.$emit("close"))},n[4]||(n[4]=[e("i",{class:"fas fa-times"},null,-1)]))]),e("div",os,[e("div",as,[e("div",null,[n[5]||(n[5]=e("b",null,"User:",-1)),y(" "+b((k=c.user)==null?void 0:k.zk_userid)+" — "+b((v=c.user)==null?void 0:v.name),1)]),c.mode==="push"?($(),w("div",ns,n[6]||(n[6]=[y("Select a device to "),e("b",null,"push",-1),y(" this user into.")]))):($(),w("div",is,n[7]||(n[7]=[y("Select a device to "),e("b",null,"remove",-1),y(" this user from.")])))]),e("div",null,[n[9]||(n[9]=e("label",{class:"block text-xs text-slate-600 mb-1"},"Device",-1)),U(e("select",{"onUpdate:modelValue":n[1]||(n[1]=t=>o.value=t),class:"border rounded px-3 py-2 w-full"},[n[8]||(n[8]=e("option",{value:null,disabled:""},"Select device",-1)),($(!0),w(O,null,B(c.devices,t=>($(),w("option",{key:t.id,value:t.id}," #"+b(t.id)+" — "+b(t.name)+" ("+b(t.ip_address)+":"+b(t.port)+") ",9,rs))),128))],512),[[L,o.value]])]),n[10]||(n[10]=e("div",{class:"text-[12px] text-slate-500"}," Tip: Make sure the device is online and reachable. ",-1))]),e("div",us,[e("button",{class:"btn",onClick:n[2]||(n[2]=t=>u.$emit("close"))},"Cancel"),e("button",{class:"btn-primary",disabled:!o.value||c.loading,onClick:n[3]||(n[3]=t=>u.$emit("confirm",o.value))},[c.loading?($(),w("i",cs)):($(),w("i",{key:0,class:K(["fas",c.mode==="push"?"fa-upload":"fa-user-slash"])},null,2)),e("span",vs,b(c.mode==="push"?"Confirm Push":"Confirm Remove"),1)],8,ds)])])])):A("",!0)}}},fs=R(ms,[["__scopeId","data-v-24c53457"]]),ps={class:"my-container space-y-4"},bs={class:"flex items-center justify-between"},ys={class:"flex items-center gap-2"},xs=["disabled"],ws=["disabled"],$s={class:"flex flex-wrap items-center gap-2 bg-slate-50 border rounded-lg p-3"},hs=["disabled"],gs=["disabled"],ks=["disabled"],Cs={key:0,class:"ml-auto text-xs text-slate-500"},Us={__name:"ZKUsers",setup(c){const g=me(),x=T(()=>g.devices),o=fe(),s=de(),u=p(""),n=p(!1),k=p([]),v=p(""),t=p(!1),f=p(!1),D=p("push"),h=p(null),S=p(!1),i=p(!1),d=p(null),r=p(!1),m=p(""),M=p("");let I=null,N=null;const W=T(()=>n.value?k.value:o.users);async function F(){await o.fetchUsers()}ce(async()=>{await Promise.all([o.fetchUsers(),g.fetchDevices()])});async function V(){if(!u.value){n.value=!1,k.value=[];return}try{t.value=!0;const l=await o.searchUsers(u.value,50);k.value=Array.isArray(l)?l:[],n.value=!0}catch(l){s.error((l==null?void 0:l.message)||"Search failed")}finally{t.value=!1}}function q(){u.value="",n.value=!1,k.value=[]}function G(){d.value=null,i.value=!0}function H(l){d.value=l,i.value=!0}function J(){i.value=!1}async function Q(l){var a;try{(a=d.value)!=null&&a.id?(await o.updateUser(d.value.id,l),s.success("User updated")):(await o.createUser(l),s.success("User created")),await F(),i.value=!1}catch(_){s.error((_==null?void 0:_.message)||"Save failed")}}function X(l){m.value="Delete User",M.value=`Are you sure you want to delete "${l.name}" (Enroll ${l.zk_userid})?`,I=async()=>{await o.deleteUser(l.id),s.warning("User deleted"),await F()},N=null,r.value=!0}function E(){r.value=!1,I=null,N=null}async function Y(){if(!I)return E();try{await I(N)}catch(l){s.error((l==null?void 0:l.message)||"Operation failed")}finally{E()}}async function ee(){if(!v.value)return s.error("Enter a Device ID first");try{t.value=!0;const l=await o.pullUsersFromDevice(v.value);s.success(`Pulled from device#${v.value}: seen ${l.seen??0}, inserted ${l.inserted??0}`),await F()}catch(l){s.error((l==null?void 0:l.message)||"Pull failed")}finally{t.value=!1}}async function se(){if(!v.value)return s.error("Enter a Device ID first");try{t.value=!0;const l=await o.pushAllUsersToDevice(v.value);s.success(`Pushed to device#${v.value}: new ${l.pushed??0}, already ${l.already??0}`)}catch(l){s.error((l==null?void 0:l.message)||"Push failed")}finally{t.value=!1}}async function te(){if(!v.value)return s.error("Enter a Device ID first");try{t.value=!0;const l=await o.userCountOnDevice(v.value),a=Number((l==null?void 0:l.user_count)??0);s.info(`Device#${v.value}: users = ${a}${(l==null?void 0:l.online)===!1?" (offline)":""}`)}catch(l){s.error((l==null?void 0:l.message)||"Count failed")}finally{t.value=!1}}function le(l){h.value=l,D.value="push",f.value=!0}function oe(l){h.value=l,D.value="remove",f.value=!0}async function ae(l){if(!(!l||!h.value))try{if(S.value=!0,D.value==="push"){const a=await o.pushSingleUserToDevice(l,h.value.zk_userid);s.success(`Pushed ${h.value.zk_userid} → device#${l}: ${a!=null&&a.pushed?"created":"already exists"}`)}else{const a=await o.removeUserFromDevice(l,h.value.zk_userid);s.warning(`Removed ${h.value.zk_userid} from device#${l}${a!=null&&a.removed?"":" (check device)"}`)}}catch(a){s.error((a==null?void 0:a.message)||"Operation failed")}finally{S.value=!1,f.value=!1,h.value=null}}function ne(){f.value=!1,h.value=null}return(l,a)=>($(),w("div",ps,[e("div",bs,[a[5]||(a[5]=e("h1",{class:"text-xl font-semibold"},"ZK Users",-1)),e("div",ys,[U(e("input",{"onUpdate:modelValue":a[0]||(a[0]=_=>u.value=_),onKeyup:ve(V,["enter"]),type:"text",placeholder:"Search name / enroll / card",class:"border rounded px-3 py-1.5 text-sm w-64"},null,544),[[z,u.value]]),e("button",{class:"btn",onClick:V,disabled:t.value},a[2]||(a[2]=[e("i",{class:"fas fa-search mr-1"},null,-1),y(" Search ")]),8,xs),e("button",{class:"btn-outline",onClick:q,disabled:t.value||!n.value},a[3]||(a[3]=[e("i",{class:"fas fa-times mr-1"},null,-1),y(" Clear ")]),8,ws),e("button",{class:"btn-primary",onClick:G},a[4]||(a[4]=[e("i",{class:"fas fa-user-plus mr-1"},null,-1),y(" New User ")]))])]),e("div",$s,[a[10]||(a[10]=e("div",{class:"text-sm text-slate-600"},"Device actions:",-1)),U(e("input",{"onUpdate:modelValue":a[1]||(a[1]=_=>v.value=_),type:"number",min:"1",placeholder:"Device ID",class:"border rounded px-2 py-1 text-sm w-28"},null,512),[[z,v.value]]),e("button",{class:"btn",onClick:ee,disabled:t.value},a[6]||(a[6]=[e("i",{class:"fas fa-download mr-1"},null,-1),y(" Pull Users ")]),8,hs),e("button",{class:"btn",onClick:se,disabled:t.value},a[7]||(a[7]=[e("i",{class:"fas fa-upload mr-1"},null,-1),y(" Push All ")]),8,gs),e("button",{class:"btn",onClick:te,disabled:t.value},a[8]||(a[8]=[e("i",{class:"fas fa-list-ol mr-1"},null,-1),y(" Count ")]),8,ks),j(o).loading||t.value?($(),w("span",Cs,a[9]||(a[9]=[e("i",{class:"fas fa-circle-notch fa-spin"},null,-1),y(" Working… ")]))):A("",!0)]),P(Te,{items:W.value,loading:j(o).loading,onEdit:H,onDelete:X,onPushOne:le,onRemoveOne:oe},null,8,["items","loading"]),P(Le,{show:i.value,user:d.value,onClose:J,onSave:Q},null,8,["show","user"]),P(Ye,{show:r.value,title:m.value,message:M.value,onClose:E,onConfirm:Y},null,8,["show","title","message"]),P(fs,{show:f.value,mode:D.value,user:h.value,devices:x.value,loading:S.value,onClose:ne,onConfirm:ae},null,8,["show","mode","user","devices","loading"])]))}},As=R(Us,[["__scopeId","data-v-d1ef1cc8"]]);export{As as default};
