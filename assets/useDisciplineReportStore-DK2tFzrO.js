import{B as X,r as y,x as R,C as f}from"./index-DsqJrs7X.js";const d=t=>Array.isArray(t)?t:[],N=t=>{if(!t)return null;const s=t.month_start||t.monthStart||t.start||t.value,m=t.label||t.name||"";return{...t,month_start:s,label:m}},j=t=>{if(!t)return{};const s=t.paycuts||t.paycut_items||t.paycut_list||t.paycut||[];return{...t,manual_indisciplines:d(t.manual_indisciplines||t.indisciplines||t.manualIndisciplines),manual_actions:d(t.manual_actions||t.actions||t.manualActions),attachments:d(t.attachments||t.attachment_files||t.files),letters:d(t.letters||t.text_letters||t.letter_attachments),paycuts:Array.isArray(s)?s:s?[s]:[]}},$=t=>{const s=(t==null?void 0:t.data)||{};return s!=null&&s.data&&typeof s.data=="object"&&!Array.isArray(s.data)?s.data:s},Z=t=>{if(!(t!=null&&t.user)||!(t!=null&&t.months))return t;const s=t.user||{},m=t.year_review||{},_=Object.entries(t.months||{}).map(([h,p])=>{var w,k;const P=d((w=p==null?void 0:p.indiscipline)==null?void 0:w.manual),I=d((k=p==null?void 0:p.actions)==null?void 0:k.manual),b=(p==null?void 0:p.paycut)||null,A=Number((p==null?void 0:p.attachment_count)??(p==null?void 0:p.attachments_count)??0);return{month_start:h,paycut:b,paycuts:b?[b]:[],manual_indisciplines:P,manual_actions:I,indisciplines:P,actions:I,attachments_count:A,attachment_count:A}}),r=m==null?void 0:m.final_score;return{...s,month_records:_,final_outcome:r??s.final_outcome,final_score:r??s.final_score,yearly_final_outcome:r??s.yearly_final_outcome}},C=t=>{const s=Z(t),m=d(s.month_records||s.monthRecords||s.records||s.months),_={};return m.forEach(r=>{const h=(r==null?void 0:r.month_start)||(r==null?void 0:r.monthStart);h&&(_[h]=j(r))}),{...s,_monthMap:_}},x=t=>{const s=(t==null?void 0:t.meta)||(t==null?void 0:t.pagination)||{},m=Number((t==null?void 0:t.current_page)||s.current_page||s.page||1),_=Number((t==null?void 0:t.per_page)||s.per_page||s.perPage||25),r=Number((t==null?void 0:t.total)||s.total||0),h=Number((t==null?void 0:t.last_page)||s.last_page||s.lastPage);return{page:m,per_page:_,total:r,last_page:h||(_>0?Math.ceil(r/_):1)}},S=t=>{const s={};return Object.entries(t||{}).forEach(([m,_])=>{_==null||_===""||(s[m]=_)}),s},tt=X("discipline-report",()=>{const t=y([]),s=y([]),m=y({page:1,per_page:25,total:0,last_page:1}),_=y({year:new Date().getFullYear(),search:"",company_id:"",department_id:"",line_type:"all",employee_id:"",page:1,per_page:25}),r=y(!1),h=y(null),p=y(null),P=R(()=>t.value),I=R(()=>s.value),b=R(()=>m.value),A=(e={})=>{["year","search","company_id","department_id","line_type","employee_id","page","per_page"].forEach(c=>{c in e&&(_.value[c]=e[c])})},w=e=>t.value.findIndex(n=>Number((n==null?void 0:n.id)||(n==null?void 0:n.user_id))===Number(e)),k=(e,n)=>{var i,a;const c=w(e);return c<0?null:((a=(i=t.value[c])==null?void 0:i._monthMap)==null?void 0:a[n])||null},B=async(e={})=>{r.value=!0,h.value=null;try{A(e);const n=S({..._.value,...e}),c=await f.get("/discipline-report",{params:n}),i=$(c),a=Array.isArray(i)?i:i.users||i.data||i.items||[];t.value=d(a).map(C),s.value=d(i.months||i.month_list||i.months_list).map(N).filter(Boolean),m.value=x(i)}catch(n){h.value=n,console.error("Error fetching discipline report:",n)}finally{r.value=!1}},D=(e,n)=>{const c=Array.isArray(e)?e:e.users||e.data||e.items||[],i=d(c).map(C);i.length&&(i.forEach(a=>{var E;const u=(a==null?void 0:a.id)||(a==null?void 0:a.user_id);if(!u)return;const o=w(u);if(o===-1){t.value.push(a);return}const l=t.value[o],g={...l._monthMap||{}},z=(E=a._monthMap)==null?void 0:E[n];z&&(g[n]=z),t.value[o]={...l,...a,_monthMap:g}}),e.months&&(s.value=d(e.months).map(N).filter(Boolean)))},v=async e=>{if(e){r.value=!0,h.value=null;try{const n=S({..._.value,month_start:e}),c=await f.get("/discipline-report",{params:n}),i=$(c);D(i,e)}catch(n){h.value=n,console.error("Error refreshing discipline month:",n)}finally{r.value=!1}}},F=async(e,n,c)=>{var i;if(!(!e||!c))try{const a=await f.post("/discipline/month-records/ensure",{user_id:e,year:n,month_start:c}),u=((i=a==null?void 0:a.data)==null?void 0:i.data)||(a==null?void 0:a.data)||null;if(u){const o=w(e);if(o>=0){const l=t.value[o]._monthMap||{};t.value[o]._monthMap={...l,[c]:j(u)}}}}catch(a){throw console.error("Error ensuring month record:",a),a}},K=async e=>{const n=e==null?void 0:e.month_start;await f.post("/discipline/indisciplines",e),n&&await v(n)},O=async(e,n,c={})=>{const{user_id:i,month_start:a}=c,u=k(i,a),o=(u==null?void 0:u.manual_indisciplines)||[],l=o.findIndex(g=>g.id===e),M=l>=0?{...o[l]}:null;l>=0&&(o[l]={...o[l],...n});try{await f.patch(`/discipline/indisciplines/${e}`,n)}catch(g){throw l>=0&&M&&(o[l]=M),g}},L=async(e,n={})=>{await f.delete(`/discipline/indisciplines/${e}`),n!=null&&n.month_start&&await v(n.month_start)},T=async e=>{const n=e==null?void 0:e.month_start;await f.post("/discipline/actions",e),n&&await v(n)},Y=async(e,n,c={})=>{const{user_id:i,month_start:a}=c,u=k(i,a),o=(u==null?void 0:u.manual_actions)||[],l=o.findIndex(g=>g.id===e),M=l>=0?{...o[l]}:null;l>=0&&(o[l]={...o[l],...n});try{await f.patch(`/discipline/actions/${e}`,n)}catch(g){throw l>=0&&M&&(o[l]=M),g}},q=async(e,n={})=>{await f.delete(`/discipline/actions/${e}`),n!=null&&n.month_start&&await v(n.month_start)},G=async({file:e,title:n,doc_type:c,mode:i,user_id:a,month_start:u,year:o})=>{const l=new FormData;l.append("file",e),n&&l.append("title",n),c&&l.append("doc_type",c),i&&l.append("mode",i),a&&l.append("user_id",a),u&&l.append("month_start",u),o&&l.append("year",o),await f.post("/discipline/attachments",l,{headers:{"Content-Type":"multipart/form-data"}}),u&&await v(u)},H=async({title:e,body_html:n,doc_type:c,mode:i,user_id:a,month_start:u,year:o})=>{await f.post("/discipline/letters",{title:e,body_html:n,doc_type:c,mode:i,user_id:a,month_start:u,year:o}),u&&await v(u)},J=async(e,n={})=>{await f.delete(`/discipline/attachments/${e}`),n!=null&&n.month_start&&await v(n.month_start)},Q=async({user_id:e,year:n,score:c})=>{const i=w(e),a=i>=0?{...t.value[i]}:null;i>=0&&(t.value[i]={...t.value[i],final_outcome:c,final_score:c,yearly_final_outcome:c});try{await f.patch("/discipline-report/final-outcome",{user_id:e,year:n,score:c})}catch(u){throw i>=0&&a&&(t.value[i]=a),u}},V=async e=>{r.value=!0;try{const{data:n}=await f.get(`/discipline-attachments/${e}`);return p.value=(n==null?void 0:n.data)??null,p.value}finally{r.value=!1}},W=async e=>{var n,c,i;if(e){r.value=!0;try{const{data:a}=await f.patch(`/discipline/attachments/${e}/acknowledge`);return((n=p.value)==null?void 0:n.id)===e&&(p.value={...p.value,...(a==null?void 0:a.data)??a??{},acknowledged_at:((c=a==null?void 0:a.data)==null?void 0:c.acknowledged_at)??(a==null?void 0:a.acknowledged_at)??p.value.acknowledged_at,acknowledged_by:((i=a==null?void 0:a.data)==null?void 0:i.acknowledged_by)??(a==null?void 0:a.acknowledged_by)??p.value.acknowledged_by}),a}finally{r.value=!1}}};return{filters:_,loading:R(()=>r.value),error:R(()=>h.value),users:P,months:I,pagination:b,showAttachment:V,acknowledgeAttachment:W,fetchReport:B,refreshMonth:v,ensureMonthRecord:F,createManualIndiscipline:K,updateManualIndiscipline:O,deleteManualIndiscipline:L,createManualAction:T,updateManualAction:Y,deleteManualAction:q,uploadAttachment:G,createLetter:H,deleteAttachment:J,updateFinalScore:Q,setFilters:A}});export{tt as u};
