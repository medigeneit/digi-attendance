import{r as u,g as M,h as E,q as I,c as p,o as d,a as s,j as S,k as v,l as j,v as A,d as L,n as f,t as k,w as T}from"./index-CQTm4urV.js";import{g as V}from"./datetime-Du_mcDA9.js";import{u as O}from"./company-C39OPmRc.js";import{u as W}from"./tags-B5UwYASN.js";import{u as $}from"./useTaskStore-D7wGXv1u.js";import{S as R}from"./SectionLoading-6-1AAPfH.js";import{S as Y}from"./SelectDropdown-Ov8ZU_gU.js";import{_ as z}from"./TextEditor-C7IXhmEp.js";const G={class:"px-4 max-h-[90vh] overflow-auto"},H={class:"sticky top-0 pt-4 -mx-4 px-4 border-b bg-white rounded-t-md"},J={key:0,class:"text-center py-4 text-gray-500"},K={class:"mb-4"},P={class:"mb-4"},Q={key:0,class:"mb-4"},X={class:"mb-4"},Z={key:0},D={class:"sticky bottom-0 bg-white py-4 border-t"},ee={key:0,class:"mb-4 text-red-500 font-medium"},te={key:1},se={class:"flex items-center gap-4 justify-between"},oe=["disabled"],pe={__name:"TaskEditForm",props:{taskId:{type:[String,Number],required:!0}},emits:["updated","cancel"],setup(q,{emit:B}){const h=q,w=B,c=$(),N=u([]),_=W(),U=M(),C=O(),i=u(),r=u(!1),g=u([]),y=u(""),m=u({});E(async()=>{var t,e;r.value=!0,_.fetchTags("website"),i.value=(t=await c.fetchTask(h.taskId,{},{fetchOnly:!0,loadingBeforeFetch:!1}))==null?void 0:t.task,b.value=_.tags.filter(l=>{var n,a;return((a=(n=i.value)==null?void 0:n.website_tags)==null?void 0:a.some(o=>o.id===l.id))||!1}).map(l=>l.id),await C.fetchCompanies({with:"departments",ignore_permission:!0}),x(i.value),N.value=((e=i.value)==null?void 0:e.website_tags)||[],g.value=i.value.users,r.value=!1}),I(()=>i.value,t=>{x(t),g.value=t.users});function x(t){var e;m.value={title:t.title,description:t.description,requirement_id:t.requirement_id,from_department_id:t.from_department_id,to_department_id:t.to_department_id,...((e=U.user)==null?void 0:e.role)!=="employee"?{is_important:t.is_important,is_urgent:t.is_urgent,is_target:t.is_target,started_at:V(t.started_at),deadline:V(t.deadline)}:{}}}const F=async()=>{var t,e,l,n;r.value=!0;try{const a={...m.value,user_ids:((t=g.value)==null?void 0:t.map(o=>Number(o.id)))||[],website_tags:((e=b.value)==null?void 0:e.map(o=>Number(o)))||[]};await c.updateTask(h.taskId,a,{loadingBeforeFetch:!1}),w("updated")}catch(a){console.error(a),y.value=((n=(l=a.response)==null?void 0:l.data)==null?void 0:n.message)||"An error occurred while updating the task."}finally{r.value=!1}},b=u([]);return(t,e)=>{var l,n,a;return d(),p("div",G,[s("div",H,[e[4]||(e[4]=s("h2",{class:"text-2xl font-semibold text-gray-800 mb-4"},"Edit Task",-1)),r.value?(d(),p("div",J,"Loading form...")):v("",!0)]),s("form",{onSubmit:T(F,["prevent"]),class:"mt-4"},[s("div",K,[e[5]||(e[5]=s("label",{class:"block text-gray-700 font-medium mb-2"},"Task Title",-1)),j(s("input",{"onUpdate:modelValue":e[0]||(e[0]=o=>m.value.title=o),required:"",placeholder:"Enter task title",class:"w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"},null,512),[[A,m.value.title]])]),s("div",P,[e[6]||(e[6]=s("label",{class:"text-gray-800"},"Websites",-1)),L(Y,{options:f(_).tags,key:"id",label:"name",modelValue:b.value,"onUpdate:modelValue":e[1]||(e[1]=o=>b.value=o),multiple:!0,clearable:!0},null,8,["options","modelValue"])]),(l=i.value)!=null&&l.requirement?(d(),p("div",Q,[e[7]||(e[7]=s("label",{class:"block text-gray-700 font-medium mb-2"},"Requirement",-1)),s("div",null,[s("p",null,k((a=(n=i.value)==null?void 0:n.requirement)==null?void 0:a.title),1)])])):v("",!0),s("div",X,[e[8]||(e[8]=s("label",{class:"block text-gray-700 font-medium mb-2"},"Description",-1)),r.value?(d(),p("div",Z)):(d(),S(z,{key:1,modelValue:m.value.description,"onUpdate:modelValue":e[2]||(e[2]=o=>m.value.description=o)},null,8,["modelValue"]))]),s("div",D,[f(c).error||y.value?(d(),p("div",ee,k(f(c).error||y.value),1)):v("",!0),f(c).error?(d(),p("hr",te)):v("",!0),s("div",se,[s("button",{type:"button",onClick:e[3]||(e[3]=T(o=>w("close"),["prevent"])),class:"btn-3"},"Cancel"),s("button",{disabled:r.value,type:"submit",class:"btn-2"},k(r.value?"Updating...":"Update Task"),9,oe)])])],32),r.value?(d(),S(R,{key:0})):v("",!0)])}}};export{pe as _};
