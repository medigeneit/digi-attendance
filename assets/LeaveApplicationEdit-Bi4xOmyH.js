import{d as Z,u as ee,b as te,s as ae,x as y,r as g,e as se,A as T,m as ne,c as m,o as c,a as n,f as oe,n as I,i as le,j as ie,w as re,g as U,h as w,v as V,t as x,F as W,y as Y,k as q,ab as R}from"./index-Cg7CY8Ar.js";import{L as de}from"./LoaderView-BnogxUwb.js";import{_ as ue}from"./MultiselectDropdown-DN9h-e4W.js";import{u as ce}from"./holiday-BQvAZlhg.js";import{u as pe}from"./leave-application-NvIvuJEQ.js";import{u as me}from"./leave-type-CHpUFmzJ.js";import{u as ve}from"./user-Y8agk0_C.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./MultiselectDropdown.vue_vue_type_style_index_0_lang-B-3cW2rR.js";const fe={class:"my-container max-w-3xl space-y-4"},_e={class:"flex items-center justify-between gap-2"},ye={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},we={key:0},ge={class:"text-blue-600 font-medium"},ke={key:1,class:"bg-gray-100 p-2 rounded-md"},be={class:"font-semibold w-32 shrink-0"},he={class:"flex flex-wrap gap-3"},xe=["name","value","onUpdate:modelValue","disabled"],De={class:"flex items-center space-x-1"},Le=["name","onUpdate:modelValue"],Ue={class:"flex items-center space-x-1"},Ve=["name","onUpdate:modelValue"],Se={key:0,class:"text-red-600 text-sm font-medium mt-2"},Ae={key:2,class:"text-red-500 text-sm"},Fe={__name:"LeaveApplicationEdit",setup(Ne){const S=Z(),p=pe(),J=me(),v=ve(),k=ce(),B=ee(),j=te(),{userLeaveBalance:H}=ae(v),A=y(()=>p.leaveApplication),M=y(()=>j.params.id),D=g(null),l=g({user_id:"",last_working_date:"",resumption_date:"",reason:"",works_in_hand:"",handover_user_id:""}),d=g({}),b=g(!1),L=g(null),O=g(!1),$=y(()=>{var a,e,s,t,i;return((s=(e=(a=p==null?void 0:p.leaveApplication)==null?void 0:a.user)==null?void 0:e.assign_weekend)==null?void 0:s.weekends)||((i=(t=p==null?void 0:p.leaveApplication)==null?void 0:t.user)==null?void 0:i.weekends)||[]}),P=a=>{const e=a.getFullYear(),s=String(a.getMonth()+1).padStart(2,"0"),t=String(a.getDate()).padStart(2,"0");return`${e}-${s}-${t}`},f=y(()=>{const a=l.value.last_working_date,e=l.value.resumption_date;if(!a||!e)return[];const s=new Date(a),t=new Date(e);if(t<=s)return[];const i=[],o=new Date(s);for(o.setDate(o.getDate()+1);o<t;)i.push(P(o)),o.setDate(o.getDate()+1);return i}),z=y(()=>{const a=l.value.last_working_date,e=l.value.resumption_date;if(!a||!e)return"";const s=new Date(a);return new Date(e)<=s?"Resumption date must be after Last Working Date.":f.value.length===0?"No leave days between the selected dates.":`Total leave days: ${f.value.length}`}),G=a=>{const e=new Date(a).toLocaleString("en-us",{weekday:"long"}).toLowerCase(),s=e.charAt(0).toUpperCase()+e.slice(1);return $.value.includes(s)},K=a=>((k==null?void 0:k.holidayDates)||[]).includes(a),C=y(()=>{const a={};for(const[e,s]of Object.entries(d.value||{}))typeof s=="number"&&(a[s]=(a[s]||0)+1);return a}),E=y(()=>{const a=H.value||[],e=[];for(const s of a){const t=C.value[s.id]||0;Number.isFinite(s.remaining_days)&&t>s.remaining_days&&e.push({id:s.id,name:s.leave_type||s.name,used:t,remain:s.remaining_days})}return e}),N=()=>{const a={...d.value||{}},e={};for(const s of f.value){if(G(s)){e[s]="weekend";continue}if(K(s)){e[s]="holiday";continue}const t=a[s];if(typeof t=="number"){e[s]=t;continue}}d.value=e},F=async()=>{var e;const a=f.value;a.length&&await k.fetchHolidays({company_id:(e=S==null?void 0:S.user)==null?void 0:e.company_id,start_date:a[0],end_date:a[a.length-1]})};se(async()=>{var a,e;b.value=!0;try{const{id:s}=j.params;O.value=!!s,await p.fetchLeaveApplicationById(s);const t=p.leaveApplication,i=t==null?void 0:t.user;if(!t||!i)return;const o=(a=i==null?void 0:i.company)==null?void 0:a.id;if(o&&await J.fetchLeaveTypes(o),t.user_id&&await v.fetchUserLeaveBalances(t.user_id,{applicationId:M.value}),await v.fetchTypeWiseEmployees({type:i.type,except:[i.id]}),v.users=v.users.map(r=>({...r,label:r.name})),(e=v.users)!=null&&e.length){const r=v.users.find(h=>h.id===t.handover_user_id);r&&(D.value=r)}l.value={user_id:t.user_id,last_working_date:t.last_working_date,resumption_date:t.resumption_date,reason:t.reason,works_in_hand:t.works_in_hand,handover_user_id:t.handover_user_id};const u={};if(Array.isArray(t.json_data))for(const r of t.json_data){const h=r==null?void 0:r.date,_=r==null?void 0:r.leave_type_id;h&&(_==="weekend"||_==="holiday"?u[h]=_:_!=null&&_!==""&&!Number.isNaN(Number(_))&&(u[h]=Number(_)))}d.value=u,await F(),N()}catch(s){console.error(s)}finally{b.value=!1}}),T(()=>[l.value.last_working_date,l.value.resumption_date],async()=>{await F(),N()}),T(()=>[$.value,k.holidayDates],()=>{N()},{deep:!0}),T(()=>D.value,a=>{l.value.handover_user_id=(a==null?void 0:a.id)||null});const Q=async()=>{var a;b.value=!0,L.value=null;try{const e=f.value,s=[],t=[];for(const o of e){const u=d.value[o],r=u!=="weekend"&&u!=="holiday"&&u!=null?Number(u):null;r!=null&&s.push({date:o,leave_type_id:r}),t.push({date:o,leave_type_id:u??""})}const i={id:M.value,user_id:(a=A==null?void 0:A.value)==null?void 0:a.user_id,last_working_date:l.value.last_working_date,resumption_date:l.value.resumption_date,reason:l.value.reason,works_in_hand:l.value.works_in_hand,handover_user_id:l.value.handover_user_id,leave_days:s,json_data:t};if(i.id){const o=await p.updateLeaveApplication(i.id,i);o&&B.push({name:"LeaveApplicationShow",params:{id:o==null?void 0:o.id}})}}catch(e){L.value=(e==null?void 0:e.message)||"Failed to submit leave application"}finally{b.value=!1}},X=()=>B.go(-1);return(a,e)=>{const s=ne("RouterLink");return c(),m("div",fe,[n("div",_e,[n("button",{class:"btn-3",onClick:X},e[5]||(e[5]=[n("i",{class:"far fa-arrow-left"},null,-1),n("span",{class:"hidden md:flex"},"Back",-1)])),e[7]||(e[7]=n("h1",{class:"title-md md:title-lg flex-wrap text-center"},"Leave Application Edit Form",-1)),n("div",null,[I(s,{to:"/applications",class:"btn-2"},{default:le(()=>e[6]||(e[6]=[ie("Home")])),_:1,__:[6]})])]),b.value?(c(),oe(de,{key:0})):(c(),m("form",{key:1,onSubmit:re(Q,["prevent"]),class:"space-y-4 card-bg p-4 md:p-8"},[n("div",ye,[n("div",null,[e[8]||(e[8]=n("label",{for:"last-working-date",class:"block text-sm font-medium"},"Last Working Date",-1)),w(n("input",{type:"date",id:"last-working-date","onUpdate:modelValue":e[0]||(e[0]=t=>l.value.last_working_date=t),class:"input-1 w-full",required:""},null,512),[[V,l.value.last_working_date]])]),n("div",null,[e[9]||(e[9]=n("label",{for:"resumption-date",class:"block text-sm font-medium"},"Resumption Date",-1)),w(n("input",{type:"date",id:"resumption-date","onUpdate:modelValue":e[1]||(e[1]=t=>l.value.resumption_date=t),class:"input-1 w-full",required:""},null,512),[[V,l.value.resumption_date]])])]),l.value.last_working_date&&l.value.resumption_date?(c(),m("div",we,[n("p",ge,x(z.value),1)])):U("",!0),f.value.length?(c(),m("div",ke,[e[12]||(e[12]=n("h2",{class:"text-lg font-semibold"},"Leave Days",-1)),(c(!0),m(W,null,Y(f.value,(t,i)=>(c(),m("div",{key:t,class:"flex gap-4 mb-2 bg-white p-2 rounded-md"},[n("div",be,x(t),1),n("div",he,[(c(!0),m(W,null,Y(q(H),o=>(c(),m("label",{key:o.id,class:"flex items-center space-x-1"},[w(n("input",{type:"radio",name:"leaveType-"+t,value:o.id,"onUpdate:modelValue":u=>d.value[t]=u,disabled:C.value[o.id]>=(o.remaining_days??1/0)&&d.value[t]!==o.id},null,8,xe),[[R,d.value[t]]]),n("span",null,x(o.leave_type),1)]))),128)),n("label",De,[w(n("input",{type:"radio",name:"leaveType-"+t,value:"weekend","onUpdate:modelValue":o=>d.value[t]=o},null,8,Le),[[R,d.value[t]]]),e[10]||(e[10]=n("span",null,"Weekend",-1))]),n("label",Ue,[w(n("input",{type:"radio",name:"leaveType-"+t,value:"holiday","onUpdate:modelValue":o=>d.value[t]=o},null,8,Ve),[[R,d.value[t]]]),e[11]||(e[11]=n("span",null,"Holiday",-1))])])]))),128)),E.value.length?(c(),m("p",Se," You have exceeded remaining days for: "+x(E.value.map(t=>`${t.name} (used ${t.used}/${t.remain})`).join(", ")),1)):U("",!0)])):U("",!0),n("div",null,[e[13]||(e[13]=n("label",{for:"reason",class:"block text-sm font-medium"},"Reason",-1)),w(n("textarea",{id:"reason","onUpdate:modelValue":e[2]||(e[2]=t=>l.value.reason=t),class:"input-1 w-full",placeholder:"Enter your reason for leave"},null,512),[[V,l.value.reason]])]),n("div",null,[e[14]||(e[14]=n("label",{for:"handover-user",class:"block text-sm font-medium"},"Handover User",-1)),I(ue,{modelValue:D.value,"onUpdate:modelValue":e[3]||(e[3]=t=>D.value=t),options:q(v).users,multiple:!1,label:"label",placeholder:"Select user"},null,8,["modelValue","options"])]),n("div",null,[e[15]||(e[15]=n("label",{for:"works-in-hand",class:"block text-sm font-medium"},"Works in Hand",-1)),w(n("textarea",{id:"works-in-hand","onUpdate:modelValue":e[4]||(e[4]=t=>l.value.works_in_hand=t),class:"input-1 w-full",placeholder:"Enter details of works in hand",rows:"6"},null,512),[[V,l.value.works_in_hand]])]),L.value?(c(),m("div",Ae,x(L.value),1)):U("",!0),e[16]||(e[16]=n("div",{class:"flex justify-end"},[n("button",{type:"submit",class:"btn-1"},"Update")],-1))],32))])}}};export{Fe as default};
