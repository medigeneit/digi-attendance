import{D as ae,E as P,s as de,r as _,x as ie,e as le,y as ue,c as u,o as c,a,h as J,v as ce,j as pe,k as N,n as me,t as b,F as R,A as U,g as T,L as ye,X as fe,w as be,q as W}from"./index-DXa7cwaN.js";import{L as ve}from"./LoaderView-Hum-yu18.js";import{_ as xe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ke=ae("kpi-report",{state:()=>({meta:null,rows:[],isLoading:!1,error:null}),actions:{async fetchBiMonthly(M){var i,l;this.isLoading=!0,this.error=null;try{const{data:s}=await P.get("/kpi/reports/bi-monthly",{params:M});return this.meta=(s==null?void 0:s.meta)??null,this.rows=Array.isArray(s==null?void 0:s.rows)?s.rows:Array.isArray(s==null?void 0:s.data)?s.data:[],{meta:this.meta,rows:this.rows}}catch(s){throw this.error=((l=(i=s==null?void 0:s.response)==null?void 0:i.data)==null?void 0:l.message)||"Failed to load report",s}finally{this.isLoading=!1}},async exportBiMonthly(M){try{const i=await P.get("/kpi/reports/bi-monthly-export",{params:M,responseType:"blob"}),l=i.headers["content-disposition"]||"";let s="kpi_bi_monthly.xlsx";const y=/filename="?([^"]+)"?/i.exec(l);y&&y[1]&&(s=decodeURIComponent(y[1]));const L=new Blob([i.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),h=URL.createObjectURL(L),g=document.createElement("a");g.href=h,g.download=s,document.body.appendChild(g),g.click(),g.remove(),URL.revokeObjectURL(h)}catch(i){throw console.error(i),i}},async setReportCompletion(M){var i,l;try{const{form_id:s,department_id:y,completed:L}=M||{};if(!s)throw new Error("form_id is required");if(y==null)throw new Error("department_id is required");const{data:h}=await P.patch(`/kpi/forms/${s}/report-completion`,{department_id:y,completed:!!L});return h}catch(s){const y=((l=(i=s==null?void 0:s.response)==null?void 0:i.data)==null?void 0:l.message)||(s==null?void 0:s.message)||"Failed to update report completion";throw console.error("setReportCompletion error:",s),new Error(y)}}}}),he={class:"space-y-4 px-4 print:px-0"},_e={class:"flex flex-wrap items-end gap-3 print:hidden"},ge={key:0,class:"py-8 text-center"},we={key:1,class:"rounded-md border border-red-200 bg-red-50 p-3 text-red-700"},Ce={key:2,class:"overflow-x-auto rounded-xl border bg-white shadow-sm"},Ne={class:"min-w-full text-sm"},Me={class:"bg-gray-100 text-gray-800"},Le={rowspan:"2",class:"border px-2 py-2 text-left"},Re={class:"bg-gray-100 text-gray-700"},Se={class:"border px-1 py-2 text-center"},$e={class:"border px-1 py-2 w-40"},Be={class:"border py-1 text-center"},De={key:0,class:"text-xs text-gray-500"},Ie={class:"border py-1 text-center"},Ve=["disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange","title"],Ee={class:"border py-1 text-center"},Oe={class:"border px-2 py-2 text-center"},Ae={key:0,class:"mt-1 text-[10px] text-gray-500 text-center"},Ue={key:0},Pe=1500,Te={__name:"KpiBiMonthlyReport",setup(M){const i=ke(),{meta:l,rows:s,isLoading:y,error:L}=de(i),h=_(new Date().getFullYear()),g=_("department"),I=_(""),V=_(""),E=_("any"),v=ie(()=>{var e;return((e=l.value)==null?void 0:e.periods)||[]}),m=_({}),O=_({}),A=_({}),F=_({}),w=(e,t)=>`${e}::${t}`;function K(e){var n;if(((n=l.value)==null?void 0:n.scope)!=="department")return null;const t=String((e==null?void 0:e.key)||"").match(/^dept:(\d+)$/);return t?Number(t[1]):null}function X(e){const t=v.value.find(n=>n.key===e);return t!=null&&t.form_id?Number(t.form_id):null}function H(e){var t;return((t=v.value.find(n=>n.key===e))==null?void 0:t.label)||e}function Q(){const e={};for(const t of s.value||[])for(const n of v.value){const o=w(t.key,n.key);e[o]=m.value[o]}A.value=e}function j(){var n,o,d;const e={},t=Object.fromEntries(v.value.map(r=>[r.key,new Set((r.completed_departments||[]).map(Number))]));for(const r of s.value||[]){const x=K(r);for(const k of v.value){let f=!1;if(x&&t[k.key].has(x))f=!0;else{const p=(n=r.cells)==null?void 0:n[k.key],C=Number((p==null?void 0:p.assigned)??0),S=Number(((o=p==null?void 0:p.incharge)==null?void 0:o.done)??0),$=Number(((d=p==null?void 0:p.coordinator)==null?void 0:d.done)??0);f=E.value==="both"?C>0&&S>=C&&$>=C:C>0&&(S>=C||$>=C)}e[w(r.key,k.key)]=f}}m.value=e,Q()}function Z(e){const t=F.value[e]||0;return Date.now()-t>=Pe}function q(e,t){const n=w(e.key,t.key);A.value[n]=m.value[n]}async function ee(e,t){var S,$,G;const n=w(e.key,t.key),o=!!m.value[n],d=!!A.value[n],r=`${(e==null?void 0:e.name)??""} • ${H(t.key)}`,x=o?"mark as Completed":"mark as Pending";if(!window.confirm(`Confirm
${r}

Do you want to ${x}?`)){m.value[n]=d;return}if(O.value[n]){m.value[n]=d,window.alert("Already updating this cell. Please wait…");return}if(!Z(n)){m.value[n]=d,window.alert("Just updated. Try again in a moment.");return}const f=X(t.key),p=K(e),C=!!(($=(S=e==null?void 0:e.cells)==null?void 0:S[t.key])!=null&&$.form_id&&f);if(((G=l.value)==null?void 0:G.scope)!=="department"||!p||!C){m.value[n]=d,window.alert("This period is not assignable (no form). Cannot update.");return}O.value[n]=!0;try{await i.setReportCompletion({form_id:f,department_id:p,completed:o}),F.value[n]=Date.now(),A.value[n]=o;const B=v.value.findIndex(D=>D.key===t.key);if(B>=0){const D=new Set((l.value.periods[B].completed_departments||[]).map(Number));o?D.add(p):D.delete(p),l.value.periods[B].completed_departments=Array.from(D)}}catch(B){m.value[n]=d,console.error(B),window.alert("Failed to update report completion.")}finally{O.value[n]=!1}}const te=(e,t)=>{var n,o,d;return!!((o=(n=e==null?void 0:e.cells)==null?void 0:n[t])!=null&&o.form_id)&&((d=l.value)==null?void 0:d.scope)==="department"};async function oe(){await i.fetchBiMonthly({year:Number(h.value),scope:g.value,department_id:I.value?Number(I.value):void 0,form_id:V.value?Number(V.value):void 0,rule:E.value}),j()}async function ne(){await i.exportBiMonthly({year:Number(h.value),scope:g.value,department_id:I.value?Number(I.value):void 0,form_id:V.value?Number(V.value):void 0,rule:E.value})}function se(e){return e?"✓":"—"}function Y(e,t,n){var r,x;const o=Number((e==null?void 0:e.assigned)??0),d=Number(n==="ic"?((r=e==null?void 0:e.incharge)==null?void 0:r.done)??0:((x=e==null?void 0:e.coordinator)==null?void 0:x.done)??0);if(o===0&&d===0){const k=n==="ic"?e==null?void 0:e.incharge:e==null?void 0:e.coordinator;if(typeof k=="boolean")return se(k)}return`${d}/${t}`}function z(e,t){var d,r;const n=Number((e==null?void 0:e.assigned)??0),o=Number(t==="ic"?((d=e==null?void 0:e.incharge)==null?void 0:d.done)??0:((r=e==null?void 0:e.coordinator)==null?void 0:r.done)??0);return n===0?"border-gray-200 bg-gray-50 text-gray-600":o>=n?"border-emerald-200 bg-emerald-50 text-emerald-700":"border-rose-200 bg-rose-50 text-rose-700"}function re(){window.print()}return le(oe),ue([s,v,E],j),(e,t)=>{var n;return c(),u("div",he,[a("div",_e,[a("div",null,[t[1]||(t[1]=a("label",{class:"text-sm text-gray-600"},"Year",-1)),J(a("input",{type:"number","onUpdate:modelValue":t[0]||(t[0]=o=>h.value=o),class:"w-28 rounded border px-2 py-1"},null,512),[[ce,h.value,void 0,{number:!0}]])]),a("button",{class:"btn-3",onClick:ne},"Excel Generate"),a("button",{class:"btn-3",onClick:re},t[2]||(t[2]=[a("i",{class:"far fa-print mr-1"},null,-1),pe("Print")]))]),N(y)?(c(),u("div",ge,[me(ve)])):N(L)?(c(),u("div",we,b(N(L)),1)):(c(),u("div",Ce,[a("table",Ne,[a("thead",null,[a("tr",Me,[t[3]||(t[3]=a("th",{rowspan:"2",class:"border px-2 py-2 text-center"},"SL",-1)),a("th",Le,b(((n=N(l))==null?void 0:n.scope)==="user"?"Employee":"Department"),1),(c(!0),u(R,null,U(v.value,o=>(c(),u("th",{key:o.key,colspan:"4",class:"border px-2 py-2 text-center font-semibold"},b(o.label),1))),128))]),a("tr",Re,[(c(!0),u(R,null,U(v.value,o=>(c(),u(R,{key:o.key+"-sub"},[t[4]||(t[4]=a("th",{class:"border px-1 py-1 text-center text-[11px]"},"Target",-1)),t[5]||(t[5]=a("th",{class:"border px-1 py-1 text-center text-[11px]"},"Report",-1)),t[6]||(t[6]=a("th",{class:"border px-1 py-1 text-center text-[11px]"},"Inch.",-1)),t[7]||(t[7]=a("th",{class:"border px-1 py-1 text-center text-[11px]"},"Coord.",-1))],64))),128))])]),a("tbody",null,[(c(!0),u(R,null,U(N(s),(o,d)=>(c(),u("tr",{key:o.key,class:"border-t"},[a("td",Se,b(d+1),1),a("td",$e,b(o.name),1),(c(!0),u(R,null,U(v.value,r=>{var x,k;return c(),u(R,{key:r.key},[a("td",Be,[((x=N(l))==null?void 0:x.scope)==="department"?(c(),u("div",De,b(o.cells[r.key].monthly_target.have||0)+" / "+b(o.cells[r.key].monthly_target.of||0),1)):T("",!0)]),a("td",Ie,[J(a("input",{type:"checkbox",disabled:!te(o,r.key)||O.value[w(o.key,r.key)],"onUpdate:modelValue":f=>m.value[w(o.key,r.key)]=f,onMousedown:f=>q(o,r),onKeydown:fe(be(f=>q(o,r),["prevent"]),["enter"]),onChange:f=>ee(o,r),title:m.value[w(o.key,r.key)]?"Completed":"Pending"},null,40,Ve),[[ye,m.value[w(o.key,r.key)]]])]),a("td",Ee,[a("span",{class:W(["inline-block text-center font-mono rounded",z(o.cells[r.key],"ic")])},b(Y(o.cells[r.key],o.employees_total,"ic")),3)]),a("td",Oe,[a("span",{class:W(["inline-block text-center font-mono rounded",z(o.cells[r.key],"co")])},b(Y(o.cells[r.key],o.employees_total,"co")),3),(k=o.cells[r.key])!=null&&k.max_total?(c(),u("div",Ae,b(o.cells[r.key].final_total)+" / "+b(o.cells[r.key].max_total),1)):T("",!0)])],64)}),128))]))),128)),!N(s)||N(s).length===0?(c(),u("tr",Ue,t[8]||(t[8]=[a("td",{colspan:"100",class:"px-3 py-6 text-center text-gray-600"},"No data",-1)]))):T("",!0)])])]))])}}},qe=xe(Te,[["__scopeId","data-v-702e91b7"]]);export{qe as default};
