import{B as Se,r as y,C as T,u as _e,f as ke,D as q,x as F,h as xe,q as O,c as h,o as m,a,j as ue,t as D,d as we,k as P,H as Ce,F as j,e as $,v as Ee,b as G,m as Ne,s as L,O as J,P as Fe}from"./index-xRQ_62kI.js";import{_ as De}from"./EmployeeFilter-ACNS-V4k.js";import{u as Ae}from"./company-D_lBB9wo.js";import{u as Me}from"./department-CIrVQAcB.js";import{u as Oe}from"./shift-Sjm4H2GJ.js";import{d as X}from"./dayjs.min-KY5zZdIN.js";import{_ as je}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./EmployeeDropdownInput-DEDKFf0c.js";import"./SelectDropdown-DXsJjjD4.js";import"./UserChip-s8R6EcAb.js";const $e=Se("shiftSchedule",()=>{const W=y([]),k=y(!1);return{schedules:W,defaultShift:k,fetchSchedules:async g=>{var C,S,Y;const r=await T.get("/shift-schedules",g);return W.value=(C=r==null?void 0:r.data)==null?void 0:C.schedules,k.value=(S=r==null?void 0:r.data)==null?void 0:S.default_shift,(Y=r.data)==null?void 0:Y.schedules},saveSchedules:async g=>{await T.post("/shift-schedules",{schedules:g==null?void 0:g.payload})},fetchDefaultSchedules:async g=>{const r=await T.get("/default-shift-schedules",g);return W.value=r==null?void 0:r.data,r.data}}}),We={class:"p-4 max-w-[1600px] mx-auto"},Be={class:"flex items-center justify-between gap-3 mb-4"},Ye={class:"text-sm text-gray-500"},Ke={class:"flex flex-wrap justify-start items-center gap-3 mb-4"},Qe=["value"],Ve={key:0,class:"text-amber-700 bg-amber-50 border border-amber-100 rounded p-2 mb-3"},He={class:"flex flex-wrap gap-3 mb-4 p-3 bg-white/70 backdrop-blur rounded sticky top-16 z-20 border"},Le=["onClick"],Ue={class:"text-sm"},ze={class:"mb-4 flex flex-wrap gap-3"},Re=["disabled"],Te=["disabled"],qe=["disabled"],Pe={class:"btn-3"},Ge=["checked"],Je={class:"overflow-auto border rounded"},Xe={class:"table-auto w-full text-sm"},Ze={class:"sticky top-0 bg-white z-10"},Ie=["title"],et={class:"font-medium leading-none"},tt={class:"text-[10px] text-gray-500"},lt={class:"border p-2"},at={class:"flex items-center gap-2"},st=["value"],ot={class:"min-w-0"},nt={class:"font-medium leading-tight"},rt={class:"border p-2"},ut=["onClick","disabled"],it=["onClick","title"],dt={key:0},ct={class:"flex justify-center mt-5"},vt=["disabled"],ft={__name:"ShiftScheduleForm",setup(W){const k=$e(),Z=Ae(),B=Oe(),U=Me(),g=_e(),r=ke(),{defaultShift:C}=q(k),{employees:S}=q(Z),{shifts:Y}=q(B),d=y(X().format("YYYY-MM")),p=y(""),b=y(""),x=y(""),c=y(""),u=y({}),_=y([]),w=y("all"),I=y(!1),z=y(!1),A=y({WEEKEND:"#B91C1C",HOLIDAY:"#6B7280"}),ee=["#FF5733","#33C1FF","#33FF57","#FF33D4","#FFD633","#7D33FF","#FF8C33","#33FFF0","#B833FF","#3375FF","#FF3333","#33FFAA"],te=t=>e=>(e||[]).find(s=>Number(s==null?void 0:s.id)===Number(t)),K=F(()=>{const t=Y.value||{};return Array.isArray(t)?t:Object.values(t).flat()});function le(){let t=0;K.value.forEach(e=>{const s=String(e.id);A.value[s]||(A.value[s]=ee[t%ee.length],t++)})}const Q=F(()=>Array.from({length:X(d.value).daysInMonth()},(t,e)=>e+1)),ae=t=>{const e=`${d.value}-${String(t).padStart(2,"0")}`;return X(e).format("ddd")},v=F(()=>(_.value||[]).map(t=>Number(t)).filter(Number.isFinite)),se=F(()=>new Set(v.value)),E=t=>se.value.has(Number(t)),i=t=>String(t),ie=(t,e)=>{var o,n;const s=(n=(o=u.value)==null?void 0:o[i(t)])==null?void 0:n[e];return s?{backgroundColor:A.value[String(s)]||"#D1D5DB"}:{backgroundColor:"#E5E7EB"}},de=(t,e)=>{var o,n;const s=(n=(o=u.value)==null?void 0:o[i(t)])==null?void 0:n[e];if(s==="WEEKEND"||s==="HOLIDAY")return s;const l=te(s)(K.value);return(l==null?void 0:l.name)||""};function ce(t,e){E(t)&&c.value&&(u.value[i(t)]||(u.value[i(t)]={}),u.value[i(t)][e]=c.value)}function oe(t){E(t)&&c.value&&(u.value[i(t)]||(u.value[i(t)]={}),Q.value.forEach(e=>{u.value[i(t)][e]=c.value}))}function ve(){!v.value.length||!c.value||v.value.forEach(oe)}function fe(){v.value.length&&v.value.forEach(t=>{var l;const e=te(t)(S.value),s=(((l=e==null?void 0:e.assign_weekend)==null?void 0:l.weekends)||[]).map(o=>String(o).slice(0,3));u.value[i(t)]||(u.value[i(t)]={}),Q.value.forEach(o=>{const n=ae(o);s.includes(n)&&(u.value[i(t)][o]="WEEKEND")})})}function pe(){v.value.length&&v.value.forEach(t=>{u.value[i(t)]&&(u.value[i(t)]={})})}async function ne(){if(!v.value.length){alert("Select at least one employee.");return}const t=[];for(const[e,s]of Object.entries(u.value||{})){const l=Number(e);if(se.value.has(l))for(const[o,n]of Object.entries(s||{})){const f=Number(o);if(!f||!n)continue;const N=`${d.value}-${String(f).padStart(2,"0")}`;let H=null,M=null;n==="WEEKEND"||n==="HOLIDAY"?M=n:H=Number(n),t.push({employee_id:l,date:N,shift_id:H,status:M})}}if(!t.length){alert("No schedule data to save for checked employees.");return}try{await k.saveSchedules({payload:t}),alert("Shift schedule saved successfully!")}catch(e){console.error("Failed to save schedule",e),alert("Something went wrong while saving.")}}async function R(t,e,s){try{if(!t||!e||!s){alert("Company, Department, and Month are required to load schedule.");return}u.value={},C.value=!1;let o=await k.fetchSchedules({params:{company_id:Number(t),department_id:Number(e),month:s}})||[];if(!o.length){const f=await k.fetchDefaultSchedules({params:{company_id:Number(t),department_id:Number(e),month:s}});console.warn("[Fallback Schedule Loaded]",f),alert("No saved schedule found. Default schedule loaded."),o=f||[],C.value=!0}const n={};o.forEach(f=>{const N=Number(f==null?void 0:f.employee_id),H=String((f==null?void 0:f.date)||"").split("-")[2],M=Number(H);!N||!M||(n[i(N)]||(n[i(N)]={}),n[i(N)][M]=f.shift_id??f.status)}),u.value=n}catch(l){console.error("Failed to load schedule data:",l),alert("Error loading schedule. Please try again or contact admin.")}}async function re(t){if(!t)return S.value=[],_.value=[],[];const s=await U.fetchDepartmentEmployee([Number(t)],w.value)||[];return S.value=s,_.value=_.value.filter(l=>s.some(o=>Number(o==null?void 0:o.id)===Number(l))),s}const he=F(()=>({company_id:p.value,department_id:b.value,line_type:w.value,employee_id:x.value,month:d.value})),me=t=>Object.fromEntries(Object.entries(t||{}).filter(([,e])=>e!==""&&e!==null&&e!==void 0));function ye(t={}){const e={...r.query,...t},s=me(e);Object.keys(s).length===Object.keys(r.query).length&&Object.entries(s).every(([o,n])=>String(r.query[o]??"")===String(n??""))||g.replace({query:s}).catch(()=>{})}function be(t=r.query){z.value=!0,p.value=t.company_id||"",b.value=t.department_id||"",x.value=t.employee_id||"",w.value=t.line_type||"all",d.value=t.month||d.value,z.value=!1,I.value=!0}xe(()=>{be()}),O(p,async t=>{t&&(b.value="",_.value=[],S.value=[],u.value={},await U.fetchDepartments({company_id:Number(t)}),await B.fetchShifts({company_id:Number(t)}),le())}),O(b,async t=>{t&&(await re(t),!(!p.value||!d.value)&&await R(p.value,t,d.value))}),O(w,async()=>{b.value&&(await re(b.value),!(!p.value||!d.value)&&await R(p.value,b.value,d.value))}),O(d,async t=>{!t||!p.value||!b.value||(await B.fetchShifts({company_id:Number(p.value)}),le(),await R(p.value,b.value,t))}),O(he,t=>{!I.value||z.value||ye(t)},{deep:!0});const V=F(()=>{if(!x.value)return S.value||[];const t=Number(x.value);return(S.value||[]).filter(e=>Number(e==null?void 0:e.id)===t)});function ge(t){t?_.value=V.value.map(e=>Number(e.id)):_.value=[]}return(t,e)=>{var s;return m(),h("div",We,[a("div",Be,[e[10]||(e[10]=a("h2",{class:"text-center text-2xl font-semibold"},"Monthly Shift Schedule Plan",-1)),a("div",Ye,"Month: "+D(d.value),1)]),a("div",Ke,[we(De,{company_id:p.value,"onUpdate:company_id":e[0]||(e[0]=l=>p.value=l),department_id:b.value,"onUpdate:department_id":e[1]||(e[1]=l=>b.value=l),line_type:w.value,"onUpdate:line_type":e[2]||(e[2]=l=>w.value=l),employee_id:x.value,"onUpdate:employee_id":e[3]||(e[3]=l=>x.value=l),"initial-value":{company_id:p.value,department_id:b.value,line_type:w.value,employee_id:x.value}},null,8,["company_id","department_id","line_type","employee_id","initial-value"]),P(a("select",{"onUpdate:modelValue":e[4]||(e[4]=l=>c.value=l),class:"px-2 py-2 border rounded"},[e[11]||(e[11]=a("option",{value:""},"- Pick a Shift -",-1)),(m(!0),h(j,null,$(K.value,l=>(m(),h("option",{key:l.id,value:l.id},D(l.name),9,Qe))),128))],512),[[Ce,c.value]]),P(a("input",{type:"month","onUpdate:modelValue":e[5]||(e[5]=l=>d.value=l),class:"h-10 px-2 border rounded"},null,512),[[Ee,d.value]])]),e[19]||(e[19]=a("p",{class:"text-sky-800 bg-sky-50 border border-sky-200 rounded p-2 mb-3"},[G(" ✔ Only "),a("b",null,"checked"),G(" employees are editable & will be saved. ")],-1)),Ne(C)?(m(),h("p",Ve," ⚠ Showing default schedule from current shift. Select employees manually before saving. ")):ue("",!0),a("div",He,[(m(!0),h(j,null,$(K.value,l=>(m(),h("div",{key:l.id,class:L(["flex items-center gap-2 cursor-pointer px-2 py-1 rounded border hover:bg-gray-50",{"ring-2 ring-blue-500":String(c.value)===String(l.id)}]),onClick:o=>c.value=l.id},[a("div",{class:"w-4 h-4 rounded",style:J({backgroundColor:A.value[String(l.id)]||"#ccc"})},null,4),a("span",Ue,D(l.name),1)],10,Le))),128)),a("div",{class:L(["flex items-center gap-2 cursor-pointer px-2 py-1 rounded border hover:bg-gray-50",{"ring-2 ring-blue-500":c.value==="HOLIDAY"}]),onClick:e[6]||(e[6]=l=>c.value="HOLIDAY")},e[12]||(e[12]=[a("div",{class:"w-5 h-5 rounded bg-gray-500"},null,-1),a("span",{class:"text-sm"},"Holiday",-1)]),2),a("div",{class:L(["flex items-center gap-2 cursor-pointer px-2 py-1 rounded border hover:bg-gray-50",{"ring-2 ring-blue-500":c.value==="WEEKEND"}]),onClick:e[7]||(e[7]=l=>c.value="WEEKEND")},[a("div",{class:"w-5 h-5 rounded",style:J({backgroundColor:A.value.WEEKEND})},null,4),e[13]||(e[13]=a("span",{class:"text-sm"},"Weekend",-1))],2)]),a("div",ze,[a("button",{onClick:ve,class:"btn-4 bg-indigo-600 hover:bg-indigo-700 text-white",disabled:!v.value.length||!c.value,title:"Set selected shift to all days for checked employees"}," Set Shift → Checked (All Dates) ",8,Re),a("button",{onClick:fe,class:"btn-4 bg-red-700 hover:bg-red-800 text-white",disabled:!v.value.length,title:"Mark employee-specific weekends for checked employees"}," Set Weekends → Checked ",8,Te),a("button",{onClick:pe,class:"btn-4 bg-gray-700 hover:bg-gray-800 text-white",disabled:!v.value.length}," Clear (Checked) ",8,qe),a("div",{class:"justify-end flex-grow"},[a("button",{onClick:ne,class:"btn-2"}," Save (Checked only) ")]),a("label",Pe,[a("input",{type:"checkbox",checked:v.value.length&&v.value.length===V.value.length,onChange:e[8]||(e[8]=l=>ge(l.target.checked))},null,40,Ge),e[14]||(e[14]=a("span",null,"Select all (visible)",-1))])]),a("div",Je,[a("table",Xe,[a("thead",Ze,[a("tr",null,[e[15]||(e[15]=a("th",{class:"border p-2 text-left w-40"},"Employee",-1)),e[16]||(e[16]=a("th",{class:"border p-2 w-40"},"Quick Action",-1)),(m(!0),h(j,null,$(Q.value,l=>(m(),h("th",{key:l,class:"border text-center p-1 min-w-[46px]",title:`${d.value}-${String(l).padStart(2,"0")}`},[a("div",et,D(l),1),a("div",tt,D(ae(l)),1)],8,Ie))),128))])]),a("tbody",null,[(m(!0),h(j,null,$(V.value,l=>(m(),h("tr",{key:l.id,class:"odd:bg-white even:bg-gray-50"},[a("td",lt,[a("label",at,[P(a("input",{type:"checkbox",class:"rounded",value:l.id,"onUpdate:modelValue":e[9]||(e[9]=o=>_.value=o)},null,8,st),[[Fe,_.value]]),a("div",ot,[a("div",nt,D(l.name),1)])])]),a("td",rt,[a("button",{class:"btn-4 cursor-pointer",onClick:o=>oe(l.id),disabled:!c.value||!E(l.id)}," Selected shift to all dates ",8,ut)]),(m(!0),h(j,null,$(Q.value,o=>(m(),h("td",{key:o,class:L(["border text-center",E(l.id)?"cursor-pointer hover:bg-gray-100":"cursor-not-allowed opacity-60"]),onClick:n=>E(l.id)&&ce(l.id,o),title:E(l.id)?de(l.id,o)||"Click to set":"Check this employee to edit"},[a("div",{style:J(ie(l.id,o)),class:"w-full h-6 rounded transition"},null,4)],10,it))),128))]))),128)),(s=V.value)!=null&&s.length?ue("",!0):(m(),h("tr",dt,e[17]||(e[17]=[a("td",{colspan:"999",class:"text-center text-gray-500 p-6"}," No employees found for current filter. ",-1)])))])])]),a("div",ct,[a("button",{onClick:ne,class:"btn-2",disabled:!v.value.length,title:"Saves only checked employees"},e[18]||(e[18]=[a("i",null,null,-1),G(" Save (Checked only) ")]),8,vt)])])}}},wt=je(ft,[["__scopeId","data-v-93927736"]]);export{wt as default};
