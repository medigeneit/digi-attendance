import{d as J,u as O,b as P,A as G,p as k,r as _,e as K,a4 as Q,y as j,B as X,c as m,o as p,a as t,f as Z,s as C,i as ee,j as ae,w as te,g as T,h as f,v as x,t as L,F as M,q as F,k as H,a5 as A}from"./index-BKgdzu_o.js";import{L as se}from"./LoaderView-GlVQbooq.js";import{_ as le}from"./MultiselectDropdown--D_JOU0T.js";import{u as oe}from"./holiday-DIG_Y37_.js";import{u as ne}from"./leave-application-DVbdDwsl.js";import{u as re}from"./leave-type-BBkJCeqi.js";import{u as de}from"./user-HxOpoM6x.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./MultiselectDropdown.vue_vue_type_style_index_0_lang-BjZXIyMm.js";const ie={class:"my-container max-w-3xl space-y-4"},ue={class:"flex items-center justify-between gap-2"},ve={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},pe={key:0,class:""},me={class:"text-blue-600 font-medium"},ce={key:1,class:"bg-gray-100 p-2 rounded-md"},_e={class:"font-semibold"},fe={class:"flex flex-wrap gap-2"},ye=["name","value","onUpdate:modelValue","disabled"],we={class:"flex items-center space-x-1"},ge=["name","onUpdate:modelValue"],ke={class:"flex items-center space-x-1"},he=["name","onUpdate:modelValue"],be={key:2,class:"text-red-500 text-sm"},Re={__name:"LeaveApplicationEdit",setup(De){const S=J(),v=ne(),E=O(),B=P(),N=re(),c=de(),{userLeaveBalance:y}=G(c),R=oe(),U=k(()=>v.leaveApplication),W=k(()=>B.params.id),h=_(null),r=_({user_id:"",last_working_date:"",resumption_date:"",reason:"",works_in_hand:"",handover_user_id:"",leave_days:[]}),d=_([]),V=_([]),w=_(!1),b=_(null),$=_(!1),q=k(()=>{var n,e,s,a,l;return((s=(e=(n=v==null?void 0:v.leaveApplication)==null?void 0:n.user)==null?void 0:e.assign_weekend)==null?void 0:s.weekends)||((l=(a=v==null?void 0:v.leaveApplication)==null?void 0:a.user)==null?void 0:l.weekends)||[]});K(async()=>{var n;w.value=!0;try{const{id:e}=B.params;$.value=!!e,await v.fetchLeaveApplicationById(e);const s=v.leaveApplication,a=s==null?void 0:s.user;if(!s||!a)return;const l=s.user_id,o=(n=a==null?void 0:a.company)==null?void 0:n.id;if(o&&await N.fetchLeaveTypes(o),l&&await c.fetchUserLeaveBalances(l),await c.fetchTypeWiseEmployees({type:a.type,except:[a.id]}),c.users=c.users.map(u=>({...u,label:u.name})),c.users.length>0){const u=c.users.find(g=>g.id===s.handover_user_id);u&&(h.value=u)}r.value={user_id:s.user_id,last_working_date:s.last_working_date,resumption_date:s.resumption_date,reason:s.reason,works_in_hand:s.works_in_hand,handover_user_id:s.handover_user_id,leave_days:s.leave_days},s.json_data&&Array.isArray(s.json_data)&&s.json_data.forEach((u,g)=>{var D;d.value[g]=u.leave_type_id||((D=y.value[0])==null?void 0:D.id)})}catch(e){console.error("Failed to load leave application:",e)}finally{w.value=!1}});const i=k(()=>{const n=r.value.last_working_date,e=r.value.resumption_date;if(!n||!e)return[];const s=new Date(n),a=new Date(e);if(a<=s)return[];const l=[];let o=new Date(s);for(o.setDate(o.getDate()+1);o<a;){const u=o.getFullYear(),g=(o.getMonth()+1).toString().padStart(2,"0"),D=o.getDate().toString().padStart(2,"0");l.push(`${u}-${g}-${D}`),o.setDate(o.getDate()+1)}return l}),I=k(()=>{const n=r.value.last_working_date,e=r.value.resumption_date;if(!n||!e)return"";const s=new Date(n);return new Date(e)<=s?"Resumption date must be after Last Working Date.":i.value.length===0?"No leave days between the selected dates.":`Total leave days: ${i.value.length}`});Q(async()=>{var n;i.value.length&&y.value.length&&(d.value.length!==i.value.length&&(d.value=i.value.map(()=>{var e;return(e=y.value[0])==null?void 0:e.id})),await R.fetchHolidays({company_id:(n=S==null?void 0:S.user)==null?void 0:n.company_id,start_date:i.value[0],end_date:i.value[i.value.length-1]}),i.value.forEach(async(e,s)=>{const a=new Date(e).toLocaleString("en-us",{weekday:"long"}).toLowerCase(),l=a.charAt(0).toUpperCase()+a.slice(1);q.value.includes(l)&&(d.value[s]="weekend"),R.holidayDates.includes(e)&&(d.value[s]="holiday")}))}),j(()=>h.value,n=>{r.value.handover_user_id=n==null?void 0:n.id}),j(d,n=>{const e={};n.forEach(a=>{typeof a=="number"&&(e[a]=(e[a]||0)+1)});const s=y.value.filter(a=>(e[a.id]||0)>a.remaining_days);s.length?(V.value=s.map(a=>a.name),alert(`You have exceeded remaining days for: ${V.value.join(", ")}`)):V.value=[]});const Y=async()=>{var n;w.value=!0,b.value=null;try{const e=i.value.map((l,o)=>({date:l,leave_type_id:d.value[o]!=="weekend"&&d.value[o]!=="holiday"?d.value[o]:null})).filter(l=>l.leave_type_id!==null),s=i.value.map((l,o)=>({date:l,leave_type_id:d.value[o]||""})),a={id:W.value,user_id:(n=U==null?void 0:U.value)==null?void 0:n.user_id,last_working_date:r.value.last_working_date,resumption_date:r.value.resumption_date,reason:r.value.reason,works_in_hand:r.value.works_in_hand,handover_user_id:r.value.handover_user_id,leave_days:e,json_data:s};if(a.id){const l=await v.updateLeaveApplication(a.id,a);l&&E.push({name:"LeaveApplicationShow",params:{id:l==null?void 0:l.id}})}}catch(e){b.value=e.message||"Failed to submit leave application"}finally{w.value=!1}},z=()=>E.go(-1);return(n,e)=>{const s=X("RouterLink");return p(),m("div",ie,[t("div",ue,[t("button",{class:"btn-3",onClick:z},e[5]||(e[5]=[t("i",{class:"far fa-arrow-left"},null,-1),t("span",{class:"hidden md:flex"},"Back",-1)])),e[7]||(e[7]=t("h1",{class:"title-md md:title-lg flex-wrap text-center"},"Leave Application Edit Form",-1)),t("div",null,[C(s,{to:"/applications",class:"btn-2"},{default:ee(()=>e[6]||(e[6]=[ae("Home")])),_:1,__:[6]})])]),w.value?(p(),Z(se,{key:0})):(p(),m("form",{key:1,onSubmit:te(Y,["prevent"]),class:"space-y-4 card-bg p-4 md:p-8"},[t("div",ve,[t("div",null,[e[8]||(e[8]=t("label",{for:"last-working-date",class:"block text-sm font-medium"},"Last Working Date",-1)),f(t("input",{type:"date",id:"last-working-date","onUpdate:modelValue":e[0]||(e[0]=a=>r.value.last_working_date=a),class:"input-1 w-full",required:""},null,512),[[x,r.value.last_working_date]])]),t("div",null,[e[9]||(e[9]=t("label",{for:"resumption-date",class:"block text-sm font-medium"},"Resumption Date",-1)),f(t("input",{type:"date",id:"resumption-date","onUpdate:modelValue":e[1]||(e[1]=a=>r.value.resumption_date=a),class:"input-1 w-full",required:""},null,512),[[x,r.value.resumption_date]])])]),r.value.last_working_date&&r.value.resumption_date?(p(),m("div",pe,[t("p",me,L(I.value),1)])):T("",!0),i.value.length?(p(),m("div",ce,[e[12]||(e[12]=t("h2",{class:"text-lg font-semibold"},"Leave Days",-1)),t("div",null,[(p(!0),m(M,null,F(i.value,(a,l)=>(p(),m("div",{key:l,class:"flex gap-4 mb-2 bg-white p-2 rounded-md"},[t("div",_e,L(a),1),t("div",fe,[(p(!0),m(M,null,F(H(y),o=>(p(),m("label",{key:o.id,class:"flex items-center space-x-1"},[f(t("input",{type:"radio",name:"leaveType-"+l,value:o.id,"onUpdate:modelValue":u=>d.value[l]=u,disabled:d.value.filter(u=>u===o.id).length>=o.remaining_days},null,8,ye),[[A,d.value[l]]]),t("span",null,L(o.leave_type),1)]))),128)),t("label",we,[f(t("input",{type:"radio",name:"leaveType-"+l,value:"weekend","onUpdate:modelValue":o=>d.value[l]=o},null,8,ge),[[A,d.value[l]]]),e[10]||(e[10]=t("span",null,"Weekend",-1))]),t("label",ke,[f(t("input",{type:"radio",name:"leaveType-"+l,value:"holiday","onUpdate:modelValue":o=>d.value[l]=o},null,8,he),[[A,d.value[l]]]),e[11]||(e[11]=t("span",null," Holiday",-1))])])]))),128))])])):T("",!0),t("div",null,[e[13]||(e[13]=t("label",{for:"reason",class:"block text-sm font-medium"},"Reason",-1)),f(t("textarea",{id:"reason","onUpdate:modelValue":e[2]||(e[2]=a=>r.value.reason=a),class:"input-1 w-full",placeholder:"Enter your reason for leave"},null,512),[[x,r.value.reason]])]),t("div",null,[e[14]||(e[14]=t("label",{for:"handover-user",class:"block text-sm font-medium"},"Handover User",-1)),C(le,{modelValue:h.value,"onUpdate:modelValue":e[3]||(e[3]=a=>h.value=a),options:H(c).users,multiple:!1,label:"label",placeholder:"Select user"},null,8,["modelValue","options"])]),t("div",null,[e[15]||(e[15]=t("label",{for:"works-in-hand",class:"block text-sm font-medium"},"Works in Hand",-1)),f(t("textarea",{id:"works-in-hand","onUpdate:modelValue":e[4]||(e[4]=a=>r.value.works_in_hand=a),class:"input-1 w-full",placeholder:"Enter details of works in hand",rows:"6"},null,512),[[x,r.value.works_in_hand]])]),b.value?(p(),m("div",be,L(b.value),1)):T("",!0),e[16]||(e[16]=t("div",{class:"flex justify-end"},[t("button",{type:"submit",class:"btn-1"},"Update")],-1))],32))])}}};export{Re as default};
