import{g as se,u as ae,f as le,D as oe,x as f,r as w,h as ne,q,p as re,c as m,o as p,a as s,j as ie,d as O,m as de,b as U,w as ue,k as y,l as g,v as V,t as c,F as P,e as Y,s as T,n as z,ae as R}from"./index-Bkmvuqye.js";import{L as pe}from"./LoaderView-Bb7zQQ2Q.js";import{_ as me}from"./MultiselectDropdown-xlRaBFnQ.js";import{u as ce}from"./holiday-39WGkHaL.js";import{u as ve}from"./leave-application-DTgEGpxt.js";import{u as fe}from"./leave-type-gDZPq56H.js";import{u as xe}from"./user-CzzSlHBT.js";const be={class:"my-container max-w-4xl space-y-6"},ge={class:"rounded-2xl border border-slate-200 bg-white/80 p-4 shadow-sm md:p-6"},_e={class:"flex flex-wrap items-center justify-between gap-3"},we={class:"grid grid-cols-1 gap-4 md:grid-cols-2"},ye={key:0,class:"rounded-lg bg-blue-50 p-3 text-sm text-blue-700"},he={key:1,class:"grid gap-3 rounded-xl border border-slate-100 bg-slate-50 p-4 sm:grid-cols-2 lg:grid-cols-4"},ke={class:"rounded-lg bg-white p-3 shadow-sm"},De={class:"text-2xl font-semibold text-slate-800"},Se={class:"rounded-lg bg-white p-3 shadow-sm"},Le={class:"text-xl font-semibold text-slate-800"},Ue={class:"rounded-lg bg-white p-3 shadow-sm"},Ve={class:"text-xl font-semibold text-slate-800"},Te={class:"rounded-lg bg-white p-3 shadow-sm"},Ae={class:"text-xl font-semibold text-amber-600"},Ne={key:2,class:"flex items-start gap-3 rounded-lg border border-amber-200 bg-amber-50/80 p-4 text-amber-800 shadow-sm"},je={class:"text-sm"},Me={key:3,class:"space-y-4"},Re={class:"max-h-[28rem] space-y-3 overflow-y-auto pr-1"},Be={class:"flex flex-wrap items-center justify-between gap-3"},Ie={class:"font-semibold text-slate-900"},We={class:"mt-3 flex flex-wrap gap-2"},He=["name","value","onUpdate:modelValue","disabled"],$e=["name","onUpdate:modelValue"],Ce=["name","onUpdate:modelValue"],Fe={class:"space-y-1"},Ee={class:"space-y-1"},qe={class:"space-y-1"},Oe={key:4,class:"flex items-start gap-3 rounded-lg border border-red-200 bg-red-50 p-4 text-red-700 shadow-sm"},Pe={class:"flex-1 text-sm leading-5"},Ye={class:"mt-0.5"},tt={__name:"LeaveApplicationEdit",setup(ze){se();const D=ve(),J=fe(),v=xe();ce();const B=ae(),I=le(),{userLeaveBalance:A}=oe(v),N=f(()=>D.leaveApplication),W=f(()=>I.params.id),S=w(null),r=w({user_id:"",last_working_date:"",resumption_date:"",reason:"",works_in_hand:"",handover_user_id:""}),n=w({}),h=w(!1),L=w(null),G=w(!1),K=a=>{const e=a.getFullYear(),l=String(a.getMonth()+1).padStart(2,"0"),t=String(a.getDate()).padStart(2,"0");return`${e}-${l}-${t}`},x=f(()=>{const a=r.value.last_working_date,e=r.value.resumption_date;if(!a||!e)return[];const l=new Date(a),t=new Date(e);if(t<=l)return[];const o=[],i=new Date(l);for(i.setDate(i.getDate()+1);i<t;)o.push(K(i)),i.setDate(i.getDate()+1);return o}),H=f(()=>{const a=r.value.last_working_date,e=r.value.resumption_date;if(!a||!e)return"";const l=new Date(a);return new Date(e)<=l?"Resumption date must be after Last Working Date.":x.value.length===0?"No leave days between the selected dates.":null}),_=f(()=>{const a=x.value.length;if(!a)return{total:0,weekends:0,holidays:0,assigned:0,pending:0};let e=0,l=0,t=0;x.value.forEach(i=>{var d;const u=(d=n.value)==null?void 0:d[i];u==="weekend"?e+=1:u==="holiday"?l+=1:u&&(t+=1)});const o=Math.max(a-(e+l+t),0);return{total:a,weekends:e,holidays:l,assigned:t,pending:o}}),j=f(()=>{const a={};for(const[e,l]of Object.entries(n.value||{}))typeof l=="number"&&(a[l]=(a[l]||0)+1);return a}),M=a=>{const e=Number(a==null?void 0:a.remaining_days);return Number.isFinite(e)?e:1/0},$=f(()=>{const a=A.value||[],e=[];for(const l of a){const t=j.value[l.id]||0,o=M(l);o!==1/0&&t>o&&e.push({id:l.id,name:l.leave_type||l.name,used:t,remain:o})}return e}),C=f(()=>{if(!$.value.length)return"";const a=$.value[0];return`You requested ${a.used} ${a.name} day(s) but only ${a.remain} remaining.`}),Q=a=>new Date(a).toLocaleString("en-us",{weekday:"long"}),X=a=>{var l;const e=(l=A.value)==null?void 0:l.find(t=>t.id===a);return(e==null?void 0:e.name)||(e==null?void 0:e.leave_type)||""},Z=a=>{const e=M(a);if(e===1/0)return"âˆž";const l=j.value[a.id]||0;return Math.max(e-l,0)},F=(a,e)=>{const l=M(a);return l===1/0||e===a.id?!1:(j.value[a.id]||0)>=l},E=()=>{const a=n.value||{},e={};for(const l of x.value)Object.prototype.hasOwnProperty.call(a,l)&&(e[l]=a[l]);n.value=e};ne(async()=>{var a,e;h.value=!0;try{const{id:l}=I.params;G.value=!!l,await D.fetchLeaveApplicationById(l);const t=D.leaveApplication,o=t==null?void 0:t.user;if(!t||!o)return;const i=(a=o==null?void 0:o.company)==null?void 0:a.id;if(i&&await J.fetchLeaveTypes(i),t.user_id&&await v.fetchUserLeaveBalances(t.user_id,{applicationId:W.value}),await v.fetchTypeWiseEmployees({type:o.type,except:[o.id]}),v.users=v.users.map(d=>({...d,label:d.name})),(e=v.users)!=null&&e.length){const d=v.users.find(k=>k.id===t.handover_user_id);d&&(S.value=d)}r.value={user_id:t.user_id,last_working_date:t.last_working_date,resumption_date:t.resumption_date,reason:t.reason,works_in_hand:t.works_in_hand,handover_user_id:t.handover_user_id};const u={};if(Array.isArray(t.json_data))for(const d of t.json_data){const k=d==null?void 0:d.date,b=d==null?void 0:d.leave_type_id;k&&(b==="weekend"||b==="holiday"?u[k]=b:b!=null&&b!==""&&!Number.isNaN(Number(b))&&(u[k]=Number(b)))}n.value=u,E()}catch(l){console.error(l)}finally{h.value=!1}}),q(()=>[r.value.last_working_date,r.value.resumption_date],()=>{E()}),q(()=>S.value,a=>{r.value.handover_user_id=(a==null?void 0:a.id)||null});const ee=async()=>{var a;h.value=!0,L.value=null;try{const e=x.value,l=[],t=[];for(const i of e){const u=n.value[i],d=u!=="weekend"&&u!=="holiday"&&u!=null?Number(u):null;d!=null&&l.push({date:i,leave_type_id:d}),t.push({date:i,leave_type_id:u??""})}const o={id:W.value,user_id:(a=N==null?void 0:N.value)==null?void 0:a.user_id,last_working_date:r.value.last_working_date,resumption_date:r.value.resumption_date,reason:r.value.reason,works_in_hand:r.value.works_in_hand,handover_user_id:r.value.handover_user_id,leave_days:l,json_data:t};if(o.id){const i=await D.updateLeaveApplication(o.id,o);i&&B.push({name:"LeaveApplicationShow",params:{id:i==null?void 0:i.id}})}}catch(e){L.value=(e==null?void 0:e.message)||"Failed to submit leave application"}finally{h.value=!1}},te=()=>B.go(-1);return(a,e)=>{const l=re("RouterLink");return p(),m("div",be,[s("section",ge,[s("div",_e,[s("button",{class:"btn-3",onClick:te},e[5]||(e[5]=[s("i",{class:"far fa-arrow-left"},null,-1),s("span",{class:"hidden md:flex"},"Back",-1)])),e[7]||(e[7]=s("div",{class:"text-center"},[s("h1",{class:"title-md md:title-lg"},"Update Leave Plan"),s("p",{class:"text-xs text-slate-500 md:text-sm"}," Adjust your dates, reassign types, and keep approvers in the loop. ")],-1)),O(l,{to:"/applications",class:"btn-2"},{default:de(()=>e[6]||(e[6]=[U("Home")])),_:1,__:[6]})])]),h.value?(p(),ie(pe,{key:0})):(p(),m("form",{key:1,onSubmit:ue(ee,["prevent"]),class:"relative space-y-6 rounded-2xl border border-slate-200 bg-white/80 p-4 pb-24 shadow-lg md:p-8 md:pb-28"},[s("div",we,[s("div",null,[e[8]||(e[8]=s("label",{for:"last-working-date",class:"block text-sm font-medium text-slate-600"},"Last Working Date",-1)),g(s("input",{type:"date",id:"last-working-date","onUpdate:modelValue":e[0]||(e[0]=t=>r.value.last_working_date=t),class:"input-1 mt-1 w-full",required:""},null,512),[[V,r.value.last_working_date]])]),s("div",null,[e[9]||(e[9]=s("label",{for:"resumption-date",class:"block text-sm font-medium text-slate-600"},"Resumption Date",-1)),g(s("input",{type:"date",id:"resumption-date","onUpdate:modelValue":e[1]||(e[1]=t=>r.value.resumption_date=t),class:"input-1 mt-1 w-full",required:""},null,512),[[V,r.value.resumption_date]])])]),r.value.last_working_date&&r.value.resumption_date&&H.value?(p(),m("div",ye,c(H.value),1)):y("",!0),_.value.total?(p(),m("div",he,[s("div",ke,[e[10]||(e[10]=s("p",{class:"text-xs uppercase text-slate-400"},"Total Days",-1)),s("p",De,c(_.value.total),1)]),s("div",Se,[e[11]||(e[11]=s("p",{class:"text-xs uppercase text-slate-400"},"Assigned",-1)),s("p",Le,c(_.value.assigned),1),e[12]||(e[12]=s("p",{class:"text-xs text-slate-500"},"Leave types selected",-1))]),s("div",Ue,[e[13]||(e[13]=s("p",{class:"text-xs uppercase text-slate-400"},"Weekend / Holiday",-1)),s("p",Ve,c(_.value.weekends+_.value.holidays),1),e[14]||(e[14]=s("p",{class:"text-xs text-slate-500"},"Auto-excluded",-1))]),s("div",Te,[e[15]||(e[15]=s("p",{class:"text-xs uppercase text-slate-400"},"Still Unassigned",-1)),s("p",Ae,c(_.value.pending),1),e[16]||(e[16]=s("p",{class:"text-xs text-slate-500"},"Select a leave type below",-1))])])):y("",!0),C.value?(p(),m("div",Ne,[e[17]||(e[17]=s("i",{class:"fas fa-info-circle mt-1 text-amber-500"},null,-1)),s("p",je,c(C.value),1)])):y("",!0),x.value.length?(p(),m("div",Me,[e[20]||(e[20]=s("div",{class:"flex flex-wrap items-center justify-between gap-2"},[s("h2",{class:"text-lg font-semibold text-slate-700"},"Leave Days"),s("p",{class:"text-xs text-slate-500"},"Tap a badge to classify each date")],-1)),s("div",Re,[(p(!0),m(P,null,Y(x.value,t=>(p(),m("div",{key:t,class:"rounded-2xl border border-slate-100 bg-white p-4 shadow-sm transition hover:border-blue-200 hover:shadow-md"},[s("div",Be,[s("div",null,[s("p",Ie,c(t)+" ("+c(Q(t))+")",1)]),n.value[t]?(p(),m("span",{key:0,class:T(["inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold",{"bg-amber-50 text-amber-700":n.value[t]==="weekend","bg-emerald-50 text-emerald-700":n.value[t]==="holiday","bg-blue-50 text-blue-700":n.value[t]!=="weekend"&&n.value[t]!=="holiday"}])},c(n.value[t]==="weekend"?"Weekend":n.value[t]==="holiday"?"Holiday":X(n.value[t])),3)):y("",!0)]),s("div",We,[(p(!0),m(P,null,Y(z(A),o=>(p(),m("label",{key:o.id,class:T(["cursor-pointer rounded-full border px-3 py-1 text-sm font-medium transition",[n.value[t]===o.id?"border-blue-500 bg-blue-50 text-blue-700":"border-slate-200 text-slate-600",F(o,n.value[t])?"cursor-not-allowed opacity-40":""]])},[g(s("input",{type:"radio",class:"sr-only",name:"leaveType-"+t,value:o.id,"onUpdate:modelValue":i=>n.value[t]=i,disabled:F(o,n.value[t])},null,8,He),[[R,n.value[t]]]),s("span",null,c(o.name)+" ("+c(Z(o))+")",1)],2))),128)),s("label",{class:T(["cursor-pointer rounded-full px-3 py-1 text-sm font-medium transition",n.value[t]==="weekend"?"border-amber-400 bg-amber-50 text-amber-700":"border-slate-200 text-slate-600 hover:border-amber-200 hover:text-amber-700"])},[g(s("input",{type:"radio",class:"sr-only",name:"leaveType-"+t,value:"weekend","onUpdate:modelValue":o=>n.value[t]=o},null,8,$e),[[R,n.value[t]]]),e[18]||(e[18]=U(" Weekend "))],2),s("label",{class:T(["cursor-pointer rounded-full px-3 py-1 text-sm font-medium transition",n.value[t]==="holiday"?"border-emerald-400 bg-emerald-50 text-emerald-700":"border-slate-200 text-slate-600 hover:border-emerald-200 hover:text-emerald-700"])},[g(s("input",{type:"radio",class:"sr-only",name:"leaveType-"+t,value:"holiday","onUpdate:modelValue":o=>n.value[t]=o},null,8,Ce),[[R,n.value[t]]]),e[19]||(e[19]=U(" Holiday "))],2)])]))),128))])])):y("",!0),s("div",Fe,[e[21]||(e[21]=s("label",{for:"reason",class:"text-sm font-medium text-slate-600"},"Reason",-1)),g(s("textarea",{id:"reason","onUpdate:modelValue":e[2]||(e[2]=t=>r.value.reason=t),class:"input-1 w-full",placeholder:"Let approvers know why you need the time off",rows:"3"},null,512),[[V,r.value.reason]])]),s("div",Ee,[e[22]||(e[22]=s("label",{for:"handover-user",class:"text-sm font-medium text-slate-600"},"Handover User",-1)),O(me,{modelValue:S.value,"onUpdate:modelValue":e[3]||(e[3]=t=>S.value=t),options:z(v).users,multiple:!1,label:"label",placeholder:"Search teammate"},null,8,["modelValue","options"])]),s("div",qe,[e[23]||(e[23]=s("label",{for:"works-in-hand",class:"text-sm font-medium text-slate-600"},"Works in Hand",-1)),g(s("textarea",{id:"works-in-hand","onUpdate:modelValue":e[4]||(e[4]=t=>r.value.works_in_hand=t),class:"input-1 w-full",placeholder:"Share current deliverables so the team has context",rows:"6"},null,512),[[V,r.value.works_in_hand]])]),L.value?(p(),m("div",Oe,[e[25]||(e[25]=s("div",{class:"flex-shrink-0"},[s("i",{class:"fas fa-exclamation-triangle text-red-500"})],-1)),s("div",Pe,[e[24]||(e[24]=s("p",{class:"font-medium"},"Something went wrong!",-1)),s("p",Ye,c(L.value),1)])])):y("",!0),e[26]||(e[26]=s("div",{class:"sticky inset-x-0 bottom-0 -mx-4 flex justify-end border-t border-slate-100 bg-white/95 px-4 py-4 backdrop-blur supports-[backdrop-filter]:bg-white/80 md:-mx-8 md:px-8"},[s("button",{type:"submit",class:"btn-2 inline-flex items-center gap-2 shadow-md"},[s("i",{class:"far fa-save"}),U(" Update Application ")])],-1))],32))])}}};export{tt as default};
