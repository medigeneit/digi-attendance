import{D as re,E as O,B as ae,r as h,p as ie,e as de,q as le,c,o as p,a,h as W,v as ue,j as ce,k as w,y as pe,t as f,F as $,x as F,g as P,L as me,X as ye,w as fe,n as X}from"./index-CfsOA4f7.js";import{L as be}from"./LoaderView-BbywpHSV.js";import{_ as ke}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ve=re("kpi-report",{state:()=>({meta:null,rows:[],isLoading:!1,error:null}),actions:{async fetchBiMonthly(v){var m,l;this.isLoading=!0,this.error=null;try{const{data:s}=await O.get("/kpi/reports/bi-monthly",{params:v});return this.meta=(s==null?void 0:s.meta)??null,this.rows=Array.isArray(s==null?void 0:s.rows)?s.rows:Array.isArray(s==null?void 0:s.data)?s.data:[],{meta:this.meta,rows:this.rows}}catch(s){throw this.error=((l=(m=s==null?void 0:s.response)==null?void 0:m.data)==null?void 0:l.message)||"Failed to load report",s}finally{this.isLoading=!1}},async exportBiMonthly(v){var m,l,s;try{const u=await O.get("/kpi/reports/bi-monthly/export",{params:v,responseType:"blob"}),M=u.data,C=((m=u.headers)==null?void 0:m["content-disposition"])||"",B=/filename\*?=(?:UTF-8''|")?([^;\r\n"]+)/i.exec(C),L=B?decodeURIComponent(B[1].replace(/"/g,"")):`kpi-bimonthly-${(v==null?void 0:v.year)||""}.xlsx`;return{blob:M,filename:L}}catch(u){throw this.error=((s=(l=u==null?void 0:u.response)==null?void 0:l.data)==null?void 0:s.message)||"Failed to export report",u}},async setReportCompletion(v){var m,l;try{const{form_id:s,department_id:u,completed:M}=v||{};if(!s)throw new Error("form_id is required");if(u==null)throw new Error("department_id is required");const{data:C}=await O.patch(`/kpi/forms/${s}/report-completion`,{department_id:u,completed:!!M});return C}catch(s){const u=((l=(m=s==null?void 0:s.response)==null?void 0:m.data)==null?void 0:l.message)||(s==null?void 0:s.message)||"Failed to update report completion";throw console.error("setReportCompletion error:",s),new Error(u)}}}}),xe={class:"space-y-4 px-4 print:px-0"},he={class:"flex flex-wrap items-end gap-3 print:hidden"},ge={key:0,class:"py-8 text-center"},_e={key:1,class:"rounded-md border border-red-200 bg-red-50 p-3 text-red-700"},we={key:2,class:"overflow-x-auto rounded-xl border bg-white shadow-sm"},Ce={class:"min-w-full text-sm"},Ne={class:"bg-gray-100 text-gray-800"},Me={rowspan:"2",class:"border px-2 py-2 text-left"},$e={class:"bg-gray-100 text-gray-700"},Se={class:"border px-1 py-2 text-center"},De={class:"border px-1 py-2 w-40"},Ie={class:"border py-1 text-center"},Ve=["disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange","title"],Be={key:0,class:"text-xs text-gray-500 print:hidden"},Le={class:"border py-1 text-center"},Re={class:"border px-2 py-2 text-center"},Ae={key:0,class:"mt-1 text-[10px] text-gray-500 text-center"},Fe={key:0},Ee=1500,Oe={__name:"KpiBiMonthlyReport",setup(v){const m=ve(),{meta:l,rows:s,isLoading:u,error:M}=ae(m),C=h(new Date().getFullYear()),B=h("department"),L=h(""),T=h(""),E=h("any"),b=ie(()=>{var e;return((e=l.value)==null?void 0:e.periods)||[]}),y=h({}),R=h({}),A=h({}),U=h({}),g=(e,t)=>`${e}::${t}`;function K(e){var n;if(((n=l.value)==null?void 0:n.scope)!=="department")return null;const t=String((e==null?void 0:e.key)||"").match(/^dept:(\d+)$/);return t?Number(t[1]):null}function H(e){const t=b.value.find(n=>n.key===e);return t!=null&&t.form_id?Number(t.form_id):null}function Q(e){var t;return((t=b.value.find(n=>n.key===e))==null?void 0:t.label)||e}function Z(){const e={};for(const t of s.value||[])for(const n of b.value){const o=g(t.key,n.key);e[o]=y.value[o]}A.value=e}function q(){var n,o,i;const e={},t=Object.fromEntries(b.value.map(r=>[r.key,new Set((r.completed_departments||[]).map(Number))]));for(const r of s.value||[]){const k=K(r);for(const N of b.value){let x=!1;if(k&&t[N.key].has(k))x=!0;else{const d=(n=r.cells)==null?void 0:n[N.key],_=Number((d==null?void 0:d.assigned)??0),S=Number(((o=d==null?void 0:d.incharge)==null?void 0:o.done)??0),D=Number(((i=d==null?void 0:d.coordinator)==null?void 0:i.done)??0);x=E.value==="both"?_>0&&S>=_&&D>=_:_>0&&(S>=_||D>=_)}e[g(r.key,N.key)]=x}}y.value=e,Z()}function ee(e){const t=U.value[e]||0;return Date.now()-t>=Ee}function j(e,t){const n=g(e.key,t.key);A.value[n]=y.value[n]}async function te(e,t){var S,D,J;const n=g(e.key,t.key),o=!!y.value[n],i=!!A.value[n],r=`${(e==null?void 0:e.name)??""} • ${Q(t.key)}`,k=o?"mark as Completed":"mark as Pending";if(!window.confirm(`Confirm
${r}

Do you want to ${k}?`)){y.value[n]=i;return}if(R.value[n]){y.value[n]=i,window.alert("Already updating this cell. Please wait…");return}if(!ee(n)){y.value[n]=i,window.alert("Just updated. Try again in a moment.");return}const x=H(t.key),d=K(e),_=!!((D=(S=e==null?void 0:e.cells)==null?void 0:S[t.key])!=null&&D.form_id&&x);if(((J=l.value)==null?void 0:J.scope)!=="department"||!d||!_){y.value[n]=i,window.alert("This period is not assignable (no form). Cannot update.");return}R.value[n]=!0;try{await m.setReportCompletion({form_id:x,department_id:d,completed:o}),U.value[n]=Date.now(),A.value[n]=o;const I=b.value.findIndex(V=>V.key===t.key);if(I>=0){const V=new Set((l.value.periods[I].completed_departments||[]).map(Number));o?V.add(d):V.delete(d),l.value.periods[I].completed_departments=Array.from(V)}}catch(I){y.value[n]=i,console.error(I),window.alert("Failed to update report completion.")}finally{R.value[n]=!1}}const oe=(e,t)=>{var n,o,i;return!!((o=(n=e==null?void 0:e.cells)==null?void 0:n[t])!=null&&o.form_id)&&((i=l.value)==null?void 0:i.scope)==="department"};async function Y(){await m.fetchBiMonthly({year:Number(C.value),scope:B.value,department_id:L.value?Number(L.value):void 0,form_id:T.value?Number(T.value):void 0,rule:E.value}),q()}function ne(e){return e?"✓":"—"}function z(e,t){var i,r;const n=Number((e==null?void 0:e.assigned)??0),o=Number(t==="ic"?((i=e==null?void 0:e.incharge)==null?void 0:i.done)??0:((r=e==null?void 0:e.coordinator)==null?void 0:r.done)??0);if(n===0&&o===0){const k=t==="ic"?e==null?void 0:e.incharge:e==null?void 0:e.coordinator;if(typeof k=="boolean")return ne(k)}return`${o}/${n}`}function G(e,t){var i,r;const n=Number((e==null?void 0:e.assigned)??0),o=Number(t==="ic"?((i=e==null?void 0:e.incharge)==null?void 0:i.done)??0:((r=e==null?void 0:e.coordinator)==null?void 0:r.done)??0);return n===0?"border-gray-200 bg-gray-50 text-gray-600":o>=n?"border-emerald-200 bg-emerald-50 text-emerald-700":"border-rose-200 bg-rose-50 text-rose-700"}function se(){window.print()}return de(Y),le([s,b,E],q),(e,t)=>{var n;return p(),c("div",xe,[a("div",he,[a("div",null,[t[1]||(t[1]=a("label",{class:"text-sm text-gray-600"},"Year",-1)),W(a("input",{type:"number","onUpdate:modelValue":t[0]||(t[0]=o=>C.value=o),class:"w-28 rounded border px-2 py-1"},null,512),[[ue,C.value,void 0,{number:!0}]])]),a("button",{class:"btn-3",onClick:Y},"Generate"),a("button",{class:"btn-3",onClick:se},t[2]||(t[2]=[a("i",{class:"far fa-print mr-1"},null,-1),ce("Print")]))]),w(u)?(p(),c("div",ge,[pe(be)])):w(M)?(p(),c("div",_e,f(w(M)),1)):(p(),c("div",we,[a("table",Ce,[a("thead",null,[a("tr",Ne,[t[3]||(t[3]=a("th",{rowspan:"2",class:"border px-2 py-2 text-center"},"SL",-1)),a("th",Me,f(((n=w(l))==null?void 0:n.scope)==="user"?"Employee":"Department"),1),(p(!0),c($,null,F(b.value,o=>(p(),c("th",{key:o.key,colspan:"3",class:"border px-2 py-2 text-center font-semibold"},f(o.label),1))),128))]),a("tr",$e,[(p(!0),c($,null,F(b.value,o=>(p(),c($,{key:o.key+"-sub"},[t[4]||(t[4]=a("th",{class:"border px-1 py-1 text-center text-[11px]"},"Report",-1)),t[5]||(t[5]=a("th",{class:"border px-1 py-1 text-center text-[11px]"},"Inch.",-1)),t[6]||(t[6]=a("th",{class:"border px-1 py-1 text-center text-[11px]"},"Coord.",-1))],64))),128))])]),a("tbody",null,[(p(!0),c($,null,F(w(s),(o,i)=>(p(),c("tr",{key:o.key,class:"border-t"},[a("td",Se,f(i+1),1),a("td",De,f(o.name),1),(p(!0),c($,null,F(b.value,r=>{var k,N,x;return p(),c($,{key:r.key},[a("td",Ie,[W(a("input",{type:"checkbox",disabled:!oe(o,r.key)||R.value[g(o.key,r.key)],"onUpdate:modelValue":d=>y.value[g(o.key,r.key)]=d,onMousedown:d=>j(o,r),onKeydown:ye(fe(d=>j(o,r),["prevent"]),["enter"]),onChange:d=>te(o,r),title:y.value[g(o.key,r.key)]?"Completed":"Pending"},null,40,Ve),[[me,y.value[g(o.key,r.key)]]]),((k=w(l))==null?void 0:k.scope)==="department"?(p(),c("div",Be," A: "+f(((N=o.cells[r.key])==null?void 0:N.assigned)||0)+" / "+f(o.employees_total||0),1)):P("",!0)]),a("td",Le,[a("span",{class:X(["inline-block text-center font-mono rounded",G(o.cells[r.key],"ic")])},f(z(o.cells[r.key],"ic")),3)]),a("td",Re,[a("span",{class:X(["inline-block text-center font-mono rounded",G(o.cells[r.key],"co")])},f(z(o.cells[r.key],"co")),3),(x=o.cells[r.key])!=null&&x.max_total?(p(),c("div",Ae,f(o.cells[r.key].final_total)+" / "+f(o.cells[r.key].max_total),1)):P("",!0)])],64)}),128))]))),128)),!w(s)||w(s).length===0?(p(),c("tr",Fe,t[7]||(t[7]=[a("td",{colspan:"100",class:"px-3 py-6 text-center text-gray-600"},"No data",-1)]))):P("",!0)])])]))])}}},Ke=ke(Oe,[["__scopeId","data-v-76ccfe24"]]);export{Ke as default};
