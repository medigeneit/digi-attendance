import{L as re}from"./LoaderView-CbijMZGm.js";import{O as U}from"./OverlyModal-ByBOh5Wt.js";import{_ as Q}from"./DepartmentChip-DU0aKFFb.js";import{_ as oe}from"./TaskAddForm-DLLVlv19.js";import{_ as ie}from"./TaskEditForm-Bn_HkTS5.js";import{_ as ae}from"./TaskHeader-CsnSrcGB.js";import{_ as ne}from"./TaskUserAssignForm-CCP7zRsh.js";import{m as E,c as a,o,g as n,a as t,F as $,y as B,x as O,t as b,p as g,j as F,k as f,f as T,w as W,b as le,u as de,r as A,d as ue,z as X,e as me,A as Y,i as V,I as ce}from"./index-CmYiCXOi.js";import{u as pe}from"./task-priority-CO19j4VV.js";import{u as ye}from"./useRequirementStore-CUwyQk65.js";import{u as fe}from"./useTaskStore-WU1WXnTg.js";import{_ as ge,T as xe,a as ke,b as _e}from"./TaskUrgentBadge-D3wjid8P.js";import{_ as ve,a as be}from"./TaskAssignedUsers-B8i3Wxw7.js";import{T as he}from"./TaskIsClosedBadge-C6pYGUI-.js";import{d as Te,b as we}from"./datetime-Efw590t9.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./RequiredIcon-OTZVDVse.js";import"./company-CYfH-6Ad.js";import"./url-CePbr-gY.js";import"./CompanyDepartmentSelectInput-BY_jr43f.js";import"./SelectDropdown-DkAmmBiR.js";import"./SectionLoading-DaSh4f8A.js";import"./TextWithHr-xbLTvCf5.js";import"./TaskUrgencyInput-DHaxRV4T.js";import"./tags-CQ6QDke8.js";import"./MultiselectDropdown-BHaTwY8C.js";import"./MultiselectDropdown.vue_vue_type_style_index_0_lang-DP7cfONl.js";import"./task-DkvoeVXE.js";import"./EmployeeDropdownInput-DjbjljgC.js";import"./UserChip-B5mr42UF.js";import"./SearchInput-L9QgNdcQ.js";import"./user-Bb2WF72m.js";import"./DraggableList.vue_vue_type_script_setup_true_lang-Df-EOS2Z.js";import"./TaskUserChip-CywMck_9.js";import"./requirement-DKttisVj.js";import"./TaskTitle-DOuIRyQ9.js";const qe={class:"w-full p-1"},Ce={key:0,class:"w-full"},$e={key:0},Ie={class:"line-clamp-1"},Le={class:"border text-center py-2 px-1 border-gray-200"},Me={key:0,class:"text-base font-semibold text-purple-600"},Ae={class:"border px-3 py-1 border-gray-200 relative"},Be={class:"flex items-center justify-between gap-2"},Re={class:"flex items-center gap-3 mb-0.5"},Se={class:"flex items-center flex-none lg:w-full order-0 lg:order-1"},De={class:"text-gray-400 text-xs mr-4 whitespace-nowrap"},ze={class:"flex items-center gap-2 text-xs text-gray-500 opacity-80 text-left"},Ee={class:"text-xs flex items-center gap-1 text-sky-400 ml-4"},Oe={class:"text-xs flex items-center gap-1 text-sky-400 ml-3"},Pe=["href","onClick"],Ue={class:"border px-3 py-1 border-gray-200"},Fe={class:"flex gap-2 justify-between items-center relative w-full"},Ve={class:"shrink-0"},je=["href","onClick"],Ne={class:"border px-3 py-1 border-gray-200 text-center"},He={key:0,class:"ml-4 text-gray-500 text-sm"},Ke={class:"text-blue-500 font-semibold whitespace-nowrap"},Je={class:"border px-3 border-gray-200 sticky right-0 border-l bg-sky-50"},Qe={class:"flex justify-end flex-wrap gap-2 py-2"},Z={__name:"TaskTable",props:{tasks:{type:Array,required:!0,default:()=>[]},hideButtons:{type:Boolean,default:!1},parentTreeLevel:{type:Number},maxItem:{Number,default:5},isMyTask:{type:Boolean,default:!1},taskLinkTo:{type:Function,default:null}},emits:["editClick","addClick","employeeAssignClick"],setup(w,{emit:x}){const R=w,l=E(()=>R.tasks.reduce((p,r)=>{var d;const _=((d=r.requirement_detail)==null?void 0:d.id)||"-",y=[...p],k=y.find(e=>(e==null?void 0:e.key)==_);return k?k.tasks=[...k.tasks,r]:y.push({key:_,position:r!=null&&r.requirement_detail?0:1,...(r==null?void 0:r.requirement_detail)||{title:"(Other tasks)",id:0},tasks:[r]}),y},[]).sort((p,r)=>p.position-r.position)),q=x;return(p,r)=>{var _;return o(),a("div",qe,[((_=w.tasks)==null?void 0:_.length)>0?(o(),a("table",Ce,[r[5]||(r[5]=t("thead",null,[t("tr",null,[t("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 w-[30px] sticky -top-4 z-20"}," SL "),t("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Task "),t("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Assign Person "),t("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Deadline "),t("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 -top-4 z-20 sticky right-0 border-l bg-sky-50 px-2 whitespace-nowrap"}," Status ")])],-1)),t("tbody",null,[(o(!0),a($,null,B(l.value,(y,k)=>{var d;return o(),a($,{key:y.id},[l.value.length===1&&((d=l.value[0])==null?void 0:d.id)==0?n("",!0):(o(),a("tr",$e,[t("th",{colspan:"10",class:O(["font-semibold border",[(k>0,"")]])},[t("div",{class:O(["text-left pt-4 pb-1 px-2",[y.id===0?"text-gray-500":"text-sky-800"]])},[t("div",Ie,b(y==null?void 0:y.title),1)],2)],2)])),(o(!0),a($,null,B(y.tasks,(e,S)=>{var D,I;return o(),a("tr",{key:e.id,class:O(["group/sub-task-row",{" bg-green-400/20":e.status=="COMPLETED"," bg-white hover:bg-slate-50":e.status!=="COMPLETED"}])},[t("td",Le,[S!==void 0?(o(),a("div",Me,b(S+1)+". ",1)):n("",!0)]),t("td",Ae,[t("div",Be,[t("div",null,[t("div",Re,[g(ge,{titleClass:"text-sm",task:e,"sub-tasks-open":!1,isMyTask:w.isMyTask,to:w.taskLinkTo},null,8,["task","isMyTask","to"])]),t("div",Se,[t("div",De,[r[0]||(r[0]=t("i",{class:"fas fa-clock"},null,-1)),F(" "+b(f(Te)(e.created_at)),1)]),t("div",ze,[e!=null&&e.is_important?(o(),T(xe,{key:0})):n("",!0),e!=null&&e.is_urgent?(o(),T(ke,{key:1})):n("",!0)]),t("div",Ee,[r[1]||(r[1]=t("i",{class:"fas fa-tasks"},null,-1)),F(" "+b(e==null?void 0:e.todos_count),1)]),t("div",Oe,[r[2]||(r[2]=t("i",{class:"fas fa-book"},null,-1)),F(" "+b((D=e==null?void 0:e.requirement_detail)==null?void 0:D.id),1)])])]),!e.is_closed&&!w.hideButtons?(o(),a("a",{key:0,href:`/tasks/edit/${e.id}`,onClick:W(L=>q("editClick",e.id),["stop","prevent"]),class:"btn-3 py-1.5 px-1.5 !border-0 size-7 text-sm opacity-40 group-hover/sub-task-row:opacity-100 duration-100"},r[3]||(r[3]=[t("i",{class:"fas fa-edit"},null,-1)]),8,Pe)):n("",!0)])]),t("td",Ue,[t("div",Fe,[g(ve,{class:"flex items-center justify-center gap-x-3 gap-y-2",users:e.users||[],isTargetTask:e.is_target,maxItem:1,"route-to":L=>`/requirement-tasks?status=not-completed&view=userwise&user-ids=${L.id}`},null,8,["users","isTargetTask","route-to"]),t("div",Ve,[!e.is_closed&&!w.hideButtons?(o(),a("a",{key:0,href:`/tasks/${e.id}/assign-users`,onClick:W(L=>q("employeeAssignClick",e.id),["stop","prevent"]),class:"btn-3 py-1.5 px-1.5 !border-0 size-7 text-sm opacity-40 group-hover/sub-task-row:opacity-100 duration-100 flex-shrink-0"},r[4]||(r[4]=[t("i",{class:"fas fa-users-cog"},null,-1)]),8,je)):n("",!0)])])]),t("td",Ne,[e.deadline?(o(),a("span",He,[t("span",Ke,b(f(we)(e.deadline)),1)])):n("",!0)]),t("td",Je,[t("div",Qe,[e.closed_at?(o(),T(he,{key:0})):n("",!0),g(be,{status:e==null?void 0:e.status,progressPercent:(e==null?void 0:e.progress_percent)||0,class:"w-full"},null,8,["status","progressPercent"]),((I=e==null?void 0:e.children_tasks)==null?void 0:I.length)>0?(o(),T(_e,{key:1,ref_for:!0,ref:"progress",task:e,class:"text-sm w-full"},null,8,["task"])):n("",!0)])])],2)}),128))],64)}),128))])])):n("",!0)])}}},We={class:"my-container p-6 mt-2 relative bg-white rounded-md shadow-md min-h-[50vh]"},Xe={class:"mb-4"},Ye={key:4,class:"text-center py-4 text-red-500"},Ze={class:"relative min-h-[20vh]"},Ge={class:"sticky top-14 z-40 text-gray-700 bg-gradient-to-tl from-sky-400/60 to-sky-400 py-2 px-4 flex items-center"},et={class:"font-semibold flex items-center gap-2"},tt={class:"text-white text-base"},st={class:"rounded-b-md overflow-y-auto"},rt={class:"sticky top-14 z-40 text-gray-700 bg-gradient-to-tl from-sky-400/60 to-sky-400 py-2 px-4 flex items-center"},ot={class:"font-semibold flex items-center gap-2"},it={class:"rounded-b-md overflow-y-auto"},at={key:2,class:"text-center py-4 text-gray-500 border h-[30vh] flex items-center justify-center rounded bg-gray-50 italic"},jt={__name:"RequirementTaskList",setup(w){const x=fe(),R=ye(),l=le(),q=de(),p=A(""),r=A(null),_=A(!1),y=ue(),k=X({parentId:0,requirementId:0}),d=X({taskId:0,isOpen:!1}),e=E(()=>{const i=l.query["user-ids"]||null,s=(x.tasks||[]).flatMap(u=>{var v;return i?(v=u.users)==null?void 0:v.filter(z=>i.includes(z.id)):u.users});return[...new Map(s.map(u=>[u.id,u])).values()].sort((u,v)=>u.id-v.id)}),S=E(()=>(x.tasks||[]).reduce((i,s)=>{const h=`${s.from_department_id}-${s.to_department_id}`,u=i.find(v=>v.key==h);return u?u.tasks=[...u.tasks,s]:i.push({key:h,from_department:s.from_department,to_department:s.to_department,tasks:[s]}),i},[])),D=A(null),I=A([]),{saveTaskPriority:L,listHasRearranged:j}=pe(()=>x.taskListTree,0);me(()=>{console.log("Task List Mounted"),p.value="loading",C()});async function C(){console.log({name:l.name}),l.name=="RequirementTaskList"&&await x.fetchAllTasks({...l.query,page:1}),l.name=="MyRequirementTaskList"&&await x.fetchAllMyTasks({...l.query,page:1}),p.value="",I.value=[]}const P=i=>{_.value=!0,k.parentId=i},N=i=>{d.taskId=i,d.isOpen=!0};async function H(){r.value=null,_.value=!1,k.parentId=0,p.value="loading",await C()}async function G(){_.value=!1,k.parentId=0,await C()}async function ee(){p.value="loading",await L()&&await C()}function te(i){return x.tasks.filter(s=>(s.users||[]).some(h=>h.id===i))}Y(()=>({...l.query}),async()=>{try{x.resetTaskList(),p.value="loading",await C()}catch(i){console.warn(i)}}),Y(()=>y.isAdminMood,i=>{i?q.push({name:"RequirementTaskList"}):q.push({name:"MyRequirementTaskList"})},{immediate:!0});const K=E({get(){return{...l.query}},set(i){localStorage.removeItem("sub_task_opened_list"),q.push({query:{...i}})}});function se(i){return{name:"RequirementTaskShow",params:{id:(i==null?void 0:i.id)||0}}}return(i,s)=>{var h,u,v,z,J;return o(),a("div",We,[r.value?(o(),T(U,{key:0},{default:V(()=>[g(ie,{taskId:r.value,onClose:s[0]||(s[0]=m=>r.value=null),onUpdated:H},null,8,["taskId"])]),_:1})):n("",!0),_.value?(o(),T(U,{key:1},{default:V(()=>[g(oe,{parentTaskId:k.parentId,requirementId:k.requirementId,onClose:G,onTaskCreated:H},null,8,["parentTaskId","requirementId"])]),_:1})):n("",!0),d.isOpen?(o(),T(U,{key:2,class:"*:max-w-4xl"},{default:V(()=>[g(ne,{taskId:d.taskId,onCancelClick:s[1]||(s[1]=()=>{d.isOpen=!1,d.taskId=0}),onSuccess:s[2]||(s[2]=()=>{d.isOpen=!1,d.taskId=0,p.value="loading",C()})},null,8,["taskId"])]),_:1})):n("",!0),g(ae,{modelValue:K.value,"onUpdate:modelValue":s[3]||(s[3]=m=>K.value=m),onClickAddTask:P,onClickPrioritySave:ee,onClickPriorityDiscard:s[4]||(s[4]=()=>f(j)?D.value.resetItems:null),"list-has-rearranged":f(j),isMyTask:f(l).name==="MyRequirementTaskList",class:"mb-6"},null,8,["modelValue","list-has-rearranged","isMyTask"]),((u=(h=f(l))==null?void 0:h.query)==null?void 0:u["query-log"])=="true"?(o(!0),a($,{key:3},B(I.value,(m,c)=>(o(),a("div",{key:c,class:"text-xs text-gray-500"},[t("div",Xe,b(m.raw_query),1)]))),128)):n("",!0),f(R).error?(o(),a("div",Ye,b(f(R).error),1)):n("",!0),t("div",Ze,[((v=f(l).query)==null?void 0:v.view)==="userwise"?(o(!0),a($,{key:0},B(e.value,m=>(o(),a("div",{key:m.id,class:"mt-8 rounded-md border-2 border-sky-300"},[t("div",Ge,[t("div",et,[g(ce,{user:m},null,8,["user"]),t("div",tt,b(m.label),1)])]),t("div",st,[g(Z,{tasks:te(m.id),onEditClick:s[5]||(s[5]=c=>r.value=c),onAddClick:s[6]||(s[6]=c=>P(c)),onEmployeeAssignClick:s[7]||(s[7]=c=>N(c)),taskLinkTo:c=>({name:"RequirementTaskShow",params:{id:(c==null?void 0:c.id)||0}})},null,8,["tasks","taskLinkTo"])])]))),128)):(o(!0),a($,{key:1},B(S.value,m=>{var c;return o(),a("div",{key:m.key,class:"mt-8 rounded-md border-2 border-sky-300"},[t("div",rt,[t("div",ot,[s[11]||(s[11]=t("span",{class:"text-white text-sm"},"From",-1)),g(Q,{department:m.from_department},null,8,["department"]),s[12]||(s[12]=t("span",{class:"text-white text-sm"},"To",-1)),g(Q,{department:m.to_department},null,8,["department"])])]),t("div",it,[g(Z,{tasks:m.tasks,groupBy:"requirement_details",onEditClick:s[8]||(s[8]=M=>r.value=M),onAddClick:s[9]||(s[9]=M=>P(M)),onEmployeeAssignClick:s[10]||(s[10]=M=>N(M)),hideButtons:((c=f(l))==null?void 0:c.name)!=="RequirementTaskList",taskLinkTo:se},null,8,["tasks","hideButtons"])])])}),128)),p.value!=="loading"&&((z=f(x).tasks)==null?void 0:z.length)===0?(o(),a("div",at," No tasks ")):n("",!0),p.value==="loading"?(o(),T(re,{key:3,class:O(["absolute inset-0 flex items-center z-50 bg-opacity-60 h-full shadow-none border",[((J=f(x).tasks)==null?void 0:J.length)===0?"justify-center":""]])},null,8,["class"])):n("",!0)])])}}};export{jt as default};
