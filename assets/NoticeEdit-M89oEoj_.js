import{Q as De,u as Ve,f as Ne,r as p,D as ie,x as n,G as Se,q as g,h as je,p as Pe,c as v,o as c,a as t,j as w,i as ze,w as Ee,t as r,s as x,d as k,b as S,F as Be,e as Ue,k as $e,v as Fe,O as Me,l as Te}from"./index-4akVb-5j.js";import{L as Le}from"./LoaderView-B3I_8tDF.js";import{_ as K}from"./MultiselectDropdown-DCS4x_XE.js";import{_ as Re}from"./TextEditor-BZayh9em.js";import{_ as ne}from"./FlexibleDatePicker-CDhALBlI.js";import{u as Ge}from"./company-Ct_VOmyq.js";import{u as He}from"./department-aY9CDC9K.js";import{u as Oe}from"./notice-qzWO8D-d.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const qe={class:"my-container space-y-4"},Ie={class:"card-bg md:p-8 p-4 mx-4"},Je={class:"grid grid-cols-1 md:grid-cols-3 gap-3"},Qe={class:"rounded-xl border bg-white p-4 flex items-center justify-between"},Xe={class:"flex items-center gap-3"},Ye={class:"font-semibold"},Ke={class:"rounded-xl border bg-white p-4 flex items-center justify-between"},We={class:"flex items-center gap-3"},Ze={class:"font-semibold"},et={class:"rounded-xl border bg-white p-4"},tt={class:"flex items-center justify-between"},lt={class:"flex items-center gap-3"},st={class:"font-semibold"},at={class:"border p-4 rounded-xl bg-white space-y-6 shadow-sm"},ot={class:"grid md:grid-cols-3 gap-4"},it={class:"w-full"},nt={class:"inline-flex rounded-lg border overflow-hidden"},rt={class:"w-full"},dt={class:"font-medium block mb-1"},ut={key:0,class:"text-red-500"},pt={key:0,class:"text-xs text-gray-500 mt-1"},ct={class:"w-full"},mt={key:0,class:"text-xs text-red-600 mt-1"},vt={key:1,class:"text-xs text-gray-500 mt-1"},yt={class:"space-y-2"},bt={class:"flex flex-wrap gap-2"},ft=["onClick"],gt={key:0,class:"text-xs text-red-500 mt-1"},xt={class:"space-y-3"},ht={class:"flex items-center justify-between"},_t={class:"inline-flex rounded-lg border overflow-hidden"},wt={class:"grid md:grid-cols-2 gap-6"},kt={class:"space-y-3"},Ct={class:"flex items-center justify-between"},At={class:"inline-flex rounded-lg border overflow-hidden"},Dt={class:"space-y-3"},Vt={class:"flex items-center justify-between"},Nt={class:"inline-flex items-center gap-3"},St={class:"text-xs text-gray-500"},jt={class:"inline-flex rounded-lg border overflow-hidden"},Pt={class:"border p-4 rounded-xl bg-white space-y-6 shadow-sm"},zt={class:"space-y-2"},Et={key:0,class:"mb-2"},Bt=["href"],Ut={class:"w-full rounded-lg border border-dashed p-4 hover:bg-gray-50 transition"},$t={class:"flex items-center justify-between gap-3"},Ft={class:"inline-flex items-center"},Mt=["disabled"],Tt={key:0,class:"mt-3"},Lt={class:"h-2 bg-gray-200 rounded overflow-hidden"},Rt={class:"flex items-center justify-between mt-1 text-xs text-gray-600"},Gt={class:"sticky bottom-0 bg-white/90 backdrop-blur flex justify-center gap-4 p-3 rounded-xl border"},Ht=["disabled"],Ot={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4"},qt={class:"bg-white rounded-xl shadow-xl w-full max-w-md p-6 space-y-4"},It={class:"text-sm text-gray-600 break-words"},Jt={class:"flex justify-end gap-3"},al={__name:"NoticeEdit",setup(Qt){const y=De(),W=Ve(),H=Ne(),O=p(!1),U=p(!1),j=p(!0),q=Oe(),I=Ge(),m=He(),{companies:re}=ie(I),{employees:J}=ie(m),P=n(()=>m.departments||[]),Q=n(()=>Array.isArray(J.value)?J.value:[]),z=n(()=>re.value||[]),l=Se({title:"",type:1,description:"",published_at:"",expired_at:"",all_companies:!1,all_departments:!1,all_employees:!1,file_url:null,receiver_type:[]}),Z=[{value:"doctor",label:"Doctor"},{value:"executive",label:"Executive"},{value:"support_staff",label:"Support Staff"},{value:"academic_body",label:"Academic Body"}],C=n(()=>(Array.isArray(l.receiver_type)?l.receiver_type:l.receiver_type?[l.receiver_type]:[]).filter(Boolean)),de=s=>{if(!s)return;Array.isArray(l.receiver_type)||(l.receiver_type=[]);const e=l.receiver_type.indexOf(s);e>=0?l.receiver_type.splice(e,1):l.receiver_type.push(s)},ue=()=>{l.receiver_type=Z.map(s=>s.value)},pe=()=>{l.receiver_type=[]},$=s=>{if(!s)return null;const[e,o,a]=s.split("-");return!e||!o||!a?null:{year:Number(e),month:Number(o),day:Number(a)}},d=p($(l.published_at)),b=p($(l.expired_at)),ce=()=>{d.value=null,b.value=null,l.published_at="",l.expired_at=""},A=n(()=>l.type===2),ee=s=>String(s).padStart(2,"0"),X=s=>s?`${s.year}-${ee(s.month)}-${ee(s.day)}`:"",me=()=>{const s=new Date;return{year:s.getFullYear(),month:s.getMonth()+1,day:s.getDate()}},D=p([]),V=p([]),u=p([]),h=p(null),F=p(0),N=p(!1),M=p(!1);let E=null;const ve=n(()=>{var s;return((s=h.value)==null?void 0:s.name)||""}),ye=n(()=>h.value?(h.value.size/(1024*1024)).toFixed(2):"0.00"),T=n(()=>D.value.map(s=>s.id)),te=n(()=>V.value.map(s=>s.id)),be=n(()=>u.value.map(s=>s.id)),le=s=>{if(!s)return"";const e=String(s).split(" ")[0];return e.includes("-")?e:""},Y=n(()=>{if(l.type===2||!l.published_at||!l.expired_at)return!0;try{const s=new Date(l.published_at);return new Date(l.expired_at)>=s}catch{return!0}}),fe=n(()=>{var s;return!!((s=l.title)!=null&&s.trim())&&(l.type===2||!!l.published_at)&&C.value.length>0&&!N.value&&Y.value}),L=n({get:()=>l.all_companies?"all":"custom",set:s=>{l.all_companies=s==="all",D.value=l.all_companies?[...z.value]:[]}}),R=n({get:()=>l.all_departments?"all":"custom",set:s=>{l.all_departments=s==="all",V.value=l.all_departments?[...P.value]:[]}}),G=n({get:()=>l.all_employees?"all":"custom",set:s=>{l.all_employees=s==="all",u.value=l.all_employees?[...Q.value]:[]}});g(()=>l.all_companies,async s=>{j.value||(s?await m.fetchDepartments():await m.fetchDepartments(T.value))}),g(T,async s=>{j.value||l.all_companies||await m.fetchDepartments(s)});const ge=n(()=>l.all_departments?(P.value||[]).map(s=>s.id):te.value);g([ge,C],async([s,e])=>{if(j.value)return;const o=Array.isArray(e)?e:[];if(!o.length){m.employees=[],u.value=[],l.all_employees=!1;return}if(Array.isArray(s)&&s.length>0){u.value=[];let a=[];for(const f of o){const B=await m.fetchDepartmentActiveEmployee(s,f);Array.isArray(B)&&B.forEach(i=>{a.some(_=>(_==null?void 0:_.id)===(i==null?void 0:i.id))||a.push(i)})}m.employees=a,l.all_employees&&Array.isArray(a)&&(u.value=[...a])}else m.employees=[],u.value=[],l.all_employees=!1},{immediate:!0}),g(d,s=>{if(!s){l.published_at="";return}const e=X(s);l.published_at!==e&&(l.published_at=e)}),g(b,s=>{if(!s){l.expired_at="";return}const e=X(s);l.expired_at!==e&&(l.expired_at=e)}),g(()=>l.published_at,s=>{if(!s){d.value=null;return}const e=$(s);e&&(!d.value||d.value.year!==e.year||d.value.month!==e.month||d.value.day!==e.day)&&(d.value=e)}),g(()=>l.expired_at,s=>{if(!s){b.value=null;return}const e=$(s);e&&(!b.value||b.value.year!==e.year||b.value.month!==e.month||b.value.day!==e.day)&&(b.value=e)}),g(()=>l.type,(s,e)=>{if(s===2)ce();else if(e===2&&s===1&&!d.value){const o=me();d.value=o,l.published_at=X(o)}}),g([u,J],([s,e])=>{if(j.value)return;const o=Array.isArray(e)?e.length:0;l.all_employees=o>0&&s.length===o});const xe=async()=>{var e,o,a,f,B;const s=H.params.id;try{const i=await q.fetchNotice(s);l.title=i.title??"",l.type=Number(i.type??1),l.published_at=le(i.published_at),l.expired_at=le(i.expired_at),l.description=i.description??"",l.file_url=i.file_url||i.file||null,l.receiver_type=Array.isArray(i.receiver_type)?i.receiver_type.filter(Boolean):i.receiver_type?[i.receiver_type]:[];const _=(((e=i.companies_notice)==null?void 0:e.length)??0)>0;l.all_companies=!_,z.value.length===0&&await I.fetchCompanies(),D.value=_?i.companies_notice:[...z.value],l.all_companies?await m.fetchDepartments():await m.fetchDepartments(T.value);const ae=(((o=i.departments)==null?void 0:o.length)??0)>0;l.all_departments=!ae,V.value=ae?i.departments:[...P.value];const oe=(((a=i.employees)==null?void 0:a.length)??0)>0;l.all_employees=!oe,u.value=oe?i.employees:[]}catch(i){const _=((B=(f=i==null?void 0:i.response)==null?void 0:f.data)==null?void 0:B.message)||"Failed to load notice data";y.error(_),W.push({name:"NoticeList"})}},he=s=>{var a,f;const e=(f=(a=s==null?void 0:s.target)==null?void 0:a.files)==null?void 0:f[0];if(!e)return;if(!["image/jpeg","image/jpg","image/png","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"].includes(e.type)){y.error("Unsupported file type. Allowed: jpg, jpeg, png, pdf, doc, docx.");return}if(e.size>2*1024*1024){y.error("File size must be ≤ 2MB.");return}h.value=e,M.value=!0},_e=async()=>{var s,e;try{const o=H.params.id;if(!(h.value instanceof Blob))return;F.value=0,N.value=!0,E=new AbortController;const a=await q.updateNoticeFile(o,h.value,{onProgress:f=>F.value=f,signal:E.signal});l.file_url=(a==null?void 0:a.file_url)||(a==null?void 0:a.file)||l.file_url,y.success("File uploaded successfully.")}catch(o){if((o==null?void 0:o.name)==="CanceledError"||(o==null?void 0:o.message)==="canceled")y.info("Upload canceled.");else{const a=((e=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:e.message)||(o==null?void 0:o.message)||"Upload failed.";y.error(a)}}finally{N.value=!1,M.value=!1,h.value=null,E=null}},we=()=>{E&&E.abort()},ke=async()=>{var s,e;if(!C.value.length){y.error("Receiver type is required.");return}if(!Y.value){y.error("Expire date must be the same or after Publish date.");return}try{U.value=!0;const o=H.params.id,a={title:l.title,type:l.type,description:l.description,published_at:l.type===2?null:l.published_at||null,expired_at:l.type===2?null:l.expired_at||null,all_companies:!!l.all_companies,all_departments:!!l.all_departments,all_employees:!!l.all_employees,company_ids:T.value,department_ids:te.value,employee_ids:be.value,receiver_type:C.value};await q.updateNotice(o,a),y.success("Notice updated successfully"),W.push({name:"NoticeShow",params:{id:o}})}catch(o){const a=((e=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:e.message)||(o==null?void 0:o.message)||"Failed to update notice";y.error(a)}finally{U.value=!1}};je(async()=>{O.value=!0,await I.fetchCompanies(),await xe(),O.value=!1,j.value=!1});const Ce=n(()=>z.value.length),Ae=n(()=>P.value.length),se=n(()=>Q.value.length);return(s,e)=>{const o=Pe("RouterLink");return c(),v("div",qe,[t("div",Ie,[e[38]||(e[38]=t("h2",{class:"title-lg text-center"},"Edit Notice",-1)),O.value?(c(),ze(Le,{key:0,class:"bg-gray-100 border shadow-none"})):(c(),v("form",{key:1,onSubmit:Ee(ke,["prevent"]),class:"space-y-5"},[t("div",Je,[t("div",Qe,[t("div",Xe,[e[17]||(e[17]=t("span",{class:"inline-flex h-8 w-8 items-center justify-center rounded-lg bg-blue-100"},[t("svg",{viewBox:"0 0 24 24",class:"h-5 w-5 text-blue-600"},[t("path",{fill:"currentColor",d:"M3 10v10h18V10H3zm9-7l9 7H3l9-7z"})])],-1)),t("div",null,[e[16]||(e[16]=t("div",{class:"text-sm text-gray-500"},"Companies",-1)),t("div",Ye,r(l.all_companies?"All":D.value.length)+" / "+r(Ce.value),1)])])]),t("div",Ke,[t("div",We,[e[19]||(e[19]=t("span",{class:"inline-flex h-8 w-8 items-center justify-center rounded-lg bg-purple-100"},[t("svg",{viewBox:"0 0 24 24",class:"h-5 w-5 text-purple-600"},[t("path",{fill:"currentColor",d:"M3 5h18v2H3V5zm3 4h12v10H6V9z"})])],-1)),t("div",null,[e[18]||(e[18]=t("div",{class:"text-sm text-gray-500"},"Departments",-1)),t("div",Ze,r(l.all_departments?"All":V.value.length)+" / "+r(Ae.value),1)])])]),t("div",et,[t("div",tt,[t("div",lt,[e[21]||(e[21]=t("span",{class:"inline-flex h-8 w-8 items-center justify-center rounded-lg bg-emerald-100"},[t("svg",{viewBox:"0 0 24 24",class:"h-5 w-5 text-emerald-600"},[t("path",{fill:"currentColor",d:"M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6z"})])],-1)),t("div",null,[e[20]||(e[20]=t("div",{class:"text-sm text-gray-500"},"Employees",-1)),t("div",st,r(l.all_employees?"All":u.value.length)+" / "+r(se.value),1)])])])])]),t("div",at,[e[29]||(e[29]=t("h2",{class:"text-lg font-semibold"},"Notice Information",-1)),t("div",ot,[t("div",it,[e[22]||(e[22]=t("label",{for:"type",class:"font-medium block mb-1"},"Type*",-1)),t("div",nt,[t("button",{type:"button",class:x(["px-4 py-2 text-sm",l.type===1?"bg-blue-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[0]||(e[0]=a=>l.type=1)}," General ",2),t("button",{type:"button",class:x(["px-4 py-2 text-sm border-l",l.type===2?"bg-blue-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[1]||(e[1]=a=>l.type=2)}," Policy ",2)])]),t("div",rt,[t("label",dt,[e[23]||(e[23]=S(" Publish Date ")),A.value?w("",!0):(c(),v("span",ut,"*"))]),k(ne,{modelValue:d.value,"onUpdate:modelValue":e[2]||(e[2]=a=>d.value=a),"show-year":!1,"show-month":!1,"show-date":!0,disabled:A.value},null,8,["modelValue","disabled"]),A.value?(c(),v("p",pt," Policies skip publish dates and remain visible indefinitely. ")):w("",!0)]),t("div",ct,[e[24]||(e[24]=t("label",{class:"font-medium block mb-1"},"Expire Date",-1)),k(ne,{modelValue:b.value,"onUpdate:modelValue":e[3]||(e[3]=a=>b.value=a),"show-year":!1,"show-month":!1,"show-date":!0,disabled:A.value},null,8,["modelValue","disabled"]),!Y.value&&!A.value?(c(),v("p",mt," Expire date must be the same or after Publish date. ")):A.value?(c(),v("p",vt," Policies stay active until replaced. ")):w("",!0)])]),t("div",yt,[t("div",{class:"flex items-center justify-between"},[e[25]||(e[25]=t("label",{class:"font-medium block mb-1"},[S(" Send To "),t("span",{class:"text-red-500"},"*")],-1)),t("div",{class:"inline-flex gap-1 text-xs"},[t("button",{type:"button",class:"px-2 py-1 rounded border text-gray-600 hover:bg-gray-50",onClick:ue}," Select All "),t("button",{type:"button",class:"px-2 py-1 rounded border text-gray-600 hover:bg-gray-50",onClick:pe}," Clear ")])]),t("div",bt,[(c(),v(Be,null,Ue(Z,a=>t("button",{key:a.value,type:"button",class:x(["px-3 py-1.5 rounded-full border text-xs",C.value.includes(a.value)?"bg-blue-600 text-white border-blue-600":"bg-white text-gray-700 hover:bg-gray-50"]),onClick:f=>de(a.value)},r(a.label),11,ft)),64))]),C.value.length?w("",!0):(c(),v("p",gt," Receiver type is required. "))]),t("div",xt,[t("div",ht,[e[26]||(e[26]=t("label",{class:"font-medium"},"Companies",-1)),t("div",_t,[t("button",{type:"button",class:x(["px-3 py-1.5 text-xs",L.value==="all"?"bg-blue-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[4]||(e[4]=a=>L.value="all")},"All",2),t("button",{type:"button",class:x(["px-3 py-1.5 text-xs border-l",L.value==="custom"?"bg-blue-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[5]||(e[5]=a=>L.value="custom")},"Custom",2)])]),t("div",null,[k(K,{modelValue:D.value,"onUpdate:modelValue":e[6]||(e[6]=a=>D.value=a),options:z.value,multiple:!0,searchable:!0,placeholder:"Select companies","track-by":"id",label:"name"},null,8,["modelValue","options"])])]),t("div",wt,[t("div",kt,[t("div",Ct,[e[27]||(e[27]=t("label",{class:"font-medium"},"Departments",-1)),t("div",At,[t("button",{type:"button",class:x(["px-3 py-1.5 text-xs",R.value==="all"?"bg-purple-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[7]||(e[7]=a=>R.value="all")},"All",2),t("button",{type:"button",class:x(["px-3 py-1.5 text-xs border-l",R.value==="custom"?"bg-purple-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[8]||(e[8]=a=>R.value="custom")},"Custom",2)])]),k(K,{modelValue:V.value,"onUpdate:modelValue":e[9]||(e[9]=a=>V.value=a),options:P.value,multiple:!0,searchable:!0,placeholder:"Select departments","track-by":"id",label:"name"},null,8,["modelValue","options"])]),t("div",Dt,[t("div",Vt,[e[28]||(e[28]=t("label",{class:"font-medium"},"Employees",-1)),t("div",Nt,[t("span",St," Selected "+r(u.value.length)+" / "+r(se.value),1),t("div",jt,[t("button",{type:"button",class:x(["px-3 py-1.5 text-xs",G.value==="all"?"bg-emerald-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[10]||(e[10]=a=>G.value="all")},"All",2),t("button",{type:"button",class:x(["px-3 py-1.5 text-xs border-l",G.value==="custom"?"bg-emerald-600 text-white":"bg-white hover:bg-gray-50"]),onClick:e[11]||(e[11]=a=>G.value="custom")},"Custom",2)])])]),k(K,{modelValue:u.value,"onUpdate:modelValue":e[12]||(e[12]=a=>u.value=a),options:Q.value,multiple:!0,searchable:!0,placeholder:"Select employee","track-by":"id",label:"name"},null,8,["modelValue","options"])])])]),t("div",Pt,[e[36]||(e[36]=t("h2",{class:"text-lg font-semibold"},"Notice Content",-1)),t("div",null,[e[30]||(e[30]=t("label",{class:"font-medium block mb-1"},"Title*",-1)),$e(t("input",{"onUpdate:modelValue":e[13]||(e[13]=a=>l.title=a),type:"text",class:"w-full p-2 border rounded",required:""},null,512),[[Fe,l.title]])]),t("div",zt,[e[34]||(e[34]=t("label",{class:"font-medium block mb-1"},"Attachment",-1)),l.file_url?(c(),v("div",Et,[t("a",{href:l.file_url,target:"_blank",class:"inline-flex items-center gap-2 text-blue-600 underline"},e[31]||(e[31]=[t("svg",{viewBox:"0 0 24 24",class:"h-4 w-4"},[t("path",{fill:"currentColor",d:"M14 3H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"}),t("path",{fill:"currentColor",d:"M14 3v6h6"})],-1),S(" View Current File ")]),8,Bt)])):w("",!0),t("div",Ut,[t("div",$t,[e[33]||(e[33]=t("div",{class:"text-sm text-gray-600"},[t("div",{class:"font-medium"},"Upload new file"),t("div",null,"JPG, JPEG, PNG, PDF, DOC, DOCX (≤ 2MB)")],-1)),t("label",Ft,[t("input",{type:"file",accept:".jpg,.jpeg,.png,.pdf,.doc,.docx",onChange:he,class:"hidden",disabled:N.value},null,40,Mt),e[32]||(e[32]=t("span",{class:"px-4 py-2 rounded border bg-white hover:bg-gray-50 cursor-pointer"}," Browse… ",-1))])]),N.value?(c(),v("div",Tt,[t("div",Lt,[t("div",{class:"h-2 bg-blue-600 transition-all",style:Me({width:F.value+"%"})},null,4)]),t("div",Rt,[t("span",null,r(F.value)+"%",1),t("button",{type:"button",class:"px-3 py-1 rounded border hover:bg-gray-50",onClick:we}," Cancel ")])])):w("",!0)])]),t("div",null,[e[35]||(e[35]=t("label",{class:"font-medium block mb-1"},"Description",-1)),k(Re,{modelValue:l.description,"onUpdate:modelValue":e[14]||(e[14]=a=>l.description=a),class:"w-full px-4 py-2"},null,8,["modelValue"])])]),t("div",Gt,[k(o,{to:{name:"NoticeList"},type:"button",class:"bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"},{default:Te(()=>e[37]||(e[37]=[S(" Cancel ")])),_:1,__:[37]}),t("button",{disabled:U.value||N.value||!fe.value,type:"submit",class:"bg-blue-600 text-white px-5 py-2 rounded hover:bg-blue-700 disabled:opacity-60"},r(U.value?"Saving…":"Save"),9,Ht)])],32))]),M.value?(c(),v("div",Ot,[t("div",qt,[e[42]||(e[42]=t("h3",{class:"text-lg font-semibold"},"Upload this file?",-1)),t("p",It,[e[39]||(e[39]=t("span",{class:"font-medium"},"Name:",-1)),S(" "+r(ve.value),1),e[40]||(e[40]=t("br",null,null,-1)),e[41]||(e[41]=t("span",{class:"font-medium"},"Size:",-1)),S(" "+r(ye.value)+" MB ",1)]),t("div",Jt,[t("button",{class:"px-4 py-2 rounded border hover:bg-gray-50",onClick:e[15]||(e[15]=a=>{M.value=!1,h.value=null})}," Cancel "),t("button",{class:"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",onClick:_e}," Upload ")])])])):w("",!0)])}}};export{al as default};
