import{L as Ae,M as q,s as Re,r as x,x as H,b as De,A as J,e as Ie,c as f,o as b,a as l,j as W,t as _,h as Q,B as Le,k as j,F as A,y as P,n as Ve,q as $,g as pe,O as fe,a1 as be,w as ve}from"./index-R3BEEySt.js";import{L as Pe}from"./LoaderView-BHj4_Wwy.js";import{_ as Ee}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ke=Ae("kpi-report",{state:()=>({meta:null,rows:[],isLoading:!1,error:null}),actions:{async fetchBiMonthly(M){var c,d;this.isLoading=!0,this.error=null;try{const{data:a}=await q.get("/kpi/reports/bi-monthly",{params:M});return this.meta=(a==null?void 0:a.meta)??null,this.rows=Array.isArray(a==null?void 0:a.rows)?a.rows:Array.isArray(a==null?void 0:a.data)?a.data:[],{meta:this.meta,rows:this.rows}}catch(a){throw this.error=((d=(c=a==null?void 0:a.response)==null?void 0:c.data)==null?void 0:d.message)||"Failed to load report",a}finally{this.isLoading=!1}},async exportBiMonthly(M){try{const c=await q.get("/kpi/reports/bi-monthly-export",{params:M,responseType:"blob"}),d=c.headers["content-disposition"]||"";let a="kpi_bi_monthly.xlsx";const g=/filename="?([^"]+)"?/i.exec(d);g&&g[1]&&(a=decodeURIComponent(g[1]));const R=new Blob([c.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),T=URL.createObjectURL(R),p=document.createElement("a");p.href=T,p.download=a,document.body.appendChild(p),p.click(),p.remove(),URL.revokeObjectURL(T)}catch(c){throw console.error(c),c}},async setReportCompletion(M){var c,d;try{const{form_id:a,department_id:g,completed:R}=M||{};if(!a)throw new Error("form_id is required");if(g==null)throw new Error("department_id is required");const{data:T}=await q.patch(`/kpi/forms/${a}/report-completion`,{department_id:g,completed:!!R});return T}catch(a){const g=((d=(c=a==null?void 0:a.response)==null?void 0:c.data)==null?void 0:d.message)||(a==null?void 0:a.message)||"Failed to update report completion";throw console.error("setReportCompletion error:",a),new Error(g)}},async setTargetCompletion({form_id:M,department_id:c,completed:d}){const{data:a}=await q.post(`/kpi/bi-monthly/forms/${M}/target-completion`,{department_id:c,completed:d});return a}}}),Ue={class:"space-y-4 px-4 print:px-0"},Fe={class:"hidden print:block mx-auto text-center mb-3"},ze={class:"text-sm text-gray-600"},Ye={class:"font-medium"},qe={class:"flex flex-wrap items-end gap-3 sticky top-0 z-10 bg-white/80 backdrop-blur print:hidden p-2 -mx-2 rounded-md border border-gray-100"},He={class:"flex items-center gap-2"},Je=["disabled"],We=["value"],Ge={key:0,class:"py-10 text-center"},Qe={key:1,class:"rounded-md border border-red-200 bg-red-50 p-3 text-red-700",role:"alert","aria-live":"polite"},Xe={key:3,class:"hidden md:block overflow-x-auto rounded-xl border bg-white shadow-sm"},Ze={class:"min-w-[900px] w-full text-sm"},et={class:"text-gray-800 sticky top-0 z-[5]"},tt={class:"bg-gray-100/95 backdrop-blur"},ot={rowspan:"2",class:"sticky z-[6] border-y border-r bg-gray-100/95 px-2 py-2 text-left",style:{left:"2rem",minWidth:"12.5rem",width:"12.5rem"}},nt={class:"whitespace-nowrap"},rt={class:"bg-gray-100/95 text-gray-700 whitespace-nowrap"},at={class:"text-gray-800"},st={class:"sticky left-0 z-[4] border-r bg-inherit px-2 text-center"},lt={class:"sticky z-[4] border bg-inherit px-2"},it=["title"],dt={class:"inline-flex items-center justify-center gap-2 cursor-pointer"},ct=["aria-label","disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange"],ut={class:"inline-flex items-center justify-center gap-2 cursor-pointer"},mt=["aria-label","disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange"],yt={key:0,class:"mt-1 text-[10px] text-gray-500 text-center"},pt={key:0},ft=1500,bt={__name:"KpiBiMonthlyReport",setup(M){const c=Ke(),{meta:d,rows:a,isLoading:g,error:R}=Re(c),T=new Date().getFullYear(),p=x(T),D=x([]),X=x("department"),E=x(""),K=x(""),U=x("any"),v=H(()=>{var e;return((e=d.value)==null?void 0:e.periods)||[]}),Z=H(()=>{var e;return((e=d.value)==null?void 0:e.available_years)||null}),ee=H(()=>{const e=Object.create(null);for(const o of v.value)e[o.key]=o;return e}),he=De(),ke=["feb_mar","jun_jul","nov"],ge=H(()=>{var n;const e=he.query.hl;if(e)return new Set(String(e).split(",").map(t=>t.trim()).filter(Boolean));const o=(n=d.value)==null?void 0:n.highlight_period_keys;return Array.isArray(o)&&o.length?new Set(o):new Set(ke)}),te=e=>ge.value.has(e.key),O=e=>te(e)?"bg-amber-50":"bg-white",I=e=>te(e)?"border-amber-300":"border-gray-200",xe=T;function _e(e=2018,o=xe+1){const n=[];for(let s=o;s>=e;s--)n.push(s);const t=Number(p.value);n.includes(t)||n.unshift(t),D.value=Array.from(new Set(n))}function oe(e){Array.isArray(e)&&e.length?(D.value=[...new Set(e.map(Number))].sort((o,n)=>n-o),D.value.includes(Number(p.value))||(p.value=D.value[0])):_e()}J(Z,oe,{immediate:!0}),J(p,()=>{const e=Number(p.value);!Number.isInteger(e)||e<2e3||e>2100||me()});const w=x(Object.create(null)),C=x(Object.create(null)),B=x(Object.create(null)),F=x(Object.create(null)),z=x(Object.create(null)),G=x(Object.create(null)),h=(e,o)=>`${e}::${o}`;function Y(e){var n;if(((n=d.value)==null?void 0:n.scope)!=="department")return null;const o=String((e==null?void 0:e.key)||"").match(/^dept:(\d+)$/);return o?Number(o[1]):null}function ne(e){const o=ee.value[e];return o!=null&&o.form_id?Number(o.form_id):null}function re(e){var o;return((o=ee.value[e])==null?void 0:o.label)||e}function ae(e){const o=G.value[e]||0;return Date.now()-o>=ft}function we(){const e=Object.create(null);for(const o of a.value||[])for(const n of v.value){const t=h(o.key,n.key);e[t]=w.value[t]}F.value=e}function se(){var n,t,s;const e=Object.create(null),o=Object.create(null);for(const r of v.value)o[r.key]=new Set((r.completed_departments||[]).map(Number));for(const r of a.value||[]){const u=Y(r);for(const i of v.value){let m=!1;if(u&&o[i.key].has(u))m=!0;else{const y=(n=r.cells)==null?void 0:n[i.key],k=Number((y==null?void 0:y.assigned)??0),N=Number(((t=y==null?void 0:y.incharge)==null?void 0:t.done)??0),S=Number(((s=y==null?void 0:y.coordinator)==null?void 0:s.done)??0);m=U.value==="both"?k>0&&N>=k&&S>=k:k>0&&(N>=k||S>=k)}e[h(r.key,i.key)]=m}}w.value=e,we()}function le(e,o){const n=h(e.key,o.key);F.value[n]=w.value[n]}async function Ce(e,o){var N,S,ye;const n=h(e.key,o.key),t=!!w.value[n],s=!!F.value[n],r=`${(e==null?void 0:e.name)??""} • ${re(o.key)}`,u=t?"mark as Completed":"mark as Pending";if(!window.confirm(`Confirm
${r}

Do you want to ${u}?`)){w.value[n]=s;return}if(B.value[n]){w.value[n]=s,window.alert("Already updating…");return}if(!ae(n)){w.value[n]=s,window.alert("Just updated. Try again shortly.");return}const m=ne(o.key),y=Y(e),k=!!((S=(N=e==null?void 0:e.cells)==null?void 0:N[o.key])!=null&&S.form_id&&m);if(((ye=d.value)==null?void 0:ye.scope)!=="department"||!y||!k){w.value[n]=s,window.alert("This period is not assignable (no form).");return}B.value[n]=!0;try{await c.setReportCompletion({form_id:m,department_id:y,completed:t}),G.value[n]=Date.now(),F.value[n]=t;const L=v.value.findIndex(V=>V.key===o.key);if(L>=0){const V=new Set((d.value.periods[L].completed_departments||[]).map(Number));t?V.add(y):V.delete(y),d.value.periods[L].completed_departments=Array.from(V)}}catch(L){w.value[n]=s,console.error(L),window.alert("Failed to update.")}finally{B.value[n]=!1}}function Ne(){const e=Object.create(null);for(const o of a.value||[])for(const n of v.value){const t=h(o.key,n.key);e[t]=C.value[t]}z.value=e}function ie(){var n,t;const e=Object.create(null),o=Object.create(null);for(const s of v.value)o[s.key]=new Set((s.target_completed_departments||[]).map(Number));for(const s of a.value||[]){const r=Y(s);for(const u of v.value){let i=!1;if(r&&o[u.key].has(r))i=!0;else{const m=(t=(n=s==null?void 0:s.cells)==null?void 0:n[u.key])==null?void 0:t.monthly_target,y=Number((m==null?void 0:m.have)??0),k=Number((m==null?void 0:m.of)??0);i=k>0&&y>=k}e[h(s.key,u.key)]=i}}C.value=e,Ne()}function de(e,o){const n=h(e.key,o.key);z.value[n]=C.value[n]}async function Se(e,o){var k;const n=h(e.key,o.key),t=!!C.value[n],s=!!z.value[n],r=`${(e==null?void 0:e.name)??""} • ${re(o.key)}`,u=t?"mark Target as Completed":"mark Target as Pending";if(!window.confirm(`Confirm
${r}

Do you want to ${u}?`)){C.value[n]=s;return}if(B.value[n]){C.value[n]=s,window.alert("Already updating…");return}if(!ae(n)){C.value[n]=s,window.alert("Just updated. Try again shortly.");return}const m=Y(e);if(((k=d.value)==null?void 0:k.scope)!=="department"||!m){C.value[n]=s,window.alert("Not assignable.");return}const y=ne(o.key);B.value[n]=!0;try{await c.setTargetCompletion({period_key:o.key,form_id:y||void 0,department_id:m,completed:t}),G.value[n]=Date.now(),z.value[n]=t;const N=v.value.findIndex(S=>S.key===o.key);if(N>=0){const S=new Set((d.value.periods[N].target_completed_departments||[]).map(Number));t?S.add(m):S.delete(m),d.value.periods[N].target_completed_departments=Array.from(S)}}catch(N){C.value[n]=s,console.error(N),window.alert("Failed to update.")}finally{B.value[n]=!1}}const $e=(e,o)=>{var n,t,s;return!!((t=(n=e==null?void 0:e.cells)==null?void 0:n[o])!=null&&t.form_id)&&((s=d.value)==null?void 0:s.scope)==="department"},Oe=(e,o)=>{var t,s,r,u,i;if(((t=d.value)==null?void 0:t.scope)!=="department")return!1;const n=(r=(s=e==null?void 0:e.cells)==null?void 0:s[o])==null?void 0:r.monthly_target;return Number((n==null?void 0:n.of)??0)>0||!!((i=(u=e==null?void 0:e.cells)==null?void 0:u[o])!=null&&i.form_id)},Me=e=>e?"✓":"—";function ce(e,o,n){var r,u;const t=Number((e==null?void 0:e.assigned)??0),s=Number(n==="ic"?((r=e==null?void 0:e.incharge)==null?void 0:r.done)??0:((u=e==null?void 0:e.coordinator)==null?void 0:u.done)??0);if(t===0&&s===0){const i=n==="ic"?e==null?void 0:e.incharge:e==null?void 0:e.coordinator;if(typeof i=="boolean")return Me(i)}return`${s}/${o}`}function ue(e,o){var s,r;const n=Number((e==null?void 0:e.assigned)??0),t=Number(o==="ic"?((s=e==null?void 0:e.incharge)==null?void 0:s.done)??0:((r=e==null?void 0:e.coordinator)==null?void 0:r.done)??0);return n===0?"bg-gray-50 text-gray-600":t>=n?"bg-emerald-50 text-emerald-700":"bg-rose-50 text-rose-700"}function Be(){window.print()}function je(){return new Date().toLocaleString()}async function me(){try{await c.fetchBiMonthly({year:Number(p.value),scope:X.value,department_id:E.value?Number(E.value):void 0,form_id:K.value?Number(K.value):void 0,rule:U.value})}catch(e){console.error("fetchBiMonthly failed:",e)}finally{se(),ie()}}async function Te(){try{await c.exportBiMonthly({year:Number(p.value),scope:X.value,department_id:E.value?Number(E.value):void 0,form_id:K.value?Number(K.value):void 0,rule:U.value})}catch(e){console.error("exportBiMonthly failed:",e),window.alert("Export failed. Please try again.")}}return J([a,v,U],se),J([a,v],ie),Ie(()=>{oe(Z.value),me()}),(e,o)=>{var n;return b(),f("div",Ue,[l("div",Fe,[o[3]||(o[3]=l("h1",{class:"text-xl font-semibold text-gray-900"},"Bi-Monthly KPI Report",-1)),l("div",ze,[o[1]||(o[1]=W(" Year: ")),l("span",Ye,_(p.value),1),o[2]||(o[2]=W(" • Generated: ")),l("span",null,_(je()),1)])]),l("div",qe,[l("div",He,[o[4]||(o[4]=l("label",{class:"text-xs font-medium text-gray-600"},"Year",-1)),Q(l("select",{"onUpdate:modelValue":o[0]||(o[0]=t=>p.value=t),class:"w-32 rounded border border-gray-300 bg-white px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400/50 disabled:opacity-60",disabled:j(g),"aria-label":"Select year"},[(b(!0),f(A,null,P(D.value,t=>(b(),f("option",{key:t,value:t},_(t),9,We))),128))],8,Je),[[Le,p.value,void 0,{number:!0}]])]),l("div",{class:"ml-auto flex gap-2"},[l("button",{class:"btn-3 !py-1.5 !px-3",onClick:Te},o[5]||(o[5]=[l("i",{class:"far fa-file-excel mr-1"},null,-1),W(" Excel ")])),l("button",{class:"btn-3 !py-1.5 !px-3",onClick:Be},o[6]||(o[6]=[l("i",{class:"far fa-print mr-1"},null,-1),W(" Print ")]))])]),j(g)?(b(),f("div",Ge,[Ve(Pe)])):j(R)?(b(),f("div",Qe,_(j(R)),1)):(b(),f("div",Xe,[l("table",Ze,[l("thead",et,[l("tr",tt,[o[9]||(o[9]=l("th",{rowspan:"2",class:"sticky left-0 z-[6] border-y border-r bg-gray-100/95 px-2 py-2 text-center",style:{"min-width":"2.25rem",width:"2.25rem"}},"SL",-1)),l("th",ot,_(((n=j(d))==null?void 0:n.scope)==="user"?"Employee":"Department"),1),(b(!0),f(A,null,P(v.value,t=>(b(),f("th",{key:t.key,colspan:"4",class:$(["border-y px-2 py-2 text-center font-semibold border-x-2 text-red-500 print:text-black",[O(t),I(t)]])},[l("span",nt,_(t.label),1)],2))),128))]),l("tr",rt,[(b(!0),f(A,null,P(v.value,t=>(b(),f(A,{key:t.key+"-sub"},[l("th",{class:$(["border-y py-1 text-center text-[11px] w-8 border-r",O(t)])},"Report",2),l("th",{class:$(["border-y py-1 text-center text-[11px] w-8 border-r",[O(t),I(t)]])},"Target",2),l("th",{class:$(["border-y py-1 text-center text-[11px] w-8 border-r",O(t)])},"Inch.",2),l("th",{class:$(["border-y py-1 text-center text-[11px] border-r-2 w-8",[O(t),I(t)]])},"Coord.",2)],64))),128))])]),l("tbody",at,[(b(!0),f(A,null,P(j(a),(t,s)=>(b(),f("tr",{key:t.key,class:"border-t odd:bg-gray-50 hover:bg-sky-50/40 transition-colors break-inside-avoid"},[l("td",st,_(s+1),1),l("td",lt,[l("div",{class:"truncate w-48",title:t.name},_(t.name),9,it)]),(b(!0),f(A,null,P(v.value,r=>{var u;return b(),f(A,{key:r.key},[l("td",{class:$(["border-r text-center",O(r)])},[l("label",dt,[Q(l("input",{type:"checkbox",class:"h-4 w-4 accent-emerald-500","aria-label":`Report • ${t.name} • ${r.label}`,disabled:!$e(t,r.key)||B.value[h(t.key,r.key)],"onUpdate:modelValue":i=>w.value[h(t.key,r.key)]=i,onMousedown:i=>le(t,r),onKeydown:be(ve(i=>le(t,r),["prevent"]),["enter"]),onChange:i=>Ce(t,r)},null,40,ct),[[fe,w.value[h(t.key,r.key)]]])])],2),l("td",{class:$(["text-center border-r",[O(r),I(r)]])},[l("label",ut,[Q(l("input",{type:"checkbox",class:"h-4 w-4 accent-sky-500","aria-label":`Target • ${t.name} • ${r.label}`,disabled:!Oe(t,r.key)||B.value[h(t.key,r.key)],"onUpdate:modelValue":i=>C.value[h(t.key,r.key)]=i,onMousedown:i=>de(t,r),onKeydown:be(ve(i=>de(t,r),["prevent"]),["enter"]),onChange:i=>Se(t,r)},null,40,mt),[[fe,C.value[h(t.key,r.key)]]])])],2),l("td",{class:$(["border-r text-center",O(r)])},[l("span",{class:$(["inline-block rounded py-0.5 font-mono text-[12px]",ue(t.cells[r.key],"ic")])},_(ce(t.cells[r.key],t.employees_total,"ic")),3)],2),l("td",{class:$(["border-y text-center border-r-2",[O(r),I(r)]])},[l("span",{class:$(["inline-block rounded py-0.5 font-mono text-[12px]",ue(t.cells[r.key],"co")])},_(ce(t.cells[r.key],t.employees_total,"co")),3),(u=t.cells[r.key])!=null&&u.max_total?(b(),f("div",yt,_(t.cells[r.key].final_total)+" / "+_(t.cells[r.key].max_total),1)):pe("",!0)],2)],64)}),128))]))),128)),!j(a)||j(a).length===0?(b(),f("tr",pt,o[10]||(o[10]=[l("td",{colspan:"100",class:"px-3 py-6 text-center text-gray-600"},"No data",-1)]))):pe("",!0)])])]))])}}},gt=Ee(bt,[["__scopeId","data-v-5dcbc808"]]);export{gt as default};
