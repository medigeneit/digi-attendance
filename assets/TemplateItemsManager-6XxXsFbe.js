import{N as M,r as _,O as N,A as V,x as S,c as h,g as O,o as g,a as e,t as C,h as U,v as F,Q as E,b as L,e as A,n as D,k as q,F as R,y as T}from"./index-BnK1mVVG.js";const j=M("templateItems",()=>{const d=_([]),k=_(!1),r=_(!1),a=_("");function v(){d.value.sort((u,o)=>(u.order_no??0)-(o.order_no??0)||u.id-o.id)}async function x(u){var o,l,i,p;k.value=!0,a.value="";try{const{data:t}=await N.get(`/checklist-templates/${u}/items`);d.value=((t==null?void 0:t.data)||[]).map(s=>({...s})),v()}catch(t){a.value=((l=(o=t==null?void 0:t.response)==null?void 0:o.data)==null?void 0:l.message)||"Failed to load items",(p=(i=window==null?void 0:window.notify)==null?void 0:i.error)==null||p.call(i,a.value)}finally{k.value=!1}}async function b(u,o){var l,i,p,t,s,n;r.value=!0,a.value="";try{const{data:c}=await N.post(`/checklist-templates/${u}/items`,o),y=(c==null?void 0:c.data)||{};return d.value.push(y),v(),(i=(l=window==null?void 0:window.notify)==null?void 0:l.success)==null||i.call(l,"Item added"),y}catch(c){throw a.value=((t=(p=c==null?void 0:c.response)==null?void 0:p.data)==null?void 0:t.message)||"Failed to add item",(n=(s=window==null?void 0:window.notify)==null?void 0:s.error)==null||n.call(s,a.value),c}finally{r.value=!1}}async function w(u,o){var p,t,s,n;r.value=!0,a.value="";const l=d.value.findIndex(c=>c.id===u),i=l>=0?{...d.value[l]}:null;l>=0&&(d.value[l]={...d.value[l],...o});try{const{data:c}=await N.patch(`/checklist-template-items/${u}`,o),y=(c==null?void 0:c.data)||{};return l>=0&&(d.value[l]={...y}),v(),y}catch(c){throw l>=0&&i&&(d.value[l]=i),a.value=((t=(p=c==null?void 0:c.response)==null?void 0:p.data)==null?void 0:t.message)||"Failed to update item",(n=(s=window==null?void 0:window.notify)==null?void 0:s.error)==null||n.call(s,a.value),c}finally{r.value=!1}}async function $(u){var i,p,t,s,n,c;r.value=!0,a.value="";const o=d.value.findIndex(y=>y.id===u),l=o>=0?{...d.value[o]}:null;o>=0&&d.value.splice(o,1);try{await N.delete(`/checklist-template-items/${u}`),(p=(i=window==null?void 0:window.notify)==null?void 0:i.success)==null||p.call(i,"Item deleted")}catch(y){throw o>=0&&l&&d.value.splice(o,0,l),a.value=((s=(t=y==null?void 0:y.response)==null?void 0:t.data)==null?void 0:s.message)||"Failed to delete item",(c=(n=window==null?void 0:window.notify)==null?void 0:n.error)==null||c.call(n,a.value),y}finally{r.value=!1}}function I(u){const o=d.value.findIndex(l=>l.id===u);if(o>0){const l=d.value[o-1],i=d.value[o],p=l.order_no;l.order_no=i.order_no,i.order_no=p,d.value[o-1]=i,d.value[o]=l}}function m(u){const o=d.value.findIndex(l=>l.id===u);if(o>=0&&o<d.value.length-1){const l=d.value[o+1],i=d.value[o],p=l.order_no;l.order_no=i.order_no,i.order_no=p,d.value[o+1]=i,d.value[o]=l}}async function f(){var u,o,l,i;r.value=!0;try{const p=d.value.map((t,s)=>{const n=s;return(t.order_no??0)!==n?(t.order_no=n,N.patch(`/checklist-template-items/${t.id}`,n)):Promise.resolve()});await Promise.allSettled(p),(o=(u=window==null?void 0:window.notify)==null?void 0:u.success)==null||o.call(u,"Order saved")}catch{throw(i=(l=window==null?void 0:window.notify)==null?void 0:l.error)==null||i.call(l,"Failed to save order"),new Error("Failed to save order")}finally{r.value=!1,v()}}return{items:d,loading:k,saving:r,error:a,fetch:x,add:b,update:w,remove:$,moveUp:I,moveDown:m,saveOrder:f}}),B={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4"},P={class:"w-full max-w-lg rounded-2xl bg-white p-5 shadow-xl"},K={class:"mb-4 flex items-center justify-between"},z={class:"text-lg font-semibold"},J={class:"space-y-4"},Q={key:0},Y={class:"flex items-center gap-3"},G={class:"flex items-center gap-2"},H={class:"ml-auto w-40"},W={key:1,class:"text-sm text-rose-600"},X={class:"mt-6 flex justify-end gap-2"},Z={__name:"AddEditItemModal",props:{open:{type:Boolean,default:!1},mode:{type:String,default:"add"},model:{type:Object,default:()=>({})},nextOrder:{type:Number,default:0}},emits:["close","submit"],setup(d,{emit:k}){const r=d,a=k,v=_({item_key:"",label:"",required:!1,order_no:0}),x=_("");V(()=>r.open,I=>{var m,f,u,o;I&&(r.mode==="edit"?v.value={item_key:((m=r.model)==null?void 0:m.item_key)??"",label:((f=r.model)==null?void 0:f.label)??"",required:!!((u=r.model)!=null&&u.required),order_no:((o=r.model)==null?void 0:o.order_no)??0}:v.value={item_key:"",label:"",required:!1,order_no:r.nextOrder??0},x.value="")},{immediate:!0});const b=S(()=>r.mode==="edit"?"Edit Item":"Add Item");function w(){a("close")}function $(){if(x.value="",r.mode==="add"&&!v.value.item_key.trim()){x.value="Item key is required";return}if(!v.value.label.trim()){x.value="Label is required";return}a("submit",{...v.value})}return(I,m)=>d.open?(g(),h("div",B,[e("div",P,[e("div",K,[e("h3",z,C(b.value),1),e("button",{class:"rounded p-1 hover:bg-gray-100",onClick:w,title:"Close"}," ✕ ")]),e("div",J,[r.mode==="add"?(g(),h("div",Q,[m[4]||(m[4]=e("label",{class:"block text-sm font-medium"},"Item Key",-1)),U(e("input",{"onUpdate:modelValue":m[0]||(m[0]=f=>v.value.item_key=f),type:"text",class:"mt-1 w-full rounded border px-3 py-2",placeholder:"e.g., nid_copy"},null,512),[[F,v.value.item_key]]),m[5]||(m[5]=e("p",{class:"mt-1 text-xs text-gray-500"},"Unique machine key (max 80 chars)",-1))])):O("",!0),e("div",null,[m[6]||(m[6]=e("label",{class:"block text-sm font-medium"},"Label",-1)),U(e("input",{"onUpdate:modelValue":m[1]||(m[1]=f=>v.value.label=f),type:"text",class:"mt-1 w-full rounded border px-3 py-2",placeholder:"e.g., National ID Copy"},null,512),[[F,v.value.label]])]),e("div",Y,[e("label",G,[U(e("input",{"onUpdate:modelValue":m[2]||(m[2]=f=>v.value.required=f),type:"checkbox",class:"h-4 w-4"},null,512),[[E,v.value.required]]),m[7]||(m[7]=e("span",null,"Required",-1))]),e("div",H,[m[8]||(m[8]=e("label",{class:"block text-sm font-medium"},"Order No",-1)),U(e("input",{"onUpdate:modelValue":m[3]||(m[3]=f=>v.value.order_no=f),type:"number",class:"mt-1 w-full rounded border px-3 py-2",min:"0"},null,512),[[F,v.value.order_no,void 0,{number:!0}]])])]),x.value?(g(),h("p",W,C(x.value),1)):O("",!0)]),e("div",X,[e("button",{class:"rounded border px-3 py-2 hover:bg-gray-50",onClick:w},"Cancel"),e("button",{class:"rounded bg-gray-900 px-3 py-2 text-white hover:bg-gray-800",onClick:$},C(r.mode==="edit"?"Update":"Create"),1)])])])):O("",!0)}},ee={class:"mx-auto max-w-7xl p-4"},te={class:"mb-4 flex items-center gap-2"},se={class:"flex-1"},le={class:"text-md text-gray-500"},oe={class:"mb-3 flex items-center gap-2"},ae={class:"ml-auto flex items-center gap-2"},ne=["disabled"],de={class:"overflow-hidden rounded-xl border bg-white"},ie={class:"min-w-full text-sm"},re={key:0},ue={class:"px-3 py-2"},ce={class:"flex items-center gap-1"},me=["disabled","onClick"],ve=["disabled","onClick"],pe={class:"ml-2 tabular-nums text-gray-500"},ye={class:"px-3 py-2 font-mono text-xs text-gray-700"},fe={class:"px-3 py-2"},xe={class:"truncate"},be={class:"px-3 py-2"},_e={class:"inline-flex cursor-pointer items-center gap-2"},he=["checked","disabled","onChange"],ge={class:"text-xs"},ke={class:"px-3 py-2"},we=["onClick"],Ce={key:1},$e={key:0,class:"mt-3 text-sm text-gray-500"},Ie={__name:"TemplateItemsManager",setup(d){const k=L(),r=S(()=>Number(k.params.id||k.query.template_id)),a=j(),v=_(!1),x=_("add"),b=_(null),w=_(""),$=S(()=>{const t=(w.value||"").toLowerCase().trim();return t?a.items.filter(s=>(s.item_key||"").toLowerCase().includes(t)||(s.label||"").toLowerCase().includes(t)):a.items}),I=S(()=>{var t;return((t=a.items)==null?void 0:t.length)||0});A(async()=>{r.value&&await a.fetch(r.value)});function m(){x.value="add",b.value=null,v.value=!0}function f(t){x.value="edit",b.value={...t},v.value=!0}async function u(t){var s;try{if(x.value==="add")await a.add(r.value,t);else if((s=b.value)!=null&&s.id){const n={label:t.label,required:!!t.required,order_no:t.order_no??b.value.order_no};await a.update(b.value.id,n)}v.value=!1}catch{}}async function o(t){var s,n;try{await a.update(t.id,{required:!t.required}),(n=(s=window==null?void 0:window.notify)==null?void 0:s.success)==null||n.call(s,"Required updated")}catch{}}function l(t){a.moveUp(t.id)}function i(t){a.moveDown(t.id)}async function p(){await a.saveOrder()}return(t,s)=>(g(),h("div",ee,[e("div",te,[e("div",se,[s[2]||(s[2]=e("h2",{class:"text-xl font-semibold"},"Checklist Template Items",-1)),e("p",le,"Template : "+C(r.value==1?"Joining Checklist Items":"Exist Checklist Items"),1)]),e("button",{class:"rounded bg-gray-900 px-3 py-2 text-white hover:bg-gray-800",onClick:m}," + Add Item ")]),e("div",oe,[U(e("input",{"onUpdate:modelValue":s[0]||(s[0]=n=>w.value=n),type:"text",placeholder:"Search (key/label)…",class:"w-64 rounded border px-3 py-2"},null,512),[[F,w.value]]),e("div",ae,[e("button",{class:"rounded border px-3 py-2 hover:bg-gray-50",disabled:q(a).saving,onClick:p,title:"Persist current order"},"Save Order",8,ne)])]),e("div",de,[e("table",ie,[s[5]||(s[5]=e("thead",{class:"bg-gray-50 text-left"},[e("tr",null,[e("th",{class:"px-3 py-2 w-16"},"Order"),e("th",{class:"px-3 py-2"},"Item Key"),e("th",{class:"px-3 py-2"},"Label"),e("th",{class:"px-3 py-2 w-28"},"Required"),e("th",{class:"px-3 py-2 w-40"},"Actions")])],-1)),e("tbody",null,[q(a).loading?(g(),h("tr",re,s[3]||(s[3]=[e("td",{colspan:"5",class:"px-3 py-4"},[e("div",{class:"h-4 w-full animate-pulse rounded bg-gray-100"})],-1)]))):O("",!0),(g(!0),h(R,null,T($.value,(n,c)=>(g(),h("tr",{key:n.id,class:"border-t hover:bg-gray-50"},[e("td",ue,[e("div",ce,[e("button",{class:"rounded border px-2 py-1 text-xs hover:bg-gray-50 disabled:opacity-50",disabled:c===0||q(a).saving,onClick:y=>l(n),title:"Move up"},"↑",8,me),e("button",{class:"rounded border px-2 py-1 text-xs hover:bg-gray-50 disabled:opacity-50",disabled:c===$.value.length-1||q(a).saving,onClick:y=>i(n),title:"Move down"},"↓",8,ve),e("span",pe,C(n.order_no??c),1)])]),e("td",ye,C(n.item_key),1),e("td",fe,[e("div",xe,C(n.label),1)]),e("td",be,[e("label",_e,[e("input",{type:"checkbox",class:"h-4 w-4",checked:!!n.required,disabled:q(a).saving,onChange:y=>o(n)},null,40,he),e("span",ge,C(n.required?"Yes":"No"),1)])]),e("td",ke,[e("button",{class:"btn-2 py-1",onClick:y=>f(n)},"Edit",8,we)])]))),128)),!q(a).loading&&$.value.length===0?(g(),h("tr",Ce,s[4]||(s[4]=[e("td",{colspan:"5",class:"px-3 py-6 text-center text-gray-500"},"No items",-1)]))):O("",!0)])])]),q(a).saving?(g(),h("div",$e,"Saving…")):O("",!0),D(Z,{open:v.value,mode:x.value,model:b.value,"next-order":I.value,onClose:s[1]||(s[1]=n=>v.value=!1),onSubmit:u},null,8,["open","mode","model","next-order"])]))}};export{Ie as default};
