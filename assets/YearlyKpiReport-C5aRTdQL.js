import{r as w,q as le,x as S,c as l,j as c,o as a,a as e,t as o,k as me,v as Fe,F as N,e as C,b as L,_ as He,D as Je,f as We,u as Qe,G as Re,h as Xe,d as ne,l as he,m as W,H as Ae,s as O,z as Me,T as De}from"./index-CoogvYU6.js";import{L as Ze}from"./LoaderView-efXzsdrB.js";import{_ as et}from"./EmployeeFilter-BbRqoWqZ.js";import{u as Te}from"./kpi-report-CTaj6cgN.js";import"./company-CqDwffB9.js";import"./department-BMtCBpFM.js";import"./EmployeeDropdownInput-Bw9ACFm9.js";import"./SelectDropdown-Cjworybx.js";import"./UserChip-CsbhZ0TU.js";import"./user-CKqgBbUp.js";const tt={key:0,class:"fixed inset-0 z-50"},st={class:"absolute left-1/2 top-1/2 w-[95vw] max-w-3xl -translate-x-1/2 -translate-y-1/2 rounded-xl bg-white shadow"},nt={class:"flex items-center justify-between border-b px-4 py-3"},lt={class:"text-xs text-gray-500"},at={class:"px-4 py-3"},ot={key:0,class:"py-6 text-center text-sm text-gray-600"},it={key:1},rt={key:0,class:"mb-3 rounded-md border border-red-200 bg-red-50 p-2 text-sm text-red-700"},dt={class:"mb-4 rounded-lg border p-3"},ut={class:"mb-1 text-sm font-semibold"},ct={class:"text-xs text-gray-500 mb-2"},pt=["disabled","max"],mt={key:0,class:"mt-2 text-xs text-gray-500"},yt={class:"rounded-lg border"},_t={class:"max-h-[320px] overflow-auto"},bt={class:"font-medium"},xt={class:"text-xs text-gray-500"},vt={class:"text-xs text-gray-600"},ft={key:0},gt={key:0,class:"px-3 py-4 text-sm text-gray-500"},ht={class:"flex items-center justify-end gap-2 border-t px-4 py-3"},kt=["disabled"],wt={__name:"KpiMarkingModal",props:{open:Boolean,cycleId:{type:Number,required:!0},employeeId:{type:Number,required:!0},employeeName:{type:String,default:""},laneKey:{type:String,default:"supv_director"},group:{type:String,default:"personal"}},emits:["update:open","saved"],setup(Q,{emit:U}){const D=Q,G=U,X=Te(),A=w(!1),F=w(""),$=w(D.laneKey),p=w([]),Z=w({}),P=w([]),E=w(0),f=w("");function ae(u){return u==="supv_director"?"Supv. Director":u==="da"?"DA":u}function B(){G("update:open",!1)}function T(){if(f.value===""||f.value==null)return;const u=Number(E.value||0),v=Number(f.value);if(!Number.isFinite(v))return;let y=v;y<0&&(y=0),u>0&&y>u&&(y=u),String(f.value)!==String(y)&&(f.value=String(y))}function V(){var y;const u=((y=Z.value)==null?void 0:y[$.value])||[],v=Array.isArray(u)?u[u.length-1]:null;f.value=(v==null?void 0:v.obtained)??"",T()}async function oe(){A.value=!0,F.value="";try{const u=await X.fetchMarkingForm({cycle_id:D.cycleId,employee_id:D.employeeId,lane_keys:"supv_director,da",include_personal_items:1,force:!0});p.value=u.lanes||[],Z.value=u.reviewsByLane||{},P.value=u.personalItems||[],E.value=Number(u.personalMaxTotal||0),V()}catch(u){F.value=(u==null?void 0:u.message)||"Failed to load"}finally{A.value=!1}}le(()=>D.open,u=>{u&&($.value=D.laneKey||"supv_director",oe())}),le(()=>D.laneKey,u=>{u&&($.value=u)}),le($,()=>{V()}),le([f,E],()=>{T()});async function Y(){F.value="";const u=Number(E.value||0),v=Number(f.value);if(!Number.isFinite(v))return F.value="Overall mark must be a number.";if(v<0||u>0&&v>u)return F.value=`Overall mark must be between 0 and ${u}.`;A.value=!0;try{await X.submitOverallMark({cycle_id:D.cycleId,employee_id:D.employeeId,reviewer_lane:$.value,overall_mark:v,group_key:D.group||"personal"}),G("saved"),B()}catch(y){F.value=(y==null?void 0:y.message)||"Submit failed"}finally{A.value=!1}}const K=S(()=>{const u=(p.value||[]).find(v=>v.key===$.value);return!!(u!=null&&u.can_current_user_review)});return(u,v)=>Q.open?(a(),l("div",tt,[e("div",{class:"absolute inset-0 bg-black/40",onClick:B}),e("div",st,[e("div",nt,[e("div",null,[v[1]||(v[1]=e("div",{class:"text-sm font-semibold"},"KPI Marking (Overall)",-1)),e("div",lt,o(Q.employeeName?Q.employeeName+" • ":"")+"Personal Group ",1)]),e("button",{class:"text-sm px-2 py-1",onClick:B},"✕")]),e("div",at,[A.value?(a(),l("div",ot,"Loading...")):(a(),l("div",it,[F.value?(a(),l("div",rt,o(F.value),1)):c("",!0),e("div",dt,[e("div",ut,o(ae($.value))+" Overall Mark",1),e("div",ct," Out of "+o(E.value||0),1),me(e("input",{"onUpdate:modelValue":v[0]||(v[0]=y=>f.value=y),type:"number",step:"0.01",class:"w-full rounded-md border px-3 py-2 text-sm",disabled:!K.value,max:E.value||void 0,min:"0",placeholder:"Enter overall mark"},null,8,pt),[[Fe,f.value]]),K.value?c("",!0):(a(),l("div",mt," You cannot submit for this lane. "))]),e("div",yt,[v[2]||(v[2]=e("div",{class:"border-b px-3 py-2 text-sm font-semibold"},"Personal Items (View Only)",-1)),e("div",_t,[(a(!0),l(N,null,C(P.value,y=>(a(),l("div",{key:y.id,class:"flex items-start justify-between gap-3 border-b px-3 py-2 text-sm"},[e("div",null,[e("div",bt,o(y.title),1),e("div",xt,o(y==null?void 0:y.label),1)]),e("div",vt,[L(" Max: "+o(y.max)+" ",1),y.weight!==null&&y.weight!==void 0?(a(),l("span",ft," • W: "+o(y.weight),1)):c("",!0)])]))),128)),P.value.length?c("",!0):(a(),l("div",gt," No personal items found in cycle. "))])])]))]),e("div",ht,[e("button",{class:"rounded-md border px-4 py-2 text-sm",onClick:B},"Cancel"),e("button",{class:"rounded-md bg-sky-600 px-4 py-2 text-sm text-white disabled:opacity-50",disabled:A.value||!K.value,onClick:Y}," Submit ",8,kt)])])])):c("",!0)}},Nt={class:"space-y-4 px-4 print:px-0"},St={class:"hidden print:block mx-auto text-center mb-3"},Ct={class:"text-sm text-gray-600"},Lt={class:"font-medium"},$t={class:"font-medium"},jt={class:"flex flex-wrap items-end gap-3 sticky top-14 z-10 bg-white/80 backdrop-blur print:hidden p-4 -mx-2 rounded-xl border border-gray-100"},Rt={class:"w-full flex items-start gap-3"},At={class:"flex gap-2"},Mt=["disabled"],Dt=["value"],Ft={class:"flex flex-wrap items-center gap-2 w-full"},Tt=["value"],Et=["disabled"],It=["disabled"],Ot={key:0,class:"py-10 text-center"},Yt={key:1,class:"rounded-xl border border-red-200 bg-red-50 p-3 text-red-700",role:"alert"},Kt={class:"rounded-2xl border border-gray-200 bg-white shadow-sm p-4 print:hidden"},zt={class:"flex flex-wrap items-start justify-between gap-3"},Gt={class:"text-xs font-semibold uppercase tracking-[0.18em] text-indigo-500"},Pt={class:"mt-1 text-lg font-semibold text-slate-900"},Vt={class:"mt-1 flex flex-wrap gap-2 text-xs text-slate-600"},qt={class:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5"},Ut={class:"text-slate-900"},Bt={key:0,class:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5"},Ht={class:"text-slate-900"},Jt={class:"text-xs text-slate-500"},Wt={class:"space-y-3 md:hidden"},Qt={class:"flex items-start justify-between gap-3"},Xt={class:"min-w-0"},Zt=["title"],es={class:"mt-0.5 text-[11px] text-slate-500"},ts={key:0},ss={key:1},ns={key:2},ls={key:3},as={class:"shrink-0"},os={key:0,class:"mt-2 grid grid-cols-4 gap-2"},is=["title"],rs={class:"mt-1 flex flex-col items-center gap-1"},ds=["onClick"],us={key:1,class:"flex flex-col items-center gap-1"},cs={class:"mt-3 grid grid-cols-3 gap-2"},ps={class:"text-[10px] font-medium text-slate-600"},ms={class:"mt-1 text-[11px] font-semibold text-slate-900"},ys={class:"mt-3 flex items-center justify-between gap-3"},_s=["onClick"],bs={key:0,class:"px-3 py-8 text-center text-gray-600"},xs={class:"hidden md:block rounded-2xl border bg-white shadow-sm"},vs={class:"w-full text-sm"},fs={class:"sticky top-40 z-[5] bg-gray-100/95 backdrop-blur"},gs={class:"text-xs font-semibold text-slate-700"},hs={class:"text-xs font-semibold text-slate-700"},ks={class:"sticky left-0 z-[4] border-r bg-inherit px-2 text-center"},ws={class:"sticky z-[4] border-r bg-inherit px-2",style:{left:"3rem"}},Ns={class:"max-w-[12rem]"},Ss=["title"],Cs={class:"text-[11px] text-slate-500 truncate"},Ls={key:0},$s={key:1},js={key:2},Rs={key:3},As={class:"border-r px-2 text-center"},Ms={class:"flex flex-col items-center gap-1"},Ds=["onClick"],Fs={key:1,class:"flex flex-col items-center gap-1"},Ts={class:"px-2"},Es={class:"space-y-1 text-[11px] text-slate-600"},Is={class:"mt-2 flex items-center justify-between gap-3"},Os=["onClick"],Ys={key:0},Ks={class:"relative max-w-2xl w-full rounded-2xl border border-slate-200 bg-white p-5 shadow-xl",role:"dialog","aria-modal":"true","aria-label":"Latest review details"},zs={class:"flex items-start justify-between gap-4"},Gs={class:"text-lg font-semibold text-slate-900"},Ps={class:"text-xs text-slate-500"},Vs={key:0},qs={key:1},Us={class:"text-xs text-slate-500"},Bs={class:"mt-4 space-y-4 text-slate-700"},Hs={class:"rounded-xl border border-slate-200 bg-slate-50 p-4"},Js={class:"mt-3 space-y-2 text-xs text-slate-700"},Ws={key:0},Qs={class:"mt-1 text-slate-600"},Xs={key:1},Zs={class:"mt-1 text-slate-600"},en={key:2},tn={class:"mt-1 text-slate-600"},sn={key:3,class:"text-slate-500"},nn={class:"relative max-w-3xl w-full rounded-2xl border border-slate-200 bg-white shadow-xl overflow-hidden",role:"dialog","aria-modal":"true","aria-label":"All reviewer comments"},ln={class:"p-5 border-b border-slate-200 bg-white"},an={class:"flex items-start justify-between gap-4"},on={class:"min-w-0"},rn={class:"text-lg font-semibold text-slate-900 truncate"},dn={class:"mt-0.5 text-xs text-slate-500"},un={key:0},cn={key:1},pn={class:"mt-2 flex flex-wrap gap-2 text-[11px] text-slate-600"},mn={class:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5"},yn={class:"text-slate-900"},_n={class:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5"},bn={class:"text-slate-900"},xn={class:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5"},vn={class:"text-slate-900"},fn={class:"max-h-[75vh] overflow-y-auto p-5 space-y-4"},gn={key:0,class:"rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600"},hn={class:"px-4 py-3 bg-slate-50 border-b border-slate-200 flex flex-wrap items-center justify-between gap-2"},kn={class:"flex items-center gap-2 min-w-0"},wn=["title"],Nn={class:"text-[11px] text-slate-500 truncate"},Sn={class:"flex flex-wrap gap-2 text-[11px] text-slate-600"},Cn={class:"rounded-full border border-slate-200 bg-white px-2 py-0.5"},Ln={class:"text-slate-900"},$n={class:"rounded-full border border-slate-200 bg-white px-2 py-0.5"},jn={class:"text-slate-900"},Rn={class:"p-4 space-y-3"},An={class:"flex flex-wrap items-start justify-between gap-2"},Mn={class:"min-w-0"},Dn={class:"text-sm font-semibold text-slate-900 truncate"},Fn={class:"mt-0.5 text-[11px] text-slate-500"},Tn={key:0},En={class:"flex flex-wrap gap-2"},In={class:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5 text-[11px] font-semibold text-slate-700"},On={key:0,class:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5 text-[11px] font-semibold text-slate-700"},Yn={class:"mt-3 space-y-2 text-xs text-slate-700"},Kn={key:0},zn={class:"mt-1 list-disc pl-5 text-slate-600 space-y-1"},Gn={key:1},Pn={class:"mt-1 list-disc pl-5 text-slate-600 space-y-1"},Vn={key:2},qn={class:"mt-1 list-disc pl-5 text-slate-600 space-y-1"},Un={key:3,class:"text-slate-500"},Bn={key:0,class:"text-sm text-slate-500"},Hn={__name:"YearlyKpiReport",setup(Q){const U=Te(),{reports:D,isLoading:G,error:X}=Je(U),A=We(),F=Qe(),$=S(()=>({company_id:A.query.company_id??"",department_id:A.query.department_id??"",employee_id:A.query.employee_id??"",line_type:A.query.line_type??"executive"})),p=Re({company_id:$.value.company_id,department_id:$.value.department_id,employee_id:$.value.employee_id,line_type:$.value.line_type}),Z=w(!1);function P(t,s){var i,r;return t!=null&&t.marking_permissions&&Object.prototype.hasOwnProperty.call(t.marking_permissions,s)?!!t.marking_permissions[s]:!!((r=(i=t==null?void 0:t.lane_lens)==null?void 0:i[s])!=null&&r.can_current_user_review)}const E=new Date().getFullYear(),f=w(Number(A.query.year??E)),ae=w([]);function B(t=2020,s=E+1){const i=[];for(let r=s;r>=t;r--)i.push(r);ae.value=i}const T=S(()=>D.value||{}),V=S(()=>{var t;return((t=T.value)==null?void 0:t.cycle)||{}}),oe=S(()=>{var t;return((t=T.value)==null?void 0:t.filters)||{}}),Y=S(()=>{var s;return[...Array.isArray((s=T.value)==null?void 0:s.lane_definitions)?T.value.lane_definitions:[]].sort((i,r)=>Number(i.rank||0)-Number(r.rank||0))}),K=S(()=>Y.value.filter(t=>{const s=String((t==null?void 0:t.key)||"").toLowerCase(),i=String((t==null?void 0:t.label)||"").toLowerCase();return!(s==="hr"||/^hr\d*$/.test(s)||s.includes("avg")||/\bavg\b/i.test(i)||i.includes("average")||i.includes("hr")&&s==="")})),u=S(()=>{var t;return((t=T.value)==null?void 0:t.summary)||{}}),v=S(()=>{var t;return Array.isArray((t=T.value)==null?void 0:t.data)?T.value.data:[]}),y=S(()=>{var s;if(Y.value.length)return Y.value.length;const t=Number(((s=V.value)==null?void 0:s.lane_count)??0);return Number.isFinite(t)&&t>0?t:0}),ye=[{key:"training",label:"Training"},{key:"discipline",label:"Dis"},{key:"execution",label:"Exe"},{key:"target",label:"Target"},{key:"final",label:"Final"}];function Ee(t){const s=Number(t);return Number.isFinite(s)?`${Math.round(s)}%`:"0%"}function ee(t,s=2){const i=Number(t);if(!Number.isFinite(i))return"—";const r=Number(i.toFixed(s));return Number.isInteger(r),String(r)}function H(t,s="-"){const i=(t??"").toString().trim();return i||s}function ke(t){if(!t)return null;const s=new Date(t);return Number.isNaN(s.getTime())?null:s.toLocaleDateString()}function Ie(){return new Date().toLocaleString()}function J(t){return!Array.isArray(t)||t.length===0?null:t.join("; ")}function _e(t){return Array.isArray(t)?t.map(s=>typeof s=="string"?s.trim():"").filter(s=>s!==""):typeof t=="string"?t.split(/[\r\n;]+/).map(s=>s.trim()).filter(s=>s!==""):[]}function we(t){var r;const s=Number(((r=t==null?void 0:t.progress)==null?void 0:r.lanes_reviewed)??0),i=Number(y.value??0);return i?s>=i?"bg-emerald-50 text-emerald-700 border-emerald-200":s>0?"bg-amber-50 text-amber-700 border-amber-200":"bg-rose-50 text-rose-700 border-rose-200":"bg-slate-50 text-slate-600 border-slate-200"}function be(t){var r;const s=Number(((r=t==null?void 0:t.progress)==null?void 0:r.lanes_reviewed)??0),i=Number(y.value??0);return i?`${s}/${i}`:`${s}`}function Oe(t){if(!t)return"No reviews submitted yet";const s=t.reviewer_name||"Latest reviewer",i=t.reviewer_lane?` (${t.reviewer_lane})`:"",r=t.obtained_total??null,b=t.max_total??null,k=Number.isFinite(Number(r))&&Number.isFinite(Number(b))?`${Number(r)}/${Number(b)}`:r!==null?`${r}`:null,n=ke(t.submitted_at),x=[`${s}${i}`];return k&&x.push(k),n&&x.push(n),x.join(" • ")}function M(t,s){var g,te,_,pe;const i=String(s||""),b=i==="hr"||i==="hr1"?((g=t==null?void 0:t.computed)==null?void 0:g.hr_total)??null:((_=(te=t==null?void 0:t.computed)==null?void 0:te.personal_by_lane)==null?void 0:_[i])??null,h=Number(b);if(Number.isFinite(h))return{text:ee(h),cls:h>0?"bg-emerald-50 text-emerald-700 border-emerald-200":"bg-amber-50 text-amber-700 border-amber-200"};const n=(Array.isArray(t==null?void 0:t.lanes)?t.lanes:[]).find(I=>(I==null?void 0:I.key)===i)||null;if(!n)return{text:"-",cls:"bg-slate-50 text-slate-500 border border-slate-200"};const j=!!(n.latest_review_at||n.submitted_at||n.submittedAt||((pe=n.review)==null?void 0:pe.submitted_at))||!!(Array.isArray(n.reviewers)&&n.reviewers.length),d=n.average_marks??n.obtained_total??n.obtained??null,R=Number(d);return Number.isFinite(R)?{text:ee(R),cls:j?"bg-emerald-50 text-emerald-700 border-emerald-200":"bg-amber-50 text-amber-700 border-amber-200"}:{text:"-",cls:j?"bg-emerald-50 text-emerald-700 border-emerald-200":"bg-amber-50 text-amber-700 border-amber-200"}}const Ne=S(()=>v.value.map(t=>{var b,h,k,n;const s=t.employee||{},i=t.latest_review||null,r=t.comments||{};return{...t,_name:H(s.name),_company:H(s.company,""),_dept:H(s.department,""),_joining:ke(s.joining_date),_type:H(s.type,""),latestReviewSummary:Oe(i),latestReviewStrengths:J(i==null?void 0:i.strengths)||null,latestReviewGaps:J(i==null?void 0:i.gaps)||null,latestReviewSuggestions:J(i==null?void 0:i.suggestions)||null,aggregatedStrengthsList:_e(r==null?void 0:r.strengths),aggregatedGapsList:_e(r==null?void 0:r.gaps),aggregatedSuggestionsList:_e(r==null?void 0:r.suggestions),aggregatedStrengths:J(r==null?void 0:r.strengths),aggregatedGaps:J(r==null?void 0:r.gaps),aggregatedSuggestions:J(r==null?void 0:r.suggestions),computed:(t==null?void 0:t.computed)||{},finalTotal:((b=t==null?void 0:t.computed)==null?void 0:b.final)??null,finalPercent:((h=t==null?void 0:t.kpi_result)==null?void 0:h.final_percent)??((k=t==null?void 0:t.kpi_result)==null?void 0:k.final_percentage)??((n=t==null?void 0:t.kpi_result)==null?void 0:n.final)??null}})),xe=w(""),ve=w("all"),Ye=[{value:"all",label:"Any comment"},{value:"strengths",label:"Strengths"},{value:"gaps",label:"Gaps"},{value:"suggestions",label:"Suggestions"}],Ke=S(()=>xe.value.trim().toLowerCase()),ze=S(()=>{const t=Ke.value;return t?Ne.value.filter(s=>{const i=ve.value,r=[];return(i==="all"||i==="strengths")&&r.push(s.aggregatedStrengthsList||[]),(i==="all"||i==="gaps")&&r.push(s.aggregatedGapsList||[]),(i==="all"||i==="suggestions")&&r.push(s.aggregatedSuggestionsList||[]),r.some(b=>b.some(h=>h.toLowerCase().includes(t)))}):Ne.value}),ie=S(()=>ze.value),m=w(null),re=w(!1);function Se(t){m.value=t,re.value=!0}function q(){re.value=!1,m.value=null}const fe=w(!1),z=Re({employee_id:null,employee_name:"",lane_key:""}),Ge=S(()=>{const t=Y.value||[],s=[],i=n=>{n!=null&&n.key&&!s.includes(n.key)&&s.push(n.key)},r=n=>t.find(x=>x.key===n),b=n=>t.find(x=>n.test(String(x.label||""))),h=r("supv_director")||b(/supv\.?\s*director|supervising\s+director/i),k=r("da")||b(/\bda\b|director\s*of\s*admin|director\s*admin/i);return i(h),i(k),s});function de(t){return Ge.value.includes(t)}function Ce(t,s){var r,b,h,k;if(!P(t,s))return;const i=((r=t==null?void 0:t.employee)==null?void 0:r.id)??(t==null?void 0:t.employee_id)??(t==null?void 0:t.id)??null;i&&(z.cycle_id=((b=t==null?void 0:t.cycle)==null?void 0:b.id)??((h=V.value)==null?void 0:h.id)??null,z.employee_id=i,z.employee_name=(t==null?void 0:t._name)||((k=t==null?void 0:t.employee)==null?void 0:k.name)||"",z.lane_key=s,fe.value=!0)}const ue=w(!1),ce=w(!1);function Pe(){return{year:Number(f.value),company_id:p.company_id||void 0,department_id:p.department_id||void 0,employee_id:p.employee_id||void 0,line_type:p.line_type||void 0,flag:"excel"}}function Ve(){return{year:Number(f.value),company_id:p.company_id||void 0,department_id:p.department_id||void 0,employee_id:p.employee_id||void 0,line_type:p.line_type||void 0,flag:"comment_excel"}}async function qe(){ue.value=!0;try{await U.exportYearly(Pe())}catch(t){console.error("exportYearly failed:",t)}finally{ue.value=!1}}async function Ue(){ce.value=!0;try{await U.exportYearly(Ve())}catch(t){console.error("exportYearly comment_excel failed:",t)}finally{ce.value=!1}}function Le(t={}){const s={...A.query,...t};Object.keys(s).forEach(i=>{const r=s[i];(r==null||r==="")&&delete s[i]}),F.replace({query:s})}async function ge(){try{p.company_id&&await U.fetchYearlyExecutive({year:Number(f.value),company_id:p.company_id||void 0,department_id:p.department_id||void 0,employee_id:p.employee_id||void 0,line_type:p.line_type||void 0})}catch(t){console.error("fetchYearlyExecutive failed:",t)}}function Be(t={}){p.company_id=t.company_id??"",p.department_id=t.department_id??"",p.employee_id=t.employee_id??"",p.line_type=t.line_type??$.value.line_type??"executive",Z.value=!0,Le({company_id:p.company_id||void 0,department_id:p.department_id||void 0,employee_id:p.employee_id||void 0,line_type:p.line_type||void 0,year:Number(f.value)}),ge()}le(f,()=>{const t=Number(f.value);!Number.isInteger(t)||t<2e3||t>2100||Z.value&&(Le({year:t}),ge())}),Xe(()=>{B()});function $e(t){if(!t)return null;const s=new Date(t);return Number.isNaN(s.getTime())?null:s.toLocaleString()}const je=S(()=>{const t=m.value,s=Array.isArray(t==null?void 0:t.lanes)?t.lanes:[],i=new Map(Y.value.map(b=>[b.key,Number(b.rank??0)]));return[...s].sort((b,h)=>{const k=i.get(b.key)??9999,n=i.get(h.key)??9999;return k-n}).map(b=>{var n;const k=[...Array.isArray(b.reviewers)?b.reviewers:[]].sort((x,j)=>{const d=new Date(x.submitted_at||x.updated_at||0).getTime();return new Date(j.submitted_at||j.updated_at||0).getTime()-d});return{...b,label:((n=Y.value.find(x=>x.key===b.key))==null?void 0:n.label)||b.key,reviewers:k}})});return(t,s)=>{var i,r,b,h,k;return a(),l("div",Nt,[e("div",St,[s[11]||(s[11]=e("h1",{class:"text-xl font-semibold text-gray-900"},"Yearly KPI Report",-1)),e("div",Ct,[s[8]||(s[8]=L(" Cycle: ")),e("span",Lt,o(((i=V.value)==null?void 0:i.slug)||"-"),1),s[9]||(s[9]=L(" • Year: ")),e("span",$t,o(f.value),1),s[10]||(s[10]=L(" • Generated: ")),e("span",null,o(Ie()),1)])]),e("div",jt,[e("div",Rt,[ne(et,{company_id:p.company_id,"onUpdate:company_id":s[1]||(s[1]=n=>p.company_id=n),department_id:p.department_id,"onUpdate:department_id":s[2]||(s[2]=n=>p.department_id=n),employee_id:p.employee_id,"onUpdate:employee_id":s[3]||(s[3]=n=>p.employee_id=n),line_type:p.line_type,"onUpdate:line_type":s[4]||(s[4]=n=>p.line_type=n),"initial-value":$.value,class:"w-full",onFilterChange:Be},{default:he(()=>[e("div",At,[s[12]||(s[12]=e("label",{for:"",class:"top-label -top-1"},"Year",-1)),me(e("select",{"onUpdate:modelValue":s[0]||(s[0]=n=>f.value=n),class:"w-32 rounded-lg border border-gray-300 bg-white px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400/50 disabled:opacity-60",disabled:W(G),"aria-label":"Select year"},[(a(!0),l(N,null,C(ae.value,n=>(a(),l("option",{key:n,value:n},o(n),9,Dt))),128))],8,Mt),[[Ae,f.value,void 0,{number:!0}]])])]),_:1},8,["company_id","department_id","employee_id","line_type","initial-value"])]),e("div",Ft,[me(e("input",{"onUpdate:modelValue":s[5]||(s[5]=n=>xe.value=n),type:"search",placeholder:"Search gaps/strengths/suggestions",class:"flex-1 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm focus:border-sky-400 focus:ring-2 focus:ring-sky-400/50"},null,512),[[Fe,xe.value]]),me(e("select",{"onUpdate:modelValue":s[6]||(s[6]=n=>ve.value=n),class:"rounded-lg border border-gray-300 bg-white px-2 py-1 text-sm focus:border-sky-400 focus:ring-2 focus:ring-sky-400/50"},[(a(),l(N,null,C(Ye,n=>e("option",{key:n.value,value:n.value},o(n.label),9,Tt)),64))],512),[[Ae,ve.value]]),e("button",{class:"btn-1 rounded",onClick:qe,disabled:ue.value||W(G)},[s[13]||(s[13]=e("i",{class:"far fa-file-excel mr-1 text-lg text-green-600"},null,-1)),L(" "+o(ue.value?"Preparing...":"Download Excel"),1)],8,Et),e("button",{class:"btn-1 rounded",onClick:Ue,disabled:ce.value||W(G)},[s[14]||(s[14]=e("i",{class:"far fa-file-excel mr-1 text-lg text-green-600"},null,-1)),L(" "+o(ce.value?"Preparing...":"Download Comments Excel"),1)],8,It)])]),W(G)?(a(),l("div",Ot,[ne(Ze)])):W(X)?(a(),l("div",Yt,o(W(X)),1)):(a(),l(N,{key:2},[e("div",Kt,[e("div",zt,[e("div",null,[e("div",Gt," KPI Cycle • "+o(H((r=V.value)==null?void 0:r.slug)),1),e("h2",Pt," Year "+o(f.value)+" • "+o(H(p.line_type)),1),e("div",Vt,[e("span",qt,[s[15]||(s[15]=L(" Employees: ")),e("b",Ut,o(((b=u.value)==null?void 0:b.total_employees)??0),1)]),y.value?(a(),l("span",Bt,[s[16]||(s[16]=L(" Lanes: ")),e("b",Ht,o(y.value),1)])):c("",!0)])]),e("div",Jt,[s[17]||(s[17]=e("div",null,[e("b",{class:"text-slate-700"},"API Filters")],-1)),e("div",null,"line_type: "+o(((h=oe.value)==null?void 0:h.line_type)??"-"),1),e("div",null,"submitted_only: "+o((k=oe.value)!=null&&k.submitted_only?"true":"false"),1)])])]),e("div",Wt,[(a(!0),l(N,null,C(ie.value,(n,x)=>{var j;return a(),l("div",{key:"m-"+(((j=n.employee)==null?void 0:j.id)??x),class:"rounded-2xl border border-gray-200 bg-white shadow-sm p-3"},[e("div",Qt,[e("div",Xt,[e("div",{class:"text-sm font-semibold text-slate-900 truncate",title:n._name},o(x+1)+". "+o(n._name),9,Zt),e("div",es,[n._dept?(a(),l("span",ts,o(n._dept),1)):c("",!0),n._dept&&n._company?(a(),l("span",ss," • ")):c("",!0),n._company?(a(),l("span",ns,o(n._company),1)):c("",!0),n._joining?(a(),l("span",ls," • Joined "+o(n._joining),1)):c("",!0)])]),e("div",as,[e("span",{class:O(["inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[11px] font-semibold",we(n)])},o(be(n)),3)])]),K.value.length?(a(),l("div",os,[(a(!0),l(N,null,C(K.value,d=>(a(),l("div",{key:"m-lane-"+d.key,class:"rounded-xl border p-2 text-center"},[e("div",{class:"text-[10px] font-medium text-slate-600 truncate",title:d.label},o(d.label),9,is),e("div",rs,[de(d.key)&&P(n,d.key)?(a(),l("button",{key:0,type:"button",class:"group inline-flex flex-col items-center gap-1",onClick:R=>Ce(n,d.key)},[e("span",{class:O(["inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-[11px] font-semibold",M(n,d.key).cls])},o(M(n,d.key).text),3),s[18]||(s[18]=e("span",{class:"text-[10px] font-semibold text-sky-600 group-hover:text-sky-700"}," Mark/Edit ",-1))],8,ds)):de(d.key)?(a(),l("div",us,[e("span",{class:O(["inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-[11px] font-semibold",M(n,d.key).cls])},o(M(n,d.key).text),3)])):(a(),l("span",{key:2,class:O(["inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-[11px] font-semibold",M(n,d.key).cls])},o(M(n,d.key).text),3))])]))),128))])):c("",!0),e("div",cs,[(a(),l(N,null,C(ye,d=>{var R,g;return e("div",{key:"m-calc-"+d.key,class:"rounded-xl border border-slate-200 bg-slate-50 p-2 text-center"},[e("div",ps,o(d.label),1),e("div",ms,o(((R=n==null?void 0:n.computed)==null?void 0:R[d.key])==null||((g=n==null?void 0:n.computed)==null?void 0:g[d.key])===""?"—":ee(n.computed[d.key])),1)])}),64))]),e("div",ys,[e("button",{type:"button",class:"text-xs font-semibold text-sky-600 hover:text-sky-800",onClick:d=>Se(n)}," Open modal ",8,_s)])])}),128)),ie.value.length===0?(a(),l("div",bs,"No data")):c("",!0)]),e("div",xs,[e("table",vs,[e("thead",fs,[e("tr",null,[s[19]||(s[19]=e("th",{class:"sticky left-0 z-[6] border-b border-r bg-gray-100/95 px-3 py-2 text-center",style:{"min-width":"3rem",width:"3rem"}}," SL ",-1)),s[20]||(s[20]=e("th",{class:"sticky z-[6] border-b border-r bg-gray-100/95 px-2 py-1 text-left",style:{left:"3rem",minWidth:"13rem",width:"13rem"}}," Employee ",-1)),s[21]||(s[21]=e("th",{class:"border-b border-r px-2 py-1 text-center",style:{"min-width":"7rem"}}," Progress ",-1)),(a(!0),l(N,null,C(K.value,n=>(a(),l("th",{key:"lane-head-"+n.key,class:"border-b border-r px-2 py-1 text-center",style:{"min-width":"6.5rem"}},[e("span",gs,o(n.label),1)]))),128)),(a(),l(N,null,C(ye,n=>e("th",{key:"calc-head-"+n.key,class:"border-b border-r px-2 py-1 text-center",style:{"min-width":"6rem"}},[e("span",hs,o(n.label),1)])),64)),s[22]||(s[22]=e("th",{class:"border-b px-2 py-1 text-left"}," comments ",-1))])]),e("tbody",null,[(a(!0),l(N,null,C(ie.value,(n,x)=>{var j;return a(),l("tr",{key:"d-"+(((j=n.employee)==null?void 0:j.id)??x),class:"border-t hover:bg-slate-50/80 transition-colors"},[e("td",ks,o(x+1),1),e("td",ws,[e("div",Ns,[e("div",{class:"font-semibold text-slate-900 truncate",title:n._name},o(n._name),9,Ss),e("div",Cs,[n._dept?(a(),l("span",Ls,o(n._dept),1)):c("",!0),n._dept&&n._company?(a(),l("span",$s," • ")):c("",!0),n._company?(a(),l("span",js,o(n._company),1)):c("",!0),n._joining?(a(),l("span",Rs," • Joined "+o(n._joining),1)):c("",!0)])])]),e("td",As,[e("span",{class:O(["inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-[12px] font-semibold",we(n)])},o(be(n)),3)]),(a(!0),l(N,null,C(K.value,d=>(a(),l("td",{key:"lane-"+d.key+"-"+x,class:"border-r px-2 text-center"},[e("div",Ms,[de(d.key)&&P(n,d.key)?(a(),l("button",{key:0,type:"button",class:"group inline-flex flex-col items-center gap-1",onClick:R=>Ce(n,d.key)},[e("span",{class:O(["inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-[11px] font-semibold",M(n,d.key).cls])},o(M(n,d.key).text),3),s[23]||(s[23]=e("span",{class:"text-[10px] font-semibold text-sky-600 group-hover:text-sky-700"}," Mark/Edit ",-1))],8,Ds)):de(d.key)?(a(),l("div",Fs,[e("span",{class:O(["inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-[11px] font-semibold",M(n,d.key).cls])},o(M(n,d.key).text),3)])):(a(),l("span",{key:2,class:O(["inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-[11px] font-semibold",M(n,d.key).cls])},o(M(n,d.key).text),3))])]))),128)),(a(),l(N,null,C(ye,d=>{var R,g;return e("td",{key:"calc-"+d.key+"-"+x,class:"border-r px-2 text-center"},[e("span",{class:O(["inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-[11px] font-semibold",d.key==="final"?"border-sky-200 bg-sky-50 text-sky-700":"border-slate-200 bg-slate-50 text-slate-700"])},o(((R=n==null?void 0:n.computed)==null?void 0:R[d.key])==null||((g=n==null?void 0:n.computed)==null?void 0:g[d.key])===""?"—":ee(n.computed[d.key])),3)])}),64)),e("td",Ts,[e("div",Es,[e("div",Is,[e("button",{type:"button",class:"text-[11px] font-semibold text-sky-600 hover:text-sky-800",onClick:d=>Se(n)}," Open modal ",8,Os)])])])])}),128)),ie.value.length===0?(a(),l("tr",Ys,s[24]||(s[24]=[e("td",{colspan:"100",class:"px-3 py-8 text-center text-gray-600"},"No data",-1)]))):c("",!0)])])]),ne(De,{name:"fade-scale"},{default:he(()=>[re.value&&m.value?(a(),l("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center px-4 py-6",onKeydown:Me(q,["escape","window"])},[e("div",{class:"absolute inset-0 bg-slate-900/60 backdrop-blur-sm","aria-hidden":"true",onClick:q}),e("div",Ks,[e("div",zs,[e("div",null,[e("p",Gs,o(m.value._name),1),e("p",Ps,[L(o(m.value._dept||"Department unknown")+" ",1),m.value._company?(a(),l("span",Vs," • "+o(m.value._company),1)):c("",!0),m.value._joining?(a(),l("span",qs," • Joined "+o(m.value._joining),1)):c("",!0)]),e("p",Us,"Line type: "+o(m.value._type),1)]),e("button",{type:"button",class:"rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-600 hover:bg-slate-50",onClick:q}," Close ")]),e("div",Bs,[e("article",Hs,[e("div",Js,[m.value.latestReviewStrengths?(a(),l("div",Ws,[s[25]||(s[25]=e("span",{class:"font-semibold text-slate-800"},"Strengths:",-1)),e("div",Qs,o(m.value.latestReviewStrengths),1)])):c("",!0),m.value.latestReviewGaps?(a(),l("div",Xs,[s[26]||(s[26]=e("span",{class:"font-semibold text-slate-800"},"Gaps:",-1)),e("div",Zs,o(m.value.latestReviewGaps),1)])):c("",!0),m.value.latestReviewSuggestions?(a(),l("div",en,[s[27]||(s[27]=e("span",{class:"font-semibold text-slate-800"},"Suggestions:",-1)),e("div",tn,o(m.value.latestReviewSuggestions),1)])):c("",!0),!m.value.latestReviewStrengths&&!m.value.latestReviewGaps&&!m.value.latestReviewSuggestions?(a(),l("div",sn," No latest review comments ")):c("",!0)])])])])],32)):c("",!0)]),_:1})],64)),ne(De,{name:"fade-scale"},{default:he(()=>{var n,x,j,d,R;return[re.value&&m.value?(a(),l("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center px-4 py-6",onKeydown:Me(q,["escape","window"])},[e("div",{class:"absolute inset-0","aria-hidden":"true",onClick:q}),e("div",nn,[e("div",ln,[e("div",an,[e("div",on,[e("p",rn,o(m.value._name),1),e("p",dn,[L(o(m.value._dept||"Department unknown")+" ",1),m.value._company?(a(),l("span",un," • "+o(m.value._company),1)):c("",!0),m.value._joining?(a(),l("span",cn," • Joined "+o(m.value._joining),1)):c("",!0)]),e("div",pn,[e("span",mn,[s[28]||(s[28]=L(" Progress: ")),e("b",yn,o(be(m.value)),1)]),e("span",_n,[s[29]||(s[29]=L(" Final: ")),e("b",bn,o(((x=(n=m.value)==null?void 0:n.computed)==null?void 0:x.final)==null||((d=(j=m.value)==null?void 0:j.computed)==null?void 0:d.final)===""?"—":ee(m.value.computed.final)),1)]),e("span",xn,[s[30]||(s[30]=L(" Reviews: ")),e("b",vn,o(((R=m.value.progress)==null?void 0:R.review_count)??0),1)])])]),e("button",{type:"button",class:"shrink-0 rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-600 hover:bg-slate-50",onClick:q}," Close ")])]),e("div",fn,[je.value.length?c("",!0):(a(),l("div",gn," No reviews found for this employee. ")),(a(!0),l(N,null,C(je.value,g=>{var te;return a(),l("div",{key:"lane-group-"+g.key,class:"rounded-2xl border border-slate-200 bg-white overflow-hidden"},[e("div",hn,[e("div",kn,[e("span",{class:"text-sm font-semibold text-slate-900 truncate",title:g.label},o(g.label),9,wn),e("span",Nn," (key: "+o(g.key)+") ",1)]),e("div",Sn,[e("span",Cn,[s[31]||(s[31]=L(" Count: ")),e("b",Ln,o(g.count??((te=g.reviewers)==null?void 0:te.length)??0),1)]),e("span",$n,[s[32]||(s[32]=L(" Latest: ")),e("b",jn,o($e(g.latest_review_at)||"—"),1)])])]),e("div",Rn,[(a(!0),l(N,null,C(g.reviewers||[],(_,pe)=>(a(),l("div",{key:"rv-"+g.key+"-"+pe+"-"+(_.id??"x"),class:"rounded-xl border border-slate-200 bg-white p-3"},[e("div",An,[e("div",Mn,[e("div",Dn,o(_.name||"Reviewer"),1),e("div",Fn,[L(" Lane: "+o(_.lane||g.key)+" ",1),_.submitted_at||_.updated_at?(a(),l("span",Tn," • "+o($e(_.submitted_at||_.updated_at)),1)):c("",!0)])]),e("div",En,[e("span",In,o(_.percent==null?"—":Ee(_.percent)),1),_.obtained_total!=null&&_.max_total!=null?(a(),l("span",On,o(_.obtained_total),1)):c("",!0)])]),e("div",Yn,[_.strengths&&_.strengths.length?(a(),l("div",Kn,[s[33]||(s[33]=e("div",{class:"font-semibold text-slate-900"},"Strengths",-1)),e("ul",zn,[(a(!0),l(N,null,C(_.strengths,(I,se)=>(a(),l("li",{key:"s-"+se},o(I),1))),128))])])):c("",!0),_.gaps&&_.gaps.length?(a(),l("div",Gn,[s[34]||(s[34]=e("div",{class:"font-semibold text-slate-900"},"Gaps",-1)),e("ul",Pn,[(a(!0),l(N,null,C(_.gaps,(I,se)=>(a(),l("li",{key:"g-"+se},o(I),1))),128))])])):c("",!0),_.suggestions&&_.suggestions.length?(a(),l("div",Vn,[s[35]||(s[35]=e("div",{class:"font-semibold text-slate-900"},"Suggestions",-1)),e("ul",qn,[(a(!0),l(N,null,C(_.suggestions,(I,se)=>(a(),l("li",{key:"u-"+se},o(I),1))),128))])])):c("",!0),(!_.strengths||!_.strengths.length)&&(!_.gaps||!_.gaps.length)&&(!_.suggestions||!_.suggestions.length)?(a(),l("div",Un," No comments in this review. ")):c("",!0)])]))),128)),!g.reviewers||g.reviewers.length===0?(a(),l("div",Bn," No reviewers found in this lane. ")):c("",!0)])])}),128))]),e("div",{class:"p-4 border-t border-slate-200 bg-white flex items-center justify-end gap-2"},[e("button",{type:"button",class:"rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-600 hover:bg-slate-50",onClick:q}," Close ")])])],32)):c("",!0)]}),_:1}),ne(wt,{open:fe.value,"onUpdate:open":s[7]||(s[7]=n=>fe.value=n),"cycle-id":z.cycle_id,"employee-id":z.employee_id,"employee-name":z.employee_name,"lane-key":z.lane_key,group:"personal",onSaved:ge},null,8,["open","cycle-id","employee-id","employee-name","lane-key"])])}}},al=He(Hn,[["__scopeId","data-v-f3c603ca"]]);export{al as default};
