import{G as X,r as S,e as Y,H as nt,A as Z,c as d,o as a,f as b,a as t,t as g,I as E,n as $,h as c,w as D,l as _,p as v,E as tt,m as w,q as C,F as P,x as L,J as ot,K as W,g as rt,v as lt,b as it,u as dt,k as J,y as K}from"./index-D0gMtR9b.js";import{L as Q}from"./LoaderView-3M-anU0G.js";import{u as ut,_ as pt,O as M}from"./task-priority-X1hx8jG9.js";import{a as ct}from"./TaskAddForm-cWUIuqrl.js";import{_ as kt}from"./TaskEditForm-Cwrzqoqi.js";import{_ as mt,a as yt,b as ft}from"./TaskTreeView-CPtJp6G3.js";import{g as A}from"./datetime-BISRKKpq.js";import{_ as N}from"./UserChip-DliarONw.js";import{u as gt}from"./useTaskStore-Dn5uxorE.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./RequiredIcon-Ks_oyajm.js";import"./company-DSdjcazI.js";import"./useRequirementStore-Wedz0WdA.js";import"./SectionLoading-Bc1XnoR8.js";const _t={key:0},bt={key:0},xt={key:1},vt=X({__name:"CountdownTimer",props:{targetDateTime:{}},setup(i){const e=i,s=S(u());let l;function u(){const m=new Date(e.targetDateTime).getTime()-new Date().getTime(),y=Math.floor(m/1e3%60),o=Math.floor(m/1e3/60%60),p=Math.floor(m/(1e3*60*60)%24),k=Math.floor(m/(1e3*60*60*24));return{total:m,days:k,hours:p,minutes:o,seconds:y}}function n(){s.value=u()}return Y(()=>{l=setInterval(()=>{n(),s.value.total<=0&&clearInterval(l)},1e3)}),nt(()=>clearInterval(l)),Z(()=>e.targetDateTime,()=>{n(),clearInterval(l)}),(m,y)=>s.value.total>0?(a(),d("div",_t,[s.value.days?(a(),d("span",bt,g(s.value.days)+"d ",1)):b("",!0),t("span",null,g(s.value.hours.toString().padStart(2,"0"))+"h :",1),t("span",null,g(s.value.minutes.toString().padStart(2,"0"))+"m :",1),t("span",null,g(s.value.seconds.toString().padStart(2,"0"))+"s",1)])):(a(),d("div",xt,[E(m.$slots,"expired",{},()=>[y[0]||(y[0]=$("Timeâ€™s up!"))])]))}}),ht={class:"mb-3"},Tt={key:0,class:"flex gap-2 items-center mx-auto justify-center mb-2"},$t={key:1,class:"text-center py-4 text-gray-500"},wt={key:2,class:"text-center py-4 text-red-500"},Ct={key:3,class:"space-y-4"},St={__name:"TaskList",props:{tasks:{default:null,type:Array},loading:{default:!1,type:Boolean},error:{default:"",type:String},parentId:{type:Number,default:0},treeLevel:{type:Number,required:!0}},emits:["commentButtonClick","editClick","addClick","updatePriority"],setup(i,{emit:e}){const s=i,l=e,u=S(null),{handleItemsPriorityUpdate:n,saveTaskPriority:m,listHasRearranged:y}=ut(()=>s.tasks,s.parentId),o=async()=>{await m(),l("updatePriority")};return(p,k)=>(a(),d("div",null,[t("div",ht,[E(p.$slots,"task:header")]),c(y)?(a(),d("div",Tt,[k[3]||(k[3]=t("span",{class:"text-red-500"},"Priority Changed",-1)),t("button",{class:"btn-3",onClick:D(o,["prevent"])},"Save"),t("button",{class:"btn-3",onClick:k[0]||(k[0]=D((...f)=>u.value.resetItems&&u.value.resetItems(...f),["prevent"]))},"Discard")])):b("",!0),i.loading?(a(),d("div",$t,"Loading tasks...")):i.error?(a(),d("div",wt,g(i.error),1)):(a(),d("div",Ct,[_(pt,{items:i.tasks,handle:"handle",onItemsUpdate:c(n),class:"rounded-lg bg-white overflow-hidden space-y-3",ref_key:"draggableTaskList",ref:u},{item:v(({item:f,index:h})=>[_(mt,{index:h,task:f,showDraggableHandle:!0,"tree-level":i.treeLevel,class:"!border-0",onCommentButtonClick:I=>l("commentButtonClick",f.id),onEditClick:k[1]||(k[1]=I=>l("editClick",I)),onAddClick:k[2]||(k[2]=I=>l("addClick",I))},null,8,["index","task","tree-level","onCommentButtonClick"])]),_:1},8,["items","onItemsUpdate"])]))]))}},It={class:"flex justify-between mt-5"},Dt={class:"flex flex-wrap items-center gap-2 mt-3"},Pt={__name:"SubTaskList",props:{subTasks:Array,parentId:{type:Number,required:!0},treeLevel:{type:Number,required:!0}},emits:["created","error","updatePriority"],setup(i,{emit:e}){const s=i,l=e,u=S(),n=tt({show:!1,parentId:s.parentId,requirementId:null}),m=k=>{n.show=!0,n.parentId=k,console.log({addForm:n})};function y(){n.show=!1,n.parentId=s.parentId,l("created")}function o(){u.value=!1,l("updated")}function p(){n.show=!1,n.parentId=s.parentId}return(k,f)=>(a(),d("div",null,[u.value?(a(),w(M,{key:0},{default:v(()=>[_(kt,{taskId:u.value,onClose:f[0]||(f[0]=h=>u.value=null),onUpdated:o},null,8,["taskId"])]),_:1})):b("",!0),n.show?(a(),w(M,{key:1},{default:v(()=>[_(ct,{parentTaskId:n.parentId,requirementId:n.requirementId,onTaskCreated:y,onError:k.handleTaskError,onClose:p},null,8,["parentTaskId","requirementId","onError"])]),_:1})):b("",!0),_(St,{tasks:i.subTasks,parentId:i.parentId,treeLevel:i.treeLevel,onAddClick:f[2]||(f[2]=h=>m(h)),onEditClick:f[3]||(f[3]=h=>u.value=h),onUpdatePriority:f[4]||(f[4]=h=>l("updatePriority"))},{"task:header":v(()=>[t("div",It,[f[5]||(f[5]=t("div",{class:"flex justify-between items-center"},[t("h2",{class:"text-2xl font-bold text-gray-800"},"Sub Tasks")],-1)),t("div",Dt,[t("button",{class:"btn-1 ml-auto",onClick:f[1]||(f[1]=D(()=>m(i.parentId),["prevent"]))}," Add Sub Task ")])])]),_:1},8,["tasks","parentId","treeLevel"])]))}},Ut=i=>i==null?void 0:i.reduce((e,s)=>e+s.task_weight,0),et=(i,e)=>{const s=Ut(i);return i.map(l=>{const u=e.filter(n=>n.user_id===l.id).reduce((n,m)=>n+m.progress,0);return{...l,task_progress:Math.floor(u*(l.task_weight/s)),user_progress:u}})},Lt=(i,e)=>{let s=0;const l=[],u=y=>y.status==="COMPLETED",n=y=>y.users.some(o=>o.id===e),m=(y,o)=>{y.forEach(p=>{const k=n(p);l[o]=l[o]||{user_id:e,total_assigned:0,total_assigned_on_leaf_task:0,completed_count:0};const f=k&&p.children_tasks.length===0;l[o].total_assigned+=k?1:0,l[o].total_assigned_on_leaf_task+=f?1:0,s+=f?1:0,k&&u(p)&&(l[o].completed_count++,p.children_tasks.length),p.children_tasks.length>0&&m(p.children_tasks,o+1)})};return m(i,0),{sub_task_infos:l,assigned_on_any_leaf_task:s>0}},Et=(i,e)=>i.map(s=>({...s,...Lt(e,s.id)})),At={key:0,class:"min-w-full bg-white rounded overflow-hidden"},Mt={class:"py-0.5 text-bg font-semibold"},Nt={class:"bg-gray-50"},Bt={class:"px-2 py-1 border-y"},Rt={class:"px-2 py-1 border-y"},jt={key:0,class:"text-sm text-gray-400"},Ft={key:1},qt={key:1,class:"min-w-full bg-white rounded overflow-hidden"},Ot={class:"py-0.5 text-bg font-semibold"},Vt={class:"px-2 py-1 border-y"},zt={class:"px-2 py-1 border-y"},Ht={class:"px-2 py-1 border-y text-center"},Gt={class:"px-2 py-1 border-y text-center"},Wt=X({__name:"TaskProgressTable",props:{task:{},subTasks:{}},setup(i){const e=i,s=C(()=>et(e.task.users,e.task.task_reports||[])),l=C(()=>Et(e.task.users,e.subTasks));return(u,n)=>{var m,y;return e.task.children_task_count>0?(a(),d("table",At,[t("caption",Mt,[E(u.$slots,"caption",{},()=>[n[0]||(n[0]=$("Progress"))])]),t("thead",Nt,[t("tr",null,[n[1]||(n[1]=t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-left"},"#",-1)),n[2]||(n[2]=t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-left lg:w-[200px]"}," User ",-1)),(a(!0),d(P,null,L(((y=(m=l.value[0]||{})==null?void 0:m.sub_task_infos)==null?void 0:y.length)||1,o=>(a(),d("th",{key:o,class:"px-2 py-1 border-y font-semibold text-xs uppercase text-center"},g(o===1?"Completed Sub Task":"")+" "+g(o===2?"Completed Sub Sub Task":"")+" "+g(o===3?"Completed Sub Sub Sub Task":""),1))),128))])]),t("tbody",null,[(a(!0),d(P,null,L(l.value,(o,p)=>(a(),d("tr",{key:o.id,class:"border-t hover:bg-gray-50 cursor-pointer"},[t("td",Bt,g(p+1),1),t("td",Rt,[_(N,{user:o},null,8,["user"])]),(a(!0),d(P,null,L(o.sub_task_infos,(k,f)=>(a(),d("td",{class:"px-2 py-1 border-y text-center",key:f},[k.total_assigned===0||!o.assigned_on_any_leaf_task?(a(),d("div",jt," Not Assigned To Any Task ")):(a(),d("div",Ft,g(k.completed_count)+" / "+g(k.total_assigned),1))]))),128))]))),128))])])):(a(),d("table",qt,[t("caption",Ot,[E(u.$slots,"caption",{},()=>[n[3]||(n[3]=$("Progress"))])]),n[4]||(n[4]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-left"},"#"),t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-left lg:w-[200px]"}," User "),t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-center"},"Started"),t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-center"},"Finished")])],-1)),t("tbody",null,[(a(!0),d(P,null,L(s.value,(o,p)=>(a(),d("tr",{key:o.id,class:"border-t hover:bg-gray-50 cursor-pointer"},[t("td",Vt,g(p+1),1),t("td",zt,[_(N,{user:o},null,8,["user"])]),t("td",Ht,g(c(A)(o.task_started_at)),1),t("td",Gt,g(c(A)(o.task_finished_at)),1)]))),128))])]))}}}),Jt=ot("task-user",()=>({updateUserStartDate:async(s,l,u)=>await W.patch(`/task-user/task/${s}/user/${l}/update-start-date/${u}`),updateUserFinishDate:async(s,l,u)=>await W.patch(`/task-user/task/${s}/user/${l}/update-finish-date/${u}`)})),Kt={class:"border-b text-center"},Qt={key:0},Xt={key:1},Yt={class:"mb-2 mt-6"},Zt={class:"flex justify-center"},te={class:"py-6"},ee={class:"mt-2"},se={key:0,class:"inline-block text-sm text-orange-700 text-center w-full"},ae={class:"flex justify-between items-center"},ne={__name:"TaskUserDateUpdate",props:{task:{type:Object},user:{user:Object},type:{type:String}},emits:["closeClick","updateDate"],setup(i,{emit:e}){const s=i,l=e,u=Jt(),n=S(""),m=S("");async function y(){var o,p;console.log({date:n.value});try{s.type=="start-date"?await u.updateUserStartDate(s.task.id,s.user.id,n.value||"0"):s.type=="finish-date"&&await u.updateUserFinishDate(s.task.id,s.user.id,n.value||"0"),l("updateDate")}catch(k){m.value=((p=(o=k.response)==null?void 0:o.data)==null?void 0:p.message)||`Failed to update ${s.type}`}}return(o,p)=>(a(),d("form",{class:"p-4",onSubmit:D(y,["prevent"])},[t("div",Kt,[i.type=="start-date"?(a(),d("h2",Qt,"Edit Start Date")):i.type=="finish-date"?(a(),d("h2",Xt,"Edit Finish Date")):b("",!0)]),t("div",Yt,[p[2]||(p[2]=t("div",{class:"text-xs uppercase text-gray-500 font-semibold"},"Task:",-1)),t("div",null,g(i.task.title),1)]),t("div",null,[p[3]||(p[3]=t("div",{class:"text-xs uppercase text-gray-500 font-semibold"},"User:",-1)),_(N,{user:i.user},null,8,["user"])]),t("div",Zt,[t("div",te,[p[4]||(p[4]=t("label",{class:"block text-xs font-semibold"},"Date",-1)),rt(t("input",{type:"date","onUpdate:modelValue":p[0]||(p[0]=k=>n.value=k),class:"border py-2 px-4 rounded-md",size:"8"},null,512),[[lt,n.value]])])]),t("div",ee,[m.value?(a(),d("div",se,g(m.value),1)):b("",!0)]),t("div",ae,[p[5]||(p[5]=t("div",null,[t("button",{class:"btn-2"},"Submit")],-1)),t("button",{class:"btn-3",onClick:p[1]||(p[1]=D(k=>l("closeClick"),["prevent"]))},"Close")])],32))}},oe={class:"container mx-auto p-6"},re={key:2,class:"max-w-8xl min-h-64 mx-auto bg-white shadow-lg rounded-lg p-6 relative"},le={class:"grid grid-cols-4"},ie={class:"mb-4 flex col-span-full"},de={class:"font-medium text-xl"},ue={class:"flex items-center gap-2 text-xs text-gray-500 mt-2 opacity-80 text-left"},pe={key:0,class:"text-xs px-2 py-0.5 rounded-full border bg-yellow-800 text-white"},ce={key:1,class:"text-xs px-2 py-0.5 rounded-full border bg-red-500 text-white"},ke={class:"text-right col-span-full md:col-span-1 ml-auto flex items-start justify-center gap-4 !text-lg"},me={class:"mt-4 col-span-full mb-6"},ye={class:"ml-auto text-right text-sm col-span-full"},fe={key:1,class:"text-gray-500"},ge={class:"font-semibold text-green-800"},_e={key:2,class:"ml-4 text-gray-500"},be={class:"text-red-500 font-semibold"},xe={class:"py-2 flex justify-center items-center gap-2 col-span-full"},ve={class:"ml-auto flex gap-4"},he={key:0},Te={key:1},$e={key:1,class:"text-center py-4 text-red-500"},je={__name:"TaskShow",setup(i){const e=gt(),s=it(),l=dt(),u=S(""),n=C(()=>e.tasks),m=S({});Y(async()=>{u.value="loading",await o(s.params.id),u.value=""});const y=tt({user:null,type:""});async function o(T){await e.fetchTask(T)}const p=C(()=>et(e.task.users,e.task.task_reports||[])),k=C(()=>A(e.task.started_at)),f=C(()=>A(e.task.deadline));async function h(){await o(s.params.id),y.user=null,y.type=""}const I=T=>{l.push({name:"TaskEdit",params:{id:T}})},st=C(()=>{var T,r;return e.task?((T=e.task)==null?void 0:T.parent_id)==0?{name:"TaskList"}:{name:"TaskShow",params:{id:(r=e.task)==null?void 0:r.parent_id}}:null});return Z(()=>s.params.id,async T=>{u.value="changing",await o(T),u.value=""}),(T,r)=>{var B,R,j,F,q,O,V,z,H;const U=J("RouterLink"),at=J("router-view");return a(),d("div",oe,[y.user?(a(),w(M,{key:0},{default:v(()=>[_(ne,{task:c(e).task,user:y.user,type:y.type,onCloseClick:r[0]||(r[0]=x=>y.user=null),onUpdateDate:h},null,8,["task","user","type"])]),_:1})):b("",!0),u.value==="loading"?(a(),w(Q,{key:1})):(a(),d("div",re,[c(e).task?(a(),d(P,{key:0},[t("section",le,[t("div",ie,[t("div",null,[t("h2",de,g(c(e).task.title),1),t("div",ue,[(B=c(e).task)!=null&&B.is_important?(a(),d("span",pe,"IMPORTANT")):b("",!0),(R=c(e).task)!=null&&R.is_urgent?(a(),d("span",ce,"URGENT")):b("",!0)])]),t("div",ke,[_(yt,{status:(j=c(e).task)==null?void 0:j.status,progressPercent:(F=c(e).task)==null?void 0:F.progress_percent,class:"h-6 !text-lg"},null,8,["status","progressPercent"]),c(e).task?(a(),w(ft,{key:0,task:c(e).task,ref_key:"progress",ref:m,class:"!text-lg"},null,8,["task"])):b("",!0)])]),t("section",me,[_(Wt,{"task-users":((q=c(e).task)==null?void 0:q.users)||[],task:c(e).task,"sub-tasks":c(e).tasks,"progress-users":p.value},{caption:v(()=>r[9]||(r[9]=[t("div",{class:"text-sm py-1 text-left uppercase font-semibold text-gray-600"}," Assigned Users ",-1)])),_:1},8,["task-users","task","sub-tasks","progress-users"])]),t("div",ye,[c(e).task.deadline?(a(),w(vt,{key:0,targetDateTime:c(e).task.deadline,class:"text-lg font-semibold italic text-green-600"},null,8,["targetDateTime"])):b("",!0),k.value?(a(),d("span",fe,[r[10]||(r[10]=$(" Started: ")),t("span",ge,g(k.value),1)])):b("",!0),f.value?(a(),d("span",_e,[r[11]||(r[11]=$(" Deadline: ")),t("span",be,g(f.value),1)])):b("",!0)]),r[16]||(r[16]=t("hr",{class:"my-3 col-span-full"},null,-1)),t("div",xe,[t("button",{onClick:r[1]||(r[1]=D(x=>{var G;return I((G=c(e).task)==null?void 0:G.id)},["stop"])),class:"btn-2 py-0.5"},"Edit"),_(U,{to:{name:"TaskUserAssign",params:{id:(O=c(e).task)==null?void 0:O.id}},class:"bg-indigo-500 hover:bg-indigo-600 text-white font-semibold px-3 py-0.5 rounded-full transition",onClick:r[2]||(r[2]=x=>x.stopPropagation())},{default:v(()=>r[12]||(r[12]=[t("i",{class:"fas fa-user-plus"},null,-1),$(" Assign Users ")])),_:1,__:[12]},8,["to"]),_(U,{to:st.value,class:"bg-indigo-500 hover:bg-indigo-600 text-white font-semibold px-3 py-0.5 rounded-full transition",onClick:r[3]||(r[3]=x=>x.stopPropagation())},{default:v(()=>r[13]||(r[13]=[t("i",{class:"fas fa-arrow-left"},null,-1),$(" Back ")])),_:1,__:[13]},8,["to"]),t("div",ve,[n.value.length>0?(a(),w(U,{key:0,to:{name:"TaskShow",params:{id:(V=c(e).task)==null?void 0:V.id}},onClick:r[4]||(r[4]=x=>x.stopPropagation()),class:K(["py-1 btn-3 ml-auto",{"bg-blue-500 text-white":c(s).name=="TaskShow"}])},{default:v(()=>r[14]||(r[14]=[t("i",{class:"fal fa-list-ul"},null,-1),$(" Sub Tasks ")])),_:1,__:[14]},8,["to","class"])):b("",!0),_(U,{to:{name:"TaskReports",params:{id:(z=c(e).task)==null?void 0:z.id}},onClick:r[5]||(r[5]=x=>x.stopPropagation()),class:K(["py-1 btn-3",{"bg-blue-500 text-white":c(s).name=="TaskReports"}])},{default:v(()=>r[15]||(r[15]=[t("i",{class:"fal fa-file-alt"},null,-1),$(" Reports ")])),_:1,__:[15]},8,["to","class"])])])]),c(s).name=="TaskShow"&&((H=c(e).task)==null?void 0:H.level)<=2?(a(),d("section",he,[_(Pt,{subTasks:n.value,"parent-id":c(s).params.id,"tree-level":c(e).task.level+1,onCreated:r[6]||(r[6]=x=>o(c(s).params.id)),onUpdated:r[7]||(r[7]=x=>o(c(s).params.id)),onUpdatePriority:r[8]||(r[8]=x=>o(c(s).params.id))},null,8,["subTasks","parent-id","tree-level"])])):(a(),d("section",Te,[_(at)]))],64)):(a(),d("div",$e,g(c(e).error),1)),u.value==="changing"?(a(),w(Q,{key:2,class:"absolute bg-opacity-80 inset-0 z-20"})):b("",!0)]))])}}};export{je as default};
