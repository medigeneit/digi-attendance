import{b as R,u as T,r as y,m as B,e as z,c as i,o as u,a as e,t as b,h as n,v as c,j as A,F as g,y as w,B as O}from"./index-D_5uLc0m.js";import{u as q}from"./kpiCycleAdmin-tZ1NPt1d.js";const H={class:"max-w-6xl mx-auto p-4 space-y-5"},Y={class:"flex items-center justify-between"},Z={class:"flex items-center gap-3"},J={class:"text-xl font-semibold"},Q={class:"grid md:grid-cols-3 gap-3"},W={class:"rounded-xl border card-bg p-3"},X={class:"space-y-2"},ee={class:"text-xs text-slate-600"},te={class:"rounded-xl border card-bg p-3 md:col-span-2"},se={class:"grid md:grid-cols-3 gap-2"},oe={class:"text-xs text-slate-600 mb-1 capitalize"},le={class:"flex items-center gap-1"},ae=["onUpdate:modelValue"],ne=["onUpdate:modelValue"],de={class:"rounded-xl border card-bg p-3"},re={class:"overflow-auto"},ie={class:"w-full text-sm min-w-[760px]"},ue={class:"px-2 py-1"},ce=["onClick"],pe=["onClick"],me={class:"px-2 py-1"},_e=["onUpdate:modelValue"],xe={class:"px-2 py-1"},be=["onUpdate:modelValue"],ve={class:"px-2 py-1"},ye=["onUpdate:modelValue","onChange"],fe={class:"px-2 py-1"},he=["onUpdate:modelValue"],ke=["onUpdate:modelValue"],ge={class:"px-2 py-1"},we=["onClick"],Ce={class:"rounded-xl border p-3"},Ue={class:"space-y-4 mt-3"},Ve={class:"flex items-center justify-between bg-slate-50 px-3 py-2"},$e={class:"font-medium"},De={class:"flex items-center gap-2"},Ie=["onClick"],Ae=["onClick"],Le=["onClick"],je={class:"p-3 overflow-auto"},Se={class:"w-full text-sm min-w-[720px]"},Me={class:"px-2 py-1"},Ke={class:"px-2 py-1"},Ne=["onUpdate:modelValue"],Pe={class:"px-2 py-1"},Ee=["onUpdate:modelValue"],Fe={class:"px-2 py-1"},Ge=["onUpdate:modelValue"],Re={class:"px-2 py-1"},Te=["onClick"],Be=["onClick"],ze=["onClick"],Oe={class:"mt-2"},qe=["onClick"],He={class:"text-xs text-slate-600 ml-3"},Ye={class:"flex items-center justify-between mt-3"},Ze={class:"text-sm text-slate-700"},Xe={__name:"CycleFormPage",setup(Je){const U=R();T();const f=q(),m=y(U.params.id?Number(U.params.id):null),h=y("KPI 2025"),k=y(new Date().getFullYear()),_=y([{id:"personal",label:"Personal Attributes (25)",items:[{id:"attitude",label:"ব্যক্তিত্ব ও আচরণ",max:2.5},{id:"punctual",label:"সময়নিষ্ঠতা",max:2.5},{id:"teamwork",label:"সহযোগিতা ও আচরণ",max:5},{id:"discipline",label:"শৃঙ্খলা",max:5},{id:"communication",label:"কমিউনিকেশন",max:5},{id:"ethics",label:"নৈতিকতা",max:5}]},{id:"training",label:"Training (15)",items:[{id:"tech_training",label:"প্রযুক্তিগত প্রশিক্ষণ",max:5},{id:"cert",label:"সার্টিফিকেশন/সেমিনার",max:5},{id:"onjob",label:"অন জব লার্নিং",max:5}]},{id:"performance",label:"কাজের কার্যসম্পাদন (25)",items:[{id:"quality",label:"কাজের মান",max:10},{id:"planning",label:"পরিকল্পনা/ম্যানেজমেন্ট",max:7},{id:"report",label:"রিপোর্টিং/ডকুমেন্টেশন",max:8}]},{id:"target",label:"Monthly Target (25)",items:[{id:"target",label:"টার্গেট এচিভমেন্ট",max:25}]}]),d=y([{key:"incharge",label:"Incharge",rank:10,source:{type:"department_field",field:"incharge_id"}},{key:"op_admin",label:"Op. Admin",rank:20,source:{type:"department_field",field:"operational_admin_user_id"}},{key:"hr",label:"HR",rank:25,source:{type:"manual",permission:"kpi.review.lane.hr"}},{key:"coordinator",label:"Coordinator / AD / DD",rank:30,source:{type:"department_field",field:"coordinator_id"}},{key:"cc",label:"CC",rank:40,source:{type:"department_field",field:"recommend_by_user_id"}},{key:"supv_director",label:"Supv. Director",rank:50,source:{type:"department_field",field:"approved_by_user_id"}},{key:"da",label:"DA",rank:60,source:{type:"manual",permission:"kpi.da"}}]),x=y({excellent:[91,100],good:[81,90],satisfactory:[71,80],average:[51,70],below:[0,50]}),V=B(()=>{let t=0;return _.value.forEach(s=>s.items.forEach(o=>t+=Number(o.max||0))),Number(t.toFixed(2))});function v(t,s,o){const l=s+o;l<0||l>=t.length||([t[s],t[l]]=[t[l],t[s]])}function L(){const t=prompt("Group ID (slug):");t&&_.value.push({id:t,label:t,items:[]})}function j(t){t.items.push({id:"item_"+(t.items.length+1),label:"New Item",max:1})}function S(t){_.value.splice(t,1)}function M(t,s){t.items.splice(s,1)}const C={incharge:"incharge_id",op_admin:"operational_admin_user_id",coordinator:"coordinator_id",cc:"recommend_by_user_id",supv_director:"approved_by_user_id",hr:"approved_by_user_id"};function $(t,s=0){var p,r,I;const o=t.key||`lane_${s+1}`,l=((p=t.source)==null?void 0:p.type)||"manual",a={key:o,label:t.label||o,rank:t.rank??(s+1)*10,source:{type:l}};return l==="department_field"?a.source.field=((r=t.source)==null?void 0:r.field)||C[o]||"":a.source.permission=((I=t.source)==null?void 0:I.permission)||`kpi.review.lane.${o}`,a}function K(){d.value.push({key:"",label:"New Lane",rank:(d.value.length+1)*10,source:{type:"manual",permission:""}})}function N(t){d.value.splice(t,1)}function P(t){t.source||(t.source={type:"manual"}),t.source.type==="department_field"?("field"in t.source||(t.source.field=C[t.key]||""),delete t.source.permission):("permission"in t.source||(t.source.permission=`kpi.review.lane.${t.key||"new"}`),delete t.source.field)}function E(t){const s=new Set;for(const o of t){if(!o.key||!/^[A-Za-z0-9_]+$/.test(o.key))throw new Error(`Invalid lane key "${o.key||"(empty)"}". Use letters/numbers/underscore only.`);if(s.has(o.key))throw new Error(`Duplicate lane key "${o.key}".`);s.add(o.key)}}z(async()=>{if(m.value){const t=await f.load(m.value);h.value=t.title,k.value=t.year,_.value=t.groups_json||[],d.value=(t.reviewer_lanes_json||[]).map((s,o)=>$(s,o)),x.value=t.grading_json||x.value}else d.value=d.value.map((t,s)=>$(t,s))});function F(t){return t.map((s,o)=>{const l={...s,rank:s.rank??(o+1)*10,source:{...s.source||{}}};if(l.source.type==="department_field"){if(l.source.field=l.source.field||C[l.key]||"",!l.source.field)throw new Error(`Missing department field for lane '${l.key}'. Please set source.field.`);delete l.source.permission}else l.source.permission=l.source.permission||`kpi.review.lane.${l.key}`,delete l.source.field;return l})}async function D(){try{E(d.value);const t={title:h.value,year:k.value,groups:_.value,lanes:F(d.value),grading:x.value};m.value?await f.update(m.value,t):m.value=(await f.create(t)).id,alert("Saved!")}catch(t){console.error(t),alert((t==null?void 0:t.message)||"Failed to save")}}async function G(){if(!m.value){alert("Save first");return}await f.activate(m.value),alert("Activated!")}return(t,s)=>(u(),i("div",H,[e("header",Y,[e("div",Z,[e("button",{class:"px-3 py-1.5 rounded-lg border",onClick:s[0]||(s[0]=o=>t.$router.push({name:"KpiCycles"}))},"← Back"),e("h1",J,b(m.value?"Edit KPI Cycle":"Create KPI Cycle"),1)]),e("div",{class:"flex gap-2"},[e("button",{onClick:D,class:"btn-2"},"Save Draft"),e("button",{onClick:G,class:"btn-1"},"Activate")])]),e("div",Q,[e("div",W,[s[4]||(s[4]=e("div",{class:"text-sm font-medium mb-2"},"Basic",-1)),e("div",X,[n(e("input",{"onUpdate:modelValue":s[1]||(s[1]=o=>h.value=o),class:"border rounded-lg px-3 py-2 w-full",placeholder:"Title e.g., KPI 2025"},null,512),[[c,h.value]]),n(e("input",{"onUpdate:modelValue":s[2]||(s[2]=o=>k.value=o),type:"number",class:"border rounded-lg px-3 py-2 w-full",placeholder:"Year"},null,512),[[c,k.value]]),e("div",ee,[s[3]||(s[3]=A("Total Max: ")),e("b",null,b(V.value),1)])])]),e("div",te,[s[6]||(s[6]=e("div",{class:"text-sm font-medium mb-2"},"Grading (0–100)",-1)),e("div",se,[(u(!0),i(g,null,w(x.value,(o,l)=>(u(),i("div",{key:l,class:"border rounded-lg p-2"},[e("div",oe,b(l),1),e("div",le,[n(e("input",{type:"number","onUpdate:modelValue":a=>x.value[l][0]=a,class:"border rounded px-2 py-1 w-20 text-right"},null,8,ae),[[c,x.value[l][0],void 0,{number:!0}]]),s[5]||(s[5]=e("span",null,"–",-1)),n(e("input",{type:"number","onUpdate:modelValue":a=>x.value[l][1]=a,class:"border rounded px-2 py-1 w-20 text-right"},null,8,ne),[[c,x.value[l][1],void 0,{number:!0}]])])]))),128))])])]),e("div",de,[e("div",{class:"flex items-center justify-between mb-2"},[s[7]||(s[7]=e("div",{class:"text-sm font-medium"},"Reviewer Lanes & Hierarchy",-1)),e("button",{class:"btn-2",onClick:K},"Add Lane")]),e("div",re,[e("table",ie,[s[9]||(s[9]=e("thead",{class:"bg-slate-50"},[e("tr",null,[e("th",{class:"text-left px-2 py-1"},"Order"),e("th",{class:"text-left px-2 py-1"},"Key"),e("th",{class:"text-left px-2 py-1"},"Label"),e("th",{class:"text-left px-2 py-1"},"Source"),e("th",{class:"text-left px-2 py-1"},"Field / Permission"),e("th",{class:"text-left px-2 py-1"})])],-1)),e("tbody",null,[(u(!0),i(g,null,w(d.value,(o,l)=>(u(),i("tr",{key:l,class:"border-t"},[e("td",ue,[e("button",{class:"border rounded px-2 text-xs mr-1",onClick:a=>v(d.value,l,-1)},"↑",8,ce),e("button",{class:"border rounded px-2 text-xs",onClick:a=>v(d.value,l,1)},"↓",8,pe)]),e("td",me,[n(e("input",{"onUpdate:modelValue":a=>o.key=a,class:"border rounded px-2 py-1 w-32"},null,8,_e),[[c,o.key]])]),e("td",xe,[n(e("input",{"onUpdate:modelValue":a=>o.label=a,class:"border rounded px-2 py-1 w-56"},null,8,be),[[c,o.label]])]),e("td",ve,[n(e("select",{"onUpdate:modelValue":a=>o.source.type=a,class:"border rounded px-2 py-1",onChange:a=>P(o)},s[8]||(s[8]=[e("option",{value:"department_field"},"department_field",-1),e("option",{value:"manual"},"manual",-1)]),40,ye),[[O,o.source.type]])]),e("td",fe,[o.source.type==="department_field"?n((u(),i("input",{key:0,"onUpdate:modelValue":a=>o.source.field=a,class:"border rounded px-2 py-1 w-64",placeholder:"e.g., incharge_id"},null,8,he)),[[c,o.source.field]]):n((u(),i("input",{key:1,"onUpdate:modelValue":a=>o.source.permission=a,class:"border rounded px-2 py-1 w-64",placeholder:"permission e.g., kpi.review.lane.hr"},null,8,ke)),[[c,o.source.permission]])]),e("td",ge,[e("button",{class:"border rounded px-2 text-xs",onClick:a=>N(l)},"Remove",8,we)])]))),128))])])]),s[10]||(s[10]=e("div",{class:"text-xs text-slate-500 mt-2"},"Order (top→bottom) ই হল hierarchy rank।",-1))]),e("div",Ce,[e("div",{class:"flex items-center justify-between"},[s[11]||(s[11]=e("div",{class:"text-sm font-medium"},"Groups & Items",-1)),e("button",{onClick:L,class:"btn-2"},"Add Group")]),e("div",Ue,[(u(!0),i(g,null,w(_.value,(o,l)=>(u(),i("div",{key:o.id,class:"rounded-lg border card-bg"},[e("div",Ve,[e("div",$e,b(l+1)+". "+b(o.label),1),e("div",De,[e("button",{class:"px-2 py-1 text-xs border rounded",onClick:a=>v(_.value,l,-1)},"↑",8,Ie),e("button",{class:"px-2 py-1 text-xs border rounded",onClick:a=>v(_.value,l,1)},"↓",8,Ae),e("button",{class:"px-2 py-1 text-xs border rounded",onClick:a=>S(l)},"Remove",8,Le)])]),e("div",je,[e("table",Se,[s[12]||(s[12]=e("thead",null,[e("tr",{class:"text-left bg-slate-50"},[e("th",{class:"px-2 py-1 w-14"},"SL"),e("th",{class:"px-2 py-1"},"Item ID"),e("th",{class:"px-2 py-1"},"Label"),e("th",{class:"px-2 py-1 w-24"},"Max"),e("th",{class:"px-2 py-1 w-40"})])],-1)),e("tbody",null,[(u(!0),i(g,null,w(o.items,(a,p)=>(u(),i("tr",{key:a.id,class:"border-t bg-white"},[e("td",Me,b(p+1),1),e("td",Ke,[n(e("input",{"onUpdate:modelValue":r=>a.id=r,class:"border rounded px-2 py-1 w-40"},null,8,Ne),[[c,a.id]])]),e("td",Pe,[n(e("input",{"onUpdate:modelValue":r=>a.label=r,class:"border rounded px-2 py-1 w-full"},null,8,Ee),[[c,a.label]])]),e("td",Fe,[n(e("input",{"onUpdate:modelValue":r=>a.max=r,type:"number",min:"0",step:"0.5",class:"border rounded px-2 py-1 w-24 text-right"},null,8,Ge),[[c,a.max,void 0,{number:!0}]])]),e("td",Re,[e("button",{class:"px-2 py-1 text-xs border rounded mr-1",onClick:r=>v(o.items,p,-1)},"↑",8,Te),e("button",{class:"px-2 py-1 text-xs border rounded mr-1",onClick:r=>v(o.items,p,1)},"↓",8,Be),e("button",{class:"px-2 py-1 text-xs border rounded",onClick:r=>M(o,p)},"Remove",8,ze)])]))),128))])]),e("div",Oe,[e("button",{onClick:a=>j(o),class:"btn-2"},"Add Item",8,qe),e("span",He,"Group total: "+b(o.items.reduce((a,p)=>a+Number(p.max||0),0)),1)])])]))),128))]),e("div",Ye,[e("div",Ze,[s[13]||(s[13]=A("Overall Total Max: ")),e("b",null,b(V.value),1)]),e("button",{onClick:D,class:"btn-2"},"Save Draft")])])]))}};export{Xe as default};
