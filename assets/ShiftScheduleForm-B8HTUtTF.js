import{L as de,r as y,M as V,s as H,x as D,A as U,c as f,o as h,a as s,g as le,t as w,n as ce,h as T,B as ve,F,y as A,v as fe,j as z,k as he,q as L,K as q,O as pe}from"./index-BRcUpGA5.js";import{_ as me}from"./EmployeeFilter-Bbk_MqS2.js";import{u as be}from"./company-Aq0ticOI.js";import{u as ge}from"./department-DfBzBXZR.js";import{u as ye}from"./shift-B-lgXUAs.js";import{d as Q}from"./dayjs.min-Cbbdfn5l.js";import{_ as Se}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./EmployeeDropdownInput-DjnXuNqt.js";import"./SelectDropdown-f8fKJ1lL.js";import"./UserChip-Bol1EcXn.js";const _e=de("shiftSchedule",()=>{const M=y([]),_=y(!1);return{schedules:M,defaultShift:_,fetchSchedules:async m=>{var O,p,b;const n=await V.get("/shift-schedules",m);return M.value=(O=n==null?void 0:n.data)==null?void 0:O.schedules,_.value=(p=n==null?void 0:n.data)==null?void 0:p.default_shift,(b=n.data)==null?void 0:b.schedules},saveSchedules:async m=>{await V.post("/shift-schedules",{schedules:m==null?void 0:m.payload})},fetchDefaultSchedules:async m=>{const n=await V.get("/default-shift-schedules",m);return M.value=n==null?void 0:n.data,n.data}}}),ke={class:"p-4 max-w-[1600px] mx-auto"},xe={class:"flex items-center justify-between gap-3 mb-4"},we={class:"text-sm text-gray-500"},Ne={class:"flex flex-wrap justify-start items-center gap-3 mb-4"},Ce=["value"],Ee={key:0,class:"text-amber-700 bg-amber-50 border border-amber-100 rounded p-2 mb-3"},De={class:"flex flex-wrap gap-3 mb-4 p-3 bg-white/70 backdrop-blur rounded sticky top-16 z-20 border"},Fe=["onClick"],Ae={class:"text-sm"},Me={class:"mb-4 flex flex-wrap gap-3"},$e=["disabled"],We=["disabled"],Oe=["disabled"],je={class:"btn-3"},Be=["checked"],Ke={class:"overflow-auto border rounded"},Ye={class:"table-auto w-full text-sm"},Le={class:"sticky top-0 bg-white z-10"},Ve=["title"],He={class:"font-medium leading-none"},Ue={class:"text-[10px] text-gray-500"},Te={class:"border p-2"},ze={class:"flex items-center gap-2"},qe=["value"],Qe={class:"min-w-0"},Re={class:"font-medium leading-tight"},Ge={class:"border p-2"},Je=["onClick","disabled"],Pe=["onClick","title"],Xe={key:0},Ze={class:"flex justify-center mt-5"},Ie=["disabled"],et={__name:"ShiftScheduleForm",setup(M){const _=_e(),R=be(),$=ye(),W=ge(),{defaultShift:m}=H(_),{employees:n}=H(R),{shifts:O}=H($),p=y(Q().format("YYYY-MM")),b=y(""),S=y(""),N=y(""),d=y(""),u=y({}),g=y([]),C=y({WEEKEND:"#B91C1C",HOLIDAY:"#6B7280"}),G=["#FF5733","#33C1FF","#33FF57","#FF33D4","#FFD633","#7D33FF","#FF8C33","#33FFF0","#B833FF","#3375FF","#FF3333","#33FFAA"],J=t=>e=>(e||[]).find(a=>Number(a==null?void 0:a.id)===Number(t)),j=D(()=>{const t=O.value||{};return Array.isArray(t)?t:Object.values(t).flat()});function P(){let t=0;j.value.forEach(e=>{const a=String(e.id);C.value[a]||(C.value[a]=G[t%G.length],t++)})}const B=D(()=>Array.from({length:Q(p.value).daysInMonth()},(t,e)=>e+1)),X=t=>{const e=`${p.value}-${String(t).padStart(2,"0")}`;return Q(e).format("ddd")},c=D(()=>(g.value||[]).map(t=>Number(t)).filter(Number.isFinite)),Z=D(()=>new Set(c.value)),k=t=>Z.value.has(Number(t)),i=t=>String(t),se=(t,e)=>{var o,r;const a=(r=(o=u.value)==null?void 0:o[i(t)])==null?void 0:r[e];return a?{backgroundColor:C.value[String(a)]||"#D1D5DB"}:{backgroundColor:"#E5E7EB"}},ae=(t,e)=>{var o,r;const a=(r=(o=u.value)==null?void 0:o[i(t)])==null?void 0:r[e];if(a==="WEEKEND"||a==="HOLIDAY")return a;const l=J(a)(j.value);return(l==null?void 0:l.name)||""};function oe(t,e){k(t)&&d.value&&(u.value[i(t)]||(u.value[i(t)]={}),u.value[i(t)][e]=d.value)}function I(t){k(t)&&d.value&&(u.value[i(t)]||(u.value[i(t)]={}),B.value.forEach(e=>{u.value[i(t)][e]=d.value}))}function ne(){!c.value.length||!d.value||c.value.forEach(I)}function re(){c.value.length&&c.value.forEach(t=>{var l;const e=J(t)(n.value),a=(((l=e==null?void 0:e.assign_weekend)==null?void 0:l.weekends)||[]).map(o=>String(o).slice(0,3));u.value[i(t)]||(u.value[i(t)]={}),B.value.forEach(o=>{const r=X(o);a.includes(r)&&(u.value[i(t)][o]="WEEKEND")})})}function ue(){c.value.length&&c.value.forEach(t=>{u.value[i(t)]&&(u.value[i(t)]={})})}async function ee(){if(!c.value.length){alert("Select at least one employee.");return}const t=[];for(const[e,a]of Object.entries(u.value||{})){const l=Number(e);if(Z.value.has(l))for(const[o,r]of Object.entries(a||{})){const v=Number(o);if(!v||!r)continue;const x=`${p.value}-${String(v).padStart(2,"0")}`;let Y=null,E=null;r==="WEEKEND"||r==="HOLIDAY"?E=r:Y=Number(r),t.push({employee_id:l,date:x,shift_id:Y,status:E})}}if(!t.length){alert("No schedule data to save for checked employees.");return}try{await _.saveSchedules({payload:t}),alert("Shift schedule saved successfully!")}catch(e){console.error("Failed to save schedule",e),alert("Something went wrong while saving.")}}async function te(t,e,a){try{if(!t||!e||!a){alert("Company, Department, and Month are required to load schedule.");return}u.value={},m.value=!1;let o=await _.fetchSchedules({params:{company_id:Number(t),department_id:Number(e),month:a}})||[];if(!o.length){const v=await _.fetchDefaultSchedules({params:{company_id:Number(t),department_id:Number(e),month:a}});console.warn("[Fallback Schedule Loaded]",v),alert("No saved schedule found. Default schedule loaded."),o=v||[],m.value=!0}const r={};o.forEach(v=>{const x=Number(v==null?void 0:v.employee_id),Y=String((v==null?void 0:v.date)||"").split("-")[2],E=Number(Y);!x||!E||(r[i(x)]||(r[i(x)]={}),r[i(x)][E]=v.shift_id??v.status)}),u.value=r}catch(l){console.error("Failed to load schedule data:",l),alert("Error loading schedule. Please try again or contact admin.")}}U(b,async t=>{t&&(S.value="",g.value=[],n.value=[],u.value={},await W.fetchDepartments({company_id:Number(t)}),await $.fetchShifts({company_id:Number(t)}),P())}),U(S,async t=>{if(!t)return;const e=await W.fetchDepartmentEmployee({departmentIds:[Number(t)]});n.value=e||[],g.value=g.value.filter(a=>(n.value||[]).some(l=>Number(l.id)===Number(a))),await te(b.value,t,p.value)}),U(p,async t=>{if(!t||!b.value||!S.value)return;await $.fetchShifts({company_id:Number(b.value)}),P();const e=await W.fetchDepartmentEmployee({departmentIds:[Number(S.value)]});n.value=e||[],g.value=g.value.filter(a=>(n.value||[]).some(l=>Number(l.id)===Number(a))),await te(b.value,S.value,t)});const K=D(()=>{if(!N.value)return n.value||[];const t=Number(N.value);return(n.value||[]).filter(e=>Number(e==null?void 0:e.id)===t)});function ie(t){t?g.value=K.value.map(e=>Number(e.id)):g.value=[]}return(t,e)=>{var a;return h(),f("div",ke,[s("div",xe,[e[9]||(e[9]=s("h2",{class:"text-center text-2xl font-semibold"},"Monthly Shift Schedule Plan",-1)),s("div",we,"Month: "+w(p.value),1)]),s("div",Ne,[ce(me,{company_id:b.value,"onUpdate:company_id":e[0]||(e[0]=l=>b.value=l),department_id:S.value,"onUpdate:department_id":e[1]||(e[1]=l=>S.value=l),employee_id:N.value,"onUpdate:employee_id":e[2]||(e[2]=l=>N.value=l),"with-type":!1,"initial-value":{company_id:b.value,department_id:S.value,employee_id:N.value}},null,8,["company_id","department_id","employee_id","initial-value"]),T(s("select",{"onUpdate:modelValue":e[3]||(e[3]=l=>d.value=l),class:"px-2 py-2 border rounded"},[e[10]||(e[10]=s("option",{value:""},"- Pick a Shift -",-1)),(h(!0),f(F,null,A(j.value,l=>(h(),f("option",{key:l.id,value:l.id},w(l.name),9,Ce))),128))],512),[[ve,d.value]]),T(s("input",{type:"month","onUpdate:modelValue":e[4]||(e[4]=l=>p.value=l),class:"h-10 px-2 border rounded"},null,512),[[fe,p.value]])]),e[18]||(e[18]=s("p",{class:"text-sky-800 bg-sky-50 border border-sky-200 rounded p-2 mb-3"},[z(" ✔ Only "),s("b",null,"checked"),z(" employees are editable & will be saved. ")],-1)),he(m)?(h(),f("p",Ee," ⚠ Showing default schedule from current shift. Select employees manually before saving. ")):le("",!0),s("div",De,[(h(!0),f(F,null,A(j.value,l=>(h(),f("div",{key:l.id,class:L(["flex items-center gap-2 cursor-pointer px-2 py-1 rounded border hover:bg-gray-50",{"ring-2 ring-blue-500":String(d.value)===String(l.id)}]),onClick:o=>d.value=l.id},[s("div",{class:"w-4 h-4 rounded",style:q({backgroundColor:C.value[String(l.id)]||"#ccc"})},null,4),s("span",Ae,w(l.name),1)],10,Fe))),128)),s("div",{class:L(["flex items-center gap-2 cursor-pointer px-2 py-1 rounded border hover:bg-gray-50",{"ring-2 ring-blue-500":d.value==="HOLIDAY"}]),onClick:e[5]||(e[5]=l=>d.value="HOLIDAY")},e[11]||(e[11]=[s("div",{class:"w-5 h-5 rounded bg-gray-500"},null,-1),s("span",{class:"text-sm"},"Holiday",-1)]),2),s("div",{class:L(["flex items-center gap-2 cursor-pointer px-2 py-1 rounded border hover:bg-gray-50",{"ring-2 ring-blue-500":d.value==="WEEKEND"}]),onClick:e[6]||(e[6]=l=>d.value="WEEKEND")},[s("div",{class:"w-5 h-5 rounded",style:q({backgroundColor:C.value.WEEKEND})},null,4),e[12]||(e[12]=s("span",{class:"text-sm"},"Weekend",-1))],2)]),s("div",Me,[s("button",{onClick:ne,class:"btn-4 bg-indigo-600 hover:bg-indigo-700 text-white",disabled:!c.value.length||!d.value,title:"Set selected shift to all days for checked employees"}," Set Shift → Checked (All Dates) ",8,$e),s("button",{onClick:re,class:"btn-4 bg-red-700 hover:bg-red-800 text-white",disabled:!c.value.length,title:"Mark employee-specific weekends for checked employees"}," Set Weekends → Checked ",8,We),s("button",{onClick:ue,class:"btn-4 bg-gray-700 hover:bg-gray-800 text-white",disabled:!c.value.length}," Clear (Checked) ",8,Oe),s("div",{class:"justify-end flex-grow"},[s("button",{onClick:ee,class:"btn-2"}," Save (Checked only) ")]),s("label",je,[s("input",{type:"checkbox",checked:c.value.length&&c.value.length===K.value.length,onChange:e[7]||(e[7]=l=>ie(l.target.checked))},null,40,Be),e[13]||(e[13]=s("span",null,"Select all (visible)",-1))])]),s("div",Ke,[s("table",Ye,[s("thead",Le,[s("tr",null,[e[14]||(e[14]=s("th",{class:"border p-2 text-left w-40"},"Employee",-1)),e[15]||(e[15]=s("th",{class:"border p-2 w-40"},"Quick Action",-1)),(h(!0),f(F,null,A(B.value,l=>(h(),f("th",{key:l,class:"border text-center p-1 min-w-[46px]",title:`${p.value}-${String(l).padStart(2,"0")}`},[s("div",He,w(l),1),s("div",Ue,w(X(l)),1)],8,Ve))),128))])]),s("tbody",null,[(h(!0),f(F,null,A(K.value,l=>(h(),f("tr",{key:l.id,class:"odd:bg-white even:bg-gray-50"},[s("td",Te,[s("label",ze,[T(s("input",{type:"checkbox",class:"rounded",value:l.id,"onUpdate:modelValue":e[8]||(e[8]=o=>g.value=o)},null,8,qe),[[pe,g.value]]),s("div",Qe,[s("div",Re,w(l.name),1)])])]),s("td",Ge,[s("button",{class:"btn-4 cursor-pointer",onClick:o=>I(l.id),disabled:!d.value||!k(l.id)}," Selected shift to all dates ",8,Je)]),(h(!0),f(F,null,A(B.value,o=>(h(),f("td",{key:o,class:L(["border text-center",k(l.id)?"cursor-pointer hover:bg-gray-100":"cursor-not-allowed opacity-60"]),onClick:r=>k(l.id)&&oe(l.id,o),title:k(l.id)?ae(l.id,o)||"Click to set":"Check this employee to edit"},[s("div",{style:q(se(l.id,o)),class:"w-full h-6 rounded transition"},null,4)],10,Pe))),128))]))),128)),(a=K.value)!=null&&a.length?le("",!0):(h(),f("tr",Xe,e[16]||(e[16]=[s("td",{colspan:"999",class:"text-center text-gray-500 p-6"}," No employees found for current filter. ",-1)])))])])]),s("div",Ze,[s("button",{onClick:ee,class:"btn-2",disabled:!c.value.length,title:"Saves only checked employees"},e[17]||(e[17]=[s("i",null,null,-1),z(" Save (Checked only) ")]),8,Ie)])])}}},ct=Se(et,[["__scopeId","data-v-4aeb17f6"]]);export{ct as default};
