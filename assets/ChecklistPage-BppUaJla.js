import{N as H,r as B,x as U,O as S,c as y,o as h,a,g as R,F as T,t as M,j as K,M as G,y as O,q as X,h as W,B as J,v as Q,k as j,n as Z,b as ee,e as te,A as ae,f as se}from"./index-DWf0FhHw.js";const z=H("checklist",()=>{const w=B(!1),p=B(null),l=B(null),g=e=>typeof e=="boolean"?e:typeof e=="number"?e===1:typeof e=="string"?e==="1"||e.toLowerCase()==="true":!!e,v=e=>{var r,t;return(e==null?void 0:e.label)??((r=e==null?void 0:e.template_item)==null?void 0:r.label)??((t=e==null?void 0:e.templateItem)==null?void 0:t.label)??""},f=e=>{var r,t;return g((e==null?void 0:e.required)??((r=e==null?void 0:e.template_item)==null?void 0:r.required)??((t=e==null?void 0:e.templateItem)==null?void 0:t.required))},i=e=>{var r,t;return Number((e==null?void 0:e.order_no)??((r=e==null?void 0:e.template_item)==null?void 0:r.order_no)??((t=e==null?void 0:e.templateItem)==null?void 0:t.order_no)??0)};function b(e){return{...e,_label:v(e),_required:f(e),_order:i(e)}}function k(e){if(!e)return null;const r=Array.isArray(e.items)?e.items.map(b):[];return r.sort((t,s)=>t._order-s._order),{...e,items:r}}const x=U(()=>{var e;return((e=l.value)==null?void 0:e.items)??[]}),I=U(()=>x.value.filter(e=>e._required)),F=U(()=>{const e=I.value.length;if(!e)return 100;const r=I.value.filter(t=>t.status==="done").length;return Math.round(r/e*100)}),C=e=>(e==null?void 0:e._label)??v(e),o=e=>(e==null?void 0:e._required)??f(e);async function d(e,r){w.value=!0,p.value=null;try{const{data:t}=await S.post(`/users/${Number(e)}/checklists`,{template_id:Number(r)});l.value=k(t.data)}catch(t){p.value=t,console.error("ensureChecklist failed:",t)}finally{w.value=!1}}async function n(e,r){w.value=!0,p.value=null;try{const{data:t}=await S.get(`/users/${Number(e)}/checklists/${Number(r)}`);l.value=k(t.data)}catch(t){p.value=t,console.error("fetchChecklist failed:",t)}finally{w.value=!1}}async function $(e,r){var _;const t=((_=l.value)==null?void 0:_.items)||[],s=t.findIndex(N=>N.id===e.id),c=s>=0?t[s]:e,u={...c};Object.assign(c,r);try{const{data:N}=await S.patch(`/checklist-items/${c.id}`,r),D=b({...c,...(N==null?void 0:N.data)||{}});t[s]=D}catch(N){throw s>=0&&(t[s]=b(u)),N}}async function V(e,{deleteDocument:r=!0,force:t=!1}={}){var D,L,P;console.log("detachAttachment",e,{deleteDocument:r,force:t});const s=((D=l.value)==null?void 0:D.items)||[],c=typeof e=="object"?e==null?void 0:e.id:e;if(!c)return{ok:!0,data:null};const u=s.findIndex(A=>A.id===Number(c)),_=u>=0?s[u]:{id:Number(c)};if(!(_!=null&&_.attachment_id)&&!(_!=null&&_.attachment))return{ok:!0,data:_};const N=u>=0?{...s[u]}:null;u>=0&&(s[u]={...s[u],attachment_id:null,attachment:null});try{const{data:A}=await S.patch(`/checklist-items/${c}/detach-attachment`,{delete_document:!!r,force:!!t}),E={...(A==null?void 0:A.data)||{}};return u>=0&&(s[u]={...s[u],...E}),(L=window==null?void 0:window.notify)!=null&&L.success&&window.notify.success("Attachment removed"),{ok:!0,data:E}}catch(A){throw u>=0&&N&&(s[u]=N),(P=window==null?void 0:window.notify)!=null&&P.error&&window.notify.error("Failed to remove attachment"),A}}async function q(e){const r=new FormData;r.append("file",e);const{data:t}=await S.post("/documents",r,{headers:{"Content-Type":"multipart/form-data"}});return t.data}async function m(){w.value=!1,p.value=null,l.value=null}return{loading:w,error:p,checklist:l,items:x,requiredItems:I,completion:F,labelOf:C,requiredOf:o,ensureChecklist:d,fetchChecklist:n,saveItem:$,uploadDocument:q,reset:m,detachAttachment:V}}),ne={class:"min-w-0"},oe={class:"flex items-center gap-2 min-w-0"},le=["href","title"],re={class:"inline-flex h-4 w-4 items-center justify-center"},ce=["src"],de={key:1,class:"h-4 w-4 text-gray-500",viewBox:"0 0 24 24",fill:"none","aria-hidden":"true"},ue={class:"truncate"},ie=["disabled"],me=["disabled"],fe=["disabled"],he=["disabled"],pe={key:2,class:"h-4 w-4 animate-spin text-gray-500",viewBox:"0 0 24 24",fill:"none","aria-label":"Uploading"},ve={key:0,class:"mt-1 h-[3px] w-full overflow-hidden rounded bg-gray-200"},ye={key:1,class:"mt-1 truncate text-[11px] text-rose-600",role:"alert"},Y=10*1024*1024,we=".jpg,.jpeg,.png,.pdf,.doc,.docx",be={__name:"AttachmentUploader",props:{itemId:{type:[Number,String],required:!0},modelValue:{type:[Number,null],default:null},current:{type:Object,default:null},disabled:{type:Boolean,default:!1}},emits:["update:modelValue","update:current","uploaded","detached"],setup(w,{emit:p}){const l=w,g=p,v=z(),f=B(null),i=B(!1),b=B(""),k=B(0),x=B(!1),I=["image/jpeg","image/png","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],F=U(()=>{var t,s;return!!((t=l.current)!=null&&t.url||(s=l.current)!=null&&s.path)}),C=U(()=>{var t,s;return((t=l.current)==null?void 0:t.url)||((s=l.current)==null?void 0:s.path)||null}),o=U(()=>{var t,s;return((t=l.current)==null?void 0:t.name)||((s=l.current)==null?void 0:s.original_name)||n(C.value)||"Document"}),d=U(()=>{var t;return(((t=l.current)==null?void 0:t.mime)||"").startsWith("image/")});function n(t){if(!t)return"";try{return decodeURIComponent(t.split("/").pop().split("?")[0])}catch{return""}}function $(t){const s=["B","KB","MB","GB"];let c=0,u=t;for(;u>=1024&&c<s.length-1;)u/=1024,c++;return`${u.toFixed(c?1:0)} ${s[c]}`}function V(t){return t?t.size>Y?`Max ${$(Y)}`:I.includes(t.type)?"":"Unsupported type":"No file selected"}async function q(t){var c,u;const s=V(t);if(s){b.value=s;return}if(!l.disabled){i.value=!0,b.value="",k.value=0,x.value=!1;try{const _=await v.uploadDocument(t,{onProgress:N=>{x.value=!0,k.value=N}});g("update:modelValue",_.id),g("uploaded",_),(c=window==null?void 0:window.notify)!=null&&c.success&&window.notify.success("File uploaded")}catch(_){console.error(_),b.value="Upload failed",(u=window==null?void 0:window.notify)!=null&&u.error&&window.notify.error("Upload failed")}finally{i.value=!1,k.value=0,x.value=!1,f.value&&(f.value.value="")}}}function m(t){var c;const s=(c=t.target.files)==null?void 0:c[0];s&&q(s)}function e(){var t;i.value||l.disabled||(t=f.value)==null||t.click()}const r=async()=>{var t,s;if(!(i.value||l.disabled)){i.value=!0,b.value="";try{const c=await v.detachAttachment(l.itemId,{deleteDocument:!0});g("update:modelValue",null),g("update:current",null),g("detached",(c==null?void 0:c.data)||null),(t=window==null?void 0:window.notify)!=null&&t.success&&window.notify.success("Attachment removed")}catch(c){console.error(c),b.value="Failed to remove",(s=window==null?void 0:window.notify)!=null&&s.error&&window.notify.error("Failed to remove")}finally{i.value=!1}}};return(t,s)=>(h(),y("div",ne,[a("div",oe,[F.value?(h(),y(T,{key:0},[a("a",{href:C.value,target:"_blank",class:"group inline-flex max-w-[12rem] items-center gap-1 truncate rounded-full border px-2 py-0.5 text-xs hover:bg-gray-50",title:o.value},[a("span",re,[d.value?(h(),y("img",{key:0,src:C.value,alt:"",class:"h-4 w-4 rounded object-cover"},null,8,ce)):(h(),y("svg",de,s[0]||(s[0]=[a("path",{d:"M14 2H6a2 2 0 00-2 2v16c0 1.1.9 2 2 2h12a2 2 0 002-2V8l-6-6z",stroke:"currentColor","stroke-width":"1.5"},null,-1),a("path",{d:"M14 2v6h6",stroke:"currentColor","stroke-width":"1.5"},null,-1)])))]),a("span",ue,M(o.value),1)],8,le),a("button",{type:"button",class:"inline-flex h-7 w-7 items-center justify-center rounded border text-gray-700 hover:bg-gray-50 disabled:opacity-60",disabled:i.value||w.disabled,title:"Replace",onClick:e},s[1]||(s[1]=[a("svg",{class:"h-4 w-4",viewBox:"0 0 24 24",fill:"none","aria-hidden":"true"},[a("path",{d:"M4 12a8 8 0 118 8",stroke:"currentColor","stroke-width":"1.5"}),a("path",{d:"M12 8v8m0-8l-3 3m3-3l3 3",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round"})],-1)]),8,ie),a("button",{type:"button",class:"inline-flex h-7 w-7 items-center justify-center rounded border border-rose-200 text-rose-700 hover:bg-rose-50 disabled:opacity-60",disabled:i.value||w.disabled,title:"Remove",onClick:r},s[2]||(s[2]=[a("svg",{class:"h-4 w-4",viewBox:"0 0 24 24",fill:"none","aria-hidden":"true"},[a("path",{d:"M6 6l12 12M18 6L6 18",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round"})],-1)]),8,me)],64)):(h(),y("button",{key:1,type:"button",class:"inline-flex items-center gap-1 rounded-md bg-gray-900 px-2.5 py-1 text-xs text-white hover:bg-gray-800 disabled:opacity-60",disabled:i.value||w.disabled,onClick:e,title:"Upload file"},s[3]||(s[3]=[a("svg",{class:"h-3.5 w-3.5",viewBox:"0 0 24 24",fill:"none","aria-hidden":"true"},[a("path",{d:"M12 16V4m0 12l-3-3m3 3l3-3M6 20h12",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round"})],-1),K(" Upload ")]),8,fe)),a("input",{ref_key:"inputRef",ref:f,type:"file",class:"hidden",accept:we,onChange:m,disabled:i.value||w.disabled},null,40,he),i.value?(h(),y("svg",pe,s[4]||(s[4]=[a("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"3"},null,-1),a("path",{class:"opacity-75",d:"M4 12a8 8 0 018-8",stroke:"currentColor","stroke-width":"3"},null,-1)]))):R("",!0)]),i.value?(h(),y("div",ve,[a("div",{class:"h-[3px] bg-blue-500 transition-[width]",style:G({width:(x.value?k.value:60)+"%"})},null,4)])):R("",!0),b.value?(h(),y("p",ye,M(b.value),1)):R("",!0)]))}},_e={class:"w-full overflow-x-auto bg-white"},ge={class:"min-w-full text-sm"},ke={class:"p-3"},xe={class:"p-3 font-medium"},Ce={class:"p-3"},$e={class:"p-3"},Ne=["onUpdate:modelValue","onChange","disabled"],Ie=["value"],Me={class:"p-3"},Ue=["onUpdate:modelValue","onInput","disabled"],Fe={class:"p-3"},Be={class:"p-3"},Ve={class:"p-3"},Ae={__name:"ChecklistTable",props:{items:{type:Array,required:!0}},setup(w){const p=w,l=z(),g=[{value:"pending",label:"Pending"},{value:"done",label:"Done âœ“"},{value:"waived",label:"Waived"},{value:"rejected",label:"Rejected"}],v=B(Object.create(null));function f(o,d){v.value[o]=!!d,v.value={...v.value}}function i(o,d=600){let n;return(...$)=>{clearTimeout(n),n=setTimeout(()=>o(...$),d)}}function b(o){return l.labelOf(o)}function k(o){return l.requiredOf(o)}const x=i(async o=>{var d,n;try{f(o.id,!0),await l.saveItem(o,{comment:o.comment||null}),(d=window==null?void 0:window.notify)!=null&&d.success&&window.notify.success("Note saved")}catch{(n=window==null?void 0:window.notify)!=null&&n.error&&window.notify.error("Failed to save note")}finally{f(o.id,!1)}},600);async function I(o){var d,n;try{f(o.id,!0),await l.saveItem(o,{status:o.status}),(d=window==null?void 0:window.notify)!=null&&d.success&&window.notify.success("Status updated")}catch{(n=window==null?void 0:window.notify)!=null&&n.error&&window.notify.error("Failed to update status")}finally{f(o.id,!1)}}async function F(o,d){var n,$;try{f(o.id,!0),console.log("linking attachment",o,d),await l.saveItem(o,{attachment_id:d.id}),o.attachment={...d},(n=window==null?void 0:window.notify)!=null&&n.success&&window.notify.success("Attachment linked")}catch{($=window==null?void 0:window.notify)!=null&&$.error&&window.notify.error("Failed to link file")}finally{f(o.id,!1)}}function C(o){if(!o)return"-";try{return new Date(o).toLocaleString()}catch{return String(o)}}return(o,d)=>(h(),y("div",_e,[a("table",ge,[d[0]||(d[0]=a("thead",{class:"sticky top-0 bg-gray-100 backdrop-blur"},[a("tr",{class:"text-left border-b"},[a("th",{class:"p-3 w-10"},"#"),a("th",{class:"p-3"},"Item"),a("th",{class:"p-3 w-20"},"Req."),a("th",{class:"p-3 w-40"},"Status"),a("th",{class:"p-3"},"Comment"),a("th",{class:"p-3 w-64"},"Attachment"),a("th",{class:"p-3 w-44"},"Checked By"),a("th",{class:"p-3 w-48"},"Checked At")])],-1)),a("tbody",null,[(h(!0),y(T,null,O(p.items,(n,$)=>{var V,q;return h(),y("tr",{key:n.id,class:"border-b hover:bg-gray-50"},[a("td",ke,M($+1),1),a("td",xe,M(b(n)),1),a("td",Ce,[a("span",{class:X(["px-2 py-0.5 rounded text-xs",k(n)?"bg-rose-100 text-rose-700":"bg-gray-100 text-gray-600"])},M(k(n)?"Yes":"No"),3)]),a("td",$e,[W(a("select",{"onUpdate:modelValue":m=>n.status=m,onChange:m=>I(n),class:"border rounded px-2 py-1 w-full focus:outline-none focus:ring disabled:opacity-60",disabled:v.value[n.id]},[(h(),y(T,null,O(g,m=>a("option",{key:m.value,value:m.value},M(m.label),9,Ie)),64))],40,Ne),[[J,n.status]])]),a("td",Me,[W(a("textarea",{"onUpdate:modelValue":m=>n.comment=m,onInput:m=>j(x)(n),placeholder:"Notesâ€¦",class:"border rounded p-2 w-60 h-10 resize-y focus:outline-none focus:ring disabled:opacity-60",disabled:v.value[n.id]},null,40,Ue),[[Q,n.comment]])]),a("td",Fe,[Z(be,{"item-id":n.id,modelValue:n.attachment_id,"onUpdate:modelValue":m=>n.attachment_id=m,current:n.attachment,disabled:v.value[n.id],onUploaded:m=>F(n,m),"onUpdate:current":m=>n.attachment=m,onDetached:()=>{n.attachment=null}},null,8,["item-id","modelValue","onUpdate:modelValue","current","disabled","onUploaded","onUpdate:current","onDetached"])]),a("td",Be,M(((V=n.checked_by)==null?void 0:V.name)||((q=n.checker)==null?void 0:q.name)||"-"),1),a("td",Ve,M(C(n.checked_at)),1)])}),128))])])]))}},je={class:"p-6 space-y-6"},qe={class:"flex items-start justify-between gap-4"},Se={class:"text-2xl font-semibold"},De={class:"text-sm text-gray-500"},Re={class:"flex items-center gap-2"},Te={class:"w-48 bg-gray-200 rounded-full h-2 overflow-hidden","aria-label":"Completion progress"},ze={class:"text-sm font-medium"},Le={key:0,class:"text-gray-500"},Pe={key:1,class:"text-red-600"},Ee={key:3,class:"text-gray-500"},We={__name:"ChecklistPage",setup(w){const p=ee(),l=z(),g=U(()=>Number(p.params.userId)),v=U(()=>p.params.checklistId?Number(p.params.checklistId):null),f=U(()=>p.params.templateId?Number(p.params.templateId):null),i=B(!1);function b(I,F=0,C=100){const o=Number(I||0);return Math.min(Math.max(o,F),C)}const k=U(()=>b(l.completion));async function x(){if(g.value){i.value=!0;try{v.value?await l.fetchChecklist(g.value,v.value):f.value?await l.ensureChecklist(g.value,f.value):await l.reset()}catch{}finally{i.value=!1}}}return te(x),ae([g,v,f],x),(I,F)=>{var C,o,d,n;return h(),y("div",je,[a("div",qe,[a("div",null,[a("h1",Se,M(((o=(C=j(l).checklist)==null?void 0:C.template)==null?void 0:o.name)||"Checklist"),1),a("p",De," Type: "+M(((n=(d=j(l).checklist)==null?void 0:d.template)==null?void 0:n.type)||"-"),1)]),a("div",Re,[F[0]||(F[0]=a("span",{class:"text-sm text-gray-600"},"Completion",-1)),a("div",Te,[a("div",{class:"bg-green-500 h-2",style:G({width:k.value+"%"})},null,4)]),a("span",ze,M(k.value)+"%",1)])]),i.value||j(l).loading?(h(),y("div",Le,"Loadingâ€¦")):j(l).error?(h(),y("div",Pe,"Failed to load.")):j(l).checklist?(h(),se(Ae,{key:2,items:j(l).items},null,8,["items"])):(h(),y("div",Ee,"No checklist found."))])}}};export{We as default};
