import{B as De,r as d,C as J,u as Ae,f as je,D as X,x as O,h as Oe,q as W,c as f,o as p,a,j as Z,t as M,d as Me,k as ee,H as $e,F as B,e as K,v as ze,b as me,m as We,s as P,O as te,P as Be}from"./index-DgYll9c7.js";import{_ as Ke}from"./EmployeeFilter-n_nLWsF7.js";import{u as Le}from"./company-BSPqPoGq.js";import{u as Ye}from"./department-ClkaFOa6.js";import{u as Qe}from"./shift-B5NnFs2n.js";import{d as le}from"./dayjs.min-FDasNvPQ.js";import{_ as Ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./EmployeeDropdownInput-DkNn3XOS.js";import"./SelectDropdown-DBMjwLhk.js";import"./UserChip-DJi64ebq.js";const He=De("shiftSchedule",()=>{const L=d([]),C=d(!1);return{schedules:L,defaultShift:C,fetchSchedules:async g=>{var D,N,V;const u=await J.get("/shift-schedules",g);return L.value=(D=u==null?void 0:u.data)==null?void 0:D.schedules,C.value=(N=u==null?void 0:u.data)==null?void 0:N.default_shift,(V=u.data)==null?void 0:V.schedules},saveSchedules:async g=>{await J.post("/shift-schedules",{schedules:g==null?void 0:g.payload})},fetchDefaultSchedules:async g=>{const u=await J.get("/default-shift-schedules",g);return L.value=u==null?void 0:u.data,u.data}}}),Re={class:"p-4 max-w-[1600px] mx-auto"},Te={class:"flex flex-wrap items-center justify-between gap-3 mb-4"},Ue={class:"flex items-center gap-3 text-xs md:text-sm text-gray-500"},Ie={class:"font-semibold"},Pe={class:"flex flex-wrap justify-start items-center gap-3 mb-2"},qe=["value"],Ge={class:"flex flex-wrap items-center justify-between gap-2 mb-3"},Je={key:0,class:"text-xs md:text-sm text-gray-500 flex items-center gap-2"},Xe={key:0,class:"text-xs md:text-sm text-amber-700 bg-amber-50 border border-amber-100 rounded px-2 py-1 mb-3"},Ze={class:"flex flex-wrap gap-2 md:gap-3 mb-4 p-2 md:p-3 bg-white/70 backdrop-blur rounded sticky top-16 z-20 border"},et=["onClick"],tt={class:"mb-3 flex flex-wrap gap-2 md:gap-3 items-center"},lt=["disabled"],at=["disabled"],st=["disabled"],nt={class:"btn-3 ml-auto flex items-center gap-2 text-xs md:text-sm"},ot=["checked"],rt=["disabled"],ut={class:"overflow-auto border rounded"},it={class:"table-auto w-full text-xs md:text-sm"},dt={class:"sticky top-0 bg-white z-10"},ct=["title"],vt={class:"font-medium leading-none"},mt={class:"text-[9px] md:text-[10px] text-gray-500"},ft={class:"border p-2 sticky-col-1 bg-inherit z-10"},pt={class:"flex items-center gap-2"},ht=["value"],yt={class:"min-w-0"},bt={class:"font-medium leading-tight truncate max-w-[150px]"},gt={class:"border p-1 md:p-2 sticky-col-2 bg-inherit z-10 text-center"},xt=["onClick","disabled"],St=["onClick","title"],_t={key:0},kt={class:"flex justify-center mt-4 md:mt-5"},wt=["disabled"],Et={__name:"ShiftScheduleForm",setup(L){const C=He(),ae=Le(),Y=Qe(),Q=Ye(),g=Ae(),u=je(),{defaultShift:D}=X(C),{employees:N}=X(ae),{shifts:V}=X(Y),h=d(le().format("YYYY-MM")),y=d(""),b=d(""),x=d(""),c=d(""),r=d({}),S=d([]),_=d(""),se=d(!1),H=d(!1),A=d([]),q=d(!1),$=d(null),z=d({WEEKEND:"#B91C1C",HOLIDAY:"#6B7280"}),ne=["#FF5733","#33C1FF","#33FF57","#FF33D4","#FFD633","#7D33FF","#FF8C33","#33FFF0","#B833FF","#3375FF","#FF3333","#33FFAA"],oe=t=>e=>(e||[]).find(s=>Number(s==null?void 0:s.id)===Number(t)),R=O(()=>{const t=V.value||{};return Array.isArray(t)?t:Object.values(t).flat()});function re(){let t=0;R.value.forEach(e=>{const s=String(e.id);z.value[s]||(z.value[s]=ne[t%ne.length],t++)})}const T=O(()=>Array.from({length:le(h.value).daysInMonth()},(t,e)=>e+1)),ue=t=>{const e=`${h.value}-${String(t).padStart(2,"0")}`;return le(e).format("ddd")},v=O(()=>(S.value||[]).map(t=>Number(t)).filter(Number.isFinite)),ie=O(()=>new Set(v.value)),j=t=>ie.value.has(Number(t)),i=t=>String(t),fe=(t,e)=>{var n,o;const s=(o=(n=r.value)==null?void 0:n[i(t)])==null?void 0:o[e];return s?{backgroundColor:z.value[String(s)]||"#D1D5DB"}:{backgroundColor:"#E5E7EB"}},pe=(t,e)=>{var n,o;const s=(o=(n=r.value)==null?void 0:n[i(t)])==null?void 0:o[e];if(s==="WEEKEND"||s==="HOLIDAY")return s;const l=oe(s)(R.value);return(l==null?void 0:l.name)||""};function he(t,e){j(t)&&c.value&&(r.value[i(t)]||(r.value[i(t)]={}),r.value[i(t)][e]=c.value)}function de(t){j(t)&&c.value&&(r.value[i(t)]||(r.value[i(t)]={}),T.value.forEach(e=>{r.value[i(t)][e]=c.value}))}function ye(){!v.value.length||!c.value||v.value.forEach(de)}function be(){v.value.length&&v.value.forEach(t=>{var l;const e=oe(t)(A.value),s=(((l=e==null?void 0:e.assign_weekend)==null?void 0:l.weekends)||[]).map(n=>String(n).slice(0,3));r.value[i(t)]||(r.value[i(t)]={}),T.value.forEach(n=>{const o=ue(n);s.includes(o)&&(r.value[i(t)][n]="WEEKEND")})})}function ge(){v.value.length&&v.value.forEach(t=>{r.value[i(t)]&&(r.value[i(t)]={})})}async function ce(){if(!v.value.length){alert("Select at least one employee.");return}const t=[];for(const[e,s]of Object.entries(r.value||{})){const l=Number(e);if(ie.value.has(l))for(const[n,o]of Object.entries(s||{})){const w=Number(n);if(!w||!o)continue;const k=`${h.value}-${String(w).padStart(2,"0")}`;let F=null,m=null;o==="WEEKEND"||o==="HOLIDAY"?m=o:F=Number(o),t.push({employee_id:l,date:k,shift_id:F,status:m})}}if(!t.length){alert("No schedule data to save for checked employees.");return}try{await C.saveSchedules({payload:t}),alert("Shift schedule saved successfully!")}catch(e){console.error("Failed to save schedule",e),alert("Something went wrong while saving.")}}function xe({companyId:t,departmentId:e,lineType:s,month:l}){return[t||"",e||"",s||"all",l||""].join("-")}async function Se({companyId:t,departmentId:e,lineType:s,month:l}){if(!t||!e||!l||s==="all"){r.value={};return}const n={companyId:Number(t)||null,departmentId:Number(e)||null,lineType:s&&s!=="all"?s:"all",month:l},o=xe(n);if($.value!==o){$.value=o,q.value=!0,D.value=!1,r.value={};try{const w={company_id:n.companyId,department_id:n.departmentId,month:n.month};n.lineType&&n.lineType!=="all"&&(w.line_type=n.lineType);let k=await C.fetchSchedules({params:w});if(k=Array.isArray(k)?k:k||[],!k.length){const m=await C.fetchDefaultSchedules({params:w}),E=Array.isArray(m)?m:m||[];E.length&&(console.warn("[Fallback Schedule Loaded]",E),D.value=!0,k=E,alert("No saved schedule found. Default schedule loaded."))}const F={};k.forEach(m=>{const E=Number(m==null?void 0:m.employee_id),Fe=String((m==null?void 0:m.date)||"").split("-")[2],ve=Number(Fe);!E||!ve||(F[i(E)]||(F[i(E)]={}),F[i(E)][ve]=m.shift_id??m.status)}),$.value===o&&(r.value=F)}catch(w){console.error("Failed to load schedule data:",w),alert("Error loading schedule. Please try again or contact admin.")}finally{$.value===o&&(q.value=!1)}}}async function G(t){if(!t)return A.value=[],N.value=[],S.value=[],[];const e=await Q.fetchDepartmentEmployee([Number(t)],_.value),s=Array.isArray(e)?e:Array.isArray(e==null?void 0:e.data)?e.data:[];return A.value=s,N.value=s,S.value=S.value.filter(l=>s.some(n=>Number(n==null?void 0:n.id)===Number(l))),s}function _e(t=h.value){return!!(y.value&&b.value&&t)}async function U(t){const e=t||h.value;_e(e)&&await Se({companyId:y.value,departmentId:b.value,lineType:_.value,month:e})}const ke=O(()=>({company_id:y.value,department_id:b.value,line_type:_.value,employee_id:x.value,month:h.value})),we=t=>Object.fromEntries(Object.entries(t||{}).filter(([,e])=>e!==""&&e!==null&&e!==void 0));function Ee(t={}){const e={...u.query,...t},s=we(e);Object.keys(s).length===Object.keys(u.query).length&&Object.entries(s).every(([n,o])=>String(u.query[n]??"")===String(o??""))||g.replace({query:s}).catch(()=>{})}function Ce(t=u.query){H.value=!0,y.value=t.company_id||"",b.value=t.department_id||"",x.value=t.employee_id||"",_.value=t.line_type||"all",h.value=t.month||h.value,H.value=!1,se.value=!0}Oe(async()=>{Ce(),y.value&&(await Promise.all([Q.fetchDepartments({company_id:Number(y.value)}),Y.fetchShifts({company_id:Number(y.value)})]),re()),y.value&&b.value&&(await G(b.value),await U())}),W(y,async t=>{t&&(b.value="",S.value=[],x.value="",A.value=[],N.value=[],r.value={},_.value="all",$.value=null,await Promise.all([Q.fetchDepartments({company_id:Number(t)}),Y.fetchShifts({company_id:Number(t)})]),re())}),W(b,async t=>{t&&(H.value||(x.value=""),await G(t),await U())}),W(_,async()=>{!y.value||!b.value||(await G(b.value),await U())}),W(h,async t=>{await U(t)}),W(ke,t=>{!se.value||H.value||Ee(t)},{deep:!0});const I=O(()=>{const t=A.value.length?A.value:N.value||[];if(!x.value)return t;const e=Number(x.value);return t.filter(s=>Number(s==null?void 0:s.id)===e)});function Ne(t){t?S.value=I.value.map(e=>Number(e.id)):S.value=[]}return(t,e)=>{var s;return p(),f("div",Re,[a("div",Te,[e[11]||(e[11]=a("h2",{class:"text-xl md:text-2xl font-semibold"}," Monthly Shift Schedule Plan ",-1)),a("div",Ue,[e[10]||(e[10]=a("span",null,"Month:",-1)),a("span",Ie,M(h.value),1)])]),a("div",Pe,[Me(Ke,{company_id:y.value,"onUpdate:company_id":e[0]||(e[0]=l=>y.value=l),department_id:b.value,"onUpdate:department_id":e[1]||(e[1]=l=>b.value=l),line_type:_.value,"onUpdate:line_type":e[2]||(e[2]=l=>_.value=l),employee_id:x.value,"onUpdate:employee_id":e[3]||(e[3]=l=>x.value=l),"initial-value":{company_id:y.value,department_id:b.value,line_type:_.value,employee_id:x.value}},null,8,["company_id","department_id","line_type","employee_id","initial-value"]),ee(a("select",{"onUpdate:modelValue":e[4]||(e[4]=l=>c.value=l),class:"px-2 py-2 border rounded text-sm"},[e[12]||(e[12]=a("option",{value:""},"- Pick a Shift -",-1)),(p(!0),f(B,null,K(R.value,l=>(p(),f("option",{key:l.id,value:l.id},M(l.name),9,qe))),128))],512),[[$e,c.value]]),ee(a("input",{type:"month","onUpdate:modelValue":e[5]||(e[5]=l=>h.value=l),class:"h-10 px-2 border rounded text-sm"},null,512),[[ze,h.value]])]),a("div",Ge,[e[14]||(e[14]=a("div",{class:"text-xs md:text-sm text-sky-800 bg-sky-50 border border-sky-200 rounded px-2 py-1"},[me(" ✔ Only "),a("b",null,"checked"),me(" employees are editable & will be saved. ")],-1)),q.value?(p(),f("div",Je,e[13]||(e[13]=[a("span",{class:"inline-block w-2 h-2 rounded-full border-2 border-gray-400 border-t-transparent animate-spin"},null,-1),a("span",null,"Loading schedule...",-1)]))):Z("",!0)]),We(D)?(p(),f("p",Xe," ⚠ Showing default schedule from current shift. Select employees manually before saving. ")):Z("",!0),a("div",Ze,[(p(!0),f(B,null,K(R.value,l=>(p(),f("div",{key:l.id,class:P(["flex items-center gap-2 cursor-pointer px-2 py-1 rounded border hover:bg-gray-50 text-xs md:text-sm",{"ring-2 ring-blue-500":String(c.value)===String(l.id)}]),onClick:n=>c.value=l.id},[a("div",{class:"w-4 h-4 rounded",style:te({backgroundColor:z.value[String(l.id)]||"#ccc"})},null,4),a("span",null,M(l.name),1)],10,et))),128)),a("div",{class:P(["flex items-center gap-2 cursor-pointer px-2 py-1 rounded border hover:bg-gray-50 text-xs md:text-sm",{"ring-2 ring-blue-500":c.value==="HOLIDAY"}]),onClick:e[6]||(e[6]=l=>c.value="HOLIDAY")},e[15]||(e[15]=[a("div",{class:"w-4 h-4 rounded bg-gray-500"},null,-1),a("span",null,"Holiday",-1)]),2),a("div",{class:P(["flex items-center gap-2 cursor-pointer px-2 py-1 rounded border hover:bg-gray-50 text-xs md:text-sm",{"ring-2 ring-blue-500":c.value==="WEEKEND"}]),onClick:e[7]||(e[7]=l=>c.value="WEEKEND")},[a("div",{class:"w-4 h-4 rounded",style:te({backgroundColor:z.value.WEEKEND})},null,4),e[16]||(e[16]=a("span",null,"Weekend",-1))],2)]),a("div",tt,[a("button",{onClick:ye,class:"btn-4 bg-indigo-600 hover:bg-indigo-700 text-white text-xs md:text-sm",disabled:!v.value.length||!c.value,title:"Set selected shift to all days for checked employees"}," Set Shift → Checked (All Dates) ",8,lt),a("button",{onClick:be,class:"btn-4 bg-red-700 hover:bg-red-800 text-white text-xs md:text-sm",disabled:!v.value.length,title:"Mark employee-specific weekends for checked employees"}," Set Weekends → Checked ",8,at),a("button",{onClick:ge,class:"btn-4 bg-gray-700 hover:bg-gray-800 text-white text-xs md:text-sm",disabled:!v.value.length}," Clear (Checked) ",8,st),a("label",nt,[a("input",{type:"checkbox",checked:v.value.length&&v.value.length===I.value.length,onChange:e[8]||(e[8]=l=>Ne(l.target.checked))},null,40,ot),e[17]||(e[17]=a("span",null,"Select all (visible)",-1))]),a("button",{onClick:ce,class:"btn-2 text-xs md:text-sm",disabled:!v.value.length,title:"Saves only checked employees"}," Save (Checked only) ",8,rt)]),a("div",ut,[a("table",it,[a("thead",dt,[a("tr",null,[e[18]||(e[18]=a("th",{class:"border p-2 w-40 sticky-col-1 text-left bg-white z-20"}," Employee ",-1)),e[19]||(e[19]=a("th",{class:"border p-2 w-32 md:w-40 sticky-col-2 text-center bg-white z-20"}," Quick Action ",-1)),(p(!0),f(B,null,K(T.value,l=>(p(),f("th",{key:l,class:"border text-center p-1 min-w-[40px] md:min-w-[46px]",title:`${h.value}-${String(l).padStart(2,"0")}`},[a("div",vt,M(l),1),a("div",mt,M(ue(l)),1)],8,ct))),128))])]),a("tbody",null,[(p(!0),f(B,null,K(I.value,l=>(p(),f("tr",{key:l.id,class:"odd:bg-white even:bg-gray-50"},[a("td",ft,[a("label",pt,[ee(a("input",{type:"checkbox",class:"rounded",value:l.id,"onUpdate:modelValue":e[9]||(e[9]=n=>S.value=n)},null,8,ht),[[Be,S.value]]),a("div",yt,[a("div",bt,M(l.name),1)])])]),a("td",gt,[a("button",{class:"btn-4 cursor-pointer text-[11px] md:text-xs px-2 py-1",onClick:n=>de(l.id),disabled:!c.value||!j(l.id)}," Apply to all ",8,xt)]),(p(!0),f(B,null,K(T.value,n=>(p(),f("td",{key:n,class:P(["border text-center",j(l.id)?"cursor-pointer hover:bg-gray-100":"cursor-not-allowed opacity-60"]),onClick:o=>j(l.id)&&he(l.id,n),title:j(l.id)?pe(l.id,n)||"Click to set":"Check this employee to edit"},[a("div",{style:te(fe(l.id,n)),class:"w-full h-5 md:h-6 rounded transition"},null,4)],10,St))),128))]))),128)),(s=I.value)!=null&&s.length?Z("",!0):(p(),f("tr",_t,e[20]||(e[20]=[a("td",{colspan:"999",class:"text-center text-gray-500 p-6"}," No employees found for current filter. ",-1)])))])])]),a("div",kt,[a("button",{onClick:ce,class:"btn-2 text-xs md:text-sm",disabled:!v.value.length,title:"Saves only checked employees"}," Save (Checked only) ",8,wt)])])}}},Wt=Ve(Et,[["__scopeId","data-v-7fb1b89b"]]);export{Wt as default};
