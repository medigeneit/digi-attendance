import{G as tt,r as I,e as et,H as dt,A as st,c as d,o as a,f as b,a as t,t as g,I as A,n as $,h as c,w as C,l as _,p as T,E as at,m as w,q as D,F as P,x as L,J as ut,K as Q,g as pt,v as ct,b as kt,u as mt,d as yt,k as X,y as Y}from"./index-m2Gk5Trf.js";import{L as Z}from"./LoaderView-Dok9iGdJ.js";import{u as ft,_ as gt,O as M}from"./task-priority-xzBMF8Uu.js";import{a as bt}from"./TaskAddForm-Ck7nPxt9.js";import{_ as _t}from"./TaskEditForm-Dc5FsO8d.js";import{_ as xt,a as vt,b as ht}from"./TaskTreeView-CRVNXexE.js";import{g as E}from"./datetime-BISRKKpq.js";import{_ as N}from"./UserChip-Bx3eg9wh.js";import{u as Tt}from"./useTaskStore-Dx63qDxQ.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./RequiredIcon-BRVsSPKJ.js";import"./company-BuK04mGv.js";import"./useRequirementStore-tTGzoaYP.js";import"./SectionLoading-BRSzrIHi.js";const $t={key:0},wt={key:0},Ct={key:1},St=tt({__name:"CountdownTimer",props:{targetDateTime:{}},setup(u){const e=u,s=I(p());let i;function p(){const m=new Date(e.targetDateTime).getTime()-new Date().getTime(),f=Math.floor(m/1e3%60),n=Math.floor(m/1e3/60%60),l=Math.floor(m/(1e3*60*60)%24),k=Math.floor(m/(1e3*60*60*24));return{total:m,days:k,hours:l,minutes:n,seconds:f}}function r(){s.value=p()}return et(()=>{i=setInterval(()=>{r(),s.value.total<=0&&clearInterval(i)},1e3)}),dt(()=>clearInterval(i)),st(()=>e.targetDateTime,()=>{r(),clearInterval(i)}),(m,f)=>s.value.total>0?(a(),d("div",$t,[s.value.days?(a(),d("span",wt,g(s.value.days)+"d ",1)):b("",!0),t("span",null,g(s.value.hours.toString().padStart(2,"0"))+"h :",1),t("span",null,g(s.value.minutes.toString().padStart(2,"0"))+"m :",1),t("span",null,g(s.value.seconds.toString().padStart(2,"0"))+"s",1)])):(a(),d("div",Ct,[A(m.$slots,"expired",{},()=>[f[0]||(f[0]=$("Timeâ€™s up!"))])]))}}),Dt={class:"mb-3"},It={key:0,class:"flex gap-2 items-center mx-auto justify-center mb-2"},Pt={key:1,class:"text-center py-4 text-gray-500"},Ut={key:2,class:"text-center py-4 text-red-500"},Lt={key:3,class:"space-y-4"},At={__name:"TaskList",props:{tasks:{default:null,type:Array},loading:{default:!1,type:Boolean},error:{default:"",type:String},parentId:{type:Number,default:0},treeLevel:{type:Number,required:!0}},emits:["commentButtonClick","editClick","addClick","updatePriority"],setup(u,{emit:e}){const s=u,i=e,p=I(null),{handleItemsPriorityUpdate:r,saveTaskPriority:m,listHasRearranged:f}=ft(()=>s.tasks,s.parentId),n=async()=>{await m(),i("updatePriority")};return(l,k)=>(a(),d("div",null,[t("div",Dt,[A(l.$slots,"task:header")]),c(f)?(a(),d("div",It,[k[3]||(k[3]=t("span",{class:"text-red-500"},"Priority Changed",-1)),t("button",{class:"btn-3",onClick:C(n,["prevent"])},"Save"),t("button",{class:"btn-3",onClick:k[0]||(k[0]=C((...y)=>p.value.resetItems&&p.value.resetItems(...y),["prevent"]))},"Discard")])):b("",!0),u.loading?(a(),d("div",Pt,"Loading tasks...")):u.error?(a(),d("div",Ut,g(u.error),1)):(a(),d("div",Lt,[_(gt,{items:u.tasks,handle:"handle",onItemsUpdate:c(r),class:"rounded-lg bg-white overflow-hidden space-y-3",ref_key:"draggableTaskList",ref:p},{item:T(({item:y,index:h})=>[_(xt,{index:h,task:y,showDraggableHandle:!0,"tree-level":u.treeLevel,class:"!border-0",onCommentButtonClick:S=>i("commentButtonClick",y.id),onEditClick:k[1]||(k[1]=S=>i("editClick",S)),onAddClick:k[2]||(k[2]=S=>i("addClick",S))},null,8,["index","task","tree-level","onCommentButtonClick"])]),_:1},8,["items","onItemsUpdate"])]))]))}},Et={class:"flex justify-between mt-5"},Mt={class:"flex flex-wrap items-center gap-2 mt-3"},Nt={__name:"SubTaskList",props:{subTasks:Array,parentId:{type:Number,required:!0},treeLevel:{type:Number,required:!0}},emits:["created","error","updatePriority"],setup(u,{emit:e}){const s=u,i=e,p=I(),r=at({show:!1,parentId:s.parentId,requirementId:null}),m=k=>{r.show=!0,r.parentId=k,console.log({addForm:r})};function f(){r.show=!1,r.parentId=s.parentId,i("created")}function n(){p.value=!1,i("updated")}function l(){r.show=!1,r.parentId=s.parentId}return(k,y)=>(a(),d("div",null,[p.value?(a(),w(M,{key:0},{default:T(()=>[_(_t,{taskId:p.value,onClose:y[0]||(y[0]=h=>p.value=null),onUpdated:n},null,8,["taskId"])]),_:1})):b("",!0),r.show?(a(),w(M,{key:1},{default:T(()=>[_(bt,{parentTaskId:r.parentId,requirementId:r.requirementId,onTaskCreated:f,onError:k.handleTaskError,onClose:l},null,8,["parentTaskId","requirementId","onError"])]),_:1})):b("",!0),_(At,{tasks:u.subTasks,parentId:u.parentId,treeLevel:u.treeLevel,onAddClick:y[2]||(y[2]=h=>m(h)),onEditClick:y[3]||(y[3]=h=>p.value=h),onUpdatePriority:y[4]||(y[4]=h=>i("updatePriority"))},{"task:header":T(()=>[t("div",Et,[y[5]||(y[5]=t("div",{class:"flex justify-between items-center"},[t("h2",{class:"text-2xl font-bold text-gray-800"},"Sub Tasks")],-1)),t("div",Mt,[t("button",{class:"btn-1 ml-auto",onClick:y[1]||(y[1]=C(()=>m(u.parentId),["prevent"]))}," Add Sub Task ")])])]),_:1},8,["tasks","parentId","treeLevel"])]))}},Bt=u=>u==null?void 0:u.reduce((e,s)=>e+s.task_weight,0),nt=(u,e)=>{const s=Bt(u);return u.map(i=>{const p=e.filter(r=>r.user_id===i.id).reduce((r,m)=>r+m.progress,0);return{...i,task_progress:Math.floor(p*(i.task_weight/s)),user_progress:p}})},Ft=(u,e)=>{let s=0;const i=[],p=f=>f.status==="COMPLETED",r=f=>f.users.some(n=>n.id===e),m=(f,n)=>{f.forEach(l=>{const k=r(l);i[n]=i[n]||{user_id:e,total_assigned:0,total_assigned_on_leaf_task:0,completed_count:0};const y=k&&l.children_tasks.length===0;i[n].total_assigned+=k?1:0,i[n].total_assigned_on_leaf_task+=y?1:0,s+=y?1:0,k&&p(l)&&(i[n].completed_count++,l.children_tasks.length),l.children_tasks.length>0&&m(l.children_tasks,n+1)})};return m(u,0),{sub_task_infos:i,assigned_on_any_leaf_task:s>0}},Rt=(u,e)=>u.map(s=>({...s,...Ft(e,s.id)})),jt={key:0,class:"min-w-full bg-white rounded overflow-hidden"},qt={class:"py-0.5 text-bg font-semibold"},Ot={class:"bg-gray-50"},Vt={class:"px-2 py-1 border-y"},zt={class:"px-2 py-1 border-y"},Ht={key:0,class:"text-sm text-gray-400"},Gt={key:1},Wt={key:1,class:"min-w-full bg-white rounded overflow-hidden"},Jt={class:"py-0.5 text-bg font-semibold"},Kt={class:"px-2 py-1 border-y"},Qt={class:"px-2 py-1 border-y"},Xt={class:"px-2 py-1 border-y text-center"},Yt={class:"px-2 py-1 border-y text-center"},Zt=tt({__name:"TaskProgressTable",props:{task:{},subTasks:{}},setup(u){const e=u,s=D(()=>nt(e.task.users,e.task.task_reports||[])),i=D(()=>Rt(e.task.users,e.subTasks));return(p,r)=>{var m,f;return e.task.children_task_count>0?(a(),d("table",jt,[t("caption",qt,[A(p.$slots,"caption",{},()=>[r[0]||(r[0]=$("Progress"))])]),t("thead",Ot,[t("tr",null,[r[1]||(r[1]=t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-left"},"#",-1)),r[2]||(r[2]=t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-left lg:w-[200px]"}," User ",-1)),(a(!0),d(P,null,L(((f=(m=i.value[0]||{})==null?void 0:m.sub_task_infos)==null?void 0:f.length)||1,n=>(a(),d("th",{key:n,class:"px-2 py-1 border-y font-semibold text-xs uppercase text-center"},g(n===1?"Completed Sub Task":"")+" "+g(n===2?"Completed Sub Sub Task":"")+" "+g(n===3?"Completed Sub Sub Sub Task":""),1))),128))])]),t("tbody",null,[(a(!0),d(P,null,L(i.value,(n,l)=>(a(),d("tr",{key:n.id,class:"border-t hover:bg-gray-50 cursor-pointer"},[t("td",Vt,g(l+1),1),t("td",zt,[_(N,{user:n},null,8,["user"])]),(a(!0),d(P,null,L(n.sub_task_infos,(k,y)=>(a(),d("td",{class:"px-2 py-1 border-y text-center",key:y},[k.total_assigned===0||!n.assigned_on_any_leaf_task?(a(),d("div",Ht," Not Assigned To Any Task ")):(a(),d("div",Gt,g(k.completed_count)+" / "+g(k.total_assigned),1))]))),128))]))),128))])])):(a(),d("table",Wt,[t("caption",Jt,[A(p.$slots,"caption",{},()=>[r[3]||(r[3]=$("Progress"))])]),r[4]||(r[4]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-left"},"#"),t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-left lg:w-[200px]"}," User "),t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-center"},"Started"),t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-center"},"Finished")])],-1)),t("tbody",null,[(a(!0),d(P,null,L(s.value,(n,l)=>(a(),d("tr",{key:n.id,class:"border-t hover:bg-gray-50 cursor-pointer"},[t("td",Kt,g(l+1),1),t("td",Qt,[_(N,{user:n},null,8,["user"])]),t("td",Xt,g(c(E)(n.task_started_at)),1),t("td",Yt,g(c(E)(n.task_finished_at)),1)]))),128))])]))}}}),te=ut("task-user",()=>({updateUserStartDate:async(s,i,p)=>await Q.patch(`/task-user/task/${s}/user/${i}/update-start-date/${p}`),updateUserFinishDate:async(s,i,p)=>await Q.patch(`/task-user/task/${s}/user/${i}/update-finish-date/${p}`)})),ee={class:"border-b text-center"},se={key:0},ae={key:1},ne={class:"mb-2 mt-6"},oe={class:"flex justify-center"},re={class:"py-6"},le={class:"mt-2"},ie={key:0,class:"inline-block text-sm text-orange-700 text-center w-full"},de={class:"flex justify-between items-center"},ue={__name:"TaskUserDateUpdate",props:{task:{type:Object},user:{user:Object},type:{type:String}},emits:["closeClick","updateDate"],setup(u,{emit:e}){const s=u,i=e,p=te(),r=I(""),m=I("");async function f(){var n,l;console.log({date:r.value});try{s.type=="start-date"?await p.updateUserStartDate(s.task.id,s.user.id,r.value||"0"):s.type=="finish-date"&&await p.updateUserFinishDate(s.task.id,s.user.id,r.value||"0"),i("updateDate")}catch(k){m.value=((l=(n=k.response)==null?void 0:n.data)==null?void 0:l.message)||`Failed to update ${s.type}`}}return(n,l)=>(a(),d("form",{class:"p-4",onSubmit:C(f,["prevent"])},[t("div",ee,[u.type=="start-date"?(a(),d("h2",se,"Edit Start Date")):u.type=="finish-date"?(a(),d("h2",ae,"Edit Finish Date")):b("",!0)]),t("div",ne,[l[2]||(l[2]=t("div",{class:"text-xs uppercase text-gray-500 font-semibold"},"Task:",-1)),t("div",null,g(u.task.title),1)]),t("div",null,[l[3]||(l[3]=t("div",{class:"text-xs uppercase text-gray-500 font-semibold"},"User:",-1)),_(N,{user:u.user},null,8,["user"])]),t("div",oe,[t("div",re,[l[4]||(l[4]=t("label",{class:"block text-xs font-semibold"},"Date",-1)),pt(t("input",{type:"date","onUpdate:modelValue":l[0]||(l[0]=k=>r.value=k),class:"border py-2 px-4 rounded-md",size:"8"},null,512),[[ct,r.value]])])]),t("div",le,[m.value?(a(),d("div",ie,g(m.value),1)):b("",!0)]),t("div",de,[l[5]||(l[5]=t("div",null,[t("button",{class:"btn-2"},"Submit")],-1)),t("button",{class:"btn-3",onClick:l[1]||(l[1]=C(k=>i("closeClick"),["prevent"]))},"Close")])],32))}},pe={class:"container mx-auto p-6"},ce={key:2,class:"max-w-8xl min-h-64 mx-auto bg-white shadow-lg rounded-lg p-6 relative"},ke={class:"grid grid-cols-4"},me={class:"mb-4 flex col-span-full"},ye={class:"font-medium text-xl"},fe={class:"flex items-center gap-2 text-xs text-gray-500 mt-2 opacity-80 text-left"},ge={key:0,class:"text-xs px-2 py-0.5 rounded-full border bg-yellow-800 text-white"},be={key:1,class:"text-xs px-2 py-0.5 rounded-full border bg-red-500 text-white"},_e={class:"text-right col-span-full md:col-span-1 ml-auto flex items-start justify-center gap-4 !text-lg"},xe={class:"mt-4 col-span-full mb-6"},ve={class:"ml-auto text-right text-sm col-span-full"},he={key:1,class:"text-gray-500"},Te={class:"font-semibold text-green-800"},$e={key:2,class:"ml-4 text-gray-500"},we={class:"text-red-500 font-semibold"},Ce={class:"py-2 flex justify-center items-center gap-2 col-span-full"},Se={class:"ml-auto flex gap-4"},De=["disabled"],Ie=["disabled"],Pe={key:0},Ue={key:1},Le={key:1,class:"text-center py-4 text-red-500"},We={__name:"TaskShow",setup(u){const e=Tt(),s=kt(),i=mt(),p=I(""),r=yt(),m=D(()=>e.tasks),f=I({});et(async()=>{p.value="loading",await l(s.params.id),p.value=""});const n=at({user:null,type:""});async function l(x){await e.fetchTask(x)}const k=D(()=>nt(e.task.users,e.task.task_reports||[])),y=D(()=>E(e.task.started_at)),h=D(()=>E(e.task.deadline));function S(x){n.user=r.user,n.type=x}async function ot(){await l(s.params.id),n.user=null,n.type=""}const rt=x=>{i.push({name:"TaskEdit",params:{id:x}})},lt=D(()=>{var x,o;return e.task?((x=e.task)==null?void 0:x.parent_id)==0?{name:"TaskList"}:{name:"TaskShow",params:{id:(o=e.task)==null?void 0:o.parent_id}}:null});return st(()=>s.params.id,async x=>{p.value="changing",await l(x),p.value=""}),(x,o)=>{var B,F,R,j,q,O,V,z,H,G,W,J;const U=X("RouterLink"),it=X("router-view");return a(),d("div",pe,[n.user?(a(),w(M,{key:0},{default:T(()=>[_(ue,{task:c(e).task,user:n.user,type:n.type,onCloseClick:o[0]||(o[0]=v=>n.user=null),onUpdateDate:ot},null,8,["task","user","type"])]),_:1})):b("",!0),p.value==="loading"?(a(),w(Z,{key:1})):(a(),d("div",ce,[c(e).task?(a(),d(P,{key:0},[t("section",ke,[t("div",me,[t("div",null,[t("h2",ye,g(c(e).task.title),1),t("div",fe,[(B=c(e).task)!=null&&B.is_important?(a(),d("span",ge,"IMPORTANT")):b("",!0),(F=c(e).task)!=null&&F.is_urgent?(a(),d("span",be,"URGENT")):b("",!0)])]),t("div",_e,[_(vt,{status:(R=c(e).task)==null?void 0:R.status,progressPercent:(j=c(e).task)==null?void 0:j.progress_percent,class:"h-6 !text-lg"},null,8,["status","progressPercent"]),c(e).task?(a(),w(ht,{key:0,task:c(e).task,ref_key:"progress",ref:f,class:"!text-lg"},null,8,["task"])):b("",!0)])]),t("section",xe,[_(Zt,{"task-users":((q=c(e).task)==null?void 0:q.users)||[],task:c(e).task,"sub-tasks":c(e).tasks,"progress-users":k.value},{caption:T(()=>o[11]||(o[11]=[t("div",{class:"text-sm py-1 text-left uppercase font-semibold text-gray-600"}," Assigned Users ",-1)])),_:1},8,["task-users","task","sub-tasks","progress-users"])]),t("div",ve,[c(e).task.deadline?(a(),w(St,{key:0,targetDateTime:c(e).task.deadline,class:"text-lg font-semibold italic text-green-600"},null,8,["targetDateTime"])):b("",!0),y.value?(a(),d("span",he,[o[12]||(o[12]=$(" Started: ")),t("span",Te,g(y.value),1)])):b("",!0),h.value?(a(),d("span",$e,[o[13]||(o[13]=$(" Deadline: ")),t("span",we,g(h.value),1)])):b("",!0)]),o[18]||(o[18]=t("hr",{class:"my-3 col-span-full"},null,-1)),t("div",Ce,[t("button",{onClick:o[1]||(o[1]=C(v=>{var K;return rt((K=c(e).task)==null?void 0:K.id)},["stop"])),class:"btn-2 py-0.5"},"Edit"),_(U,{to:{name:"TaskUserAssign",params:{id:(O=c(e).task)==null?void 0:O.id}},class:"bg-indigo-500 hover:bg-indigo-600 text-white font-semibold px-3 py-0.5 rounded-full transition",onClick:o[2]||(o[2]=v=>v.stopPropagation())},{default:T(()=>o[14]||(o[14]=[t("i",{class:"fas fa-user-plus"},null,-1),$(" Assign Users ")])),_:1,__:[14]},8,["to"]),_(U,{to:lt.value,class:"bg-indigo-500 hover:bg-indigo-600 text-white font-semibold px-3 py-0.5 rounded-full transition",onClick:o[3]||(o[3]=v=>v.stopPropagation())},{default:T(()=>o[15]||(o[15]=[t("i",{class:"fas fa-arrow-left"},null,-1),$(" Back ")])),_:1,__:[15]},8,["to"]),t("div",Se,[((V=c(e).task)==null?void 0:V.children_task_count)===0?(a(),d(P,{key:0},[t("button",{class:"btn-3 px-3 py-0.5 font-semibold border disabled:opacity-30 disabled:pointer-events-none",onClick:o[4]||(o[4]=C(()=>S("start-date"),["prevent"])),disabled:!!((z=x.authUserProgress)!=null&&z.started_at)}," Set Started Date ",8,De),t("button",{class:"btn-3 px-3 py-0.5 font-semibold border disabled:opacity-30 disabled:pointer-events-none",onClick:o[5]||(o[5]=C(()=>S("finish-date"),["prevent"])),disabled:!!((H=x.authUserProgress)!=null&&H.finished_at)}," Set Finish Date ",8,Ie)],64)):b("",!0),m.value.length>0?(a(),w(U,{key:1,to:{name:"TaskShow",params:{id:(G=c(e).task)==null?void 0:G.id}},onClick:o[6]||(o[6]=v=>v.stopPropagation()),class:Y(["py-1 btn-3 ml-auto",{"bg-blue-500 text-white":c(s).name=="TaskShow"}])},{default:T(()=>o[16]||(o[16]=[t("i",{class:"fal fa-list-ul"},null,-1),$(" Sub Tasks ")])),_:1,__:[16]},8,["to","class"])):b("",!0),_(U,{to:{name:"TaskReports",params:{id:(W=c(e).task)==null?void 0:W.id}},onClick:o[7]||(o[7]=v=>v.stopPropagation()),class:Y(["py-1 btn-3",{"bg-blue-500 text-white":c(s).name=="TaskReports"}])},{default:T(()=>o[17]||(o[17]=[t("i",{class:"fal fa-file-alt"},null,-1),$(" Reports ")])),_:1,__:[17]},8,["to","class"])])])]),c(s).name=="TaskShow"&&((J=c(e).task)==null?void 0:J.level)<=2?(a(),d("section",Pe,[_(Nt,{subTasks:m.value,"parent-id":c(s).params.id,"tree-level":c(e).task.level+1,onCreated:o[8]||(o[8]=v=>l(c(s).params.id)),onUpdated:o[9]||(o[9]=v=>l(c(s).params.id)),onUpdatePriority:o[10]||(o[10]=v=>l(c(s).params.id))},null,8,["subTasks","parent-id","tree-level"])])):(a(),d("section",Ue,[_(it)]))],64)):(a(),d("div",Le,g(c(e).error),1)),p.value==="changing"?(a(),w(Z,{key:2,class:"absolute bg-opacity-80 inset-0 z-20"})):b("",!0)]))])}}};export{We as default};
