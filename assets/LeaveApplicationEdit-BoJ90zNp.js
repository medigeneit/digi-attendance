import{d as Z,u as ee,b as ae,m as k,r as _,e as te,a4 as le,z as q,n as se,c,o as p,a,f as oe,p as I,i as ne,j as ie,w as de,g as j,h as f,v as T,t as U,F as z,q as Y,k as J,a5 as B}from"./index-Buhj-MDq.js";import{L as re}from"./LoaderView-C7issKRf.js";import{_ as ue}from"./MultiselectDropdown-DB41Ou-X.js";import{u as pe}from"./holiday-BBjAeL1w.js";import{u as ve}from"./leave-application-CkD22-Vc.js";import{u as ce}from"./leave-type-DWhhD-q1.js";import{u as me}from"./user-CxA2I5So.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const _e={class:"my-container max-w-3xl space-y-4"},fe={class:"flex items-center justify-between gap-2"},ye={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},ge={key:0,class:""},we={class:"text-blue-600 font-medium"},ke={key:1,class:"bg-gray-100 p-2 rounded-md"},he={class:"font-semibold"},be={class:"flex flex-wrap gap-2"},De=["name","value","onUpdate:modelValue","disabled"],Ae={class:"flex items-center space-x-1"},xe=["name","onUpdate:modelValue"],Le={class:"flex items-center space-x-1"},Se=["name","onUpdate:modelValue"],Te={key:2,class:"text-red-500 text-sm"},He={__name:"LeaveApplicationEdit",setup(Ue){const v=Z(),d=ve(),C=ee(),M=ae(),y=ce(),g=me(),F=pe(),V=k(()=>d.leaveApplication),O=k(()=>M.params.id),b=_(null),s=_({user_id:"",last_working_date:"",resumption_date:"",reason:"",works_in_hand:"",handover_user_id:"",leave_days:[]}),r=_([]),E=_([]),D=_(!1),A=_(null),P=_(!1),G=k(()=>{var n,e,i;return((e=(n=v==null?void 0:v.user)==null?void 0:n.assign_weekend)==null?void 0:e.weekends)||((i=v==null?void 0:v.user)==null?void 0:i.weekends)});te(async()=>{var e,i,t,l,o,m,x,L,H,N,W,$;const{id:n}=M.params;P.value=!!n;try{await d.fetchLeaveApplicationById(n);const S=(t=(i=(e=d.leaveApplication)==null?void 0:e.user)==null?void 0:i.company)==null?void 0:t.id;if(S&&await y.fetchLeaveTypes(S),d.leaveApplication){if(await g.fetchTypeWiseEmployees({type:d.leaveApplication.user.type,except:[d.leaveApplication.user.id]}),g.users=g.users.map(w=>({...w,label:w.name})),g.users.length>0){const w=k(()=>g.users.find(R=>{var h;return R.id===((h=d.leaveApplication)==null?void 0:h.handover_user_id)})||{});b.value=w.value}s.value.user_id=(l=d.leaveApplication)==null?void 0:l.user_id,s.value.last_working_date=(o=d.leaveApplication)==null?void 0:o.last_working_date,s.value.resumption_date=(m=d.leaveApplication)==null?void 0:m.resumption_date,s.value.reason=(x=d.leaveApplication)==null?void 0:x.reason,s.value.works_in_hand=(L=d.leaveApplication)==null?void 0:L.works_in_hand,s.value.handover_user_id=(H=d.leaveApplication)==null?void 0:H.handover_user_id,s.value.leave_days=(N=d.leaveApplication)==null?void 0:N.leave_days,console.log(d.leaveApplication),(W=d.leaveApplication)!=null&&W.json_data&&(($=d.leaveApplication)==null||$.json_data.forEach((w,R)=>{var h;r.value[R]=w.leave_type_id||((h=y.leaveTypes[0])==null?void 0:h.id)}))}}catch(S){console.error("Failed to load leave application:",S)}finally{D.value=!1}});const u=k(()=>{const n=s.value.last_working_date,e=s.value.resumption_date;if(!n||!e)return[];const i=new Date(n),t=new Date(e);if(t<=i)return[];const l=[];let o=new Date(i);for(o.setDate(o.getDate()+1);o<t;){const m=o.getFullYear(),x=(o.getMonth()+1).toString().padStart(2,"0"),L=o.getDate().toString().padStart(2,"0");l.push(`${m}-${x}-${L}`),o.setDate(o.getDate()+1)}return l}),K=k(()=>{const n=s.value.last_working_date,e=s.value.resumption_date;if(!n||!e)return"";const i=new Date(n);return new Date(e)<=i?"Resumption date must be after Last Working Date.":u.value.length===0?"No leave days between the selected dates.":`Total leave days: ${u.value.length}`});le(async()=>{var n;u.value.length&&y.leaveTypes.length&&(r.value.length!==u.value.length&&(r.value=u.value.map(()=>{var e;return(e=y.leaveTypes[0])==null?void 0:e.id})),await F.fetchHolidays({company_id:(n=v==null?void 0:v.user)==null?void 0:n.company_id,start_date:u.value[0],end_date:u.value[u.value.length-1]}),u.value.forEach(async(e,i)=>{const t=new Date(e).toLocaleString("en-us",{weekday:"long"}).toLowerCase(),l=t.charAt(0).toUpperCase()+t.slice(1);G.value.includes(l)&&(r.value[i]="weekend"),F.holidayDates.includes(e)&&(r.value[i]="holiday")}))}),q(()=>b.value,n=>{s.value.handover_user_id=n==null?void 0:n.id}),q(r,n=>{const e={};n.forEach(t=>{typeof t=="number"&&(e[t]=(e[t]||0)+1)});const i=y.leaveTypes.filter(t=>(e[t.id]||0)>t.remaining_days);i.length?(E.value=i.map(t=>t.name),alert(`You have exceeded remaining days for: ${E.value.join(", ")}`)):E.value=[]});const Q=async()=>{var n;D.value=!0,A.value=null;try{const e=u.value.map((l,o)=>({date:l,leave_type_id:r.value[o]!=="weekend"&&r.value[o]!=="holiday"?r.value[o]:null})).filter(l=>l.leave_type_id!==null),i=u.value.map((l,o)=>({date:l,leave_type_id:r.value[o]||""})),t={id:O.value,user_id:(n=V==null?void 0:V.value)==null?void 0:n.user_id,last_working_date:s.value.last_working_date,resumption_date:s.value.resumption_date,reason:s.value.reason,works_in_hand:s.value.works_in_hand,handover_user_id:s.value.handover_user_id,leave_days:e,json_data:i};if(t.id){const l=await d.updateLeaveApplication(t.id,t);l&&C.push({name:"LeaveApplicationShow",params:{id:l==null?void 0:l.id}})}}catch(e){A.value=e.message||"Failed to submit leave application"}finally{D.value=!1}},X=()=>C.go(-1);return(n,e)=>{const i=se("RouterLink");return p(),c("div",_e,[a("div",fe,[a("button",{class:"btn-3",onClick:X},e[5]||(e[5]=[a("i",{class:"far fa-arrow-left"},null,-1),a("span",{class:"hidden md:flex"},"Back",-1)])),e[7]||(e[7]=a("h1",{class:"title-md md:title-lg flex-wrap text-center"},"Leave Application Form",-1)),a("div",null,[I(i,{to:"/applications",class:"btn-2"},{default:ne(()=>e[6]||(e[6]=[ie("Home")])),_:1,__:[6]})])]),D.value?(p(),oe(re,{key:0})):(p(),c("form",{key:1,onSubmit:de(Q,["prevent"]),class:"space-y-4 card-bg p-4 md:p-8"},[a("div",ye,[a("div",null,[e[8]||(e[8]=a("label",{for:"last-working-date",class:"block text-sm font-medium"},"Last Working Date",-1)),f(a("input",{type:"date",id:"last-working-date","onUpdate:modelValue":e[0]||(e[0]=t=>s.value.last_working_date=t),class:"input-1 w-full",required:""},null,512),[[T,s.value.last_working_date]])]),a("div",null,[e[9]||(e[9]=a("label",{for:"resumption-date",class:"block text-sm font-medium"},"Resumption Date",-1)),f(a("input",{type:"date",id:"resumption-date","onUpdate:modelValue":e[1]||(e[1]=t=>s.value.resumption_date=t),class:"input-1 w-full",required:""},null,512),[[T,s.value.resumption_date]])])]),s.value.last_working_date&&s.value.resumption_date?(p(),c("div",ge,[a("p",we,U(K.value),1)])):j("",!0),u.value.length?(p(),c("div",ke,[e[12]||(e[12]=a("h2",{class:"text-lg font-semibold"},"Leave Days",-1)),a("div",null,[(p(!0),c(z,null,Y(u.value,(t,l)=>(p(),c("div",{key:l,class:"flex gap-4 mb-2 bg-white p-2 rounded-md"},[a("div",he,U(t),1),a("div",be,[(p(!0),c(z,null,Y(J(y).leaveTypes,o=>(p(),c("label",{key:o.id,class:"flex items-center space-x-1"},[f(a("input",{type:"radio",name:"leaveType-"+l,value:o.id,"onUpdate:modelValue":m=>r.value[l]=m,disabled:r.value.filter(m=>m===o.id).length>=o.remaining_days},null,8,De),[[B,r.value[l]]]),a("span",null,U(o.leave_type),1)]))),128)),a("label",Ae,[f(a("input",{type:"radio",name:"leaveType-"+l,value:"weekend","onUpdate:modelValue":o=>r.value[l]=o},null,8,xe),[[B,r.value[l]]]),e[10]||(e[10]=a("span",null,"Weekend",-1))]),a("label",Le,[f(a("input",{type:"radio",name:"leaveType-"+l,value:"holiday","onUpdate:modelValue":o=>r.value[l]=o},null,8,Se),[[B,r.value[l]]]),e[11]||(e[11]=a("span",null," Holiday",-1))])])]))),128))])])):j("",!0),a("div",null,[e[13]||(e[13]=a("label",{for:"reason",class:"block text-sm font-medium"},"Reason",-1)),f(a("textarea",{id:"reason","onUpdate:modelValue":e[2]||(e[2]=t=>s.value.reason=t),class:"input-1 w-full",placeholder:"Enter your reason for leave"},null,512),[[T,s.value.reason]])]),a("div",null,[e[14]||(e[14]=a("label",{for:"handover-user",class:"block text-sm font-medium"},"Handover User",-1)),I(ue,{modelValue:b.value,"onUpdate:modelValue":e[3]||(e[3]=t=>b.value=t),options:J(g).users,multiple:!1,label:"label",placeholder:"Select user"},null,8,["modelValue","options"])]),a("div",null,[e[15]||(e[15]=a("label",{for:"works-in-hand",class:"block text-sm font-medium"},"Works in Hand",-1)),f(a("textarea",{id:"works-in-hand","onUpdate:modelValue":e[4]||(e[4]=t=>s.value.works_in_hand=t),class:"input-1 w-full",placeholder:"Enter details of works in hand",rows:"6"},null,512),[[T,s.value.works_in_hand]])]),A.value?(p(),c("div",Te,U(A.value),1)):j("",!0),e[16]||(e[16]=a("div",{class:"flex justify-end"},[a("button",{type:"submit",class:"btn-1"},"Update")],-1))],32))])}}};export{He as default};
