import{L as ut}from"./LoaderView-CmYvZpI6.js";import{O as P}from"./OverlyModal-BuEP8jX_.js";import{_ as G}from"./DepartmentChip-CNvECgCJ.js";import{b as ct,_ as mt}from"./TaskTableRow-BBidTOAV.js";import{_ as kt}from"./TaskAddForm-BdRsXbWl.js";import{_ as pt}from"./TaskEditForm-BmczI6Ia.js";import{_ as yt}from"./TaskUserAssignForm-r37-d1ty.js";import{f as ft,g as et,x as j,p as _t,c as r,o as n,k as y,a,F,e as R,s as H,j as A,t as T,m as M,b as Q,w as gt,n as $,r as O,E as W,h as vt,q as ht,d as v,M as xt}from"./index-DoDyGwYu.js";import{u as wt}from"./task-priority-dm6S_BTB.js";import{u as bt}from"./useRequirementStore-Bsg7wiOS.js";import{u as Tt}from"./useTaskStore-CSmixHqr.js";const Ct={class:"w-full p-1"},At={key:0,class:"w-full rounded-b"},$t={class:"group/dept"},Lt={class:"flex gap-1 items-center text-base"},It={class:"font-bold text-lime-600"},Bt={key:0},Ft=["onClick"],St={class:"ml-auto"},Ot=["onClick"],tt={__name:"TaskTable",props:{tasks:{type:Array,required:!0,default:()=>[]},hideButtons:{type:Boolean,default:!1},parentTreeLevel:{type:Number},maxItem:{Number,default:5},isMyTask:{type:Boolean,default:!1},taskLinkTo:{type:Function,default:null}},emits:["editClick","addClick","employeeAssignClick","clickAddClick","clickAttachment"],setup(L,{emit:K}){const J=L,k=ft(),z=et(),p=j(()=>J.tasks.reduce((m,s)=>{var d;const _=((d=s.requirement)==null?void 0:d.id)||"-",h=[...m],e=h.find(u=>(u==null?void 0:u.key)==_);return e?e.tasks=[...e.tasks,s]:h.push({key:_,position:s!=null&&s.requirement?0:1,...(s==null?void 0:s.requirement)||{title:"(Other tasks)",id:0},tasks:[s]}),h},[]).sort((m,s)=>m.position-s.position)),C=K;return(m,s)=>{var h;const _=_t("RouterLink");return n(),r("div",Ct,[((h=L.tasks)==null?void 0:h.length)>0?(n(),r("table",At,[s[4]||(s[4]=a("thead",null,[a("tr",null,[a("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 w-[30px] sticky -top-4 z-20"}," SL "),a("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Task "),a("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Assign Person "),a("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Deadline "),a("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 -top-4 z-20 sticky right-0 border-l bg-sky-50 px-2 whitespace-nowrap"}," Status ")])],-1)),a("tbody",null,[(n(!0),r(F,null,R(p.value,(e,d)=>{var u,E,U,I,S,N;return n(),r(F,{key:e.id},[a("tr",$t,[a("th",{colspan:"10",class:H(["font-semibold",[(d>0,"")]])},[a("div",{class:H(["text-left -mx-[2px] -mb-[1px] py-2 px-2 flex items-center border border-b-0 rounded-t bg-emerald-50",[e.id===0?"text-gray-500":"text-sky-800",d>0?"mt-4":""]])},[a("div",Lt,[a("div",It,T(d+1)+".",1),e.id===0?(n(),r("p",Bt,T(e.title),1)):(n(),A(_,{key:1,to:`requirements/show/${e.id}`,class:"line-clamp-2 hover:underline"},{default:M(()=>[Q(T(e.title),1)]),_:2},1032,["to"])),((u=e.attachments)==null?void 0:u.length)>0?(n(),r("button",{key:2,class:"text-sky-400 text-sm",onClick:gt(B=>C("clickAttachment",e.attachments),["prevent"])},[s[2]||(s[2]=a("i",{class:"fas fa-paperclip"},null,-1)),Q(" "+T((E=e.attachments)==null?void 0:E.length)+" Attachment"+T(((U=e.attachments)==null?void 0:U.length)>1?"s":""),1)],8,Ft)):y("",!0)]),a("div",St,[((I=$(k))==null?void 0:I.name)=="RequirementTaskList"&&((N=(S=$(z))==null?void 0:S.user)==null?void 0:N.department_id)==(e==null?void 0:e.to_department_id)?(n(),r("button",{key:0,onClick:B=>C("clickAddTask",{requirement_id:e==null?void 0:e.id,from_department_id:e==null?void 0:e.from_department_id,to_department_id:e==null?void 0:e.to_department_id},{requirement_id:!0,from_department_id:!0,to_department_id:!0}),class:"btn-2 whitespace-nowrap h-6 px-3 opacity-70 group-hover/dept:opacity-100"},s[3]||(s[3]=[a("i",{class:"fas fa-plus-circle"},null,-1),Q(" Add Task ")]),8,Ot)):y("",!0)])],2)],2)]),(n(!0),r(F,null,R(e.tasks,(B,x)=>(n(),A(ct,{key:B.id,task:B,indexing:`${d+1}.${x+1}`,onEditClick:s[0]||(s[0]=w=>C("editClick",w)),onEmployeeAssignClick:s[1]||(s[1]=w=>C("employeeAssignClick",w)),taskLinkTo:L.taskLinkTo,hideButtons:L.hideButtons},null,8,["task","indexing","taskLinkTo","hideButtons"]))),128))],64)}),128))])])):y("",!0)])}}},Mt={class:"mb-4"},Rt={key:4,class:"text-center py-4 text-red-500"},zt={class:"relative min-h-[60vh]"},Et={key:0,class:"space-y-6"},Ut={class:"sticky top-14 z-40 text-gray-700 bg-gradient-to-tl from-sky-400/60 to-sky-400 py-2 px-4 flex items-center"},Nt={class:"font-semibold flex items-center gap-2"},Vt={class:"text-white text-base"},Dt={class:"rounded-b-md overflow-y-auto"},Pt={key:1,class:"space-y-6"},jt={class:"sticky top-14 z-40 text-gray-700 bg-gradient-to-tl from-sky-400/60 to-sky-400 py-2 px-4 flex items-center"},Ht={class:"font-semibold flex items-center gap-2"},Kt={class:"ml-auto"},Jt=["onClick"],Qt={class:"rounded-b-md overflow-y-auto"},Wt={key:2,class:"text-center py-4 text-gray-500 border h-[60vh] flex items-center justify-center rounded bg-gray-50 italic"},ie={__name:"RequirementTaskList",props:{taskFilters:{type:Object,default:()=>({})},showOnlyMyTasks:{type:Boolean,default:!1},inContainer:{type:Boolean,default:!0}},emits:["update:taskFilters","loading"],setup(L,{expose:K,emit:J}){const k=L,z=J,p=Tt(),C=bt(),m=O(""),s=O(null),_=O(!1),h=et(),e=W({show:!1,attachments:[]}),d=W({parentId:0,requirementId:0,params:{}}),u=W({taskId:0,isOpen:!1}),E=j(()=>{const i=k.taskFilters["user-ids"]||null,t=(p.tasks||[]).flatMap(c=>{var g;return i?(g=c.users)==null?void 0:g.filter(V=>i.includes(V.id)):c.users});return[...new Map(t.map(c=>[c.id,c])).values()].sort((c,g)=>c.id-g.id)}),U=j(()=>(p.tasks||[]).reduce((i,t)=>{const b=`${t.from_department_id}-${t.to_department_id}`,c=i.find(g=>g.key==b);return c?c.tasks=[...c.tasks,t]:i.push({key:b,from_department:t.from_department,to_department:t.to_department,tasks:[t]}),i},[])),I=O(null),S=O([]),{saveTaskPriority:N,listHasRearranged:B}=wt(()=>p.taskListTree,0);vt(()=>{m.value="loading",x()});async function x(){z("loading",!0),k.showOnlyMyTasks?await p.fetchAllMyTasks({...k.taskFilters,page:1}):await p.fetchAllTasks({...k.taskFilters,page:1}),z("loading",!1),m.value="",S.value=p.query_log||[]}const w=(i,t)=>{_.value=!0,d.params=i,d.readonlyValues=t},X=i=>{u.taskId=i,u.isOpen=!0};async function Y(){s.value=null,_.value=!1,m.value="loading",d.params={},await x()}async function st(){_.value=!1,d.params={},await x()}async function at(){m.value="loading",await N()&&await x()}function nt(i){return p.tasks.filter(t=>(t.users||[]).some(b=>b.id===i))}ht(()=>({...k.taskFilters}),async()=>{try{p.resetTaskList(),m.value="loading",await x()}catch(i){console.warn(i)}});function ot(i,t){w(i,t)}function it(){return at()}function rt(){return B&&I.value&&I.value.resetItems?I.value.resetItems():null}K({openAdd:ot,savePriority:it,discardPriority:rt});function lt(i){return{name:"RequirementTaskShow",params:{id:(i==null?void 0:i.id)||0}}}const dt=j(()=>k.inContainer?"p-6 mt-2 container mx-auto relative bg-white rounded-md shadow-md min-h-[calc(100vh-12rem)]":"");return(i,t)=>{var b,c,g,V;return n(),r("div",{class:H(dt.value)},[s.value?(n(),A(P,{key:0},{default:M(()=>[v(pt,{taskId:s.value,onClose:t[0]||(t[0]=o=>s.value=null),onUpdated:Y},null,8,["taskId"])]),_:1})):y("",!0),_.value?(n(),A(P,{key:1},{default:M(()=>{var o,l;return[v(kt,{parentTaskId:d.parentId,requirementId:(o=d.params)==null?void 0:o.requirement_id,requirementDetailId:(l=d.params)==null?void 0:l.requirement_detail_id,"default-values":d.params,"readonly-fields":d.readonlyValues,onClose:st,onTaskCreated:Y},null,8,["parentTaskId","requirementId","requirementDetailId","default-values","readonly-fields"])]}),_:1})):y("",!0),u.isOpen?(n(),A(P,{key:2,class:"*:max-w-4xl"},{default:M(()=>[v(yt,{taskId:u.taskId,onCancelClick:t[1]||(t[1]=()=>{u.isOpen=!1,u.taskId=0}),onSuccess:t[2]||(t[2]=()=>{u.isOpen=!1,u.taskId=0,m.value="loading",x()})},null,8,["taskId"])]),_:1})):y("",!0),((b=k.taskFilters)==null?void 0:b["query-log"])=="true"?(n(!0),r(F,{key:3},R(S.value,(o,l)=>(n(),r("div",{key:l,class:"text-xs text-gray-500"},[a("div",Mt,T(o.raw_query),1)]))),128)):y("",!0),$(C).error?(n(),r("div",Rt,T($(C).error),1)):y("",!0),a("div",zt,[((c=k.taskFilters)==null?void 0:c.view)==="userwise"?(n(),r("div",Et,[(n(!0),r(F,null,R(E.value,o=>(n(),r("div",{key:o.id,class:"rounded-md border-2 border-sky-300"},[a("div",Ut,[a("div",Nt,[v(xt,{user:o},null,8,["user"]),a("div",Vt,T(o.label),1)])]),a("div",Dt,[v(tt,{tasks:nt(o.id),onEditClick:t[3]||(t[3]=l=>s.value=l),onAddClick:t[4]||(t[4]=l=>w(l)),onEmployeeAssignClick:t[5]||(t[5]=l=>X(l)),onClickAttachment:t[6]||(t[6]=l=>{e.show=!0,e.attachments=l}),taskLinkTo:l=>({name:"RequirementTaskShow",params:{id:(l==null?void 0:l.id)||0}})},null,8,["tasks","taskLinkTo"])])]))),128))])):(n(),r("div",Pt,[(n(!0),r(F,null,R(U.value,o=>{var l,Z,q;return n(),r("div",{key:o.key,class:"rounded-md border-2 border-sky-300"},[a("div",jt,[a("div",Ht,[t[12]||(t[12]=a("span",{class:"text-white text-sm"},"From",-1)),v(G,{department:o.from_department},null,8,["department"]),t[13]||(t[13]=a("span",{class:"text-white text-sm"},"To",-1)),v(G,{department:o.to_department},null,8,["department"])]),a("div",Kt,[!k.showOnlyMyTasks&&((Z=(l=$(h))==null?void 0:l.user)==null?void 0:Z.department_id)==((q=o==null?void 0:o.to_department)==null?void 0:q.id)?(n(),r("button",{key:0,onClick:()=>{var f,D;return w({from_department_id:(f=o==null?void 0:o.from_department)==null?void 0:f.id,to_department_id:(D=o==null?void 0:o.to_department)==null?void 0:D.id},{from_department_id:!0,to_department_id:!0})},class:"btn-3 h-6 whitespace-nowrap bg-white border-white px-2"}," Add Task ",8,Jt)):y("",!0)])]),a("div",Qt,[v(tt,{tasks:o.tasks,groupBy:"requirement",onEditClick:t[7]||(t[7]=f=>s.value=f),onClickAddTask:t[8]||(t[8]=(f,D)=>w(f,D)),onEmployeeAssignClick:t[9]||(t[9]=f=>X(f)),onClickAttachment:t[10]||(t[10]=f=>{e.show=!0,e.attachments=f}),hideButtons:k.showOnlyMyTasks,taskLinkTo:lt},null,8,["tasks","hideButtons"])])])}),128))])),m.value!=="loading"&&((g=$(p).tasks)==null?void 0:g.length)===0?(n(),r("div",Wt," No tasks ")):y("",!0),m.value==="loading"?(n(),A(ut,{key:3,class:H(["absolute inset-0 flex items-center z-50 bg-opacity-60 h-full shadow-none border",[((V=$(p).tasks)==null?void 0:V.length)===0?"justify-center":""]])},null,8,["class"])):y("",!0)]),e.show?(n(),A(P,{key:5},{default:M(()=>[v(mt,{attachments:e.attachments||[],onClickClose:t[11]||(t[11]=o=>e.show=!1)},null,8,["attachments"])]),_:1})):y("",!0)],2)}}};export{ie as _};
