import{L as ke}from"./LoaderView-B_65gys4.js";import{u as se}from"./user-monthly-kpi-Cd3nBbBs.js";import{u as ne}from"./monthly-kpi-forms-Brosc_c-.js";import{u as we}from"./user-BozEEhNU.js";import{Q as le,r as y,q as M,x,h as oe,c as u,j,o as i,a,t as m,d as C,k as $e,H as Ce,F as de,e as ie,u as Se,f as qe,D as te,p as Fe,l as ae,b as L,s as V,m as h,i as Le}from"./index-f0yJNl-w.js";import{_ as re}from"./EmployeeFilter-8r3FH79_.js";import{_ as H}from"./FlexibleDatePicker-C27bWrVp.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./company-DdPTgN1i.js";import"./department-C5WB6hDi.js";import"./EmployeeDropdownInput-neRa36ec.js";import"./SelectDropdown-D35Q5FeR.js";import"./UserChip-D2K91x1U.js";const Ve={key:0,class:"fixed inset-0 z-50 flex items-center justify-center"},Ue={class:"relative w-full max-w-3xl rounded-2xl bg-white shadow-lg border p-4"},Ne={class:"grid gap-3 md:grid-cols-12"},Me={key:0,class:"md:col-span-7"},ze={class:"rounded-md border px-3 py-2 bg-gray-50 text-gray-700"},Ie={class:"text-sm"},De={key:1,class:"md:col-span-7"},Ee={key:0,class:"mt-1 text-xs text-gray-500"},Pe={class:"md:col-span-5"},Be=["value"],je={class:"mt-4 flex justify-end gap-2"},Te=["disabled"],Ye=["disabled"],Ae={key:0},Oe={key:1},Ke={__name:"CreateEvaluationModal",props:{modelValue:{type:Boolean,default:!1},userId:{type:[Number,String],default:""},userLabel:{type:String,default:""}},emits:["update:modelValue","created"],setup(z,{emit:I}){var $;const S=z,r=I,q=le(),f=se(),g=($=ne)==null?void 0:$(),k=y(S.modelValue);M(()=>S.modelValue,v=>k.value=v),M(k,v=>r("update:modelValue",v));const o=y({company_id:"",department_id:"",employee_id:"",line_type:"",user_id:"",form_id:""}),U=y([]),w=y(!1),T=x(()=>!!S.userId);M(()=>S.userId,async v=>{var l;v&&(o.value.user_id=String(v),o.value.company_id="",o.value.department_id="",o.value.employee_id="",o.value.line_type="",g&&(await((l=g.fetchList)==null?void 0:l.call(g,{per_page:100})),U.value=g.items||[]))},{immediate:!0}),oe(async()=>{var v;g&&(await((v=g.fetchList)==null?void 0:v.call(g,{per_page:100})),U.value=g.items||[])});function Y(){o.value.user_id=o.value.employee_id||""}async function D(){var v,l;if(!o.value.user_id||!o.value.form_id){q.error("User এবং Form সিলেক্ট করুন");return}try{w.value=!0;const d=await f.create(Number(o.value.user_id),Number(o.value.form_id));q.success("Evaluation created"),r("created",d),k.value=!1}catch(d){q.error(((l=(v=d==null?void 0:d.response)==null?void 0:v.data)==null?void 0:l.message)||"Failed to create")}finally{w.value=!1}}function p(){k.value=!1}return(v,l)=>k.value?(i(),u("div",Ve,[a("div",{class:"absolute inset-0 bg-black/40",onClick:p}),a("div",Ue,[a("div",{class:"flex items-center justify-between mb-3"},[l[6]||(l[6]=a("h3",{class:"text-lg font-semibold"},"Create Evaluation",-1)),a("button",{class:"btn-icon",onClick:p},l[5]||(l[5]=[a("i",{class:"far fa-times"},null,-1)]))]),a("div",Ne,[T.value?(i(),u("div",Me,[l[8]||(l[8]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Employee",-1)),a("div",ze,[a("span",Ie,m(z.userLabel||"#"+String(z.userId)),1),l[7]||(l[7]=a("span",{class:"ml-2 inline-flex items-center rounded-full bg-blue-100 px-2 py-0.5 text-xs text-blue-700"}," locked ",-1))])])):(i(),u("div",De,[l[9]||(l[9]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Employee",-1)),C(re,{company_id:o.value.company_id,"onUpdate:company_id":l[0]||(l[0]=d=>o.value.company_id=d),department_id:o.value.department_id,"onUpdate:department_id":l[1]||(l[1]=d=>o.value.department_id=d),employee_id:o.value.employee_id,"onUpdate:employee_id":l[2]||(l[2]=d=>o.value.employee_id=d),line_type:o.value.line_type,"onUpdate:line_type":l[3]||(l[3]=d=>o.value.line_type=d),"with-type":!0,onFilterChange:Y,class:"w-full"},null,8,["company_id","department_id","employee_id","line_type"]),o.value.user_id?(i(),u("p",Ee,"Selected user_id: "+m(o.value.user_id),1)):j("",!0)])),a("div",Pe,[l[11]||(l[11]=a("label",{class:"block text-sm font-medium text-gray-700"},"Form",-1)),$e(a("select",{"onUpdate:modelValue":l[4]||(l[4]=d=>o.value.form_id=d),class:"mt-1 w-full rounded-md border px-3 py-2 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200"},[l[10]||(l[10]=a("option",{value:""},"Select a form…",-1)),(i(!0),u(de,null,ie(U.value,d=>(i(),u("option",{key:d.id,value:d.id}," #"+m(d.id)+" — "+m(d.type)+" — "+m(d.start_month)+m(d.end_month?` → ${d.end_month}`:""),9,Be))),128))],512),[[Ce,o.value.form_id]])])]),a("div",je,[a("button",{class:"btn-3",onClick:p,disabled:w.value},"Cancel",8,Te),a("button",{class:"btn-2",onClick:D,disabled:w.value},[w.value?(i(),u("span",Ae,"Creating…")):(i(),u("span",Oe,"Create"))],8,Ye)])])])):j("",!0)}},Re={class:"space-y-4 px-4 max-w-7xl mx-auto my-6"},He={class:"flex items-center justify-between gap-2"},Qe={class:"flex gap-2"},Ge={class:"rounded-xl border bg-white p-4 md:p-5 shadow-sm"},Je={class:"grid gap-4 md:grid-cols-12"},We={class:"col-span-full"},Xe={class:"md:col-span-3"},Ze={class:"inline-flex rounded-lg bg-slate-100 p-1"},et={class:"md:col-span-6"},tt={class:"inline-flex rounded-lg bg-slate-100 p-1"},at={class:"inline-flex rounded-lg p-1 ml-4 gap-3"},st={class:"mt-3"},nt={key:0,class:"inline-flex items-center"},lt={key:1,class:"flex flex-wrap items-end gap-3"},ot={class:"md:col-span-3 flex items-end justify-end gap-2"},dt=["disabled"],it=["disabled"],rt={key:0,class:"py-8 text-center"},ut={key:1,class:"rounded-md border border-red-200 bg-red-50 p-3 text-red-700"},pt={key:2,class:"overflow-x-auto rounded-xl border bg-white shadow-sm"},mt={class:"min-w-full text-sm"},_t={class:"px-3 py-2"},vt={class:"px-3 py-2"},ct={class:"px-3 py-2"},yt={key:0,class:"text-gray-700"},gt={key:1,class:"text-gray-400"},ft={class:"px-3 py-2"},bt={key:0},ht={key:1,class:"text-gray-400"},xt={class:"px-3 py-2"},kt={class:"px-3 py-2 text-right"},wt={class:"flex items-center justify-end gap-2"},$t=["onClick"],Ct=["onClick"],St={key:0},qt={colspan:"7",class:"px-3 py-6 text-center text-gray-600"},Ft={key:0,class:"flex items-center justify-between p-3 text-sm"},Lt={class:"text-gray-600"},Vt={class:"font-medium"},Ut={class:"font-medium"},Nt={class:"font-medium"},Mt={class:"flex items-center gap-2"},zt=["disabled"],It={class:"text-gray-700"},Dt=["disabled"],Jt={__name:"EvaluationList",setup(z){var ee;const I=le(),S=Se(),r=qe(),q=se(),{list:f,isLoading:g,error:k}=te(q),o=(ee=ne)==null?void 0:ee(),U=y([]),w=we(),{users:T,isLoading:Y,error:D}=te(w),p=y({total:0,current_page:1,last_page:1,per_page:10});function $(s=new Date){const t=s.getFullYear(),c=String(s.getMonth()+1).padStart(2,"0");return`${t}-${c}`}function v(s){if(!s)return{start:"",end:""};const[t,c]=s.split("-").map(Number),n=`${s}-01`,_=new Date(t,c,0).getDate(),b=`${s}-${String(_).padStart(2,"0")}`;return{start:n,end:b}}const l=r.query.month||$(),d=s=>String(s??"").padStart(2,"0"),A=s=>{const t=new Date;if(!s)return{year:t.getFullYear(),month:t.getMonth()+1,day:1};const[c="",n=""]=String(s).split("-");return{year:Number(c)||t.getFullYear(),month:Number(n)||t.getMonth()+1,day:1}},O=s=>`${s.year}-${d(s.month)}`,e=y({company_id:r.query.company_id?Number(r.query.company_id):"",department_id:r.query.department_id?Number(r.query.department_id):"",employee_id:r.query.employee_id?Number(r.query.employee_id):"",line_type:r.query.line_type??"",user_id:r.query.user_id?Number(r.query.user_id):"",form_id:r.query.form_id?Number(r.query.form_id):"",finalized:r.query.finalized??"",per_page:r.query.per_page?Number(r.query.per_page):10,page:r.query.page?Number(r.query.page):1,period:r.query.period||"month",month:r.query.month||l,start_month:r.query.start_month||l,end_month:r.query.end_month||l}),Q=x({get(){return A(e.value.month)},set(s){s&&(e.value.month=O(s))}}),G=x({get(){return A(e.value.start_month)},set(s){s&&(e.value.start_month=O(s))}}),J=x({get(){return A(e.value.end_month)},set(s){s&&(e.value.end_month=O(s))}}),ue=x(()=>{if(e.value.period==="month"){const{start:s,end:t}=v(e.value.month);return{month:e.value.month,month_start:s,month_end:t}}else if(e.value.period==="range"){const s=v(e.value.start_month).start,t=v(e.value.end_month).end;return{month_start:s,month_end:t}}return{}}),N=x(()=>!!e.value.company_id&&!!e.value.department_id),pe=x(()=>e.value.period==="month"?e.value.month!==l:e.value.start_month!==l||e.value.end_month!==l),me=x(()=>N.value||!!e.value.form_id||e.value.finalized!==""||!!e.value.line_type||pe.value),_e=y(!1),K=x(()=>g.value||Y.value||_e.value);async function F(){var t,c,n;if(!N.value){f.value=[],p.value={total:0,current_page:1,last_page:1,per_page:e.value.per_page};return}const s={company_id:e.value.company_id,department_id:e.value.department_id,line_type:e.value.line_type||void 0,employee_id:e.value.employee_id||null,form_id:e.value.form_id||void 0,finalized:e.value.finalized===""?void 0:e.value.finalized,per_page:e.value.per_page,page:e.value.page,...ue.value};try{await w.fetchUsers({company_id:s.company_id,department_id:s.department_id,line_type:s.line_type,employee_id:s.employee_id,per_page:s.per_page,page:s.page});const _=await q.fetchList(s),b=_==null?void 0:_.meta;p.value=b?{total:b.total??0,current_page:b.current_page??1,last_page:b.last_page??1,per_page:b.per_page??e.value.per_page}:{total:((t=f.value)==null?void 0:t.length)||0,current_page:1,last_page:1,per_page:e.value.per_page}}catch(_){I.error(((n=(c=_==null?void 0:_.response)==null?void 0:c.data)==null?void 0:n.message)||"Failed to load list")}}function E(){S.replace({query:{company_id:e.value.company_id||void 0,department_id:e.value.department_id||void 0,line_type:e.value.line_type||void 0,user_id:e.value.user_id||void 0,employee_id:e.value.employee_id||void 0,form_id:e.value.form_id||void 0,finalized:e.value.finalized||void 0,per_page:e.value.per_page!==10?String(e.value.per_page):void 0,page:e.value.page>1?String(e.value.page):void 0,period:e.value.period||void 0,month:e.value.period==="month"?e.value.month:void 0,start_month:e.value.period==="range"?e.value.start_month:void 0,end_month:e.value.period==="range"?e.value.end_month:void 0}}).catch(()=>{})}async function ve(){e.value.user_id=e.value.employee_id||"",e.value.page=1,await F(),E()}async function ce(){if(!N.value)return I.error("Select Company & Department");e.value.page=1,await F(),E()}async function ye(){e.value={company_id:"",department_id:"",employee_id:"",line_type:"",user_id:"",form_id:"",finalized:"",per_page:10,page:1,period:"month",month:l,start_month:l,end_month:l},await F(),E()}async function W(s){s<1||s>p.value.last_page||(e.value.page=s,await F(),E())}const ge=y(!1),fe=y({kpiId:null,userId:null,userLabel:""});function be(s){fe.value={kpiId:s.id,userId:s.user_id,userLabel:R(s.user_id)},ge.value=!0}const P=y(!1),X=y("create"),B=y({userId:null,userLabel:"",kpiId:null});function he(s){X.value="create",B.value={userId:s,userLabel:R(s),kpiId:null},P.value=!0}async function xe(){P.value=!1,await F()}function R(s){const t=(T.value||[]).find(c=>c.id===s);return(t==null?void 0:t.name)||`#${s}`}function Z(s){return s.is_demo?{label:"Not created",cls:"bg-gray-100 text-gray-700"}:s.monthly_kpi_form_id?s.finalized_at?{label:"Finalized",cls:"bg-green-100 text-green-700"}:{label:"In progress",cls:"bg-yellow-100 text-yellow-700"}:{label:"Unassigned",cls:"bg-gray-100 text-gray-700"}}return oe(async()=>{var s;o&&(await((s=o.fetchList)==null?void 0:s.call(o,{per_page:100})),U.value=o.items||[]),e.value.user_id&&!e.value.employee_id&&(e.value.employee_id=e.value.user_id),await F()}),M(()=>e.value.employee_id,s=>{e.value.user_id=s||""}),M(()=>[e.value.period,e.value.start_month,e.value.end_month],()=>{e.value.period==="range"&&e.value.end_month<e.value.start_month&&(e.value.end_month=e.value.start_month)}),(s,t)=>{const c=Fe("RouterLink");return i(),u("div",Re,[a("div",He,[t[19]||(t[19]=a("h1",{class:"title-md md:title-lg"},"User Monthly KPI Evaluations",-1)),a("div",Qe,[C(c,{to:{name:"MonthlyKpiFormList"},class:"btn-2"},{default:ae(()=>t[18]||(t[18]=[L("Forms")])),_:1,__:[18]})])]),a("div",Ge,[a("div",Je,[a("div",We,[t[20]||(t[20]=a("label",{class:"mb-1 block text-sm font-medium text-slate-700"},"Employee",-1)),C(re,{company_id:e.value.company_id,"onUpdate:company_id":t[0]||(t[0]=n=>e.value.company_id=n),department_id:e.value.department_id,"onUpdate:department_id":t[1]||(t[1]=n=>e.value.department_id=n),employee_id:e.value.employee_id,"onUpdate:employee_id":t[2]||(t[2]=n=>e.value.employee_id=n),line_type:e.value.line_type,"onUpdate:line_type":t[3]||(t[3]=n=>e.value.line_type=n),"with-type":!0,"initial-value":{...s.$route.query},onFilterChange:ve,class:"w-full"},null,8,["company_id","department_id","employee_id","line_type","initial-value"])]),a("div",Xe,[t[21]||(t[21]=a("label",{class:"mb-1 block text-sm font-medium text-slate-700"},"Status",-1)),a("div",Ze,[a("button",{type:"button",class:V(["px-3 py-1.5 text-xs rounded-md transition",e.value.finalized===""?"bg-white shadow border border-slate-200 text-slate-900":"text-slate-600 hover:bg-slate-200/60"]),onClick:t[4]||(t[4]=n=>e.value.finalized="")},"All",2),a("button",{type:"button",class:V(["px-3 py-1.5 text-xs rounded-md transition",e.value.finalized==="0"?"bg-white shadow border border-slate-200 text-slate-900":"text-slate-600 hover:bg-slate-200/60"]),onClick:t[5]||(t[5]=n=>e.value.finalized="0")},"In progress",2),a("button",{type:"button",class:V(["px-3 py-1.5 text-xs rounded-md transition",e.value.finalized==="1"?"bg-white shadow border border-slate-200 text-slate-900":"text-slate-600 hover:bg-slate-200/60"]),onClick:t[6]||(t[6]=n=>e.value.finalized="1")},"Finalized",2)])]),a("div",et,[t[22]||(t[22]=a("label",{class:"mb-1 block text-sm font-medium text-slate-700"},"Period",-1)),a("div",tt,[a("button",{type:"button",class:V(["px-3 py-1.5 text-xs rounded-md transition",e.value.period==="month"?"bg-white shadow border border-slate-200 text-slate-900":"text-slate-600 hover:bg-slate-200/60"]),onClick:t[7]||(t[7]=n=>e.value.period="month")},"Single month",2),a("button",{type:"button",class:V(["px-3 py-1.5 text-xs rounded-md transition",e.value.period==="range"?"bg-white shadow border border-slate-200 text-slate-900":"text-slate-600 hover:bg-slate-200/60"]),onClick:t[8]||(t[8]=n=>e.value.period="range")},"Month range",2)]),a("div",at,[a("button",{type:"button",class:"rounded-md border border-slate-300 px-2.5 py-1 text-xs text-slate-700 hover:bg-slate-50",onClick:t[9]||(t[9]=n=>{e.value.period="month",e.value.month=$(new Date)})},"This month"),a("button",{type:"button",class:"rounded-md border border-slate-300 px-2.5 py-1 text-xs text-slate-700 hover:bg-slate-50",onClick:t[10]||(t[10]=n=>{(()=>{const _=new Date;_.setMonth(_.getMonth()-1),e.value.period="month",e.value.month=$(_)})()})},"Last month"),a("button",{type:"button",class:"rounded-md border border-slate-300 px-2.5 py-1 text-xs text-slate-700 hover:bg-slate-50",onClick:t[11]||(t[11]=n=>{(()=>{const _=new Date;_.setMonth(_.getMonth()-3),e.value.period="range",e.value.start_month=$(_),e.value.end_month=$(new Date)})()})},"Last 3 months")]),a("div",st,[e.value.period==="month"?(i(),u("div",nt,[C(H,{modelValue:Q.value,"onUpdate:modelValue":t[12]||(t[12]=n=>Q.value=n),"show-year":!1,"show-month":!0,"show-date":!1,class:"h-9",label:"Month"},null,8,["modelValue"])])):(i(),u("div",lt,[C(H,{modelValue:G.value,"onUpdate:modelValue":t[13]||(t[13]=n=>G.value=n),"show-year":!1,"show-month":!0,"show-date":!1,class:"h-9",label:"Start"},null,8,["modelValue"]),C(H,{modelValue:J.value,"onUpdate:modelValue":t[14]||(t[14]=n=>J.value=n),"show-year":!1,"show-month":!0,"show-date":!1,class:"h-9",label:"End"},null,8,["modelValue"])]))])]),a("div",ot,[a("button",{class:"h-9 rounded-md border border-slate-300 px-3 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-50",disabled:K.value||!me.value,onClick:ye},"Reset",8,dt),a("button",{class:"h-9 rounded-md bg-indigo-600 px-3 text-sm font-medium text-white hover:bg-indigo-700 disabled:opacity-50",disabled:K.value||!N.value,onClick:ce},"Search",8,it)])])]),K.value?(i(),u("div",rt,[C(ke)])):h(D)||h(k)?(i(),u("div",ut,m(h(D)||h(k)),1)):(i(),u("div",pt,[a("table",mt,[t[24]||(t[24]=a("thead",null,[a("tr",{class:"bg-gray-100 text-left text-gray-700"},[a("th",{class:"px-3 py-2 w-12"},"#"),a("th",{class:"px-3 py-2"},"User"),a("th",{class:"px-3 py-2"},"Period"),a("th",{class:"px-3 py-2"},"Total"),a("th",{class:"px-3 py-2"},"Status"),a("th",{class:"px-3 py-2 text-right w-40"},"Actions")])],-1)),a("tbody",null,[(i(!0),u(de,null,ie(h(f),(n,_)=>(i(),u("tr",{key:`${n.user_id}-${n.id??"demo"}`,class:"border-t"},[a("td",_t,m((p.value.current_page-1)*p.value.per_page+(_+1)),1),a("td",vt,m(R(n.user_id)),1),a("td",ct,[n.month_start||n.month_end?(i(),u("span",yt,m(n.month_start)+" → "+m(n.month_end),1)):(i(),u("span",gt,"—"))]),a("td",ft,[n.is_demo?(i(),u("span",ht,"—")):(i(),u("span",bt,m(n.obtained_total)+" / "+m(n.max_total),1))]),a("td",xt,[a("span",{class:V(["inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium",Z(n).cls])},m(Z(n).label),3)]),a("td",kt,[a("div",wt,[n.is_demo?(i(),u("button",{key:0,class:"btn-3",onClick:b=>he(n.user_id)},"Create",8,$t)):n.monthly_kpi_form_id?(i(),Le(c,{key:2,to:{name:"EvaluationShow",params:{id:n.id}},class:"btn-2"},{default:ae(()=>t[23]||(t[23]=[L(" Open ")])),_:2,__:[23]},1032,["to"])):(i(),u("button",{key:1,class:"btn-2",onClick:b=>be(n)},"Assign",8,Ct))])])]))),128)),!h(f)||h(f).length===0?(i(),u("tr",St,[a("td",qt,m(N.value?"No users found for this scope.":"Select company & department to see users."),1)])):j("",!0)])]),p.value.last_page>1?(i(),u("div",Ft,[a("div",Lt,[t[25]||(t[25]=L(" Showing ")),a("span",Vt,m((p.value.current_page-1)*p.value.per_page+(h(f).length?1:0)),1),t[26]||(t[26]=L(" to ")),a("span",Ut,m((p.value.current_page-1)*p.value.per_page+h(f).length),1),t[27]||(t[27]=L(" of ")),a("span",Nt,m(p.value.total),1),t[28]||(t[28]=L(" results "))]),a("div",Mt,[a("button",{class:"btn-3",disabled:p.value.current_page===1,onClick:t[15]||(t[15]=n=>W(p.value.current_page-1))},"Prev",8,zt),a("span",It,"Page "+m(p.value.current_page)+" / "+m(p.value.last_page),1),a("button",{class:"btn-3",disabled:p.value.current_page===p.value.last_page,onClick:t[16]||(t[16]=n=>W(p.value.current_page+1))},"Next",8,Dt)])])):j("",!0)])),C(Ke,{modelValue:P.value,"onUpdate:modelValue":t[17]||(t[17]=n=>P.value=n),mode:X.value,"user-id":B.value.userId||"","user-label":B.value.userLabel||"","kpi-id":B.value.kpiId||null,onCreated:xe},null,8,["modelValue","mode","user-id","user-label","kpi-id"])])}}};export{Jt as default};
