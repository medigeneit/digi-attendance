import{G as dt,r as P,e as ut,H as gt,A as pt,c as u,o as a,f as b,a as t,t as g,I as O,n as C,d as ct,q as U,F as L,h as d,w as I,l as v,p as w,E as B,m as S,x as E,J as bt,K as rt,g as vt,v as xt,b as _t,u as ht,k as lt,y as N}from"./index-DLIEvkXB.js";import{L as it}from"./LoaderView-DB3ok1lC.js";import{O as M}from"./OverlyModal-BoB7W57e.js";import{a as Tt}from"./TaskAddForm-BmZaL87D.js";import{_ as $t}from"./TaskEditForm-Bb-pwyV5.js";import{_ as wt,a as Ct,b as St,c as It}from"./TaskTreeView-CLXZiMq_.js";import{a as Dt,_ as Ut}from"./TaskUserAssignForm-IC8dGvNc.js";import{u as Pt}from"./task-priority-DBXVdtrO.js";import{g as F}from"./datetime-q3Sn87-f.js";import{_ as R}from"./UserChip-C7Naoevw.js";import{u as Lt}from"./useTaskStore-vgLwPrU8.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./RequiredIcon-BvFHHljf.js";import"./company-Dx_xUIMC.js";import"./useRequirementStore-T8U0XYRt.js";import"./SectionLoading-Dghuq6jA.js";import"./TaskUrgencyInput-BGO5qxTk.js";import"./MultiselectDropdown-BiycMUQK.js";const At={key:0},Et={key:0},Mt={key:1},Ot=dt({__name:"CountdownTimer",props:{targetDateTime:{}},setup(c){const e=c,s=P(k());let o;function k(){const p=new Date(e.targetDateTime).getTime()-new Date().getTime(),f=Math.floor(p/1e3%60),i=Math.floor(p/1e3/60%60),r=Math.floor(p/(1e3*60*60)%24),m=Math.floor(p/(1e3*60*60*24));return{total:p,days:m,hours:r,minutes:i,seconds:f}}function l(){s.value=k()}return ut(()=>{o=setInterval(()=>{l(),s.value.total<=0&&clearInterval(o)},1e3)}),gt(()=>clearInterval(o)),pt(()=>e.targetDateTime,()=>{l(),clearInterval(o)}),(p,f)=>s.value.total>0?(a(),u("div",At,[s.value.days?(a(),u("span",Et,g(s.value.days)+"d ",1)):b("",!0),t("span",null,g(s.value.hours.toString().padStart(2,"0"))+"h :",1),t("span",null,g(s.value.minutes.toString().padStart(2,"0"))+"m :",1),t("span",null,g(s.value.seconds.toString().padStart(2,"0"))+"s",1)])):(a(),u("div",Mt,[O(p.$slots,"expired",{},()=>[f[0]||(f[0]=C("Timeâ€™s up!"))])]))}}),Ft={class:"mb-3"},Nt={key:0,class:"flex gap-2 items-center mx-auto justify-center mb-2"},Bt={key:1,class:"text-center py-4 text-gray-500"},Rt={key:2,class:"text-center py-4 text-red-500"},jt={key:3,class:"space-y-4"},qt={__name:"TaskList",props:{tasks:{default:null,type:Array},loading:{default:!1,type:Boolean},error:{default:"",type:String},parentId:{type:Number,default:0},treeLevel:{type:Number,required:!0}},emits:["commentButtonClick","editClick","addClick","updatePriority"],setup(c,{emit:e}){const s=c,o=ct(),k=U(()=>{var h;return!!(((h=o==null?void 0:o.user)==null?void 0:h.role)!=="employee"&&(o!=null&&o.isAdminMood))}),l=e,p=P(null),{handleItemsPriorityUpdate:f,saveTaskPriority:i,listHasRearranged:r}=Pt(()=>s.tasks,s.parentId),m=async()=>{await i(),l("updatePriority")};return(h,x)=>(a(),u("div",null,[t("div",Ft,[O(h.$slots,"task:header")]),k.value?(a(),u(L,{key:0},[d(r)?(a(),u("div",Nt,[x[4]||(x[4]=t("span",{class:"text-red-500"},"Priority Changed",-1)),t("button",{class:"btn-3",onClick:I(m,["prevent"])},"Save"),t("button",{class:"btn-3",onClick:x[0]||(x[0]=I((...y)=>p.value.resetItems&&p.value.resetItems(...y),["prevent"]))},"Discard")])):b("",!0)],64)):b("",!0),c.loading?(a(),u("div",Bt,"Loading tasks...")):c.error?(a(),u("div",Rt,g(c.error),1)):(a(),u("div",jt,[v(Dt,{items:c.tasks,handle:"handle",onItemsUpdate:d(f),class:"rounded-lg bg-white overflow-hidden space-y-3",ref_key:"draggableTaskList",ref:p},{item:w(({item:y,index:$})=>[v(wt,{index:$,task:y,showDraggableHandle:k.value,"tree-level":c.treeLevel,class:"!border-0",onCommentButtonClick:D=>l("commentButtonClick",y.id),onEditClick:x[1]||(x[1]=D=>l("editClick",D)),onAddClick:x[2]||(x[2]=D=>l("addClick",D)),onEmployeeAssignClick:x[3]||(x[3]=D=>l("employeeAssignClick",D))},null,8,["index","task","showDraggableHandle","tree-level","onCommentButtonClick"])]),_:1},8,["items","onItemsUpdate"])]))]))}},Ht={class:"flex justify-between mt-5"},Vt={class:"flex flex-wrap items-center gap-2 mt-3"},zt={__name:"SubTaskList",props:{subTasks:Array,parentId:{type:Number,required:!0},treeLevel:{type:Number,required:!0}},emits:["created","error","updatePriority","assignUser"],setup(c,{emit:e}){const s=c,o=B({taskId:0,isOpen:!1}),k=e,l=P(),p=B({show:!1,parentId:s.parentId,requirementId:null}),f=x=>{p.show=!0,p.parentId=x,console.log({addForm:p})};function i(){p.show=!1,p.parentId=s.parentId,k("created")}function r(){k("assignUser")}function m(){l.value=!1,k("updated")}function h(){p.show=!1,p.parentId=s.parentId}return(x,y)=>(a(),u("div",null,[l.value?(a(),S(M,{key:0},{default:w(()=>[v($t,{taskId:l.value,onClose:y[0]||(y[0]=$=>l.value=null),onUpdated:m},null,8,["taskId"])]),_:1})):b("",!0),p.show?(a(),S(M,{key:1},{default:w(()=>[v(Tt,{parentTaskId:p.parentId,requirementId:p.requirementId,onTaskCreated:i,onError:x.handleTaskError,onClose:h},null,8,["parentTaskId","requirementId","onError"])]),_:1})):b("",!0),o.isOpen?(a(),S(M,{key:2},{default:w(()=>[v(Ut,{taskId:o.taskId,onCancelClick:y[1]||(y[1]=()=>{o.isOpen=!1,o.taskId=0}),onSuccess:y[2]||(y[2]=()=>{o.isOpen=!1,o.taskId=0,r()})},null,8,["taskId"])]),_:1})):b("",!0),v(qt,{tasks:c.subTasks,parentId:c.parentId,treeLevel:c.treeLevel,onAddClick:y[4]||(y[4]=$=>f($)),onEditClick:y[5]||(y[5]=$=>l.value=$),onUpdatePriority:y[6]||(y[6]=$=>k("updatePriority")),onEmployeeAssignClick:y[7]||(y[7]=$=>{o.taskId=$,o.isOpen=!0})},{"task:header":w(()=>[t("div",Ht,[y[8]||(y[8]=t("div",{class:"flex justify-between items-center"},[t("h2",{class:"text-2xl font-bold text-gray-800"},"Sub Tasks")],-1)),t("div",Vt,[t("button",{class:"btn-1 ml-auto",onClick:y[3]||(y[3]=I(()=>f(c.parentId),["prevent"]))}," Add Sub Task ")])])]),_:1},8,["tasks","parentId","treeLevel"])]))}},Gt=c=>c==null?void 0:c.reduce((e,s)=>e+s.task_weight,0),kt=(c,e)=>{const s=Gt(c);return c.map(o=>{const k=e.filter(l=>l.user_id===o.id).reduce((l,p)=>l+p.progress,0);return{...o,task_progress:Math.floor(k*(o.task_weight/s)),user_progress:k}})},Wt=(c,e)=>{let s=0;const o=[],k=f=>f.status==="COMPLETED",l=f=>f.users.some(i=>i.id===e),p=(f,i)=>{f.forEach(r=>{const m=l(r);o[i]=o[i]||{user_id:e,total_assigned:0,total_assigned_on_leaf_task:0,completed_count:0};const h=m&&r.children_tasks.length===0;o[i].total_assigned+=m?1:0,o[i].total_assigned_on_leaf_task+=h?1:0,s+=h?1:0,m&&k(r)&&(o[i].completed_count++,r.children_tasks.length),r.children_tasks.length>0&&p(r.children_tasks,i+1)})};return p(c,0),{sub_task_infos:o,assigned_on_any_leaf_task:s>0}},Jt=(c,e)=>c.map(s=>({...s,...Wt(e,s.id)})),Kt={key:0,class:"min-w-full bg-white rounded overflow-hidden"},Qt={class:"py-0.5 text-bg font-semibold"},Xt={class:"bg-gray-50"},Yt={class:"px-2 py-1 border-y"},Zt={class:"px-2 py-1 border-y"},te={key:0,class:"text-sm text-gray-400"},ee={key:1},se={key:1,class:"min-w-full bg-white rounded overflow-hidden"},ae={class:"py-0.5 text-bg font-semibold"},ne={class:"px-2 py-1 border-y text-center"},oe={class:"px-2 py-1 border-y border-r"},re={class:"px-2 py-1 border-y text-center"},le={class:"px-2 py-1 border-y text-center"},ie=dt({__name:"TaskProgressTable",props:{task:{},subTasks:{}},setup(c){const e=c,s=U(()=>kt(e.task.users,e.task.task_reports||[])),o=U(()=>Jt(e.task.users,e.subTasks));return(k,l)=>{var p,f;return e.task.children_task_count>0?(a(),u("table",Kt,[t("caption",Qt,[O(k.$slots,"caption",{},()=>[l[0]||(l[0]=C("Progress"))])]),t("thead",Xt,[t("tr",null,[l[1]||(l[1]=t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-left"},"#",-1)),l[2]||(l[2]=t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-left lg:w-[200px]"}," User ",-1)),(a(!0),u(L,null,E(((f=(p=o.value[0]||{})==null?void 0:p.sub_task_infos)==null?void 0:f.length)||1,i=>(a(),u("th",{key:i,class:"px-2 py-1 border-y font-semibold text-xs uppercase text-center"},g(i===1?"Completed Sub Task":"")+" "+g(i===2?"Completed Sub Sub Task":"")+" "+g(i===3?"Completed Sub Sub Sub Task":""),1))),128))])]),t("tbody",null,[(a(!0),u(L,null,E(o.value,(i,r)=>(a(),u("tr",{key:i.id,class:"border-t hover:bg-gray-50 cursor-pointer"},[t("td",Yt,g(r+1),1),t("td",Zt,[v(R,{user:i},null,8,["user"])]),(a(!0),u(L,null,E(i.sub_task_infos,(m,h)=>(a(),u("td",{class:"px-2 py-1 border-y text-center",key:h},[m.total_assigned===0||!i.assigned_on_any_leaf_task?(a(),u("div",te," Not Assigned To Any Task ")):(a(),u("div",ee,g(m.completed_count)+" / "+g(m.total_assigned),1))]))),128))]))),128))])])):(a(),u("table",se,[t("caption",ae,[O(k.$slots,"caption",{},()=>[l[3]||(l[3]=C("Progress"))])]),l[4]||(l[4]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase w-[50px] text-center"},"#"),t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-left sm:w-[250px] mx:w-[300px] border-r"}," User "),t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-center"},"Started"),t("th",{class:"px-2 py-1 border-y font-semibold text-xs uppercase text-center"},"Finished")])],-1)),t("tbody",null,[(a(!0),u(L,null,E(s.value,(i,r)=>(a(),u("tr",{key:i.id,class:"border-t hover:bg-gray-50 cursor-pointer"},[t("td",ne,g(r+1),1),t("td",oe,[v(R,{user:i},null,8,["user"])]),t("td",re,g(d(F)(i.task_started_at)),1),t("td",le,g(d(F)(i.task_finished_at)),1)]))),128))])]))}}}),de=bt("task-user",()=>({updateUserStartDate:async(s,o,k)=>await rt.patch(`/task-user/task/${s}/user/${o}/update-start-date/${k}`),updateUserFinishDate:async(s,o,k)=>await rt.patch(`/task-user/task/${s}/user/${o}/update-finish-date/${k}`)})),ue={class:"border-b text-center"},pe={key:0},ce={key:1},ke={class:"mb-2 mt-6"},me={class:"flex justify-center"},ye={class:"py-6"},fe={class:"mt-2"},ge={key:0,class:"inline-block text-sm text-orange-700 text-center w-full"},be={class:"flex justify-between items-center"},ve={__name:"TaskUserDateUpdate",props:{task:{type:Object},user:{user:Object},type:{type:String}},emits:["closeClick","updateDate"],setup(c,{emit:e}){const s=c,o=e,k=de(),l=P(""),p=P("");async function f(){var i,r;console.log({date:l.value});try{s.type=="start-date"?await k.updateUserStartDate(s.task.id,s.user.id,l.value||"0"):s.type=="finish-date"&&await k.updateUserFinishDate(s.task.id,s.user.id,l.value||"0"),o("updateDate")}catch(m){p.value=((r=(i=m.response)==null?void 0:i.data)==null?void 0:r.message)||`Failed to update ${s.type}`}}return(i,r)=>(a(),u("form",{class:"p-4",onSubmit:I(f,["prevent"])},[t("div",ue,[c.type=="start-date"?(a(),u("h2",pe,"Edit Start Date")):c.type=="finish-date"?(a(),u("h2",ce,"Edit Finish Date")):b("",!0)]),t("div",ke,[r[2]||(r[2]=t("div",{class:"text-xs uppercase text-gray-500 font-semibold"},"Task:",-1)),t("div",null,g(c.task.title),1)]),t("div",null,[r[3]||(r[3]=t("div",{class:"text-xs uppercase text-gray-500 font-semibold"},"User:",-1)),v(R,{user:c.user},null,8,["user"])]),t("div",me,[t("div",ye,[r[4]||(r[4]=t("label",{class:"block text-xs font-semibold"},"Date",-1)),vt(t("input",{type:"date","onUpdate:modelValue":r[0]||(r[0]=m=>l.value=m),class:"border py-2 px-4 rounded-md",size:"8"},null,512),[[xt,l.value]])])]),t("div",fe,[p.value?(a(),u("div",ge,g(p.value),1)):b("",!0)]),t("div",be,[r[5]||(r[5]=t("div",null,[t("button",{class:"btn-2"},"Submit")],-1)),t("button",{class:"btn-3",onClick:r[1]||(r[1]=I(m=>o("closeClick"),["prevent"]))},"Close")])],32))}},xe={class:"container mx-auto p-6"},_e={key:2,class:"max-w-8xl min-h-64 mx-auto bg-white shadow-lg rounded-lg p-6 relative"},he={class:"grid grid-cols-4"},Te={class:"mb-4 flex col-span-full"},$e={class:"font-medium text-xl"},we={class:"flex items-center gap-2 text-xs text-gray-500 mt-2 opacity-80 text-left"},Ce={key:0,class:"text-xs px-2 py-0.5 rounded-full border bg-yellow-800 text-white"},Se={key:1,class:"text-xs px-2 py-0.5 rounded-full border bg-red-500 text-white"},Ie={class:"text-right col-span-full md:col-span-1 ml-auto flex items-start justify-center gap-4 !text-lg"},De={class:"col-span-full"},Ue=["innerHTML"],Pe={class:"mt-4 col-span-full mb-6"},Le={class:"ml-auto text-right text-sm col-span-full"},Ae={key:1,class:"text-gray-500"},Ee={class:"font-semibold text-green-800"},Me={key:2,class:"ml-4 text-gray-500"},Oe={class:"text-red-500 font-semibold"},Fe={class:"py-2 flex justify-center items-center gap-2 col-span-full"},Ne={class:"ml-auto flex gap-4"},Be=["disabled"],Re=["disabled"],je={key:0},qe={key:1},He={key:1,class:"text-center py-4 text-red-500"},is={__name:"TaskShow",setup(c){const e=Lt(),s=_t(),o=ht(),k=P(""),l=ct(),p=U(()=>e.tasks),f=P({}),i=P(!0);ut(async()=>{k.value="loading",await m(s.params.id),k.value=""});const r=B({user:null,type:""});async function m(T){await e.fetchTask(T)}const h=U(()=>kt(e.task.users,e.task.task_reports||[])),x=U(()=>F(e.task.started_at)),y=U(()=>F(e.task.deadline));function $(T){r.user=l.user,r.type=T}async function D(){await m(s.params.id),r.user=null,r.type=""}const mt=T=>{o.push({name:"TaskEdit",params:{id:T}})},yt=U(()=>{var T,n;return e.task?((T=e.task)==null?void 0:T.parent_id)==0?{name:"TaskList"}:{name:"TaskShow",params:{id:(n=e.task)==null?void 0:n.parent_id}}:null});return pt(()=>s.params.id,async T=>{k.value="changing",await m(T),k.value=""}),(T,n)=>{var j,q,H,V,z,G,W,J,K,Q,X,Y,Z,tt,et,st,at,nt;const A=lt("RouterLink"),ft=lt("router-view");return a(),u("div",xe,[r.user?(a(),S(M,{key:0},{default:w(()=>[v(ve,{task:d(e).task,user:r.user,type:r.type,onCloseClick:n[0]||(n[0]=_=>r.user=null),onUpdateDate:D},null,8,["task","user","type"])]),_:1})):b("",!0),k.value==="loading"?(a(),S(it,{key:1})):(a(),u("div",_e,[d(e).task?(a(),u(L,{key:0},[t("section",he,[t("div",Te,[t("div",null,[t("h2",$e,g(d(e).task.title),1),t("div",we,[(j=d(e).task)!=null&&j.is_important?(a(),u("span",Ce,"IMPORTANT")):b("",!0),(q=d(e).task)!=null&&q.is_urgent?(a(),u("span",Se,"URGENT")):b("",!0)])]),t("div",Ie,[v(Ct,{status:(H=d(e).task)==null?void 0:H.status,progressPercent:(V=d(e).task)==null?void 0:V.progress_percent,class:"h-6 !text-lg"},null,8,["status","progressPercent"]),d(e).task?(a(),S(St,{key:0,task:d(e).task,ref_key:"progress",ref:f,class:"!text-lg"},null,8,["task"])):b("",!0)])]),t("div",De,[t("p",{innerHTML:(z=d(e).task)==null?void 0:z.description,class:N(["text-gray-700",{"line-clamp-3":i.value}])},null,10,Ue),((W=(G=d(e).task)==null?void 0:G.description)==null?void 0:W.length)>=600?(a(),u("button",{key:0,class:"text-blue-500 mt-2",onClick:n[1]||(n[1]=I(_=>i.value=!i.value,["prevent"]))}," Show "+g(i.value?"More":"Less"),1)):b("",!0)]),v(It,{task:(J=d(e))==null?void 0:J.task,"tree-level":(Q=(K=d(e))==null?void 0:K.task)==null?void 0:Q.level},null,8,["task","tree-level"]),t("section",Pe,[v(ie,{"task-users":((X=d(e).task)==null?void 0:X.users)||[],task:d(e).task,"sub-tasks":d(e).tasks,"progress-users":h.value},{caption:w(()=>n[13]||(n[13]=[t("div",{class:"text-sm py-1 text-left uppercase font-semibold text-gray-600"}," Assigned Users ",-1)])),_:1},8,["task-users","task","sub-tasks","progress-users"])]),t("div",Le,[d(e).task.deadline?(a(),S(Ot,{key:0,targetDateTime:d(e).task.deadline,class:"text-lg font-semibold italic text-green-600"},null,8,["targetDateTime"])):b("",!0),x.value?(a(),u("span",Ae,[n[14]||(n[14]=C(" Started: ")),t("span",Ee,g(x.value),1)])):b("",!0),y.value?(a(),u("span",Me,[n[15]||(n[15]=C(" Deadline: ")),t("span",Oe,g(y.value),1)])):b("",!0)]),n[20]||(n[20]=t("hr",{class:"my-3 col-span-full"},null,-1)),t("div",Fe,[t("button",{onClick:n[2]||(n[2]=I(_=>{var ot;return mt((ot=d(e).task)==null?void 0:ot.id)},["stop"])),class:"btn-2 py-0.5"},"Edit"),v(A,{to:{name:"TaskUserAssign",params:{id:(Y=d(e).task)==null?void 0:Y.id}},class:"bg-indigo-500 hover:bg-indigo-600 text-white font-semibold px-3 py-0.5 rounded-full transition",onClick:n[3]||(n[3]=_=>_.stopPropagation())},{default:w(()=>n[16]||(n[16]=[t("i",{class:"fas fa-user-plus"},null,-1),C(" Assign Users ")])),_:1,__:[16]},8,["to"]),v(A,{to:yt.value,class:"bg-indigo-500 hover:bg-indigo-600 text-white font-semibold px-3 py-0.5 rounded-full transition",onClick:n[4]||(n[4]=_=>_.stopPropagation())},{default:w(()=>n[17]||(n[17]=[t("i",{class:"fas fa-arrow-left"},null,-1),C(" Back ")])),_:1,__:[17]},8,["to"]),t("div",Ne,[((Z=d(e).task)==null?void 0:Z.children_task_count)===0?(a(),u(L,{key:0},[t("button",{class:"btn-3 px-3 py-0.5 text-sm h-8 font-semibold border disabled:opacity-30 disabled:pointer-events-none",onClick:n[5]||(n[5]=I(()=>$("start-date"),["prevent"])),disabled:!!((tt=T.authUserProgress)!=null&&tt.started_at)}," Set Started Date ",8,Be),t("button",{class:"btn-3 px-3 py-0.5 text-sm h-8 font-semibold border disabled:opacity-30 disabled:pointer-events-none",onClick:n[6]||(n[6]=I(()=>$("finish-date"),["prevent"])),disabled:!!((et=T.authUserProgress)!=null&&et.finished_at)}," Set Finish Date ",8,Re)],64)):b("",!0),p.value.length>0?(a(),S(A,{key:1,to:{name:"TaskShow",params:{id:(st=d(e).task)==null?void 0:st.id}},onClick:n[7]||(n[7]=_=>_.stopPropagation()),class:N(["py-0.5 btn-3 ml-auto text-sm h-8",{"bg-blue-500 text-white":d(s).name=="TaskShow"}])},{default:w(()=>n[18]||(n[18]=[t("i",{class:"fal fa-list-ul"},null,-1),C(" Sub Tasks ")])),_:1,__:[18]},8,["to","class"])):b("",!0),v(A,{to:{name:"TaskReports",params:{id:(at=d(e).task)==null?void 0:at.id}},onClick:n[8]||(n[8]=_=>_.stopPropagation()),class:N(["py-0.5 btn-3 text-sm h-8",{"bg-blue-500 text-white":d(s).name=="TaskReports"}])},{default:w(()=>n[19]||(n[19]=[t("i",{class:"fal fa-file-alt"},null,-1),C(" Reports ")])),_:1,__:[19]},8,["to","class"])])])]),d(s).name=="TaskShow"&&((nt=d(e).task)==null?void 0:nt.level)<=2?(a(),u("section",je,[v(zt,{subTasks:p.value,"parent-id":d(s).params.id,"tree-level":d(e).task.level+1,onCreated:n[9]||(n[9]=_=>m(d(s).params.id)),onUpdated:n[10]||(n[10]=_=>m(d(s).params.id)),onUpdatePriority:n[11]||(n[11]=_=>m(d(s).params.id)),onAssignUser:n[12]||(n[12]=_=>m(d(s).params.id))},null,8,["subTasks","parent-id","tree-level"])])):(a(),u("section",qe,[v(ft)]))],64)):(a(),u("div",He,g(d(e).error),1)),k.value==="changing"?(a(),S(it,{key:2,class:"absolute bg-opacity-80 inset-0 z-20"})):b("",!0)]))])}}};export{is as default};
