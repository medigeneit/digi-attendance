import{B as ee,r as D,x as G,C as j,ad as te,k as V,H as W,c as u,o as d,F as K,e as F,a as e,t as g,q as B,b as P,s as T,_ as se,G as J,y as Z,d as H,j as R,w as Q,P as ae,l as ne,v as Y,T as re,A as le,g as oe,D as ie,h as de,a8 as ue,m as f,a3 as X,i as ce,n as pe}from"./index-DFLvcHVU.js";const me=ee("clearance",()=>{const A=D(null),y=D(""),U=D([]),m=D([]),c=D([]),o=D(new Map),k=D(new Set),w=D(!1),I=D(!1),h=D(""),O=G(()=>{const p=(c.value??[]).slice().sort((i,t)=>(i.order_no??0)-(t.order_no??0)).map(i=>{var C,S;const t=o.value.get(i.id)||{},s=typeof i.show_receiver<"u"?!!i.show_receiver:i.handover_to!=="departmental_incharge",l=t.receiver_name??((C=i.handover_user)==null?void 0:C.name)??((S=i.handover_user)==null?void 0:S.label)??"";return{id:i.id,template_item_id:i.id,label:i.label||i.item_label||i.item_key,order_no:i.order_no??0,handover_to:i.handover_to??null,show_receiver:s,status:t.status??"PENDING",handover_status:t.handover_status??"NA",present_condition:t.present_condition??"",receiver_name:s?l:"",remarks:t.remarks??""}});return y.value?p.filter(i=>i.status===y.value):p});function N(p,i=!0){i?k.value.add(p):k.value.delete(p)}function b(){k.value.clear()}const _=async(p=null)=>{var i,t;w.value=!0,h.value=null;try{const s=await j.get("/departments",{params:{company_id:p}});U.value=s.data}catch(s){h.value=((t=(i=s.response)==null?void 0:i.data)==null?void 0:t.message)||"ডিপার্টমেন্ট লোড করতে ব্যর্থ হয়েছে।",console.error("Error fetching departments:",s)}finally{w.value=!1}};async function n(p){var i;h.value="";try{const t=await j.get("/without-permission-users",{params:{department_id:p,per_page:1e3}});m.value=((i=t.data)==null?void 0:i.data)||t.data||[]}catch(t){h.value="Failed to load users",console.error(t)}}async function v(){var p;c.value=[],h.value="";try{const i=await j.get("/department-clearance-items"),t=((p=i.data)==null?void 0:p.data)||i.data||[];c.value=t}catch(i){h.value="Failed to load assigned items",console.error(i)}}async function M(p,i,t){var s;o.value=new Map,h.value="";try{const l=await j.get("/clearances",{params:{user_id:p,department_id:i,template_id:t,per_page:1e3}}),C=((s=l.data)==null?void 0:s.data)||l.data||[];for(const S of C)o.value.set(S.template_item_id,S)}catch(l){h.value="Failed to load clearances",console.error(l)}}async function z(p,i){if(!(!p||!i)){w.value=!0,h.value="";try{await v(p,i),A.value&&await M(A.value,p,i)}catch(t){h.value="Failed to refresh data",console.error(t)}finally{w.value=!1}}}async function L(p,i){if(!A.value)return;const t=O.value.filter(s=>k.value.has(s.template_item_id)).map(s=>({template_item_id:s.template_item_id,status:s.status,handover_status:s.handover_status,present_condition:(typeof s.present_condition=="string"?s.present_condition.trim():"")||null,receiver_name:(typeof s.receiver_name=="string"?s.receiver_name.trim():"")||null,remarks:(typeof s.remarks=="string"?s.remarks.trim():"")||null}));if(t.length!==0){I.value=!0,h.value="";try{await j.post("/clearances/bulk-upsert",{user_id:A.value,department_id:p,items:t}),b(),await M(A.value,p,i)}catch(s){h.value="Failed to save",console.error(s)}finally{I.value=!1}}}return{userId:A,departments:U,statusFilter:y,users:m,assignedItems:c,clearanceByItemId:o,itemsForTable:O,dirty:k,loading:w,saving:I,error:h,loadUsersByDept:n,fetchDepartments:_,loadAssignedItems:v,loadClearances:M,refreshAll:z,saveBulk:L,markDirty:N}}),ve=["value"],ge={__name:"HandoverSelect",props:{modelValue:{type:String,default:"NA"},modelModifiers:{}},emits:["update:modelValue"],setup(A){const y=te(A,"modelValue"),U=[{v:"YES",t:"Yes"},{v:"NO",t:"No"},{v:"NA",t:"N/A"}];return(m,c)=>V((d(),u("select",{"onUpdate:modelValue":c[0]||(c[0]=o=>y.value=o),class:"input-1"},[(d(),u(K,null,F(U,o=>e("option",{key:o.v,value:o.v},g(o.t),9,ve)),64))],512)),[[W,y.value]])}},be=["aria-disabled"],fe=["aria-checked","onClick"],ye="inline-flex items-center gap-1 rounded-md border px-2.5 py-1.5 text-xs font-medium transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-500/40 select-none",_e=Object.assign({name:"StatusSegment"},{__name:"StatusSegment",props:{modelValue:{type:String,default:""},disabled:{type:Boolean,default:!1}},emits:["update:modelValue","change"],setup(A,{emit:y}){const U=A,m=y,c=b=>(b??"").toString().trim().toUpperCase(),o=D(c(U.modelValue));B(()=>U.modelValue,b=>{const _=c(b);_!==o.value&&(o.value=_)});const k=[{value:"PENDING",label:"Pending"},{value:"WORKING",label:"Working"},{value:"COMPLETED",label:"Completed"}],w=b=>o.value===b;function I(b){if(U.disabled)return;const _=c(b);o.value=_,m("update:modelValue",_),m("change",_)}function h(b){if(U.disabled)return;const _=Math.max(0,k.findIndex(n=>n.value===o.value));["ArrowRight","ArrowDown"].includes(b.key)?(b.preventDefault(),I(k[(_+1)%k.length].value)):["ArrowLeft","ArrowUp"].includes(b.key)&&(b.preventDefault(),I(k[(_-1+k.length)%k.length].value))}function O(b){const n=w(b)?{PENDING:"bg-amber-600 text-white border-amber-600",WORKING:"bg-sky-600 text-white border-sky-600",COMPLETED:"bg-emerald-600 text-white border-emerald-600"}[b]||"bg-gray-800 text-white border-gray-800":"bg-white text-gray-700 border-gray-300 hover:bg-gray-50",v=U.disabled?"opacity-60 cursor-not-allowed":"cursor-pointer";return`${ye} ${n} ${v}`}const N=G(()=>`inline-flex items-center gap-1 bg-white rounded-lg p-1 border ${U.disabled?"opacity-75":""}`);return(b,_)=>(d(),u("div",{class:T(N.value),role:"radiogroup","aria-disabled":A.disabled?"true":"false",onKeydown:h},[(d(),u(K,null,F(k,n=>e("button",{key:n.value,type:"button",class:T(O(n.value)),"aria-checked":w(n.value)?"true":"false",role:"radio",onClick:v=>I(n.value)},[e("span",{class:T(["h-1.5 w-1.5 rounded-full",{"bg-amber-200":n.value==="PENDING"&&!w(n.value),"bg-sky-200":n.value==="WORKING"&&!w(n.value),"bg-emerald-200":n.value==="COMPLETED"&&!w(n.value),"bg-white":w(n.value)}])},null,2),P(" "+g(n.label),1)],10,fe)),64))],42,be))}}),xe={class:"card overflow-hidden border rounded-xl bg-white shadow-sm"},he={class:"px-4 py-3 border-b bg-white/85 backdrop-blur flex items-center justify-between gap-3"},we={class:"text-sm text-gray-700"},ke={class:"ml-1 font-semibold tabular-nums"},Ne=["disabled"],Ce={class:"w-full text-sm min-w-[1020px]"},$e=["onClick"],Ee={class:"px-3 py-2 align-top text-gray-500 tabular-nums"},Se={class:"px-3 py-2 align-top"},De={class:"font-medium text-gray-900"},Ae={class:"text-[11px] text-gray-500"},Ue={class:"px-3 py-2 align-top"},Ie={class:"font-medium"},Oe={class:"px-3 py-2 align-top"},Re={class:"whitespace-pre-wrap text-gray-900"},Pe={class:"px-3 py-2 align-top"},Me={key:0,class:"whitespace-pre-wrap text-gray-900"},Te={key:1,class:"text-gray-400"},Ve={class:"px-3 py-2 align-top"},Le={class:"whitespace-pre-wrap text-gray-900"},Ge={class:"px-3 py-2 align-top"},Be={class:"font-medium"},ze=["onClick"],je={key:0},Ke={class:"w-full max-w-2xl rounded-2xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-2xl ring-1 ring-black/5"},Fe={class:"px-5 py-4 space-y-4"},We={key:0,class:"text-xs text-rose-600 mt-1"},He=["maxlength"],Ye={key:0,class:"text-xs text-rose-600 mt-1"},qe=["maxlength"],Je={key:0,class:"text-xs text-rose-600 mt-1"},Qe=["maxlength"],Xe={key:0,class:"text-xs text-rose-600 mt-1"},Ze={key:0,class:"text-xs text-rose-600 mt-1"},et={__name:"ClearanceEditorTable",props:{rows:{type:Array,default:()=>[]},maxHeight:{type:String,default:"60vh"},disabled:{type:Boolean,default:!1}},emits:["update:row"],setup(A,{emit:y}){const U=A,m=y,c=D([]),o=t=>(t==null?void 0:t.template_item_id)??(t==null?void 0:t.id),k=(t=[])=>t.map(s=>({...s}));B(()=>U.rows,t=>{c.value=k(t??[])},{immediate:!0});const w={PENDING:{label:"Pending",dot:"bg-amber-500",pill:"bg-amber-50 text-amber-800 border-amber-200"},WORKING:{label:"Working",dot:"bg-sky-500",pill:"bg-sky-50 text-sky-800 border-sky-200"},COMPLETED:{label:"Completed",dot:"bg-emerald-500",pill:"bg-emerald-50 text-emerald-800 border-emerald-200"}},I={YES:{label:"Yes",pill:"bg-emerald-50 text-emerald-700 border-emerald-200"},NO:{label:"No",pill:"bg-rose-50 text-rose-700 border-rose-200"},NA:{label:"N/A",pill:"bg-slate-50 text-slate-700 border-slate-200"}},h=t=>t==="COMPLETED"?"border-l-4 border-emerald-400":t==="WORKING"?"border-l-4 border-sky-400":t==="PENDING"?"border-l-4 border-amber-400":"",O=t=>typeof(t==null?void 0:t.show_receiver)<"u"?!!t.show_receiver:(t==null?void 0:t.handover_to)!=="departmental_incharge",N={present_condition:200,receiver_name:120,remarks:255},b=D(!1),_=D(-1),n=J({handover_status:"NA",present_condition:"",receiver_name:"",remarks:"",status:"PENDING",show_receiver:!0}),v=J({});function M(t,s){_.value=s,n.handover_status=t.handover_status??"NA",n.present_condition=t.present_condition??"",n.receiver_name=t.receiver_name??"",n.remarks=t.remarks??"",n.status=t.status??"PENDING",n.show_receiver=O(t),Object.keys(v).forEach(l=>delete v[l]),b.value=!0,le(()=>{})}function z(){var t,s,l;return Object.keys(v).forEach(C=>delete v[C]),["YES","NO","NA"].includes(n.handover_status)||(v.handover_status="Select YES / NO / NA"),(((t=n.present_condition)==null?void 0:t.length)||0)>N.present_condition&&(v.present_condition=`Max ${N.present_condition} chars`),n.show_receiver&&(((s=n.receiver_name)==null?void 0:s.length)||0)>N.receiver_name&&(v.receiver_name=`Max ${N.receiver_name} chars`),(((l=n.remarks)==null?void 0:l.length)||0)>N.remarks&&(v.remarks=`Max ${N.remarks} chars`),["PENDING","WORKING","COMPLETED"].includes(n.status)||(v.status="Invalid status"),Object.keys(v).length===0}function L(){var S,r,a,$,E,x;if(!z())return;const t=_.value;if(t<0)return;const s=c.value[t],l=Number(o(s)),C={handover_status:n.handover_status,present_condition:((r=(S=n.present_condition)==null?void 0:S.trim)==null?void 0:r.call(S))??n.present_condition,receiver_name:n.show_receiver?(($=(a=n.receiver_name)==null?void 0:a.trim)==null?void 0:$.call(a))??n.receiver_name:"",remarks:((x=(E=n.remarks)==null?void 0:E.trim)==null?void 0:x.call(E))??n.remarks,status:n.status};c.value[t]={...s,...C},m("update:row",l,{id:l,template_item_id:l,...C}),b.value=!1}function p(){b.value=!1}function i(t){b.value&&(t.key==="Escape"&&(t.stopPropagation(),t.preventDefault(),p()),(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="enter"&&(t.preventDefault(),L()))}return typeof window<"u"&&window.addEventListener("keydown",i),Z(()=>window.removeEventListener("keydown",i)),(t,s)=>(d(),u("div",xe,[e("div",he,[e("div",we,[s[7]||(s[7]=e("span",{class:"font-medium"},"Assigned items:",-1)),e("span",ke,g(c.value.length),1)]),e("button",{class:"rounded-md border px-3 py-1.5 text-sm hover:bg-gray-50 disabled:opacity-50",disabled:!c.value.length,onClick:s[0]||(s[0]=l=>M(c.value[0],0)),title:"Add/Update clearance"}," ➕ Add/Update clearance ",8,Ne)]),e("div",{class:"overflow-auto",style:ae({maxHeight:A.maxHeight})},[e("table",Ce,[s[9]||(s[9]=e("thead",{class:"bg-gray-50 sticky top-0 z-10 backdrop-blur border-b"},[e("tr",{class:"text-left text-gray-600"},[e("th",{class:"px-3 py-2 w-10"},"#"),e("th",{class:"px-3 py-2"},"Item"),e("th",{class:"px-3 py-2 w-40"},"Handover"),e("th",{class:"px-3 py-2 w-[18rem]"},"Present Condition"),e("th",{class:"px-3 py-2 w-[18rem]"},"Receiver"),e("th",{class:"px-3 py-2 w-[18rem]"},"Remarks"),e("th",{class:"px-3 py-2 w-40"},"Status"),e("th",{class:"px-3 py-2 w-16"})])],-1)),e("tbody",null,[(d(!0),u(K,null,F(c.value,(l,C)=>{var S,r,a,$,E;return d(),u("tr",{key:o(l),class:T(["border-t hover:bg-gray-50 transition-colors cursor-pointer",h(l.status)]),onClick:x=>M(l,C)},[e("td",Ee,g(C+1),1),e("td",Se,[e("div",De,g(l.label),1),e("div",Ae,"#"+g(o(l)),1)]),e("td",Ue,[e("span",{class:T(["inline-flex items-center gap-1 rounded-full border px-2 py-0.5",((S=I[l.handover_status])==null?void 0:S.pill)||"bg-slate-50 text-slate-700 border-slate-200"])},[e("span",Ie,g(((r=I[l.handover_status])==null?void 0:r.label)||l.handover_status||"N/A"),1)],2)]),e("td",Oe,[e("div",Re,g(l.present_condition||"—"),1)]),e("td",Pe,[O(l)?(d(),u("div",Me,g(l.receiver_name||"—"),1)):(d(),u("div",Te,"—"))]),e("td",Ve,[e("div",Le,g(l.remarks||"—"),1)]),e("td",Ge,[e("span",{class:T(["inline-flex items-center gap-1 rounded-full border px-2 py-0.5",((a=w[l.status])==null?void 0:a.pill)||"bg-slate-50 text-slate-700 border-slate-200"])},[e("span",{class:T(["h-1.5 w-1.5 rounded-full",(($=w[l.status])==null?void 0:$.dot)||"bg-slate-400"])},null,2),e("span",Be,g(((E=w[l.status])==null?void 0:E.label)||l.status||"—"),1)],2)]),e("td",{class:"px-3 py-2 align-top",onClick:s[1]||(s[1]=Q(()=>{},["stop"]))},[e("button",{class:"inline-flex items-center gap-1 rounded-md border px-2.5 py-1.5 text-xs hover:bg-gray-50",onClick:x=>M(l,C),title:"Edit"},"✎ Edit",8,ze)])],10,$e)}),128)),c.value.length===0?(d(),u("tr",je,s[8]||(s[8]=[e("td",{colspan:"8",class:"px-3 py-12"},[e("div",{class:"flex flex-col items-center justify-center text-center border border-dashed rounded-xl p-8 bg-slate-50"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-8 w-8 mb-2",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1.5",d:"M3 7h18M3 12h18M3 17h18M7 3v18"})]),e("div",{class:"text-sm text-gray-700 font-medium"},"No items to show"),e("p",{class:"text-xs text-gray-500 mt-1"},"Choose a department & template to load assigned clearance items.")])],-1)]))):R("",!0)])])],4),H(re,{"enter-active-class":"transition ease-out duration-150","enter-from-class":"opacity-0","enter-to-class":"opacity-100","leave-active-class":"transition ease-in duration-100","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:ne(()=>[b.value?(d(),u("div",{key:0,class:"fixed inset-0 z-[60] flex items-start md:items-center justify-center bg-black/40 p-4",onClick:Q(p,["self"]),role:"dialog","aria-modal":"true"},[e("div",Ke,[e("div",{class:"sticky top-0 flex items-center justify-between border-b px-5 py-3 bg-white/90 dark:bg-gray-900/90 backdrop-blur"},[s[10]||(s[10]=e("h3",{class:"text-base font-semibold"},"Add / Update Clearance",-1)),e("button",{class:"h-8 w-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800",onClick:p,title:"Close"},"✕")]),e("div",Fe,[e("div",null,[s[11]||(s[11]=e("label",{class:"block text-sm font-medium mb-1"},"Handover",-1)),H(ge,{"model-value":n.handover_status,"onUpdate:modelValue":s[2]||(s[2]=l=>n.handover_status=l)},null,8,["model-value"]),v.handover_status?(d(),u("p",We,g(v.handover_status),1)):R("",!0)]),e("div",null,[s[12]||(s[12]=e("label",{class:"block text-sm font-medium mb-1"},"Present Condition",-1)),V(e("textarea",{class:"w-full resize-none bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 leading-6 focus:outline-none focus:ring-2 focus:ring-sky-500/20 focus:border-sky-500","onUpdate:modelValue":s[3]||(s[3]=l=>n.present_condition=l),maxlength:N.present_condition,rows:"3",placeholder:"e.g., OK / minor scratches / N/A"},null,8,He),[[Y,n.present_condition]]),v.present_condition?(d(),u("p",Ye,g(v.present_condition),1)):R("",!0)]),e("div",null,[s[13]||(s[13]=e("label",{class:"block text-sm font-medium mb-1"},"Receiver",-1)),V(e("textarea",{class:"w-full resize-none bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 leading-6 focus:outline-none focus:ring-2 focus:ring-sky-500/20 focus:border-sky-500","onUpdate:modelValue":s[4]||(s[4]=l=>n.receiver_name=l),maxlength:N.receiver_name,rows:"2",placeholder:"Receiver name(s), designation — one per line"},null,8,qe),[[Y,n.receiver_name]]),v.receiver_name?(d(),u("p",Je,g(v.receiver_name),1)):R("",!0)]),e("div",null,[s[14]||(s[14]=e("label",{class:"block text-sm font-medium mb-1"},"Remarks",-1)),V(e("textarea",{class:"w-full resize-none bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 leading-6 focus:outline-none focus:ring-2 focus:ring-sky-500/20 focus:border-sky-500","onUpdate:modelValue":s[5]||(s[5]=l=>n.remarks=l),maxlength:N.remarks,rows:"3",placeholder:"Remarks (optional)"},null,8,Qe),[[Y,n.remarks]]),v.remarks?(d(),u("p",Xe,g(v.remarks),1)):R("",!0)]),e("div",null,[s[15]||(s[15]=e("label",{class:"block text-sm font-medium mb-1"},"Status",-1)),H(_e,{"model-value":n.status,"onUpdate:modelValue":s[6]||(s[6]=l=>n.status=l)},null,8,["model-value"]),v.status?(d(),u("p",Ze,g(v.status),1)):R("",!0)])]),e("div",{class:"sticky bottom-0 flex items-center justify-end gap-2 border-t px-5 py-3 bg-white/90 dark:bg-gray-900/90 backdrop-blur"},[e("button",{class:"rounded-lg border px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-800",onClick:p},"Cancel"),e("button",{class:"inline-flex items-center gap-2 rounded-lg bg-gray-900 px-3 py-2 text-sm text-white hover:bg-gray-800",onClick:L,title:"Save (Ctrl+Enter)"}," Save ")])])])):R("",!0)]),_:1})]))}},tt=se(et,[["__scopeId","data-v-b7897bb0"]]),st={class:"p-6 space-y-6"},at={class:"sticky top-0 z-10 bg-white/90 backdrop-blur border-b"},nt={class:"flex flex-wrap items-center justify-between gap-4 py-3"},rt={class:"p-2 space-y-1"},lt={class:"flex items-center gap-2"},ot={class:"flex flex-wrap items-center gap-2 text-xs text-slate-600"},it={class:"inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-1"},dt={class:"text-slate-800"},ut={class:"inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-1"},ct={class:"text-slate-800"},pt={key:0,class:"inline-flex items-center gap-1 rounded-full bg-amber-50 px-2 py-1 text-amber-700"},mt={class:"flex items-center gap-2"},vt={key:0,class:"hidden md:flex items-center gap-2 text-xs text-gray-600","aria-label":"Summary"},gt={class:"inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-1"},bt={class:"inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-1"},ft={class:"inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-1"},yt=["disabled","aria-busy"],_t={key:0},xt={key:1},ht=["disabled","title","aria-busy"],wt={key:0},kt={key:1},Nt={class:"card p-4 space-y-4"},Ct={class:"grid grid-cols-1 md:grid-cols-3 gap-3"},$t={class:"space-y-1"},Et=["value"],St={key:0,class:"text-[11px] text-slate-500"},Dt={class:"space-y-1"},At=["disabled"],Ut={value:null},It=["value"],Ot={key:0,class:"text-[11px] text-slate-500"},Rt={class:"space-y-1"},Pt=["disabled"],Mt={key:0,class:"text-[11px] text-slate-500"},Tt={key:0,class:"mt-2 text-sm text-rose-600"},Vt={key:0,class:"card p-6 text-slate-600"},Lt={key:1,class:"card p-6 text-slate-600"},Gt={key:2},Bt={key:0,class:"card p-6"},jt={__name:"UserClearance",setup(A){const y=me(),U=oe(),m=D(null),c=D(2),{userId:o,departments:k,statusFilter:w,users:I,itemsForTable:h,loading:O,saving:N,error:b,dirty:_}=ie(y),n=()=>_.value.size,v=()=>!!m.value&&!!c.value,M=G(()=>(k.value||[]).find(r=>r.id===m.value)||null),z=G(()=>(I.value||[]).find(r=>r.id===o.value)||null),L=r=>{var q;if(!r)return"";const a=r.name||"Unnamed",$=r.employee_code||r.employee_id||r.code||"",E=((q=r.designation)==null?void 0:q.name)||r.designation_name||"",x=[$,E].filter(Boolean).join(" • ");return x?`${a} (${x})`:a},p=G(()=>m.value?o.value?"work":"user":"dept"),i=async()=>_.value.size>0&&typeof window<"u"?window.confirm("You have unsaved changes. Changing Department will discard them. Continue?"):!0;B(()=>{var r;return(r=U.user)==null?void 0:r.department_id},async r=>{if(r){m.value=r,I.value=[],o.value=null;try{await y.loadUsersByDept(r),v()&&await y.refreshAll(r,c.value)}catch(a){console.error("bootstrap error",a)}}},{immediate:!0}),B(m,async(r,a)=>{if(r===a)return;if(!await i()){m.value=a??null;return}if(I.value=[],o.value=null,r)try{await y.loadUsersByDept(r),c.value&&await y.refreshAll(r,c.value)}catch(E){console.error("dept change error",E)}}),B(c,async r=>{if(m.value&&r)try{await y.refreshAll(m.value,r),o.value&&await y.loadClearances(o.value,m.value,c.value)}catch(a){console.error("template change error",a)}}),B(o,async()=>{if(v()&&o.value)try{await y.loadClearances(o.value,m.value,c.value)}catch(r){console.error("user change error",r)}});function t(r,a){const $=h.value,E=$.findIndex(x=>x.template_item_id===r);E>=0&&(Object.assign($[E],a),y.markDirty(r,!0))}async function s(){try{if(!o.value)return;await y.saveBulk(m.value,c.value)}catch(r){console.error(r)}}async function l(){if(v())try{await y.refreshAll(m.value,c.value),o.value&&await y.loadClearances(o.value,m.value,c.value)}catch(r){console.error("refresh error",r)}}const C=G(()=>{if(!o.value)return{pending:0,working:0,completed:0};const r=h.value||[];return{pending:r.filter(a=>a.status==="PENDING").length,working:r.filter(a=>a.status==="WORKING").length,completed:r.filter(a=>a.status==="COMPLETED").length}});function S(r){_.value.size>0&&(r.preventDefault(),r.returnValue="")}return de(async()=>{typeof window<"u"&&window.addEventListener("beforeunload",S);try{await y.fetchDepartments()}catch(r){console.error("fetchDepartments error",r)}}),Z(()=>{typeof window<"u"&&window.removeEventListener("beforeunload",S)}),ue((r,a,$)=>{if(_.value.size>0&&typeof window<"u"&&!window.confirm("You have unsaved changes. Leave anyway?"))return $(!1);$()}),(r,a)=>{var $,E;return d(),u("div",st,[e("div",at,[e("div",nt,[e("div",rt,[e("div",lt,[a[3]||(a[3]=e("h1",{class:"text-2xl font-semibold tracking-tight"},"User Clearance",-1)),e("span",{class:T(["inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold",{"bg-slate-100 text-slate-700":p.value==="dept","bg-blue-50 text-blue-700":p.value==="user","bg-emerald-50 text-emerald-700":p.value==="work"}])},g(p.value==="dept"?"Step 1: Department":p.value==="user"?"Step 2: User":"Step 3: Update"),3)]),a[7]||(a[7]=e("p",{class:"text-sm text-gray-600"}," Assign করা আইটেম অনুযায়ী ইউজারের ক্লিয়ারেন্স আপডেট করুন ",-1)),e("div",ot,[e("span",it,[a[4]||(a[4]=P(" Dept: ")),e("b",dt,g((($=M.value)==null?void 0:$.name)||"—"),1)]),e("span",ut,[a[5]||(a[5]=P(" User: ")),e("b",ct,g(((E=z.value)==null?void 0:E.name)||"—"),1)]),f(_).size?(d(),u("span",pt,[a[6]||(a[6]=P(" Unsaved: ")),e("b",null,g(n()),1)])):R("",!0)])]),e("div",mt,[f(o)?(d(),u("div",vt,[e("span",gt,[a[8]||(a[8]=P(" Pending: ")),e("b",null,g(C.value.pending),1)]),e("span",bt,[a[9]||(a[9]=P(" Working: ")),e("b",null,g(C.value.working),1)]),e("span",ft,[a[10]||(a[10]=P(" Completed: ")),e("b",null,g(C.value.completed),1)])])):R("",!0),e("button",{class:"btn-2",onClick:l,disabled:f(O)||!m.value||!c.value,title:"Reload template bindings and current user's items","aria-busy":f(O)?"true":"false"},[f(O)?(d(),u("span",_t,"Refreshing…")):(d(),u("span",xt,"Refresh"))],8,yt),e("button",{class:"btn-1",onClick:s,disabled:f(N)||f(_).size===0||!f(o),title:f(o)?"":"Select a user first","aria-busy":f(N)?"true":"false"},[f(N)?(d(),u("span",wt,"Saving…")):(d(),u("span",kt,"Save Changes ("+g(n())+")",1))],8,ht)])])]),e("div",Nt,[e("div",Ct,[e("div",$t,[a[12]||(a[12]=e("label",{class:"text-sm font-medium text-slate-700"},"Department",-1)),V(e("select",{"onUpdate:modelValue":a[0]||(a[0]=x=>m.value=x),class:"input-1"},[a[11]||(a[11]=e("option",{value:null},"Select Department",-1)),(d(!0),u(K,null,F(f(k),x=>(d(),u("option",{key:x.id,value:x.id},g(x.name),9,Et))),128))],512),[[W,m.value]]),m.value?R("",!0):(d(),u("p",St," Step 1: প্রথমে Department সিলেক্ট করুন "))]),e("div",Dt,[a[13]||(a[13]=e("label",{class:"text-sm font-medium text-slate-700"},"User",-1)),V(e("select",{"onUpdate:modelValue":a[1]||(a[1]=x=>X(o)?o.value=x:null),class:"input-1",disabled:!m.value||f(O)},[e("option",Ut,g(m.value?f(O)?"Loading users…":"Select User":"Select Department first"),1),(d(!0),u(K,null,F(f(I),x=>(d(),u("option",{key:x.id,value:x.id},g(L(x)),9,It))),128))],8,At),[[W,f(o)]]),m.value&&!f(o)?(d(),u("p",Ot," Step 2: এখন একটি User সিলেক্ট করুন ")):R("",!0)]),e("div",Rt,[a[15]||(a[15]=e("label",{class:"text-sm font-medium text-slate-700"},"Status Filter",-1)),V(e("select",{"onUpdate:modelValue":a[2]||(a[2]=x=>X(w)?w.value=x:null),class:"input-1",disabled:!f(o)},a[14]||(a[14]=[e("option",{value:""},"All",-1),e("option",{value:"PENDING"},"Pending",-1),e("option",{value:"WORKING"},"Working",-1),e("option",{value:"COMPLETED"},"Completed",-1)]),8,Pt),[[W,f(w)]]),f(o)?R("",!0):(d(),u("p",Mt," User সিলেক্ট করলে filter কাজ করবে "))])]),f(b)?(d(),u("div",Tt,g(f(b)),1)):R("",!0)]),m.value?f(o)?(d(),u("div",Gt,[f(O)?(d(),u("div",Bt,a[18]||(a[18]=[pe('<div class="animate-pulse space-y-3"><div class="h-4 bg-gray-200 rounded w-1/3"></div><div class="h-4 bg-gray-200 rounded w-2/3"></div><div class="h-4 bg-gray-200 rounded"></div><div class="h-4 bg-gray-200 rounded"></div></div>',1)]))):(d(),ce(tt,{rows:f(h),key:f(o),"onUpdate:row":t},null,8,["rows"]))])):(d(),u("div",Lt,a[17]||(a[17]=[e("b",null,"Step 2:",-1),P(" Select a "),e("b",null,"User",-1),P(" to load clearance items. ")]))):(d(),u("div",Vt,a[16]||(a[16]=[e("b",null,"Step 1:",-1),P(" Select a "),e("b",null,"Department",-1),P(" to load users. ")])))])}}};export{jt as default};
