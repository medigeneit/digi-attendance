import{B as Me,r as i,C as ee,u as ze,f as We,D as te,x as $,h as Be,q as K,c as m,o as p,a,j as le,t as z,d as me,l as Ke,k as pe,F as L,e as V,H as Le,b as he,m as Ve,s as J,O as ae,P as Ye}from"./index-Cfiy3STQ.js";import{_ as Qe}from"./EmployeeFilter-BuAnui4z.js";import{u as He}from"./company-CLSQPKlk.js";import{u as Re}from"./department-Dsx9MprQ.js";import{u as Te}from"./shift-xHY3yVEu.js";import{d as Y}from"./dayjs.min-BAVZghaK.js";import{_ as Ue}from"./FlexibleDatePicker-6AnTSy6d.js";import{_ as Ie}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./EmployeeDropdownInput-DFBPgjTb.js";import"./SelectDropdown-Bq782kL7.js";import"./UserChip-BrZtBeAD.js";const Pe=Me("shiftSchedule",()=>{const Q=i([]),F=i(!1);return{schedules:Q,defaultShift:F,fetchSchedules:async g=>{var j,D,T;const u=await ee.get("/shift-schedules",g);return Q.value=(j=u==null?void 0:u.data)==null?void 0:j.schedules,F.value=(D=u==null?void 0:u.data)==null?void 0:D.default_shift,(T=u.data)==null?void 0:T.schedules},saveSchedules:async g=>{await ee.post("/shift-schedules",{schedules:g==null?void 0:g.payload})},fetchDefaultSchedules:async g=>{const u=await ee.get("/default-shift-schedules",g);return Q.value=u==null?void 0:u.data,u.data}}}),qe={class:"p-4 max-w-[1600px] mx-auto"},Ge={class:"flex flex-wrap items-center justify-between gap-3 mb-4"},Je={class:"flex items-center gap-3 text-xs md:text-sm text-gray-500"},Xe={class:"font-semibold"},Ze={class:"flex flex-wrap justify-start items-center gap-3 mb-2"},et={class:"flex gap-4"},tt=["value"],lt={class:"flex flex-wrap items-center justify-between gap-2 mb-3"},at={key:0,class:"text-xs md:text-sm text-gray-500 flex items-center gap-2"},st={key:0,class:"text-xs md:text-sm text-amber-700 bg-amber-50 border border-amber-100 rounded px-2 py-1 mb-3"},nt={class:"flex flex-wrap gap-2 md:gap-3 mb-4 p-2 md:p-3 bg-white/70 backdrop-blur rounded sticky top-16 z-20 border"},ot=["onClick"],rt={class:"mb-3 flex flex-wrap gap-2 md:gap-3 items-center"},ut=["disabled"],it=["disabled"],dt=["disabled"],ct={class:"btn-3 ml-auto flex items-center gap-2 text-xs md:text-sm"},vt=["checked"],ft=["disabled"],mt={class:"overflow-auto border rounded"},pt={class:"table-auto w-full text-xs md:text-sm"},ht={class:"sticky top-0 bg-white z-10"},yt=["title"],bt={class:"font-medium leading-none"},gt={class:"text-[9px] md:text-[10px] text-gray-500"},xt={class:"border p-2 sticky-col-1 bg-inherit z-10"},St={class:"flex items-center gap-2"},_t=["value"],kt={class:"min-w-0"},wt={class:"font-medium leading-tight truncate max-w-[150px]"},Nt={class:"border p-1 md:p-2 sticky-col-2 bg-inherit z-10 text-center"},Ct=["onClick","disabled"],Et=["onClick","title"],Ft={key:0},Dt={class:"flex justify-center mt-4 md:mt-5"},At=["disabled"],$t={__name:"ShiftScheduleForm",setup(Q){const F=Pe(),se=He(),H=Te(),R=Re(),g=ze(),u=We(),{defaultShift:j}=te(F),{employees:D}=te(se),{shifts:T}=te(H),x=i(Y().format("YYYY-MM")),h=i(""),y=i(""),S=i(""),c=i(""),ye=t=>String(t).padStart(2,"0"),N=i({year:Number(x.value.split("-")[0])||Y().year(),month:Number(x.value.split("-")[1])||Y().month()+1,day:1}),b=$(()=>!N.value.year||!N.value.month?"":`${N.value.year}-${ye(N.value.month)}`),r=i({}),_=i([]),k=i(""),ne=i(!1),U=i(!1),O=i([]),X=i(!1),W=i(null),B=i({WEEKEND:"#B91C1C",HOLIDAY:"#6B7280"}),oe=["#FF5733","#33C1FF","#33FF57","#FF33D4","#FFD633","#7D33FF","#FF8C33","#33FFF0","#B833FF","#3375FF","#FF3333","#33FFAA"],re=t=>e=>(e||[]).find(s=>Number(s==null?void 0:s.id)===Number(t)),I=$(()=>{const t=T.value||{};return Array.isArray(t)?t:Object.values(t).flat()});function ue(){let t=0;I.value.forEach(e=>{const s=String(e.id);B.value[s]||(B.value[s]=oe[t%oe.length],t++)})}const P=$(()=>b.value?Array.from({length:Y(b.value).daysInMonth()},(t,e)=>e+1):[]),ie=t=>{const e=`${b.value}-${String(t).padStart(2,"0")}`;return Y(e).format("ddd")},v=$(()=>(_.value||[]).map(t=>Number(t)).filter(Number.isFinite)),de=$(()=>new Set(v.value)),M=t=>de.value.has(Number(t)),d=t=>String(t),be=(t,e)=>{var n,o;const s=(o=(n=r.value)==null?void 0:n[d(t)])==null?void 0:o[e];return s?{backgroundColor:B.value[String(s)]||"#D1D5DB"}:{backgroundColor:"#E5E7EB"}},ge=(t,e)=>{var n,o;const s=(o=(n=r.value)==null?void 0:n[d(t)])==null?void 0:o[e];if(s==="WEEKEND"||s==="HOLIDAY")return s;const l=re(s)(I.value);return(l==null?void 0:l.name)||""},xe=(t,e)=>{const s=`${b.value}-${String(e).padStart(2,"0")}`,l=ge(t,e);return l?`${s} — ${l}`:M(t)?`${s} — Click to set shift`:`${s} — Check this employee to edit`};function Se(t,e){M(t)&&c.value&&(r.value[d(t)]||(r.value[d(t)]={}),r.value[d(t)][e]=c.value)}function ce(t){M(t)&&c.value&&(r.value[d(t)]||(r.value[d(t)]={}),P.value.forEach(e=>{r.value[d(t)][e]=c.value}))}function _e(){!v.value.length||!c.value||v.value.forEach(ce)}function ke(){v.value.length&&v.value.forEach(t=>{var l;const e=re(t)(O.value),s=(((l=e==null?void 0:e.assign_weekend)==null?void 0:l.weekends)||[]).map(n=>String(n).slice(0,3));r.value[d(t)]||(r.value[d(t)]={}),P.value.forEach(n=>{const o=ie(n);s.includes(o)&&(r.value[d(t)][n]="WEEKEND")})})}function we(){v.value.length&&v.value.forEach(t=>{r.value[d(t)]&&(r.value[d(t)]={})})}async function ve(){if(!v.value.length){alert("Select at least one employee.");return}const t=[];for(const[e,s]of Object.entries(r.value||{})){const l=Number(e);if(de.value.has(l))for(const[n,o]of Object.entries(s||{})){const C=Number(n);if(!C||!o)continue;const w=`${b.value}-${String(C).padStart(2,"0")}`;let A=null,f=null;o==="WEEKEND"||o==="HOLIDAY"?f=o:A=Number(o),t.push({employee_id:l,date:w,shift_id:A,status:f})}}if(!t.length){alert("No schedule data to save for checked employees.");return}try{await F.saveSchedules({payload:t}),alert("Shift schedule saved successfully!")}catch(e){console.error("Failed to save schedule",e),alert("Something went wrong while saving.")}}function Ne({companyId:t,departmentId:e,lineType:s,month:l}){return[t||"",e||"",s||"all",l||""].join("-")}async function Ce({companyId:t,departmentId:e,lineType:s,month:l}){if(!t||!e||!l||s==="all"){r.value={};return}const n={companyId:Number(t)||null,departmentId:Number(e)||null,lineType:s&&s!=="all"?s:"all",month:l},o=Ne(n);if(W.value!==o){W.value=o,X.value=!0,j.value=!1,r.value={};try{const C={company_id:n.companyId,department_id:n.departmentId,month:n.month};n.lineType&&n.lineType!=="all"&&(C.line_type=n.lineType);let w=await F.fetchSchedules({params:C});if(w=Array.isArray(w)?w:w||[],!w.length){const f=await F.fetchDefaultSchedules({params:C}),E=Array.isArray(f)?f:f||[];E.length&&(console.warn("[Fallback Schedule Loaded]",E),j.value=!0,w=E,alert("No saved schedule found. Default schedule loaded."))}const A={};w.forEach(f=>{const E=Number(f==null?void 0:f.employee_id),Oe=String((f==null?void 0:f.date)||"").split("-")[2],fe=Number(Oe);!E||!fe||(A[d(E)]||(A[d(E)]={}),A[d(E)][fe]=f.shift_id??f.status)}),W.value===o&&(r.value=A)}catch(C){console.error("Failed to load schedule data:",C),alert("Error loading schedule. Please try again or contact admin.")}finally{W.value===o&&(X.value=!1)}}}async function Z(t){if(!t)return O.value=[],D.value=[],_.value=[],[];const e=await R.fetchDepartmentEmployee([Number(t)],k.value),s=Array.isArray(e)?e:Array.isArray(e==null?void 0:e.data)?e.data:[];return O.value=s,D.value=s,_.value=_.value.filter(l=>s.some(n=>Number(n==null?void 0:n.id)===Number(l))),s}function Ee(t=b.value||x.value){return!!(h.value&&y.value&&t)}async function q(t){const e=t||b.value||x.value;Ee(e)&&await Ce({companyId:h.value,departmentId:y.value,lineType:k.value,month:e})}const Fe=$(()=>({company_id:h.value,department_id:y.value,line_type:k.value,employee_id:S.value,month:b.value})),De=t=>Object.fromEntries(Object.entries(t||{}).filter(([,e])=>e!==""&&e!==null&&e!==void 0));function Ae(t={}){const e={...u.query,...t},s=De(e);Object.keys(s).length===Object.keys(u.query).length&&Object.entries(s).every(([n,o])=>String(u.query[n]??"")===String(o??""))||g.replace({query:s}).catch(()=>{})}function $e(t=u.query){U.value=!0,h.value=t.company_id||"",y.value=t.department_id||"",S.value=t.employee_id||"",k.value=t.line_type||"all";const e=t.month||x.value;if(x.value=e,e){const[s,l]=e.split("-");s&&(N.value.year=Number(s)),l&&(N.value.month=Number(l))}U.value=!1,ne.value=!0}Be(async()=>{$e(),h.value&&(await Promise.all([R.fetchDepartments({company_id:Number(h.value)}),H.fetchShifts({company_id:Number(h.value)})]),ue()),h.value&&y.value&&(await Z(y.value),await q())}),K(h,async t=>{t&&(y.value="",_.value=[],S.value="",O.value=[],D.value=[],r.value={},k.value="all",W.value=null,await Promise.all([R.fetchDepartments({company_id:Number(t)}),H.fetchShifts({company_id:Number(t)})]),ue())}),K(y,async t=>{t&&(U.value||(S.value=""),await Z(t),await q())}),K(k,async()=>{!h.value||!y.value||(await Z(y.value),await q())}),K(b,async t=>{t&&(x.value=t,await q(t))}),K(Fe,t=>{!ne.value||U.value||Ae(t)},{deep:!0});const G=$(()=>{const t=O.value.length?O.value:D.value||[];if(!S.value)return t;const e=Number(S.value);return t.filter(s=>Number(s==null?void 0:s.id)===e)});function je(t){t?_.value=G.value.map(e=>Number(e.id)):_.value=[]}return(t,e)=>{var s;return p(),m("div",qe,[a("div",Ge,[e[11]||(e[11]=a("h2",{class:"text-xl md:text-2xl font-semibold"}," Monthly Shift Schedule Plan ",-1)),a("div",Je,[e[10]||(e[10]=a("span",null,"Month:",-1)),a("span",Xe,z(b.value||x.value),1)])]),a("div",Ze,[me(Qe,{company_id:h.value,"onUpdate:company_id":e[2]||(e[2]=l=>h.value=l),department_id:y.value,"onUpdate:department_id":e[3]||(e[3]=l=>y.value=l),line_type:k.value,"onUpdate:line_type":e[4]||(e[4]=l=>k.value=l),employee_id:S.value,"onUpdate:employee_id":e[5]||(e[5]=l=>S.value=l),"initial-value":{company_id:h.value,department_id:y.value,line_type:k.value,employee_id:S.value}},{default:Ke(()=>[a("div",et,[pe(a("select",{"onUpdate:modelValue":e[0]||(e[0]=l=>c.value=l),class:"px-3 py-0.5 border rounded-full text-sm"},[e[12]||(e[12]=a("option",{value:""},"- Pick a Shift -",-1)),(p(!0),m(L,null,V(I.value,l=>(p(),m("option",{key:l.id,value:l.id},z(l.name),9,tt))),128))],512),[[Le,c.value]]),me(Ue,{modelValue:N.value,"onUpdate:modelValue":e[1]||(e[1]=l=>N.value=l),"show-year":!1,"show-month":!0,"show-date":!1},null,8,["modelValue"])])]),_:1},8,["company_id","department_id","line_type","employee_id","initial-value"])]),a("div",lt,[e[14]||(e[14]=a("div",{class:"text-xs md:text-sm text-sky-800 bg-sky-50 border border-sky-200 rounded px-2 py-1"},[he(" ✔ Only "),a("b",null,"checked"),he(" employees are editable & will be saved. ")],-1)),X.value?(p(),m("div",at,e[13]||(e[13]=[a("span",{class:"inline-block w-2 h-2 rounded-full border-2 border-gray-400 border-t-transparent animate-spin"},null,-1),a("span",null,"Loading schedule...",-1)]))):le("",!0)]),Ve(j)?(p(),m("p",st," ⚠ Showing default schedule from current shift. Select employees manually before saving. ")):le("",!0),a("div",nt,[(p(!0),m(L,null,V(I.value,l=>(p(),m("div",{key:l.id,class:J(["flex items-center gap-2 cursor-pointer px-2 py-1 rounded border hover:bg-gray-50 text-xs md:text-sm",{"ring-2 ring-blue-500":String(c.value)===String(l.id)}]),onClick:n=>c.value=l.id},[a("div",{class:"w-4 h-4 rounded",style:ae({backgroundColor:B.value[String(l.id)]||"#ccc"})},null,4),a("span",null,z(l.name),1)],10,ot))),128)),a("div",{class:J(["flex items-center gap-2 cursor-pointer px-2 py-1 rounded border hover:bg-gray-50 text-xs md:text-sm",{"ring-2 ring-blue-500":c.value==="HOLIDAY"}]),onClick:e[6]||(e[6]=l=>c.value="HOLIDAY")},e[15]||(e[15]=[a("div",{class:"w-4 h-4 rounded bg-gray-500"},null,-1),a("span",null,"Holiday",-1)]),2),a("div",{class:J(["flex items-center gap-2 cursor-pointer px-2 py-1 rounded border hover:bg-gray-50 text-xs md:text-sm",{"ring-2 ring-blue-500":c.value==="WEEKEND"}]),onClick:e[7]||(e[7]=l=>c.value="WEEKEND")},[a("div",{class:"w-4 h-4 rounded",style:ae({backgroundColor:B.value.WEEKEND})},null,4),e[16]||(e[16]=a("span",null,"Weekend",-1))],2)]),a("div",rt,[a("button",{onClick:_e,class:"btn-4 bg-indigo-600 hover:bg-indigo-700 text-white text-xs md:text-sm",disabled:!v.value.length||!c.value,title:"Set selected shift to all days for checked employees"}," Set Shift → Checked (All Dates) ",8,ut),a("button",{onClick:ke,class:"btn-4 bg-red-700 hover:bg-red-800 text-white text-xs md:text-sm",disabled:!v.value.length,title:"Mark employee-specific weekends for checked employees"}," Set Weekends → Checked ",8,it),a("button",{onClick:we,class:"btn-4 bg-gray-700 hover:bg-gray-800 text-white text-xs md:text-sm",disabled:!v.value.length}," Clear (Checked) ",8,dt),a("label",ct,[a("input",{type:"checkbox",checked:v.value.length&&v.value.length===G.value.length,onChange:e[8]||(e[8]=l=>je(l.target.checked))},null,40,vt),e[17]||(e[17]=a("span",null,"Select all (visible)",-1))]),a("button",{onClick:ve,class:"btn-2 text-xs md:text-sm",disabled:!v.value.length,title:"Saves only checked employees"}," Save (Checked only) ",8,ft)]),a("div",mt,[a("table",pt,[a("thead",ht,[a("tr",null,[e[18]||(e[18]=a("th",{class:"border p-2 w-40 sticky-col-1 text-left bg-white z-50"}," Employee ",-1)),e[19]||(e[19]=a("th",{class:"border p-2 w-32 sticky-col-2 text-center bg-white z-50"}," Quick Action ",-1)),(p(!0),m(L,null,V(P.value,l=>(p(),m("th",{key:l,class:"border text-center p-1 min-w-[32px] md:min-w-[40px]",title:`${x.value}-${String(l).padStart(2,"0")}`},[a("div",bt,z(l),1),a("div",gt,z(ie(l)),1)],8,yt))),128))])]),a("tbody",null,[(p(!0),m(L,null,V(G.value,l=>(p(),m("tr",{key:l.id,class:"odd:bg-white even:bg-gray-50"},[a("td",xt,[a("label",St,[pe(a("input",{type:"checkbox",class:"rounded",value:l.id,"onUpdate:modelValue":e[9]||(e[9]=n=>_.value=n)},null,8,_t),[[Ye,_.value]]),a("div",kt,[a("div",wt,z(l.name),1)])])]),a("td",Nt,[a("button",{class:"btn-4 cursor-pointer text-[11px] md:text-xs px-2 py-1",onClick:n=>ce(l.id),disabled:!c.value||!M(l.id)}," Apply to all ",8,Ct)]),(p(!0),m(L,null,V(P.value,n=>(p(),m("td",{key:n,class:J(["border text-center",["border text-center",M(l.id)?"cursor-pointer hover:bg-gray-100":"cursor-default opacity-70"]]),onClick:o=>M(l.id)&&Se(l.id,n),title:xe(l.id,n)},[a("div",{style:ae(be(l.id,n)),class:"w-full h-5 md:h-6 rounded transition"},null,4)],10,Et))),128))]))),128)),(s=G.value)!=null&&s.length?le("",!0):(p(),m("tr",Ft,e[20]||(e[20]=[a("td",{colspan:"999",class:"text-center text-gray-500 p-6"}," No employees found for current filter. ",-1)])))])])]),a("div",Dt,[a("button",{onClick:ve,class:"btn-2 text-xs md:text-sm",disabled:!v.value.length,title:"Saves only checked employees"}," Save (Checked only) ",8,At)])])}}},Ht=Ie($t,[["__scopeId","data-v-4bc6315e"]]);export{Ht as default};
