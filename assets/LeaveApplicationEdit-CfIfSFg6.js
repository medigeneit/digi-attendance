import{d as J,u as z,b as G,s as K,x as y,r as w,e as Q,A as $,m as X,c as m,o as p,a,f as Z,n as E,i as ee,j as te,w as ae,g as S,h as f,v as L,t as b,F,y as I,k as C,ab as U}from"./index-W-8vDVy9.js";import{L as se}from"./LoaderView-BOPiIUWG.js";import{_ as ne}from"./MultiselectDropdown-Bf_YRo6Z.js";import{u as le}from"./holiday-B7Q0PbwC.js";import{u as oe}from"./leave-application-BtDNXLr9.js";import{u as ie}from"./leave-type-DrhDTXXT.js";import{u as re}from"./user-DlIcYnNf.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./MultiselectDropdown.vue_vue_type_style_index_0_lang-C7b4kQ3v.js";const ue={class:"my-container max-w-3xl space-y-4"},de={class:"flex items-center justify-between gap-2"},pe={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},me={key:0},ve={class:"text-blue-600 font-medium"},ce={key:1,class:"bg-gray-100 p-2 rounded-md"},fe={class:"font-semibold w-32 shrink-0"},_e={class:"flex flex-wrap gap-3"},ye=["name","value","onUpdate:modelValue","disabled"],we={class:"flex items-center space-x-1"},ge=["name","onUpdate:modelValue"],ke={class:"flex items-center space-x-1"},be=["name","onUpdate:modelValue"],xe={key:0,class:"text-red-600 text-sm font-medium mt-2"},he={key:2,class:"text-red-500 text-sm"},Be={__name:"LeaveApplicationEdit",setup(De){J();const x=oe(),H=ie(),v=re();le();const A=z(),T=G(),{userLeaveBalance:N}=K(v),V=y(()=>x.leaveApplication),R=y(()=>T.params.id),h=w(null),o=w({user_id:"",last_working_date:"",resumption_date:"",reason:"",works_in_hand:"",handover_user_id:""}),u=w({}),g=w(!1),D=w(null),W=w(!1),O=n=>{const e=n.getFullYear(),s=String(n.getMonth()+1).padStart(2,"0"),t=String(n.getDate()).padStart(2,"0");return`${e}-${s}-${t}`},_=y(()=>{const n=o.value.last_working_date,e=o.value.resumption_date;if(!n||!e)return[];const s=new Date(n),t=new Date(e);if(t<=s)return[];const r=[],l=new Date(s);for(l.setDate(l.getDate()+1);l<t;)r.push(O(l)),l.setDate(l.getDate()+1);return r}),Y=y(()=>{const n=o.value.last_working_date,e=o.value.resumption_date;if(!n||!e)return"";const s=new Date(n);return new Date(e)<=s?"Resumption date must be after Last Working Date.":_.value.length===0?"No leave days between the selected dates.":`Total leave days: ${_.value.length}`}),j=y(()=>{const n={};for(const[e,s]of Object.entries(u.value||{}))typeof s=="number"&&(n[s]=(n[s]||0)+1);return n}),B=y(()=>{const n=N.value||[],e=[];for(const s of n){const t=j.value[s.id]||0;Number.isFinite(s.remaining_days)&&t>s.remaining_days&&e.push({id:s.id,name:s.leave_type||s.name,used:t,remain:s.remaining_days})}return e}),M=()=>{const n=u.value||{},e={};for(const s of _.value)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s]);u.value=e};Q(async()=>{var n,e;g.value=!0;try{const{id:s}=T.params;W.value=!!s,await x.fetchLeaveApplicationById(s);const t=x.leaveApplication,r=t==null?void 0:t.user;if(!t||!r)return;const l=(n=r==null?void 0:r.company)==null?void 0:n.id;if(l&&await H.fetchLeaveTypes(l),t.user_id&&await v.fetchUserLeaveBalances(t.user_id,{applicationId:R.value}),await v.fetchTypeWiseEmployees({type:r.type,except:[r.id]}),v.users=v.users.map(i=>({...i,label:i.name})),(e=v.users)!=null&&e.length){const i=v.users.find(k=>k.id===t.handover_user_id);i&&(h.value=i)}o.value={user_id:t.user_id,last_working_date:t.last_working_date,resumption_date:t.resumption_date,reason:t.reason,works_in_hand:t.works_in_hand,handover_user_id:t.handover_user_id};const d={};if(Array.isArray(t.json_data))for(const i of t.json_data){const k=i==null?void 0:i.date,c=i==null?void 0:i.leave_type_id;k&&(c==="weekend"||c==="holiday"?d[k]=c:c!=null&&c!==""&&!Number.isNaN(Number(c))&&(d[k]=Number(c)))}u.value=d,M()}catch(s){console.error(s)}finally{g.value=!1}}),$(()=>[o.value.last_working_date,o.value.resumption_date],()=>{M()}),$(()=>h.value,n=>{o.value.handover_user_id=(n==null?void 0:n.id)||null});const q=async()=>{var n;g.value=!0,D.value=null;try{const e=_.value,s=[],t=[];for(const l of e){const d=u.value[l],i=d!=="weekend"&&d!=="holiday"&&d!=null?Number(d):null;i!=null&&s.push({date:l,leave_type_id:i}),t.push({date:l,leave_type_id:d??""})}const r={id:R.value,user_id:(n=V==null?void 0:V.value)==null?void 0:n.user_id,last_working_date:o.value.last_working_date,resumption_date:o.value.resumption_date,reason:o.value.reason,works_in_hand:o.value.works_in_hand,handover_user_id:o.value.handover_user_id,leave_days:s,json_data:t};if(r.id){const l=await x.updateLeaveApplication(r.id,r);l&&A.push({name:"LeaveApplicationShow",params:{id:l==null?void 0:l.id}})}}catch(e){D.value=(e==null?void 0:e.message)||"Failed to submit leave application"}finally{g.value=!1}},P=()=>A.go(-1);return(n,e)=>{const s=X("RouterLink");return p(),m("div",ue,[a("div",de,[a("button",{class:"btn-3",onClick:P},e[5]||(e[5]=[a("i",{class:"far fa-arrow-left"},null,-1),a("span",{class:"hidden md:flex"},"Back",-1)])),e[7]||(e[7]=a("h1",{class:"title-md md:title-lg flex-wrap text-center"},"Leave Application Edit Form",-1)),a("div",null,[E(s,{to:"/applications",class:"btn-2"},{default:ee(()=>e[6]||(e[6]=[te("Home")])),_:1,__:[6]})])]),g.value?(p(),Z(se,{key:0})):(p(),m("form",{key:1,onSubmit:ae(q,["prevent"]),class:"space-y-4 card-bg p-4 md:p-8"},[a("div",pe,[a("div",null,[e[8]||(e[8]=a("label",{for:"last-working-date",class:"block text-sm font-medium"},"Last Working Date",-1)),f(a("input",{type:"date",id:"last-working-date","onUpdate:modelValue":e[0]||(e[0]=t=>o.value.last_working_date=t),class:"input-1 w-full",required:""},null,512),[[L,o.value.last_working_date]])]),a("div",null,[e[9]||(e[9]=a("label",{for:"resumption-date",class:"block text-sm font-medium"},"Resumption Date",-1)),f(a("input",{type:"date",id:"resumption-date","onUpdate:modelValue":e[1]||(e[1]=t=>o.value.resumption_date=t),class:"input-1 w-full",required:""},null,512),[[L,o.value.resumption_date]])])]),o.value.last_working_date&&o.value.resumption_date?(p(),m("div",me,[a("p",ve,b(Y.value),1)])):S("",!0),_.value.length?(p(),m("div",ce,[e[12]||(e[12]=a("h2",{class:"text-lg font-semibold"},"Leave Days",-1)),(p(!0),m(F,null,I(_.value,(t,r)=>(p(),m("div",{key:t,class:"flex gap-4 mb-2 bg-white p-2 rounded-md"},[a("div",fe,b(t),1),a("div",_e,[(p(!0),m(F,null,I(C(N),l=>(p(),m("label",{key:l.id,class:"flex items-center space-x-1"},[f(a("input",{type:"radio",name:"leaveType-"+t,value:l.id,"onUpdate:modelValue":d=>u.value[t]=d,disabled:j.value[l.id]>=(l.remaining_days??1/0)&&u.value[t]!==l.id},null,8,ye),[[U,u.value[t]]]),a("span",null,b(l.leave_type),1)]))),128)),a("label",we,[f(a("input",{type:"radio",name:"leaveType-"+t,value:"weekend","onUpdate:modelValue":l=>u.value[t]=l},null,8,ge),[[U,u.value[t]]]),e[10]||(e[10]=a("span",null,"Weekend",-1))]),a("label",ke,[f(a("input",{type:"radio",name:"leaveType-"+t,value:"holiday","onUpdate:modelValue":l=>u.value[t]=l},null,8,be),[[U,u.value[t]]]),e[11]||(e[11]=a("span",null,"Holiday",-1))])])]))),128)),B.value.length?(p(),m("p",xe," You have exceeded remaining days for: "+b(B.value.map(t=>`${t.name} (used ${t.used}/${t.remain})`).join(", ")),1)):S("",!0)])):S("",!0),a("div",null,[e[13]||(e[13]=a("label",{for:"reason",class:"block text-sm font-medium"},"Reason",-1)),f(a("textarea",{id:"reason","onUpdate:modelValue":e[2]||(e[2]=t=>o.value.reason=t),class:"input-1 w-full",placeholder:"Enter your reason for leave"},null,512),[[L,o.value.reason]])]),a("div",null,[e[14]||(e[14]=a("label",{for:"handover-user",class:"block text-sm font-medium"},"Handover User",-1)),E(ne,{modelValue:h.value,"onUpdate:modelValue":e[3]||(e[3]=t=>h.value=t),options:C(v).users,multiple:!1,label:"label",placeholder:"Select user"},null,8,["modelValue","options"])]),a("div",null,[e[15]||(e[15]=a("label",{for:"works-in-hand",class:"block text-sm font-medium"},"Works in Hand",-1)),f(a("textarea",{id:"works-in-hand","onUpdate:modelValue":e[4]||(e[4]=t=>o.value.works_in_hand=t),class:"input-1 w-full",placeholder:"Enter details of works in hand",rows:"6"},null,512),[[L,o.value.works_in_hand]])]),D.value?(p(),m("div",he,b(D.value),1)):S("",!0),e[16]||(e[16]=a("div",{class:"flex justify-end"},[a("button",{type:"submit",class:"btn-1"},"Update")],-1))],32))])}}};export{Be as default};
