import{S as He,Q as R,b as Le,d as Se,r as h,m,e as Ve,c as r,o as i,a as e,g as C,t as a,k as H,j as w,F as L,y as S,h as V,v as j}from"./index-DDK5bJel.js";const je=He("kpi",{state:()=>({cycle:null,loading:!1}),actions:{async fetchActiveCycle(){try{this.loading=!0;const{data:b}=await R.get("/kpi/active");this.cycle=b}finally{this.loading=!1}},async submitReview(b){const{data:p}=await R.post("/kpi/review/submit",b);return p},async fetchSummary(b,p){const{data:c}=await R.get(`/kpi/summary/${b}/${p}`);return c},async submitFinalResult(b,p){const{data:c}=await R.post(`/kpi/finalize/${b}/${p}`);return c},async fetchLanes(b,p){const{data:c}=await R.get(`/kpi/lanes/${b}/${p}`);return c}}}),Ee={class:"max-w-6xl mx-auto py-6 px-4"},Te={class:"mb-4"},Ae={class:"flex items-center justify-between"},Ge={class:"space-y-0.5"},Pe={class:"text-xl font-semibold"},Ue={class:"text-sm text-slate-600"},Ke={key:0,class:"inline-flex items-center gap-1"},ze={key:1},Ie={class:"text-right"},Be={class:"text-lg font-bold"},qe={key:0,class:"overflow-auto border rounded-2xl mb-6"},De={class:"min-w-[980px] w-full text-sm"},Oe={class:"bg-slate-50 sticky top-0"},Qe={class:"font-medium"},Ye={class:"text-[11px] text-slate-500"},Je={key:0},We={key:1},Xe={key:2,class:"ml-1 rounded bg-blue-50 text-blue-700 border border-blue-200 px-1"},Ze={class:"bg-slate-100/80 border-t"},et=["colspan"],tt={class:"px-3 py-2 text-center"},st={class:"px-3 py-2"},lt={class:"font-medium"},at={class:"mt-1 hidden md:flex gap-1 text-[11px] text-slate-500"},ot=["onClick"],nt=["onClick"],dt=["onClick"],rt={class:"px-3 py-2 text-center"},it={key:0,class:"flex items-center gap-2 justify-center"},ut=["max","onUpdate:modelValue","onChange"],ct={key:1,class:"text-center text-slate-700"},xt={key:2,class:"text-center text-slate-400"},mt={class:"bg-slate-50 border-t"},vt={class:"px-3 py-2 text-center font-medium"},pt=["colspan"],_t={class:"font-semibold"},bt={class:"text-slate-500"},yt={key:1,class:"border rounded-2xl"},ft={class:"px-3 py-2 bg-slate-50 text-sm font-medium flex items-center justify-between"},ht={class:"hidden md:flex gap-2 text-[12px] text-slate-600"},gt={key:0,class:"rounded bg-emerald-50 text-emerald-700 border border-emerald-200 px-2 py-0.5"},kt={key:1,class:"rounded bg-slate-100 border px-2 py-0.5"},wt={class:"min-w-[760px] w-full text-sm"},Nt={class:"sticky top-0 bg-white"},Ft={class:"bg-slate-100"},Ct={class:"text-left px-3 py-2 w-[48%]"},Mt={class:"bg-slate-50"},$t={class:"px-3 py-2"},Rt={class:"flex gap-1 text-[11px] text-slate-600"},Ht=["onClick","disabled"],Lt=["onClick","disabled"],St=["onClick","disabled"],Vt={class:"px-3 py-2 text-center"},jt={class:"px-3 py-2"},Et={class:"font-medium"},Tt={key:0,class:"max-w-xl"},At={class:"grid grid-cols-1 sm:grid-cols-3 gap-3"},Gt={class:"flex-1 rounded-lg border px-3 py-2"},Pt={class:"flex items-center justify-between"},Ut={class:"text-[11px] px-1.5 py-0.5 rounded bg-blue-50 text-blue-700 border border-blue-200"},Kt={class:"mt-0.5 text-sm font-semibold"},zt={class:"text-xs text-slate-500"},It={class:"flex-1 rounded-lg border px-3 py-2"},Bt={class:"flex items-center justify-between"},qt={class:"text-[11px] px-1.5 py-0.5 rounded bg-violet-50 text-violet-700 border border-violet-200"},Dt={class:"mt-0.5 text-sm font-semibold"},Ot={class:"text-xs text-slate-500"},Qt={class:"flex-1 rounded-lg border px-3 py-2"},Yt={class:"flex items-center justify-between"},Jt={class:"text-[11px] px-1.5 py-0.5 rounded bg-emerald-50 text-emerald-700 border border-emerald-200"},Wt={class:"mt-0.5 text-sm font-semibold"},Xt={class:"text-xs text-slate-500"},Zt={class:"px-3 py-2 text-center"},es={class:"px-3 py-2 text-center"},ts=["max","onUpdate:modelValue","onChange"],ss={key:1,class:"text-slate-700"},ls={class:"bg-slate-50 border-t"},as={class:"px-3 py-2 text-center font-medium"},os={class:"px-3 py-2 text-center"},ns={key:2,class:"grid md:grid-cols-3 gap-4 mt-4"},ds={class:"mt-6 flex items-center justify-between"},rs={class:"text-sm"},is=["disabled"],cs={__name:"KpiReviewForm",setup(b){const p=Le(),c=je(),T=Se(),u=h({}),A=h(""),G=h(""),P=h(""),x=h(null),U=h([]),K=h({}),f=h(null),z=h(!1),I=m(()=>{var s;return((s=c.cycle)==null?void 0:s.groups_json)||[]}),J=s=>(s==null?void 0:s.id)==="personal"||/personal/i.test((s==null?void 0:s.label)||""),g=m(()=>I.value.find(J)||null),B=m(()=>I.value.filter(s=>!J(s))),Fe=s=>/^hr\d*$/i.test(s)||s==="hr",W=s=>Fe((s==null?void 0:s.key)||"")||(s==null?void 0:s.is_hr_lane)===!0,X=m(()=>U.value.filter(W)),N=m(()=>U.value.filter(s=>!W(s))),Ce=m(()=>{var s;return Number(((s=T==null?void 0:T.user)==null?void 0:s.id)||0)}),q=m(()=>{const s=Ce.value;return s&&X.value.find(t=>Number(t.assigned_user_id)===s)||null}),M=m(()=>{var s;return((s=q.value)==null?void 0:s.key)||null}),Me=m(()=>!!(q.value&&q.value.can_current_user_review)),y=m(()=>!!(z.value||Me.value)),Z=m(()=>!!f.value&&N.value.some(s=>s.key===f.value&&s.can_current_user_review));function D(s){var o;return(((o=K.value)==null?void 0:o[s])||[])[0]||null}function ee(s,t){var l;const o=D(s);return((l=o==null?void 0:o.marks)==null?void 0:l[t])??""}function te(s){var o,l,d,n;if(M.value){const v=D(M.value),k=(o=v==null?void 0:v.marks)==null?void 0:o[s];if(k!=null)return k}let t=null;for(const v of X.value){const _=(((l=K.value)==null?void 0:l[v.key])||[])[0];if(!(!_||((d=_==null?void 0:_.marks)==null?void 0:d[s])==null)){if(!t){t=_;continue}_.submitted_at&&t.submitted_at&&_.submitted_at>t.submitted_at&&(t=_)}}return((n=t==null?void 0:t.marks)==null?void 0:n[s])??""}function O(s,t){const o=Number(u.value[s]??0);o<0&&(u.value[s]=0),o>Number(t)&&(u.value[s]=Number(t))}function E(s,t,o){o==="zero"?u.value[s]=0:o==="half"?u.value[s]=Number(t)/2:o==="full"&&(u.value[s]=Number(t)),O(s,t)}function Q(s,t){s.items.forEach(o=>E(o.id,o.max,t))}const $=m(()=>{let s=0,t=0;const o=g.value;o&&o.items.forEach(d=>{s+=Number(d.max||0);const n=Number(u.value[d.id]||0);t+=Math.min(Math.max(n,0),Number(d.max||0))});const l=s>0?t/s*100:0;return{max:Number(s.toFixed(2)),got:Number(t.toFixed(2)),percent:Number(l.toFixed(2))}}),$e=m(()=>{const s={};let t=1;const o=g.value;return o&&o.items.forEach(l=>{s[l.id]=t++}),s});Ve(async()=>{var t,o;c.cycle||await c.fetchActiveCycle();const s=await c.fetchLanes(c.cycle.id,Number(p.params.employeeId));if(x.value=s==null?void 0:s.annual_target_avg_marks,U.value=s.lanes||[],K.value=s.reviews_by_lane||{},z.value=!!(((t=s==null?void 0:s.meta)==null?void 0:t.is_hr)??(s==null?void 0:s.hr)??!1),f.value=((o=N.value.find(l=>l.can_current_user_review))==null?void 0:o.key)||null,I.value.forEach(l=>l.items.forEach(d=>{u.value[d.id]==null&&(u.value[d.id]=0)})),f.value){const l=D(f.value);l!=null&&l.marks&&Object.assign(u.value,l.marks)}y.value&&B.value.forEach(l=>{l.items.forEach(d=>{let n=M.value?ee(M.value,d.id):"";(n===""||n==null)&&(n=te(d.id)),n!==""&&n!=null&&(u.value[d.id]=Number(n))})})});async function Re(){const s=y.value;await c.submitReview({cycle_id:c.cycle.id,employee_id:Number(p.params.employeeId),reviewer_lane:s?M.value:f.value,marks:u.value,strengths:A.value,gaps:G.value,suggestions:P.value}),alert("Submitted")}function F(s){const t=Number(s??0);return isNaN(t)?"0.00":t.toFixed(2)}function Y(s,t){const o=Number(s??0),l=Number(t??0);return l>0?Math.round(o/l*100):0}return(s,t)=>{var o;return i(),r("div",Ee,[e("header",Te,[e("div",Ae,[e("div",Ge,[e("h2",Pe,"KPI — "+a((o=H(c).cycle)==null?void 0:o.title),1),e("p",Ue,[t[5]||(t[5]=w(" Employee: ")),e("strong",null,"#"+a(s.$route.params.employeeId),1),t[6]||(t[6]=w(" • Reviewing as: ")),y.value?(i(),r("strong",Ke,t[4]||(t[4]=[w(" HR "),e("span",{class:"text-[11px] rounded bg-emerald-50 border border-emerald-200 px-1.5 py-0.5 text-emerald-700"},"HR mode",-1)]))):(i(),r("strong",ze,a(f.value||"No lane"),1))])]),e("div",Ie,[t[7]||(t[7]=e("div",{class:"text-xs text-slate-500"},"Total (Personal group)",-1)),e("div",Be,a($.value.got.toFixed(2))+" / "+a($.value.max.toFixed(2))+" ("+a($.value.percent.toFixed(2))+"%) ",1)]),z.value?(i(),r("button",{key:0,onClick:t[0]||(t[0]=l=>H(c).submitFinalResult(H(c).cycle.id,H(p).params.employeeId)),class:"px-5 py-2.5 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700"}," Finalize & Lock ")):C("",!0)])]),H(c).cycle&&g.value?(i(),r("section",qe,[e("table",De,[e("thead",Oe,[e("tr",null,[t[8]||(t[8]=e("th",{class:"px-3 py-2 w-[60px] text-center"},"SL",-1)),t[9]||(t[9]=e("th",{class:"text-left px-3 py-2 w-[34%]"},"মূল্যায়নের বিষয় (Personal)",-1)),t[10]||(t[10]=e("th",{class:"px-3 py-2 text-center"},"Max",-1)),(i(!0),r(L,null,S(N.value,l=>(i(),r("th",{key:l.key,class:"px-3 py-2 text-center"},[e("div",Qe,a(l.label),1),e("div",Ye,[l.assigned_user_name?(i(),r("span",Je,a(l.assigned_user_name),1)):(i(),r("span",We,"-")),l.key===f.value&&l.can_current_user_review?(i(),r("span",Xe,"editable")):C("",!0)])]))),128))])]),e("tbody",null,[e("tr",Ze,[e("td",{colspan:3+N.value.length,class:"px-3 py-2 font-medium"},a(g.value.label),9,et)]),(i(!0),r(L,null,S(g.value.items,l=>(i(),r("tr",{key:l.id,class:"border-t"},[e("td",tt,a($e.value[l.id]),1),e("td",st,[e("div",lt,a(l.label),1),e("div",at,[e("button",{class:"border rounded px-1.5 py-0.5",onClick:d=>E(l.id,l.max,"zero")},"0",8,ot),e("button",{class:"border rounded px-1.5 py-0.5",onClick:d=>E(l.id,l.max,"half")},"½",8,nt),e("button",{class:"border rounded px-1.5 py-0.5",onClick:d=>E(l.id,l.max,"full")},"Full",8,dt)])]),e("td",rt,a(l.max),1),(i(!0),r(L,null,S(N.value,d=>(i(),r("td",{key:d.key,class:"px-3 py-2"},[d.key===f.value&&d.can_current_user_review?(i(),r("div",it,[V(e("input",{type:"number",step:"0.1",min:"0",max:l.max,"onUpdate:modelValue":n=>u.value[l.id]=n,onChange:n=>O(l.id,l.max),class:"w-24 text-right rounded-lg border px-2 py-1"},null,40,ut),[[j,u.value[l.id],void 0,{number:!0}]])])):d.can_view_marks?(i(),r("div",ct,a(ee(d.key,l.id)),1)):(i(),r("div",xt,"—"))]))),128))]))),128)),e("tr",mt,[t[11]||(t[11]=e("td",null,null,-1)),t[12]||(t[12]=e("td",{class:"px-3 py-2 text-right font-medium"},"Group Total",-1)),e("td",vt,a(g.value.items.reduce((l,d)=>l+Number(d.max||0),0).toFixed(2)),1),e("td",{colspan:N.value.length,class:"px-3 py-2 text-center"},[e("span",_t,a(g.value.items.reduce((l,d)=>{const n=Number(u.value[d.id]||0);return l+Math.min(Math.max(n,0),Number(d.max||0))},0).toFixed(2)),1),e("span",bt," / "+a(g.value.items.reduce((l,d)=>l+Number(d.max||0),0).toFixed(2)),1)],8,pt)])])])])):C("",!0),B.value.length?(i(),r("section",yt,[e("div",ft,[t[13]||(t[13]=e("span",null,"Other Groups (HR only) — Personal attributes excluded",-1)),e("div",ht,[y.value?(i(),r("span",gt,"You can edit HR")):(i(),r("span",kt,"View only"))])]),(i(!0),r(L,null,S(B.value,(l,d)=>(i(),r("div",{key:l.id,class:"overflow-auto"},[e("table",wt,[e("thead",Nt,[e("tr",Ft,[t[14]||(t[14]=e("th",{class:"px-3 py-2 w-[60px] text-center"},"SL",-1)),e("th",Ct,"গ্রুপ: "+a(d+1)+" — "+a(l.label),1),t[15]||(t[15]=e("th",{class:"px-3 py-2 text-center w-[120px]"},"Max",-1)),t[16]||(t[16]=e("th",{class:"px-3 py-2 text-center w-[160px]"},"HR",-1))])]),e("tbody",null,[e("tr",Mt,[t[17]||(t[17]=e("td",null,null,-1)),e("td",$t,[e("div",Rt,[e("button",{class:"border rounded px-1.5 py-0.5",onClick:n=>Q(l,"zero"),disabled:!y.value},"All 0",8,Ht),e("button",{class:"border rounded px-1.5 py-0.5",onClick:n=>Q(l,"half"),disabled:!y.value},"All ½",8,Lt),e("button",{class:"border rounded px-1.5 py-0.5",onClick:n=>Q(l,"full"),disabled:!y.value},"All Full",8,St)])]),t[18]||(t[18]=e("td",null,null,-1)),t[19]||(t[19]=e("td",null,null,-1))]),(i(!0),r(L,null,S(l.items,(n,v)=>{var k,_,se,le,ae,oe,ne,de,re,ie,ue,ce,xe,me,ve,pe,_e,be,ye,fe,he,ge,ke,we;return i(),r("tr",{key:n.id,class:"border-t"},[e("td",Vt,a(v+1),1),e("td",jt,[e("div",Et,a(n.label),1),l.id==="target"?(i(),r("div",Tt,[e("div",At,[e("div",Gt,[e("div",Pt,[t[20]||(t[20]=e("span",{class:"text-xs font-medium text-slate-600"},"Incharge (avg)",-1)),e("span",Ut,a(Y((_=(k=x.value)==null?void 0:k.avg)==null?void 0:_.incharge,(le=(se=x.value)==null?void 0:se.avg)==null?void 0:le.max))+"% ",1)]),e("div",Kt,[w(a(F((oe=(ae=x.value)==null?void 0:ae.avg)==null?void 0:oe.incharge))+" ",1),e("span",zt,"/ "+a(F((de=(ne=x.value)==null?void 0:ne.avg)==null?void 0:de.max)),1)])]),e("div",It,[e("div",Bt,[t[21]||(t[21]=e("span",{class:"text-xs font-medium text-slate-600"},"Coordinator (avg)",-1)),e("span",qt,a(Y((ie=(re=x.value)==null?void 0:re.avg)==null?void 0:ie.coordinator,(ce=(ue=x.value)==null?void 0:ue.avg)==null?void 0:ce.max))+"% ",1)]),e("div",Dt,[w(a(F((me=(xe=x.value)==null?void 0:xe.avg)==null?void 0:me.coordinator))+" ",1),e("span",Ot,"/ "+a(F((pe=(ve=x.value)==null?void 0:ve.avg)==null?void 0:pe.max)),1)])]),e("div",Qt,[e("div",Yt,[t[22]||(t[22]=e("span",{class:"text-xs font-medium text-slate-600"},"Final (avg)",-1)),e("span",Jt,a(Y((be=(_e=x.value)==null?void 0:_e.avg)==null?void 0:be.final,(fe=(ye=x.value)==null?void 0:ye.avg)==null?void 0:fe.max))+"% ",1)]),e("div",Wt,[w(a(F((ge=(he=x.value)==null?void 0:he.avg)==null?void 0:ge.final))+" ",1),e("span",Xt,"/ "+a(F((we=(ke=x.value)==null?void 0:ke.avg)==null?void 0:we.max)),1)])])])])):C("",!0)]),e("td",Zt,a(n.max),1),e("td",es,[y.value?V((i(),r("input",{key:0,type:"number",step:"0.1",min:"0",max:n.max,"onUpdate:modelValue":Ne=>u.value[n.id]=Ne,onChange:Ne=>O(n.id,n.max),class:"w-24 text-right rounded-lg border px-2 py-1"},null,40,ts)),[[j,u.value[n.id],void 0,{number:!0}]]):(i(),r("span",ss,a(te(n.id)),1))])])}),128)),e("tr",ls,[t[23]||(t[23]=e("td",null,null,-1)),t[24]||(t[24]=e("td",{class:"px-3 py-2 text-right font-medium"},"Group Total",-1)),e("td",as,a(l.items.reduce((n,v)=>n+Number(v.max||0),0).toFixed(2)),1),e("td",os,a(l.items.reduce((n,v)=>{const k=Number(u.value[v.id]||0);return n+Math.min(Math.max(k,0),Number(v.max||0))},0).toFixed(2)),1)])])])]))),128))])):C("",!0),Z.value||y.value?(i(),r("div",ns,[V(e("textarea",{"onUpdate:modelValue":t[1]||(t[1]=l=>A.value=l),placeholder:"Key Strength(s)",class:"rounded-xl border p-3 min-h-28"},null,512),[[j,A.value]]),V(e("textarea",{"onUpdate:modelValue":t[2]||(t[2]=l=>G.value=l),placeholder:"GAP(s)",class:"rounded-xl border p-3 min-h-28"},null,512),[[j,G.value]]),V(e("textarea",{"onUpdate:modelValue":t[3]||(t[3]=l=>P.value=l),placeholder:"Suggestions / Training",class:"rounded-xl border p-3 min-h-28"},null,512),[[j,P.value]])])):C("",!0),e("div",ds,[e("div",rs,[t[25]||(t[25]=w("My (Personal) Total: ")),e("b",null,a($.value.got.toFixed(2)),1),w(" / "+a($.value.max.toFixed(2)),1)]),e("button",{onClick:Re,disabled:!(y.value||Z.value),class:"px-5 py-2.5 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-40"}," Submit ",8,is)])])}}};export{cs as default};
