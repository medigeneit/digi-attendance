import{C as Ce,D as K,s as Ne,r as w,x as J,A as Y,e as Oe,c as f,o as v,a as l,h as z,B as Te,k as M,F as B,y as P,t as O,j as $e,n as Me,g as de,L as ue,X as ce,w as me,q as pe}from"./index-8KAp3d5I.js";import{L as Se}from"./LoaderView-wPDpQ1P9.js";import{_ as Be}from"./_plugin-vue_export-helper-DlAUqK2U.js";const je=Ce("kpi-report",{state:()=>({meta:null,rows:[],isLoading:!1,error:null}),actions:{async fetchBiMonthly(T){var u,d;this.isLoading=!0,this.error=null;try{const{data:r}=await K.get("/kpi/reports/bi-monthly",{params:T});return this.meta=(r==null?void 0:r.meta)??null,this.rows=Array.isArray(r==null?void 0:r.rows)?r.rows:Array.isArray(r==null?void 0:r.data)?r.data:[],{meta:this.meta,rows:this.rows}}catch(r){throw this.error=((d=(u=r==null?void 0:r.response)==null?void 0:u.data)==null?void 0:d.message)||"Failed to load report",r}finally{this.isLoading=!1}},async exportBiMonthly(T){try{const u=await K.get("/kpi/reports/bi-monthly-export",{params:T,responseType:"blob"}),d=u.headers["content-disposition"]||"";let r="kpi_bi_monthly.xlsx";const g=/filename="?([^"]+)"?/i.exec(d);g&&g[1]&&(r=decodeURIComponent(g[1]));const j=new Blob([u.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),S=URL.createObjectURL(j),b=document.createElement("a");b.href=S,b.download=r,document.body.appendChild(b),b.click(),b.remove(),URL.revokeObjectURL(S)}catch(u){throw console.error(u),u}},async setReportCompletion(T){var u,d;try{const{form_id:r,department_id:g,completed:j}=T||{};if(!r)throw new Error("form_id is required");if(g==null)throw new Error("department_id is required");const{data:S}=await K.patch(`/kpi/forms/${r}/report-completion`,{department_id:g,completed:!!j});return S}catch(r){const g=((d=(u=r==null?void 0:r.response)==null?void 0:u.data)==null?void 0:d.message)||(r==null?void 0:r.message)||"Failed to update report completion";throw console.error("setReportCompletion error:",r),new Error(g)}},async setTargetCompletion({form_id:T,department_id:u,completed:d}){const{data:r}=await K.post(`/kpi/bi-monthly/forms/${T}/target-completion`,{department_id:u,completed:d});return r}}}),Ae={class:"space-y-4 px-4 print:px-0"},De={class:"flex flex-wrap items-end gap-3 print:hidden"},Ie=["disabled"],Pe=["value"],Re={key:0,class:"py-8 text-center"},Ve={key:1,class:"rounded-md border border-red-200 bg-red-50 p-3 text-red-700"},Le={key:2,class:"overflow-x-auto rounded-xl border bg-white shadow-sm"},Ue={class:"min-w-full text-sm"},Ee={class:"bg-gray-100 text-gray-800"},Fe={rowspan:"2",class:"border px-2 py-2 text-left"},Ke={class:"bg-gray-100 text-gray-700"},Ye={class:"border text-center"},qe={class:"border px-2 w-40"},Je={class:"border text-center"},ze=["disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange","title"],Ge={class:"border text-center"},We=["disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange","title"],Xe={class:"border text-center"},He={class:"border text-center"},Qe={key:0,class:"mt-1 text-[10px] text-gray-500 text-center"},Ze={key:0},et=1500,tt={__name:"KpiBiMonthlyReport",setup(T){const u=je(),{meta:d,rows:r,isLoading:g,error:j}=Ne(u),S=new Date().getFullYear(),b=w(S),A=w([]),G=w("department"),R=w(""),V=w(""),L=w("any"),k=J(()=>{var e;return((e=d.value)==null?void 0:e.periods)||[]}),W=J(()=>{var e;return((e=d.value)==null?void 0:e.available_years)||null}),X=J(()=>{const e=Object.create(null);for(const t of k.value)e[t.key]=t;return e});function ye(e=2018,t=S+1){const n=[];for(let s=t;s>=e;s--)n.push(s);const o=Number(b.value);n.includes(o)||n.unshift(o),A.value=Array.from(new Set(n))}function H(e){Array.isArray(e)&&e.length?(A.value=[...new Set(e.map(Number))].sort((t,n)=>n-t),A.value.includes(Number(b.value))||(b.value=A.value[0])):ye()}Y(W,H,{immediate:!0}),Y(b,()=>{const e=Number(b.value);!Number.isInteger(e)||e<2e3||e>2100||le()});const x=w(Object.create(null)),_=w(Object.create(null)),$=w(Object.create(null)),U=w(Object.create(null)),E=w(Object.create(null)),q=w(Object.create(null)),y=(e,t)=>`${e}::${t}`;function F(e){var n;if(((n=d.value)==null?void 0:n.scope)!=="department")return null;const t=String((e==null?void 0:e.key)||"").match(/^dept:(\d+)$/);return t?Number(t[1]):null}function Q(e){const t=X.value[e];return t!=null&&t.form_id?Number(t.form_id):null}function Z(e){var t;return((t=X.value[e])==null?void 0:t.label)||e}function ee(e){const t=q.value[e]||0;return Date.now()-t>=et}function fe(){const e=Object.create(null);for(const t of r.value||[])for(const n of k.value){const o=y(t.key,n.key);e[o]=x.value[o]}U.value=e}function te(){var n,o,s;const e=Object.create(null),t=Object.create(null);for(const a of k.value)t[a.key]=new Set((a.completed_departments||[]).map(Number));for(const a of r.value||[]){const c=F(a);for(const i of k.value){let m=!1;if(c&&t[i.key].has(c))m=!0;else{const p=(n=a.cells)==null?void 0:n[i.key],h=Number((p==null?void 0:p.assigned)??0),C=Number(((o=p==null?void 0:p.incharge)==null?void 0:o.done)??0),N=Number(((s=p==null?void 0:p.coordinator)==null?void 0:s.done)??0);m=L.value==="both"?h>0&&C>=h&&N>=h:h>0&&(C>=h||N>=h)}e[y(a.key,i.key)]=m}}x.value=e,fe()}function oe(e,t){const n=y(e.key,t.key);U.value[n]=x.value[n]}async function ve(e,t){var C,N,ie;const n=y(e.key,t.key),o=!!x.value[n],s=!!U.value[n],a=`${(e==null?void 0:e.name)??""} • ${Z(t.key)}`,c=o?"mark as Completed":"mark as Pending";if(!window.confirm(`Confirm
${a}

Do you want to ${c}?`)){x.value[n]=s;return}if($.value[n]){x.value[n]=s,window.alert("Already updating this cell. Please wait…");return}if(!ee(n)){x.value[n]=s,window.alert("Just updated. Try again in a moment.");return}const m=Q(t.key),p=F(e),h=!!((N=(C=e==null?void 0:e.cells)==null?void 0:C[t.key])!=null&&N.form_id&&m);if(((ie=d.value)==null?void 0:ie.scope)!=="department"||!p||!h){x.value[n]=s,window.alert("This period is not assignable (no form). Cannot update.");return}$.value[n]=!0;try{await u.setReportCompletion({form_id:m,department_id:p,completed:o}),q.value[n]=Date.now(),U.value[n]=o;const D=k.value.findIndex(I=>I.key===t.key);if(D>=0){const I=new Set((d.value.periods[D].completed_departments||[]).map(Number));o?I.add(p):I.delete(p),d.value.periods[D].completed_departments=Array.from(I)}}catch(D){x.value[n]=s,console.error(D),window.alert("Failed to update report completion.")}finally{$.value[n]=!1}}function be(){const e=Object.create(null);for(const t of r.value||[])for(const n of k.value){const o=y(t.key,n.key);e[o]=_.value[o]}E.value=e}function ne(){var n,o;const e=Object.create(null),t=Object.create(null);for(const s of k.value)t[s.key]=new Set((s.target_completed_departments||[]).map(Number));for(const s of r.value||[]){const a=F(s);for(const c of k.value){let i=!1;if(a&&t[c.key].has(a))i=!0;else{const m=(o=(n=s==null?void 0:s.cells)==null?void 0:n[c.key])==null?void 0:o.monthly_target,p=Number((m==null?void 0:m.have)??0),h=Number((m==null?void 0:m.of)??0);i=h>0&&p>=h}e[y(s.key,c.key)]=i}}_.value=e,be()}function ae(e,t){const n=y(e.key,t.key);E.value[n]=_.value[n]}async function ke(e,t){var h;const n=y(e.key,t.key),o=!!_.value[n],s=!!E.value[n],a=`${(e==null?void 0:e.name)??""} • ${Z(t.key)}`,c=o?"mark Target as Completed":"mark Target as Pending";if(!window.confirm(`Confirm
${a}

Do you want to ${c}?`)){_.value[n]=s;return}if($.value[n]){_.value[n]=s,window.alert("Already updating this cell. Please wait…");return}if(!ee(n)){_.value[n]=s,window.alert("Just updated. Try again in a moment.");return}const m=F(e);if(((h=d.value)==null?void 0:h.scope)!=="department"||!m){_.value[n]=s,window.alert("This period is not assignable. Cannot update target.");return}const p=Q(t.key);$.value[n]=!0;try{await u.setTargetCompletion({period_key:t.key,form_id:p||void 0,department_id:m,completed:o}),q.value[n]=Date.now(),E.value[n]=o;const C=k.value.findIndex(N=>N.key===t.key);if(C>=0){const N=new Set((d.value.periods[C].target_completed_departments||[]).map(Number));o?N.add(m):N.delete(m),d.value.periods[C].target_completed_departments=Array.from(N)}}catch(C){_.value[n]=s,console.error(C),window.alert("Failed to update target completion.")}finally{$.value[n]=!1}}const he=(e,t)=>{var n,o,s;return!!((o=(n=e==null?void 0:e.cells)==null?void 0:n[t])!=null&&o.form_id)&&((s=d.value)==null?void 0:s.scope)==="department"},ge=(e,t)=>{var o,s,a,c,i;if(((o=d.value)==null?void 0:o.scope)!=="department")return!1;const n=(a=(s=e==null?void 0:e.cells)==null?void 0:s[t])==null?void 0:a.monthly_target;return Number((n==null?void 0:n.of)??0)>0||!!((i=(c=e==null?void 0:e.cells)==null?void 0:c[t])!=null&&i.form_id)};function xe(e){return e?"✓":"—"}function re(e,t,n){var a,c;const o=Number((e==null?void 0:e.assigned)??0),s=Number(n==="ic"?((a=e==null?void 0:e.incharge)==null?void 0:a.done)??0:((c=e==null?void 0:e.coordinator)==null?void 0:c.done)??0);if(o===0&&s===0){const i=n==="ic"?e==null?void 0:e.incharge:e==null?void 0:e.coordinator;if(typeof i=="boolean")return xe(i)}return`${s}/${t}`}function se(e,t){var s,a;const n=Number((e==null?void 0:e.assigned)??0),o=Number(t==="ic"?((s=e==null?void 0:e.incharge)==null?void 0:s.done)??0:((a=e==null?void 0:e.coordinator)==null?void 0:a.done)??0);return n===0?"border-gray-200 bg-gray-50 text-gray-600":o>=n?"border-emerald-200 bg-emerald-50 text-emerald-700":"border-rose-200 bg-rose-50 text-rose-700"}function _e(){window.print()}async function le(){try{await u.fetchBiMonthly({year:Number(b.value),scope:G.value,department_id:R.value?Number(R.value):void 0,form_id:V.value?Number(V.value):void 0,rule:L.value})}catch(e){console.error("fetchBiMonthly failed:",e)}finally{te(),ne()}}async function we(){try{await u.exportBiMonthly({year:Number(b.value),scope:G.value,department_id:R.value?Number(R.value):void 0,form_id:V.value?Number(V.value):void 0,rule:L.value})}catch(e){console.error("exportBiMonthly failed:",e),window.alert("Export failed. Please try again.")}}return Y([r,k,L],te),Y([r,k],ne),Oe(()=>{H(W.value),le()}),(e,t)=>{var n;return v(),f("div",Ae,[l("div",De,[l("div",null,[t[1]||(t[1]=l("label",{class:"text-sm text-gray-600"},"Year",-1)),z(l("select",{"onUpdate:modelValue":t[0]||(t[0]=o=>b.value=o),class:"w-32 rounded border px-2 py-1",disabled:M(g),"aria-label":"Select year"},[(v(!0),f(B,null,P(A.value,o=>(v(),f("option",{key:o,value:o},O(o),9,Pe))),128))],8,Ie),[[Te,b.value,void 0,{number:!0}]])]),l("button",{class:"btn-3",onClick:we},"Excel Generate"),l("button",{class:"btn-3",onClick:_e},t[2]||(t[2]=[l("i",{class:"far fa-print mr-1"},null,-1),$e("Print")]))]),M(g)?(v(),f("div",Re,[Me(Se)])):M(j)?(v(),f("div",Ve,O(M(j)),1)):(v(),f("div",Le,[l("table",Ue,[l("thead",null,[l("tr",Ee,[t[3]||(t[3]=l("th",{rowspan:"2",class:"border py-2 text-center"},"SL",-1)),l("th",Fe,O(((n=M(d))==null?void 0:n.scope)==="user"?"Employee":"Department"),1),(v(!0),f(B,null,P(k.value,o=>(v(),f("th",{key:o.key,colspan:"4",class:"border px-2 py-2 text-center font-semibold"},O(o.label),1))),128))]),l("tr",Ke,[(v(!0),f(B,null,P(k.value,o=>(v(),f(B,{key:o.key+"-sub"},[t[4]||(t[4]=l("th",{class:"border px-1 py-1 text-center text-[11px]"},"Target",-1)),t[5]||(t[5]=l("th",{class:"border px-1 py-1 text-center text-[11px]"},"Report",-1)),t[6]||(t[6]=l("th",{class:"border px-1 py-1 text-center text-[11px]"},"Inch.",-1)),t[7]||(t[7]=l("th",{class:"border px-1 py-1 text-center text-[11px]"},"Coord.",-1))],64))),128))])]),l("tbody",null,[(v(!0),f(B,null,P(M(r),(o,s)=>(v(),f("tr",{key:o.key,class:"border-t"},[l("td",Ye,O(s+1),1),l("td",qe,O(o.name),1),(v(!0),f(B,null,P(k.value,a=>{var c;return v(),f(B,{key:a.key},[l("td",Je,[z(l("input",{type:"checkbox",disabled:!ge(o,a.key)||$.value[y(o.key,a.key)],"onUpdate:modelValue":i=>_.value[y(o.key,a.key)]=i,onMousedown:i=>ae(o,a),onKeydown:ce(me(i=>ae(o,a),["prevent"]),["enter"]),onChange:i=>ke(o,a),title:_.value[y(o.key,a.key)]?"Target Completed":"Target Pending"},null,40,ze),[[ue,_.value[y(o.key,a.key)]]])]),l("td",Ge,[z(l("input",{type:"checkbox",disabled:!he(o,a.key)||$.value[y(o.key,a.key)],"onUpdate:modelValue":i=>x.value[y(o.key,a.key)]=i,onMousedown:i=>oe(o,a),onKeydown:ce(me(i=>oe(o,a),["prevent"]),["enter"]),onChange:i=>ve(o,a),title:x.value[y(o.key,a.key)]?"Completed":"Pending"},null,40,We),[[ue,x.value[y(o.key,a.key)]]])]),l("td",Xe,[l("span",{class:pe(["inline-block text-center font-mono rounded",se(o.cells[a.key],"ic")])},O(re(o.cells[a.key],o.employees_total,"ic")),3)]),l("td",He,[l("span",{class:pe(["inline-block text-center font-mono rounded",se(o.cells[a.key],"co")])},O(re(o.cells[a.key],o.employees_total,"co")),3),(c=o.cells[a.key])!=null&&c.max_total?(v(),f("div",Qe,O(o.cells[a.key].final_total)+" / "+O(o.cells[a.key].max_total),1)):de("",!0)])],64)}),128))]))),128)),!M(r)||M(r).length===0?(v(),f("tr",Ze,t[8]||(t[8]=[l("td",{colspan:"100",class:"px-3 py-6 text-center text-gray-600"},"No data",-1)]))):de("",!0)])])]))])}}},rt=Be(tt,[["__scopeId","data-v-e16a9364"]]);export{rt as default};
