import{B as Ae,r as d,C as J,u as $e,f as je,D as X,x as j,h as Oe,q as W,c as p,o as h,a,j as Z,t as O,d as Me,k as ee,H as ze,F as B,e as K,v as We,b as fe,m as Be,s as P,O as te,P as Ke}from"./index-Chd8BsxV.js";import{_ as Le}from"./EmployeeFilter-7Y_bqlAp.js";import{u as Ye}from"./company-D-V_M7IG.js";import{u as Qe}from"./department-CueBOEsA.js";import{u as Te}from"./shift-BRCWXCPL.js";import{d as le}from"./dayjs.min-DTSAUpQ2.js";import{_ as Ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./EmployeeDropdownInput-DcKQDxu5.js";import"./SelectDropdown-CrnnjnBN.js";import"./UserChip-DIWDzbKJ.js";const He=Ae("shiftSchedule",()=>{const L=d([]),C=d(!1);return{schedules:L,defaultShift:C,fetchSchedules:async g=>{var D,N,T;const u=await J.get("/shift-schedules",g);return L.value=(D=u==null?void 0:u.data)==null?void 0:D.schedules,C.value=(N=u==null?void 0:u.data)==null?void 0:N.default_shift,(T=u.data)==null?void 0:T.schedules},saveSchedules:async g=>{await J.post("/shift-schedules",{schedules:g==null?void 0:g.payload})},fetchDefaultSchedules:async g=>{const u=await J.get("/default-shift-schedules",g);return L.value=u==null?void 0:u.data,u.data}}}),Re={class:"p-4 max-w-[1600px] mx-auto"},Ue={class:"flex flex-wrap items-center justify-between gap-3 mb-4"},Ie={class:"flex items-center gap-3 text-xs md:text-sm text-gray-500"},Pe={class:"font-semibold"},qe={class:"flex flex-wrap justify-start items-center gap-3 mb-2"},Ge=["value"],Je={class:"flex flex-wrap items-center justify-between gap-2 mb-3"},Xe={key:0,class:"text-xs md:text-sm text-gray-500 flex items-center gap-2"},Ze={key:0,class:"text-xs md:text-sm text-amber-700 bg-amber-50 border border-amber-100 rounded px-2 py-1 mb-3"},et={class:"flex flex-wrap gap-2 md:gap-3 mb-4 p-2 md:p-3 bg-white/70 backdrop-blur rounded sticky top-16 z-20 border"},tt=["onClick"],lt={class:"mb-3 flex flex-wrap gap-2 md:gap-3 items-center"},at=["disabled"],st=["disabled"],nt=["disabled"],ot={class:"btn-3 ml-auto flex items-center gap-2 text-xs md:text-sm"},rt=["checked"],ut=["disabled"],it={class:"overflow-auto border rounded"},dt={class:"table-auto w-full text-xs md:text-sm"},ct={class:"sticky top-0 bg-white z-10"},vt=["title"],ft={class:"font-medium leading-none"},mt={class:"text-[9px] md:text-[10px] text-gray-500"},pt={class:"border p-2 sticky-col-1 bg-inherit z-10"},ht={class:"flex items-center gap-2"},yt=["value"],bt={class:"min-w-0"},gt={class:"font-medium leading-tight truncate max-w-[150px]"},xt={class:"border p-1 md:p-2 sticky-col-2 bg-inherit z-10 text-center"},St=["onClick","disabled"],_t=["onClick","title"],kt={key:0},wt={class:"flex justify-center mt-4 md:mt-5"},Et=["disabled"],Ct={__name:"ShiftScheduleForm",setup(L){const C=He(),ae=Ye(),Y=Te(),Q=Qe(),g=$e(),u=je(),{defaultShift:D}=X(C),{employees:N}=X(ae),{shifts:T}=X(Y),m=d(le().format("YYYY-MM")),y=d(""),b=d(""),x=d(""),c=d(""),r=d({}),S=d([]),_=d(""),se=d(!1),V=d(!1),A=d([]),q=d(!1),M=d(null),z=d({WEEKEND:"#B91C1C",HOLIDAY:"#6B7280"}),ne=["#FF5733","#33C1FF","#33FF57","#FF33D4","#FFD633","#7D33FF","#FF8C33","#33FFF0","#B833FF","#3375FF","#FF3333","#33FFAA"],oe=t=>e=>(e||[]).find(s=>Number(s==null?void 0:s.id)===Number(t)),H=j(()=>{const t=T.value||{};return Array.isArray(t)?t:Object.values(t).flat()});function re(){let t=0;H.value.forEach(e=>{const s=String(e.id);z.value[s]||(z.value[s]=ne[t%ne.length],t++)})}const R=j(()=>Array.from({length:le(m.value).daysInMonth()},(t,e)=>e+1)),ue=t=>{const e=`${m.value}-${String(t).padStart(2,"0")}`;return le(e).format("ddd")},v=j(()=>(S.value||[]).map(t=>Number(t)).filter(Number.isFinite)),ie=j(()=>new Set(v.value)),$=t=>ie.value.has(Number(t)),i=t=>String(t),me=(t,e)=>{var n,o;const s=(o=(n=r.value)==null?void 0:n[i(t)])==null?void 0:o[e];return s?{backgroundColor:z.value[String(s)]||"#D1D5DB"}:{backgroundColor:"#E5E7EB"}},pe=(t,e)=>{var n,o;const s=(o=(n=r.value)==null?void 0:n[i(t)])==null?void 0:o[e];if(s==="WEEKEND"||s==="HOLIDAY")return s;const l=oe(s)(H.value);return(l==null?void 0:l.name)||""},he=(t,e)=>{const s=`${m.value}-${String(e).padStart(2,"0")}`,l=pe(t,e);return l?`${s} — ${l}`:$(t)?`${s} — Click to set shift`:`${s} — Check this employee to edit`};function ye(t,e){$(t)&&c.value&&(r.value[i(t)]||(r.value[i(t)]={}),r.value[i(t)][e]=c.value)}function de(t){$(t)&&c.value&&(r.value[i(t)]||(r.value[i(t)]={}),R.value.forEach(e=>{r.value[i(t)][e]=c.value}))}function be(){!v.value.length||!c.value||v.value.forEach(de)}function ge(){v.value.length&&v.value.forEach(t=>{var l;const e=oe(t)(A.value),s=(((l=e==null?void 0:e.assign_weekend)==null?void 0:l.weekends)||[]).map(n=>String(n).slice(0,3));r.value[i(t)]||(r.value[i(t)]={}),R.value.forEach(n=>{const o=ue(n);s.includes(o)&&(r.value[i(t)][n]="WEEKEND")})})}function xe(){v.value.length&&v.value.forEach(t=>{r.value[i(t)]&&(r.value[i(t)]={})})}async function ce(){if(!v.value.length){alert("Select at least one employee.");return}const t=[];for(const[e,s]of Object.entries(r.value||{})){const l=Number(e);if(ie.value.has(l))for(const[n,o]of Object.entries(s||{})){const w=Number(n);if(!w||!o)continue;const k=`${m.value}-${String(w).padStart(2,"0")}`;let F=null,f=null;o==="WEEKEND"||o==="HOLIDAY"?f=o:F=Number(o),t.push({employee_id:l,date:k,shift_id:F,status:f})}}if(!t.length){alert("No schedule data to save for checked employees.");return}try{await C.saveSchedules({payload:t}),alert("Shift schedule saved successfully!")}catch(e){console.error("Failed to save schedule",e),alert("Something went wrong while saving.")}}function Se({companyId:t,departmentId:e,lineType:s,month:l}){return[t||"",e||"",s||"all",l||""].join("-")}async function _e({companyId:t,departmentId:e,lineType:s,month:l}){if(!t||!e||!l||s==="all"){r.value={};return}const n={companyId:Number(t)||null,departmentId:Number(e)||null,lineType:s&&s!=="all"?s:"all",month:l},o=Se(n);if(M.value!==o){M.value=o,q.value=!0,D.value=!1,r.value={};try{const w={company_id:n.companyId,department_id:n.departmentId,month:n.month};n.lineType&&n.lineType!=="all"&&(w.line_type=n.lineType);let k=await C.fetchSchedules({params:w});if(k=Array.isArray(k)?k:k||[],!k.length){const f=await C.fetchDefaultSchedules({params:w}),E=Array.isArray(f)?f:f||[];E.length&&(console.warn("[Fallback Schedule Loaded]",E),D.value=!0,k=E,alert("No saved schedule found. Default schedule loaded."))}const F={};k.forEach(f=>{const E=Number(f==null?void 0:f.employee_id),De=String((f==null?void 0:f.date)||"").split("-")[2],ve=Number(De);!E||!ve||(F[i(E)]||(F[i(E)]={}),F[i(E)][ve]=f.shift_id??f.status)}),M.value===o&&(r.value=F)}catch(w){console.error("Failed to load schedule data:",w),alert("Error loading schedule. Please try again or contact admin.")}finally{M.value===o&&(q.value=!1)}}}async function G(t){if(!t)return A.value=[],N.value=[],S.value=[],[];const e=await Q.fetchDepartmentEmployee([Number(t)],_.value),s=Array.isArray(e)?e:Array.isArray(e==null?void 0:e.data)?e.data:[];return A.value=s,N.value=s,S.value=S.value.filter(l=>s.some(n=>Number(n==null?void 0:n.id)===Number(l))),s}function ke(t=m.value){return!!(y.value&&b.value&&t)}async function U(t){const e=t||m.value;ke(e)&&await _e({companyId:y.value,departmentId:b.value,lineType:_.value,month:e})}const we=j(()=>({company_id:y.value,department_id:b.value,line_type:_.value,employee_id:x.value,month:m.value})),Ee=t=>Object.fromEntries(Object.entries(t||{}).filter(([,e])=>e!==""&&e!==null&&e!==void 0));function Ce(t={}){const e={...u.query,...t},s=Ee(e);Object.keys(s).length===Object.keys(u.query).length&&Object.entries(s).every(([n,o])=>String(u.query[n]??"")===String(o??""))||g.replace({query:s}).catch(()=>{})}function Ne(t=u.query){V.value=!0,y.value=t.company_id||"",b.value=t.department_id||"",x.value=t.employee_id||"",_.value=t.line_type||"all",m.value=t.month||m.value,V.value=!1,se.value=!0}Oe(async()=>{Ne(),y.value&&(await Promise.all([Q.fetchDepartments({company_id:Number(y.value)}),Y.fetchShifts({company_id:Number(y.value)})]),re()),y.value&&b.value&&(await G(b.value),await U())}),W(y,async t=>{t&&(b.value="",S.value=[],x.value="",A.value=[],N.value=[],r.value={},_.value="all",M.value=null,await Promise.all([Q.fetchDepartments({company_id:Number(t)}),Y.fetchShifts({company_id:Number(t)})]),re())}),W(b,async t=>{t&&(V.value||(x.value=""),await G(t),await U())}),W(_,async()=>{!y.value||!b.value||(await G(b.value),await U())}),W(m,async t=>{await U(t)}),W(we,t=>{!se.value||V.value||Ce(t)},{deep:!0});const I=j(()=>{const t=A.value.length?A.value:N.value||[];if(!x.value)return t;const e=Number(x.value);return t.filter(s=>Number(s==null?void 0:s.id)===e)});function Fe(t){t?S.value=I.value.map(e=>Number(e.id)):S.value=[]}return(t,e)=>{var s;return h(),p("div",Re,[a("div",Ue,[e[11]||(e[11]=a("h2",{class:"text-xl md:text-2xl font-semibold"}," Monthly Shift Schedule Plan ",-1)),a("div",Ie,[e[10]||(e[10]=a("span",null,"Month:",-1)),a("span",Pe,O(m.value),1)])]),a("div",qe,[Me(Le,{company_id:y.value,"onUpdate:company_id":e[0]||(e[0]=l=>y.value=l),department_id:b.value,"onUpdate:department_id":e[1]||(e[1]=l=>b.value=l),line_type:_.value,"onUpdate:line_type":e[2]||(e[2]=l=>_.value=l),employee_id:x.value,"onUpdate:employee_id":e[3]||(e[3]=l=>x.value=l),"initial-value":{company_id:y.value,department_id:b.value,line_type:_.value,employee_id:x.value}},null,8,["company_id","department_id","line_type","employee_id","initial-value"]),ee(a("select",{"onUpdate:modelValue":e[4]||(e[4]=l=>c.value=l),class:"px-2 py-2 border rounded text-sm"},[e[12]||(e[12]=a("option",{value:""},"- Pick a Shift -",-1)),(h(!0),p(B,null,K(H.value,l=>(h(),p("option",{key:l.id,value:l.id},O(l.name),9,Ge))),128))],512),[[ze,c.value]]),ee(a("input",{type:"month","onUpdate:modelValue":e[5]||(e[5]=l=>m.value=l),class:"h-10 px-2 border rounded text-sm"},null,512),[[We,m.value]])]),a("div",Je,[e[14]||(e[14]=a("div",{class:"text-xs md:text-sm text-sky-800 bg-sky-50 border border-sky-200 rounded px-2 py-1"},[fe(" ✔ Only "),a("b",null,"checked"),fe(" employees are editable & will be saved. ")],-1)),q.value?(h(),p("div",Xe,e[13]||(e[13]=[a("span",{class:"inline-block w-2 h-2 rounded-full border-2 border-gray-400 border-t-transparent animate-spin"},null,-1),a("span",null,"Loading schedule...",-1)]))):Z("",!0)]),Be(D)?(h(),p("p",Ze," ⚠ Showing default schedule from current shift. Select employees manually before saving. ")):Z("",!0),a("div",et,[(h(!0),p(B,null,K(H.value,l=>(h(),p("div",{key:l.id,class:P(["flex items-center gap-2 cursor-pointer px-2 py-1 rounded border hover:bg-gray-50 text-xs md:text-sm",{"ring-2 ring-blue-500":String(c.value)===String(l.id)}]),onClick:n=>c.value=l.id},[a("div",{class:"w-4 h-4 rounded",style:te({backgroundColor:z.value[String(l.id)]||"#ccc"})},null,4),a("span",null,O(l.name),1)],10,tt))),128)),a("div",{class:P(["flex items-center gap-2 cursor-pointer px-2 py-1 rounded border hover:bg-gray-50 text-xs md:text-sm",{"ring-2 ring-blue-500":c.value==="HOLIDAY"}]),onClick:e[6]||(e[6]=l=>c.value="HOLIDAY")},e[15]||(e[15]=[a("div",{class:"w-4 h-4 rounded bg-gray-500"},null,-1),a("span",null,"Holiday",-1)]),2),a("div",{class:P(["flex items-center gap-2 cursor-pointer px-2 py-1 rounded border hover:bg-gray-50 text-xs md:text-sm",{"ring-2 ring-blue-500":c.value==="WEEKEND"}]),onClick:e[7]||(e[7]=l=>c.value="WEEKEND")},[a("div",{class:"w-4 h-4 rounded",style:te({backgroundColor:z.value.WEEKEND})},null,4),e[16]||(e[16]=a("span",null,"Weekend",-1))],2)]),a("div",lt,[a("button",{onClick:be,class:"btn-4 bg-indigo-600 hover:bg-indigo-700 text-white text-xs md:text-sm",disabled:!v.value.length||!c.value,title:"Set selected shift to all days for checked employees"}," Set Shift → Checked (All Dates) ",8,at),a("button",{onClick:ge,class:"btn-4 bg-red-700 hover:bg-red-800 text-white text-xs md:text-sm",disabled:!v.value.length,title:"Mark employee-specific weekends for checked employees"}," Set Weekends → Checked ",8,st),a("button",{onClick:xe,class:"btn-4 bg-gray-700 hover:bg-gray-800 text-white text-xs md:text-sm",disabled:!v.value.length}," Clear (Checked) ",8,nt),a("label",ot,[a("input",{type:"checkbox",checked:v.value.length&&v.value.length===I.value.length,onChange:e[8]||(e[8]=l=>Fe(l.target.checked))},null,40,rt),e[17]||(e[17]=a("span",null,"Select all (visible)",-1))]),a("button",{onClick:ce,class:"btn-2 text-xs md:text-sm",disabled:!v.value.length,title:"Saves only checked employees"}," Save (Checked only) ",8,ut)]),a("div",it,[a("table",dt,[a("thead",ct,[a("tr",null,[e[18]||(e[18]=a("th",{class:"border p-2 w-40 sticky-col-1 text-left bg-white z-50"}," Employee ",-1)),e[19]||(e[19]=a("th",{class:"border p-2 w-32 sticky-col-2 text-center bg-white z-50"}," Quick Action ",-1)),(h(!0),p(B,null,K(R.value,l=>(h(),p("th",{key:l,class:"border text-center p-1 min-w-[32px] md:min-w-[40px]",title:`${m.value}-${String(l).padStart(2,"0")}`},[a("div",ft,O(l),1),a("div",mt,O(ue(l)),1)],8,vt))),128))])]),a("tbody",null,[(h(!0),p(B,null,K(I.value,l=>(h(),p("tr",{key:l.id,class:"odd:bg-white even:bg-gray-50"},[a("td",pt,[a("label",ht,[ee(a("input",{type:"checkbox",class:"rounded",value:l.id,"onUpdate:modelValue":e[9]||(e[9]=n=>S.value=n)},null,8,yt),[[Ke,S.value]]),a("div",bt,[a("div",gt,O(l.name),1)])])]),a("td",xt,[a("button",{class:"btn-4 cursor-pointer text-[11px] md:text-xs px-2 py-1",onClick:n=>de(l.id),disabled:!c.value||!$(l.id)}," Apply to all ",8,St)]),(h(!0),p(B,null,K(R.value,n=>(h(),p("td",{key:n,class:P(["border text-center",["border text-center",$(l.id)?"cursor-pointer hover:bg-gray-100":"cursor-default opacity-70"]]),onClick:o=>$(l.id)&&ye(l.id,n),title:he(l.id,n)},[a("div",{style:te(me(l.id,n)),class:"w-full h-5 md:h-6 rounded transition"},null,4)],10,_t))),128))]))),128)),(s=I.value)!=null&&s.length?Z("",!0):(h(),p("tr",kt,e[20]||(e[20]=[a("td",{colspan:"999",class:"text-center text-gray-500 p-6"}," No employees found for current filter. ",-1)])))])])]),a("div",wt,[a("button",{onClick:ce,class:"btn-2 text-xs md:text-sm",disabled:!v.value.length,title:"Saves only checked employees"}," Save (Checked only) ",8,Et)])])}}},Bt=Ve(Ct,[["__scopeId","data-v-cfd02597"]]);export{Bt as default};
