import{S as q,Q as k,r as m,e as R,K as H,c,o as p,g as V,h as I,a as t,t as b,v as K,F as U,y as D,x as O,P,m as J,A as Q,B as G,k as z,p as W}from"./index-DKvvHbAy.js";const X=q("kpiAdmin",{state:()=>({cycles:[],lanesConfig:null,overrides:[],loading:!1,_userCache:new Map,_abortCtrls:{}}),actions:{async fetchCycles(){this.loading=!0;try{const{data:n}=await k.get("/kpi/cycles");this.cycles=n}finally{this.loading=!1}},async loadCycle(n){const{data:s}=await k.get(`/kpi/cycles/${n}`);return this.lanesConfig=s.reviewer_lanes_json||[],s},async updateLanes(n,s){const{data:o}=await k.put(`/kpi/cycles/${n}/lanes`,{reviewer_lanes_json:s});return this.lanesConfig=o.reviewer_lanes_json,o},async fetchOverrides(n){const{data:s}=await k.get("/kpi/overrides",{params:n});return this.overrides=s,s},async saveOverridesBulk(n){return(await k.post("/kpi/overrides/save-bulk",n)).data},async lookupUsers(n){var r;const s=typeof n=="string"?{q:n}:n||{},o=JSON.stringify({q:s.q||"",lane_key:s.lane_key});if(this._userCache.has(o))return this._userCache.get(o);this._abortCtrls[o]&&this._abortCtrls[o].abort();const u=new AbortController;this._abortCtrls[o]=u;try{const{data:i}=await k.get("/users",{params:s,signal:u.signal});return this._userCache.set(o,i),setTimeout(()=>this._userCache.delete(o),6e4),i}catch(i){if(i.name==="CanceledError"||(r=i.message)!=null&&r.includes("canceled"))return[];throw i}finally{delete this._abortCtrls[o]}},async lookupDepartments(n){const{data:s}=await k.get("/departments",{params:{q:n}});return s}}}),Y={key:0,class:"mb-2 inline-flex items-center gap-2 rounded-full border px-3 py-1"},Z={class:"text-sm"},ee={class:"text-[11px] text-slate-500"},te=["placeholder"],le={key:1,class:"absolute left-0 mt-1 border bg-white rounded-lg shadow max-h-56 overflow-auto w-[28rem] max-w-[90vw] z-20"},ae={key:0,class:"px-3 py-2 text-slate-500 text-sm"},se=["onClick"],ne=["innerHTML"],oe={class:"text-[11px] text-slate-500"},ue={key:0,class:"px-3 py-2 text-slate-400 text-sm"};function ie(n,s){if(!s)return n;try{const o=new RegExp(`(${s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"ig");return(n==null?void 0:n.replace(o,"<mark>$1</mark>"))??""}catch{return n}}const re={__name:"AsyncUserCombobox",props:{modelValue:{type:[Number,null],default:null},display:{type:Object,default:()=>({name:null,dept:null})},placeholder:{type:String,default:"Search user…"},fetcher:{type:Function,required:!0},laneKey:{type:String,default:null},departmentId:{type:[Number,null],default:null},limit:{type:Number,default:20}},emits:["update:modelValue","update:display","cleared"],setup(n,{emit:s}){const o=n,u=s,r=m(!1),i=m(""),_=m([]),x=m(!1),f=m(-1);let w=null;async function C(){x.value=!0;const v=await o.fetcher({q:i.value,lane_key:o.laneKey,limit:o.limit});_.value=v,x.value=!1,f.value=v.length?0:-1}function g(){clearTimeout(w),w=setTimeout(C,250)}function E(){r.value=!0,i.value||g()}function S(v){if(!r.value)return;const y=_.value.length;v.key==="ArrowDown"?(v.preventDefault(),y&&(f.value=(f.value+1)%y)):v.key==="ArrowUp"?(v.preventDefault(),y&&(f.value=(f.value-1+y)%y)):v.key==="Enter"?(v.preventDefault(),y&&f.value>=0&&L(_.value[f.value])):v.key==="Escape"&&(r.value=!1)}function L(v){u("update:modelValue",v.id),u("update:display",{name:v.name,dept:v.department_name||null}),r.value=!1,i.value="",_.value=[]}function B(){u("update:modelValue",null),u("update:display",{name:null,dept:null}),u("cleared")}function A(v){const y=$.value;y&&!y.contains(v.target)&&(r.value=!1)}const $=m(null);return R(()=>document.addEventListener("click",A)),H(()=>document.removeEventListener("click",A)),(v,y)=>{var N,j;return p(),c("div",{ref_key:"wrapper",ref:$,class:"relative"},[n.modelValue?(p(),c("div",Y,[t("span",Z,b(((N=n.display)==null?void 0:N.name)||"User #"+n.modelValue),1),t("span",ee,b(((j=n.display)==null?void 0:j.dept)||""),1),t("button",{onClick:B,class:"text-xs px-2 py-0.5 rounded border hover:bg-slate-50"},"Clear")])):V("",!0),I(t("input",{placeholder:n.placeholder,class:"border rounded-lg px-3 py-2 w-[28rem] max-w-full","onUpdate:modelValue":y[0]||(y[0]=a=>i.value=a),onFocus:E,onInput:g,onKeydown:S},null,40,te),[[K,i.value]]),r.value?(p(),c("div",le,[x.value?(p(),c("div",ae,"Searching…")):(p(),c(U,{key:1},[(p(!0),c(U,null,D(_.value,(a,l)=>(p(),c("button",{key:a.id,onClick:e=>L(a),class:O(["flex w-full items-center justify-between px-3 py-2 text-left hover:bg-slate-50",l===f.value?"bg-slate-50":""])},[t("span",{innerHTML:ie(a.name,i.value)},null,8,ne),t("span",oe,b(a.id||"N/A"),1)],10,se))),128)),_.value.length?V("",!0):(p(),c("div",ue,"No results"))],64))])):V("",!0)],512)}}},de={class:"max-w-6xl mx-auto p-4 space-y-5"},ce={class:"sticky top-0 z-10 bg-white/85 backdrop-blur border-b -mx-4 px-4"},pe={class:"flex flex-col gap-2 py-3"},ve={class:"flex items-center justify-between gap-3"},me={class:"text-xs text-slate-600"},ye={key:0,class:"ml-2 inline-flex items-center text-amber-700"},_e={class:"flex items-center gap-2"},fe=["value"],ge={class:"flex items-center justify-between"},he={class:"inline-flex rounded-xl border overflow-hidden"},be={class:"flex items-center gap-2"},xe=["disabled"],ke={class:"grid md:grid-cols-2 gap-4"},we={key:0,class:"rounded-2xl border p-4"},Ce={class:"relative"},Se={key:0,class:"absolute mt-1 border bg-white rounded-lg shadow max-h-56 overflow-auto w-full md:w-96 z-20"},$e=["onClick"],Ue={class:"text-xs text-slate-500"},Ve={key:1,class:"rounded-2xl border p-4"},De={class:"relative"},Ee={key:0,class:"absolute mt-1 border bg-white rounded-lg shadow max-h-56 overflow-auto w-full md:w-[26rem] z-20"},Le=["onClick"],Ae={class:"text-xs text-slate-500"},Ne={class:"rounded-2xl border overflow-auto card-bg"},je={class:"w-full text-sm"},Ie={class:"px-3 py-2"},Oe={class:"font-medium"},Be={class:"text-[11px] text-slate-500"},Ke={class:"px-3 py-3"},Fe={__name:"LaneOverridesPage",setup(n){const s=X(),o=m(null),u=m("department"),r=m(null),i=m(null),_=m([]),x=m(""),f=m([]),w=m(""),C=m([]),g=m(!1);R(async()=>{await s.fetchCycles(),s.cycles.length&&(o.value=s.cycles[0].id,await S()),window.addEventListener("beforeunload",E)});function E(a){g.value&&(a.preventDefault(),a.returnValue="")}P(()=>window.removeEventListener("beforeunload",E));async function S(){await s.loadCycle(o.value),_.value=(s.lanesConfig||[]).map(a=>({lane_key:a.key,label:a.label,assigned_user_id:null,assignee_name:null,assignee_dept:null})),g.value=!1,(u.value==="department"&&r.value||u.value==="employee"&&i.value)&&await $()}async function L(){f.value=await s.lookupDepartments(x.value)}async function B(){C.value=await s.lookupUsers(w.value)}const A=J(()=>u.value==="department"?r.value?`Dept: ${r.value.name}`:"Select a department":i.value?`Employee: ${i.value.name}`:"Select an employee");async function $(){const a={cycle_id:o.value,scope:u.value};u.value==="department"&&r.value&&(a.department_id=r.value.id),u.value==="employee"&&i.value&&(a.employee_id=i.value.id);const l=await s.fetchOverrides(a),e={};(l.data||[]).forEach(d=>{var h,T,F,M;e[d.lane_key]={id:d.assigned_user_id,name:((h=d.assignee)==null?void 0:h.name)||null,dept:((F=(T=d.assignee)==null?void 0:T.department)==null?void 0:F.name)||(((M=d.assignee)==null?void 0:M.department_name)??null)}}),_.value=(s.lanesConfig||[]).map(d=>{const h=e[d.key]||null;return{lane_key:d.key,label:d.label,assigned_user_id:(h==null?void 0:h.id)??null,assignee_name:(h==null?void 0:h.name)??null,assignee_dept:(h==null?void 0:h.dept)??null}}),g.value=!1}function v(a,l,e){a.assigned_user_id=l,a.assignee_name=(e==null?void 0:e.name)||null,a.assignee_dept=(e==null?void 0:e.dept)||null,g.value=!0}function y(a){a.assigned_user_id=null,a.assignee_name=null,a.assignee_dept=null,g.value=!0}function N(){const a=_.value.find(l=>l.assigned_user_id);a&&(_.value.forEach(l=>{l.assigned_user_id||(l.assigned_user_id=a.assigned_user_id,l.assignee_name=a.assignee_name,l.assignee_dept=a.assignee_dept)}),g.value=!0)}async function j(){var l,e;if(!o.value)return alert("Select cycle");if(u.value==="department"&&!r.value)return alert("Select department");if(u.value==="employee"&&!i.value)return alert("Select employee");const a={cycle_id:o.value,scope:u.value,department_id:u.value==="department"?(l=r==null?void 0:r.value)==null?void 0:l.id:null,employee_id:u.value==="employee"?(e=i==null?void 0:i.value)==null?void 0:e.id:null,overrides:_.value.map(d=>({lane_key:d.lane_key,assigned_user_id:d.assigned_user_id}))};try{await s.saveOverridesBulk(a),g.value=!1,alert("Saved!")}catch(d){console.error(d),alert("Failed to save")}}return Q([u,o],()=>{r.value=null,i.value=null,S()}),(a,l)=>(p(),c("div",de,[t("header",ce,[t("div",pe,[t("div",ve,[t("div",null,[l[5]||(l[5]=t("h1",{class:"text-lg md:text-xl font-semibold"},"KPI — Permissions",-1)),t("div",me,[t("span",null,b(A.value),1),g.value?(p(),c("span",ye,"• Unsaved changes")):V("",!0)])]),t("div",_e,[I(t("select",{"onUpdate:modelValue":l[0]||(l[0]=e=>o.value=e),onChange:S,class:"border rounded-lg px-3 py-2 bg-white"},[(p(!0),c(U,null,D(z(s).cycles,e=>(p(),c("option",{value:e.id,key:e.id},b(e.title)+" ("+b(e.year)+")",9,fe))),128))],544),[[G,o.value]]),t("button",{onClick:S,class:"px-3 py-2 border rounded-lg hover:bg-slate-50"},"Reload")])]),t("div",ge,[t("div",he,[t("button",{onClick:l[1]||(l[1]=e=>u.value="department"),class:O(["px-4 py-2 text-sm",u.value==="department"?"bg-slate-900 text-white":"bg-white"])},"Department",2),t("button",{onClick:l[2]||(l[2]=e=>u.value="employee"),class:O(["px-4 py-2 text-sm border-l",u.value==="employee"?"bg-slate-900 text-white":"bg-white"])},"Employee",2)]),t("div",be,[t("button",{onClick:N,class:"px-3 py-1.5 border rounded-lg hover:bg-slate-50"},"Apply to all empty lanes"),t("button",{onClick:j,disabled:!o.value||(u.value==="department"?!r.value:!i.value)||!g.value,class:O(["px-4 py-2 rounded-xl text-white",g.value?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-400 cursor-not-allowed"])}," Save Overrides ",10,xe)])])])]),t("div",ke,[u.value==="department"?(p(),c("div",we,[l[6]||(l[6]=t("div",{class:"text-sm mb-2 font-medium"},"Select Department",-1)),t("div",Ce,[I(t("input",{"onUpdate:modelValue":l[3]||(l[3]=e=>x.value=e),onInput:L,placeholder:"Search department…",class:"border rounded-lg px-3 py-2 w-full md:w-80"},null,544),[[K,x.value]]),f.value.length?(p(),c("div",Se,[(p(!0),c(U,null,D(f.value,e=>(p(),c("button",{key:e.id,onClick:d=>{r.value=e,f.value=[],$()},class:"flex w-full items-center justify-between px-3 py-2 hover:bg-slate-50"},[t("span",null,b(e.name),1),t("span",Ue,"ID: "+b(e.id),1)],8,$e))),128))])):V("",!0)])])):(p(),c("div",Ve,[l[7]||(l[7]=t("div",{class:"text-sm mb-2 font-medium"},"Select Employee",-1)),t("div",De,[I(t("input",{"onUpdate:modelValue":l[4]||(l[4]=e=>w.value=e),onInput:B,placeholder:"Search employee…",class:"border rounded-lg px-3 py-2 w-full md:w-[26rem]"},null,544),[[K,w.value]]),C.value.length?(p(),c("div",Ee,[(p(!0),c(U,null,D(C.value,e=>(p(),c("button",{key:e.id,onClick:d=>{i.value=e,C.value=[],$()},class:"flex w-full items-center justify-between px-3 py-2 hover:bg-slate-50"},[t("span",null,b(e.name),1),t("span",Ae,b(e.department_name||"N/A"),1)],8,Le))),128))])):V("",!0)])]))]),t("div",Ne,[t("table",je,[l[8]||(l[8]=t("thead",{class:"bg-slate-50"},[t("tr",null,[t("th",{class:"text-left px-3 py-2 w-[28%]"},"Lane"),t("th",{class:"text-left px-3 py-2"},"Assignee")])],-1)),t("tbody",null,[(p(!0),c(U,null,D(_.value,e=>(p(),c("tr",{key:e.lane_key,class:"border-t p-4"},[t("td",Ie,[t("div",Oe,b(e.label),1),t("div",Be,b(e.lane_key),1)]),t("td",Ke,[W(re,{"model-value":e.assigned_user_id,display:{name:e.assignee_name,dept:e.assignee_dept},"lane-key":e.lane_key,fetcher:d=>z(s).lookupUsers(d),placeholder:"Search user for this lane…","onUpdate:modelValue":d=>v(e,d,{name:e.assignee_name,dept:e.assignee_dept}),"onUpdate:display":d=>v(e,e.assigned_user_id,d),onCleared:()=>y(e)},null,8,["model-value","display","lane-key","fetcher","onUpdate:modelValue","onUpdate:display","onCleared"])])]))),128))])])])]))}};export{Fe as default};
