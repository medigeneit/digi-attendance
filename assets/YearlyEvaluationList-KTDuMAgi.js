import{Q as de,u as oe,f as re,D as ue,r as k,x as b,q as z,h as pe,A as ce,c as _,o as v,a as s,t as r,d as T,k as M,v as me,z as _e,H as ve,m as C,j as N,F as ye,e as fe,b as xe,s as Y}from"./index-DkacTpiq.js";import{L as H}from"./LoaderView-DEZmrm44.js";import{_ as be}from"./EmployeeFilter-BpzK1cyp.js";import{u as ge}from"./kpi-B-mJCzxH.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./company-BINqcgNu.js";import"./department-CqBpxssv.js";import"./EmployeeDropdownInput-DN-BG7l0.js";import"./SelectDropdown-BiIMMPZ8.js";import"./UserChip-cgOZpsWj.js";const he={class:"space-y-4 px-4 max-w-7xl mx-auto my-6"},ke={class:"sticky top-0 z-10 -mx-4 px-4 bg-white/80 backdrop-blur border-b"},qe={class:"flex flex-col gap-3 py-3 md:flex-row md:items-center md:justify-between"},Se={class:"flex items-center gap-2"},ze={class:"hidden md:flex items-center gap-2 text-xs"},Ce={class:"px-2 py-1 rounded-full bg-slate-100 text-slate-700"},Ne={class:"px-2 py-1 rounded-full bg-emerald-100 text-emerald-700"},Ue={class:"px-2 py-1 rounded-full bg-amber-100 text-amber-700"},Re={class:"px-2 py-1 rounded-full bg-slate-100 text-slate-700"},Ae=["disabled"],Be={class:"rounded-xl border bg-white p-4 md:p-5 shadow-sm"},Te={class:"grid gap-4 md:grid-cols-12"},De={class:"col-span-full"},Fe={class:"md:col-span-4"},je=["placeholder","disabled"],Ee={class:"md:col-span-2"},Le={class:"md:col-span-1"},Ve={class:"md:col-span-2 flex items-end justify-end gap-2"},$e=["disabled"],Ke={key:0,class:"py-8 text-center"},Oe={key:1,class:"rounded-md border border-red-200 bg-red-50 p-3 text-red-700"},Ie={key:2,class:"relative overflow-x-auto rounded-xl border bg-white shadow-sm"},Ge={key:0,class:"absolute inset-0 grid place-items-center bg-white/50 backdrop-blur-[1px] z-10","aria-live":"polite","aria-busy":"true"},Pe={class:"min-w-full text-sm"},Me={class:"px-3 py-2"},Ye={class:"px-3 py-2"},He={class:"flex items-center gap-3"},Je={class:"h-8 w-8 rounded-full bg-slate-200 grid place-items-center text-xs font-medium text-slate-700"},Qe={class:"font-medium text-slate-900"},We={class:"text-[11px] text-slate-500"},Xe={key:0,class:"mx-1"},Ze={key:1},we={class:"px-3 py-2"},et={class:"px-3 py-2"},tt={class:"px-3 py-2"},st={class:"px-3 py-2 text-right"},at={class:"flex items-center justify-end gap-2"},lt=["onClick"],nt={key:0},it={colspan:"6",class:"px-3 py-6 text-center text-gray-600"},xt={__name:"YearlyEvaluationList",setup(dt){const D=de(),F=oe(),o=re(),j=ge(),{users:q,loading:J,error:E,usersError:L}=ue(j),a=k({company_id:o.query.company_id?Number(o.query.company_id):"",department_id:o.query.department_id?Number(o.query.department_id):"",employee_id:o.query.employee_id?Number(o.query.employee_id):"",line_type:o.query.line_type??"",user_id:o.query.user_id?Number(o.query.user_id):"",finalized:o.query.finalized??"",q:o.query.q??""}),c=k(o.query.sortBy||"name"),y=k(o.query.sortDir||"asc");let V=null,U=0,$="";const R=k(!1),K=k([]),m=b(()=>!!a.value.company_id&&!!a.value.department_id),Q=b(()=>m.value||a.value.finalized!==""||!!a.value.line_type||!!a.value.q),W=b(()=>J.value),g=b(()=>m.value?Array.isArray(q.value)?q.value:[]:K.value),S=b(()=>{var u;let n=g.value.length,e=0,t=0,d=0;for(const p of g.value){const l=(u=p==null?void 0:p.latest_kpi_result)==null?void 0:u.status;l==="finalized"||l==="approved"?e++:l==="in_progress"||l==="draft"?t++:d++}return{total:n,fin:e,prog:t,none:d}}),h=b(()=>{const n=[...g.value],e=y.value==="desc"?-1:1,t=c.value,d=l=>{var i;return Number(((i=l==null?void 0:l.latest_kpi_result)==null?void 0:i.final_obtained)??-1/0)},u=l=>{var i;return String(((i=l==null?void 0:l.latest_kpi_result)==null?void 0:i.grade)??"")},p=l=>{var f;const i=(f=l==null?void 0:l.latest_kpi_result)==null?void 0:f.status;return i==="finalized"||i==="approved"?0:i==="in_progress"||i==="draft"?1:2};return n.sort((l,i)=>{if(t==="score")return(d(l)>d(i)?1:d(l)<d(i)?-1:0)*e;if(t==="grade")return u(l).localeCompare(u(i))*e;if(t==="status")return(p(l)-p(i))*e;const f=String((l==null?void 0:l.name)??""),B=String((i==null?void 0:i.name)??"");return f.localeCompare(B)*e}),n});function x(){F.replace({query:{company_id:a.value.company_id||void 0,department_id:a.value.department_id||void 0,line_type:a.value.line_type||void 0,user_id:a.value.user_id||void 0,employee_id:a.value.employee_id||void 0,finalized:a.value.finalized||void 0,q:a.value.q||void 0,sortBy:c.value!=="name"?c.value:void 0,sortDir:y.value!=="asc"?y.value:void 0}}).catch(()=>{})}function X(){clearTimeout(V),V=setTimeout(()=>{m.value&&x()},350)}z(()=>o.fullPath,async()=>{const n=o.query;a.value.company_id=n.company_id?Number(n.company_id):"",a.value.department_id=n.department_id?Number(n.department_id):"",a.value.employee_id=n.employee_id?Number(n.employee_id):"",a.value.user_id=n.user_id?Number(n.user_id):"",a.value.line_type=n.line_type??"",a.value.finalized=n.finalized??"",a.value.q=n.q??"",c.value=n.sortBy||"name",y.value=n.sortDir||"asc",m.value&&await O()});function Z(){return{company_id:a.value.company_id,department_id:a.value.department_id||void 0,employee_id:a.value.employee_id||void 0,user_id:a.value.user_id||void 0,line_type:a.value.line_type||void 0,finalized:a.value.finalized,q:a.value.q||void 0}}async function O(){const n=Z(),e=JSON.stringify(n);if(e===$)return;$=e;const t=++U;R.value=g.value.length>0;try{const d=await j.fetchUsers(n);if(t!==U)return;const u=Array.isArray(d)?d:Array.isArray(q.value)?q.value:[];K.value=[...u]}catch(d){console.error(d),D.error("Failed to load users.")}finally{t===U&&(R.value=!1)}}function w(){a.value.user_id=a.value.employee_id||"",x()}function ee(){if(!m.value)return D.error("Select Company & Department");x()}function te(){a.value={company_id:"",department_id:"",employee_id:"",line_type:"",user_id:"",finalized:"",q:""},c.value="name",y.value="asc",x()}function I(n){c.value===n?y.value=y.value==="asc"?"desc":"asc":(c.value=n,y.value="asc"),x()}function se(n){const e=n==null?void 0:n.id;e&&F.push({name:"KpiReview",params:{employeeId:e}})}function A(n){var t;const e=(t=n==null?void 0:n.latest_kpi_result)==null?void 0:t.status;return e==="finalized"||e==="approved"?{label:"Finalized",cls:"bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200"}:e==="in_progress"||e==="draft"?{label:"In progress",cls:"bg-amber-100 text-amber-700 ring-1 ring-amber-200"}:{label:"Not evaluated",cls:"bg-slate-100 text-slate-700 ring-1 ring-slate-200"}}function ae(n){const e=String(n||"").toUpperCase();return["A+","A"].includes(e)?"bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200":["A-","B+","B"].includes(e)?"bg-sky-50 text-sky-700 ring-1 ring-sky-200":["B-","C+","C"].includes(e)?"bg-amber-50 text-amber-700 ring-1 ring-amber-200":!e||e==="—"?"text-slate-400":"bg-rose-50 text-rose-700 ring-1 ring-rose-200"}function le(){if(!h.value.length)return;const n=["#","User","Grade","Score","Status"],e=h.value.map((l,i)=>{var G,P;const f=((G=l==null?void 0:l.latest_kpi_result)==null?void 0:G.grade)??"",B=((P=l==null?void 0:l.latest_kpi_result)==null?void 0:P.final_obtained)??"",ne=A(l).label,ie=(l==null?void 0:l.name)??`#${l==null?void 0:l.id}`;return[i+1,`"${ie.replace(/"/g,'""')}"`,f,B,ne].join(",")}),t=[n.join(","),...e].join(`
`),d=new Blob([t],{type:"text/csv;charset=utf-8;"}),u=URL.createObjectURL(d),p=document.createElement("a");p.href=u,p.download="kpi-users.csv",p.click(),URL.revokeObjectURL(u)}return z(()=>a.value.employee_id,n=>{a.value.user_id=n||""}),z(()=>a.value.q,()=>{m.value&&X()}),z(()=>[a.value.finalized,a.value.line_type],()=>{m.value&&x()}),pe(async()=>{await ce(),m.value&&await O()}),(n,e)=>(v(),_("div",he,[s("div",ke,[s("div",qe,[e[8]||(e[8]=s("div",null,[s("h1",{class:"text-lg md:text-xl font-semibold"},"User Yearly KPI Evaluations"),s("p",{class:"text-xs text-slate-600 mt-0.5"}," Filter by company/department, then refine by status or search. ")],-1)),s("div",Se,[s("div",ze,[s("span",Ce,"Total: "+r(S.value.total),1),s("span",Ne,"Finalized: "+r(S.value.fin),1),s("span",Ue,"In progress: "+r(S.value.prog),1),s("span",Re,"None: "+r(S.value.none),1)]),s("button",{class:"h-9 rounded-md border border-slate-300 px-3 text-xs md:text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-50",disabled:!h.value.length,onClick:le}," Export CSV ",8,Ae)])])]),s("div",Be,[s("div",Te,[s("div",De,[e[9]||(e[9]=s("label",{class:"mb-1 block text-sm font-medium text-slate-700"},"Employee scope",-1)),T(be,{company_id:a.value.company_id,"onUpdate:company_id":e[0]||(e[0]=t=>a.value.company_id=t),department_id:a.value.department_id,"onUpdate:department_id":e[1]||(e[1]=t=>a.value.department_id=t),employee_id:a.value.employee_id,"onUpdate:employee_id":e[2]||(e[2]=t=>a.value.employee_id=t),line_type:a.value.line_type,"onUpdate:line_type":e[3]||(e[3]=t=>a.value.line_type=t),"with-type":!0,"initial-value":{...n.$route.query},onFilterChange:w,class:"w-full"},null,8,["company_id","department_id","employee_id","line_type","initial-value"]),e[10]||(e[10]=s("p",{class:"mt-1 text-[11px] text-slate-500"},"Tip: resetting the scope keeps showing the previous results until you pick a new scope.",-1))]),s("div",Fe,[e[11]||(e[11]=s("label",{class:"mb-1 block text-sm font-medium text-slate-700"},"Search",-1)),M(s("input",{"onUpdate:modelValue":e[4]||(e[4]=t=>a.value.q=t),onKeyup:_e(ee,["enter"]),placeholder:m.value?"Search name, grade…":"Select company & department first",class:"h-9 w-full rounded-md border border-slate-300 px-3 text-sm disabled:bg-slate-100",disabled:!m.value},null,40,je),[[me,a.value.q,void 0,{trim:!0}]])]),s("div",Ee,[e[13]||(e[13]=s("label",{class:"mb-1 block text-sm font-medium text-slate-700"},"Sort by",-1)),M(s("select",{class:"h-9 w-full rounded-md border border-slate-300 px-2 text-sm","onUpdate:modelValue":e[5]||(e[5]=t=>c.value=t),onChange:e[6]||(e[6]=t=>I(c.value))},e[12]||(e[12]=[s("option",{value:"name"},"Name",-1),s("option",{value:"grade"},"Grade",-1),s("option",{value:"score"},"Score",-1),s("option",{value:"status"},"Status",-1)]),544),[[ve,c.value]])]),s("div",Le,[e[14]||(e[14]=s("label",{class:"mb-1 block text-sm font-medium text-slate-700"},"Order",-1)),s("button",{class:"h-9 w-full rounded-md border border-slate-300 text-sm hover:bg-slate-50",onClick:e[7]||(e[7]=t=>I(c.value))},r(y.value==="asc"?"Asc":"Desc"),1)]),s("div",Ve,[s("button",{class:"h-9 rounded-md border border-slate-300 px-3 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-50",disabled:!Q.value,onClick:te}," Reset ",8,$e)])])]),W.value&&!g.value.length?(v(),_("div",Ke,[T(H)])):C(L)||C(E)?(v(),_("div",Oe,r(C(L)||C(E)),1)):(v(),_("div",Ie,[R.value?(v(),_("div",Ge,[T(H)])):N("",!0),s("table",Pe,[e[15]||(e[15]=s("thead",{class:"sticky top-0 bg-gray-100"},[s("tr",{class:"text-left text-gray-700"},[s("th",{class:"px-3 py-2 w-12"},"#"),s("th",{class:"px-3 py-2"},"User"),s("th",{class:"px-3 py-2"},"Grade"),s("th",{class:"px-3 py-2"},"Score"),s("th",{class:"px-3 py-2"},"Status"),s("th",{class:"px-3 py-2 text-right w-40"},"Actions")])],-1)),s("tbody",null,[(v(!0),_(ye,null,fe(h.value,(t,d)=>{var u,p,l,i;return v(),_("tr",{key:t.id,class:"border-t hover:bg-slate-50/50"},[s("td",Me,r(d+1),1),s("td",Ye,[s("div",He,[s("div",Je,r(((t==null?void 0:t.name)||"#").slice(0,1).toUpperCase()),1),s("div",null,[s("div",Qe,r((t==null?void 0:t.name)??"#"+t.id),1),s("div",We,[xe(r(((u=t==null?void 0:t.department)==null?void 0:u.name)||"—")+" ",1),t!=null&&t.type?(v(),_("span",Xe,"•")):N("",!0),t!=null&&t.type?(v(),_("span",Ze,r(t.type),1)):N("",!0)])])])]),s("td",we,[s("span",{class:Y(["inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium",ae((p=t==null?void 0:t.latest_kpi_result)==null?void 0:p.grade)])},r(((l=t==null?void 0:t.latest_kpi_result)==null?void 0:l.grade)??"—"),3)]),s("td",et,r(((i=t==null?void 0:t.latest_kpi_result)==null?void 0:i.final_obtained)??"—"),1),s("td",tt,[s("span",{class:Y(["inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium",A(t).cls])},r(A(t).label),3)]),s("td",st,[s("div",at,[s("button",{class:"h-9 px-3 rounded-md border border-slate-300 text-sm hover:bg-slate-50",onClick:f=>se(t)}," Open ",8,lt)])])])}),128)),h.value.length?N("",!0):(v(),_("tr",nt,[s("td",it,r(m.value?"No users found for this scope.":"Select company & department to see users (previous results remain visible on reset)."),1)]))])])]))]))}};export{xt as default};
