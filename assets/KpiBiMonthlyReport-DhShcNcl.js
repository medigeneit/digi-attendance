import{G as A,H as T,I as j,B as K,r as f,p as E,e as G,c as r,o as l,a as e,h as g,v as _,A as C,j as P,k as y,y as Y,t as n,F as V,x as B,g as I}from"./index-BgZTGMd4.js";import{L as H}from"./LoaderView-CN5-aWvv.js";import{_ as O}from"./_plugin-vue_export-helper-DlAUqK2U.js";const $=A("kpi-report",{state:()=>({meta:null,rows:[],isLoading:!1,error:null}),actions:{async fetchBiMonthly(u){var i,d;this.isLoading=!0,this.error=null;try{const{data:s}=await T.get("/kpi/reports/bi-monthly",{params:u});return this.meta=(s==null?void 0:s.meta)??null,this.rows=Array.isArray(s==null?void 0:s.rows)?s.rows:Array.isArray(s==null?void 0:s.data)?s.data:[],{meta:this.meta,rows:this.rows}}catch(s){throw this.error=((d=(i=s==null?void 0:s.response)==null?void 0:i.data)==null?void 0:d.message)||"Failed to load report",s}finally{this.isLoading=!1}},async exportBiMonthly(u){var i,d,s;try{const a=await T.get("/kpi/reports/bi-monthly/export",{params:u,responseType:"blob"}),w=a.data,b=((i=a.headers)==null?void 0:i["content-disposition"])||"",c=/filename\*?=(?:UTF-8''|")?([^;\r\n"]+)/i.exec(b),x=c?decodeURIComponent(c[1].replace(/"/g,"")):`kpi-bimonthly-${(u==null?void 0:u.year)||""}.xlsx`;return{blob:w,filename:x}}catch(a){throw this.error=((s=(d=a==null?void 0:a.response)==null?void 0:d.data)==null?void 0:s.message)||"Failed to export report",a}}}}),q={class:"space-y-4 px-4 print:px-0"},z={class:"flex flex-wrap items-end gap-3 print:hidden"},J={key:0,class:"py-8 text-center"},Q={key:1,class:"rounded-md border border-red-200 bg-red-50 p-3 text-red-700"},W={key:2,class:"overflow-x-auto rounded-xl border bg-white shadow-sm"},X={class:"min-w-full text-sm"},Z={class:"bg-gray-100 text-gray-800"},ee={class:"border px-2 py-2 text-left"},te={class:"font-semibold"},se={class:"border px-2 py-2 text-center"},oe={class:"border px-2 py-2"},re={class:"flex items-center justify-center gap-3"},le={class:"inline-block w-10 text-center"},ne={class:"inline-block w-10 text-center"},ae={key:0,class:"mt-1 text-[11px] text-gray-500 text-center"},ie={class:"border px-2 py-2 text-right"},de={key:0},pe={__name:"KpiBiMonthlyReport",setup(u){j();const i=$(),{meta:d,rows:s,isLoading:a,error:w}=K(i),b=f(new Date().getFullYear()),c=f("department"),x=f(""),k=f(""),h=f("any"),D=E(()=>{var v;return((v=d.value)==null?void 0:v.periods)||[]});async function L(){await i.fetchBiMonthly({year:Number(b.value),scope:c.value,department_id:x.value?Number(x.value):void 0,form_id:k.value?Number(k.value):void 0,rule:h.value})}function M(v){return v?"✓":"—"}function R(){window.print()}return G(L),(v,t)=>{var N;return l(),r("div",q,[e("div",z,[e("div",null,[t[5]||(t[5]=e("label",{class:"text-sm text-gray-600"},"Year",-1)),g(e("input",{type:"number","onUpdate:modelValue":t[0]||(t[0]=o=>b.value=o),class:"w-28 rounded border px-2 py-1"},null,512),[[_,b.value,void 0,{number:!0}]])]),e("div",null,[t[7]||(t[7]=e("label",{class:"text-sm text-gray-600"},"Scope",-1)),g(e("select",{"onUpdate:modelValue":t[1]||(t[1]=o=>c.value=o),class:"rounded border px-2 py-1"},t[6]||(t[6]=[e("option",{value:"department"},"Department",-1),e("option",{value:"user"},"User",-1)]),512),[[C,c.value]])]),e("div",null,[t[8]||(t[8]=e("label",{class:"text-sm text-gray-600"},"Dept ID (optional)",-1)),g(e("input",{"onUpdate:modelValue":t[2]||(t[2]=o=>x.value=o),type:"number",class:"w-28 rounded border px-2 py-1"},null,512),[[_,x.value]])]),e("div",null,[t[9]||(t[9]=e("label",{class:"text-sm text-gray-600"},"Form ID (optional)",-1)),g(e("input",{"onUpdate:modelValue":t[3]||(t[3]=o=>k.value=o),type:"number",class:"w-28 rounded border px-2 py-1"},null,512),[[_,k.value]])]),e("div",null,[t[11]||(t[11]=e("label",{class:"text-sm text-gray-600"},"Rule",-1)),g(e("select",{"onUpdate:modelValue":t[4]||(t[4]=o=>h.value=o),class:"rounded border px-2 py-1"},t[10]||(t[10]=[e("option",{value:"any"},"✓ if any saved",-1),e("option",{value:"both"},"✓ if both saved",-1)]),512),[[C,h.value]])]),e("button",{class:"btn-3",onClick:L},"Generate"),e("button",{class:"btn-3",onClick:R},t[12]||(t[12]=[e("i",{class:"far fa-print mr-1"},null,-1),P("Print")]))]),y(a)?(l(),r("div",J,[Y(H)])):y(w)?(l(),r("div",Q,n(y(w)),1)):(l(),r("div",W,[e("table",X,[e("thead",null,[e("tr",Z,[t[14]||(t[14]=e("th",{class:"border px-2 py-2 w-10 text-center"},"SL",-1)),e("th",ee,n(((N=y(d))==null?void 0:N.scope)==="user"?"Employee":"Department"),1),(l(!0),r(V,null,B(D.value,o=>(l(),r("th",{key:o.key,class:"border px-2 py-2 text-center"},[e("div",te,n(o.label),1),t[13]||(t[13]=e("div",{class:"text-[11px] text-gray-600"},"Inch. | Coord.",-1))]))),128)),t[15]||(t[15]=e("th",{class:"border px-2 py-2 text-right w-24"},"Total",-1))])]),e("tbody",null,[(l(!0),r(V,null,B(y(s),(o,S)=>(l(),r("tr",{key:o.key,class:"border-t"},[e("td",se,n(S+1),1),e("td",oe,n(o.name),1),(l(!0),r(V,null,B(D.value,p=>{var m,U,F;return l(),r("td",{key:p.key,class:"border px-2 py-2"},[e("div",re,[e("span",le,n(M((m=o.cells[p.key])==null?void 0:m.incharge)),1),e("span",ne,n(M((U=o.cells[p.key])==null?void 0:U.coordinator)),1)]),(F=o.cells[p.key])!=null&&F.max_total?(l(),r("div",ae,n(o.cells[p.key].final_total)+" / "+n(o.cells[p.key].max_total),1)):I("",!0)])}),128)),e("td",ie,n(Object.values(o.cells).reduce((p,m)=>p+((m==null?void 0:m.final_total)||0),0)),1)]))),128)),!y(s)||y(s).length===0?(l(),r("tr",de,t[16]||(t[16]=[e("td",{colspan:"100",class:"px-3 py-6 text-center text-gray-600"},"No data",-1)]))):I("",!0)])])]))])}}},xe=O(pe,[["__scopeId","data-v-c11bcc25"]]);export{xe as default};
