import{r as N,q as le,x as C,c as l,j as c,o as a,a as e,t as o,s as F,k as me,v as Fe,F as S,e as $,b as L,D as He,f as Je,u as We,G as Re,h as Qe,d as ne,l as he,m as W,H as Ae,z as Me,T as De}from"./index-BSTa_RIz.js";import{L as Xe}from"./LoaderView-CEzKhcxX.js";import{_ as Ze}from"./EmployeeFilter-CWhLdcUj.js";import{u as Te}from"./kpi-report-s5HFB7AZ.js";import{_ as et}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./company-VKMhembU.js";import"./department-CFPxMpP0.js";import"./EmployeeDropdownInput-CyTJI9rv.js";import"./SelectDropdown-Df4J41Sg.js";import"./UserChip-7Rcl0ZYO.js";const tt={key:0,class:"fixed inset-0 z-50"},st={class:"absolute left-1/2 top-1/2 w-[95vw] max-w-3xl -translate-x-1/2 -translate-y-1/2 rounded-xl bg-white shadow"},nt={class:"flex items-center justify-between border-b px-4 py-3"},lt={class:"text-xs text-gray-500"},at={class:"px-4 py-3"},ot={class:"mb-3 flex gap-2"},it={key:0,class:"py-6 text-center text-sm text-gray-600"},rt={key:1},dt={key:0,class:"mb-3 rounded-md border border-red-200 bg-red-50 p-2 text-sm text-red-700"},ut={class:"mb-4 rounded-lg border p-3"},ct={class:"mb-1 text-sm font-semibold"},pt={class:"text-xs text-gray-500 mb-2"},mt=["disabled","max"],yt={key:0,class:"mt-2 text-xs text-gray-500"},_t={class:"rounded-lg border"},bt={class:"max-h-[320px] overflow-auto"},xt={class:"font-medium"},vt={class:"text-xs text-gray-500"},ft={class:"text-xs text-gray-600"},gt={key:0},ht={key:0,class:"px-3 py-4 text-sm text-gray-500"},kt={class:"flex items-center justify-end gap-2 border-t px-4 py-3"},wt=["disabled"],Nt={__name:"KpiMarkingModal",props:{open:Boolean,cycleId:{type:Number,required:!0},employeeId:{type:Number,required:!0},employeeName:{type:String,default:""},laneKey:{type:String,default:"supv_director"},group:{type:String,default:"personal"}},emits:["update:open","saved"],setup(Q,{emit:U}){const D=Q,G=U,X=Te(),A=N(!1),T=N(""),k=N(D.laneKey),p=N([]),Z=N({}),P=N([]),I=N(0),f=N("");function ae(u){return u==="supv_director"?"Supv. Director":u==="da"?"DA":u}function B(){G("update:open",!1)}function E(){if(f.value===""||f.value==null)return;const u=Number(I.value||0),x=Number(f.value);if(!Number.isFinite(x))return;let m=x;m<0&&(m=0),u>0&&m>u&&(m=u),String(f.value)!==String(m)&&(f.value=String(m))}function V(){var m;const u=((m=Z.value)==null?void 0:m[k.value])||[],x=Array.isArray(u)?u[u.length-1]:null;f.value=(x==null?void 0:x.obtained)??"",E()}async function oe(){A.value=!0,T.value="";try{const u=await X.fetchMarkingForm({cycle_id:D.cycleId,employee_id:D.employeeId,lane_keys:"supv_director,da",include_personal_items:1,force:!0});p.value=u.lanes||[],Z.value=u.reviewsByLane||{},P.value=u.personalItems||[],I.value=Number(u.personalMaxTotal||0),V()}catch(u){T.value=(u==null?void 0:u.message)||"Failed to load"}finally{A.value=!1}}le(()=>D.open,u=>{u&&(k.value=D.laneKey||"supv_director",oe())}),le(()=>D.laneKey,u=>{u&&(k.value=u)}),le(k,()=>{V()}),le([f,I],()=>{E()});async function Y(){T.value="";const u=Number(I.value||0),x=Number(f.value);if(!Number.isFinite(x))return T.value="Overall mark must be a number.";if(x<0||u>0&&x>u)return T.value=`Overall mark must be between 0 and ${u}.`;A.value=!0;try{await X.submitOverallMark({cycle_id:D.cycleId,employee_id:D.employeeId,reviewer_lane:k.value,overall_mark:x,group_key:D.group||"personal"}),G("saved"),B()}catch(m){T.value=(m==null?void 0:m.message)||"Submit failed"}finally{A.value=!1}}const K=C(()=>{const u=(p.value||[]).find(x=>x.key===k.value);return!!(u!=null&&u.can_current_user_review)});return(u,x)=>Q.open?(a(),l("div",tt,[e("div",{class:"absolute inset-0 bg-black/40",onClick:B}),e("div",st,[e("div",nt,[e("div",null,[x[3]||(x[3]=e("div",{class:"text-sm font-semibold"},"KPI Marking (Overall)",-1)),e("div",lt,o(Q.employeeName?Q.employeeName+" • ":"")+"Personal Group ",1)]),e("button",{class:"text-sm px-2 py-1",onClick:B},"✕")]),e("div",at,[e("div",ot,[e("button",{class:F(["rounded-md border px-3 py-1 text-sm",k.value==="supv_director"?"bg-gray-900 text-white":""]),onClick:x[0]||(x[0]=m=>k.value="supv_director")}," Supv. Director ",2),e("button",{class:F(["rounded-md border px-3 py-1 text-sm",k.value==="da"?"bg-gray-900 text-white":""]),onClick:x[1]||(x[1]=m=>k.value="da")}," DA ",2)]),A.value?(a(),l("div",it,"Loading...")):(a(),l("div",rt,[T.value?(a(),l("div",dt,o(T.value),1)):c("",!0),e("div",ut,[e("div",ct,o(ae(k.value))+" Overall Mark",1),e("div",pt," Out of "+o(I.value||0),1),me(e("input",{"onUpdate:modelValue":x[2]||(x[2]=m=>f.value=m),type:"number",step:"0.01",class:"w-full rounded-md border px-3 py-2 text-sm",disabled:!K.value,max:I.value||void 0,min:"0",placeholder:"Enter overall mark"},null,8,mt),[[Fe,f.value]]),K.value?c("",!0):(a(),l("div",yt," You cannot submit for this lane. "))]),e("div",_t,[x[4]||(x[4]=e("div",{class:"border-b px-3 py-2 text-sm font-semibold"},"Personal Items (View Only)",-1)),e("div",bt,[(a(!0),l(S,null,$(P.value,m=>(a(),l("div",{key:m.id,class:"flex items-start justify-between gap-3 border-b px-3 py-2 text-sm"},[e("div",null,[e("div",xt,o(m.title),1),e("div",vt,o(m==null?void 0:m.label),1)]),e("div",ft,[L(" Max: "+o(m.max)+" ",1),m.weight!==null&&m.weight!==void 0?(a(),l("span",gt," • W: "+o(m.weight),1)):c("",!0)])]))),128)),P.value.length?c("",!0):(a(),l("div",ht," No personal items found in cycle. "))])])]))]),e("div",kt,[e("button",{class:"rounded-md border px-4 py-2 text-sm",onClick:B},"Cancel"),e("button",{class:"rounded-md bg-sky-600 px-4 py-2 text-sm text-white disabled:opacity-50",disabled:A.value||!K.value,onClick:Y}," Submit ",8,wt)])])])):c("",!0)}},St={class:"space-y-4 px-4 print:px-0"},Ct={class:"hidden print:block mx-auto text-center mb-3"},$t={class:"text-sm text-gray-600"},Lt={class:"font-medium"},jt={class:"font-medium"},Rt={class:"flex flex-wrap items-end gap-3 sticky top-14 z-10 bg-white/80 backdrop-blur print:hidden p-4 -mx-2 rounded-xl border border-gray-100"},At={class:"w-full flex items-start gap-3"},Mt={class:"flex gap-2"},Dt=["disabled"],Ft=["value"],Tt={class:"flex flex-wrap items-center gap-2 w-full"},Et=["value"],It=["disabled"],Ot=["disabled"],Yt={key:0,class:"py-10 text-center"},Kt={key:1,class:"rounded-xl border border-red-200 bg-red-50 p-3 text-red-700",role:"alert"},zt={class:"rounded-2xl border border-gray-200 bg-white shadow-sm p-4 print:hidden"},Gt={class:"flex flex-wrap items-start justify-between gap-3"},Pt={class:"text-xs font-semibold uppercase tracking-[0.18em] text-indigo-500"},Vt={class:"mt-1 text-lg font-semibold text-slate-900"},qt={class:"mt-1 flex flex-wrap gap-2 text-xs text-slate-600"},Ut={class:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5"},Bt={class:"text-slate-900"},Ht={key:0,class:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5"},Jt={class:"text-slate-900"},Wt={class:"text-xs text-slate-500"},Qt={class:"space-y-3 md:hidden"},Xt={class:"flex items-start justify-between gap-3"},Zt={class:"min-w-0"},es=["title"],ts={class:"mt-0.5 text-[11px] text-slate-500"},ss={key:0},ns={key:1},ls={key:2},as={key:3},os={class:"shrink-0"},is={key:0,class:"mt-2 grid grid-cols-4 gap-2"},rs=["title"],ds={class:"mt-1 flex flex-col items-center gap-1"},us=["onClick"],cs={key:1,class:"flex flex-col items-center gap-1"},ps={class:"mt-3 grid grid-cols-3 gap-2"},ms={class:"text-[10px] font-medium text-slate-600"},ys={class:"mt-1 text-[11px] font-semibold text-slate-900"},_s={class:"mt-3 flex items-center justify-between gap-3"},bs=["onClick"],xs={key:0,class:"px-3 py-8 text-center text-gray-600"},vs={class:"hidden md:block rounded-2xl border bg-white shadow-sm"},fs={class:"w-full text-sm"},gs={class:"sticky top-40 z-[5] bg-gray-100/95 backdrop-blur"},hs={class:"text-xs font-semibold text-slate-700"},ks={class:"text-xs font-semibold text-slate-700"},ws={class:"sticky left-0 z-[4] border-r bg-inherit px-2 text-center"},Ns={class:"sticky z-[4] border-r bg-inherit px-2",style:{left:"3rem"}},Ss={class:"max-w-[12rem]"},Cs=["title"],$s={class:"text-[11px] text-slate-500 truncate"},Ls={key:0},js={key:1},Rs={key:2},As={key:3},Ms={class:"border-r px-2 text-center"},Ds={class:"flex flex-col items-center gap-1"},Fs=["onClick"],Ts={key:1,class:"flex flex-col items-center gap-1"},Es={class:"px-2"},Is={class:"space-y-1 text-[11px] text-slate-600"},Os={class:"mt-2 flex items-center justify-between gap-3"},Ys=["onClick"],Ks={key:0},zs={class:"relative max-w-2xl w-full rounded-2xl border border-slate-200 bg-white p-5 shadow-xl",role:"dialog","aria-modal":"true","aria-label":"Latest review details"},Gs={class:"flex items-start justify-between gap-4"},Ps={class:"text-lg font-semibold text-slate-900"},Vs={class:"text-xs text-slate-500"},qs={key:0},Us={key:1},Bs={class:"text-xs text-slate-500"},Hs={class:"mt-4 space-y-4 text-slate-700"},Js={class:"rounded-xl border border-slate-200 bg-slate-50 p-4"},Ws={class:"mt-3 space-y-2 text-xs text-slate-700"},Qs={key:0},Xs={class:"mt-1 text-slate-600"},Zs={key:1},en={class:"mt-1 text-slate-600"},tn={key:2},sn={class:"mt-1 text-slate-600"},nn={key:3,class:"text-slate-500"},ln={class:"relative max-w-3xl w-full rounded-2xl border border-slate-200 bg-white shadow-xl overflow-hidden",role:"dialog","aria-modal":"true","aria-label":"All reviewer comments"},an={class:"p-5 border-b border-slate-200 bg-white"},on={class:"flex items-start justify-between gap-4"},rn={class:"min-w-0"},dn={class:"text-lg font-semibold text-slate-900 truncate"},un={class:"mt-0.5 text-xs text-slate-500"},cn={key:0},pn={key:1},mn={class:"mt-2 flex flex-wrap gap-2 text-[11px] text-slate-600"},yn={class:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5"},_n={class:"text-slate-900"},bn={class:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5"},xn={class:"text-slate-900"},vn={class:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5"},fn={class:"text-slate-900"},gn={class:"max-h-[75vh] overflow-y-auto p-5 space-y-4"},hn={key:0,class:"rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600"},kn={class:"px-4 py-3 bg-slate-50 border-b border-slate-200 flex flex-wrap items-center justify-between gap-2"},wn={class:"flex items-center gap-2 min-w-0"},Nn=["title"],Sn={class:"text-[11px] text-slate-500 truncate"},Cn={class:"flex flex-wrap gap-2 text-[11px] text-slate-600"},$n={class:"rounded-full border border-slate-200 bg-white px-2 py-0.5"},Ln={class:"text-slate-900"},jn={class:"rounded-full border border-slate-200 bg-white px-2 py-0.5"},Rn={class:"text-slate-900"},An={class:"p-4 space-y-3"},Mn={class:"flex flex-wrap items-start justify-between gap-2"},Dn={class:"min-w-0"},Fn={class:"text-sm font-semibold text-slate-900 truncate"},Tn={class:"mt-0.5 text-[11px] text-slate-500"},En={key:0},In={class:"flex flex-wrap gap-2"},On={class:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5 text-[11px] font-semibold text-slate-700"},Yn={key:0,class:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5 text-[11px] font-semibold text-slate-700"},Kn={class:"mt-3 space-y-2 text-xs text-slate-700"},zn={key:0},Gn={class:"mt-1 list-disc pl-5 text-slate-600 space-y-1"},Pn={key:1},Vn={class:"mt-1 list-disc pl-5 text-slate-600 space-y-1"},qn={key:2},Un={class:"mt-1 list-disc pl-5 text-slate-600 space-y-1"},Bn={key:3,class:"text-slate-500"},Hn={key:0,class:"text-sm text-slate-500"},Jn={__name:"YearlyKpiReport",setup(Q){const U=Te(),{reports:D,isLoading:G,error:X}=He(U),A=Je(),T=We(),k=C(()=>({company_id:A.query.company_id??"",department_id:A.query.department_id??"",employee_id:A.query.employee_id??"",line_type:A.query.line_type??"executive"})),p=Re({company_id:k.value.company_id,department_id:k.value.department_id,employee_id:k.value.employee_id,line_type:k.value.line_type}),Z=N(!1);function P(t,s){var i,r;return t!=null&&t.marking_permissions&&Object.prototype.hasOwnProperty.call(t.marking_permissions,s)?!!t.marking_permissions[s]:!!((r=(i=t==null?void 0:t.lane_lens)==null?void 0:i[s])!=null&&r.can_current_user_review)}const I=new Date().getFullYear(),f=N(Number(A.query.year??I)),ae=N([]);function B(t=2020,s=I+1){const i=[];for(let r=s;r>=t;r--)i.push(r);ae.value=i}const E=C(()=>D.value||{}),V=C(()=>{var t;return((t=E.value)==null?void 0:t.cycle)||{}}),oe=C(()=>{var t;return((t=E.value)==null?void 0:t.filters)||{}}),Y=C(()=>{var s;return[...Array.isArray((s=E.value)==null?void 0:s.lane_definitions)?E.value.lane_definitions:[]].sort((i,r)=>Number(i.rank||0)-Number(r.rank||0))}),K=C(()=>Y.value.filter(t=>{const s=String((t==null?void 0:t.key)||"").toLowerCase(),i=String((t==null?void 0:t.label)||"").toLowerCase();return!(s==="hr"||/^hr\d*$/.test(s)||s.includes("avg")||/\bavg\b/i.test(i)||i.includes("average")||i.includes("hr")&&s==="")})),u=C(()=>{var t;return((t=E.value)==null?void 0:t.summary)||{}}),x=C(()=>{var t;return Array.isArray((t=E.value)==null?void 0:t.data)?E.value.data:[]}),m=C(()=>{var s;if(Y.value.length)return Y.value.length;const t=Number(((s=V.value)==null?void 0:s.lane_count)??0);return Number.isFinite(t)&&t>0?t:0}),ye=[{key:"training",label:"Training"},{key:"discipline",label:"Dis"},{key:"execution",label:"Exe"},{key:"target",label:"Target"},{key:"final",label:"Final"}];function Ee(t){const s=Number(t);return Number.isFinite(s)?`${Math.round(s)}%`:"0%"}function ee(t,s=2){const i=Number(t);if(!Number.isFinite(i))return"—";const r=Number(i.toFixed(s));return Number.isInteger(r),String(r)}function H(t,s="-"){const i=(t??"").toString().trim();return i||s}function ke(t){if(!t)return null;const s=new Date(t);return Number.isNaN(s.getTime())?null:s.toLocaleDateString()}function Ie(){return new Date().toLocaleString()}function J(t){return!Array.isArray(t)||t.length===0?null:t.join("; ")}function _e(t){return Array.isArray(t)?t.map(s=>typeof s=="string"?s.trim():"").filter(s=>s!==""):typeof t=="string"?t.split(/[\r\n;]+/).map(s=>s.trim()).filter(s=>s!==""):[]}function we(t){var r;const s=Number(((r=t==null?void 0:t.progress)==null?void 0:r.lanes_reviewed)??0),i=Number(m.value??0);return i?s>=i?"bg-emerald-50 text-emerald-700 border-emerald-200":s>0?"bg-amber-50 text-amber-700 border-amber-200":"bg-rose-50 text-rose-700 border-rose-200":"bg-slate-50 text-slate-600 border-slate-200"}function be(t){var r;const s=Number(((r=t==null?void 0:t.progress)==null?void 0:r.lanes_reviewed)??0),i=Number(m.value??0);return i?`${s}/${i}`:`${s}`}function Oe(t){if(!t)return"No reviews submitted yet";const s=t.reviewer_name||"Latest reviewer",i=t.reviewer_lane?` (${t.reviewer_lane})`:"",r=t.obtained_total??null,b=t.max_total??null,w=Number.isFinite(Number(r))&&Number.isFinite(Number(b))?`${Number(r)}/${Number(b)}`:r!==null?`${r}`:null,n=ke(t.submitted_at),v=[`${s}${i}`];return w&&v.push(w),n&&v.push(n),v.join(" • ")}function M(t,s){var g,te,_,pe;const i=String(s||""),b=i==="hr"||i==="hr1"?((g=t==null?void 0:t.computed)==null?void 0:g.hr_total)??null:((_=(te=t==null?void 0:t.computed)==null?void 0:te.personal_by_lane)==null?void 0:_[i])??null,h=Number(b);if(Number.isFinite(h))return{text:ee(h),cls:h>0?"bg-emerald-50 text-emerald-700 border-emerald-200":"bg-amber-50 text-amber-700 border-amber-200"};const n=(Array.isArray(t==null?void 0:t.lanes)?t.lanes:[]).find(O=>(O==null?void 0:O.key)===i)||null;if(!n)return{text:"-",cls:"bg-slate-50 text-slate-500 border border-slate-200"};const j=!!(n.latest_review_at||n.submitted_at||n.submittedAt||((pe=n.review)==null?void 0:pe.submitted_at))||!!(Array.isArray(n.reviewers)&&n.reviewers.length),d=n.average_marks??n.obtained_total??n.obtained??null,R=Number(d);return Number.isFinite(R)?{text:ee(R),cls:j?"bg-emerald-50 text-emerald-700 border-emerald-200":"bg-amber-50 text-amber-700 border-amber-200"}:{text:"-",cls:j?"bg-emerald-50 text-emerald-700 border-emerald-200":"bg-amber-50 text-amber-700 border-amber-200"}}const Ne=C(()=>x.value.map(t=>{var b,h,w,n;const s=t.employee||{},i=t.latest_review||null,r=t.comments||{};return{...t,_name:H(s.name),_company:H(s.company,""),_dept:H(s.department,""),_joining:ke(s.joining_date),_type:H(s.type,""),latestReviewSummary:Oe(i),latestReviewStrengths:J(i==null?void 0:i.strengths)||null,latestReviewGaps:J(i==null?void 0:i.gaps)||null,latestReviewSuggestions:J(i==null?void 0:i.suggestions)||null,aggregatedStrengthsList:_e(r==null?void 0:r.strengths),aggregatedGapsList:_e(r==null?void 0:r.gaps),aggregatedSuggestionsList:_e(r==null?void 0:r.suggestions),aggregatedStrengths:J(r==null?void 0:r.strengths),aggregatedGaps:J(r==null?void 0:r.gaps),aggregatedSuggestions:J(r==null?void 0:r.suggestions),computed:(t==null?void 0:t.computed)||{},finalTotal:((b=t==null?void 0:t.computed)==null?void 0:b.final)??null,finalPercent:((h=t==null?void 0:t.kpi_result)==null?void 0:h.final_percent)??((w=t==null?void 0:t.kpi_result)==null?void 0:w.final_percentage)??((n=t==null?void 0:t.kpi_result)==null?void 0:n.final)??null}})),xe=N(""),ve=N("all"),Ye=[{value:"all",label:"Any comment"},{value:"strengths",label:"Strengths"},{value:"gaps",label:"Gaps"},{value:"suggestions",label:"Suggestions"}],Ke=C(()=>xe.value.trim().toLowerCase()),ze=C(()=>{const t=Ke.value;return t?Ne.value.filter(s=>{const i=ve.value,r=[];return(i==="all"||i==="strengths")&&r.push(s.aggregatedStrengthsList||[]),(i==="all"||i==="gaps")&&r.push(s.aggregatedGapsList||[]),(i==="all"||i==="suggestions")&&r.push(s.aggregatedSuggestionsList||[]),r.some(b=>b.some(h=>h.toLowerCase().includes(t)))}):Ne.value}),ie=C(()=>ze.value),y=N(null),re=N(!1);function Se(t){y.value=t,re.value=!0}function q(){re.value=!1,y.value=null}const fe=N(!1),z=Re({employee_id:null,employee_name:"",lane_key:""}),Ge=C(()=>{const t=Y.value||[],s=[],i=n=>{n!=null&&n.key&&!s.includes(n.key)&&s.push(n.key)},r=n=>t.find(v=>v.key===n),b=n=>t.find(v=>n.test(String(v.label||""))),h=r("supv_director")||b(/supv\.?\s*director|supervising\s+director/i),w=r("da")||b(/\bda\b|director\s*of\s*admin|director\s*admin/i);return i(h),i(w),s});function de(t){return Ge.value.includes(t)}function Ce(t,s){var r,b,h,w;if(!P(t,s))return;const i=((r=t==null?void 0:t.employee)==null?void 0:r.id)??(t==null?void 0:t.employee_id)??(t==null?void 0:t.id)??null;i&&(z.cycle_id=((b=t==null?void 0:t.cycle)==null?void 0:b.id)??((h=V.value)==null?void 0:h.id)??null,z.employee_id=i,z.employee_name=(t==null?void 0:t._name)||((w=t==null?void 0:t.employee)==null?void 0:w.name)||"",z.lane_key=s,fe.value=!0)}const ue=N(!1),ce=N(!1);function Pe(){return{year:Number(f.value),company_id:p.company_id||void 0,department_id:p.department_id||void 0,employee_id:p.employee_id||void 0,line_type:p.line_type||void 0,flag:"excel"}}function Ve(){return{year:Number(f.value),company_id:p.company_id||void 0,department_id:p.department_id||void 0,employee_id:p.employee_id||void 0,line_type:p.line_type||void 0,flag:"comment_excel"}}async function qe(){ue.value=!0;try{await U.exportYearly(Pe())}catch(t){console.error("exportYearly failed:",t)}finally{ue.value=!1}}async function Ue(){ce.value=!0;try{await U.exportYearly(Ve())}catch(t){console.error("exportYearly comment_excel failed:",t)}finally{ce.value=!1}}function $e(t={}){const s={...A.query,...t};Object.keys(s).forEach(i=>{const r=s[i];(r==null||r==="")&&delete s[i]}),T.replace({query:s})}async function ge(){try{p.company_id&&await U.fetchYearlyExecutive({year:Number(f.value),company_id:p.company_id||void 0,department_id:p.department_id||void 0,employee_id:p.employee_id||void 0,line_type:p.line_type||void 0})}catch(t){console.error("fetchYearlyExecutive failed:",t)}}function Be(t={}){p.company_id=t.company_id??"",p.department_id=t.department_id??"",p.employee_id=t.employee_id??"",p.line_type=t.line_type??k.value.line_type??"executive",Z.value=!0,$e({company_id:p.company_id||void 0,department_id:p.department_id||void 0,employee_id:p.employee_id||void 0,line_type:p.line_type||void 0,year:Number(f.value)}),ge()}le(f,()=>{const t=Number(f.value);!Number.isInteger(t)||t<2e3||t>2100||Z.value&&($e({year:t}),ge())}),Qe(()=>{B()});function Le(t){if(!t)return null;const s=new Date(t);return Number.isNaN(s.getTime())?null:s.toLocaleString()}const je=C(()=>{const t=y.value,s=Array.isArray(t==null?void 0:t.lanes)?t.lanes:[],i=new Map(Y.value.map(b=>[b.key,Number(b.rank??0)]));return[...s].sort((b,h)=>{const w=i.get(b.key)??9999,n=i.get(h.key)??9999;return w-n}).map(b=>{var n;const w=[...Array.isArray(b.reviewers)?b.reviewers:[]].sort((v,j)=>{const d=new Date(v.submitted_at||v.updated_at||0).getTime();return new Date(j.submitted_at||j.updated_at||0).getTime()-d});return{...b,label:((n=Y.value.find(v=>v.key===b.key))==null?void 0:n.label)||b.key,reviewers:w}})});return(t,s)=>{var i,r,b,h,w;return a(),l("div",St,[e("div",Ct,[s[11]||(s[11]=e("h1",{class:"text-xl font-semibold text-gray-900"},"Yearly KPI Report",-1)),e("div",$t,[s[8]||(s[8]=L(" Cycle: ")),e("span",Lt,o(((i=V.value)==null?void 0:i.slug)||"-"),1),s[9]||(s[9]=L(" • Year: ")),e("span",jt,o(f.value),1),s[10]||(s[10]=L(" • Generated: ")),e("span",null,o(Ie()),1)])]),e("div",Rt,[e("div",At,[ne(Ze,{company_id:p.company_id,"onUpdate:company_id":s[1]||(s[1]=n=>p.company_id=n),department_id:p.department_id,"onUpdate:department_id":s[2]||(s[2]=n=>p.department_id=n),employee_id:p.employee_id,"onUpdate:employee_id":s[3]||(s[3]=n=>p.employee_id=n),line_type:p.line_type,"onUpdate:line_type":s[4]||(s[4]=n=>p.line_type=n),"initial-value":k.value,class:"w-full",onFilterChange:Be},{default:he(()=>[e("div",Mt,[s[12]||(s[12]=e("label",{for:"",class:"top-label -top-1"},"Year",-1)),me(e("select",{"onUpdate:modelValue":s[0]||(s[0]=n=>f.value=n),class:"w-32 rounded-lg border border-gray-300 bg-white px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400/50 disabled:opacity-60",disabled:W(G),"aria-label":"Select year"},[(a(!0),l(S,null,$(ae.value,n=>(a(),l("option",{key:n,value:n},o(n),9,Ft))),128))],8,Dt),[[Ae,f.value,void 0,{number:!0}]])])]),_:1},8,["company_id","department_id","employee_id","line_type","initial-value"])]),e("div",Tt,[me(e("input",{"onUpdate:modelValue":s[5]||(s[5]=n=>xe.value=n),type:"search",placeholder:"Search gaps/strengths/suggestions",class:"flex-1 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm focus:border-sky-400 focus:ring-2 focus:ring-sky-400/50"},null,512),[[Fe,xe.value]]),me(e("select",{"onUpdate:modelValue":s[6]||(s[6]=n=>ve.value=n),class:"rounded-lg border border-gray-300 bg-white px-2 py-1 text-sm focus:border-sky-400 focus:ring-2 focus:ring-sky-400/50"},[(a(),l(S,null,$(Ye,n=>e("option",{key:n.value,value:n.value},o(n.label),9,Et)),64))],512),[[Ae,ve.value]]),e("button",{class:"btn-1 rounded",onClick:qe,disabled:ue.value||W(G)},[s[13]||(s[13]=e("i",{class:"far fa-file-excel mr-1 text-lg text-green-600"},null,-1)),L(" "+o(ue.value?"Preparing...":"Download Excel"),1)],8,It),e("button",{class:"btn-1 rounded",onClick:Ue,disabled:ce.value||W(G)},[s[14]||(s[14]=e("i",{class:"far fa-file-excel mr-1 text-lg text-green-600"},null,-1)),L(" "+o(ce.value?"Preparing...":"Download Comments Excel"),1)],8,Ot)])]),W(G)?(a(),l("div",Yt,[ne(Xe)])):W(X)?(a(),l("div",Kt,o(W(X)),1)):(a(),l(S,{key:2},[e("div",zt,[e("div",Gt,[e("div",null,[e("div",Pt," KPI Cycle • "+o(H((r=V.value)==null?void 0:r.slug)),1),e("h2",Vt," Year "+o(f.value)+" • "+o(H(p.line_type)),1),e("div",qt,[e("span",Ut,[s[15]||(s[15]=L(" Employees: ")),e("b",Bt,o(((b=u.value)==null?void 0:b.total_employees)??0),1)]),m.value?(a(),l("span",Ht,[s[16]||(s[16]=L(" Lanes: ")),e("b",Jt,o(m.value),1)])):c("",!0)])]),e("div",Wt,[s[17]||(s[17]=e("div",null,[e("b",{class:"text-slate-700"},"API Filters")],-1)),e("div",null,"line_type: "+o(((h=oe.value)==null?void 0:h.line_type)??"-"),1),e("div",null,"submitted_only: "+o((w=oe.value)!=null&&w.submitted_only?"true":"false"),1)])])]),e("div",Qt,[(a(!0),l(S,null,$(ie.value,(n,v)=>{var j;return a(),l("div",{key:"m-"+(((j=n.employee)==null?void 0:j.id)??v),class:"rounded-2xl border border-gray-200 bg-white shadow-sm p-3"},[e("div",Xt,[e("div",Zt,[e("div",{class:"text-sm font-semibold text-slate-900 truncate",title:n._name},o(v+1)+". "+o(n._name),9,es),e("div",ts,[n._dept?(a(),l("span",ss,o(n._dept),1)):c("",!0),n._dept&&n._company?(a(),l("span",ns," • ")):c("",!0),n._company?(a(),l("span",ls,o(n._company),1)):c("",!0),n._joining?(a(),l("span",as," • Joined "+o(n._joining),1)):c("",!0)])]),e("div",os,[e("span",{class:F(["inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[11px] font-semibold",we(n)])},o(be(n)),3)])]),K.value.length?(a(),l("div",is,[(a(!0),l(S,null,$(K.value,d=>(a(),l("div",{key:"m-lane-"+d.key,class:"rounded-xl border p-2 text-center"},[e("div",{class:"text-[10px] font-medium text-slate-600 truncate",title:d.label},o(d.label),9,rs),e("div",ds,[de(d.key)&&P(n,d.key)?(a(),l("button",{key:0,type:"button",class:"group inline-flex flex-col items-center gap-1",onClick:R=>Ce(n,d.key)},[e("span",{class:F(["inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-[11px] font-semibold",M(n,d.key).cls])},o(M(n,d.key).text),3),s[18]||(s[18]=e("span",{class:"text-[10px] font-semibold text-sky-600 group-hover:text-sky-700"}," Mark/Edit ",-1))],8,us)):de(d.key)?(a(),l("div",cs,[e("span",{class:F(["inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-[11px] font-semibold",M(n,d.key).cls])},o(M(n,d.key).text),3)])):(a(),l("span",{key:2,class:F(["inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-[11px] font-semibold",M(n,d.key).cls])},o(M(n,d.key).text),3))])]))),128))])):c("",!0),e("div",ps,[(a(),l(S,null,$(ye,d=>{var R,g;return e("div",{key:"m-calc-"+d.key,class:"rounded-xl border border-slate-200 bg-slate-50 p-2 text-center"},[e("div",ms,o(d.label),1),e("div",ys,o(((R=n==null?void 0:n.computed)==null?void 0:R[d.key])==null||((g=n==null?void 0:n.computed)==null?void 0:g[d.key])===""?"—":ee(n.computed[d.key])),1)])}),64))]),e("div",_s,[e("button",{type:"button",class:"text-xs font-semibold text-sky-600 hover:text-sky-800",onClick:d=>Se(n)}," Open modal ",8,bs)])])}),128)),ie.value.length===0?(a(),l("div",xs,"No data")):c("",!0)]),e("div",vs,[e("table",fs,[e("thead",gs,[e("tr",null,[s[19]||(s[19]=e("th",{class:"sticky left-0 z-[6] border-b border-r bg-gray-100/95 px-3 py-2 text-center",style:{"min-width":"3rem",width:"3rem"}}," SL ",-1)),s[20]||(s[20]=e("th",{class:"sticky z-[6] border-b border-r bg-gray-100/95 px-2 py-1 text-left",style:{left:"3rem",minWidth:"13rem",width:"13rem"}}," Employee ",-1)),s[21]||(s[21]=e("th",{class:"border-b border-r px-2 py-1 text-center",style:{"min-width":"7rem"}}," Progress ",-1)),(a(!0),l(S,null,$(K.value,n=>(a(),l("th",{key:"lane-head-"+n.key,class:"border-b border-r px-2 py-1 text-center",style:{"min-width":"6.5rem"}},[e("span",hs,o(n.label),1)]))),128)),(a(),l(S,null,$(ye,n=>e("th",{key:"calc-head-"+n.key,class:"border-b border-r px-2 py-1 text-center",style:{"min-width":"6rem"}},[e("span",ks,o(n.label),1)])),64)),s[22]||(s[22]=e("th",{class:"border-b px-2 py-1 text-left"}," comments ",-1))])]),e("tbody",null,[(a(!0),l(S,null,$(ie.value,(n,v)=>{var j;return a(),l("tr",{key:"d-"+(((j=n.employee)==null?void 0:j.id)??v),class:"border-t hover:bg-slate-50/80 transition-colors"},[e("td",ws,o(v+1),1),e("td",Ns,[e("div",Ss,[e("div",{class:"font-semibold text-slate-900 truncate",title:n._name},o(n._name),9,Cs),e("div",$s,[n._dept?(a(),l("span",Ls,o(n._dept),1)):c("",!0),n._dept&&n._company?(a(),l("span",js," • ")):c("",!0),n._company?(a(),l("span",Rs,o(n._company),1)):c("",!0),n._joining?(a(),l("span",As," • Joined "+o(n._joining),1)):c("",!0)])])]),e("td",Ms,[e("span",{class:F(["inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-[12px] font-semibold",we(n)])},o(be(n)),3)]),(a(!0),l(S,null,$(K.value,d=>(a(),l("td",{key:"lane-"+d.key+"-"+v,class:"border-r px-2 text-center"},[e("div",Ds,[de(d.key)&&P(n,d.key)?(a(),l("button",{key:0,type:"button",class:"group inline-flex flex-col items-center gap-1",onClick:R=>Ce(n,d.key)},[e("span",{class:F(["inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-[11px] font-semibold",M(n,d.key).cls])},o(M(n,d.key).text),3),s[23]||(s[23]=e("span",{class:"text-[10px] font-semibold text-sky-600 group-hover:text-sky-700"}," Mark/Edit ",-1))],8,Fs)):de(d.key)?(a(),l("div",Ts,[e("span",{class:F(["inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-[11px] font-semibold",M(n,d.key).cls])},o(M(n,d.key).text),3)])):(a(),l("span",{key:2,class:F(["inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-[11px] font-semibold",M(n,d.key).cls])},o(M(n,d.key).text),3))])]))),128)),(a(),l(S,null,$(ye,d=>{var R,g;return e("td",{key:"calc-"+d.key+"-"+v,class:"border-r px-2 text-center"},[e("span",{class:F(["inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-[11px] font-semibold",d.key==="final"?"border-sky-200 bg-sky-50 text-sky-700":"border-slate-200 bg-slate-50 text-slate-700"])},o(((R=n==null?void 0:n.computed)==null?void 0:R[d.key])==null||((g=n==null?void 0:n.computed)==null?void 0:g[d.key])===""?"—":ee(n.computed[d.key])),3)])}),64)),e("td",Es,[e("div",Is,[e("div",Os,[e("button",{type:"button",class:"text-[11px] font-semibold text-sky-600 hover:text-sky-800",onClick:d=>Se(n)}," Open modal ",8,Ys)])])])])}),128)),ie.value.length===0?(a(),l("tr",Ks,s[24]||(s[24]=[e("td",{colspan:"100",class:"px-3 py-8 text-center text-gray-600"},"No data",-1)]))):c("",!0)])])]),ne(De,{name:"fade-scale"},{default:he(()=>[re.value&&y.value?(a(),l("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center px-4 py-6",onKeydown:Me(q,["escape","window"])},[e("div",{class:"absolute inset-0 bg-slate-900/60 backdrop-blur-sm","aria-hidden":"true",onClick:q}),e("div",zs,[e("div",Gs,[e("div",null,[e("p",Ps,o(y.value._name),1),e("p",Vs,[L(o(y.value._dept||"Department unknown")+" ",1),y.value._company?(a(),l("span",qs," • "+o(y.value._company),1)):c("",!0),y.value._joining?(a(),l("span",Us," • Joined "+o(y.value._joining),1)):c("",!0)]),e("p",Bs,"Line type: "+o(y.value._type),1)]),e("button",{type:"button",class:"rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-600 hover:bg-slate-50",onClick:q}," Close ")]),e("div",Hs,[e("article",Js,[e("div",Ws,[y.value.latestReviewStrengths?(a(),l("div",Qs,[s[25]||(s[25]=e("span",{class:"font-semibold text-slate-800"},"Strengths:",-1)),e("div",Xs,o(y.value.latestReviewStrengths),1)])):c("",!0),y.value.latestReviewGaps?(a(),l("div",Zs,[s[26]||(s[26]=e("span",{class:"font-semibold text-slate-800"},"Gaps:",-1)),e("div",en,o(y.value.latestReviewGaps),1)])):c("",!0),y.value.latestReviewSuggestions?(a(),l("div",tn,[s[27]||(s[27]=e("span",{class:"font-semibold text-slate-800"},"Suggestions:",-1)),e("div",sn,o(y.value.latestReviewSuggestions),1)])):c("",!0),!y.value.latestReviewStrengths&&!y.value.latestReviewGaps&&!y.value.latestReviewSuggestions?(a(),l("div",nn," No latest review comments ")):c("",!0)])])])])],32)):c("",!0)]),_:1})],64)),ne(De,{name:"fade-scale"},{default:he(()=>{var n,v,j,d,R;return[re.value&&y.value?(a(),l("div",{key:0,class:"fixed inset-0 z-50 flex items-center justify-center px-4 py-6",onKeydown:Me(q,["escape","window"])},[e("div",{class:"absolute inset-0","aria-hidden":"true",onClick:q}),e("div",ln,[e("div",an,[e("div",on,[e("div",rn,[e("p",dn,o(y.value._name),1),e("p",un,[L(o(y.value._dept||"Department unknown")+" ",1),y.value._company?(a(),l("span",cn," • "+o(y.value._company),1)):c("",!0),y.value._joining?(a(),l("span",pn," • Joined "+o(y.value._joining),1)):c("",!0)]),e("div",mn,[e("span",yn,[s[28]||(s[28]=L(" Progress: ")),e("b",_n,o(be(y.value)),1)]),e("span",bn,[s[29]||(s[29]=L(" Final: ")),e("b",xn,o(((v=(n=y.value)==null?void 0:n.computed)==null?void 0:v.final)==null||((d=(j=y.value)==null?void 0:j.computed)==null?void 0:d.final)===""?"—":ee(y.value.computed.final)),1)]),e("span",vn,[s[30]||(s[30]=L(" Reviews: ")),e("b",fn,o(((R=y.value.progress)==null?void 0:R.review_count)??0),1)])])]),e("button",{type:"button",class:"shrink-0 rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-600 hover:bg-slate-50",onClick:q}," Close ")])]),e("div",gn,[je.value.length?c("",!0):(a(),l("div",hn," No reviews found for this employee. ")),(a(!0),l(S,null,$(je.value,g=>{var te;return a(),l("div",{key:"lane-group-"+g.key,class:"rounded-2xl border border-slate-200 bg-white overflow-hidden"},[e("div",kn,[e("div",wn,[e("span",{class:"text-sm font-semibold text-slate-900 truncate",title:g.label},o(g.label),9,Nn),e("span",Sn," (key: "+o(g.key)+") ",1)]),e("div",Cn,[e("span",$n,[s[31]||(s[31]=L(" Count: ")),e("b",Ln,o(g.count??((te=g.reviewers)==null?void 0:te.length)??0),1)]),e("span",jn,[s[32]||(s[32]=L(" Latest: ")),e("b",Rn,o(Le(g.latest_review_at)||"—"),1)])])]),e("div",An,[(a(!0),l(S,null,$(g.reviewers||[],(_,pe)=>(a(),l("div",{key:"rv-"+g.key+"-"+pe+"-"+(_.id??"x"),class:"rounded-xl border border-slate-200 bg-white p-3"},[e("div",Mn,[e("div",Dn,[e("div",Fn,o(_.name||"Reviewer"),1),e("div",Tn,[L(" Lane: "+o(_.lane||g.key)+" ",1),_.submitted_at||_.updated_at?(a(),l("span",En," • "+o(Le(_.submitted_at||_.updated_at)),1)):c("",!0)])]),e("div",In,[e("span",On,o(_.percent==null?"—":Ee(_.percent)),1),_.obtained_total!=null&&_.max_total!=null?(a(),l("span",Yn,o(_.obtained_total),1)):c("",!0)])]),e("div",Kn,[_.strengths&&_.strengths.length?(a(),l("div",zn,[s[33]||(s[33]=e("div",{class:"font-semibold text-slate-900"},"Strengths",-1)),e("ul",Gn,[(a(!0),l(S,null,$(_.strengths,(O,se)=>(a(),l("li",{key:"s-"+se},o(O),1))),128))])])):c("",!0),_.gaps&&_.gaps.length?(a(),l("div",Pn,[s[34]||(s[34]=e("div",{class:"font-semibold text-slate-900"},"Gaps",-1)),e("ul",Vn,[(a(!0),l(S,null,$(_.gaps,(O,se)=>(a(),l("li",{key:"g-"+se},o(O),1))),128))])])):c("",!0),_.suggestions&&_.suggestions.length?(a(),l("div",qn,[s[35]||(s[35]=e("div",{class:"font-semibold text-slate-900"},"Suggestions",-1)),e("ul",Un,[(a(!0),l(S,null,$(_.suggestions,(O,se)=>(a(),l("li",{key:"u-"+se},o(O),1))),128))])])):c("",!0),(!_.strengths||!_.strengths.length)&&(!_.gaps||!_.gaps.length)&&(!_.suggestions||!_.suggestions.length)?(a(),l("div",Bn," No comments in this review. ")):c("",!0)])]))),128)),!g.reviewers||g.reviewers.length===0?(a(),l("div",Hn," No reviewers found in this lane. ")):c("",!0)])])}),128))]),e("div",{class:"p-4 border-t border-slate-200 bg-white flex items-center justify-end gap-2"},[e("button",{type:"button",class:"rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-600 hover:bg-slate-50",onClick:q}," Close ")])])],32)):c("",!0)]}),_:1}),ne(Nt,{open:fe.value,"onUpdate:open":s[7]||(s[7]=n=>fe.value=n),"cycle-id":z.cycle_id,"employee-id":z.employee_id,"employee-name":z.employee_name,"lane-key":z.lane_key,group:"personal",onSaved:ge},null,8,["open","cycle-id","employee-id","employee-name","lane-key"])])}}},ol=et(Jn,[["__scopeId","data-v-f3c603ca"]]);export{ol as default};
