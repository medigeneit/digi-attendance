import{f as pe,g as _e,r as f,x as v,h as be,c as d,o as i,a as e,j as N,t as o,m as R,b as g,F as S,e as $,k as j,v as E,O as te}from"./index-BfMjj160.js";import{u as fe}from"./kpi-Cj6OjUSx.js";const ye={class:"max-w-7xl mx-auto py-6 px-4"},he={class:"mb-5"},ge={class:"flex flex-col md:flex-row md:items-center md:justify-between gap-3"},ke={class:"space-y-0.5"},we={class:"text-xl font-semibold"},Ne={class:"text-sm text-slate-600"},Fe={key:0,class:"inline-flex items-center gap-1"},Ce={key:1},Me={class:"text-right"},Te={class:"text-lg font-bold"},Le={key:0,class:"overflow-auto border rounded-2xl bg-white mb-6"},He={class:"min-w-[980px] w-full text-sm"},Re={class:"bg-slate-50 sticky top-0 z-10"},Se={class:"text-slate-700"},$e={class:"font-medium"},je={class:"text-[11px] text-slate-500"},Ee={key:0},Pe={key:1},Ve={key:2,class:"ml-1 rounded bg-blue-50 text-blue-700 border border-blue-200 px-1"},Ae={class:"bg-slate-100/80 border-t"},Ge=["colspan"],ze={class:"px-3 py-2 text-center"},Ue={class:"px-3 py-2"},Ke={class:"font-medium"},Be={class:"mt-1 hidden md:flex gap-1 text-[11px] text-slate-500"},De=["disabled","onClick"],Ie=["disabled","onClick"],Ye=["disabled","onClick"],qe={class:"px-3 py-2 text-center"},Oe={key:0,class:"flex items-center gap-2 justify-center"},Je=["max","onUpdate:modelValue","onChange"],Qe={key:1,class:"text-center text-slate-700"},We={key:2,class:"text-center text-slate-400"},Xe={class:"bg-slate-50 border-t"},Ze={class:"px-3 py-2 text-center font-medium"},et=["colspan"],tt={class:"font-semibold"},st={class:"text-slate-500"},lt={key:1,class:"mt-6"},ot={class:"grid lg:grid-cols-3 gap-4"},at={class:"lg:col-span-2"},nt={class:"min-w-[760px] w-full text-sm"},dt={class:"sticky top-0 bg-white z-10"},it={class:"bg-slate-100 text-slate-700"},rt={class:"text-left px-3 py-2 w-[48%] font-medium"},ut={class:"bg-slate-50"},ct={class:"px-3 py-2"},mt={class:"flex gap-1 text-[11px] text-slate-600"},vt=["onClick","disabled"],xt=["onClick","disabled"],pt=["onClick","disabled"],_t={class:"px-3 py-2 text-center"},bt={class:"px-3 py-2"},ft={class:"font-medium"},yt={class:"px-3 py-2 text-center"},ht={class:"px-3 py-2 text-center"},gt=["max","onUpdate:modelValue","onChange"],kt={key:1,class:"text-slate-700"},wt={class:"bg-slate-50 border-t"},Nt={class:"px-3 py-2 text-center font-medium"},Ft={class:"px-3 py-2 text-center"},Ct={key:0,class:"lg:col-span-1"},Mt={class:"sticky top-4 space-y-4"},Tt={class:"border rounded-2xl bg-white p-4"},Lt={class:"flex items-center justify-between"},Ht={class:"flex items-center gap-2"},Rt={key:0,class:"text-xs rounded-full border px-2 py-0.5 text-slate-700"},St={class:"text-xs rounded-full border px-2 py-0.5 text-slate-700"},$t={class:"mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3"},jt={class:"rounded-xl border p-3"},Et={class:"flex items-center justify-between"},Pt={class:"text-[11px] px-1.5 py-0.5 rounded bg-blue-50 text-blue-700 border border-blue-200"},Vt={class:"mt-1 text-sm font-semibold"},At={class:"text-xs text-slate-500"},Gt={class:"mt-2 h-2 rounded bg-slate-100 overflow-hidden"},zt={class:"rounded-xl border p-3"},Ut={class:"flex items-center justify-between"},Kt={class:"text-[11px] px-1.5 py-0.5 rounded bg-violet-50 text-violet-700 border border-violet-200"},Bt={class:"mt-1 text-sm font-semibold"},Dt={class:"text-xs text-slate-500"},It={class:"mt-2 h-2 rounded bg-slate-100 overflow-hidden"},Yt={class:"rounded-xl border p-3"},qt={class:"flex items-center justify-between"},Ot={class:"text-[11px] px-1.5 py-0.5 rounded bg-emerald-50 text-emerald-700 border border-emerald-200"},Jt={class:"mt-1 text-sm font-semibold"},Qt={class:"text-xs text-slate-500"},Wt={class:"mt-2 h-2 rounded bg-slate-100 overflow-hidden"},Xt={class:"mt-3"},Zt={key:0,class:"mt-3 rounded-xl border bg-slate-50 p-3 text-xs"},es={class:"grid grid-cols-2 gap-y-2"},ts={class:"font-medium"},ss={class:"font-medium"},ls={class:"font-medium"},os={class:"font-medium"},as={class:"font-medium"},ns={class:"font-medium"},ds={class:"font-medium"},is={class:"font-medium"},rs={key:2,class:"grid md:grid-cols-3 gap-4 mt-4"},us={class:"mt-6 flex items-center justify-between"},cs={class:"text-sm"},ms=["disabled"],_s={__name:"KpiReviewForm",setup(vs){const P=pe(),b=fe(),z=_e(),m=f({}),U=f({}),K=f(""),B=f(""),D=f(""),F=f(null),V=f(!1),I=f([]),Y=f({}),y=f(null),q=f(!1),O=v(()=>{var s;return((s=b.cycle)==null?void 0:s.groups_json)||[]}),se=s=>(s==null?void 0:s.id)==="personal"||/personal/i.test((s==null?void 0:s.label)||""),k=v(()=>O.value.find(se)||null),J=v(()=>O.value.filter(s=>!se(s))),ie=(s,t)=>(s==null?void 0:s.label)||`Group ${t+1}`,re=s=>/^hr\d*$/i.test(s)||s==="hr",le=s=>re((s==null?void 0:s.key)||"")||(s==null?void 0:s.is_hr_lane)===!0,oe=v(()=>I.value.filter(le)),C=v(()=>I.value.filter(s=>!le(s))),ue=v(()=>{var s;return Number(((s=z==null?void 0:z.user)==null?void 0:s.id)||0)}),Q=v(()=>{const s=ue.value;return s&&oe.value.find(t=>Number(t.assigned_user_id)===s)||null}),L=v(()=>{var s;return((s=Q.value)==null?void 0:s.key)||null}),ce=v(()=>!!(Q.value&&Q.value.can_current_user_review)),h=v(()=>!!(q.value||ce.value)),w=v(()=>!!y.value&&C.value.some(s=>s.key===y.value&&s.can_current_user_review));function W(s){var a;return(((a=Y.value)==null?void 0:a[s])||[])[0]||null}function ae(s,t){var r;const a=W(s);return((r=a==null?void 0:a.marks)==null?void 0:r[t])??""}function ne(s){var a,r,x,p;if(L.value){const l=W(L.value),c=(a=l==null?void 0:l.marks)==null?void 0:a[s];if(c!=null)return c}let t=null;for(const l of oe.value){const n=(((r=Y.value)==null?void 0:r[l.key])||[])[0];if(!(!n||((x=n==null?void 0:n.marks)==null?void 0:x[s])==null)){if(!t){t=n;continue}n.submitted_at&&t.submitted_at&&n.submitted_at>t.submitted_at&&(t=n)}}return((p=t==null?void 0:t.marks)==null?void 0:p[s])??""}function X(s,t){const a=Number(m.value[s]??0);a<0&&(m.value[s]=0),a>Number(t)&&(m.value[s]=Number(t))}function A(s,t,a){a==="zero"?m.value[s]=0:a==="half"?m.value[s]=Number(t)/2:a==="full"&&(m.value[s]=Number(t)),X(s,t)}function Z(s,t){s.items.forEach(a=>A(a.id,a.max,t))}const H=v(()=>{let s=0,t=0;const a=k.value;a&&a.items.forEach(x=>{s+=Number(x.max||0);const p=Number(m.value[x.id]||0);t+=Math.min(Math.max(p,0),Number(x.max||0))});const r=s>0?t/s*100:0;return{max:Number(s.toFixed(2)),got:Number(t.toFixed(2)),percent:Number(r.toFixed(2))}}),me=v(()=>!!F.value&&typeof F.value=="object"),u=v(()=>{var s;return((s=F.value)==null?void 0:s.avg)||{max:0,incharge:0,coordinator:0,final:0,percent_simple:0,percent_weighted:0}}),ee=v(()=>{var s;return((s=F.value)==null?void 0:s.year)??null}),de=v(()=>{var s;return((s=F.value)==null?void 0:s.months_total_form)??0}),ve=v(()=>{const s={};let t=1;const a=k.value;return a&&a.items.forEach(r=>{s[r.id]=t++}),s});be(async()=>{var t,a;b.cycle||await b.fetchActiveCycle(Number(P.params.employeeId));const s=await b.fetchLanes(b.cycle.id,Number(P.params.employeeId));if(U.value=s.employee,F.value=(s==null?void 0:s.annual_target_avg_marks)||null,I.value=s.lanes||[],Y.value=s.reviews_by_lane||{},q.value=!!(((t=s==null?void 0:s.meta)==null?void 0:t.is_hr)??(s==null?void 0:s.hr)??!1),y.value=((a=C.value.find(r=>r.can_current_user_review))==null?void 0:a.key)||null,O.value.forEach(r=>r.items.forEach(x=>{m.value[x.id]==null&&(m.value[x.id]=0)})),y.value){const r=W(y.value);r!=null&&r.marks&&Object.assign(m.value,r.marks)}h.value&&J.value.forEach(r=>{r.items.forEach(x=>{let p=L.value?ae(L.value,x.id):"";(p===""||p==null)&&(p=ne(x.id)),p!==""&&p!=null&&(m.value[x.id]=Number(p))})})});async function xe(){const s=h.value;await b.submitReview({cycle_id:b.cycle.id,employee_id:Number(P.params.employeeId),reviewer_lane:s?L.value:y.value,marks:m.value,strengths:K.value,gaps:B.value,suggestions:D.value}),alert("Submitted")}function _(s){const t=Number(s??0);return isNaN(t)?"0.00":t.toFixed(2)}function M(s,t){const a=Number(s??0),r=Number(t??0);return r>0?Math.round(a/r*100):0}return(s,t)=>{var a,r,x,p;return i(),d("div",ye,[e("header",he,[e("div",ge,[e("div",ke,[e("h2",we,"KPI — "+o((a=R(b).cycle)==null?void 0:a.title),1),e("p",Ne,[t[6]||(t[6]=g(" Employee: ")),e("strong",null,o((r=U.value)==null?void 0:r.name),1),t[7]||(t[7]=g(" • Designation: ")),e("strong",null,o((p=(x=U.value)==null?void 0:x.designation)==null?void 0:p.title),1),t[8]||(t[8]=g(" • Reviewing as: ")),h.value?(i(),d("strong",Fe,t[5]||(t[5]=[g(" HR "),e("span",{class:"text-[11px] rounded bg-emerald-50 border border-emerald-200 px-1.5 py-0.5 text-emerald-700"},"HR mode",-1)]))):(i(),d("strong",Ce,o(y.value||"No lane"),1))])]),e("div",Me,[t[9]||(t[9]=e("div",{class:"text-xs text-slate-500"},"Total (Personal group)",-1)),e("div",Te,o(H.value.got.toFixed(2))+" / "+o(H.value.max.toFixed(2))+" ("+o(H.value.percent.toFixed(2))+"%) ",1)]),q.value?(i(),d("button",{key:0,onClick:t[0]||(t[0]=l=>R(b).submitFinalResult(R(b).cycle.id,R(P).params.employeeId)),class:"px-5 py-2.5 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700"}," Finalize & Lock ")):N("",!0)])]),R(b).cycle&&k.value?(i(),d("section",Le,[e("table",He,[e("thead",Re,[e("tr",Se,[t[10]||(t[10]=e("th",{class:"px-3 py-2 w-[60px] text-center font-medium"},"SL",-1)),t[11]||(t[11]=e("th",{class:"text-left px-3 py-2 w-[34%] font-medium"},"মূল্যায়নের বিষয় (Personal)",-1)),t[12]||(t[12]=e("th",{class:"px-3 py-2 text-center font-medium"},"Max",-1)),(i(!0),d(S,null,$(C.value,l=>(i(),d("th",{key:l.key,class:"px-3 py-2 text-center font-medium"},[e("div",$e,o(l.label||l.key),1),e("div",je,[l.assigned_user_name?(i(),d("span",Ee,o(l.assigned_user_name),1)):(i(),d("span",Pe,"-")),l.key===y.value&&l.can_current_user_review?(i(),d("span",Ve," editable ")):N("",!0)])]))),128))])]),e("tbody",null,[e("tr",Ae,[e("td",{colspan:3+C.value.length,class:"px-3 py-2 font-medium"},o(k.value.label||"Personal"),9,Ge)]),(i(!0),d(S,null,$(k.value.items,l=>(i(),d("tr",{key:l.id,class:"border-t"},[e("td",ze,o(ve.value[l.id]),1),e("td",Ue,[e("div",Ke,o(l.label),1),e("div",Be,[e("button",{class:"border rounded px-1.5 py-0.5 disabled:opacity-40 disabled:cursor-not-allowed",disabled:!w.value,onClick:c=>w.value&&A(l.id,l.max,"zero")}," 0 ",8,De),e("button",{class:"border rounded px-1.5 py-0.5 disabled:opacity-40 disabled:cursor-not-allowed",disabled:!w.value,onClick:c=>w.value&&A(l.id,l.max,"half")}," ½ ",8,Ie),e("button",{class:"border rounded px-1.5 py-0.5 disabled:opacity-40 disabled:cursor-not-allowed",disabled:!w.value,onClick:c=>w.value&&A(l.id,l.max,"full")}," Full ",8,Ye)])]),e("td",qe,o(l.max),1),(i(!0),d(S,null,$(C.value,c=>(i(),d("td",{key:c.key,class:"px-3 py-2"},[c.key===y.value&&c.can_current_user_review?(i(),d("div",Oe,[j(e("input",{type:"number",step:"0.1",min:"0",max:l.max,"onUpdate:modelValue":n=>m.value[l.id]=n,onChange:n=>X(l.id,l.max),inputmode:"decimal",class:"w-24 text-right rounded-lg border px-2 py-1 focus:outline-none focus:ring-2 focus:ring-indigo-200"},null,40,Je),[[E,m.value[l.id],void 0,{number:!0}]])])):c.can_view_marks?(i(),d("div",Qe,o(ae(c.key,l.id)),1)):(i(),d("div",We,"—"))]))),128))]))),128)),e("tr",Xe,[t[13]||(t[13]=e("td",null,null,-1)),t[14]||(t[14]=e("td",{class:"px-3 py-2 text-right font-medium"},"Group Total",-1)),e("td",Ze,o(k.value.items.reduce((l,c)=>l+Number(c.max||0),0).toFixed(2)),1),e("td",{colspan:C.value.length,class:"px-3 py-2 text-center"},[e("span",tt,o(k.value.items.reduce((l,c)=>{const n=Number(m.value[c.id]||0);return l+Math.min(Math.max(n,0),Number(c.max||0))},0).toFixed(2)),1),e("span",st," / "+o(k.value.items.reduce((l,c)=>l+Number(c.max||0),0).toFixed(2)),1)],8,et)])])])])):N("",!0),J.value.length?(i(),d("section",lt,[e("div",ot,[e("div",at,[(i(!0),d(S,null,$(J.value,(l,c)=>(i(),d("div",{key:c,class:"overflow-auto border rounded-2xl bg-white mb-4"},[e("table",nt,[e("thead",dt,[e("tr",it,[t[15]||(t[15]=e("th",{class:"px-3 py-2 w-[60px] text-center font-medium"},"SL",-1)),e("th",rt,"গ্রুপ: "+o(c+1)+" — "+o(ie(l,c)),1),t[16]||(t[16]=e("th",{class:"px-3 py-2 text-center w-[120px] font-medium"},"Max",-1)),t[17]||(t[17]=e("th",{class:"px-3 py-2 text-center w-[160px] font-medium"},"HR",-1))])]),e("tbody",null,[e("tr",ut,[t[18]||(t[18]=e("td",null,null,-1)),e("td",ct,[e("div",mt,[e("button",{class:"border rounded px-1.5 py-0.5",onClick:n=>Z(l,"zero"),disabled:!h.value},"All 0",8,vt),e("button",{class:"border rounded px-1.5 py-0.5",onClick:n=>Z(l,"half"),disabled:!h.value},"All ½",8,xt),e("button",{class:"border rounded px-1.5 py-0.5",onClick:n=>Z(l,"full"),disabled:!h.value},"All Full",8,pt)])]),t[19]||(t[19]=e("td",null,null,-1)),t[20]||(t[20]=e("td",null,null,-1))]),(i(!0),d(S,null,$(l.items,(n,T)=>(i(),d("tr",{key:n.id,class:"border-t"},[e("td",_t,o(T+1),1),e("td",bt,[e("div",ft,o(n.label),1)]),e("td",yt,o(n.max),1),e("td",ht,[h.value?j((i(),d("input",{key:0,type:"number",step:"0.1",min:"0",max:n.max,"onUpdate:modelValue":G=>m.value[n.id]=G,onChange:G=>X(n.id,n.max),inputmode:"decimal",class:"w-24 text-right rounded-lg border px-2 py-1 focus:outline-none focus:ring-2 focus:ring-indigo-200"},null,40,gt)),[[E,m.value[n.id],void 0,{number:!0}]]):(i(),d("span",kt,o(ne(n.id)),1))])]))),128)),e("tr",wt,[t[21]||(t[21]=e("td",null,null,-1)),t[22]||(t[22]=e("td",{class:"px-3 py-2 text-right font-medium"},"Group Total",-1)),e("td",Nt,o(l.items.reduce((n,T)=>n+Number(T.max||0),0).toFixed(2)),1),e("td",Ft,o(l.items.reduce((n,T)=>{const G=Number(m.value[T.id]||0);return n+Math.min(Math.max(G,0),Number(T.max||0))},0).toFixed(2)),1)])])])]))),128))]),me.value?(i(),d("aside",Ct,[e("div",Mt,[e("div",Tt,[e("div",Lt,[t[23]||(t[23]=e("h3",{class:"font-semibold"},"Annual Target",-1)),e("div",Ht,[ee.value?(i(),d("span",Rt,"Year "+o(ee.value),1)):N("",!0),e("span",St,o(de.value)+" form(s)",1)])]),e("div",$t,[e("div",jt,[e("div",Et,[t[24]||(t[24]=e("span",{class:"text-xs font-medium text-slate-600"},"Incharge",-1)),e("span",Pt,o(M(u.value.incharge,u.value.max))+"% ",1)]),e("div",Vt,[g(o(_(u.value.incharge))+" ",1),e("span",At,"/ "+o(_(u.value.max)),1)]),e("div",Gt,[e("div",{class:"h-2 bg-blue-500",style:te({width:M(u.value.incharge,u.value.max)+"%"})},null,4)])]),e("div",zt,[e("div",Ut,[t[25]||(t[25]=e("span",{class:"text-xs font-medium text-slate-600"},"Coordinator",-1)),e("span",Kt,o(M(u.value.coordinator,u.value.max))+"% ",1)]),e("div",Bt,[g(o(_(u.value.coordinator))+" ",1),e("span",Dt,"/ "+o(_(u.value.max)),1)]),e("div",It,[e("div",{class:"h-2 bg-violet-500",style:te({width:M(u.value.coordinator,u.value.max)+"%"})},null,4)])]),e("div",Yt,[e("div",qt,[t[26]||(t[26]=e("span",{class:"text-xs font-medium text-slate-600"},"Final",-1)),e("span",Ot,o(M(u.value.final,u.value.max))+"% ",1)]),e("div",Jt,[g(o(_(u.value.final))+" ",1),e("span",Qt,"/ "+o(_(u.value.max)),1)]),e("div",Wt,[e("div",{class:"h-2 bg-emerald-500",style:te({width:M(u.value.final,u.value.max)+"%"})},null,4)])])]),t[35]||(t[35]=e("div",{class:"mt-3 text-xs text-slate-600"},[e("p",{class:"leading-5"}," Note: The “Target” group name may be unavailable. This panel summarizes the annual target averages independently of group labels. ")],-1)),e("div",Xt,[e("button",{class:"text-xs px-3 py-1.5 rounded-md border hover:bg-slate-50",onClick:t[1]||(t[1]=l=>V.value=!V.value)},o(V.value?"Hide details":"Show details"),1),V.value?(i(),d("div",Zt,[e("div",es,[t[27]||(t[27]=e("div",{class:"text-slate-500"},"Year",-1)),e("div",ts,o(ee.value||"-"),1),t[28]||(t[28]=e("div",{class:"text-slate-500"},"Forms counted",-1)),e("div",ss,o(de.value),1),t[29]||(t[29]=e("div",{class:"text-slate-500"},"Max (denominator)",-1)),e("div",ls,o(_(u.value.max)),1),t[30]||(t[30]=e("div",{class:"text-slate-500"},"Incharge avg",-1)),e("div",os,o(_(u.value.incharge)),1),t[31]||(t[31]=e("div",{class:"text-slate-500"},"Coordinator avg",-1)),e("div",as,o(_(u.value.coordinator)),1),t[32]||(t[32]=e("div",{class:"text-slate-500"},"Final avg",-1)),e("div",ns,o(_(u.value.final)),1),t[33]||(t[33]=e("div",{class:"text-slate-500"},"Percent (simple)",-1)),e("div",ds,o(_(u.value.percent_simple))+"%",1),t[34]||(t[34]=e("div",{class:"text-slate-500"},"Percent (weighted)",-1)),e("div",is,o(_(u.value.percent_weighted))+"%",1)])])):N("",!0)])])])])):N("",!0)])])):N("",!0),w.value||h.value?(i(),d("div",rs,[j(e("textarea",{"onUpdate:modelValue":t[2]||(t[2]=l=>K.value=l),placeholder:"Key Strength(s)",class:"rounded-xl border p-3 min-h-28"},null,512),[[E,K.value]]),j(e("textarea",{"onUpdate:modelValue":t[3]||(t[3]=l=>B.value=l),placeholder:"GAP(s)",class:"rounded-xl border p-3 min-h-28"},null,512),[[E,B.value]]),j(e("textarea",{"onUpdate:modelValue":t[4]||(t[4]=l=>D.value=l),placeholder:"Suggestions / Training",class:"rounded-xl border p-3 min-h-28"},null,512),[[E,D.value]])])):N("",!0),e("div",us,[e("div",cs,[t[36]||(t[36]=g("My (Personal) Total: ")),e("b",null,o(H.value.got.toFixed(2)),1),g(" / "+o(H.value.max.toFixed(2)),1)]),e("button",{onClick:xe,disabled:!(h.value||w.value),class:"px-5 py-2.5 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-40"}," Submit ",8,ms)])])}}};export{_s as default};
