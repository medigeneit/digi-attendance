import{B as _e,C as S,r as m,h as J,y as ge,c as i,o as u,k as x,a as e,t as f,l as M,v as Q,s as L,F as V,e as I,u as be,x as F,U as ne,a8 as he,q as xe,b as H,H as we,n as A,d as G,m as oe,T as re,A as ie}from"./index-ghAFMfrQ.js";const ke=_e("kpiAdmin",{state:()=>({cycles:[],lanesConfig:null,overrides:[],loading:!1,_userCache:new Map,_abortCtrls:{}}),actions:{async fetchCycles(){this.loading=!0;try{const{data:r}=await S.get("/kpi/cycles");this.cycles=r}finally{this.loading=!1}},async loadCycle(r){const{data:n}=await S.get(`/kpi/cycles/${r}`);return this.lanesConfig=n.reviewer_lanes_json||[],n},async updateLanes(r,n){const{data:d}=await S.put(`/kpi/cycles/${r}/lanes`,{reviewer_lanes_json:n});return this.lanesConfig=d.reviewer_lanes_json,d},async fetchOverrides(r){const{data:n}=await S.get("/kpi/overrides",{params:r});return this.overrides=n,n},async saveOverridesBulk(r){return(await S.post("/kpi/overrides/save-bulk",r)).data},async lookupUsers(r){var p;const n=typeof r=="string"?{q:r}:r||{},d=JSON.stringify({q:n.q||"",lane_key:n.lane_key});if(this._userCache.has(d))return this._userCache.get(d);this._abortCtrls[d]&&this._abortCtrls[d].abort();const c=new AbortController;this._abortCtrls[d]=c;try{const{data:l}=await S.get("/users",{params:n,signal:c.signal});return this._userCache.set(d,l),setTimeout(()=>this._userCache.delete(d),6e4),l}catch(l){if(l.name==="CanceledError"||(p=l.message)!=null&&p.includes("canceled"))return[];throw l}finally{delete this._abortCtrls[d]}},async lookupDepartments(r){const{data:n}=await S.get("/departments",{params:{q:r}});return n}}}),Ce={key:0,class:"mb-2 inline-flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-3 py-1"},De={class:"text-sm font-medium text-slate-800"},$e={class:"text-[11px] text-slate-500"},Ue={class:"relative"},Ee=["placeholder"],Se={key:1,class:"absolute left-0 mt-2 w-full rounded-lg border border-slate-200 bg-white shadow-lg max-h-64 overflow-auto z-20"},Le={class:"flex items-center justify-between px-3 py-2 text-xs text-slate-500"},Ae={key:0},Ve={key:0,class:"px-3 py-2 text-slate-500 text-sm"},Te=["onClick"],Ne={class:"min-w-0"},Ke=["innerHTML"],je={class:"truncate text-[11px] text-slate-500"},Re={class:"text-[11px] text-slate-400"},Ie={key:0,class:"px-3 py-3 text-slate-400 text-sm"};function Be(r,n){if(!n)return r;try{const d=new RegExp(`(${n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"ig");return(r==null?void 0:r.replace(d,"<mark>$1</mark>"))??""}catch{return r}}const Oe={__name:"AsyncUserCombobox",props:{modelValue:{type:[Number,null],default:null},display:{type:Object,default:()=>({name:null,dept:null})},placeholder:{type:String,default:"Search userâ€¦"},fetcher:{type:Function,required:!0},laneKey:{type:String,default:null},departmentId:{type:[Number,null],default:null},limit:{type:Number,default:20}},emits:["update:modelValue","update:display","cleared"],setup(r,{emit:n}){const d=r,c=n,p=m(!1),l=m(""),v=m([]),b=m(!1),h=m(-1);let D=null;async function T(){b.value=!0;const y=await d.fetcher({q:l.value,lane_key:d.laneKey,limit:d.limit});v.value=y,b.value=!1,h.value=y.length?0:-1}function w(){clearTimeout(D),D=setTimeout(T,250)}function U(){p.value=!0,l.value||w()}function E(y){if(!p.value)return;const _=v.value.length;y.key==="ArrowDown"?(y.preventDefault(),_&&(h.value=(h.value+1)%_)):y.key==="ArrowUp"?(y.preventDefault(),_&&(h.value=(h.value-1+_)%_)):y.key==="Enter"?(y.preventDefault(),_&&h.value>=0&&N(v.value[h.value])):y.key==="Escape"&&(p.value=!1)}function N(y){c("update:modelValue",y.id),c("update:display",{name:y.name,dept:y.department_name||null}),p.value=!1,l.value="",v.value=[]}function B(){c("update:modelValue",null),c("update:display",{name:null,dept:null}),c("cleared")}function $(){l.value="",v.value=[],h.value=-1,p.value&&w()}function k(y){const _=K.value;_&&!_.contains(y.target)&&(p.value=!1)}const K=m(null);return J(()=>document.addEventListener("click",k)),ge(()=>document.removeEventListener("click",k)),(y,_)=>{var O,j;return u(),i("div",{ref_key:"wrapper",ref:K,class:"relative w-full max-w-xl"},[r.modelValue?(u(),i("div",Ce,[e("span",De,f(((O=r.display)==null?void 0:O.name)||"User #"+r.modelValue),1),e("span",$e,f(((j=r.display)==null?void 0:j.dept)||""),1),e("button",{onClick:B,class:"text-xs px-2 py-0.5 rounded-full border border-slate-200 hover:bg-white"},"Clear")])):x("",!0),e("div",Ue,[_[2]||(_[2]=e("span",{class:"pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"},[e("i",{class:"far fa-search"})],-1)),M(e("input",{placeholder:r.placeholder,class:"w-full rounded-lg border border-slate-200 bg-white py-2 pl-9 pr-10 text-sm shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200","onUpdate:modelValue":_[0]||(_[0]=C=>l.value=C),onFocus:U,onInput:w,onKeydown:E},null,40,Ee),[[Q,l.value]]),l.value?(u(),i("button",{key:0,type:"button",class:"absolute right-2 top-1/2 -translate-y-1/2 rounded-full px-2 py-1 text-xs text-slate-500 hover:bg-slate-100",onClick:$}," Clear ")):x("",!0),b.value?(u(),i("span",{key:1,class:L(["absolute top-1/2 -translate-y-1/2 text-slate-400",l.value?"right-8":"right-2"])},_[1]||(_[1]=[e("i",{class:"fas fa-spinner fa-spin"},null,-1)]),2)):x("",!0)]),p.value?(u(),i("div",Se,[e("div",Le,[_[3]||(_[3]=e("span",null,"Results",-1)),v.value.length?(u(),i("span",Ae,f(v.value.length),1)):x("",!0)]),b.value?(u(),i("div",Ve,"Searching???")):(u(),i(V,{key:1},[(u(!0),i(V,null,I(v.value,(C,P)=>(u(),i("button",{key:C.id,onClick:R=>N(C),class:L(["flex w-full items-center justify-between gap-3 px-3 py-2 text-left hover:bg-slate-50",P===h.value?"bg-slate-50":""])},[e("div",Ne,[e("div",{class:"truncate text-sm font-medium text-slate-800",innerHTML:Be(C.name,l.value)},null,8,Ke),e("div",je,f(C.department_name||"Unknown department"),1)]),e("span",Re,"#"+f(C.id||"N/A"),1)],10,Te))),128)),v.value.length?x("",!0):(u(),i("div",Ie,"No results"))],64))])):x("",!0)],512)}}},Pe={class:"max-w-6xl mx-auto px-4 py-6 space-y-6"},Fe={class:"sticky top-0 z-20 -mx-4 px-4 pt-3 pb-4 bg-white/90 backdrop-blur border-b shadow-sm"},Me={class:"flex flex-col gap-3"},ze={class:"flex items-center justify-between gap-3"},qe={class:"text-xs text-slate-600 flex items-center gap-3"},He={class:"inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5"},Ge={key:0,class:"inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 text-amber-700"},Je={class:"flex items-center gap-2"},Qe=["value"],Ye={class:"flex flex-wrap items-center justify-between gap-3"},We={class:"inline-flex rounded-full border border-slate-200 overflow-hidden bg-white shadow-sm"},Xe={class:"flex items-center gap-2"},Ze=["disabled"],et={class:"w-full gap-4"},tt={key:0,class:"rounded-2xl border border-slate-200 bg-white p-4 relative shadow-sm"},st={class:"flex items-center justify-between mb-3"},at={class:"text-xs text-slate-500"},lt={class:"flex items-center gap-2"},nt={key:0,class:"inline-flex items-center gap-2 bg-slate-100 text-slate-800 px-3 py-1.5 rounded-full"},ot={class:"text-sm font-medium"},rt={class:"p-3 border-b border-slate-200"},it={class:"max-h-[18rem] overflow-auto"},ut=["onClick"],dt={class:"truncate"},ct={class:"text-[11px] text-slate-500"},pt={key:1,class:"px-4 py-8 text-center text-sm text-slate-500"},vt={key:1,class:"rounded-2xl border border-slate-200 p-4 bg-white relative shadow-sm"},ft={class:"flex items-center justify-between mb-3"},mt={class:"text-xs text-slate-500"},yt={class:"flex items-center gap-2"},_t={key:0,class:"inline-flex items-center gap-2 bg-slate-100 text-slate-800 px-3 py-1.5 rounded-full"},gt={class:"text-sm font-medium"},bt={class:"text-xs text-slate-500"},ht={class:"p-3 border-b border-slate-200"},xt={class:"max-h-[18rem] overflow-auto"},wt=["onClick"],kt={class:"truncate"},Ct={class:"text-[11px] text-slate-500"},Dt={key:1,class:"px-4 py-8 text-center text-sm text-slate-500"},$t={class:"rounded-2xl border border-slate-200 bg-white overflow-auto shadow-sm"},Ut={class:"w-full text-sm"},Et={class:"px-3 py-3"},St={class:"font-medium text-slate-800"},Lt={class:"text-[11px] text-slate-500"},At={class:"px-3 py-3"},Tt={__name:"LaneOverridesPage",setup(r){const n=ke();be();const d=m(null),c=m("department"),p=m(null),l=m(null),v=m([]),b=m(!1),h=m(""),D=m([]),T=m(""),w=m([]),U=m(!1),E=m(!1),N=m(null),B=m(null),$=m(0),k=m(0),K=(t,a=300)=>{let s;return(...o)=>{clearTimeout(s),s=setTimeout(()=>t(...o),a)}};function y(t,a){const s=o=>{const g=t.value;g&&(o.target===g||g.contains(o.target)||a())};J(()=>document.addEventListener("mousedown",s)),ne(()=>document.removeEventListener("mousedown",s))}y(N,()=>{U.value=!1}),y(B,()=>{E.value=!1});const _=F(()=>v.value.length),O=F(()=>v.value.filter(t=>t.assigned_user_id).length),j=F(()=>c.value==="department"?p.value?`Department: ${p.value.name}`:"Select a department":l.value?`Employee: ${l.value.name}`:"Select an employee");J(async()=>{await n.fetchCycles(),n.cycles.length&&(d.value=n.cycles[0].id,await R()),window.addEventListener("beforeunload",C),window.addEventListener("keydown",P)}),ne(()=>{window.removeEventListener("beforeunload",C),window.removeEventListener("keydown",P)}),he((t,a,s)=>{if(!b.value)return s();confirm("You have unsaved changes. Leave without saving?")?s():s(!1)});function C(t){b.value&&(t.preventDefault(),t.returnValue="")}function P(t){(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="s"&&(t.preventDefault(),q.value&&W())}async function R(){await n.loadCycle(d.value),v.value=(n.lanesConfig||[]).map(t=>({lane_key:t.key,label:t.label,assigned_user_id:null,assignee_name:null,assignee_dept:null})),b.value=!1,(c.value==="department"&&p.value||c.value==="employee"&&l.value)&&await z()}async function z(){const t={cycle_id:d.value,scope:c.value};c.value==="department"&&p.value&&(t.department_id=p.value.id),c.value==="employee"&&l.value&&(t.employee_id=l.value.id);const a=await n.fetchOverrides(t),s={};(a.data||[]).forEach(o=>{var g,se,ae,le;s[o.lane_key]={id:o.assigned_user_id,name:((g=o.assignee)==null?void 0:g.name)||null,dept:((ae=(se=o.assignee)==null?void 0:se.department)==null?void 0:ae.name)||(((le=o.assignee)==null?void 0:le.department_name)??null)}}),v.value=(n.lanesConfig||[]).map(o=>{const g=s[o.key]||null;return{lane_key:o.key,label:o.label,assigned_user_id:(g==null?void 0:g.id)??null,assignee_name:(g==null?void 0:g.name)??null,assignee_dept:(g==null?void 0:g.dept)??null}}),b.value=!1}function Y(t,a,s){t.assigned_user_id=a,t.assignee_name=(s==null?void 0:s.name)||null,t.assignee_dept=(s==null?void 0:s.dept)||null,b.value=!0}function ue(t){t.assigned_user_id=null,t.assignee_name=null,t.assignee_dept=null,b.value=!0}function de(){const t=v.value.find(a=>a.assigned_user_id);t&&(v.value.forEach(a=>{a.assigned_user_id||(a.assigned_user_id=t.assigned_user_id,a.assignee_name=t.assignee_name,a.assignee_dept=t.assignee_dept)}),b.value=!0)}const q=F(()=>!!d.value&&(c.value==="department"?!!p.value:!!l.value)&&b.value);async function W(){var a,s;if(!d.value)return alert("Select cycle");if(c.value==="department"&&!p.value)return alert("Select department");if(c.value==="employee"&&!l.value)return alert("Select employee");const t={cycle_id:d.value,scope:c.value,department_id:c.value==="department"?(a=p==null?void 0:p.value)==null?void 0:a.id:null,employee_id:c.value==="employee"?(s=l==null?void 0:l.value)==null?void 0:s.id:null,overrides:v.value.map(o=>({lane_key:o.lane_key,assigned_user_id:o.assigned_user_id}))};try{await n.saveOverridesBulk(t),b.value=!1,alert("Saved!")}catch(o){console.error(o),alert("Failed to save")}}const X=K(async()=>{D.value=await n.lookupDepartments(h.value),$.value=0},250),Z=K(async()=>{w.value=await n.lookupUsers(T.value),k.value=0},250);function ce(){U.value=!0,ie(()=>{const t=document.getElementById("dept-search-input");t&&t.focus()})}function pe(){E.value=!0,ie(()=>{const t=document.getElementById("user-search-input");t&&t.focus()})}function ee(t){p.value=t,U.value=!1,D.value=[],z()}function ve(){p.value=null,v.value=v.value.map(t=>({...t,assigned_user_id:null,assignee_name:null,assignee_dept:null})),b.value=!1}function te(t){l.value=t,E.value=!1,w.value=[],z()}function fe(){l.value=null,v.value=v.value.map(t=>({...t,assigned_user_id:null,assignee_name:null,assignee_dept:null})),b.value=!1}function me(t){const a=D.value.length;a&&(t.key==="ArrowDown"&&(t.preventDefault(),$.value=($.value+1)%a),t.key==="ArrowUp"&&(t.preventDefault(),$.value=($.value-1+a)%a),t.key==="Enter"&&(t.preventDefault(),ee(D.value[$.value])),t.key==="Escape"&&(t.preventDefault(),U.value=!1))}function ye(t){const a=w.value.length;a&&(t.key==="ArrowDown"&&(t.preventDefault(),k.value=(k.value+1)%a),t.key==="ArrowUp"&&(t.preventDefault(),k.value=(k.value-1+a)%a),t.key==="Enter"&&(t.preventDefault(),te(w.value[k.value])),t.key==="Escape"&&(t.preventDefault(),E.value=!1))}return xe([c,d],()=>{p.value=null,l.value=null,R()}),(t,a)=>(u(),i("div",Pe,[e("header",Fe,[e("div",Me,[e("div",ze,[e("div",null,[a[9]||(a[9]=e("h1",{class:"text-lg md:text-xl font-semibold text-slate-900"},"KPI Lane Overrides",-1)),e("div",qe,[e("span",He,[a[7]||(a[7]=H(" Assigned: ")),e("b",null,f(O.value),1),a[8]||(a[8]=H("/")),e("b",null,f(_.value),1)]),b.value?(u(),i("span",Ge,"Unsaved changes")):x("",!0)])]),e("div",Je,[M(e("select",{"onUpdate:modelValue":a[0]||(a[0]=s=>d.value=s),onChange:R,class:"border border-slate-200 rounded-lg px-3 py-2 bg-white text-sm shadow-sm"},[(u(!0),i(V,null,I(A(n).cycles,s=>(u(),i("option",{value:s.id,key:s.id},f(s.title)+" ("+f(s.year)+") ",9,Qe))),128))],544),[[we,d.value]]),e("button",{onClick:R,class:"px-3 py-2 border border-slate-200 rounded-lg text-sm hover:bg-slate-50"},"Reload")])]),e("div",Ye,[e("div",We,[e("button",{onClick:a[1]||(a[1]=s=>c.value="department"),class:L(["px-4 py-2 text-sm transition",c.value==="department"?"bg-slate-900 text-white":"bg-white hover:bg-slate-50"])},"Department",2),e("button",{onClick:a[2]||(a[2]=s=>c.value="employee"),class:L(["px-4 py-2 text-sm transition border-l border-slate-200",c.value==="employee"?"bg-slate-900 text-white":"bg-white hover:bg-slate-50"])},"Employee",2)]),e("div",Xe,[e("button",{onClick:de,class:"px-3 py-1.5 border border-slate-200 rounded-lg text-sm hover:bg-slate-50"},"Apply to all empty lanes"),e("button",{onClick:W,disabled:!q.value,class:L(["px-4 py-2 rounded-xl text-white text-sm font-medium transition shadow-sm",q.value?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-400 cursor-not-allowed"])}," Save (Ctrl/Cmd+S) ",10,Ze)])])])]),e("div",et,[c.value==="department"?(u(),i("div",tt,[e("div",st,[a[10]||(a[10]=e("div",{class:"text-sm font-semibold text-slate-800"},"Target Department",-1)),e("span",at,f(j.value),1)]),e("div",lt,[e("button",{class:"px-3 py-2 rounded-lg border border-slate-200 text-sm hover:bg-slate-50",onClick:ce},f(p.value?"Change department":"Choose department"),1),p.value?(u(),i("div",nt,[e("span",ot,f(p.value.name),1),e("button",{onClick:ve,class:"text-xs rounded-full px-2 py-0.5 border border-slate-200 hover:bg-white",title:"Clear"},"Clear")])):x("",!0)]),G(re,{"enter-active-class":"transition ease-out duration-150","enter-from-class":"opacity-0 translate-y-1","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition ease-in duration-100","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 translate-y-1"},{default:oe(()=>[U.value?(u(),i("div",{key:0,ref_key:"deptPopoverRef",ref:N,class:"absolute z-30 mt-2 w-full md:w-[28rem] max-h-[22rem] overflow-hidden rounded-xl border border-slate-200 bg-white shadow-xl"},[e("div",rt,[M(e("input",{id:"dept-search-input","onUpdate:modelValue":a[3]||(a[3]=s=>h.value=s),onInput:a[4]||(a[4]=(...s)=>A(X)&&A(X)(...s)),onKeydown:me,placeholder:"Search department",class:"w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200"},null,544),[[Q,h.value]])]),e("div",it,[D.value.length?(u(!0),i(V,{key:0},I(D.value,(s,o)=>(u(),i("button",{key:s.id,onClick:g=>ee(s),class:L(["flex w-full items-center justify-between px-3 py-2 border-b border-slate-100 last:border-b-0 text-left",o===$.value?"bg-slate-50":"hover:bg-slate-50"])},[e("span",dt,f(s.name),1),e("span",ct,"#"+f(s.id),1)],10,ut))),128)):(u(),i("div",pt,"No departments found"))])],512)):x("",!0)]),_:1})])):(u(),i("div",vt,[e("div",ft,[a[11]||(a[11]=e("div",{class:"text-sm font-semibold text-slate-800"},"Target Employee",-1)),e("span",mt,f(j.value),1)]),e("div",yt,[e("button",{class:"px-3 py-2 rounded-lg border border-slate-200 text-sm hover:bg-slate-50",onClick:pe},f(l.value?"Change employee":"Choose employee"),1),l.value?(u(),i("div",_t,[e("span",gt,[H(f(l.value.name)+" ",1),e("span",bt," - "+f(l.value.department_name||"N/A"),1)]),e("button",{onClick:fe,class:"text-xs rounded-full px-2 py-0.5 border border-slate-200 hover:bg-white",title:"Clear"},"Clear")])):x("",!0)]),G(re,{"enter-active-class":"transition ease-out duration-150","enter-from-class":"opacity-0 translate-y-1","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition ease-in duration-100","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 translate-y-1"},{default:oe(()=>[E.value?(u(),i("div",{key:0,ref_key:"userPopoverRef",ref:B,class:"absolute z-30 mt-2 w-full md:w-[32rem] max-h-[22rem] overflow-hidden rounded-xl border border-slate-200 bg-white shadow-xl"},[e("div",ht,[M(e("input",{id:"user-search-input","onUpdate:modelValue":a[5]||(a[5]=s=>T.value=s),onInput:a[6]||(a[6]=(...s)=>A(Z)&&A(Z)(...s)),onKeydown:ye,placeholder:"Search employee",class:"w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200"},null,544),[[Q,T.value]])]),e("div",xt,[w.value.length?(u(!0),i(V,{key:0},I(w.value,(s,o)=>(u(),i("button",{key:s.id,onClick:g=>te(s),class:L(["flex w-full items-center justify-between px-3 py-2 border-b border-slate-100 last:border-b-0 text-left",o===k.value?"bg-slate-50":"hover:bg-slate-50"])},[e("span",kt,f(s.name),1),e("span",Ct,f(s.department_name||"N/A"),1)],10,wt))),128)):(u(),i("div",Dt,"No employees found"))])],512)):x("",!0)]),_:1})]))]),e("div",$t,[e("table",Ut,[a[12]||(a[12]=e("thead",{class:"bg-slate-50 text-xs uppercase tracking-wide text-slate-500"},[e("tr",null,[e("th",{class:"text-left px-3 py-2 w-[30%]"},"Lane"),e("th",{class:"text-left px-3 py-2"},"Assignee")])],-1)),e("tbody",null,[(u(!0),i(V,null,I(v.value,s=>(u(),i("tr",{key:s.lane_key,class:"border-t border-slate-100 hover:bg-slate-50/60"},[e("td",Et,[e("div",St,f(s.label),1),e("div",Lt,f(s.lane_key),1)]),e("td",At,[G(Oe,{"model-value":s.assigned_user_id,display:{name:s.assignee_name,dept:s.assignee_dept},"lane-key":s.lane_key,fetcher:o=>A(n).lookupUsers(o),placeholder:"Search user for this lane","onUpdate:modelValue":o=>Y(s,o,{name:s.assignee_name,dept:s.assignee_dept}),"onUpdate:display":o=>Y(s,s.assigned_user_id,o),onCleared:()=>ue(s)},null,8,["model-value","display","lane-key","fetcher","onUpdate:modelValue","onUpdate:display","onCleared"])])]))),128))])])])]))}};export{Tt as default};
