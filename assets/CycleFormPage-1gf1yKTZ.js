import{f as X,u as ee,r as p,x as te,q as se,h as le,c as d,o as r,a as e,j as L,t as v,k as n,v as i,H as E,b as G,F as U,e as $}from"./index-BAzg4SAU.js";import{u as oe}from"./kpiCycleAdmin-D56XJvln.js";const ae={class:"max-w-6xl mx-auto p-4 space-y-5"},ne={class:"flex items-center justify-between"},de={class:"flex items-center gap-3"},re={class:"text-xl font-semibold"},ie={class:"grid md:grid-cols-3 gap-3"},ue={class:"rounded-xl border card-bg p-3"},ce={class:"space-y-2"},pe={class:"text-xs text-slate-600"},me={class:"rounded-xl border card-bg p-3 md:col-span-2"},ve={class:"grid md:grid-cols-3 gap-2"},be={class:"text-xs text-slate-600 mb-1 capitalize"},xe={class:"flex items-center gap-1"},ye=["onUpdate:modelValue"],_e=["onUpdate:modelValue"],fe={class:"rounded-xl border card-bg p-3"},he={class:"overflow-auto"},ke={class:"w-full text-sm min-w-[760px]"},ge={class:"px-2 py-1"},we=["onClick"],Ce=["onClick"],Ve={class:"px-2 py-1"},Ue=["onUpdate:modelValue"],$e={class:"px-2 py-1"},Ie=["onUpdate:modelValue"],De={class:"px-2 py-1"},Ae=["onUpdate:modelValue","onChange"],Le={class:"px-2 py-1"},Ge=["onUpdate:modelValue"],Se=["onUpdate:modelValue"],je={class:"px-2 py-1"},Me=["onClick"],Te={class:"rounded-xl border p-3"},Ne={class:"space-y-4 mt-3"},Ee={class:"flex items-center justify-between bg-slate-50 px-3 py-2"},Ke={class:"font-medium"},Pe={class:"flex items-center gap-2"},Fe=["onClick"],Re=["onClick"],ze=["onClick"],Be={class:"p-3 overflow-auto"},qe={class:"w-full text-sm min-w-[720px]"},Oe={class:"px-2 py-1"},He={class:"px-2 py-1"},Ye=["onUpdate:modelValue"],Ze={class:"px-2 py-1"},Je=["onUpdate:modelValue"],Qe={class:"px-2 py-1"},We=["onUpdate:modelValue"],Xe={class:"px-2 py-1"},et=["onClick"],tt=["onClick"],st=["onClick"],lt={class:"mt-2"},ot=["onClick"],at={class:"text-xs text-slate-600 ml-3"},nt={class:"flex items-center justify-between mt-3"},dt={class:"text-sm text-slate-700"},rt={key:0,class:"fixed inset-0 z-50"},it={class:"absolute left-1/2 top-1/2 w-[92vw] max-w-md -translate-x-1/2 -translate-y-1/2 rounded-2xl border bg-white shadow-xl",role:"dialog","aria-modal":"true","aria-labelledby":"addGroupTitle"},ut={class:"p-4 space-y-3"},ct={key:0,class:"mt-1 text-xs text-red-600"},pt={key:0,class:"mt-1 text-xs text-red-600"},xt={__name:"CycleFormPage",setup(mt){const S=X();ee();const k=oe(),_=p(S.params.id?Number(S.params.id):null),g=p("KPI 2025"),w=p("executives"),C=p(new Date().getFullYear()),m=p([{id:"personal",label:"Personal Attributes (25)",items:[{id:"attitude",label:"ব্যক্তিত্ব ও আচরণ",max:2.5},{id:"punctual",label:"সময়নিষ্ঠতা",max:2.5},{id:"teamwork",label:"সহযোগিতা ও আচরণ",max:5},{id:"discipline",label:"শৃঙ্খলা",max:5},{id:"communication",label:"কমিউনিকেশন",max:5},{id:"ethics",label:"নৈতিকতা",max:5}]},{id:"training",label:"Training (15)",items:[{id:"tech_training",label:"প্রযুক্তিগত প্রশিক্ষণ",max:5},{id:"cert",label:"সার্টিফিকেশন/সেমিনার",max:5},{id:"onjob",label:"অন জব লার্নিং",max:5}]},{id:"performance",label:"কাজের কার্যসম্পাদন (25)",items:[{id:"quality",label:"কাজের মান",max:10},{id:"planning",label:"পরিকল্পনা/ম্যানেজমেন্ট",max:7},{id:"report",label:"রিপোর্টিং/ডকুমেন্টেশন",max:8}]},{id:"target",label:"Monthly Target (25)",items:[{id:"target",label:"টার্গেট এচিভমেন্ট",max:25}]}]),u=p([{key:"incharge",label:"Incharge",rank:10,source:{type:"department_field",field:"incharge_id"}},{key:"op_admin",label:"Op. Admin",rank:20,source:{type:"department_field",field:"operational_admin_user_id"}},{key:"hr",label:"HR",rank:25,source:{type:"manual",permission:"kpi.review.lane.hr"}},{key:"coordinator",label:"Coordinator / AD / DD",rank:30,source:{type:"department_field",field:"coordinator_id"}},{key:"cc",label:"CC",rank:40,source:{type:"department_field",field:"recommend_by_user_id"}},{key:"supv_director",label:"Supv. Director",rank:50,source:{type:"department_field",field:"approved_by_user_id"}},{key:"da",label:"DA",rank:60,source:{type:"manual",permission:"kpi.da"}}]),f=p({excellent:[91,100],good:[81,90],satisfactory:[71,80],average:[51,70],below:[0,50]}),j=te(()=>{let s=0;return m.value.forEach(t=>t.items.forEach(l=>s+=Number(l.max||0))),Number(s.toFixed(2))});function h(s,t,l){const o=t+l;o<0||o>=s.length||([s[t],s[o]]=[s[o],s[t]])}const I=p(!1),b=p({id:"",label:""}),D=p(!1),x=p({id:"",label:""});function K(s){return String(s||"").trim().toLowerCase().replace(/[^\w]+/g,"_").replace(/^_+|_+$/g,"").slice(0,40)||`group_${m.value.length+1}`}se(()=>b.value.label,s=>{D.value||(b.value.id=K(s))});function P(){D.value=!0}function F(){x.value={id:"",label:""};const{id:s,label:t}=b.value;let l=!0;return(!t||!t.trim())&&(x.value.label="Label is required",l=!1),(!s||!/^[A-Za-z0-9_]+$/.test(s))&&(x.value.id="ID must be letters/numbers/underscore only",l=!1),m.value.some(o=>o.id===s)&&(x.value.id="This ID already exists",l=!1),l}function R(){I.value=!0,b.value={id:"",label:""},D.value=!1,x.value={id:"",label:""}}function V(){I.value=!1}function z(){if(!F())return;const{id:s,label:t}=b.value;m.value.push({id:s,label:t,items:[]}),V()}function B(s){s.items.push({id:"item_"+(s.items.length+1),label:"New Item",max:1})}function q(s){m.value.splice(s,1)}function O(s,t){s.items.splice(t,1)}const A={incharge:"incharge_id",op_admin:"operational_admin_user_id",coordinator:"coordinator_id",cc:"recommend_by_user_id",supv_director:"approved_by_user_id",hr:"approved_by_user_id"};function M(s,t=0){var y,c,N;const l=s.key||`lane_${t+1}`,o=((y=s.source)==null?void 0:y.type)||"manual",a={key:l,label:s.label||l,rank:s.rank??(t+1)*10,source:{type:o}};return o==="department_field"?a.source.field=((c=s.source)==null?void 0:c.field)||A[l]||"":a.source.permission=((N=s.source)==null?void 0:N.permission)||`kpi.review.lane.${l}`,a}function H(){u.value.push({key:"",label:"New Lane",rank:(u.value.length+1)*10,source:{type:"manual",permission:""}})}function Y(s){u.value.splice(s,1)}function Z(s){s.source||(s.source={type:"manual"}),s.source.type==="department_field"?("field"in s.source||(s.source.field=A[s.key]||""),delete s.source.permission):("permission"in s.source||(s.source.permission=`kpi.review.lane.${s.key||"new"}`),delete s.source.field)}function J(s){const t=new Set;for(const l of s){if(!l.key||!/^[A-Za-z0-9_]+$/.test(l.key))throw new Error(`Invalid lane key "${l.key||"(empty)"}". Use letters/numbers/underscore only.`);if(t.has(l.key))throw new Error(`Duplicate lane key "${l.key}".`);t.add(l.key)}}le(async()=>{if(_.value){const s=await k.load(_.value);g.value=s.title,w.value=s.slug,C.value=s.year,m.value=s.groups_json||[],u.value=(s.reviewer_lanes_json||[]).map((t,l)=>M(t,l)),f.value=s.grading_json||f.value}else u.value=u.value.map((s,t)=>M(s,t))});function Q(s){return s.map((t,l)=>{const o={...t,rank:t.rank??(l+1)*10,source:{...t.source||{}}};if(o.source.type==="department_field"){if(o.source.field=o.source.field||A[o.key]||"",!o.source.field)throw new Error(`Missing department field for lane '${o.key}'. Please set source.field.`);delete o.source.permission}else o.source.permission=o.source.permission||`kpi.review.lane.${o.key}`,delete o.source.field;return o})}async function T(){try{J(u.value);const s={title:g.value,slug:w.value,year:C.value,groups:m.value,lanes:Q(u.value),grading:f.value};_.value?await k.update(_.value,s):_.value=(await k.create(s)).id,alert("Saved!")}catch(s){console.error(s),alert((s==null?void 0:s.message)||"Failed to save")}}async function W(){if(!_.value){alert("Save first");return}await k.activate(_.value),alert("Activated!")}return(s,t)=>(r(),d("div",ae,[e("header",ne,[e("div",de,[e("button",{class:"px-3 py-1.5 rounded-lg border",onClick:t[0]||(t[0]=l=>s.$router.push({name:"KpiCycles"}))},"← Back"),e("h1",re,v(_.value?"Edit KPI Cycle":"Create KPI Cycle"),1)]),e("div",{class:"flex gap-2"},[e("button",{onClick:T,class:"btn-2"},"Save Draft"),e("button",{onClick:W,class:"btn-1"},"Activate")])]),e("div",ie,[e("div",ue,[t[8]||(t[8]=e("div",{class:"text-sm font-medium mb-2"},"Basic",-1)),e("div",ce,[n(e("input",{"onUpdate:modelValue":t[1]||(t[1]=l=>g.value=l),class:"input-1",placeholder:"Title e.g., KPI 2025"},null,512),[[i,g.value]]),n(e("input",{"onUpdate:modelValue":t[2]||(t[2]=l=>C.value=l),type:"number",class:"input-1",placeholder:"Year"},null,512),[[i,C.value]]),n(e("select",{"onUpdate:modelValue":t[3]||(t[3]=l=>w.value=l),type:"text",class:"input-1",placeholder:"Year"},t[6]||(t[6]=[e("option",{value:"executives"},"Executives",-1),e("option",{value:"support_staff"},"Support Staff",-1),e("option",{value:"academy_body"},"Academy Body",-1),e("option",{value:"doctor"},"Doctor",-1)]),512),[[E,w.value]]),e("div",pe,[t[7]||(t[7]=G("Total Max: ")),e("b",null,v(j.value),1)])])]),e("div",me,[t[10]||(t[10]=e("div",{class:"text-sm font-medium mb-2"},"Grading (0–100)",-1)),e("div",ve,[(r(!0),d(U,null,$(f.value,(l,o)=>(r(),d("div",{key:o,class:"border rounded-lg p-2"},[e("div",be,v(o),1),e("div",xe,[n(e("input",{type:"number","onUpdate:modelValue":a=>f.value[o][0]=a,class:"border rounded px-2 py-1 w-20 text-right"},null,8,ye),[[i,f.value[o][0],void 0,{number:!0}]]),t[9]||(t[9]=e("span",null,"–",-1)),n(e("input",{type:"number","onUpdate:modelValue":a=>f.value[o][1]=a,class:"border rounded px-2 py-1 w-20 text-right"},null,8,_e),[[i,f.value[o][1],void 0,{number:!0}]])])]))),128))])])]),e("div",fe,[e("div",{class:"flex items-center justify-between mb-2"},[t[11]||(t[11]=e("div",{class:"text-sm font-medium"},"Reviewer Lanes & Hierarchy",-1)),e("button",{class:"btn-2",onClick:H},"Add Lane")]),e("div",he,[e("table",ke,[t[13]||(t[13]=e("thead",{class:"bg-slate-50"},[e("tr",null,[e("th",{class:"text-left px-2 py-1"},"Order"),e("th",{class:"text-left px-2 py-1"},"Key"),e("th",{class:"text-left px-2 py-1"},"Label"),e("th",{class:"text-left px-2 py-1"},"Source"),e("th",{class:"text-left px-2 py-1"},"Field / Permission"),e("th",{class:"text-left px-2 py-1"})])],-1)),e("tbody",null,[(r(!0),d(U,null,$(u.value,(l,o)=>(r(),d("tr",{key:o,class:"border-t"},[e("td",ge,[e("button",{class:"border rounded px-2 text-xs mr-1",onClick:a=>h(u.value,o,-1)},"↑",8,we),e("button",{class:"border rounded px-2 text-xs",onClick:a=>h(u.value,o,1)},"↓",8,Ce)]),e("td",Ve,[n(e("input",{"onUpdate:modelValue":a=>l.key=a,class:"border rounded px-2 py-1 w-32"},null,8,Ue),[[i,l.key]])]),e("td",$e,[n(e("input",{"onUpdate:modelValue":a=>l.label=a,class:"border rounded px-2 py-1 w-56"},null,8,Ie),[[i,l.label]])]),e("td",De,[n(e("select",{"onUpdate:modelValue":a=>l.source.type=a,class:"border rounded px-2 py-1",onChange:a=>Z(l)},t[12]||(t[12]=[e("option",{value:"department_field"},"department_field",-1),e("option",{value:"manual"},"manual",-1)]),40,Ae),[[E,l.source.type]])]),e("td",Le,[l.source.type==="department_field"?n((r(),d("input",{key:0,"onUpdate:modelValue":a=>l.source.field=a,class:"border rounded px-2 py-1 w-64",placeholder:"e.g., incharge_id"},null,8,Ge)),[[i,l.source.field]]):n((r(),d("input",{key:1,"onUpdate:modelValue":a=>l.source.permission=a,class:"border rounded px-2 py-1 w-64",placeholder:"permission e.g., kpi.review.lane.hr"},null,8,Se)),[[i,l.source.permission]])]),e("td",je,[e("button",{class:"border rounded px-2 text-xs",onClick:a=>Y(o)},"Remove",8,Me)])]))),128))])])]),t[14]||(t[14]=e("div",{class:"text-xs text-slate-500 mt-2"},"Order (top→bottom) ই হল hierarchy rank।",-1))]),e("div",Te,[e("div",{class:"flex items-center justify-between"},[t[15]||(t[15]=e("div",{class:"text-sm font-medium"},"Groups & Items",-1)),e("button",{onClick:R,class:"btn-2"},"Add Group")]),e("div",Ne,[(r(!0),d(U,null,$(m.value,(l,o)=>(r(),d("div",{key:l.id,class:"rounded-lg border card-bg"},[e("div",Ee,[e("div",Ke,v(o+1)+". "+v(l.label),1),e("div",Pe,[e("button",{class:"px-2 py-1 text-xs border rounded",onClick:a=>h(m.value,o,-1)},"↑",8,Fe),e("button",{class:"px-2 py-1 text-xs border rounded",onClick:a=>h(m.value,o,1)},"↓",8,Re),e("button",{class:"px-2 py-1 text-xs border rounded",onClick:a=>q(o)},"Remove",8,ze)])]),e("div",Be,[e("table",qe,[t[16]||(t[16]=e("thead",null,[e("tr",{class:"text-left bg-slate-50"},[e("th",{class:"px-2 py-1 w-14"},"SL"),e("th",{class:"px-2 py-1"},"Item ID"),e("th",{class:"px-2 py-1"},"Label"),e("th",{class:"px-2 py-1 w-24"},"Max"),e("th",{class:"px-2 py-1 w-40"})])],-1)),e("tbody",null,[(r(!0),d(U,null,$(l.items,(a,y)=>(r(),d("tr",{key:a.id,class:"border-t bg-white"},[e("td",Oe,v(y+1),1),e("td",He,[n(e("input",{"onUpdate:modelValue":c=>a.id=c,class:"border rounded px-2 py-1 w-40"},null,8,Ye),[[i,a.id]])]),e("td",Ze,[n(e("input",{"onUpdate:modelValue":c=>a.label=c,class:"border rounded px-2 py-1 w-full"},null,8,Je),[[i,a.label]])]),e("td",Qe,[n(e("input",{"onUpdate:modelValue":c=>a.max=c,type:"number",min:"0",step:"0.5",class:"border rounded px-2 py-1 w-24 text-right"},null,8,We),[[i,a.max,void 0,{number:!0}]])]),e("td",Xe,[e("button",{class:"px-2 py-1 text-xs border rounded mr-1",onClick:c=>h(l.items,y,-1)},"↑",8,et),e("button",{class:"px-2 py-1 text-xs border rounded mr-1",onClick:c=>h(l.items,y,1)},"↓",8,tt),e("button",{class:"px-2 py-1 text-xs border rounded",onClick:c=>O(l,y)},"Remove",8,st)])]))),128))])]),e("div",lt,[e("button",{onClick:a=>B(l),class:"btn-2"},"Add Item",8,ot),e("span",at,"Group total: "+v(l.items.reduce((a,y)=>a+Number(y.max||0),0)),1)])])]))),128))]),e("div",nt,[e("div",dt,[t[17]||(t[17]=G("Overall Total Max: ")),e("b",null,v(j.value),1)]),e("button",{onClick:T,class:"btn-2"},"Save Draft")])]),I.value?(r(),d("div",rt,[e("div",{class:"absolute inset-0 bg-black/40",onClick:V}),e("div",it,[e("div",{class:"px-4 py-3 border-b flex items-center justify-between"},[t[18]||(t[18]=e("h3",{id:"addGroupTitle",class:"text-sm font-semibold"},"Add Group",-1)),e("button",{class:"text-slate-500 hover:text-slate-700",onClick:V},"✕")]),e("div",ut,[e("div",null,[t[19]||(t[19]=e("label",{class:"block text-xs font-medium text-slate-600 mb-1"},"Group Label",-1)),n(e("input",{"onUpdate:modelValue":t[4]||(t[4]=l=>b.value.label=l),type:"text",class:"w-full rounded-lg border px-3 py-2",placeholder:"e.g., Training (15)"},null,512),[[i,b.value.label]]),x.value.label?(r(),d("p",ct,v(x.value.label),1)):L("",!0)]),e("div",null,[t[20]||(t[20]=e("label",{class:"block text-xs font-medium text-slate-600 mb-1"},[G(" Group ID (slug) "),e("span",{class:"text-[11px] text-slate-500 ml-1"},"(letters/numbers/_ only)")],-1)),n(e("input",{"onUpdate:modelValue":t[5]||(t[5]=l=>b.value.id=l),onInput:P,type:"text",class:"w-full rounded-lg border px-3 py-2 font-mono",placeholder:"e.g., training"},null,544),[[i,b.value.id]]),x.value.id?(r(),d("p",pt,v(x.value.id),1)):L("",!0)])]),e("div",{class:"px-4 py-3 border-t flex items-center justify-end gap-2"},[e("button",{class:"px-3 py-1.5 rounded-lg border",onClick:V},"Cancel"),e("button",{class:"px-3 py-1.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700",onClick:z}," Add ")])])])):L("",!0)]))}};export{xt as default};
