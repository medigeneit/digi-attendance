import{B as Ne,r as E,x as O,C as Z,ad as Ce,l as H,H as ee,c as p,o as u,F as J,e as Q,a as e,t as c,q,b as D,s as V,_ as Se,G as ye,y as _e,d as se,k as R,w as ge,P as De,m as Ee,v as ae,T as $e,A as re,g as Ae,f as Ie,D as Re,h as Ue,a8 as Oe,n as f,a3 as fe,j as Pe,i as Te}from"./index-DaJLeBqA.js";const Me=Ne("clearance",()=>{const I=E(null),_=E(""),x=E([]),N=E([]),i=E([]),v=E(new Map),C=E(new Set),h=E(!1),U=E(!1),k=E(""),G=O(()=>{const m=(i.value??[]).slice().sort((d,y)=>(d.order_no??0)-(y.order_no??0)).map(d=>{var o,A;const y=v.value.get(d.id)||{},s=typeof d.show_receiver<"u"?!!d.show_receiver:d.handover_to!=="departmental_incharge",r=y.receiver_name??((o=d.handover_user)==null?void 0:o.name)??((A=d.handover_user)==null?void 0:A.label)??"";return{id:d.id,template_item_id:d.id,label:d.label||d.item_label||d.item_key,order_no:d.order_no??0,handover_to:d.handover_to??null,show_receiver:s,status:y.status??"PENDING",handover_status:y.handover_status??"NA",present_condition:y.present_condition??"",receiver_name:s?r:"",remarks:y.remarks??""}});return _.value?m.filter(d=>d.status===_.value):m});function l(m,d=!0){d?C.value.add(m):C.value.delete(m)}function g(){C.value.clear()}const w=async(m=null)=>{var d,y;h.value=!0,k.value=null;try{const s=await Z.get("/departments",{params:{company_id:m}});x.value=s.data}catch(s){k.value=((y=(d=s.response)==null?void 0:d.data)==null?void 0:y.message)||"ডিপার্টমেন্ট লোড করতে ব্যর্থ হয়েছে।",console.error("Error fetching departments:",s)}finally{h.value=!1}};async function n(m){var d;k.value="";try{const y=await Z.get("/without-permission-users",{params:{department_id:m,per_page:1e3}});N.value=((d=y.data)==null?void 0:d.data)||y.data||[]}catch(y){k.value="Failed to load users",console.error(y)}}async function b(){var m;i.value=[],k.value="";try{const d=await Z.get("/department-clearance-items"),y=((m=d.data)==null?void 0:m.data)||d.data||[];i.value=y}catch(d){k.value="Failed to load assigned items",console.error(d)}}async function $(m,d,y){var s;v.value=new Map,k.value="";try{const r=await Z.get("/clearances",{params:{user_id:m,department_id:d,template_id:y,per_page:1e3}}),o=((s=r.data)==null?void 0:s.data)||r.data||[];for(const A of o)v.value.set(A.template_item_id,A)}catch(r){k.value="Failed to load clearances",console.error(r)}}async function j(m,d){if(!(!m||!d)){h.value=!0,k.value="";try{await b(m,d),I.value&&await $(I.value,m,d)}catch(y){k.value="Failed to refresh data",console.error(y)}finally{h.value=!1}}}async function F(m,d){if(!I.value)return;const y=G.value.filter(s=>C.value.has(s.template_item_id)).map(s=>({template_item_id:s.template_item_id,status:s.status,handover_status:s.handover_status,present_condition:(typeof s.present_condition=="string"?s.present_condition.trim():"")||null,receiver_name:(typeof s.receiver_name=="string"?s.receiver_name.trim():"")||null,remarks:(typeof s.remarks=="string"?s.remarks.trim():"")||null}));if(y.length!==0){U.value=!0,k.value="";try{await Z.post("/clearances/bulk-upsert",{user_id:I.value,department_id:m,items:y}),g(),await $(I.value,m,d)}catch(s){k.value="Failed to save",console.error(s)}finally{U.value=!1}}}return{userId:I,departments:x,statusFilter:_,users:N,assignedItems:i,clearanceByItemId:v,itemsForTable:G,dirty:C,loading:h,saving:U,error:k,loadUsersByDept:n,fetchDepartments:w,loadAssignedItems:b,loadClearances:$,refreshAll:j,saveBulk:F,markDirty:l}}),Le=["value"],Ve={__name:"HandoverSelect",props:{modelValue:{type:String,default:"NA"},modelModifiers:{}},emits:["update:modelValue"],setup(I){const _=Ce(I,"modelValue"),x=[{v:"YES",t:"Yes"},{v:"NO",t:"No"},{v:"NA",t:"N/A"}];return(N,i)=>H((u(),p("select",{"onUpdate:modelValue":i[0]||(i[0]=v=>_.value=v),class:"input-1"},[(u(),p(J,null,Q(x,v=>e("option",{key:v.v,value:v.v},c(v.t),9,Le)),64))],512)),[[ee,_.value]])}},Ge=["aria-disabled"],Be=["aria-checked","onClick"],ze="inline-flex items-center gap-1 rounded-md border px-2.5 py-1.5 text-xs font-medium transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-500/40 select-none",Ke=Object.assign({name:"StatusSegment"},{__name:"StatusSegment",props:{modelValue:{type:String,default:""},disabled:{type:Boolean,default:!1}},emits:["update:modelValue","change"],setup(I,{emit:_}){const x=I,N=_,i=g=>(g??"").toString().trim().toUpperCase(),v=E(i(x.modelValue));q(()=>x.modelValue,g=>{const w=i(g);w!==v.value&&(v.value=w)});const C=[{value:"PENDING",label:"Pending"},{value:"WORKING",label:"Working"},{value:"COMPLETED",label:"Completed"}],h=g=>v.value===g;function U(g){if(x.disabled)return;const w=i(g);v.value=w,N("update:modelValue",w),N("change",w)}function k(g){if(x.disabled)return;const w=Math.max(0,C.findIndex(n=>n.value===v.value));["ArrowRight","ArrowDown"].includes(g.key)?(g.preventDefault(),U(C[(w+1)%C.length].value)):["ArrowLeft","ArrowUp"].includes(g.key)&&(g.preventDefault(),U(C[(w-1+C.length)%C.length].value))}function G(g){const n=h(g)?{PENDING:"bg-amber-600 text-white border-amber-600",WORKING:"bg-sky-600 text-white border-sky-600",COMPLETED:"bg-emerald-600 text-white border-emerald-600"}[g]||"bg-gray-800 text-white border-gray-800":"bg-white text-gray-700 border-gray-300 hover:bg-gray-50",b=x.disabled?"opacity-60 cursor-not-allowed":"cursor-pointer";return`${ze} ${n} ${b}`}const l=O(()=>`inline-flex items-center gap-1 bg-white rounded-lg p-1 border ${x.disabled?"opacity-75":""}`);return(g,w)=>(u(),p("div",{class:V(l.value),role:"radiogroup","aria-disabled":I.disabled?"true":"false",onKeydown:k},[(u(),p(J,null,Q(C,n=>e("button",{key:n.value,type:"button",class:V(G(n.value)),"aria-checked":h(n.value)?"true":"false",role:"radio",onClick:b=>U(n.value)},[e("span",{class:V(["h-1.5 w-1.5 rounded-full",{"bg-amber-200":n.value==="PENDING"&&!h(n.value),"bg-sky-200":n.value==="WORKING"&&!h(n.value),"bg-emerald-200":n.value==="COMPLETED"&&!h(n.value),"bg-white":h(n.value)}])},null,2),D(" "+c(n.label),1)],10,Be)),64))],42,Ge))}}),qe={class:"card overflow-hidden border rounded-xl bg-white shadow-sm"},je={class:"px-4 py-3 border-b bg-white/85 backdrop-blur flex items-center justify-between gap-3"},Fe={class:"text-sm text-gray-700"},We={class:"ml-1 font-semibold tabular-nums"},He=["disabled"],Ye={class:"w-full text-sm min-w-[1020px]"},Je=["onClick"],Qe={class:"px-3 py-2 align-top text-gray-500 tabular-nums"},Xe={class:"px-3 py-2 align-top"},Ze={class:"font-medium text-gray-900"},et={class:"text-[11px] text-gray-500"},tt={class:"px-3 py-2 align-top"},st={class:"font-medium"},at={class:"px-3 py-2 align-top"},rt={class:"whitespace-pre-wrap text-gray-900"},nt={class:"px-3 py-2 align-top"},lt={key:0,class:"whitespace-pre-wrap text-gray-900"},ot={key:1,class:"text-gray-400"},it={class:"px-3 py-2 align-top"},dt={class:"whitespace-pre-wrap text-gray-900"},ut={class:"px-3 py-2 align-top"},ct={class:"font-medium"},pt=["disabled","onClick"],mt={key:0},vt={class:"w-full max-w-2xl rounded-2xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow-2xl ring-1 ring-black/5"},bt={class:"px-5 py-4 space-y-4"},yt={key:0,class:"text-xs text-rose-600 mt-1"},gt=["maxlength"],ft={key:0,class:"text-xs text-rose-600 mt-1"},_t=["maxlength"],xt={key:0,class:"text-xs text-rose-600 mt-1"},ht=["maxlength"],kt={key:0,class:"text-xs text-rose-600 mt-1"},wt={key:0,class:"text-xs text-rose-600 mt-1"},Nt={__name:"ClearanceEditorTable",props:{rows:{type:Array,default:()=>[]},maxHeight:{type:String,default:"60vh"},disabled:{type:Boolean,default:!1}},emits:["update:row"],setup(I,{emit:_}){const x=I,N=_,i=E([]),v=s=>(s==null?void 0:s.template_item_id)??(s==null?void 0:s.id),C=(s=[])=>s.map(r=>({...r}));q(()=>x.rows,s=>{i.value=C(s??[])},{immediate:!0});const h={PENDING:{label:"Pending",dot:"bg-amber-500",pill:"bg-amber-50 text-amber-800 border-amber-200"},WORKING:{label:"Working",dot:"bg-sky-500",pill:"bg-sky-50 text-sky-800 border-sky-200"},COMPLETED:{label:"Completed",dot:"bg-emerald-500",pill:"bg-emerald-50 text-emerald-800 border-emerald-200"}},U={YES:{label:"Yes",pill:"bg-emerald-50 text-emerald-700 border-emerald-200"},NO:{label:"No",pill:"bg-rose-50 text-rose-700 border-rose-200"},NA:{label:"N/A",pill:"bg-slate-50 text-slate-700 border-slate-200"}},k=s=>s==="COMPLETED"?"border-l-4 border-emerald-400":s==="WORKING"?"border-l-4 border-sky-400":s==="PENDING"?"border-l-4 border-amber-400":"",G=s=>typeof(s==null?void 0:s.show_receiver)<"u"?!!s.show_receiver:(s==null?void 0:s.handover_to)!=="departmental_incharge",l={present_condition:200,receiver_name:120,remarks:255},g=E(!1),w=E(-1),n=ye({handover_status:"NA",present_condition:"",receiver_name:"",remarks:"",status:"PENDING",show_receiver:!0}),b=ye({});function $(s,r){x.disabled||(w.value=r,n.handover_status=s.handover_status??"NA",n.present_condition=s.present_condition??"",n.receiver_name=s.receiver_name??"",n.remarks=s.remarks??"",n.status=s.status??"PENDING",n.show_receiver=G(s),Object.keys(b).forEach(o=>delete b[o]),g.value=!0,re(()=>{}))}function j(){var s,r,o;return Object.keys(b).forEach(A=>delete b[A]),["YES","NO","NA"].includes(n.handover_status)||(b.handover_status="Select YES / NO / NA"),(((s=n.present_condition)==null?void 0:s.length)||0)>l.present_condition&&(b.present_condition=`Max ${l.present_condition} chars`),n.show_receiver&&(((r=n.receiver_name)==null?void 0:r.length)||0)>l.receiver_name&&(b.receiver_name=`Max ${l.receiver_name} chars`),(((o=n.remarks)==null?void 0:o.length)||0)>l.remarks&&(b.remarks=`Max ${l.remarks} chars`),["PENDING","WORKING","COMPLETED"].includes(n.status)||(b.status="Invalid status"),Object.keys(b).length===0}function F(){var B,M,P,T,z,Y;if(x.disabled||!j())return;const s=w.value;if(s<0)return;const r=i.value[s],o=Number(v(r)),A={handover_status:n.handover_status,present_condition:((M=(B=n.present_condition)==null?void 0:B.trim)==null?void 0:M.call(B))??n.present_condition,receiver_name:n.show_receiver?((T=(P=n.receiver_name)==null?void 0:P.trim)==null?void 0:T.call(P))??n.receiver_name:"",remarks:((Y=(z=n.remarks)==null?void 0:z.trim)==null?void 0:Y.call(z))??n.remarks,status:n.status};i.value[s]={...r,...A},N("update:row",o,{id:o,template_item_id:o,...A}),g.value=!1}function m(){g.value=!1}function d(s,r){x.disabled||$(s,r)}q(()=>x.disabled,s=>{s&&g.value&&m()});function y(s){g.value&&(s.key==="Escape"&&(s.stopPropagation(),s.preventDefault(),m()),(s.ctrlKey||s.metaKey)&&s.key.toLowerCase()==="enter"&&(s.preventDefault(),F()))}return typeof window<"u"&&window.addEventListener("keydown",y),_e(()=>window.removeEventListener("keydown",y)),(s,r)=>(u(),p("div",qe,[e("div",je,[e("div",Fe,[r[7]||(r[7]=e("span",{class:"font-medium"},"Assigned items:",-1)),e("span",We,c(i.value.length),1)]),e("button",{class:V(["rounded-md border px-3 py-1.5 text-sm hover:bg-gray-50 disabled:opacity-50",x.disabled?"cursor-not-allowed opacity-60":""]),disabled:x.disabled||!i.value.length,onClick:r[0]||(r[0]=o=>$(i.value[0],0)),title:"Add/Update clearance"}," ➕ Add/Update clearance ",10,He)]),e("div",{class:"overflow-auto",style:De({maxHeight:I.maxHeight})},[e("table",Ye,[r[9]||(r[9]=e("thead",{class:"bg-gray-50 sticky top-0 z-10 backdrop-blur border-b"},[e("tr",{class:"text-left text-gray-600"},[e("th",{class:"px-3 py-2 w-10"},"#"),e("th",{class:"px-3 py-2"},"Item"),e("th",{class:"px-3 py-2 w-40"},"Handover"),e("th",{class:"px-3 py-2 w-[18rem]"},"Present Condition"),e("th",{class:"px-3 py-2 w-[18rem]"},"Receiver"),e("th",{class:"px-3 py-2 w-[18rem]"},"Remarks"),e("th",{class:"px-3 py-2 w-40"},"Status"),e("th",{class:"px-3 py-2 w-16"})])],-1)),e("tbody",null,[(u(!0),p(J,null,Q(i.value,(o,A)=>{var B,M,P,T,z;return u(),p("tr",{key:v(o),class:V(["border-t hover:bg-gray-50 transition-colors",[k(o.status),x.disabled?"cursor-default":"cursor-pointer"]]),onClick:Y=>d(o,A)},[e("td",Qe,c(A+1),1),e("td",Xe,[e("div",Ze,c(o.label),1),e("div",et,"#"+c(v(o)),1)]),e("td",tt,[e("span",{class:V(["inline-flex items-center gap-1 rounded-full border px-2 py-0.5",((B=U[o.handover_status])==null?void 0:B.pill)||"bg-slate-50 text-slate-700 border-slate-200"])},[e("span",st,c(((M=U[o.handover_status])==null?void 0:M.label)||o.handover_status||"N/A"),1)],2)]),e("td",at,[e("div",rt,c(o.present_condition||"—"),1)]),e("td",nt,[G(o)?(u(),p("div",lt,c(o.receiver_name||"—"),1)):(u(),p("div",ot,"—"))]),e("td",it,[e("div",dt,c(o.remarks||"—"),1)]),e("td",ut,[e("span",{class:V(["inline-flex items-center gap-1 rounded-full border px-2 py-0.5",((P=h[o.status])==null?void 0:P.pill)||"bg-slate-50 text-slate-700 border-slate-200"])},[e("span",{class:V(["h-1.5 w-1.5 rounded-full",((T=h[o.status])==null?void 0:T.dot)||"bg-slate-400"])},null,2),e("span",ct,c(((z=h[o.status])==null?void 0:z.label)||o.status||"—"),1)],2)]),e("td",{class:"px-3 py-2 align-top",onClick:r[1]||(r[1]=ge(()=>{},["stop"]))},[e("button",{class:V(["inline-flex items-center gap-1 rounded-md border px-2.5 py-1.5 text-xs hover:bg-gray-50 disabled:opacity-50",x.disabled?"cursor-not-allowed opacity-60":""]),disabled:x.disabled,onClick:Y=>$(o,A),title:"Edit"},"✎ Edit",10,pt)])],10,Je)}),128)),i.value.length===0?(u(),p("tr",mt,r[8]||(r[8]=[e("td",{colspan:"8",class:"px-3 py-12"},[e("div",{class:"flex flex-col items-center justify-center text-center border border-dashed rounded-xl p-8 bg-slate-50"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-8 w-8 mb-2",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1.5",d:"M3 7h18M3 12h18M3 17h18M7 3v18"})]),e("div",{class:"text-sm text-gray-700 font-medium"},"No items to show"),e("p",{class:"text-xs text-gray-500 mt-1"},"Choose a department & template to load assigned clearance items.")])],-1)]))):R("",!0)])])],4),se($e,{"enter-active-class":"transition ease-out duration-150","enter-from-class":"opacity-0","enter-to-class":"opacity-100","leave-active-class":"transition ease-in duration-100","leave-from-class":"opacity-100","leave-to-class":"opacity-0"},{default:Ee(()=>[g.value?(u(),p("div",{key:0,class:"fixed inset-0 z-[60] flex items-start md:items-center justify-center bg-black/40 p-4",onClick:ge(m,["self"]),role:"dialog","aria-modal":"true"},[e("div",vt,[e("div",{class:"sticky top-0 flex items-center justify-between border-b px-5 py-3 bg-white/90 dark:bg-gray-900/90 backdrop-blur"},[r[10]||(r[10]=e("h3",{class:"text-base font-semibold"},"Add / Update Clearance",-1)),e("button",{class:"h-8 w-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800",onClick:m,title:"Close"},"✕")]),e("div",bt,[e("div",null,[r[11]||(r[11]=e("label",{class:"block text-sm font-medium mb-1"},"Handover",-1)),se(Ve,{"model-value":n.handover_status,"onUpdate:modelValue":r[2]||(r[2]=o=>n.handover_status=o)},null,8,["model-value"]),b.handover_status?(u(),p("p",yt,c(b.handover_status),1)):R("",!0)]),e("div",null,[r[12]||(r[12]=e("label",{class:"block text-sm font-medium mb-1"},"Present Condition",-1)),H(e("textarea",{class:"w-full resize-none bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 leading-6 focus:outline-none focus:ring-2 focus:ring-sky-500/20 focus:border-sky-500","onUpdate:modelValue":r[3]||(r[3]=o=>n.present_condition=o),maxlength:l.present_condition,rows:"3",placeholder:"e.g., OK / minor scratches / N/A"},null,8,gt),[[ae,n.present_condition]]),b.present_condition?(u(),p("p",ft,c(b.present_condition),1)):R("",!0)]),e("div",null,[r[13]||(r[13]=e("label",{class:"block text-sm font-medium mb-1"},"Receiver",-1)),H(e("textarea",{class:"w-full resize-none bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 leading-6 focus:outline-none focus:ring-2 focus:ring-sky-500/20 focus:border-sky-500","onUpdate:modelValue":r[4]||(r[4]=o=>n.receiver_name=o),maxlength:l.receiver_name,rows:"2",placeholder:"Receiver name(s), designation — one per line"},null,8,_t),[[ae,n.receiver_name]]),b.receiver_name?(u(),p("p",xt,c(b.receiver_name),1)):R("",!0)]),e("div",null,[r[14]||(r[14]=e("label",{class:"block text-sm font-medium mb-1"},"Remarks",-1)),H(e("textarea",{class:"w-full resize-none bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 leading-6 focus:outline-none focus:ring-2 focus:ring-sky-500/20 focus:border-sky-500","onUpdate:modelValue":r[5]||(r[5]=o=>n.remarks=o),maxlength:l.remarks,rows:"3",placeholder:"Remarks (optional)"},null,8,ht),[[ae,n.remarks]]),b.remarks?(u(),p("p",kt,c(b.remarks),1)):R("",!0)]),e("div",null,[r[15]||(r[15]=e("label",{class:"block text-sm font-medium mb-1"},"Status",-1)),se(Ke,{"model-value":n.status,"onUpdate:modelValue":r[6]||(r[6]=o=>n.status=o)},null,8,["model-value"]),b.status?(u(),p("p",wt,c(b.status),1)):R("",!0)])]),e("div",{class:"sticky bottom-0 flex items-center justify-end gap-2 border-t px-5 py-3 bg-white/90 dark:bg-gray-900/90 backdrop-blur"},[e("button",{class:"rounded-lg border px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-800",onClick:m},"Cancel"),e("button",{class:"inline-flex items-center gap-2 rounded-lg bg-gray-900 px-3 py-2 text-sm text-white hover:bg-gray-800",onClick:F,title:"Save (Ctrl+Enter)"}," Save ")])])])):R("",!0)]),_:1})]))}},Ct=Se(Nt,[["__scopeId","data-v-870fb15b"]]),St={class:"p-6 space-y-6"},Dt={class:"sticky top-0 z-10 bg-white/90 backdrop-blur border-b"},Et={class:"flex flex-wrap items-center justify-between gap-4 py-3"},$t={class:"p-2 space-y-1"},At={class:"flex items-center gap-2"},It={class:"flex flex-wrap items-center gap-2 text-xs text-slate-600"},Rt={class:"inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-1"},Ut={class:"text-slate-800"},Ot={class:"inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-1"},Pt={class:"text-slate-800"},Tt={key:0,class:"inline-flex items-center gap-1 rounded-full bg-amber-50 px-2 py-1 text-amber-700"},Mt={class:"flex items-center gap-2"},Lt={key:0,class:"hidden md:flex items-center gap-2 text-xs text-gray-600","aria-label":"Summary"},Vt={class:"inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-1"},Gt={class:"inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-1"},Bt={class:"inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-1"},zt=["disabled"],Kt=["disabled","aria-busy"],qt={key:0},jt={key:1},Ft=["disabled","title","aria-busy"],Wt={key:0},Ht={key:1},Yt={key:0,class:"rounded-md border border-amber-200 bg-amber-50 px-4 py-2 text-sm text-amber-800"},Jt={class:"card p-4 space-y-4"},Qt={class:"grid grid-cols-1 md:grid-cols-3 gap-3"},Xt={class:"space-y-1"},Zt=["value"],es={key:0,class:"text-[11px] text-slate-500"},ts={class:"space-y-1"},ss=["disabled"],as={value:null},rs=["value"],ns={key:0,class:"text-[11px] text-slate-500"},ls={class:"space-y-1"},os=["disabled"],is={key:0,class:"text-[11px] text-slate-500"},ds={key:0,class:"mt-2 text-sm text-rose-600"},us={key:1,class:"card p-6 text-slate-600"},cs={key:2,class:"card p-6 text-slate-600"},ps={key:3},ms={key:0,class:"card p-6"},vs={id:"print-area",class:"print-area"},bs={class:"text-center"},ys={class:"text-xl font-bold tracking-wide"},gs={class:"mt-4 grid grid-cols-2 gap-3 text-sm"},fs={class:"font-medium"},_s={class:"font-medium"},xs={class:"font-medium"},hs={class:"font-medium"},ks={class:"mt-4 rounded-md border border-gray-200 p-3 text-sm"},ws={class:"font-medium"},Ns={class:"mt-1"},Cs={class:"font-medium"},Ss={class:"mt-4"},Ds={class:"w-full border border-gray-300 text-sm",style:{"border-collapse":"collapse"}},Es={class:"border border-gray-300 px-2 py-1"},$s={class:"border border-gray-300 px-2 py-1"},As={class:"border border-gray-300 px-2 py-1"},Is={key:0},Rs={class:"mt-6 text-xs text-gray-500"},Os={__name:"UserClearance",setup(I){const _=Me(),x=Ae(),N=Ie(),i=E(null),v=E(2),C=E(!1),h=O(()=>{const a=N.query.userId??N.query.user_id??N.query.uid,t=Number(a);return Number.isNaN(t)?null:t}),U=O(()=>{const a=N.query.departmentId??N.query.department_id??N.query.deptId,t=Number(a);return Number.isNaN(t)?null:t}),k=O(()=>{const a=N.query.templateId??N.query.template_id,t=Number(a);return Number.isNaN(t)?null:t}),G=O(()=>String(N.query.print||"")==="1"),{userId:l,departments:g,statusFilter:w,users:n,itemsForTable:b,loading:$,saving:j,error:F,dirty:m}=Re(_),d=()=>m.value.size,y=()=>!!i.value&&!!v.value,s=O(()=>(g.value||[]).find(a=>a.id===i.value)||null),r=O(()=>(n.value||[]).find(a=>a.id===l.value)||null),o=a=>{var X;if(!a)return"";const t=a.name||"Unnamed",L=a.employee_code||a.employee_id||a.code||"",K=((X=a.designation)==null?void 0:X.name)||a.designation_name||"",W=[L,K].filter(Boolean).join(" • ");return W?`${t} (${W})`:t},A=a=>{if(!a)return"";if(typeof a=="string")return a.slice(0,10);const t=new Date(a);return Number.isNaN(t.getTime())?"":t.toISOString().slice(0,10)},B=()=>{const a=new Date;return new Date(a.getTime()-a.getTimezoneOffset()*6e4).toISOString().slice(0,10)},M=O(()=>i.value?l.value?"work":"user":"dept"),P=O(()=>{var a;return A((a=r.value)==null?void 0:a.last_working_date)}),T=O(()=>P.value?P.value<=B():!1),z=async()=>m.value.size>0&&typeof window<"u"?window.confirm("You have unsaved changes. Changing Department will discard them. Continue?"):!0;q(()=>{var a;return(a=x.user)==null?void 0:a.department_id},async a=>{if(a&&!U.value){i.value=a,n.value=[],l.value=null;try{await _.loadUsersByDept(a),y()&&await _.refreshAll(a,v.value)}catch(t){console.error("bootstrap error",t)}}},{immediate:!0}),q(()=>N.query,()=>{U.value&&(i.value=U.value),k.value&&(v.value=k.value),h.value&&(l.value=h.value),G.value&&(C.value=!0)},{immediate:!0}),q(i,async(a,t)=>{if(a===t)return;if(!await z()){i.value=t??null;return}if(n.value=[],l.value=null,a)try{await _.loadUsersByDept(a),h.value&&(l.value=h.value),v.value&&await _.refreshAll(a,v.value)}catch(K){console.error("dept change error",K)}}),q(v,async a=>{if(i.value&&a)try{await _.refreshAll(i.value,a),l.value&&await _.loadClearances(l.value,i.value,v.value)}catch(t){console.error("template change error",t)}}),q(l,async()=>{if(y()&&l.value)try{await _.loadClearances(l.value,i.value,v.value)}catch(a){console.error("user change error",a)}});function Y(a,t){if(T.value)return;const L=b.value,K=L.findIndex(W=>W.template_item_id===a);K>=0&&(Object.assign(L[K],t),_.markDirty(a,!0))}async function xe(){try{if(!l.value||T.value)return;await _.saveBulk(i.value,v.value)}catch(a){console.error(a)}}async function he(){if(y())try{await _.refreshAll(i.value,v.value),l.value&&await _.loadClearances(l.value,i.value,v.value)}catch(a){console.error("refresh error",a)}}async function ne(){l.value&&(document.body.classList.add("printing-clearance-summary"),await re(),window.print(),setTimeout(()=>document.body.classList.remove("printing-clearance-summary"),0))}const te=O(()=>{if(!l.value)return{pending:0,working:0,completed:0};const a=b.value||[];return{pending:a.filter(t=>t.status==="PENDING").length,working:a.filter(t=>t.status==="WORKING").length,completed:a.filter(t=>t.status==="COMPLETED").length}}),ke=O(()=>{var a,t;return((t=(a=r.value)==null?void 0:a.company)==null?void 0:t.name)||"Digi Attendance"}),le=O(()=>(b.value||[]).map(t=>({label:t.label||t.item_label||t.item_key||`#${t.template_item_id??t.id??""}`,status:t.status||"N/A",remarks:t.remarks||t.present_condition||""})));function oe(a){m.value.size>0&&(a.preventDefault(),a.returnValue="")}return Ue(async()=>{typeof window<"u"&&window.addEventListener("beforeunload",oe);try{await _.fetchDepartments()}catch(a){console.error("fetchDepartments error",a)}}),q([$,b,l],async()=>{C.value&&(!l.value||$.value||(C.value=!1,await re(),ne()))}),_e(()=>{typeof window<"u"&&window.removeEventListener("beforeunload",oe)}),Oe((a,t,L)=>{if(m.value.size>0&&typeof window<"u"&&!window.confirm("You have unsaved changes. Leave anyway?"))return L(!1);L()}),(a,t)=>{var L,K,W,X,ie,de,ue,ce,pe,me,ve,be;return u(),p("div",St,[e("div",Dt,[e("div",Et,[e("div",$t,[e("div",At,[t[3]||(t[3]=e("h1",{class:"text-2xl font-semibold tracking-tight"},"User Clearance",-1)),e("span",{class:V(["inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold",{"bg-slate-100 text-slate-700":M.value==="dept","bg-blue-50 text-blue-700":M.value==="user","bg-emerald-50 text-emerald-700":M.value==="work"}])},c(M.value==="dept"?"Step 1: Department":M.value==="user"?"Step 2: User":"Step 3: Update"),3)]),t[7]||(t[7]=e("p",{class:"text-sm text-gray-600"}," Assign করা আইটেম অনুযায়ী ইউজারের ক্লিয়ারেন্স আপডেট করুন ",-1)),e("div",It,[e("span",Rt,[t[4]||(t[4]=D(" Dept: ")),e("b",Ut,c(((L=s.value)==null?void 0:L.name)||"—"),1)]),e("span",Ot,[t[5]||(t[5]=D(" User: ")),e("b",Pt,c(((K=r.value)==null?void 0:K.name)||"—"),1)]),f(m).size?(u(),p("span",Tt,[t[6]||(t[6]=D(" Unsaved: ")),e("b",null,c(d()),1)])):R("",!0)])]),e("div",Mt,[f(l)?(u(),p("div",Lt,[e("span",Vt,[t[8]||(t[8]=D(" Pending: ")),e("b",null,c(te.value.pending),1)]),e("span",Gt,[t[9]||(t[9]=D(" Working: ")),e("b",null,c(te.value.working),1)]),e("span",Bt,[t[10]||(t[10]=D(" Completed: ")),e("b",null,c(te.value.completed),1)])])):R("",!0),e("button",{class:"btn-3",onClick:ne,disabled:!f(l),title:"Print clearance summary"}," Print ",8,zt),e("button",{class:"btn-2",onClick:he,disabled:f($)||!i.value||!v.value,title:"Reload template bindings and current user's items","aria-busy":f($)?"true":"false"},[f($)?(u(),p("span",qt,"Refreshing…")):(u(),p("span",jt,"Refresh"))],8,Kt),e("button",{class:"btn-1",onClick:xe,disabled:f(j)||f(m).size===0||!f(l)||T.value,title:T.value?"This user is exited. Clearance is read-only.":f(l)?"":"Select a user first","aria-busy":f(j)?"true":"false"},[f(j)?(u(),p("span",Wt,"Saving…")):(u(),p("span",Ht,"Save Changes ("+c(d())+")",1))],8,Ft)])])]),T.value?(u(),p("div",Yt," Read-only: user has an exit date (Last working date: "+c(P.value||"N/A")+"). ",1)):R("",!0),e("div",Jt,[e("div",Qt,[e("div",Xt,[t[12]||(t[12]=e("label",{class:"text-sm font-medium text-slate-700"},"Department",-1)),H(e("select",{"onUpdate:modelValue":t[0]||(t[0]=S=>i.value=S),class:"input-1"},[t[11]||(t[11]=e("option",{value:null},"Select Department",-1)),(u(!0),p(J,null,Q(f(g),S=>(u(),p("option",{key:S.id,value:S.id},c(S.name),9,Zt))),128))],512),[[ee,i.value]]),i.value?R("",!0):(u(),p("p",es," Step 1: প্রথমে Department সিলেক্ট করুন "))]),e("div",ts,[t[13]||(t[13]=e("label",{class:"text-sm font-medium text-slate-700"},"User",-1)),H(e("select",{"onUpdate:modelValue":t[1]||(t[1]=S=>fe(l)?l.value=S:null),class:"input-1",disabled:!i.value||f($)},[e("option",as,c(i.value?f($)?"Loading users…":"Select User":"Select Department first"),1),(u(!0),p(J,null,Q(f(n),S=>(u(),p("option",{key:S.id,value:S.id},c(o(S)),9,rs))),128))],8,ss),[[ee,f(l)]]),i.value&&!f(l)?(u(),p("p",ns," Step 2: এখন একটি User সিলেক্ট করুন ")):R("",!0)]),e("div",ls,[t[15]||(t[15]=e("label",{class:"text-sm font-medium text-slate-700"},"Status Filter",-1)),H(e("select",{"onUpdate:modelValue":t[2]||(t[2]=S=>fe(w)?w.value=S:null),class:"input-1",disabled:!f(l)},t[14]||(t[14]=[e("option",{value:""},"All",-1),e("option",{value:"PENDING"},"Pending",-1),e("option",{value:"WORKING"},"Working",-1),e("option",{value:"COMPLETED"},"Completed",-1)]),8,os),[[ee,f(w)]]),f(l)?R("",!0):(u(),p("p",is," User সিলেক্ট করলে filter কাজ করবে "))])]),f(F)?(u(),p("div",ds,c(f(F)),1)):R("",!0)]),i.value?f(l)?(u(),p("div",ps,[f($)?(u(),p("div",ms,t[18]||(t[18]=[Te('<div class="animate-pulse space-y-3"><div class="h-4 bg-gray-200 rounded w-1/3"></div><div class="h-4 bg-gray-200 rounded w-2/3"></div><div class="h-4 bg-gray-200 rounded"></div><div class="h-4 bg-gray-200 rounded"></div></div>',1)]))):(u(),Pe(Ct,{rows:f(b),key:f(l),disabled:T.value,"onUpdate:row":Y},null,8,["rows","disabled"]))])):(u(),p("div",cs,t[17]||(t[17]=[e("b",null,"Step 2:",-1),D(" Select a "),e("b",null,"User",-1),D(" to load clearance items. ")]))):(u(),p("div",us,t[16]||(t[16]=[e("b",null,"Step 1:",-1),D(" Select a "),e("b",null,"Department",-1),D(" to load users. ")]))),e("div",vs,[e("div",bs,[e("h1",ys,c(ke.value),1),t[19]||(t[19]=e("p",{class:"text-xs text-gray-500"},"User Exit & Clearance Summary",-1))]),e("div",gs,[e("div",null,[t[20]||(t[20]=e("span",{class:"text-gray-500"},"Name:",-1)),t[21]||(t[21]=D()),e("span",fs,c(((W=r.value)==null?void 0:W.name)||"N/A"),1)]),e("div",null,[t[22]||(t[22]=e("span",{class:"text-gray-500"},"Employee ID:",-1)),t[23]||(t[23]=D()),e("span",_s,c(((X=r.value)==null?void 0:X.employee_id)||"N/A"),1)]),e("div",null,[t[24]||(t[24]=e("span",{class:"text-gray-500"},"Department:",-1)),t[25]||(t[25]=D()),e("span",xs,c(((de=(ie=r.value)==null?void 0:ie.department)==null?void 0:de.name)||((ue=s.value)==null?void 0:ue.name)||"N/A"),1)]),e("div",null,[t[26]||(t[26]=e("span",{class:"text-gray-500"},"Designation:",-1)),t[27]||(t[27]=D()),e("span",hs,c(((pe=(ce=r.value)==null?void 0:ce.designation)==null?void 0:pe.title)||((ve=(me=r.value)==null?void 0:me.designation)==null?void 0:ve.name)||"N/A"),1)])]),e("div",ks,[e("div",null,[t[28]||(t[28]=e("span",{class:"text-gray-500"},"Last Working Date:",-1)),t[29]||(t[29]=D()),e("span",ws,c(P.value||"N/A"),1)]),e("div",Ns,[t[30]||(t[30]=e("span",{class:"text-gray-500"},"Exit Reason:",-1)),t[31]||(t[31]=D()),e("span",Cs,c(((be=r.value)==null?void 0:be.exit_reason)||"N/A"),1)])]),e("div",Ss,[t[34]||(t[34]=e("div",{class:"mb-2 text-sm font-semibold text-gray-700"},"Clearance Items Summary",-1)),e("table",Ds,[t[33]||(t[33]=e("thead",null,[e("tr",{class:"bg-gray-100 text-gray-700"},[e("th",{class:"border border-gray-300 px-2 py-1 text-left"},"Item"),e("th",{class:"border border-gray-300 px-2 py-1 text-left w-[120px]"},"Status"),e("th",{class:"border border-gray-300 px-2 py-1 text-left"},"Remarks")])],-1)),e("tbody",null,[(u(!0),p(J,null,Q(le.value,(S,we)=>(u(),p("tr",{key:we},[e("td",Es,c(S.label||"N/A"),1),e("td",$s,c(S.status||"N/A"),1),e("td",As,c(S.remarks||"—"),1)]))),128)),le.value.length?R("",!0):(u(),p("tr",Is,t[32]||(t[32]=[e("td",{colspan:"3",class:"border border-gray-300 px-2 py-4 text-center text-gray-500"}," No clearance items found. ",-1)])))])])]),e("div",Rs," Printed: "+c(new Date().toLocaleString()),1)])])}}};export{Os as default};
