import{J as W,I as $,r as p,d as z,e as J,z as Y,n as G,c as a,o as r,a as t,f as H,g as m,h as T,v as M,p as U,k as g,t as f,F as k,j as E,B as L,q as S,w as R}from"./index-BIgT6kYM.js";import{a as j}from"./datetime-q3Sn87-f.js";import{u as K}from"./company-DhXWgbCS.js";import{u as P}from"./useTaskStore-BAf_d2fG.js";import{S as Q}from"./SectionLoading-CRnlSFc1.js";import{_ as X}from"./MultiselectDropdown-DB5LE-QH.js";async function Z(c){return W.get("/tags",{params:{tag_type:c}})}const D=$("tags",()=>{const c=p([]);return{tags:c,fetchTags:async h=>{var _,n;c.value=((n=(_=await Z(h))==null?void 0:_.data)==null?void 0:n.tags)||[]}}}),ee={class:"px-4 max-h-[90vh] overflow-auto"},te={class:"sticky top-0 pt-4 -mx-4 px-4 border-b bg-white rounded-t-md"},se={key:0,class:"text-center py-4 text-gray-500"},oe={class:"mb-4"},re={class:"mb-4"},ae={key:0,class:"mb-4"},le={class:"mb-4"},ne={class:"block text-gray-600 text-sm mb-1 font-medium"},ie=["label"],de=["value"],ue={class:"mb-4"},me={class:"block text-gray-600 text-sm mb-1 font-medium"},pe=["label"],ce=["value"],ve={class:"mb-4"},be={class:"sticky bottom-0 bg-white py-4 border-t"},ge={key:0,class:"mb-4 text-red-500 font-medium"},fe={key:1,class:"mb-4"},_e={class:"flex items-center gap-4 justify-between"},ye=["disabled"],xe={key:0,class:"text-red-500 text-sm"},qe={__name:"TaskEditForm",props:{taskId:{type:[String,Number],required:!0}},emits:["updated","cancel"],setup(c,{emit:B}){const h=c,_=B,n=P(),w=p([]),C=D(),A=z(),V=K(),i=p(),d=p(!1),q=p([]),F=p(""),l=p({});J(async()=>{var s,e;d.value=!0,C.fetchTags("website"),i.value=(s=await n.fetchTask(h.taskId,{},{fetchOnly:!0,loadingBeforeFetch:!1}))==null?void 0:s.task,await V.fetchCompanies({with:"departments",ignore_permission:!0}),N(i.value),w.value=((e=i.value)==null?void 0:e.website_tags)||[],q.value=i.value.users,d.value=!1}),Y(()=>i.value,s=>{N(s),q.value=s.users});function N(s){var e;l.value={title:s.title,description:s.description,requirement_id:s.requirement_id,from_department_id:s.from_department_id,to_department_id:s.to_department_id,...((e=A.user)==null?void 0:e.role)!=="employee"?{is_important:s.is_important,is_urgent:s.is_urgent,is_target:s.is_target,started_at:j(s.started_at),deadline:j(s.deadline)}:{}}}const O=async()=>{var s,e,y,x;d.value=!0;try{const v={...l.value,user_ids:((s=q.value)==null?void 0:s.map(b=>Number(b.id)))||[],website_tags:((e=w.value)==null?void 0:e.map(b=>Number(b.id)))||[]};await n.updateTask(h.taskId,v,{loadingBeforeFetch:!1}),_("updated")}catch(v){F.value=((x=(y=v.response)==null?void 0:y.data)==null?void 0:x.message)||"An error occurred while updating the task."}finally{d.value=!1}};return(s,e)=>{var x,v,b,I;const y=G("RequiredIcon");return r(),a("div",ee,[t("div",te,[e[6]||(e[6]=t("h2",{class:"text-2xl font-semibold text-gray-800 mb-4"},"Edit Task",-1)),d.value?(r(),a("div",se,"Loading form...")):m("",!0)]),t("form",{onSubmit:R(O,["prevent"]),class:"my-4"},[t("div",oe,[e[7]||(e[7]=t("label",{class:"block text-gray-700 font-medium mb-2"},"Task Title",-1)),T(t("input",{"onUpdate:modelValue":e[0]||(e[0]=o=>l.value.title=o),required:"",placeholder:"Enter task title",class:"w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"},null,512),[[M,l.value.title]])]),t("div",re,[e[8]||(e[8]=t("label",{class:"text-gray-800"},"Websites",-1)),U(X,{options:g(C).tags,multiple:!0,modelValue:w.value,"onUpdate:modelValue":e[1]||(e[1]=o=>w.value=o),label:"name","track-by":"id"},null,8,["options","modelValue"])]),(x=i.value)!=null&&x.requirement?(r(),a("div",ae,[e[9]||(e[9]=t("label",{class:"block text-gray-700 font-medium mb-2"},"Requirement",-1)),t("div",null,[t("p",null,f((b=(v=i.value)==null?void 0:v.requirement)==null?void 0:b.title),1)])])):m("",!0),((I=i.value)==null?void 0:I.parent_id)===0?(r(),a(k,{key:1},[t("div",le,[t("label",ne,[e[10]||(e[10]=E(" From Department ")),U(y)]),T(t("select",{"onUpdate:modelValue":e[2]||(e[2]=o=>l.value.from_department_id=o),class:"w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"},[e[11]||(e[11]=t("option",{value:""},"--select department--",-1)),(r(!0),a(k,null,S(g(V).companies,o=>(r(),a("optgroup",{key:o.id,label:o.name},[(r(!0),a(k,null,S(o.departments,u=>(r(),a("option",{value:u.id,key:u.id},f(u.name),9,de))),128))],8,ie))),128))],512),[[L,l.value.from_department_id]])]),t("div",ue,[t("label",me,[e[12]||(e[12]=E(" To Department ")),U(y)]),T(t("select",{"onUpdate:modelValue":e[3]||(e[3]=o=>l.value.to_department_id=o),class:"w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"},[e[13]||(e[13]=t("option",{value:""},"--select department--",-1)),(r(!0),a(k,null,S(g(V).companies,o=>(r(),a("optgroup",{key:o.id,label:o.name},[(r(!0),a(k,null,S(o.departments,u=>(r(),a("option",{value:u.id,key:u.id},f(u.name),9,ce))),128))],8,pe))),128))],512),[[L,l.value.to_department_id]])])],64)):m("",!0),t("div",ve,[e[14]||(e[14]=t("label",{class:"block text-gray-700 font-medium mb-2"},"Description",-1)),T(t("textarea",{"onUpdate:modelValue":e[4]||(e[4]=o=>l.value.description=o),rows:"4",placeholder:"Enter task description",class:"w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"},null,512),[[M,l.value.description]])]),t("div",be,[g(n).error?(r(),a("div",ge,f(g(n).error),1)):m("",!0),g(n).error?(r(),a("hr",fe)):m("",!0),t("div",_e,[t("button",{type:"button",onClick:e[5]||(e[5]=R(o=>_("close"),["prevent"])),class:"bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold px-5 py-2 rounded transition"}," Cancel "),t("button",{disabled:d.value,type:"submit",class:"bg-green-500 hover:bg-green-600 text-white font-semibold px-5 py-2 rounded transition"},f(d.value?"Updating...":"Update Task"),9,ye),F.value?(r(),a("div",xe,f(F.value),1)):m("",!0)])])],32),d.value?(r(),H(Q,{key:0})):m("",!0)])}}};export{qe as _};
