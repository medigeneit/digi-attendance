import{Q as ie,u as oe,f as de,D as re,r as q,x as g,q as z,h as ue,A as ce,c as v,o as y,a as t,t as d,d as A,k as Y,v as pe,z as me,H as ve,m as R,j as P,F as ye,e as _e,b as $,O as fe,s as xe}from"./index-DRtBnJiT.js";import{L as G}from"./LoaderView-B3neck5P.js";import{_ as ge}from"./EmployeeFilter-CXx2_yXK.js";import{u as be}from"./kpi-DPde-RiP.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./company-B-_j7p7a.js";import"./department-BKtPCYjc.js";import"./EmployeeDropdownInput-BmNISl8G.js";import"./SelectDropdown-D-rxad_W.js";import"./UserChip-CcE1_BKH.js";const he={class:"space-y-4 px-4 max-w-7xl mx-auto my-6"},ke={class:"sticky top-0 z-10 -mx-4 px-4 bg-white/80 backdrop-blur border-b"},qe={class:"flex flex-col gap-3 py-3 md:flex-row md:items-center md:justify-between"},Se={class:"flex items-center gap-2"},Ne={class:"hidden md:flex items-center gap-2 text-xs"},Ce={class:"px-2 py-1 rounded-full bg-slate-100 text-slate-700"},Ue={class:"px-2 py-1 rounded-full bg-emerald-100 text-emerald-700"},ze={class:"px-2 py-1 rounded-full bg-amber-100 text-amber-700"},Re={class:"px-2 py-1 rounded-full bg-slate-100 text-slate-700"},Pe=["disabled"],$e={class:"rounded-xl border bg-white p-4 md:p-5 shadow-sm"},Te={class:"grid gap-4 md:grid-cols-12"},je={class:"col-span-full"},Ae={class:"md:col-span-4"},Be=["placeholder","disabled"],De={class:"md:col-span-3"},Le={class:"md:col-span-1"},Ve={class:"md:col-span-2 flex items-end justify-end gap-2"},Ee=["disabled"],Fe={key:0,class:"py-8 text-center"},Oe={key:1,class:"rounded-md border border-red-200 bg-red-50 p-3 text-red-700"},Ke={key:2,class:"relative overflow-x-auto rounded-xl border bg-white shadow-sm"},Ie={key:0,class:"absolute inset-0 grid place-items-center bg-white/50 backdrop-blur-[1px] z-10","aria-live":"polite","aria-busy":"true"},Me={class:"min-w-full text-sm"},He={class:"px-3 py-2"},Je={class:"px-3 py-2"},Qe={class:"flex items-center gap-3"},Ye={class:"h-8 w-8 rounded-full bg-slate-200 grid place-items-center text-xs font-medium text-slate-700"},Ge={class:"font-medium text-slate-900"},We={class:"text-[11px] text-slate-500"},Xe={key:0,class:"mx-1"},Ze={key:1},we={class:"px-3 py-2"},et={class:"text-xs text-slate-700"},tt={class:"px-3 py-2"},st={class:"flex items-center gap-3"},at={class:"w-full max-w-[260px]"},lt={class:"h-2 rounded-full bg-slate-200 overflow-hidden"},nt={class:"mt-1 text-[11px] text-slate-600"},it={class:"px-3 py-2"},ot={class:"px-3 py-2 text-right"},dt={class:"flex items-center justify-end gap-2"},rt=["onClick"],ut={key:0},ct={colspan:"6",class:"px-3 py-6 text-center text-gray-600"},qt={__name:"YearlyEvaluationList",setup(pt){const B=ie(),D=oe(),u=de(),L=be(),{users:S,loading:W,error:V,usersError:E}=re(L),l=q({company_id:u.query.company_id?Number(u.query.company_id):"",department_id:u.query.department_id?Number(u.query.department_id):"",employee_id:u.query.employee_id?Number(u.query.employee_id):"",line_type:u.query.line_type??"",user_id:u.query.user_id?Number(u.query.user_id):"",finalized:u.query.finalized??"",q:u.query.q??""}),c=q(u.query.sortBy||"name"),_=q(u.query.sortDir||"asc");let F=null,T=0,O="";const j=q(!1),K=q([]),p=g(()=>!!l.value.company_id&&!!l.value.department_id),X=g(()=>p.value||l.value.finalized!==""||!!l.value.line_type||!!l.value.q),Z=g(()=>W.value),b=g(()=>p.value?Array.isArray(S.value)?S.value:[]:K.value);function m(a){var x;const e=(x=a==null?void 0:a.kpi)==null?void 0:x.progress,s=Number((e==null?void 0:e.total_lanes)??0),n=Number((e==null?void 0:e.submitted_lanes)??0),i=Number((e==null?void 0:e.pending_lanes)??Math.max(0,s-n)),r=String((e==null?void 0:e.stage)??(s?"not_started":"n/a")),o=s>0?Math.round(n/s*100):0;return{total:s,submitted:n,pending:i,stage:r,percent:o}}function I(a){return a==="completed"?0:a==="in_progress"?1:a==="not_started"?2:3}function M(a){const{stage:e,submitted:s,total:n}=m(a);return e==="completed"?{label:`Completed (${s}/${n})`,cls:"bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200"}:e==="in_progress"?{label:`In progress (${s}/${n})`,cls:"bg-amber-100 text-amber-700 ring-1 ring-amber-200"}:e==="not_started"?{label:"Not started",cls:"bg-slate-100 text-slate-700 ring-1 ring-slate-200"}:{label:"N/A",cls:"bg-slate-100 text-slate-700 ring-1 ring-slate-200"}}function H(a){var i;const e=(i=a==null?void 0:a.kpi)==null?void 0:i.cycle;if(!(e!=null&&e.id))return"—";const s=e!=null&&e.year?String(e.year):"",n=e!=null&&e.slug?String(e.slug):"";return[s,n].filter(Boolean).join(" • ")||`#${e.id}`}const N=g(()=>{let a=b.value.length,e=0,s=0,n=0,i=0;for(const r of b.value){const o=m(r).stage;o==="completed"?e++:o==="in_progress"?s++:o==="not_started"?n++:i++}return{total:a,completed:e,inProgress:s,notStarted:n,na:i}}),h=g(()=>{const a=[...b.value],e=_.value==="desc"?-1:1,s=c.value,n=i=>{const{total:r,submitted:o}=m(i);return r<=0?-1/0:o/r};return a.sort((i,r)=>{if(s==="progress"){const C=n(i),U=n(r);return(C>U?1:C<U?-1:0)*e}if(s==="stage")return(I(m(i).stage)-I(m(r).stage))*e;const o=String((i==null?void 0:i.name)??""),x=String((r==null?void 0:r.name)??"");return o.localeCompare(x)*e}),a});function f(){D.replace({query:{company_id:l.value.company_id||void 0,department_id:l.value.department_id||void 0,line_type:l.value.line_type||void 0,user_id:l.value.user_id||void 0,employee_id:l.value.employee_id||void 0,finalized:l.value.finalized||void 0,q:l.value.q||void 0,sortBy:c.value!=="name"?c.value:void 0,sortDir:_.value!=="asc"?_.value:void 0}}).catch(()=>{})}function w(){clearTimeout(F),F=setTimeout(()=>{p.value&&f()},350)}z(()=>u.fullPath,async()=>{const a=u.query;l.value.company_id=a.company_id?Number(a.company_id):"",l.value.department_id=a.department_id?Number(a.department_id):"",l.value.employee_id=a.employee_id?Number(a.employee_id):"",l.value.user_id=a.user_id?Number(a.user_id):"",l.value.line_type=a.line_type??"",l.value.finalized=a.finalized??"",l.value.q=a.q??"",c.value=a.sortBy||"name",_.value=a.sortDir||"asc",p.value&&await J()});function ee(){return{company_id:l.value.company_id,department_id:l.value.department_id||void 0,employee_id:l.value.employee_id||void 0,user_id:l.value.user_id||void 0,line_type:l.value.line_type||void 0,finalized:l.value.finalized,q:l.value.q||void 0}}async function J(){const a=ee(),e=JSON.stringify(a);if(e===O)return;O=e;const s=++T;j.value=b.value.length>0;try{const n=await L.fetchUsers(a);if(s!==T)return;const i=Array.isArray(n)?n:Array.isArray(S.value)?S.value:[];K.value=[...i]}catch(n){console.error(n),B.error("Failed to load users.")}finally{s===T&&(j.value=!1)}}function te(){l.value.user_id=l.value.employee_id||"",f()}function se(){if(!p.value)return B.error("Select Company & Department");f()}function ae(){l.value={company_id:"",department_id:"",employee_id:"",line_type:"",user_id:"",finalized:"",q:""},c.value="name",_.value="asc",f()}function Q(a){c.value===a?_.value=_.value==="asc"?"desc":"asc":(c.value=a,_.value="asc"),f()}function le(a){const e=a==null?void 0:a.id;e&&D.push({name:"KpiReview",params:{employeeId:e}})}function ne(){if(!h.value.length)return;const a=["#","User","Cycle","Submitted","Total","Pending","Stage","Progress%"],e=h.value.map((o,x)=>{const C=(o==null?void 0:o.name)??`#${o==null?void 0:o.id}`,U=H(o),k=m(o);return[x+1,`"${C.replace(/"/g,'""')}"`,`"${String(U).replace(/"/g,'""')}"`,k.submitted,k.total,k.pending,k.stage,k.percent].join(",")}),s=[a.join(","),...e].join(`
`),n=new Blob([s],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(n),r=document.createElement("a");r.href=i,r.download="kpi-progress.csv",r.click(),URL.revokeObjectURL(i)}return z(()=>l.value.employee_id,a=>{l.value.user_id=a||""}),z(()=>l.value.q,()=>{p.value&&w()}),z(()=>[l.value.finalized,l.value.line_type],()=>{p.value&&f()}),ue(async()=>{await ce(),p.value&&await J()}),(a,e)=>(y(),v("div",he,[t("div",ke,[t("div",qe,[e[8]||(e[8]=t("div",null,[t("h1",{class:"text-lg md:text-xl font-semibold"},"User KPI Progress"),t("p",{class:"text-xs text-slate-600 mt-0.5"},"Select company/department to see progress stage per user.")],-1)),t("div",Se,[t("div",Ne,[t("span",Ce,"Total: "+d(N.value.total),1),t("span",Ue,"Completed: "+d(N.value.completed),1),t("span",ze,"In progress: "+d(N.value.inProgress),1),t("span",Re,"Not started: "+d(N.value.notStarted),1)]),t("button",{class:"h-9 rounded-md border border-slate-300 px-3 text-xs md:text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-50",disabled:!h.value.length,onClick:ne}," Export CSV ",8,Pe)])])]),t("div",$e,[t("div",Te,[t("div",je,[e[9]||(e[9]=t("label",{class:"mb-1 block text-sm font-medium text-slate-700"},"Employee scope",-1)),A(ge,{company_id:l.value.company_id,"onUpdate:company_id":e[0]||(e[0]=s=>l.value.company_id=s),department_id:l.value.department_id,"onUpdate:department_id":e[1]||(e[1]=s=>l.value.department_id=s),employee_id:l.value.employee_id,"onUpdate:employee_id":e[2]||(e[2]=s=>l.value.employee_id=s),line_type:l.value.line_type,"onUpdate:line_type":e[3]||(e[3]=s=>l.value.line_type=s),"with-type":!0,"initial-value":{...a.$route.query},onFilterChange:te,class:"w-full"},null,8,["company_id","department_id","employee_id","line_type","initial-value"]),e[10]||(e[10]=t("p",{class:"mt-1 text-[11px] text-slate-500"},"Reset করলে আগের data দেখাবে যতক্ষণ না নতুন scope select করো।",-1))]),t("div",Ae,[e[11]||(e[11]=t("label",{class:"mb-1 block text-sm font-medium text-slate-700"},"Search",-1)),Y(t("input",{"onUpdate:modelValue":e[4]||(e[4]=s=>l.value.q=s),onKeyup:me(se,["enter"]),placeholder:p.value?"Search name, type…":"Select company & department first",class:"h-9 w-full rounded-md border border-slate-300 px-3 text-sm disabled:bg-slate-100",disabled:!p.value},null,40,Be),[[pe,l.value.q,void 0,{trim:!0}]])]),t("div",De,[e[13]||(e[13]=t("label",{class:"mb-1 block text-sm font-medium text-slate-700"},"Sort by",-1)),Y(t("select",{class:"h-9 w-full rounded-md border border-slate-300 px-2 text-sm","onUpdate:modelValue":e[5]||(e[5]=s=>c.value=s),onChange:e[6]||(e[6]=s=>Q(c.value))},e[12]||(e[12]=[t("option",{value:"name"},"Name",-1),t("option",{value:"progress"},"Progress",-1),t("option",{value:"stage"},"Stage",-1)]),544),[[ve,c.value]])]),t("div",Le,[e[14]||(e[14]=t("label",{class:"mb-1 block text-sm font-medium text-slate-700"},"Order",-1)),t("button",{class:"h-9 w-full rounded-md border border-slate-300 text-sm hover:bg-slate-50",onClick:e[7]||(e[7]=s=>Q(c.value))},d(_.value==="asc"?"Asc":"Desc"),1)]),t("div",Ve,[t("button",{class:"h-9 rounded-md border border-slate-300 px-3 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-50",disabled:!X.value,onClick:ae}," Reset ",8,Ee)])])]),Z.value&&!b.value.length?(y(),v("div",Fe,[A(G)])):R(E)||R(V)?(y(),v("div",Oe,d(R(E)||R(V)),1)):(y(),v("div",Ke,[j.value?(y(),v("div",Ie,[A(G)])):P("",!0),t("table",Me,[e[17]||(e[17]=t("thead",{class:"sticky top-0 bg-gray-100"},[t("tr",{class:"text-left text-gray-700"},[t("th",{class:"px-3 py-2 w-12"},"#"),t("th",{class:"px-3 py-2"},"User"),t("th",{class:"px-3 py-2"},"Cycle"),t("th",{class:"px-3 py-2 w-[340px]"},"Progress"),t("th",{class:"px-3 py-2"},"Stage"),t("th",{class:"px-3 py-2 text-right w-40"},"Actions")])],-1)),t("tbody",null,[(y(!0),v(ye,null,_e(h.value,(s,n)=>{var i;return y(),v("tr",{key:s.id,class:"border-t hover:bg-slate-50/50"},[t("td",He,d(n+1),1),t("td",Je,[t("div",Qe,[t("div",Ye,d(((s==null?void 0:s.name)||"#").slice(0,1).toUpperCase()),1),t("div",null,[t("div",Ge,d((s==null?void 0:s.name)??"#"+s.id),1),t("div",We,[$(d(((i=s==null?void 0:s.department)==null?void 0:i.name)||"—")+" ",1),s!=null&&s.type?(y(),v("span",Xe,"•")):P("",!0),s!=null&&s.type?(y(),v("span",Ze,d(s.type),1)):P("",!0)])])])]),t("td",we,[t("span",et,d(H(s)),1)]),t("td",tt,[t("div",st,[t("div",at,[t("div",lt,[t("div",{class:"h-2 rounded-full bg-slate-700",style:fe({width:(m(s).percent||0)+"%"})},null,4)]),t("div",nt,[$(d(m(s).submitted)+" / "+d(m(s).total)+" ",1),e[15]||(e[15]=t("span",{class:"mx-1"},"•",-1)),$(" Pending: "+d(m(s).pending)+" ",1),e[16]||(e[16]=t("span",{class:"mx-1"},"•",-1)),$(" "+d(m(s).percent)+"% ",1)])])])]),t("td",it,[t("span",{class:xe(["inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium",M(s).cls])},d(M(s).label),3)]),t("td",ot,[t("div",dt,[t("button",{class:"h-9 px-3 rounded-md border border-slate-300 text-sm hover:bg-slate-50",onClick:r=>le(s)}," Open ",8,rt)])])])}),128)),h.value.length?P("",!0):(y(),v("tr",ut,[t("td",ct,d(p.value?"No users found for this scope.":"Select company & department to see users."),1)]))])])]))]))}};export{qt as default};
