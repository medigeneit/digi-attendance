import{L as te}from"./LoaderView-BNMXhIVP.js";import{O as P}from"./OverlyModal-DO_Oxa0e.js";import{_ as J}from"./DepartmentChip-BAVVrKeE.js";import{_ as se}from"./TaskAddForm-BtwpNTzb.js";import{_ as re}from"./TaskEditForm-_hXYfBcv.js";import{_ as oe}from"./TaskHeader-D-uo_L_0.js";import{_ as ie}from"./TaskUserAssignForm-CAEO_FVg.js";import{m as R,c as a,o,g as l,a as t,F as $,y as A,x as E,t as b,p as f,j as U,k as _,f as T,w as Q,b as ae,u as ne,r as M,d as le,z as W,e as de,A as X,i as F,I as ue}from"./index-BnVmGfuy.js";import{u as me}from"./task-priority-C90MdBIn.js";import{u as ce}from"./useRequirementStore-c9iVhHh2.js";import{u as pe}from"./useTaskStore-Dj9f8lll.js";import{_ as ye,T as fe,a as ge,b as xe}from"./TaskUrgentBadge-C6pvp0sJ.js";import{_ as _e,a as ke}from"./TaskAssignedUsers-1mtxXP8F.js";import{T as ve}from"./TaskIsClosedBadge-BWFptGhp.js";import{d as be,b as he}from"./datetime-Efw590t9.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./RequiredIcon-BcsjzU9y.js";import"./company-Cwfj0vxX.js";import"./url-CePbr-gY.js";import"./CompanyDepartmentSelectInput-DjLcM2y3.js";import"./SelectDropdown-CXzP3ugI.js";import"./SectionLoading-Bkj9akzX.js";import"./TextWithHr-CRTtjPFf.js";import"./TaskUrgencyInput-Dnq9bTB1.js";import"./tags-BZFMjYfe.js";import"./MultiselectDropdown-1rdg5-RD.js";import"./MultiselectDropdown.vue_vue_type_style_index_0_lang-DUIQ6Nm2.js";import"./task-B4psnkci.js";import"./EmployeeDropdownInput-ButsdWAM.js";import"./UserChip-2s4RgcE7.js";import"./SearchInput-DJkZIwOZ.js";import"./user-jLxD8qKe.js";import"./DraggableList.vue_vue_type_script_setup_true_lang-By4B9e82.js";import"./TaskUserChip-Fmn2iuzQ.js";import"./requirement-BzrdZYsC.js";import"./TaskTitle-Bh8eU0-Y.js";const Te={class:"w-full p-1"},we={key:0,class:"w-full"},qe={key:0},Ce={class:"line-clamp-1"},$e={class:"border text-center py-2 px-1 border-gray-200"},Ie={key:0,class:"text-base font-semibold text-purple-600"},Le={class:"border px-3 py-1 border-gray-200 relative"},Me={class:"flex items-center justify-between gap-2"},Ae={class:"flex items-center gap-3 mb-0.5"},Be={class:"flex items-center flex-none lg:w-full order-0 lg:order-1"},Se={class:"text-gray-400 text-xs mr-4 whitespace-nowrap"},De={class:"flex items-center gap-2 text-xs text-gray-500 opacity-80 text-left"},ze={class:"text-xs flex items-center gap-1 text-sky-400 ml-4"},Re={class:"text-xs flex items-center gap-1 text-sky-400 ml-3"},Ee=["href","onClick"],Oe={class:"border px-3 py-1 border-gray-200"},Pe={class:"flex gap-2 justify-between items-center relative w-full"},Ue={class:"shrink-0"},Fe=["href","onClick"],Ve={class:"border px-3 py-1 border-gray-200 text-center"},je={key:0,class:"ml-4 text-gray-500 text-sm"},Ne={class:"text-blue-500 font-semibold whitespace-nowrap"},He={class:"border px-3 border-gray-200 sticky right-0 border-l bg-sky-50"},Ke={class:"flex justify-end flex-wrap gap-2 py-2"},Y={__name:"TaskTable",props:{tasks:{type:Array,required:!0,default:()=>[]},hideButtons:{type:Boolean,default:!1},parentTreeLevel:{type:Number},maxItem:{Number,default:5},isMyTask:{type:Boolean,default:!1},taskLinkTo:{type:Function,default:null}},emits:["editClick","addClick","employeeAssignClick"],setup(w,{emit:g}){const B=w,d=R(()=>B.tasks.reduce((p,r)=>{var u;const k=((u=r.requirement_detail)==null?void 0:u.id)||"-",y=[...p],x=y.find(e=>(e==null?void 0:e.key)==k);return x?x.tasks=[...x.tasks,r]:y.push({key:k,position:r!=null&&r.requirement_detail?0:1,...(r==null?void 0:r.requirement_detail)||{title:"(Other tasks)",id:0},tasks:[r]}),y},[]).sort((p,r)=>p.position-r.position)),q=g;return(p,r)=>{var k;return o(),a("div",Te,[((k=w.tasks)==null?void 0:k.length)>0?(o(),a("table",we,[r[5]||(r[5]=t("thead",null,[t("tr",null,[t("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 w-[30px] sticky -top-4 z-20"}," SL "),t("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Task "),t("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Assign Person "),t("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Deadline "),t("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 -top-4 z-20 sticky right-0 border-l bg-sky-50 px-2 whitespace-nowrap"}," Status ")])],-1)),t("tbody",null,[(o(!0),a($,null,A(d.value,(y,x)=>{var u;return o(),a($,{key:y.id},[d.value.length===1&&((u=d.value[0])==null?void 0:u.id)==0?l("",!0):(o(),a("tr",qe,[t("th",{colspan:"10",class:E(["font-semibold border",[(x>0,"")]])},[t("div",{class:E(["text-left pt-4 pb-1 px-2",[y.id===0?"text-gray-500":"text-sky-800"]])},[t("div",Ce,b(y==null?void 0:y.title),1)],2)],2)])),(o(!0),a($,null,A(y.tasks,(e,S)=>{var D,I;return o(),a("tr",{key:e.id,class:E(["group/sub-task-row",{" bg-green-400/20":e.status=="COMPLETED"," bg-white hover:bg-slate-50":e.status!=="COMPLETED"}])},[t("td",$e,[S!==void 0?(o(),a("div",Ie,b(S+1)+". ",1)):l("",!0)]),t("td",Le,[t("div",Me,[t("div",null,[t("div",Ae,[f(ye,{titleClass:"text-sm",task:e,"sub-tasks-open":!1,isMyTask:w.isMyTask,to:w.taskLinkTo},null,8,["task","isMyTask","to"])]),t("div",Be,[t("div",Se,[r[0]||(r[0]=t("i",{class:"fas fa-clock"},null,-1)),U(" "+b(_(be)(e.created_at)),1)]),t("div",De,[e!=null&&e.is_important?(o(),T(fe,{key:0})):l("",!0),e!=null&&e.is_urgent?(o(),T(ge,{key:1})):l("",!0)]),t("div",ze,[r[1]||(r[1]=t("i",{class:"fas fa-tasks"},null,-1)),U(" "+b(e==null?void 0:e.todos_count),1)]),t("div",Re,[r[2]||(r[2]=t("i",{class:"fas fa-book"},null,-1)),U(" "+b((D=e==null?void 0:e.requirement_detail)==null?void 0:D.id),1)])])]),!e.is_closed&&!w.hideButtons?(o(),a("a",{key:0,href:`/tasks/edit/${e.id}`,onClick:Q(L=>q("editClick",e.id),["stop","prevent"]),class:"btn-3 py-1.5 px-1.5 !border-0 size-7 text-sm opacity-40 group-hover/sub-task-row:opacity-100 duration-100"},r[3]||(r[3]=[t("i",{class:"fas fa-edit"},null,-1)]),8,Ee)):l("",!0)])]),t("td",Oe,[t("div",Pe,[f(_e,{class:"flex items-center justify-center gap-x-3 gap-y-2",users:e.users||[],isTargetTask:e.is_target,maxItem:1,"route-to":L=>`/requirement-tasks?status=not-completed&view=userwise&user-ids=${L.id}`},null,8,["users","isTargetTask","route-to"]),t("div",Ue,[!e.is_closed&&!w.hideButtons?(o(),a("a",{key:0,href:`/tasks/${e.id}/assign-users`,onClick:Q(L=>q("employeeAssignClick",e.id),["stop","prevent"]),class:"btn-3 py-1.5 px-1.5 !border-0 size-7 text-sm opacity-40 group-hover/sub-task-row:opacity-100 duration-100 flex-shrink-0"},r[4]||(r[4]=[t("i",{class:"fas fa-users-cog"},null,-1)]),8,Fe)):l("",!0)])])]),t("td",Ve,[e.deadline?(o(),a("span",je,[t("span",Ne,b(_(he)(e.deadline)),1)])):l("",!0)]),t("td",He,[t("div",Ke,[e.closed_at?(o(),T(ve,{key:0})):l("",!0),f(ke,{status:e==null?void 0:e.status,progressPercent:(e==null?void 0:e.progress_percent)||0,class:"w-full"},null,8,["status","progressPercent"]),((I=e==null?void 0:e.children_tasks)==null?void 0:I.length)>0?(o(),T(xe,{key:1,ref_for:!0,ref:"progress",task:e,class:"text-sm w-full"},null,8,["task"])):l("",!0)])])],2)}),128))],64)}),128))])])):l("",!0)])}}},Je={class:"my-container p-6 mt-2 relative bg-white rounded-md shadow-md min-h-[50vh]"},Qe={class:"mb-4"},We={key:4,class:"text-center py-4 text-red-500"},Xe={class:"relative min-h-[20vh]"},Ye={class:"sticky top-14 z-40 text-gray-700 bg-gradient-to-tl from-sky-400/60 to-sky-400 py-2 px-4 flex items-center"},Ze={class:"font-semibold flex items-center gap-2"},Ge={class:"text-white text-base"},et={class:"rounded-b-md overflow-y-auto"},tt={class:"sticky top-14 z-40 text-gray-700 bg-gradient-to-tl from-sky-400/60 to-sky-400 py-2 px-4 flex items-center"},st={class:"font-semibold flex items-center gap-2"},rt={class:"rounded-b-md overflow-y-auto"},ot={key:2,class:"text-center py-4 text-gray-500 border h-[30vh] flex items-center justify-center rounded bg-gray-50 italic"},Ft={__name:"RequirementTaskList",setup(w){const g=pe(),B=ce(),d=ae(),q=ne(),p=M(""),r=M(null),k=M(!1),y=le(),x=W({parentId:0,requirementId:0}),u=W({taskId:0,isOpen:!1}),e=R(()=>{const n=d.query["user-ids"]||null,s=(g.tasks||[]).flatMap(m=>{var v;return n?(v=m.users)==null?void 0:v.filter(z=>n.includes(z.id)):m.users});return[...new Map(s.map(m=>[m.id,m])).values()].sort((m,v)=>m.id-v.id)}),S=R(()=>(g.tasks||[]).reduce((n,s)=>{const h=`${s.from_department_id}-${s.to_department_id}`,m=n.find(v=>v.key==h);return m?m.tasks=[...m.tasks,s]:n.push({key:h,from_department:s.from_department,to_department:s.to_department,tasks:[s]}),n},[])),D=M(null),I=M([]),{saveTaskPriority:L,listHasRearranged:V}=me(()=>g.taskListTree,0);de(()=>{console.log("Task List Mounted"),p.value="loading",C()});async function C(){console.log({name:d.name}),d.name=="RequirementTaskList"&&await g.fetchAllTasks({...d.query,page:1}),d.name=="MyRequirementTaskList"&&await g.fetchAllMyTasks({...d.query,page:1}),p.value="",I.value=[]}const O=n=>{k.value=!0,x.parentId=n},j=n=>{u.taskId=n,u.isOpen=!0};async function N(){r.value=null,k.value=!1,x.parentId=0,p.value="loading",await C()}async function Z(){k.value=!1,x.parentId=0,await C()}async function G(){p.value="loading",await L()&&await C()}function ee(n){return g.tasks.filter(s=>(s.users||[]).some(h=>h.id===n))}X(()=>({...d.query}),async()=>{try{g.resetTaskList(),p.value="loading",await C()}catch(n){console.warn(n)}}),X(()=>y.isAdminMood,n=>{n?q.push({name:"RequirementTaskList"}):q.push({name:"MyRequirementTaskList"})},{immediate:!0});const H=R({get(){return{...d.query}},set(n){localStorage.removeItem("sub_task_opened_list"),q.push({query:{...n}})}});return(n,s)=>{var h,m,v,z,K;return o(),a("div",Je,[r.value?(o(),T(P,{key:0},{default:F(()=>[f(re,{taskId:r.value,onClose:s[0]||(s[0]=c=>r.value=null),onUpdated:N},null,8,["taskId"])]),_:1})):l("",!0),k.value?(o(),T(P,{key:1},{default:F(()=>[f(se,{parentTaskId:x.parentId,requirementId:x.requirementId,onClose:Z,onTaskCreated:N},null,8,["parentTaskId","requirementId"])]),_:1})):l("",!0),u.isOpen?(o(),T(P,{key:2,class:"*:max-w-4xl"},{default:F(()=>[f(ie,{taskId:u.taskId,onCancelClick:s[1]||(s[1]=()=>{u.isOpen=!1,u.taskId=0}),onSuccess:s[2]||(s[2]=()=>{u.isOpen=!1,u.taskId=0,p.value="loading",C()})},null,8,["taskId"])]),_:1})):l("",!0),f(oe,{modelValue:H.value,"onUpdate:modelValue":s[3]||(s[3]=c=>H.value=c),onClickAddTask:O,onClickPrioritySave:G,onClickPriorityDiscard:s[4]||(s[4]=()=>_(V)?D.value.resetItems:null),"list-has-rearranged":_(V),isMyTask:_(d).name==="MyRequirementTaskList",class:"mb-6"},null,8,["modelValue","list-has-rearranged","isMyTask"]),((m=(h=_(d))==null?void 0:h.query)==null?void 0:m["query-log"])=="true"?(o(!0),a($,{key:3},A(I.value,(c,i)=>(o(),a("div",{key:i,class:"text-xs text-gray-500"},[t("div",Qe,b(c.raw_query),1)]))),128)):l("",!0),_(B).error?(o(),a("div",We,b(_(B).error),1)):l("",!0),t("div",Xe,[((v=_(d).query)==null?void 0:v.view)==="userwise"?(o(!0),a($,{key:0},A(e.value,c=>(o(),a("div",{key:c.id,class:"mt-8 rounded-md border-2 border-sky-300"},[t("div",Ye,[t("div",Ze,[f(ue,{user:c},null,8,["user"]),t("div",Ge,b(c.label),1)])]),t("div",et,[f(Y,{tasks:ee(c.id),onEditClick:s[5]||(s[5]=i=>r.value=i),onAddClick:s[6]||(s[6]=i=>O(i)),onEmployeeAssignClick:s[7]||(s[7]=i=>j(i)),taskLinkTo:i=>({name:"RequirementTaskShow",params:{id:(i==null?void 0:i.id)||0}})},null,8,["tasks","taskLinkTo"])])]))),128)):(o(!0),a($,{key:1},A(S.value,c=>(o(),a("div",{key:c.key,class:"mt-8 rounded-md border-2 border-sky-300"},[t("div",tt,[t("div",st,[s[11]||(s[11]=t("span",{class:"text-white text-sm"},"From",-1)),f(J,{department:c.from_department},null,8,["department"]),s[12]||(s[12]=t("span",{class:"text-white text-sm"},"To",-1)),f(J,{department:c.to_department},null,8,["department"])])]),t("div",rt,[f(Y,{tasks:c.tasks,groupBy:"requirement_details",onEditClick:s[8]||(s[8]=i=>r.value=i),onAddClick:s[9]||(s[9]=i=>O(i)),onEmployeeAssignClick:s[10]||(s[10]=i=>j(i)),taskLinkTo:i=>({name:"RequirementTaskShow",params:{id:(i==null?void 0:i.id)||0}})},null,8,["tasks","taskLinkTo"])])]))),128)),p.value!=="loading"&&((z=_(g).tasks)==null?void 0:z.length)===0?(o(),a("div",ot," No tasks ")):l("",!0),p.value==="loading"?(o(),T(te,{key:3,class:E(["absolute inset-0 flex items-center z-50 bg-opacity-60 h-full shadow-none border",[((K=_(g).tasks)==null?void 0:K.length)===0?"justify-center":""]])},null,8,["class"])):l("",!0)])])}}};export{Ft as default};
