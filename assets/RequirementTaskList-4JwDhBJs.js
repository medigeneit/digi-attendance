import{L as rt}from"./LoaderView-BwZ-yisx.js";import{O as N}from"./OverlyModal-CDktpBBw.js";import{_ as Z}from"./DepartmentChip-CzLR7UkS.js";import{b as it,_ as lt}from"./TaskTableRow-BFtGiWk8.js";import{_ as dt}from"./TaskAddForm-cwaoAvRD.js";import{_ as ut}from"./TaskEditForm-C5yCL4g6.js";import{_ as mt}from"./TaskHeader-DEs7lMau.js";import{a as ct}from"./TaskUserAssignForm-Dx_iddot.js";import{f as et,x as P,p as pt,c as i,o,j as y,a as s,F as $,e as B,s as K,i as C,t as T,l as S,b as j,w as kt,m as k,u as yt,r as M,g as ft,G as H,h as _t,q as G,d as h,M as gt}from"./index-CzXWm8H4.js";import{u as vt}from"./task-priority-NkKXG-8C.js";import{u as ht}from"./useRequirementStore-BlPFbKlk.js";import{u as xt}from"./useTaskStore-CxxhOLAn.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./datetime-BEfC2TVK.js";import"./TaskUrgentBadge-CQSQbqvb.js";import"./TaskTitle-C0zbPpfC.js";import"./TaskAssignedUsers-BY53Fw5T.js";import"./UserChip-BzhTBlxg.js";import"./TaskIsClosedBadge-BzB4_lez.js";import"./RequiredIcon-CUiQP7-6.js";import"./company-6b3ryEZt.js";import"./requirement-BeuVPHxK.js";import"./CompanyDepartmentSelectInput-DNjnp_8I.js";import"./SelectDropdown-BWqTBot7.js";import"./SectionLoading-dbFdUTDB.js";import"./TextEditor-B0pcz3jy.js";import"./TextWithHr-cOdiiifB.js";import"./TaskUrgencyInput-BnyzuBTg.js";import"./tags-Cff0IfG7.js";import"./MultiselectDropdown-CykKAe5I.js";import"./MultiselectDropdown.vue_vue_type_style_index_0_lang-DHZJlj1E.js";import"./task--PGZcMCD.js";import"./url-CePbr-gY.js";import"./EmployeeDropdownInput-jL3KZXis.js";import"./SearchInput-BcvjHy-S.js";import"./user-DBslvaD8.js";import"./DraggableList.vue_vue_type_script_setup_true_lang-CRnSigUD.js";const bt={class:"w-full p-1"},wt={key:0,class:"w-full rounded-b"},Tt={class:"group/dept"},Ct={class:"flex gap-1 items-center text-base"},Lt={class:"font-bold text-lime-600"},At={key:0},$t=["onClick"],qt={class:"ml-auto"},It=["onClick"],tt={__name:"TaskTable",props:{tasks:{type:Array,required:!0,default:()=>[]},hideButtons:{type:Boolean,default:!1},parentTreeLevel:{type:Number},maxItem:{Number,default:5},isMyTask:{type:Boolean,default:!1},taskLinkTo:{type:Function,default:null}},emits:["editClick","addClick","employeeAssignClick","clickAddClick","clickAttachment"],setup(q,{emit:f}){const V=q,d=et(),I=P(()=>V.tasks.reduce((_,a)=>{var u;const L=((u=a.requirement)==null?void 0:u.id)||"-",m=[..._],e=m.find(b=>(b==null?void 0:b.key)==L);return e?e.tasks=[...e.tasks,a]:m.push({key:L,position:a!=null&&a.requirement?0:1,...(a==null?void 0:a.requirement)||{title:"(Other tasks)",id:0},tasks:[a]}),m},[]).sort((_,a)=>_.position-a.position)),p=f;return(_,a)=>{var m;const L=pt("RouterLink");return o(),i("div",bt,[((m=q.tasks)==null?void 0:m.length)>0?(o(),i("table",wt,[a[4]||(a[4]=s("thead",null,[s("tr",null,[s("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 w-[30px] sticky -top-4 z-20"}," SL "),s("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Task "),s("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Assign Person "),s("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Deadline "),s("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 -top-4 z-20 sticky right-0 border-l bg-sky-50 px-2 whitespace-nowrap"}," Status ")])],-1)),s("tbody",null,[(o(!0),i($,null,B(I.value,(e,u)=>{var b,z,F,R;return o(),i($,{key:e.id},[s("tr",Tt,[s("th",{colspan:"10",class:K(["font-semibold",[(u>0,"")]])},[s("div",{class:K(["text-left -mx-[2px] -mb-[1px] py-2 px-2 flex items-center border border-b-0 rounded-t bg-emerald-50",[e.id===0?"text-gray-500":"text-sky-800",u>0?"mt-4":""]])},[s("div",Ct,[s("div",Lt,T(u+1)+".",1),e.id===0?(o(),i("p",At,T(e.title),1)):(o(),C(L,{key:1,to:`requirements/show/${e.id}`,class:"line-clamp-2 hover:underline"},{default:S(()=>[j(T(e.title),1)]),_:2},1032,["to"])),((b=e.attachments)==null?void 0:b.length)>0?(o(),i("button",{key:2,class:"text-sky-400 text-sm",onClick:kt(A=>p("clickAttachment",e.attachments),["prevent"])},[a[2]||(a[2]=s("i",{class:"fas fa-paperclip"},null,-1)),j(" "+T((z=e.attachments)==null?void 0:z.length)+" Attachment"+T(((F=e.attachments)==null?void 0:F.length)>1?"s":""),1)],8,$t)):y("",!0)]),s("div",qt,[((R=k(d))==null?void 0:R.name)=="RequirementTaskList"?(o(),i("button",{key:0,onClick:A=>p("clickAddTask",{requirement_id:e==null?void 0:e.id,from_department_id:e==null?void 0:e.from_department_id,to_department_id:e==null?void 0:e.to_department_id},{requirement_id:!0,from_department_id:!0,to_department_id:!0}),class:"btn-2 whitespace-nowrap h-6 px-3 opacity-70 group-hover/dept:opacity-100"},a[3]||(a[3]=[s("i",{class:"fas fa-plus-circle"},null,-1),j(" Add Task ")]),8,It)):y("",!0)])],2)],2)]),(o(!0),i($,null,B(e.tasks,(A,U)=>(o(),C(it,{key:A.id,task:A,indexing:`${u+1}.${U+1}`,onEditClick:a[0]||(a[0]=g=>p("editClick",g)),onEmployeeAssignClick:a[1]||(a[1]=g=>p("employeeAssignClick",g)),taskLinkTo:q.taskLinkTo,hideButtons:q.hideButtons},null,8,["task","indexing","taskLinkTo","hideButtons"]))),128))],64)}),128))])])):y("",!0)])}}},Rt={class:"my-container p-6 mt-2 relative bg-white rounded-md shadow-md min-h-[50vh]"},Mt={class:"mb-4"},St={key:4,class:"text-center py-4 text-red-500"},Bt={class:"relative min-h-[20vh]"},Vt={key:0,class:"space-y-6"},zt={class:"sticky top-14 z-40 text-gray-700 bg-gradient-to-tl from-sky-400/60 to-sky-400 py-2 px-4 flex items-center"},Ft={class:"font-semibold flex items-center gap-2"},Ut={class:"text-white text-base"},Et={class:"rounded-b-md overflow-y-auto"},Ot={key:1,class:"space-y-6"},Dt={class:"sticky top-14 z-40 text-gray-700 bg-gradient-to-tl from-sky-400/60 to-sky-400 py-2 px-4 flex items-center"},Nt={class:"font-semibold flex items-center gap-2"},Pt={class:"ml-auto"},jt=["onClick"],Ht={class:"rounded-b-md overflow-y-auto"},Kt={key:2,class:"text-center py-4 text-gray-500 border h-[30vh] flex items-center justify-center rounded bg-gray-50 italic"},Ie={__name:"RequirementTaskList",setup(q){const f=xt(),V=ht(),d=et(),I=yt(),p=M(""),_=M(null),a=M(!1),L=ft(),m=H({show:!1,attachments:[]}),e=H({parentId:0,requirementId:0,params:{}}),u=H({taskId:0,isOpen:!1}),b=P(()=>{const r=d.query["user-ids"]||null,t=(f.tasks||[]).flatMap(c=>{var x;return r?(x=c.users)==null?void 0:x.filter(O=>r.includes(O.id)):c.users});return[...new Map(t.map(c=>[c.id,c])).values()].sort((c,x)=>c.id-x.id)}),z=P(()=>(f.tasks||[]).reduce((r,t)=>{const w=`${t.from_department_id}-${t.to_department_id}`,c=r.find(x=>x.key==w);return c?c.tasks=[...c.tasks,t]:r.push({key:w,from_department:t.from_department,to_department:t.to_department,tasks:[t]}),r},[])),F=M(null),R=M([]),{saveTaskPriority:A,listHasRearranged:U}=vt(()=>f.taskListTree,0);_t(()=>{console.log("Task List Mounted"),p.value="loading",g()});async function g(){console.log({name:d.name}),d.name=="RequirementTaskList"&&await f.fetchAllTasks({...d.query,page:1}),d.name=="MyRequirementTaskList"&&await f.fetchAllMyTasks({...d.query,page:1}),p.value="",R.value=[]}const E=(r,t)=>{a.value=!0,e.params=r,e.readonlyValues=t},J=r=>{u.taskId=r,u.isOpen=!0};async function Q(){_.value=null,a.value=!1,p.value="loading",e.params={},await g()}async function st(){a.value=!1,e.params={},await g()}async function at(){p.value="loading",await A()&&await g()}function ot(r){return f.tasks.filter(t=>(t.users||[]).some(w=>w.id===r))}G(()=>({...d.query}),async()=>{try{f.resetTaskList(),p.value="loading",await g()}catch(r){console.warn(r)}}),G(()=>L.isAdminMood,r=>{r?I.push({name:"RequirementTaskList",query:d.query}):I.push({name:"MyRequirementTaskList",query:d.query})});const W=P({get(){return{...d.query}},set(r){localStorage.removeItem("sub_task_opened_list"),I.push({query:{...r}})}});function nt(r){return{name:"RequirementTaskShow",params:{id:(r==null?void 0:r.id)||0}}}return(r,t)=>{var w,c,x,O,X;return o(),i("div",Rt,[_.value?(o(),C(N,{key:0},{default:S(()=>[h(ut,{taskId:_.value,onClose:t[0]||(t[0]=n=>_.value=null),onUpdated:Q},null,8,["taskId"])]),_:1})):y("",!0),a.value?(o(),C(N,{key:1},{default:S(()=>{var n,l;return[h(dt,{parentTaskId:e.parentId,requirementId:(n=e.params)==null?void 0:n.requirement_id,requirementDetailId:(l=e.params)==null?void 0:l.requirement_detail_id,"default-values":e.params,"readonly-fields":e.readonlyValues,onClose:st,onTaskCreated:Q},null,8,["parentTaskId","requirementId","requirementDetailId","default-values","readonly-fields"])]}),_:1})):y("",!0),u.isOpen?(o(),C(N,{key:2,class:"*:max-w-4xl"},{default:S(()=>[h(ct,{taskId:u.taskId,onCancelClick:t[1]||(t[1]=()=>{u.isOpen=!1,u.taskId=0}),onSuccess:t[2]||(t[2]=()=>{u.isOpen=!1,u.taskId=0,p.value="loading",g()})},null,8,["taskId"])]),_:1})):y("",!0),h(mt,{modelValue:W.value,"onUpdate:modelValue":t[3]||(t[3]=n=>W.value=n),onClickAddTask:E,onClickPrioritySave:at,onClickPriorityDiscard:t[4]||(t[4]=()=>k(U)?F.value.resetItems:null),"list-has-rearranged":k(U),isMyTask:k(d).name==="MyRequirementTaskList",class:"mb-4"},null,8,["modelValue","list-has-rearranged","isMyTask"]),((c=(w=k(d))==null?void 0:w.query)==null?void 0:c["query-log"])=="true"?(o(!0),i($,{key:3},B(R.value,(n,l)=>(o(),i("div",{key:l,class:"text-xs text-gray-500"},[s("div",Mt,T(n.raw_query),1)]))),128)):y("",!0),k(V).error?(o(),i("div",St,T(k(V).error),1)):y("",!0),s("div",Bt,[((x=k(d).query)==null?void 0:x.view)==="userwise"?(o(),i("div",Vt,[(o(!0),i($,null,B(b.value,n=>(o(),i("div",{key:n.id,class:"rounded-md border-2 border-sky-300"},[s("div",zt,[s("div",Ft,[h(gt,{user:n},null,8,["user"]),s("div",Ut,T(n.label),1)])]),s("div",Et,[h(tt,{tasks:ot(n.id),onEditClick:t[5]||(t[5]=l=>_.value=l),onAddClick:t[6]||(t[6]=l=>E(l)),onEmployeeAssignClick:t[7]||(t[7]=l=>J(l)),onClickAttachment:t[8]||(t[8]=l=>{m.show=!0,m.attachments=l}),taskLinkTo:l=>({name:"RequirementTaskShow",params:{id:(l==null?void 0:l.id)||0}})},null,8,["tasks","taskLinkTo"])])]))),128))])):(o(),i("div",Ot,[(o(!0),i($,null,B(z.value,n=>{var l,Y;return o(),i("div",{key:n.key,class:"rounded-md border-2 border-sky-300"},[s("div",Dt,[s("div",Nt,[t[14]||(t[14]=s("span",{class:"text-white text-sm"},"From",-1)),h(Z,{department:n.from_department},null,8,["department"]),t[15]||(t[15]=s("span",{class:"text-white text-sm"},"To",-1)),h(Z,{department:n.to_department},null,8,["department"])]),s("div",Pt,[((l=k(d))==null?void 0:l.name)=="RequirementTaskList"?(o(),i("button",{key:0,onClick:()=>{var v,D;return E({from_department_id:(v=n==null?void 0:n.from_department)==null?void 0:v.id,to_department_id:(D=n==null?void 0:n.to_department)==null?void 0:D.id},{from_department_id:!0,to_department_id:!0})},class:"btn-3 h-6 whitespace-nowrap bg-white border-white px-2"}," Add Task ",8,jt)):y("",!0)])]),s("div",Ht,[h(tt,{tasks:n.tasks,groupBy:"requirement",onEditClick:t[9]||(t[9]=v=>_.value=v),onClickAddTask:t[10]||(t[10]=(v,D)=>E(v,D)),onEmployeeAssignClick:t[11]||(t[11]=v=>J(v)),onClickAttachment:t[12]||(t[12]=v=>{m.show=!0,m.attachments=v}),hideButtons:((Y=k(d))==null?void 0:Y.name)!=="RequirementTaskList",taskLinkTo:nt},null,8,["tasks","hideButtons"])])])}),128))])),p.value!=="loading"&&((O=k(f).tasks)==null?void 0:O.length)===0?(o(),i("div",Kt," No tasks ")):y("",!0),p.value==="loading"?(o(),C(rt,{key:3,class:K(["absolute inset-0 flex items-center z-50 bg-opacity-60 h-full shadow-none border",[((X=k(f).tasks)==null?void 0:X.length)===0?"justify-center":""]])},null,8,["class"])):y("",!0)]),m.show?(o(),C(N,{key:5},{default:S(()=>[h(lt,{attachments:m.attachments||[],onClickClose:t[13]||(t[13]=n=>m.show=!1)},null,8,["attachments"])]),_:1})):y("",!0)])}}};export{Ie as default};
