import{N as H,r as A,A as S,m as y,e as K,K as J,f as Q,o as r,p as M,i as U,c as l,g as I,a as t,a6 as E,t as d,h as V,F as P,y as R,B as W,v as O,T as X,k as z,Y as Z}from"./index-DKvvHbAy.js";import{u as ee}from"./monthly-kpi-assignments-Cap-uISH.js";import{_ as te}from"./_plugin-vue_export-helper-DlAUqK2U.js";const se={key:0,class:"fixed inset-0 z-50 flex items-center justify-center"},ae={class:"relative w-full max-w-4xl rounded-2xl bg-white shadow-xl ring-1 ring-black/5 p-5"},ie={class:"flex items-start justify-between mb-4"},ne={class:"flex items-center gap-3"},oe={class:"h-10 w-10 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center font-semibold"},re={class:"text-xs text-gray-500"},le={class:"grid gap-5 md:grid-cols-12"},de={class:"md:col-span-7"},ue={class:"rounded-lg border bg-white p-4"},ce={class:"grid gap-4 md:grid-cols-12"},me={class:"md:col-span-12"},_e=["disabled"],ve=["value"],ge={key:0,class:"mt-1 text-xs text-gray-500"},pe={key:1,class:"mt-1 text-xs text-gray-500"},fe={class:"mt-2"},ye={key:0,class:"text-xs text-blue-600"},be={key:1,class:"text-xs text-amber-600"},xe={class:"md:col-span-5"},he={class:"md:col-span-5"},ke={class:"md:col-span-2 flex items-end"},we={class:"inline-flex items-center gap-2 select-none mt-1"},Ce={class:"mt-4 flex justify-end gap-2"},Ae=["disabled"],Se=["disabled"],Ve={key:0},Ne={key:1},Ie={class:"md:col-span-5"},Te={class:"rounded-lg border bg-white p-4"},$e={class:"flex items-center justify-between mb-2"},Le={class:"text-xs text-gray-500"},Be={key:0,class:"text-sm text-gray-500"},Fe={key:1,class:"divide-y"},je=["checked"],De={class:"flex-1"},Ke={class:"flex items-center gap-2"},Me={class:"text-sm text-gray-900"},Ue={key:0,class:"inline-flex items-center text-xs font-medium rounded-full bg-green-100 text-green-700 px-2 py-0.5"},Ee={key:1,class:"inline-flex items-center text-xs font-medium rounded-full bg-gray-100 text-gray-700 px-2 py-0.5"},Pe={class:"mt-0.5 text-xs text-gray-600"},Re={class:"mt-0.5 text-[11px] text-gray-400"},Oe={__name:"CriteriaAssignModal",props:{modelValue:{type:Boolean,default:!1},userId:{type:[Number,String],default:""},userLabel:{type:String,default:""},defaultFrom:{type:String,default:()=>new Date().toISOString().slice(0,10)},defaultTo:{type:String,default:""},criteria_assignments:{type:[Object,Array,null],default:null}},emits:["update:modelValue","assigned"],setup(T,{emit:Y}){const u=T,$=Y,m=H(),_=A(u.modelValue);S(()=>u.modelValue,e=>_.value=e),S(_,e=>$("update:modelValue",e));const x=ee(),N=x.isSaving,o=A({user_id:String(u.userId||""),criteria_id:"",assigned_from:u.defaultFrom,assigned_to:u.defaultTo,active:!0}),h=A([]),k=A(!1);function L(e){var v,f;const s=e!=null&&e.code?` ${e.code}`:"",n=e!=null&&e.type?` — ${e.type}`:"",i=(e==null?void 0:e.start_month)??"",a=e!=null&&e.end_month?` → ${e.end_month}`:"",c=e!=null&&e.name||(v=e==null?void 0:e.criteria)!=null&&v.name?` — ${e.name||((f=e.criteria)==null?void 0:f.name)}`:"";return`#${e.id}${s}${n} — ${i}${a}${c}`}async function q(){try{k.value=!0;const e=await x.fetchAvailableCriteria("");h.value=Array.isArray(e)?e:[]}finally{k.value=!1}}const G=y(()=>{var i,a;const e=u.userLabel||String(o.value.user_id||""),s=e.trim().split(/\s+/);return((((i=s[0])==null?void 0:i[0])||"")+(((a=s[1])==null?void 0:a[0])||"")||e[0]||"#").toUpperCase().slice(0,2)});function B(e){return e?String(e).slice(0,10):""}const g=y(()=>{const e=u.criteria_assignments;return(Array.isArray(e)?e.slice():e?[e]:[]).map(i=>{const a=i.criteria||i,c=L({id:(a==null?void 0:a.id)??i.criteria_id,code:a==null?void 0:a.code,type:a==null?void 0:a.type,start_month:(a==null?void 0:a.start_month)??i.start_month,end_month:(a==null?void 0:a.end_month)??i.end_month,name:(a==null?void 0:a.name)??i.criteria_name,criteria:a==null?void 0:a.criteria});return{id:i.id??null,criteria_id:i.criteria_id??(a==null?void 0:a.id)??null,label:c,active:!!i.active&&(i.assigned_to==null||i.assigned_to===""),assigned_from:B(i.assigned_from),assigned_to:B(i.assigned_to),created_at:i.created_at?new Date(i.created_at).getTime():0}}).sort((i,a)=>i.active!==a.active?i.active?-1:1:(a.assigned_from||"").localeCompare(i.assigned_from||""))}),p=y(()=>g.value.find(e=>e.active)||g.value[0]||null),w=y(()=>!!p.value&&p.value.active),C=y(()=>{if(!w.value)return!1;const e=Number(p.value.criteria_id||0),s=Number(o.value.criteria_id||0);return e>0&&e===s}),F=y(()=>!!o.value.user_id&&!!o.value.criteria_id&&!N.value&&!C.value);function b(){_.value=!1}async function j(){var e,s,n,i,a;try{if(!o.value.user_id)return m.error("Employee নির্বাচন করুন");if(!o.value.criteria_id)return m.error("Criteria নির্বাচন করুন");if(C.value){m.info("এই criteria আগেই active আছে");return}if(w.value&&((e=p.value)!=null&&e.id))try{await x.close(p.value.id),m.success("Previous assignment closed")}catch(f){return m.error(((n=(s=f==null?void 0:f.response)==null?void 0:s.data)==null?void 0:n.message)||"Failed to close previous assignment")}const c={user_id:Number(o.value.user_id),criteria_id:Number(o.value.criteria_id),assigned_from:o.value.assigned_from,assigned_to:o.value.assigned_to||null,active:!!o.value.active},v=await x.create(c);m.success("Assigned"),$("assigned",(v==null?void 0:v.data)||v),b()}catch(c){m.error(((a=(i=c==null?void 0:c.response)==null?void 0:i.data)==null?void 0:a.message)||"Failed")}}S(()=>u.userId,e=>{o.value.user_id=String(e||"")}),S([_,g],()=>{var s;if(!_.value)return;const e=(s=p.value)==null?void 0:s.criteria_id;e&&(o.value.criteria_id=String(e))}),K(async()=>{o.value.user_id=String(u.userId||""),await q()});function D(e){_.value&&(e.key==="Escape"&&b(),(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="enter"&&F.value&&j())}return K(()=>window.addEventListener("keydown",D)),J(()=>window.removeEventListener("keydown",D)),(e,s)=>(r(),Q(Z,{to:"body"},[M(E,{name:"fade"},{default:U(()=>[_.value?(r(),l("div",se,[t("div",{class:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:b}),M(E,{name:"pop"},{default:U(()=>[t("div",ae,[t("div",ie,[t("div",ne,[t("div",oe,d(G.value),1),t("div",null,[s[4]||(s[4]=t("h3",{class:"text-base font-semibold text-gray-900"},"Assign KPI Criteria",-1)),t("p",re,d(T.userLabel||"#"+o.value.user_id),1)])]),t("button",{class:"btn-icon",onClick:b,"aria-label":"Close"},"✕")]),t("div",le,[t("div",de,[t("div",ue,[t("div",ce,[t("div",me,[s[6]||(s[6]=t("label",{class:"block text-sm font-medium text-gray-700"},"Criteria",-1)),V(t("select",{"onUpdate:modelValue":s[0]||(s[0]=n=>o.value.criteria_id=n),class:"mt-1 w-full rounded-md border px-3 py-2 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200",disabled:k.value||!h.value.length},[s[5]||(s[5]=t("option",{value:""},"Select a criteria…",-1)),(r(!0),l(P,null,R(h.value,n=>(r(),l("option",{key:n.id,value:n.id},d(L(n)),9,ve))),128))],8,_e),[[W,o.value.criteria_id]]),k.value?(r(),l("p",ge,"Loading criteria…")):h.value.length?I("",!0):(r(),l("p",pe,"No criteria found")),t("div",fe,[C.value?(r(),l("p",ye," এই criteria আগেই active আছে। ")):w.value&&o.value.criteria_id?(r(),l("p",be," Reassign করলে আগের assignment close হবে এবং নতুনটি তৈরি হবে। ")):I("",!0)])]),t("div",xe,[s[7]||(s[7]=t("label",{class:"block text-sm font-medium text-gray-700"},"From",-1)),V(t("input",{"onUpdate:modelValue":s[1]||(s[1]=n=>o.value.assigned_from=n),type:"month",class:"mt-1 w-full rounded-md border px-3 py-2"},null,512),[[O,o.value.assigned_from]])]),t("div",he,[s[8]||(s[8]=t("label",{class:"block text-sm font-medium text-gray-700"},"To (optional)",-1)),V(t("input",{"onUpdate:modelValue":s[2]||(s[2]=n=>o.value.assigned_to=n),type:"month",class:"mt-1 w-full rounded-md border px-3 py-2"},null,512),[[O,o.value.assigned_to]])]),t("div",ke,[t("label",we,[V(t("input",{type:"checkbox","onUpdate:modelValue":s[3]||(s[3]=n=>o.value.active=n),class:"rounded border-gray-300"},null,512),[[X,o.value.active]]),s[9]||(s[9]=t("span",{class:"text-sm text-gray-700"},"Active",-1))])])]),t("div",Ce,[t("button",{class:"btn-3",onClick:b,disabled:z(N)},"Cancel",8,Ae),t("button",{class:"btn-2",onClick:j,disabled:!F.value},[z(N)?(r(),l("span",Ne,"Processing…")):(r(),l("span",Ve,d(w.value?C.value?"Assigned":"Reassign":"Assign"),1))],8,Se)])])]),t("div",Ie,[t("div",Te,[t("div",$e,[s[10]||(s[10]=t("h4",{class:"text-sm font-semibold text-gray-800"},"Criteria history",-1)),t("span",Le,d(g.value.length)+" item(s)",1)]),g.value.length?(r(),l("ul",Fe,[(r(!0),l(P,null,R(g.value,(n,i)=>(r(),l("li",{key:n.id??i,class:"py-3 flex items-start gap-3"},[t("input",{type:"checkbox",class:"mt-1 rounded border-gray-300",checked:n.active,disabled:""},null,8,je),t("div",De,[t("div",Ke,[t("span",Me,d(n.label),1),n.active?(r(),l("span",Ue," Active ")):(r(),l("span",Ee," Closed "))]),t("div",Pe," Period: "+d(n.assigned_from||"—")+" → "+d(n.assigned_to||"present"),1),t("div",Re," ID: "+d(n.id||"—")+", CID: "+d(n.criteria_id||"—"),1)])]))),128))])):(r(),l("div",Be," No assignment history ")),s[11]||(s[11]=t("p",{class:"mt-3 text-[11px] text-gray-500"},' টিপ: Active পরিবর্তন করতে বাম পাশের ফর্ম থেকে নতুন criteria নির্বাচন করে "Assign/Reassign" করুন। ',-1))])])])])]),_:1})])):I("",!0)]),_:1})]))}},Ge=te(Oe,[["__scopeId","data-v-ed932d55"]]);export{Ge as C};
