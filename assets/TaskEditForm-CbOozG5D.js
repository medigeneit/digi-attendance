import{r as d,g as F,h as M,q as E,c as u,o as a,a as s,i as T,j as v,k as I,v as $,d as j,m as f,t as y,w as S}from"./index-DWuYLofk.js";import{g as V}from"./datetime-BEfC2TVK.js";import{u as A}from"./company-Cxj8fGSU.js";import{u as L}from"./tags-DyD9PbHc.js";import{u as O}from"./useTaskStore-BCDmX-OJ.js";import{S as W}from"./SectionLoading-B5IDECzv.js";import{_ as R}from"./MultiselectDropdown-CnPomUc7.js";import{_ as Y}from"./TextEditor-BXWvL_gj.js";const z={class:"px-4 max-h-[90vh] overflow-auto"},G={class:"sticky top-0 pt-4 -mx-4 px-4 border-b bg-white rounded-t-md"},H={key:0,class:"text-center py-4 text-gray-500"},J={class:"mb-4"},K={class:"mb-4"},P={key:0,class:"mb-4"},Q={class:"mb-4"},X={key:0},Z={class:"sticky bottom-0 bg-white py-4 border-t"},D={key:0,class:"mb-4 text-red-500 font-medium"},ee={key:1},te={class:"flex items-center gap-4 justify-between"},se=["disabled"],me={__name:"TaskEditForm",props:{taskId:{type:[String,Number],required:!0}},emits:["updated","cancel"],setup(q,{emit:B}){const k=q,h=B,m=O(),b=d([]),x=L(),N=F(),U=A(),i=d(),r=d(!1),_=d([]),g=d(""),n=d({});M(async()=>{var t,e;r.value=!0,x.fetchTags("website"),i.value=(t=await m.fetchTask(k.taskId,{},{fetchOnly:!0,loadingBeforeFetch:!1}))==null?void 0:t.task,await U.fetchCompanies({with:"departments",ignore_permission:!0}),w(i.value),b.value=((e=i.value)==null?void 0:e.website_tags)||[],_.value=i.value.users,r.value=!1}),E(()=>i.value,t=>{w(t),_.value=t.users});function w(t){var e;n.value={title:t.title,description:t.description,requirement_id:t.requirement_id,from_department_id:t.from_department_id,to_department_id:t.to_department_id,...((e=N.user)==null?void 0:e.role)!=="employee"?{is_important:t.is_important,is_urgent:t.is_urgent,is_target:t.is_target,started_at:V(t.started_at),deadline:V(t.deadline)}:{}}}const C=async()=>{var t,e,c,p;r.value=!0;try{const l={...n.value,user_ids:((t=_.value)==null?void 0:t.map(o=>Number(o.id)))||[],website_tags:((e=b.value)==null?void 0:e.map(o=>Number(o.id)))||[]};await m.updateTask(k.taskId,l,{loadingBeforeFetch:!1}),h("updated")}catch(l){console.error(l),g.value=((p=(c=l.response)==null?void 0:c.data)==null?void 0:p.message)||"An error occurred while updating the task."}finally{r.value=!1}};return(t,e)=>{var c,p,l;return a(),u("div",z,[s("div",G,[e[4]||(e[4]=s("h2",{class:"text-2xl font-semibold text-gray-800 mb-4"},"Edit Task",-1)),r.value?(a(),u("div",H,"Loading form...")):v("",!0)]),s("form",{onSubmit:S(C,["prevent"]),class:"mt-4"},[s("div",J,[e[5]||(e[5]=s("label",{class:"block text-gray-700 font-medium mb-2"},"Task Title",-1)),I(s("input",{"onUpdate:modelValue":e[0]||(e[0]=o=>n.value.title=o),required:"",placeholder:"Enter task title",class:"w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"},null,512),[[$,n.value.title]])]),s("div",K,[e[6]||(e[6]=s("label",{class:"text-gray-800"},"Websites",-1)),j(R,{options:f(x).tags,multiple:!0,modelValue:b.value,"onUpdate:modelValue":e[1]||(e[1]=o=>b.value=o),label:"name","track-by":"id"},null,8,["options","modelValue"])]),(c=i.value)!=null&&c.requirement?(a(),u("div",P,[e[7]||(e[7]=s("label",{class:"block text-gray-700 font-medium mb-2"},"Requirement",-1)),s("div",null,[s("p",null,y((l=(p=i.value)==null?void 0:p.requirement)==null?void 0:l.title),1)])])):v("",!0),s("div",Q,[e[8]||(e[8]=s("label",{class:"block text-gray-700 font-medium mb-2"},"Description",-1)),r.value?(a(),u("div",X)):(a(),T(Y,{key:1,modelValue:n.value.description,"onUpdate:modelValue":e[2]||(e[2]=o=>n.value.description=o)},null,8,["modelValue"]))]),s("div",Z,[f(m).error||g.value?(a(),u("div",D,y(f(m).error||g.value),1)):v("",!0),f(m).error?(a(),u("hr",ee)):v("",!0),s("div",te,[s("button",{type:"button",onClick:e[3]||(e[3]=S(o=>h("close"),["prevent"])),class:"btn-3"},"Cancel"),s("button",{disabled:r.value,type:"submit",class:"btn-2"},y(r.value?"Updating...":"Update Task"),9,se)])])],32),r.value?(a(),T(W,{key:0})):v("",!0)])}}};export{me as _};
