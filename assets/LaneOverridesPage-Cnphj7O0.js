import{B as _e,C as $,r as p,h as J,y as ge,c,o as v,j as S,k as F,a,t as f,v as Y,F as V,e as K,s as A,u as he,x as P,S as ne,a7 as xe,q as be,b as H,H as ke,m as L,d as G,l as oe,T as re,A as ue}from"./index-Cf6qM8w5.js";const we=_e("kpiAdmin",{state:()=>({cycles:[],lanesConfig:null,overrides:[],loading:!1,_userCache:new Map,_abortCtrls:{}}),actions:{async fetchCycles(){this.loading=!0;try{const{data:r}=await $.get("/kpi/cycles");this.cycles=r}finally{this.loading=!1}},async loadCycle(r){const{data:l}=await $.get(`/kpi/cycles/${r}`);return this.lanesConfig=l.reviewer_lanes_json||[],l},async updateLanes(r,l){const{data:u}=await $.put(`/kpi/cycles/${r}/lanes`,{reviewer_lanes_json:l});return this.lanesConfig=u.reviewer_lanes_json,u},async fetchOverrides(r){const{data:l}=await $.get("/kpi/overrides",{params:r});return this.overrides=l,l},async saveOverridesBulk(r){return(await $.post("/kpi/overrides/save-bulk",r)).data},async lookupUsers(r){var d;const l=typeof r=="string"?{q:r}:r||{},u=JSON.stringify({q:l.q||"",lane_key:l.lane_key});if(this._userCache.has(u))return this._userCache.get(u);this._abortCtrls[u]&&this._abortCtrls[u].abort();const i=new AbortController;this._abortCtrls[u]=i;try{const{data:n}=await $.get("/users",{params:l,signal:i.signal});return this._userCache.set(u,n),setTimeout(()=>this._userCache.delete(u),6e4),n}catch(n){if(n.name==="CanceledError"||(d=n.message)!=null&&d.includes("canceled"))return[];throw n}finally{delete this._abortCtrls[u]}},async lookupDepartments(r){const{data:l}=await $.get("/departments",{params:{q:r}});return l}}}),Ce={key:0,class:"mb-2 inline-flex items-center gap-2 rounded-full border px-3 py-1"},De={class:"text-sm"},Se={class:"text-[11px] text-slate-500"},Ue=["placeholder"],Ee={key:1,class:"absolute left-0 mt-1 border bg-white rounded-lg shadow max-h-56 overflow-auto w-[28rem] max-w-[90vw] z-20"},$e={key:0,class:"px-3 py-2 text-slate-500 text-sm"},Le=["onClick"],Ae=["innerHTML"],Ve={class:"text-[11px] text-slate-500"},Te={key:0,class:"px-3 py-2 text-slate-400 text-sm"};function Ne(r,l){if(!l)return r;try{const u=new RegExp(`(${l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"ig");return(r==null?void 0:r.replace(u,"<mark>$1</mark>"))??""}catch{return r}}const Ke={__name:"AsyncUserCombobox",props:{modelValue:{type:[Number,null],default:null},display:{type:Object,default:()=>({name:null,dept:null})},placeholder:{type:String,default:"Search user…"},fetcher:{type:Function,required:!0},laneKey:{type:String,default:null},departmentId:{type:[Number,null],default:null},limit:{type:Number,default:20}},emits:["update:modelValue","update:display","cleared"],setup(r,{emit:l}){const u=r,i=l,d=p(!1),n=p(""),y=p([]),g=p(!1),x=p(-1);let w=null;async function T(){g.value=!0;const m=await u.fetcher({q:n.value,lane_key:u.laneKey,limit:u.limit});y.value=m,g.value=!1,x.value=m.length?0:-1}function C(){clearTimeout(w),w=setTimeout(T,250)}function U(){d.value=!0,n.value||C()}function E(m){if(!d.value)return;const h=y.value.length;m.key==="ArrowDown"?(m.preventDefault(),h&&(x.value=(x.value+1)%h)):m.key==="ArrowUp"?(m.preventDefault(),h&&(x.value=(x.value-1+h)%h)):m.key==="Enter"?(m.preventDefault(),h&&x.value>=0&&N(y.value[x.value])):m.key==="Escape"&&(d.value=!1)}function N(m){i("update:modelValue",m.id),i("update:display",{name:m.name,dept:m.department_name||null}),d.value=!1,n.value="",y.value=[]}function j(){i("update:modelValue",null),i("update:display",{name:null,dept:null}),i("cleared")}function b(m){const h=k.value;h&&!h.contains(m.target)&&(d.value=!1)}const k=p(null);return J(()=>document.addEventListener("click",b)),ge(()=>document.removeEventListener("click",b)),(m,h)=>{var I,R;return v(),c("div",{ref_key:"wrapper",ref:k,class:"relative"},[r.modelValue?(v(),c("div",Ce,[a("span",De,f(((I=r.display)==null?void 0:I.name)||"User #"+r.modelValue),1),a("span",Se,f(((R=r.display)==null?void 0:R.dept)||""),1),a("button",{onClick:j,class:"text-xs px-2 py-0.5 rounded border hover:bg-slate-50"},"Clear")])):S("",!0),F(a("input",{placeholder:r.placeholder,class:"border rounded-lg px-3 py-2 w-[28rem] max-w-full","onUpdate:modelValue":h[0]||(h[0]=D=>n.value=D),onFocus:U,onInput:C,onKeydown:E},null,40,Ue),[[Y,n.value]]),d.value?(v(),c("div",Ee,[g.value?(v(),c("div",$e,"Searching…")):(v(),c(V,{key:1},[(v(!0),c(V,null,K(y.value,(D,B)=>(v(),c("button",{key:D.id,onClick:M=>N(D),class:A(["flex w-full items-center justify-between px-3 py-2 text-left hover:bg-slate-50",B===x.value?"bg-slate-50":""])},[a("span",{innerHTML:Ne(D.name,n.value)},null,8,Ae),a("span",Ve,f(D.id||"N/A"),1)],10,Le))),128)),y.value.length?S("",!0):(v(),c("div",Te,"No results"))],64))])):S("",!0)],512)}}},je={class:"max-w-6xl mx-auto p-4 space-y-5"},Ie={class:"sticky top-0 z-20 bg-white rounded-md backdrop-blur border-b -mx-4 px-4"},Re={class:"flex flex-col gap-3 py-3"},Be={class:"flex items-center justify-between gap-3"},Oe={class:"text-xs text-slate-600 flex items-center gap-3"},Pe={key:0,class:"inline-flex items-center text-amber-700"},Fe={class:"flex items-center gap-2"},Me=["value"],ze={class:"flex flex-wrap items-center justify-between gap-3"},qe={class:"inline-flex rounded-xl border overflow-hidden"},He={class:"flex items-center gap-2"},Ge=["disabled"],Je={class:"grid md:grid-cols-2 gap-4"},Ye={key:0,class:"rounded-2xl border bg-white p-4 relative"},Qe={class:"flex items-center justify-between mb-2"},We={class:"text-xs text-slate-500"},Xe={class:"flex items-center gap-2"},Ze={key:0,class:"inline-flex items-center gap-2 bg-slate-100 text-slate-800 px-3 py-1.5 rounded-full"},et={class:"text-sm"},tt={class:"p-3 border-b"},at={class:"max-h-[18rem] overflow-auto"},st=["onClick"],lt={class:"truncate"},nt={class:"text-[11px] text-slate-500"},ot={key:1,class:"px-4 py-8 text-center text-sm text-slate-500"},rt={key:1,class:"rounded-2xl border p-4 bg-white relative"},ut={class:"flex items-center justify-between mb-2"},it={class:"text-xs text-slate-500"},dt={class:"flex items-center gap-2"},ct={key:0,class:"inline-flex items-center gap-2 bg-slate-100 text-slate-800 px-3 py-1.5 rounded-full"},vt={class:"text-sm"},pt={class:"text-xs text-slate-500"},mt={class:"p-3 border-b"},ft={class:"max-h-[18rem] overflow-auto"},yt=["onClick"],_t={class:"truncate"},gt={class:"text-[11px] text-slate-500"},ht={key:1,class:"px-4 py-8 text-center text-sm text-slate-500"},xt={class:"rounded-2xl border bg-white overflow-auto"},bt={class:"w-full text-sm"},kt={class:"px-3 py-3"},wt={class:"font-medium"},Ct={class:"text-[11px] text-slate-500"},Dt={class:"px-3 py-3"},Ut={__name:"LaneOverridesPage",setup(r){const l=we();he();const u=p(null),i=p("department"),d=p(null),n=p(null),y=p([]),g=p(!1),x=p(""),w=p([]),T=p(""),C=p([]),U=p(!1),E=p(!1),N=p(null),j=p(null),b=p(0),k=p(0),m=(e,s=300)=>{let t;return(...o)=>{clearTimeout(t),t=setTimeout(()=>e(...o),s)}};function h(e,s){const t=o=>{const _=e.value;_&&(o.target===_||_.contains(o.target)||s())};J(()=>document.addEventListener("mousedown",t)),ne(()=>document.removeEventListener("mousedown",t))}h(N,()=>{U.value=!1}),h(j,()=>{E.value=!1});const I=P(()=>y.value.length),R=P(()=>y.value.filter(e=>e.assigned_user_id).length),D=P(()=>i.value==="department"?d.value?`Department: ${d.value.name}`:"Select a department":n.value?`Employee: ${n.value.name}`:"Select an employee");J(async()=>{await l.fetchCycles(),l.cycles.length&&(u.value=l.cycles[0].id,await O()),window.addEventListener("beforeunload",B),window.addEventListener("keydown",M)}),ne(()=>{window.removeEventListener("beforeunload",B),window.removeEventListener("keydown",M)}),xe((e,s,t)=>{if(!g.value)return t();confirm("You have unsaved changes. Leave without saving?")?t():t(!1)});function B(e){g.value&&(e.preventDefault(),e.returnValue="")}function M(e){(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="s"&&(e.preventDefault(),q.value&&W())}async function O(){await l.loadCycle(u.value),y.value=(l.lanesConfig||[]).map(e=>({lane_key:e.key,label:e.label,assigned_user_id:null,assignee_name:null,assignee_dept:null})),g.value=!1,(i.value==="department"&&d.value||i.value==="employee"&&n.value)&&await z()}async function z(){const e={cycle_id:u.value,scope:i.value};i.value==="department"&&d.value&&(e.department_id=d.value.id),i.value==="employee"&&n.value&&(e.employee_id=n.value.id);const s=await l.fetchOverrides(e),t={};(s.data||[]).forEach(o=>{var _,ae,se,le;t[o.lane_key]={id:o.assigned_user_id,name:((_=o.assignee)==null?void 0:_.name)||null,dept:((se=(ae=o.assignee)==null?void 0:ae.department)==null?void 0:se.name)||(((le=o.assignee)==null?void 0:le.department_name)??null)}}),y.value=(l.lanesConfig||[]).map(o=>{const _=t[o.key]||null;return{lane_key:o.key,label:o.label,assigned_user_id:(_==null?void 0:_.id)??null,assignee_name:(_==null?void 0:_.name)??null,assignee_dept:(_==null?void 0:_.dept)??null}}),g.value=!1}function Q(e,s,t){e.assigned_user_id=s,e.assignee_name=(t==null?void 0:t.name)||null,e.assignee_dept=(t==null?void 0:t.dept)||null,g.value=!0}function ie(e){e.assigned_user_id=null,e.assignee_name=null,e.assignee_dept=null,g.value=!0}function de(){const e=y.value.find(s=>s.assigned_user_id);e&&(y.value.forEach(s=>{s.assigned_user_id||(s.assigned_user_id=e.assigned_user_id,s.assignee_name=e.assignee_name,s.assignee_dept=e.assignee_dept)}),g.value=!0)}const q=P(()=>!!u.value&&(i.value==="department"?!!d.value:!!n.value)&&g.value);async function W(){var s,t;if(!u.value)return alert("Select cycle");if(i.value==="department"&&!d.value)return alert("Select department");if(i.value==="employee"&&!n.value)return alert("Select employee");const e={cycle_id:u.value,scope:i.value,department_id:i.value==="department"?(s=d==null?void 0:d.value)==null?void 0:s.id:null,employee_id:i.value==="employee"?(t=n==null?void 0:n.value)==null?void 0:t.id:null,overrides:y.value.map(o=>({lane_key:o.lane_key,assigned_user_id:o.assigned_user_id}))};try{await l.saveOverridesBulk(e),g.value=!1,alert("Saved!")}catch(o){console.error(o),alert("Failed to save")}}const X=m(async()=>{w.value=await l.lookupDepartments(x.value),b.value=0},250),Z=m(async()=>{C.value=await l.lookupUsers(T.value),k.value=0},250);function ce(){U.value=!0,ue(()=>{const e=document.getElementById("dept-search-input");e&&e.focus()})}function ve(){E.value=!0,ue(()=>{const e=document.getElementById("user-search-input");e&&e.focus()})}function ee(e){d.value=e,U.value=!1,w.value=[],z()}function pe(){d.value=null,y.value=y.value.map(e=>({...e,assigned_user_id:null,assignee_name:null,assignee_dept:null})),g.value=!1}function te(e){n.value=e,E.value=!1,C.value=[],z()}function me(){n.value=null,y.value=y.value.map(e=>({...e,assigned_user_id:null,assignee_name:null,assignee_dept:null})),g.value=!1}function fe(e){const s=w.value.length;s&&(e.key==="ArrowDown"&&(e.preventDefault(),b.value=(b.value+1)%s),e.key==="ArrowUp"&&(e.preventDefault(),b.value=(b.value-1+s)%s),e.key==="Enter"&&(e.preventDefault(),ee(w.value[b.value])),e.key==="Escape"&&(e.preventDefault(),U.value=!1))}function ye(e){const s=C.value.length;s&&(e.key==="ArrowDown"&&(e.preventDefault(),k.value=(k.value+1)%s),e.key==="ArrowUp"&&(e.preventDefault(),k.value=(k.value-1+s)%s),e.key==="Enter"&&(e.preventDefault(),te(C.value[k.value])),e.key==="Escape"&&(e.preventDefault(),E.value=!1))}return be([i,u],()=>{d.value=null,n.value=null,O()}),(e,s)=>(v(),c("div",je,[a("header",Ie,[a("div",Re,[a("div",Be,[a("div",null,[s[9]||(s[9]=a("h1",{class:"text-lg md:text-xl font-semibold"},"KPI — Lane Overrides",-1)),a("div",Oe,[a("span",null,[s[7]||(s[7]=H("Assigned: ")),a("b",null,f(R.value),1),s[8]||(s[8]=H("/")),a("b",null,f(I.value),1)]),g.value?(v(),c("span",Pe,"• Unsaved changes")):S("",!0)])]),a("div",Fe,[F(a("select",{"onUpdate:modelValue":s[0]||(s[0]=t=>u.value=t),onChange:O,class:"border rounded-lg px-3 py-2 bg-white"},[(v(!0),c(V,null,K(L(l).cycles,t=>(v(),c("option",{value:t.id,key:t.id},f(t.title)+" ("+f(t.year)+") ",9,Me))),128))],544),[[ke,u.value]]),a("button",{onClick:O,class:"px-3 py-2 border rounded-lg hover:bg-slate-50"},"Reload")])]),a("div",ze,[a("div",qe,[a("button",{onClick:s[1]||(s[1]=t=>i.value="department"),class:A(["px-4 py-2 text-sm transition",i.value==="department"?"bg-slate-900 text-white":"bg-white hover:bg-slate-50"])},"Department",2),a("button",{onClick:s[2]||(s[2]=t=>i.value="employee"),class:A(["px-4 py-2 text-sm transition border-l",i.value==="employee"?"bg-slate-900 text-white":"bg-white hover:bg-slate-50"])},"Employee",2)]),a("div",He,[a("button",{onClick:de,class:"px-3 py-1.5 border rounded-lg hover:bg-slate-50"},"Apply to all empty lanes"),a("button",{onClick:W,disabled:!q.value,class:A(["px-4 py-2 rounded-xl text-white transition",q.value?"bg-emerald-600 hover:bg-emerald-700":"bg-slate-400 cursor-not-allowed"])}," Save (Ctrl/Cmd+S) ",10,Ge)])])])]),a("div",Je,[i.value==="department"?(v(),c("div",Ye,[a("div",Qe,[s[10]||(s[10]=a("div",{class:"text-sm font-medium"},"Target Department",-1)),a("span",We,f(D.value),1)]),a("div",Xe,[a("button",{class:"px-3 py-2 rounded-lg border hover:bg-slate-50",onClick:ce},f(d.value?"Change department":"Choose department"),1),d.value?(v(),c("div",Ze,[a("span",et,f(d.value.name),1),a("button",{onClick:pe,class:"text-xs hover:text-red-600",title:"Clear"},"✕")])):S("",!0)]),G(re,{"enter-active-class":"transition ease-out duration-150","enter-from-class":"opacity-0 translate-y-1","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition ease-in duration-100","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 translate-y-1"},{default:oe(()=>[U.value?(v(),c("div",{key:0,ref_key:"deptPopoverRef",ref:N,class:"absolute z-30 mt-2 w-full md:w-[28rem] max-h-[22rem] overflow-hidden rounded-xl border bg-white shadow-lg"},[a("div",tt,[F(a("input",{id:"dept-search-input","onUpdate:modelValue":s[3]||(s[3]=t=>x.value=t),onInput:s[4]||(s[4]=(...t)=>L(X)&&L(X)(...t)),onKeydown:fe,placeholder:"Search department…",class:"w-full border rounded-lg px-3 py-2"},null,544),[[Y,x.value]])]),a("div",at,[w.value.length?(v(!0),c(V,{key:0},K(w.value,(t,o)=>(v(),c("button",{key:t.id,onClick:_=>ee(t),class:A(["flex w-full items-center justify-between px-3 py-2 border-b last:border-b-0 text-left",o===b.value?"bg-slate-50":"hover:bg-slate-50"])},[a("span",lt,f(t.name),1),a("span",nt,"#"+f(t.id),1)],10,st))),128)):(v(),c("div",ot,"No departments found"))])],512)):S("",!0)]),_:1})])):(v(),c("div",rt,[a("div",ut,[s[11]||(s[11]=a("div",{class:"text-sm font-medium"},"Target Employee",-1)),a("span",it,f(D.value),1)]),a("div",dt,[a("button",{class:"px-3 py-2 rounded-lg border hover:bg-slate-50",onClick:ve},f(n.value?"Change employee":"Choose employee"),1),n.value?(v(),c("div",ct,[a("span",vt,[H(f(n.value.name)+" ",1),a("span",pt," — "+f(n.value.department_name||"N/A"),1)]),a("button",{onClick:me,class:"text-xs hover:text-red-600",title:"Clear"},"✕")])):S("",!0)]),G(re,{"enter-active-class":"transition ease-out duration-150","enter-from-class":"opacity-0 translate-y-1","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition ease-in duration-100","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 translate-y-1"},{default:oe(()=>[E.value?(v(),c("div",{key:0,ref_key:"userPopoverRef",ref:j,class:"absolute z-30 mt-2 w-full md:w-[32rem] max-h-[22rem] overflow-hidden rounded-xl border bg-white shadow-lg"},[a("div",mt,[F(a("input",{id:"user-search-input","onUpdate:modelValue":s[5]||(s[5]=t=>T.value=t),onInput:s[6]||(s[6]=(...t)=>L(Z)&&L(Z)(...t)),onKeydown:ye,placeholder:"Search employee…",class:"w-full border rounded-lg px-3 py-2"},null,544),[[Y,T.value]])]),a("div",ft,[C.value.length?(v(!0),c(V,{key:0},K(C.value,(t,o)=>(v(),c("button",{key:t.id,onClick:_=>te(t),class:A(["flex w-full items-center justify-between px-3 py-2 border-b last:border-b-0 text-left",o===k.value?"bg-slate-50":"hover:bg-slate-50"])},[a("span",_t,f(t.name),1),a("span",gt,f(t.department_name||"N/A"),1)],10,yt))),128)):(v(),c("div",ht,"No employees found"))])],512)):S("",!0)]),_:1})]))]),a("div",xt,[a("table",bt,[s[12]||(s[12]=a("thead",{class:"bg-slate-50"},[a("tr",null,[a("th",{class:"text-left px-3 py-2 w-[30%]"},"Lane"),a("th",{class:"text-left px-3 py-2"},"Assignee")])],-1)),a("tbody",null,[(v(!0),c(V,null,K(y.value,t=>(v(),c("tr",{key:t.lane_key,class:"border-t hover:bg-slate-50/50"},[a("td",kt,[a("div",wt,f(t.label),1),a("div",Ct,f(t.lane_key),1)]),a("td",Dt,[G(Ke,{"model-value":t.assigned_user_id,display:{name:t.assignee_name,dept:t.assignee_dept},"lane-key":t.lane_key,fetcher:o=>L(l).lookupUsers(o),placeholder:"Search user for this lane…","onUpdate:modelValue":o=>Q(t,o,{name:t.assignee_name,dept:t.assignee_dept}),"onUpdate:display":o=>Q(t,t.assigned_user_id,o),onCleared:()=>ie(t)},null,8,["model-value","display","lane-key","fetcher","onUpdate:modelValue","onUpdate:display","onCleared"])])]))),128))])])])]))}};export{Ut as default};
