import{Q as de,u as re,f as ue,D as ce,r as S,x,q as z,h as pe,A as me,c as v,o as y,a as s,t as r,d as T,l as H,v as ve,z as ye,G as _e,n as R,k as $,F as fe,e as ge,b as P,O as xe,s as W}from"./index-BL-OQlTg.js";import{L as X}from"./LoaderView-BOq1QSeR.js";import{_ as be}from"./EmployeeFilter-D8edn8Bo.js";import{u as he}from"./kpi-Q95QQIeb.js";import"./company-D8d5Xm0K.js";import"./department-CutgdQNW.js";import"./EmployeeDropdownInput-9s5tjfuW.js";import"./SelectDropdown-CFDO-xH4.js";import"./UserChip-CukIGZ7b.js";import"./user-Cu9TC-TM.js";const ke={class:"space-y-4 px-4 max-w-7xl mx-auto my-6"},Se={class:"sticky top-0 z-10 -mx-4 px-4 bg-white/80 backdrop-blur border-b"},qe={class:"flex flex-col gap-3 py-3 md:flex-row md:items-center md:justify-between"},Ne={class:"flex items-center gap-2"},Ce={class:"hidden md:flex items-center gap-2 text-xs"},Ue={class:"px-2 py-1 rounded-full bg-slate-100 text-slate-700"},ze={class:"px-2 py-1 rounded-full bg-emerald-100 text-emerald-700"},Re={class:"px-2 py-1 rounded-full bg-amber-100 text-amber-700"},$e={class:"px-2 py-1 rounded-full bg-slate-100 text-slate-700"},Pe=["disabled"],Be={class:"rounded-xl border bg-white p-4 md:p-5 shadow-sm"},Le={class:"grid gap-4 md:grid-cols-12"},Te={class:"col-span-full"},je={class:"md:col-span-4 relative"},Ae=["placeholder","disabled"],De={class:"md:col-span-3 relative"},Ve={class:"md:col-span-1 relative"},Ee={class:"md:col-span-2 flex items-end justify-end gap-2"},Fe=["disabled"],Oe={key:0,class:"py-8 text-center"},Ie={key:1,class:"rounded-md border border-red-200 bg-red-50 p-3 text-red-700"},Ke={key:2,class:"relative overflow-x-auto rounded-xl border bg-white shadow-sm"},Me={key:0,class:"absolute inset-0 grid place-items-center bg-white/50 backdrop-blur-[1px] z-10","aria-live":"polite","aria-busy":"true"},Ge={class:"min-w-full text-sm"},Je={class:"px-3 py-2"},Qe={class:"px-3 py-2"},Ye={class:"flex items-center gap-3"},He={class:"h-8 w-8 rounded-full bg-slate-200 grid place-items-center text-xs font-medium text-slate-700"},We={class:"font-medium text-slate-900"},Xe={class:"text-[11px] text-slate-500"},Ze={key:0,class:"mx-1"},we={key:1},et={class:"px-3 py-2"},tt={class:"text-xs text-slate-700"},st={class:"px-3 py-2"},at={class:"flex items-center gap-3"},lt={class:"w-full max-w-[260px]"},nt={class:"h-2 rounded-full bg-slate-200 overflow-hidden"},it={class:"mt-1 text-[11px] text-slate-600"},ot={class:"px-3 py-2"},dt={class:"px-3 py-2"},rt={class:"flex flex-col gap-1"},ut={class:"px-3 py-2 text-right"},ct={class:"flex items-center justify-end gap-2"},pt=["onClick"],mt={key:0},vt={colspan:"6",class:"px-3 py-6 text-center text-gray-600"},Ct={__name:"YearlyEvaluationList",setup(yt){const j=de(),A=re(),u=ue(),D=he(),{users:q,loading:Z,error:V,usersError:E}=ce(D),l=S({company_id:u.query.company_id?Number(u.query.company_id):"",department_id:u.query.department_id?Number(u.query.department_id):"",employee_id:u.query.employee_id?Number(u.query.employee_id):"",line_type:u.query.line_type??"",user_id:u.query.user_id?Number(u.query.user_id):"",finalized:u.query.finalized??"",q:u.query.q??""}),c=S(u.query.sortBy||"name"),_=S(u.query.sortDir||"asc");let F=null,B=0,O="";const L=S(!1),I=S([]),p=x(()=>!!l.value.company_id&&!!l.value.department_id),w=x(()=>p.value||l.value.finalized!==""||!!l.value.line_type||!!l.value.q),ee=x(()=>Z.value),b=x(()=>p.value?Array.isArray(q.value)?q.value:[]:I.value);function m(a){var f;const e=(f=a==null?void 0:a.kpi)==null?void 0:f.progress,t=Number((e==null?void 0:e.total_lanes)??0),n=Number((e==null?void 0:e.submitted_lanes)??0),i=Number((e==null?void 0:e.pending_lanes)??Math.max(0,t-n)),d=String((e==null?void 0:e.stage)??(t?"not_started":"n/a")),o=t>0?Math.round(n/t*100):0;return{total:t,submitted:n,pending:i,stage:d,percent:o}}function K(a){return a==="completed"?0:a==="in_progress"?1:a==="not_started"?2:3}function M(a){const{stage:e,submitted:t,total:n}=m(a);return e==="completed"?{label:`Completed (${t}/${n})`,cls:"bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200"}:e==="in_progress"?{label:`In progress (${t}/${n})`,cls:"bg-amber-100 text-amber-700 ring-1 ring-amber-200"}:e==="not_started"?{label:"Not started",cls:"bg-slate-100 text-slate-700 ring-1 ring-slate-200"}:{label:"N/A",cls:"bg-slate-100 text-slate-700 ring-1 ring-slate-200"}}function G(a){var d;const e=((d=a==null?void 0:a.kpi)==null?void 0:d.latest_review)??{},t=String((e==null?void 0:e.reviewer_lane)??"").trim();if(!t)return{label:"Not completed yet",detail:"No reviewer lane has finished",cls:"border-slate-200 bg-slate-50 text-slate-500"};const n=e!=null&&e.stage?String(e.stage):"",i=n?n.split("_").map(o=>{var f;return o?((f=o[0])==null?void 0:f.toUpperCase())+o.slice(1):""}).filter(Boolean).join(" "):"";return{label:t,detail:i?`Stage: ${i}`:"Latest completed lane",cls:"border-emerald-200 bg-emerald-50 text-emerald-700"}}function J(a){var i;const e=(i=a==null?void 0:a.kpi)==null?void 0:i.cycle;if(!(e!=null&&e.id))return"—";const t=e!=null&&e.year?String(e.year):"",n=e!=null&&e.slug?String(e.slug):"";return[t,n].filter(Boolean).join(" • ")||`#${e.id}`}const N=x(()=>{let a=b.value.length,e=0,t=0,n=0,i=0;for(const d of b.value){const o=m(d).stage;o==="completed"?e++:o==="in_progress"?t++:o==="not_started"?n++:i++}return{total:a,completed:e,inProgress:t,notStarted:n,na:i}}),h=x(()=>{const a=[...b.value],e=_.value==="desc"?-1:1,t=c.value,n=i=>{const{total:d,submitted:o}=m(i);return d<=0?-1/0:o/d};return a.sort((i,d)=>{if(t==="progress"){const C=n(i),U=n(d);return(C>U?1:C<U?-1:0)*e}if(t==="stage")return(K(m(i).stage)-K(m(d).stage))*e;const o=String((i==null?void 0:i.name)??""),f=String((d==null?void 0:d.name)??"");return o.localeCompare(f)*e}),a});function g(){A.replace({query:{company_id:l.value.company_id||void 0,department_id:l.value.department_id||void 0,line_type:l.value.line_type||void 0,user_id:l.value.user_id||void 0,employee_id:l.value.employee_id||void 0,finalized:l.value.finalized||void 0,q:l.value.q||void 0,sortBy:c.value!=="name"?c.value:void 0,sortDir:_.value!=="asc"?_.value:void 0}}).catch(()=>{})}function te(){clearTimeout(F),F=setTimeout(()=>{p.value&&g()},350)}z(()=>u.fullPath,async()=>{const a=u.query;l.value.company_id=a.company_id?Number(a.company_id):"",l.value.department_id=a.department_id?Number(a.department_id):"",l.value.employee_id=a.employee_id?Number(a.employee_id):"",l.value.user_id=a.user_id?Number(a.user_id):"",l.value.line_type=a.line_type??"",l.value.finalized=a.finalized??"",l.value.q=a.q??"",c.value=a.sortBy||"name",_.value=a.sortDir||"asc",p.value&&await Q()});function se(){return{company_id:l.value.company_id,department_id:l.value.department_id||void 0,employee_id:l.value.employee_id||void 0,user_id:l.value.user_id||void 0,line_type:l.value.line_type||void 0,finalized:l.value.finalized,q:l.value.q||void 0}}async function Q(){const a=se(),e=JSON.stringify(a);if(e===O)return;O=e;const t=++B;L.value=b.value.length>0;try{const n=await D.fetchUsers(a);if(t!==B)return;const i=Array.isArray(n)?n:Array.isArray(q.value)?q.value:[];I.value=[...i]}catch(n){console.error(n),j.error("Failed to load users.")}finally{t===B&&(L.value=!1)}}function ae(){l.value.user_id=l.value.employee_id||"",g()}function le(){if(!p.value)return j.error("Select Company & Department");g()}function ne(){l.value={company_id:"",department_id:"",employee_id:"",line_type:"",user_id:"",finalized:"",q:""},c.value="name",_.value="asc",g()}function Y(a){c.value===a?_.value=_.value==="asc"?"desc":"asc":(c.value=a,_.value="asc"),g()}function ie(a){const e=a==null?void 0:a.id;e&&A.push({name:"KpiReview",params:{employeeId:e}})}function oe(){if(!h.value.length)return;const a=["#","User","Cycle","Submitted","Total","Pending","Stage","Progress%"],e=h.value.map((o,f)=>{const C=(o==null?void 0:o.name)??`#${o==null?void 0:o.id}`,U=J(o),k=m(o);return[f+1,`"${C.replace(/"/g,'""')}"`,`"${String(U).replace(/"/g,'""')}"`,k.submitted,k.total,k.pending,k.stage,k.percent].join(",")}),t=[a.join(","),...e].join(`
`),n=new Blob([t],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(n),d=document.createElement("a");d.href=i,d.download="kpi-progress.csv",d.click(),URL.revokeObjectURL(i)}return z(()=>l.value.employee_id,a=>{l.value.user_id=a||""}),z(()=>l.value.q,()=>{p.value&&te()}),z(()=>[l.value.finalized,l.value.line_type],()=>{p.value&&g()}),pe(async()=>{await me(),p.value&&await Q()}),(a,e)=>(y(),v("div",ke,[s("div",Se,[s("div",qe,[e[8]||(e[8]=s("div",null,[s("h1",{class:"text-lg md:text-xl font-semibold"},"User KPI Progress"),s("p",{class:"text-xs text-slate-600 mt-0.5"},"Select company/department to see progress stage per user.")],-1)),s("div",Ne,[s("div",Ce,[s("span",Ue,"Total: "+r(N.value.total),1),s("span",ze,"Completed: "+r(N.value.completed),1),s("span",Re,"In progress: "+r(N.value.inProgress),1),s("span",$e,"Not started: "+r(N.value.notStarted),1)]),s("button",{class:"h-9 rounded-md border border-slate-300 px-3 text-xs md:text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-50",disabled:!h.value.length,onClick:oe}," Export CSV ",8,Pe)])])]),s("div",Be,[s("div",Le,[s("div",Te,[e[9]||(e[9]=s("label",{class:"mb-1 block text-sm font-medium text-slate-700"},"Employee scope",-1)),T(be,{company_id:l.value.company_id,"onUpdate:company_id":e[0]||(e[0]=t=>l.value.company_id=t),department_id:l.value.department_id,"onUpdate:department_id":e[1]||(e[1]=t=>l.value.department_id=t),employee_id:l.value.employee_id,"onUpdate:employee_id":e[2]||(e[2]=t=>l.value.employee_id=t),line_type:l.value.line_type,"onUpdate:line_type":e[3]||(e[3]=t=>l.value.line_type=t),"with-type":!0,"initial-value":{...a.$route.query},onFilterChange:ae,class:"w-full"},null,8,["company_id","department_id","employee_id","line_type","initial-value"]),e[10]||(e[10]=s("p",{class:"mt-1 text-[11px] text-slate-500"},"Reset করলে আগের data দেখাবে যতক্ষণ না নতুন scope select করো।",-1))]),s("div",je,[e[11]||(e[11]=s("label",{class:"top-label"},"Search",-1)),H(s("input",{"onUpdate:modelValue":e[4]||(e[4]=t=>l.value.q=t),onKeyup:ye(le,["enter"]),placeholder:p.value?"Search name, type…":"Select company & department first",class:"h-9 w-full rounded-md border border-slate-300 px-3 text-sm disabled:bg-slate-100",disabled:!p.value},null,40,Ae),[[ve,l.value.q,void 0,{trim:!0}]])]),s("div",De,[e[13]||(e[13]=s("label",{class:"top-label"},"Sort by",-1)),H(s("select",{class:"h-9 w-full rounded-md border border-slate-300 px-2 text-sm","onUpdate:modelValue":e[5]||(e[5]=t=>c.value=t),onChange:e[6]||(e[6]=t=>Y(c.value))},e[12]||(e[12]=[s("option",{value:"name"},"Name",-1),s("option",{value:"progress"},"Progress",-1),s("option",{value:"stage"},"Stage",-1)]),544),[[_e,c.value]])]),s("div",Ve,[e[14]||(e[14]=s("label",{class:"top-label"},"Order",-1)),s("button",{class:"h-9 w-full rounded-md border border-slate-300 text-sm hover:bg-slate-50",onClick:e[7]||(e[7]=t=>Y(c.value))},r(_.value==="asc"?"Asc":"Desc"),1)]),s("div",Ee,[s("button",{class:"h-9 rounded-md border border-slate-300 px-3 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-50",disabled:!w.value,onClick:ne}," Reset ",8,Fe)])])]),ee.value&&!b.value.length?(y(),v("div",Oe,[T(X)])):R(E)||R(V)?(y(),v("div",Ie,r(R(E)||R(V)),1)):(y(),v("div",Ke,[L.value?(y(),v("div",Me,[T(X)])):$("",!0),s("table",Ge,[e[17]||(e[17]=s("thead",{class:"sticky top-0 bg-gray-100"},[s("tr",{class:"text-left text-gray-700"},[s("th",{class:"px-3 py-2 w-12"},"#"),s("th",{class:"px-3 py-2"},"User"),s("th",{class:"px-3 py-2"},"Cycle"),s("th",{class:"px-3 py-2 w-[340px]"},"Progress"),s("th",{class:"px-3 py-2"},"Stage"),s("th",{class:"px-3 py-2"},"Completed Stage"),s("th",{class:"px-3 py-2 text-right w-40"},"Actions")])],-1)),s("tbody",null,[(y(!0),v(fe,null,ge(h.value,(t,n)=>{var i;return y(),v("tr",{key:t.id,class:"border-t hover:bg-slate-50/50"},[s("td",Je,r(n+1),1),s("td",Qe,[s("div",Ye,[s("div",He,r(((t==null?void 0:t.name)||"#").slice(0,1).toUpperCase()),1),s("div",null,[s("div",We,r((t==null?void 0:t.name)??"#"+t.id),1),s("div",Xe,[P(r(((i=t==null?void 0:t.department)==null?void 0:i.name)||"—")+" ",1),t!=null&&t.type?(y(),v("span",Ze,"•")):$("",!0),t!=null&&t.type?(y(),v("span",we,r(t.type),1)):$("",!0)])])])]),s("td",et,[s("span",tt,r(J(t)),1)]),s("td",st,[s("div",at,[s("div",lt,[s("div",nt,[s("div",{class:"h-2 rounded-full bg-slate-700",style:xe({width:(m(t).percent||0)+"%"})},null,4)]),s("div",it,[P(r(m(t).submitted)+" / "+r(m(t).total)+" ",1),e[15]||(e[15]=s("span",{class:"mx-1"},"•",-1)),P(" Pending: "+r(m(t).pending)+" ",1),e[16]||(e[16]=s("span",{class:"mx-1"},"•",-1)),P(" "+r(m(t).percent)+"% ",1)])])])]),s("td",ot,[s("span",{class:W(["inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium",M(t).cls])},r(M(t).label),3)]),s("td",dt,[s("div",rt,[s("span",{class:W(["inline-flex items-center rounded-full px-3 py-1 text-xs font-medium ring-1 ring-inset",G(t).cls])},r(G(t).label),3)])]),s("td",ut,[s("div",ct,[s("button",{class:"h-9 px-3 rounded-md border border-slate-300 text-sm hover:bg-slate-50",onClick:d=>ie(t)}," Open ",8,pt)])])])}),128)),h.value.length?$("",!0):(y(),v("tr",mt,[s("td",vt,r(p.value?"No users found for this scope.":"Select company & department to see users."),1)]))])])]))]))}};export{Ct as default};
