import{B as Z,r as x,x as i,C as q,f as ee,u as te,h as se,q as ae,c as l,o as n,a as t,k as _,t as u,d as oe,F as M,e as B,i as re}from"./index-9P-p50Eq.js";import{_ as le}from"./EmployeeFilter-CApyhe4B.js";import"./company-DmOZ7OWz.js";import"./department-yeNxoq9p.js";import"./EmployeeDropdownInput-CUlH_F7G.js";import"./SelectDropdown-9SVXVpNT.js";import"./UserChip-CAud_YYc.js";import"./user-C34LOgby.js";const Q="organogram_filters_v1",ne=r=>Array.isArray(r)?r:Array.isArray(r==null?void 0:r.data)?r.data:[],Y=r=>{const s=Number(r);return Number.isFinite(s)&&s>0?s:null},H=r=>{const s=r.cycle_slug==="support_staff"?"support_staff":"executives";return{company_id:Y(r.company_id),cycle_slug:s,department_id:Y(r.department_id)}},ie=Z("organogram",()=>{const r=x(H({cycle_slug:"executives"})),s=x([]),N=x(!1),b=x(null),f=x([]),C=x(!1),F=x(null),h=x(!0),w=x(!1),O=i(()=>r.value),R=i(()=>s.value),E=i(()=>N.value),A=i(()=>b.value),U=i(()=>f.value),L=(d,{persist:c=!0}={})=>{const m={...r.value,...d};r.value=H(m),c&&k()},k=()=>{localStorage.setItem(Q,JSON.stringify(r.value))},D=()=>{const d=localStorage.getItem(Q);if(d)try{const c=JSON.parse(d);L(c,{persist:!1})}catch(c){console.warn("Failed to parse organogram filters:",c)}},j=async()=>{var c,m;C.value=!0,F.value=null,h.value=!0,f.value=[];const d=async p=>{try{const g=await q.get(p),a=ne(g.data);return a.length>0?(f.value=a,{ok:!0,hasData:!0}):{ok:!0,hasData:!1}}catch(g){return{ok:!1,error:g}}};try{const p=await d("/companies");if(p.ok&&p.hasData)return;const g=await d("/hrm/companies");if(g.ok&&g.hasData)return;h.value=!1,F.value="No companies available. Enter a company id."}catch(p){h.value=!1,F.value=((m=(c=p.response)==null?void 0:c.data)==null?void 0:m.message)||"Unable to load companies from the server."}finally{C.value=!1}},I=async()=>{var d,c,m,p,g;if(!r.value.company_id){s.value=[],b.value="Select a company to load organogram data.";return}N.value=!0,b.value=null;try{const a={company_id:r.value.company_id,cycle_slug:r.value.cycle_slug};r.value.department_id&&(a.department_id=r.value.department_id);const e=await q.get("/hrm/organograms",{params:a});s.value=((d=e.data)==null?void 0:d.departments)||((m=(c=e.data)==null?void 0:c.data)==null?void 0:m.departments)||[]}catch(a){s.value=[],b.value=((g=(p=a.response)==null?void 0:p.data)==null?void 0:g.message)||"Failed to load organogram data."}finally{N.value=!1}},S=async()=>{var d,c;if(!r.value.company_id)return b.value="Select a company before exporting.",!1;w.value=!0;try{const m={company_id:r.value.company_id,cycle_slug:r.value.cycle_slug};r.value.department_id&&(m.department_id=r.value.department_id);const p=await q.get("/hrm/organograms/export",{params:m,responseType:"blob"}),a=(p.headers["content-disposition"]||"").match(/filename\*=UTF-8''(.+)|filename="?([^";]+)"?/i),e=decodeURIComponent((a==null?void 0:a[1])||(a==null?void 0:a[2])||"organogram.xlsx"),o=new Blob([p.data],{type:p.headers["content-type"]||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),v=window.URL.createObjectURL(o),y=document.createElement("a");return y.href=v,y.download=e,document.body.appendChild(y),y.click(),y.remove(),window.URL.revokeObjectURL(v),!0}catch(m){return b.value=((c=(d=m.response)==null?void 0:d.data)==null?void 0:c.message)||"Failed to export organogram.",!1}finally{w.value=!1}};return{filters:O,departments:R,loading:E,error:A,companies:U,companiesLoading:i(()=>C.value),companiesError:i(()=>F.value),companiesAvailable:i(()=>h.value),exporting:i(()=>w.value),setFilters:L,hydrateFilters:D,fetchCompanies:j,fetchOrganogram:I,exportExcel:S}}),de={class:"min-h-screen bg-slate-50 px-4 py-6 md:px-6"},ce={class:"sticky top-0 z-30 space-y-4 bg-slate-50/80 pb-3 backdrop-blur"},pe={class:"rounded-2xl border border-slate-200 bg-white shadow-sm"},ue={class:"flex flex-col gap-4 border-b border-slate-100 p-5 md:flex-row md:items-center md:justify-between"},me={class:"flex w-full gap-2 md:w-auto"},ge=["disabled"],xe=["disabled"],ye={class:"p-4"},be={key:0,class:"flex flex-wrap items-center gap-2 px-4 pb-4"},fe={class:"rounded-full bg-slate-900 px-3 py-1 text-xs font-semibold text-white"},ve={key:0,class:"rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700"},_e={key:0,class:"flex items-center justify-between rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700"},he={key:0,class:"mt-4 grid gap-4 md:grid-cols-2 xl:grid-cols-3"},we={key:1,class:"mt-6 rounded-2xl border border-dashed border-slate-200 bg-white p-8 text-center"},ke={key:2,class:"mt-6 rounded-2xl border border-dashed border-slate-200 bg-white p-8 text-center"},Ce={key:3,class:"mt-4 grid gap-4 md:grid-cols-2 xl:grid-cols-3"},Fe={class:"flex items-start justify-between gap-3"},Ne={class:"text-base font-semibold text-slate-900"},Le={class:"rounded-full bg-sky-50 px-3 py-1 text-xs font-semibold text-sky-700"},De={class:"mt-4 grid gap-2 sm:grid-cols-2"},Se={key:0,class:"rounded-lg border border-slate-100 bg-slate-50 px-3 py-2 text-xs"},Oe={class:"block font-semibold text-slate-900"},Re={key:1,class:"rounded-lg border border-slate-100 bg-slate-50 px-3 py-2 text-xs"},Ee={class:"block font-semibold text-slate-900"},Ae={key:2,class:"rounded-lg border border-slate-100 bg-slate-50 px-3 py-2 text-xs"},Ue={class:"block font-semibold text-slate-900"},je={key:3,class:"rounded-lg border border-slate-100 bg-slate-50 px-3 py-2 text-xs"},Ie={class:"block font-semibold text-slate-900"},qe={class:"mt-4 overflow-x-auto rounded-xl border border-slate-100"},Me={class:"min-w-full text-left text-xs"},Be={class:"divide-y divide-slate-100"},Te={class:"px-3 py-2 text-slate-500"},Pe={class:"px-3 py-2 font-semibold text-slate-900"},Ve={class:"block max-w-[160px] break-words"},ze={class:"px-3 py-2"},Je={class:"block max-w-[160px] break-words text-slate-700"},$e={key:0},tt={__name:"OrganogramList",setup(r){const s=ie(),N=ee(),b=te(),f=x(""),C=x(!1),F=[1,2,3],h=x(""),w=i(()=>s.loading),O=i(()=>s.error),R=i(()=>s.exporting),E=i({get:()=>s.filters.company_id??"",set:a=>{s.setFilters({company_id:a,department_id:null})}}),A=i({get:()=>s.filters.cycle_slug==="support_staff"?"support_staff":"executive",set:a=>{const e=a==="support_staff"?"support_staff":"executives";s.setFilters({cycle_slug:e})}}),U=i(()=>s.filters.cycle_slug==="support_staff"?"Staff":"Executives"),L=i({get:()=>s.filters.department_id??"",set:a=>{s.setFilters({department_id:a})}}),k=i(()=>!!s.filters.company_id),D=i(()=>{const a=f.value.trim().toLowerCase();return s.departments.map(e=>{var V,z,J,$,G;const o=Array.isArray(e.members)?e.members:[],v=((z=(V=e.director)==null?void 0:V.name)==null?void 0:z.toLowerCase())||"",y=(($=(J=e.incharge)==null?void 0:J.name)==null?void 0:$.toLowerCase())||"",W=((G=e.department_name)==null?void 0:G.toLowerCase())||"",T=a&&(W.includes(a)||v.includes(a)||y.includes(a)),P=a?o.filter(X=>{var K;return(K=X.name)==null?void 0:K.toLowerCase().includes(a)}):o;return{...e,members:o,displayMembers:T?o:P,matches:T||P.length>0}}).filter(e=>e.members.length>0&&(a?e.matches:!0))}),j=()=>{const a={};return s.filters.company_id&&(a.company_id=s.filters.company_id),s.filters.cycle_slug&&(a.cycle_slug=s.filters.cycle_slug),s.filters.department_id&&(a.department_id=s.filters.department_id),a},I=()=>{const{company_id:a,cycle_slug:e,department_id:o}=N.query;(a||e||o)&&s.setFilters({company_id:a,cycle_slug:e,department_id:o})},S=async()=>{await b.replace({query:j()})},d=async()=>{k.value&&await s.fetchOrganogram()},c=async()=>{await s.exportExcel()},m=()=>{S()},p=()=>{s.setFilters({department_id:null})},g=()=>{f.value=""};return se(async()=>{s.hydrateFilters(),I(),await s.fetchCompanies(),!s.filters.company_id&&s.companies.length>0&&s.setFilters({company_id:s.companies[0].id}),s.filters.company_id&&await s.fetchOrganogram(),C.value=!0,await S()}),ae(()=>[s.filters.company_id,s.filters.cycle_slug,s.filters.department_id],async()=>{C.value&&(await S(),s.filters.company_id&&await s.fetchOrganogram())}),(a,e)=>(n(),l("section",de,[t("div",ce,[t("div",pe,[t("div",ue,[e[4]||(e[4]=t("div",null,[t("h1",{class:"text-xl font-semibold text-slate-900"},"Organogram"),t("p",{class:"text-sm text-slate-500"}," Department-wise structure and reporting lines for the selected company. ")],-1)),t("div",me,[t("button",{type:"button",class:"inline-flex flex-1 items-center justify-center rounded-lg border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-60 md:flex-none",onClick:d,disabled:w.value||!k.value},u(w.value?"Loading...":"Refresh"),9,ge),t("button",{type:"button",class:"inline-flex flex-1 items-center justify-center rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-60 md:flex-none",onClick:c,disabled:R.value||!k.value},u(R.value?"Exporting...":"Export Excel"),9,xe)])]),t("div",ye,[oe(le,{company_id:E.value,"onUpdate:company_id":e[0]||(e[0]=o=>E.value=o),department_id:L.value,"onUpdate:department_id":e[1]||(e[1]=o=>L.value=o),line_type:A.value,"onUpdate:line_type":e[2]||(e[2]=o=>A.value=o),employee_id:h.value,"onUpdate:employee_id":e[3]||(e[3]=o=>h.value=o),"with-type":!0,"initial-value":a.$route.query,onFilterChange:m},null,8,["company_id","department_id","line_type","employee_id","initial-value"])]),k.value?(n(),l("div",be,[t("span",fe,u(U.value)+" · "+u(D.value.length)+" Departments ",1),f.value?(n(),l("span",ve,' Search: "'+u(f.value)+'" ',1)):_("",!0)])):_("",!0)]),O.value?(n(),l("div",_e,[t("span",null,u(O.value),1),t("button",{type:"button",class:"rounded-md border border-rose-200 bg-white px-3 py-1.5 text-xs font-semibold",onClick:d}," Retry ")])):_("",!0)]),w.value?(n(),l("div",he,[(n(),l(M,null,B(F,o=>t("article",{key:o,class:"animate-pulse rounded-2xl border border-slate-200 bg-white p-5"},e[5]||(e[5]=[re('<div class="h-5 w-1/2 rounded bg-slate-200"></div><div class="mt-2 h-3 w-1/3 rounded bg-slate-100"></div><div class="mt-4 space-y-2"><div class="h-8 rounded bg-slate-100"></div><div class="h-8 rounded bg-slate-100"></div></div><div class="mt-4 space-y-2"><div class="h-3 w-full rounded bg-slate-100"></div><div class="h-3 w-5/6 rounded bg-slate-100"></div><div class="h-3 w-2/3 rounded bg-slate-100"></div></div>',4)]))),64))])):k.value?D.value.length===0?(n(),l("div",ke,[e[7]||(e[7]=t("h3",{class:"text-lg font-semibold text-slate-900"},"No organogram data found",-1)),e[8]||(e[8]=t("p",{class:"mt-2 text-sm text-slate-500"},"Try adjusting the department filter or clearing the search.",-1)),t("div",{class:"mt-4 flex flex-wrap items-center justify-center gap-2"},[t("button",{type:"button",class:"rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold",onClick:g}," Clear Search "),t("button",{type:"button",class:"rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold",onClick:p}," All Departments "),t("button",{type:"button",class:"rounded-lg bg-slate-900 px-3 py-2 text-xs font-semibold text-white",onClick:d}," Refresh ")])])):(n(),l("div",Ce,[(n(!0),l(M,null,B(D.value,o=>(n(),l("article",{key:o.department_id,class:"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm transition hover:shadow-md"},[t("header",Fe,[t("div",null,[t("h3",Ne,u(o.department_name),1),e[9]||(e[9]=t("p",{class:"mt-1 text-xs text-slate-500"},"Department Overview",-1))]),t("span",Le,u(o.members.length)+" Members ",1)]),t("div",De,[o.director?(n(),l("div",Se,[e[10]||(e[10]=t("span",{class:"block text-[10px] font-semibold uppercase tracking-wide text-slate-500"},"Director",-1)),t("span",Oe,u(o.director.name),1)])):_("",!0),o.coordinator?(n(),l("div",Re,[e[11]||(e[11]=t("span",{class:"block text-[10px] font-semibold uppercase tracking-wide text-slate-500"},"Coordinator",-1)),t("span",Ee,u(o.coordinator.name),1)])):_("",!0),o.incharge?(n(),l("div",Ae,[e[12]||(e[12]=t("span",{class:"block text-[10px] font-semibold uppercase tracking-wide text-slate-500"},"Incharge",-1)),t("span",Ue,u(o.incharge.name),1)])):_("",!0),o.op_admin?(n(),l("div",je,[e[13]||(e[13]=t("span",{class:"block text-[10px] font-semibold uppercase tracking-wide text-slate-500"},"Op Admin",-1)),t("span",Ie,u(o.op_admin.name),1)])):_("",!0)]),t("div",qe,[t("table",Me,[e[15]||(e[15]=t("thead",{class:"bg-slate-50 text-[10px] uppercase tracking-wide text-slate-500"},[t("tr",null,[t("th",{class:"px-3 py-2"},"#"),t("th",{class:"px-3 py-2"},"Name"),t("th",{class:"px-3 py-2"},"Designation")])],-1)),t("tbody",Be,[(n(!0),l(M,null,B(o.displayMembers,(v,y)=>(n(),l("tr",{key:v.id,class:"text-slate-700"},[t("td",Te,u(y+1),1),t("td",Pe,[t("span",Ve,u(v.name),1)]),t("td",ze,[t("span",Je,u(v.designation_title||"—"),1)])]))),128)),o.displayMembers.length===0?(n(),l("tr",$e,e[14]||(e[14]=[t("td",{colspan:"5",class:"px-3 py-4 text-center text-xs text-slate-400"}," No members match this search. ",-1)]))):_("",!0)])])])]))),128))])):(n(),l("div",we,e[6]||(e[6]=[t("h3",{class:"text-lg font-semibold text-slate-900"},"Select a company to view organogram",-1),t("p",{class:"mt-2 text-sm text-slate-500"},"Choose a company to load department-wise organogram data.",-1)])))]))}};export{tt as default};
