import{L as ut}from"./LoaderView-HV2j_91p.js";import{O as j}from"./OverlyModal-DvKZLb7T.js";import{_ as et}from"./DepartmentChip-DCU4MPuH.js";import{b as mt,_ as ct}from"./TaskTableRow-CEw_A_Ki.js";import{_ as pt}from"./TaskAddForm-G2bX6ZWF.js";import{_ as kt}from"./TaskEditForm-DHDQVREV.js";import{_ as yt}from"./TaskHeader-CAJqFOWX.js";import{a as ft}from"./TaskUserAssignForm-Dw_rkPfm.js";import{f as ot,g as nt,x as H,p as _t,c as r,o,k,a as s,F as R,e as F,s as Q,j as $,t as A,m as z,b as K,w as gt,n as c,u as vt,r as V,G as J,h as ht,q as st,d as v,N as xt}from"./index-Dd37oRPB.js";import{u as bt}from"./task-priority-BG2bu1A7.js";import{u as wt}from"./useRequirementStore-JfoWY1Se.js";import{u as Tt}from"./useTaskStore-Bjn1rdun.js";import"./datetime-Du_mcDA9.js";import"./TaskUrgentBadge-D52_F6jZ.js";import"./TaskTitle-C2OlaDvQ.js";import"./TaskAssignedUsers-ChE1tIct.js";import"./UserChip-Cj7gj4fc.js";import"./user-CUsMlcV0.js";import"./TaskIsClosedBadge-C6d319cs.js";import"./RequiredIcon-CcBjee43.js";import"./company-D6mBZvtW.js";import"./requirement-DGs3iDa5.js";import"./CompanyDepartmentSelectInput-DVcsI1Xi.js";import"./SelectDropdown-BfrvBdyv.js";import"./SectionLoading-XLTjiQl2.js";import"./TextEditor-9nACtX-E.js";import"./TextWithHr-Dq16o6h4.js";import"./TaskUrgencyInput-BKJBIJGe.js";import"./tags-yK9NVgv7.js";import"./task-BTygOQ5v.js";import"./url-Buz9GlSr.js";import"./EmployeeDropdownInput-CNBiluhJ.js";import"./SearchInput-BlC7zuJx.js";import"./DraggableList.vue_vue_type_script_setup_true_lang-BCNgxnrT.js";const Ct={class:"w-full p-1"},Lt={key:0,class:"w-full rounded-b"},At={class:"group/dept"},$t={class:"flex gap-1 items-center text-base"},It={class:"font-bold text-lime-600"},Rt={key:0},qt=["onClick"],St={class:"ml-auto"},Bt=["onClick"],at={__name:"TaskTable",props:{tasks:{type:Array,required:!0,default:()=>[]},hideButtons:{type:Boolean,default:!1},parentTreeLevel:{type:Number},maxItem:{Number,default:5},isMyTask:{type:Boolean,default:!1},taskLinkTo:{type:Function,default:null}},emits:["editClick","addClick","employeeAssignClick","clickAddClick","clickAttachment"],setup(q,{emit:y}){const U=q,d=ot(),S=nt(),_=H(()=>U.tasks.reduce((h,n)=>{var x;const p=((x=n.requirement)==null?void 0:x.id)||"-",u=[...h],e=u.find(C=>(C==null?void 0:C.key)==p);return e?e.tasks=[...e.tasks,n]:u.push({key:p,position:n!=null&&n.requirement?0:1,...(n==null?void 0:n.requirement)||{title:"(Other tasks)",id:0},tasks:[n]}),u},[]).sort((h,n)=>h.position-n.position)),f=y;return(h,n)=>{var u;const p=_t("RouterLink");return o(),r("div",Ct,[((u=q.tasks)==null?void 0:u.length)>0?(o(),r("table",Lt,[n[4]||(n[4]=s("thead",null,[s("tr",null,[s("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 w-[30px] sticky -top-4 z-20"}," SL "),s("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Task "),s("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Assign Person "),s("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 sticky -top-4 z-20 px-2 whitespace-nowrap"}," Deadline "),s("td",{class:"border text-center text-xs text-gray-400 bg-gray-50/80 -top-4 z-20 sticky right-0 border-l bg-sky-50 px-2 whitespace-nowrap"}," Status ")])],-1)),s("tbody",null,[(o(!0),r(R,null,F(_.value,(e,x)=>{var C,E,B,N,M,b;return o(),r(R,{key:e.id},[s("tr",At,[s("th",{colspan:"10",class:Q(["font-semibold",[(x>0,"")]])},[s("div",{class:Q(["text-left -mx-[2px] -mb-[1px] py-2 px-2 flex items-center border border-b-0 rounded-t bg-emerald-50",[e.id===0?"text-gray-500":"text-sky-800",x>0?"mt-4":""]])},[s("div",$t,[s("div",It,A(x+1)+".",1),e.id===0?(o(),r("p",Rt,A(e.title),1)):(o(),$(p,{key:1,to:`requirements/show/${e.id}`,class:"line-clamp-2 hover:underline"},{default:z(()=>[K(A(e.title),1)]),_:2},1032,["to"])),((C=e.attachments)==null?void 0:C.length)>0?(o(),r("button",{key:2,class:"text-sky-400 text-sm",onClick:gt(w=>f("clickAttachment",e.attachments),["prevent"])},[n[2]||(n[2]=s("i",{class:"fas fa-paperclip"},null,-1)),K(" "+A((E=e.attachments)==null?void 0:E.length)+" Attachment"+A(((B=e.attachments)==null?void 0:B.length)>1?"s":""),1)],8,qt)):k("",!0)]),s("div",St,[((N=c(d))==null?void 0:N.name)=="RequirementTaskList"&&((b=(M=c(S))==null?void 0:M.user)==null?void 0:b.department_id)==(e==null?void 0:e.to_department_id)?(o(),r("button",{key:0,onClick:w=>f("clickAddTask",{requirement_id:e==null?void 0:e.id,from_department_id:e==null?void 0:e.from_department_id,to_department_id:e==null?void 0:e.to_department_id},{requirement_id:!0,from_department_id:!0,to_department_id:!0}),class:"btn-2 whitespace-nowrap h-6 px-3 opacity-70 group-hover/dept:opacity-100"},n[3]||(n[3]=[s("i",{class:"fas fa-plus-circle"},null,-1),K(" Add Task ")]),8,Bt)):k("",!0)])],2)],2)]),(o(!0),r(R,null,F(e.tasks,(w,O)=>(o(),$(mt,{key:w.id,task:w,indexing:`${x+1}.${O+1}`,onEditClick:n[0]||(n[0]=I=>f("editClick",I)),onEmployeeAssignClick:n[1]||(n[1]=I=>f("employeeAssignClick",I)),taskLinkTo:q.taskLinkTo,hideButtons:q.hideButtons},null,8,["task","indexing","taskLinkTo","hideButtons"]))),128))],64)}),128))])])):k("",!0)])}}},Mt={class:"p-6 mt-2 container mx-auto relative bg-white rounded-md shadow-md min-h-[calc(100vh-12rem)]"},Vt={class:"mb-4"},zt={key:4,class:"text-center py-4 text-red-500"},Ft={class:"relative min-h-[60vh]"},Ut={key:0,class:"space-y-6"},Et={class:"sticky top-14 z-40 text-gray-700 bg-gradient-to-tl from-sky-400/60 to-sky-400 py-2 px-4 flex items-center"},Nt={class:"font-semibold flex items-center gap-2"},Ot={class:"text-white text-base"},Dt={class:"rounded-b-md overflow-y-auto"},Pt={key:1,class:"space-y-6"},jt={class:"sticky top-14 z-40 text-gray-700 bg-gradient-to-tl from-sky-400/60 to-sky-400 py-2 px-4 flex items-center"},Ht={class:"font-semibold flex items-center gap-2"},Kt={class:"ml-auto"},Jt=["onClick"],Qt={class:"rounded-b-md overflow-y-auto"},Wt={key:2,class:"text-center py-4 text-gray-500 border h-[60vh] flex items-center justify-center rounded bg-gray-50 italic"},Re={__name:"RequirementTaskList",setup(q){const y=Tt(),U=wt(),d=ot(),S=vt(),_=V(""),f=V(null),h=V(!1),n=nt(),p=J({show:!1,attachments:[]}),u=J({parentId:0,requirementId:0,params:{}}),e=J({taskId:0,isOpen:!1}),x=H(()=>{const i=d.query["user-ids"]||null,t=(y.tasks||[]).flatMap(m=>{var T;return i?(T=m.users)==null?void 0:T.filter(D=>i.includes(D.id)):m.users});return[...new Map(t.map(m=>[m.id,m])).values()].sort((m,T)=>m.id-T.id)}),C=H(()=>(y.tasks||[]).reduce((i,t)=>{const L=`${t.from_department_id}-${t.to_department_id}`,m=i.find(T=>T.key==L);return m?m.tasks=[...m.tasks,t]:i.push({key:L,from_department:t.from_department,to_department:t.to_department,tasks:[t]}),i},[])),E=V(null),B=V([]),{saveTaskPriority:N,listHasRearranged:M}=bt(()=>y.taskListTree,0);ht(()=>{console.log("Task List Mounted"),_.value="loading",b()});async function b(){console.log({name:d.name}),d.name=="RequirementTaskList"&&await y.fetchAllTasks({...d.query,page:1}),d.name=="MyRequirementTaskList"&&await y.fetchAllMyTasks({...d.query,page:1}),_.value="",B.value=[]}const w=(i,t)=>{h.value=!0,u.params=i,u.readonlyValues=t},O=i=>{e.taskId=i,e.isOpen=!0};async function I(){f.value=null,h.value=!1,_.value="loading",u.params={},await b()}async function it(){h.value=!1,u.params={},await b()}async function rt(){_.value="loading",await N()&&await b()}function lt(i){return y.tasks.filter(t=>(t.users||[]).some(L=>L.id===i))}st(()=>({...d.query}),async()=>{try{y.resetTaskList(),_.value="loading",await b()}catch(i){console.warn(i)}}),st(()=>n.isAdminMood,i=>{i?S.push({name:"RequirementTaskList",query:d.query}):S.push({name:"MyRequirementTaskList",query:d.query})});const W=H({get(){return{...d.query}},set(i){localStorage.removeItem("sub_task_opened_list"),S.push({query:{...i}})}});function dt(i){return{name:"RequirementTaskShow",params:{id:(i==null?void 0:i.id)||0}}}return(i,t)=>{var L,m,T,D,X;return o(),r("div",Mt,[f.value?(o(),$(j,{key:0},{default:z(()=>[v(kt,{taskId:f.value,onClose:t[0]||(t[0]=a=>f.value=null),onUpdated:I},null,8,["taskId"])]),_:1})):k("",!0),h.value?(o(),$(j,{key:1},{default:z(()=>{var a,l;return[v(pt,{parentTaskId:u.parentId,requirementId:(a=u.params)==null?void 0:a.requirement_id,requirementDetailId:(l=u.params)==null?void 0:l.requirement_detail_id,"default-values":u.params,"readonly-fields":u.readonlyValues,onClose:it,onTaskCreated:I},null,8,["parentTaskId","requirementId","requirementDetailId","default-values","readonly-fields"])]}),_:1})):k("",!0),e.isOpen?(o(),$(j,{key:2,class:"*:max-w-4xl"},{default:z(()=>[v(ft,{taskId:e.taskId,onCancelClick:t[1]||(t[1]=()=>{e.isOpen=!1,e.taskId=0}),onSuccess:t[2]||(t[2]=()=>{e.isOpen=!1,e.taskId=0,_.value="loading",b()})},null,8,["taskId"])]),_:1})):k("",!0),v(yt,{modelValue:W.value,"onUpdate:modelValue":t[3]||(t[3]=a=>W.value=a),onClickAddTask:w,onClickPrioritySave:rt,onClickPriorityDiscard:t[4]||(t[4]=()=>c(M)?E.value.resetItems:null),"list-has-rearranged":c(M),isMyTask:c(d).name==="MyRequirementTaskList",class:"mb-4"},null,8,["modelValue","list-has-rearranged","isMyTask"]),((m=(L=c(d))==null?void 0:L.query)==null?void 0:m["query-log"])=="true"?(o(!0),r(R,{key:3},F(B.value,(a,l)=>(o(),r("div",{key:l,class:"text-xs text-gray-500"},[s("div",Vt,A(a.raw_query),1)]))),128)):k("",!0),c(U).error?(o(),r("div",zt,A(c(U).error),1)):k("",!0),s("div",Ft,[((T=c(d).query)==null?void 0:T.view)==="userwise"?(o(),r("div",Ut,[(o(!0),r(R,null,F(x.value,a=>(o(),r("div",{key:a.id,class:"rounded-md border-2 border-sky-300"},[s("div",Et,[s("div",Nt,[v(xt,{user:a},null,8,["user"]),s("div",Ot,A(a.label),1)])]),s("div",Dt,[v(at,{tasks:lt(a.id),onEditClick:t[5]||(t[5]=l=>f.value=l),onAddClick:t[6]||(t[6]=l=>w(l)),onEmployeeAssignClick:t[7]||(t[7]=l=>O(l)),onClickAttachment:t[8]||(t[8]=l=>{p.show=!0,p.attachments=l}),taskLinkTo:l=>({name:"RequirementTaskShow",params:{id:(l==null?void 0:l.id)||0}})},null,8,["tasks","taskLinkTo"])])]))),128))])):(o(),r("div",Pt,[(o(!0),r(R,null,F(C.value,a=>{var l,Y,Z,G,tt;return o(),r("div",{key:a.key,class:"rounded-md border-2 border-sky-300"},[s("div",jt,[s("div",Ht,[t[14]||(t[14]=s("span",{class:"text-white text-sm"},"From",-1)),v(et,{department:a.from_department},null,8,["department"]),t[15]||(t[15]=s("span",{class:"text-white text-sm"},"To",-1)),v(et,{department:a.to_department},null,8,["department"])]),s("div",Kt,[((l=c(d))==null?void 0:l.name)=="RequirementTaskList"&&((Z=(Y=c(n))==null?void 0:Y.user)==null?void 0:Z.department_id)==((G=a==null?void 0:a.to_department)==null?void 0:G.id)?(o(),r("button",{key:0,onClick:()=>{var g,P;return w({from_department_id:(g=a==null?void 0:a.from_department)==null?void 0:g.id,to_department_id:(P=a==null?void 0:a.to_department)==null?void 0:P.id},{from_department_id:!0,to_department_id:!0})},class:"btn-3 h-6 whitespace-nowrap bg-white border-white px-2"}," Add Task ",8,Jt)):k("",!0)])]),s("div",Qt,[v(at,{tasks:a.tasks,groupBy:"requirement",onEditClick:t[9]||(t[9]=g=>f.value=g),onClickAddTask:t[10]||(t[10]=(g,P)=>w(g,P)),onEmployeeAssignClick:t[11]||(t[11]=g=>O(g)),onClickAttachment:t[12]||(t[12]=g=>{p.show=!0,p.attachments=g}),hideButtons:((tt=c(d))==null?void 0:tt.name)!=="RequirementTaskList",taskLinkTo:dt},null,8,["tasks","hideButtons"])])])}),128))])),_.value!=="loading"&&((D=c(y).tasks)==null?void 0:D.length)===0?(o(),r("div",Wt," No tasks ")):k("",!0),_.value==="loading"?(o(),$(ut,{key:3,class:Q(["absolute inset-0 flex items-center z-50 bg-opacity-60 h-full shadow-none border",[((X=c(y).tasks)==null?void 0:X.length)===0?"justify-center":""]])},null,8,["class"])):k("",!0)]),p.show?(o(),$(j,{key:5},{default:z(()=>[v(ct,{attachments:p.attachments||[],onClickClose:t[13]||(t[13]=a=>p.show=!1)},null,8,["attachments"])]),_:1})):k("",!0)])}}};export{Re as default};
