import{_ as je,D as Ve,r as w,x as q,f as Be,q as G,h as De,c as i,o as c,a as s,b as H,t as y,l as K,G as Ie,n as p,F as O,e as T,d as Ke,k as J,s as k,P as W,z as Q,w as X}from"./index-BvXxip3M.js";import{L as Ae}from"./LoaderView-Iju7ZzGA.js";import{t as Z}from"./todos-CHsG8mDp.js";import{u as Pe}from"./kpi-report-ByEiZ9yQ.js";const Re={class:"space-y-4 px-4 print:px-0"},Ue={class:"hidden print:block mx-auto text-center mb-3"},ze={class:"text-sm text-gray-600"},Ee={class:"font-medium"},Fe={class:"flex flex-wrap items-end gap-3 sticky top-0 z-10 bg-white/80 backdrop-blur print:hidden p-2 -mx-2 rounded-md border border-gray-100"},Le={class:"flex items-center gap-2"},Ye=["disabled"],qe=["value"],Ge={key:0,class:"py-10 text-center"},He={key:1,class:"rounded-md border border-red-200 bg-red-50 p-3 text-red-700",role:"alert","aria-live":"polite"},Je={key:2,class:"space-y-3 md:hidden"},We={class:"flex items-center justify-between"},Qe=["title"],Xe={class:"text-xs text-gray-500"},Ze={class:"mt-2 grid grid-cols-1 gap-2"},et={class:"flex items-center justify-between"},tt={class:"text-[13px] font-semibold text-gray-800"},ot={class:"flex items-center gap-3"},nt={class:"inline-flex items-center gap-1.5"},at=["aria-label","disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange"],st={class:"inline-flex items-center gap-1.5"},lt=["aria-label","disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange"],rt={class:"mt-2 grid grid-cols-2 gap-2 text-center"},dt={key:0,class:"mt-1 text-[10px] text-gray-500 text-center"},it={key:0,class:"px-3 py-6 text-center text-gray-600"},ct={class:"hidden md:block overflow-x-auto rounded-xl border bg-white shadow-sm"},ut={class:"min-w-[900px] w-full text-sm"},yt={class:"text-gray-800 sticky top-0 z-[5]"},mt={class:"bg-gray-100/95 backdrop-blur"},bt={rowspan:"2",class:"sticky z-[6] border-y border-r bg-gray-100/95 px-2 py-2 text-left",style:{left:"2rem",minWidth:"12.5rem",width:"12.5rem"}},vt={class:"whitespace-nowrap"},pt={class:"bg-gray-100/95 text-gray-700 whitespace-nowrap"},ft={class:"text-gray-800"},kt={class:"sticky left-0 z-[4] border-r bg-inherit px-2 text-center"},xt={class:"sticky z-[4] border bg-inherit px-2"},gt=["title"],ht={class:"inline-flex items-center justify-center gap-2 cursor-pointer"},_t=["aria-label","disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange"],wt={class:"inline-flex items-center justify-center gap-2 cursor-pointer"},Ct=["aria-label","disabled","onUpdate:modelValue","onMousedown","onKeydown","onChange"],Nt={key:0,class:"mt-1 text-[10px] text-gray-500 text-center"},$t={key:0},St=1500,Mt={__name:"KpiBiMonthlyReport",setup(Ot){const j=Pe(),{meta:x,rows:_,isLoading:oe,error:ne}=Ve(j),ae=new Date().getFullYear(),$=w(ae),V=w([]),se=w("department"),A=w(""),P=w(""),R=w("any"),v=q(()=>{var t;return((t=x.value)==null?void 0:t.periods)||[]}),le=q(()=>{var t;return((t=x.value)==null?void 0:t.available_years)||null}),re=q(()=>{const t=Object.create(null);for(const o of v.value)t[o.key]=o;return t}),ge=Be(),he=["feb_mar","jun_jul","nov"],_e=q(()=>{var a;const t=ge.query.hl;if(t)return new Set(String(t).split(",").map(e=>e.trim()).filter(Boolean));const o=(a=x.value)==null?void 0:a.highlight_period_keys;return Array.isArray(o)&&o.length?new Set(o):new Set(he)}),ee=t=>_e.value.has(t.key),S=t=>ee(t)?"bg-amber-50":"bg-white",B=t=>ee(t)?"border-amber-300":"border-gray-200",we=ae;function Ce(t=2018,o=we+1){const a=[];for(let l=o;l>=t;l--)a.push(l);const e=Number($.value);a.includes(e)||a.unshift(e),V.value=Array.from(new Set(a))}function de(t){Array.isArray(t)&&t.length?(V.value=[...new Set(t.map(Number))].sort((o,a)=>a-o),V.value.includes(Number($.value))||($.value=V.value[0])):Ce()}G(le,de,{immediate:!0}),G($,()=>{const t=Number($.value);!Number.isInteger(t)||t<2e3||t>2100||ke()});const g=w(Object.create(null)),h=w(Object.create(null)),M=w(Object.create(null)),U=w(Object.create(null)),z=w(Object.create(null)),te=w(Object.create(null)),u=(t,o)=>`${t}::${o}`;function E(t){var a;if(((a=x.value)==null?void 0:a.scope)!=="department")return null;const o=String((t==null?void 0:t.key)||"").match(/^dept:(\d+)$/);return o?Number(o[1]):null}function ie(t){const o=re.value[t];return o!=null&&o.form_id?Number(o.form_id):null}function ce(t){var o;return((o=re.value[t])==null?void 0:o.label)||t}function ue(t){const o=te.value[t]||0;return Date.now()-o>=St}function Ne(){const t=Object.create(null);for(const o of _.value||[])for(const a of v.value){const e=u(o.key,a.key);t[e]=g.value[e]}U.value=t}function ye(){var a,e,l;const t=Object.create(null),o=Object.create(null);for(const n of v.value)o[n.key]=new Set((n.completed_departments||[]).map(Number));for(const n of _.value||[]){const d=E(n);for(const r of v.value){let m=!1;if(d&&o[r.key].has(d))m=!0;else{const b=(a=n.cells)==null?void 0:a[r.key],f=Number((b==null?void 0:b.assigned)??0),C=Number(((e=b==null?void 0:b.incharge)==null?void 0:e.done)??0),N=Number(((l=b==null?void 0:b.coordinator)==null?void 0:l.done)??0);m=R.value==="both"?f>0&&C>=f&&N>=f:f>0&&(C>=f||N>=f)}t[u(n.key,r.key)]=m}}g.value=t,Ne()}function F(t,o){const a=u(t.key,o.key);U.value[a]=g.value[a]}async function me(t,o){var C,N,xe;const a=u(t.key,o.key),e=!!g.value[a],l=!!U.value[a],n=`${(t==null?void 0:t.name)??""} • ${ce(o.key)}`,d=e?"mark as Completed":"mark as Pending";if(!window.confirm(`Confirm
${n}

Do you want to ${d}?`)){g.value[a]=l;return}if(M.value[a]){g.value[a]=l,window.alert("Already updating…");return}if(!ue(a)){g.value[a]=l,window.alert("Just updated. Try again shortly.");return}const m=ie(o.key),b=E(t),f=!!((N=(C=t==null?void 0:t.cells)==null?void 0:C[o.key])!=null&&N.form_id&&m);if(((xe=x.value)==null?void 0:xe.scope)!=="department"||!b||!f){g.value[a]=l,window.alert("This period is not assignable (no form).");return}M.value[a]=!0;try{await j.setReportCompletion({form_id:m,department_id:b,completed:e}),te.value[a]=Date.now(),U.value[a]=e;const D=v.value.findIndex(I=>I.key===o.key);if(D>=0){const I=new Set((x.value.periods[D].completed_departments||[]).map(Number));e?I.add(b):I.delete(b),x.value.periods[D].completed_departments=Array.from(I)}}catch(D){g.value[a]=l,console.error(D),window.alert("Failed to update.")}finally{M.value[a]=!1}}function $e(){const t=Object.create(null);for(const o of _.value||[])for(const a of v.value){const e=u(o.key,a.key);t[e]=h.value[e]}z.value=t}function be(){var a,e;const t=Object.create(null),o=Object.create(null);for(const l of v.value)o[l.key]=new Set((l.target_completed_departments||[]).map(Number));for(const l of _.value||[]){const n=E(l);for(const d of v.value){let r=!1;if(n&&o[d.key].has(n))r=!0;else{const m=(e=(a=l==null?void 0:l.cells)==null?void 0:a[d.key])==null?void 0:e.monthly_target,b=Number((m==null?void 0:m.have)??0),f=Number((m==null?void 0:m.of)??0);r=f>0&&b>=f}t[u(l.key,d.key)]=r}}h.value=t,$e()}function L(t,o){const a=u(t.key,o.key);z.value[a]=h.value[a]}async function ve(t,o){var f;const a=u(t.key,o.key),e=!!h.value[a],l=!!z.value[a],n=`${(t==null?void 0:t.name)??""} • ${ce(o.key)}`,d=e?"mark Target as Completed":"mark Target as Pending";if(!window.confirm(`Confirm
${n}

Do you want to ${d}?`)){h.value[a]=l;return}if(M.value[a]){h.value[a]=l,window.alert("Already updating…");return}if(!ue(a)){h.value[a]=l,window.alert("Just updated. Try again shortly.");return}const m=E(t);if(((f=x.value)==null?void 0:f.scope)!=="department"||!m){h.value[a]=l,window.alert("Not assignable.");return}const b=ie(o.key);M.value[a]=!0;try{await j.setTargetCompletion({period_key:o.key,form_id:b||void 0,department_id:m,completed:e}),te.value[a]=Date.now(),z.value[a]=e;const C=v.value.findIndex(N=>N.key===o.key);if(C>=0){const N=new Set((x.value.periods[C].target_completed_departments||[]).map(Number));e?N.add(m):N.delete(m),x.value.periods[C].target_completed_departments=Array.from(N)}}catch(C){h.value[a]=l,console.error(C),window.alert("Failed to update.")}finally{M.value[a]=!1}}const pe=(t,o)=>{var a,e,l;return!!((e=(a=t==null?void 0:t.cells)==null?void 0:a[o])!=null&&e.form_id)&&((l=x.value)==null?void 0:l.scope)==="department"},fe=(t,o)=>{var e,l,n,d,r;if(((e=x.value)==null?void 0:e.scope)!=="department")return!1;const a=(n=(l=t==null?void 0:t.cells)==null?void 0:l[o])==null?void 0:n.monthly_target;return Number((a==null?void 0:a.of)??0)>0||!!((r=(d=t==null?void 0:t.cells)==null?void 0:d[o])!=null&&r.form_id)},Se=t=>t?"✓":"—";function Y(t,o,a){var n,d;const e=Number((t==null?void 0:t.assigned)??0),l=Number(a==="ic"?((n=t==null?void 0:t.incharge)==null?void 0:n.done)??0:((d=t==null?void 0:t.coordinator)==null?void 0:d.done)??0);if(e===0&&l===0){const r=a==="ic"?t==null?void 0:t.incharge:t==null?void 0:t.coordinator;if(typeof r=="boolean")return Se(r)}return`${l}/${o}`}function Me(){window.print()}function Oe(){return new Date().toLocaleString()}async function ke(){try{await j.fetchBiMonthly({year:Number($.value),scope:se.value,department_id:A.value?Number(A.value):void 0,form_id:P.value?Number(P.value):void 0,rule:R.value})}catch(t){console.error("fetchBiMonthly failed:",t)}finally{ye(),be()}}async function Te(){try{await j.exportBiMonthly({year:Number($.value),scope:se.value,department_id:A.value?Number(A.value):void 0,form_id:P.value?Number(P.value):void 0,rule:R.value})}catch(t){console.error("exportBiMonthly failed:",t),window.alert("Export failed. Please try again.")}}return G([_,v,R],ye),G([_,v],be),De(()=>{de(le.value),ke()}),(t,o)=>{var a;return c(),i("div",Re,[s("div",Ue,[o[3]||(o[3]=s("h1",{class:"text-xl font-semibold text-gray-900"},"Bi-Monthly KPI Report",-1)),s("div",ze,[o[1]||(o[1]=H(" Year: ")),s("span",Ee,y($.value),1),o[2]||(o[2]=H(" • Generated: ")),s("span",null,y(Oe()),1)])]),s("div",Fe,[s("div",Le,[o[4]||(o[4]=s("label",{class:"text-xs font-medium text-gray-600"},"Year",-1)),K(s("select",{"onUpdate:modelValue":o[0]||(o[0]=e=>$.value=e),class:"w-32 rounded border border-gray-300 bg-white px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400/50 disabled:opacity-60",disabled:p(oe),"aria-label":"Select year"},[(c(!0),i(O,null,T(V.value,e=>(c(),i("option",{key:e,value:e},y(e),9,qe))),128))],8,Ye),[[Ie,$.value,void 0,{number:!0}]])]),s("div",{class:"ml-auto flex gap-2"},[s("button",{class:"btn-3 !py-1.5 !px-3",onClick:Te},o[5]||(o[5]=[s("i",{class:"far fa-file-excel mr-1"},null,-1),H(" Excel ")])),s("button",{class:"btn-3 !py-1.5 !px-3",onClick:Me},o[6]||(o[6]=[s("i",{class:"far fa-print mr-1"},null,-1),H(" Print ")]))])]),p(oe)?(c(),i("div",Ge,[Ke(Ae)])):p(ne)?(c(),i("div",He,y(p(ne)),1)):(c(),i("div",Je,[(c(!0),i(O,null,T(p(_),(e,l)=>(c(),i("div",{key:"card-"+e.key,class:"rounded-xl border border-gray-200 bg-white shadow-sm p-3 break-inside-avoid"},[s("div",We,[s("div",{class:"text-sm font-medium text-gray-900 truncate",title:e.name},y(l+1)+". "+y(e.name),9,Qe),s("div",Xe,"Total: "+y(e.employees_total),1)]),s("div",Ze,[(c(!0),i(O,null,T(v.value,n=>{var d;return c(),i("div",{key:n.key,class:k(["rounded-lg border p-2",[S(n),ee(n)?"border-amber-300":"border-gray-200"]])},[s("div",et,[s("div",tt,y(n.label),1),s("div",ot,[s("label",nt,[K(s("input",{type:"checkbox",class:"h-4 w-4 accent-emerald-500","aria-label":`Report • ${e.name} • ${n.label}`,disabled:!pe(e,n.key)||M.value[u(e.key,n.key)],"onUpdate:modelValue":r=>g.value[u(e.key,n.key)]=r,onMousedown:r=>F(e,n),onKeydown:Q(X(r=>F(e,n),["prevent"]),["enter"]),onChange:r=>me(e,n)},null,40,at),[[W,g.value[u(e.key,n.key)]]]),o[7]||(o[7]=s("span",{class:"text-[11px] text-gray-700"},"Report",-1))]),s("label",st,[K(s("input",{type:"checkbox",class:"h-4 w-4 accent-sky-500","aria-label":`Target • ${e.name} • ${n.label}`,disabled:!fe(e,n.key)||M.value[u(e.key,n.key)],"onUpdate:modelValue":r=>h.value[u(e.key,n.key)]=r,onMousedown:r=>L(e,n),onKeydown:Q(X(r=>L(e,n),["prevent"]),["enter"]),onChange:r=>ve(e,n)},null,40,lt),[[W,h.value[u(e.key,n.key)]]]),o[8]||(o[8]=s("span",{class:"text-[11px] text-gray-700"},"Target",-1))])])]),s("div",rt,[s("div",{class:k(["rounded px-2 py-1 text-[12px]",p(Z)(e.cells[n.key],"ic")])}," Inch: "+y(Y(e.cells[n.key],e.employees_total,"ic")),3),s("div",{class:k(["rounded px-2 py-1 text-[12px]",p(Z)(e.cells[n.key],"co")])}," Coord: "+y(Y(e.cells[n.key],e.employees_total,"co")),3)]),(d=e.cells[n.key])!=null&&d.max_total?(c(),i("div",dt,y(e.cells[n.key].final_total)+" / "+y(e.cells[n.key].max_total),1)):J("",!0)],2)}),128))])]))),128)),!p(_)||p(_).length===0?(c(),i("div",it," No data ")):J("",!0)])),s("div",ct,[s("table",ut,[s("thead",yt,[s("tr",mt,[o[9]||(o[9]=s("th",{rowspan:"2",class:"sticky left-0 z-[6] border-y border-r bg-gray-100/95 px-2 py-2 text-center",style:{"min-width":"2.25rem",width:"2.25rem"}}," SL ",-1)),s("th",bt,y(((a=p(x))==null?void 0:a.scope)==="user"?"Employee":"Department"),1),(c(!0),i(O,null,T(v.value,e=>(c(),i("th",{key:e.key,colspan:"4",class:k(["border-y px-2 py-2 text-center font-semibold border-x-2 text-red-500 print:text-black",[S(e),B(e)]])},[s("span",vt,y(e.label),1)],2))),128))]),s("tr",pt,[(c(!0),i(O,null,T(v.value,e=>(c(),i(O,{key:e.key+"-sub"},[s("th",{class:k(["border-y py-1 text-center text-[11px] w-8 border-r",S(e)])}," Report ",2),s("th",{class:k(["border-y py-1 text-center text-[11px] w-8 border-r",[S(e),B(e)]])}," Target ",2),s("th",{class:k(["border-y py-1 text-center text-[11px] w-8 border-r",S(e)])}," Inch. ",2),s("th",{class:k(["border-y py-1 text-center text-[11px] border-r-2 w-8",[S(e),B(e)]])}," Coord. ",2)],64))),128))])]),s("tbody",ft,[(c(!0),i(O,null,T(p(_),(e,l)=>(c(),i("tr",{key:e.key,class:"border-t odd:bg-gray-50 hover:bg-sky-50/40 transition-colors break-inside-avoid"},[s("td",kt,y(l+1),1),s("td",xt,[s("div",{class:"truncate w-48",title:e.name},y(e.name),9,gt)]),(c(!0),i(O,null,T(v.value,n=>{var d;return c(),i(O,{key:n.key},[s("td",{class:k(["border-r text-center",S(n)])},[s("label",ht,[K(s("input",{type:"checkbox",class:"h-4 w-4 accent-emerald-500","aria-label":`Report • ${e.name} • ${n.label}`,disabled:!pe(e,n.key)||M.value[u(e.key,n.key)],"onUpdate:modelValue":r=>g.value[u(e.key,n.key)]=r,onMousedown:r=>F(e,n),onKeydown:Q(X(r=>F(e,n),["prevent"]),["enter"]),onChange:r=>me(e,n)},null,40,_t),[[W,g.value[u(e.key,n.key)]]])])],2),s("td",{class:k(["text-center border-r",[S(n),B(n)]])},[s("label",wt,[K(s("input",{type:"checkbox",class:"h-4 w-4 accent-sky-500","aria-label":`Target • ${e.name} • ${n.label}`,disabled:!fe(e,n.key)||M.value[u(e.key,n.key)],"onUpdate:modelValue":r=>h.value[u(e.key,n.key)]=r,onMousedown:r=>L(e,n),onKeydown:Q(X(r=>L(e,n),["prevent"]),["enter"]),onChange:r=>ve(e,n)},null,40,Ct),[[W,h.value[u(e.key,n.key)]]])])],2),s("td",{class:k(["border-r text-center",S(n)])},[s("span",{class:k(["inline-block rounded py-0.5 font-mono text-[12px]",p(Z)(e.cells[n.key],"ic")])},y(Y(e.cells[n.key],e.employees_total,"ic")),3)],2),s("td",{class:k(["border-y text-center border-r-2",[S(n),B(n)]])},[s("span",{class:k(["inline-block rounded py-0.5 font-mono text-[12px]",p(Z)(e.cells[n.key],"co")])},y(Y(e.cells[n.key],e.employees_total,"co")),3),(d=e.cells[n.key])!=null&&d.max_total?(c(),i("div",Nt,y(e.cells[n.key].final_total)+" / "+y(e.cells[n.key].max_total),1)):J("",!0)],2)],64)}),128))]))),128)),!p(_)||p(_).length===0?(c(),i("tr",$t,o[10]||(o[10]=[s("td",{colspan:"100",class:"px-3 py-6 text-center text-gray-600"},"No data",-1)]))):J("",!0)])])])])}}},Dt=je(Mt,[["__scopeId","data-v-e5b0361e"]]);export{Dt as default};
