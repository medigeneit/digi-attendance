import{B as W,r as y,x as $,C as V,f as X,u as Y,D as Z,h as ee,q as Q,c as u,o as c,a as t,n as s,k as L,b as q,t as v,l as j,H as O,a3 as N,F as E,e as H,v as te,s as se}from"./index-0W4OwH8Z.js";const le=W("ctdi",()=>{const w=y(null),b=y(null),z=y(""),i=y("section"),_=y([]),p=y([]),m=y([]),I=y([]),h=y(new Map),A=y(new Set),R=y(!1),T=y(!1),g=y(""),k=$(()=>m.value.length),G=$(()=>m.value.reduce((a,o)=>a+(h.value.get(o.id)?1:0),0)),C=$(()=>{const a=z.value.trim().toLowerCase(),o=a?m.value.filter(l=>(l.label||"").toLowerCase().includes(a)||(l.item_key||"").toLowerCase().includes(a)):m.value.slice();return o.sort((l,d)=>{const f=i.value==="responsible_unit"?"responsible_unit":i.value==="section"?"section":null;if(f){const U=(l[f]||"").localeCompare(d[f]||"");if(U!==0)return U}return(l.order_no??0)-(d.order_no??0)}),o}),D=$(()=>{if(i.value==="none")return{All:C.value};const a=i.value==="responsible_unit"?"responsible_unit":"section",o={};for(const l of C.value){const d=l[a]||"—";o[d]||(o[d]=[]),o[d].push(l)}return o});function F(a,o){!!h.value.get(a)!==o&&(h.value.set(a,o),A.value.add(a))}function M(a,o){const l=D.value[a]||[];for(const d of l)F(d.id,o)}function x(a){const o=D.value[a]||[];for(const l of o)F(l.id,!h.value.get(l.id))}function e(){A.value.clear()}async function n(){var a,o;g.value="";try{const[l,d]=await Promise.all([V.get("/departments",{params:{per_page:1e3}}),V.get("/checklist-templates",{params:{per_page:1e3}})]);_.value=((a=l.data)==null?void 0:a.data)||l.data||[],p.value=((o=d.data)==null?void 0:o.data)||d.data||[]}catch(l){g.value="Failed to load filters",console.error(l)}}async function B(a){var o;m.value=[],g.value="";try{const l=await V.get(`/checklist-templates/${a}/items`),d=((o=l.data)==null?void 0:o.data)||l.data||[];m.value=d.map(f=>({id:f.id,label:f.label,item_key:f.item_key,order_no:f.order_no??0,section:f.section||null,responsible_unit:f.responsible_unit||null}))}catch(l){g.value="Failed to load template items",console.error(l)}}async function r(a,o){var l;I.value=[],h.value=new Map,A.value.clear(),g.value="";try{const d=await V.get("/department-item-assignments",{params:{department_id:a,template_id:o,per_page:1e3}}),f=((l=d.data)==null?void 0:l.data)||d.data||[];I.value=f;const U=new Set(f.filter(S=>S.is_active).map(S=>{var P;return S.template_item_id??((P=S.templateItem)==null?void 0:P.id)}));for(const S of m.value)h.value.set(S.id,U.has(S.id))}catch(d){g.value="Failed to load assignments",console.error(d)}}async function K(){if(!(!w.value||!b.value)){R.value=!0,g.value="";try{await B(b.value),await r(w.value,b.value)}catch(a){g.value="Refresh failed",console.error(a)}finally{R.value=!1}}}async function J(a=null){if(!w.value||!b.value)return;const o=m.value.filter(l=>h.value.get(l.id)).map(l=>l.id);T.value=!0,g.value="";try{await V.post("/department-item-assignments/bulk-upsert",{department_id:w.value,template_id:b.value,active_item_ids:o,notes:a}),e(),await r(w.value,b.value)}catch(l){g.value="Save failed",console.error(l)}finally{T.value=!1}}return{departmentId:w,templateId:b,search:z,groupBy:i,departments:_,templates:p,templateItems:m,assignments:I,activeById:h,dirty:A,loading:R,saving:T,error:g,totalItems:k,activeCount:G,filteredItems:C,grouped:D,loadFilters:n,refresh:K,saveBulk:J,setActive:F,setGroup:M,invertGroup:x,clearDirty:e}}),ne={class:"max-w-7xl mx-auto p-6 space-y-6"},ae={class:"flex items-start justify-between gap-4"},oe={class:"flex items-center gap-2"},ie=["disabled"],re=["disabled"],de={key:0,class:"h-4 w-4 mr-2 animate-spin",viewBox:"0 0 24 24",fill:"none"},ue={class:"rounded-2xl bg-white shadow ring-1 ring-black/5 p-4"},ce={class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3"},ve={class:"lg:col-span-2"},pe=["value"],me={class:"lg:col-span-2"},ge=["value"],fe={class:"mt-3 text-sm flex items-center justify-between"},ye={class:"text-gray-600"},xe={key:0,class:"text-rose-600"},be={key:0,class:"rounded-2xl bg-white shadow ring-1 ring-black/5 p-6 text-gray-600"},_e={key:1,class:"space-y-6"},he={class:"flex items-center justify-between px-4 py-3 border-b"},ke={class:"flex items-center gap-3"},we={class:"text-base font-semibold"},Ie={class:"text-xs text-gray-600"},Ce={class:"flex items-center gap-2"},Be=["onClick"],Se=["onClick"],Ae=["onClick"],Te={class:"divide-y"},De={class:"flex items-center gap-3 cursor-pointer"},Fe=["checked","onChange"],qe={class:"font-medium leading-5"},Re={class:"text-xs text-gray-500"},Ve={class:"font-mono"},ze={key:0,class:"text-xs text-amber-600"},Ge={key:0,class:"rounded-2xl bg-white shadow ring-1 ring-black/5 p-8 text-center text-gray-500"},Me={class:"fixed bottom-4 right-4"},Ue=["disabled"],Le={__name:"DepartmentItemAssignments",setup(w){const b=X(),z=Y(),i=le(),{departmentId:_,templateId:p,search:m,groupBy:I,departments:h,templates:A,grouped:R,totalItems:T,activeCount:g,dirty:k,loading:G,saving:C,error:D}=Z(i);function F(x){const e=Number(x);return Number.isFinite(e)&&e>0?e:null}async function M(){_.value&&p.value&&await i.refresh()}return ee(async()=>{await i.loadFilters();const x=F(b.query.templateId);x&&(p.value=x),await M()}),Q(()=>b.query.templateId,x=>{const e=F(x);e!==p.value&&(p.value=e)}),Q([_,p],async([x,e])=>{await M();const n={...b.query};e?n.templateId=String(e):delete n.templateId,x?n.departmentId=String(x):delete n.departmentId,z.replace({query:n}).catch(()=>{})}),(x,e)=>(c(),u("div",ne,[t("div",ae,[e[8]||(e[8]=t("div",null,[t("h1",{class:"text-2xl font-semibold"},"Department ↔ Template Items Assign"),t("p",{class:"text-sm text-gray-600"}," Department incharge / respective personnel অনুযায়ী টেমপ্লেট আইটেম অ্যাক্টিভেট করুন ")],-1)),t("div",oe,[t("button",{class:"inline-flex items-center rounded-lg border px-3 py-2 text-sm hover:bg-gray-50",onClick:e[0]||(e[0]=(...n)=>s(i).refresh&&s(i).refresh(...n)),disabled:s(G)}," Refresh ",8,ie),t("button",{class:"inline-flex items-center rounded-lg bg-gray-900 px-3 py-2 text-sm text-white hover:bg-gray-800 disabled:opacity-60",onClick:e[1]||(e[1]=n=>s(i).saveBulk()),disabled:s(C)||s(k).size===0||!s(_)||!s(p)},[s(C)?(c(),u("svg",de,e[7]||(e[7]=[t("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4",opacity:"0.25"},null,-1),t("path",{d:"M22 12a10 10 0 0 1-10 10",stroke:"currentColor","stroke-width":"4","stroke-linecap":"round"},null,-1)]))):L("",!0),q(" Save Assignments ("+v(s(k).size)+") ",1)],8,re)])]),t("div",ue,[t("div",ce,[t("div",ve,[e[10]||(e[10]=t("label",{class:"text-sm font-medium"},"Department",-1)),j(t("select",{"onUpdate:modelValue":e[2]||(e[2]=n=>N(_)?_.value=n:null),class:"w-full rounded-lg border px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-gray-900/20"},[e[9]||(e[9]=t("option",{value:null},"Select department",-1)),(c(!0),u(E,null,H(s(h),n=>(c(),u("option",{key:n.id,value:n.id},v(n.name),9,pe))),128))],512),[[O,s(_)]])]),t("div",me,[e[12]||(e[12]=t("label",{class:"text-sm font-medium"},"Template",-1)),j(t("select",{"onUpdate:modelValue":e[3]||(e[3]=n=>N(p)?p.value=n:null),class:"w-full rounded-lg border px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-gray-900/20"},[e[11]||(e[11]=t("option",{value:null},"Select template",-1)),(c(!0),u(E,null,H(s(A),n=>(c(),u("option",{key:n.id,value:n.id},v(n.name),9,ge))),128))],512),[[O,s(p)]])]),t("div",null,[e[14]||(e[14]=t("label",{class:"text-sm font-medium"},"Group By",-1)),j(t("select",{"onUpdate:modelValue":e[4]||(e[4]=n=>N(I)?I.value=n:null),class:"w-full rounded-lg border px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-gray-900/20"},e[13]||(e[13]=[t("option",{value:"section"},"Section",-1),t("option",{value:"responsible_unit"},"Responsible Unit",-1),t("option",{value:"none"},"No grouping",-1)]),512),[[O,s(I)]])]),t("div",null,[e[15]||(e[15]=t("label",{class:"text-sm font-medium"},"Search",-1)),j(t("input",{"onUpdate:modelValue":e[5]||(e[5]=n=>N(m)?m.value=n:null),type:"text",placeholder:"Search item/ key...",class:"w-full rounded-lg border px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-gray-900/20"},null,512),[[te,s(m),void 0,{trim:!0}]])])]),t("div",fe,[t("div",ye,[e[16]||(e[16]=q(" Total: ")),t("b",null,v(s(T)),1),e[17]||(e[17]=q(", Active: ")),t("b",null,v(s(g)),1),e[18]||(e[18]=q(", Unsaved changes: ")),t("b",null,v(s(k).size),1)]),s(D)?(c(),u("div",xe,v(s(D)),1)):L("",!0)])]),s(G)?(c(),u("div",be," Loading… ")):(c(),u("div",_e,[(c(!0),u(E,null,H(s(R),(n,B)=>(c(),u("div",{key:B,class:"rounded-2xl bg-white shadow ring-1 ring-black/5"},[t("div",he,[t("div",ke,[t("div",we,v(B),1),t("div",Ie," ("+v(n.length)+" items • active "+v(n.filter(r=>s(i).activeById.get(r.id)).length)+") ",1)]),t("div",Ce,[t("button",{class:"rounded-lg border px-3 py-1.5 text-xs hover:bg-gray-50",onClick:r=>s(i).setGroup(B,!0)},"Select all",8,Be),t("button",{class:"rounded-lg border px-3 py-1.5 text-xs hover:bg-gray-50",onClick:r=>s(i).setGroup(B,!1)},"Clear",8,Se),t("button",{class:"rounded-lg border px-3 py-1.5 text-xs hover:bg-gray-50",onClick:r=>s(i).invertGroup(B)},"Invert",8,Ae)])]),t("div",Te,[(c(!0),u(E,null,H(n,r=>(c(),u("div",{key:r.id,class:"flex items-center gap-4 px-4 py-3"},[t("label",De,[t("input",{type:"checkbox",class:"h-5 w-5",checked:s(i).activeById.get(r.id),onChange:K=>s(i).setActive(r.id,K.target.checked)},null,40,Fe),t("div",null,[t("div",qe,v(r.label),1),t("div",Re,[e[19]||(e[19]=q(" Key: ")),t("span",Ve,v(r.item_key),1),e[20]||(e[20]=t("span",{class:"mx-1"},"•",-1)),q(" Order: "+v(r.order_no??0),1)])])]),t("div",{class:se(["ml-auto text-xs",{"text-emerald-600":s(i).activeById.get(r.id),"text-gray-400":!s(i).activeById.get(r.id)}])},v(s(i).activeById.get(r.id)?"Active":"Inactive"),3),s(k).has(r.id)?(c(),u("div",ze,"unsaved")):L("",!0)]))),128))])]))),128)),s(T)===0?(c(),u("div",Ge," No items found ")):L("",!0)])),t("div",Me,[t("button",{class:"rounded-full shadow-xl bg-gray-900 text-white px-4 py-3 text-sm hover:bg-gray-800 disabled:opacity-60",disabled:s(C)||s(k).size===0||!s(_)||!s(p),onClick:e[6]||(e[6]=n=>s(i).saveBulk())}," Save ("+v(s(k).size)+") ",9,Ue)])]))}};export{Le as default};
